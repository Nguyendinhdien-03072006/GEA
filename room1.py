
import base64
exec(base64.b64decode('aW1wb3J0IHRocmVhZGluZwppbXBvcnQgdGVsZWJvdAppbXBvcnQgcmFuZG9tCmltcG9ydCByZQppbXBvcnQgdGltZQppbXBvcnQgbWF0aAppbXBvcnQgdGVsZWJvdAppbXBvcnQganNvbgpmcm9tIHJlcXVlc3RzLmV4Y2VwdGlvbnMgaW1wb3J0IENvbm5lY3RUaW1lb3V0LCBSZXF1ZXN0RXhjZXB0aW9uCmltcG9ydCBzb2NrZXQKaW1wb3J0IGxvZ2dpbmcKZnJvbSBoYXNobGliIGltcG9ydCBtZDUKaW1wb3J0IGhhc2hsaWIKaW1wb3J0IHN0cmluZwppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IGRhdGV0aW1lIGFzIGR0CmZyb20gdGVsZWdyYW0gaW1wb3J0IEJvdApmcm9tIHRlbGVib3QgaW1wb3J0IFRlbGVCb3QsIHR5cGVzCmltcG9ydCBweXR6CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lIGFzIGR0CmZyb20gdGVsZWdyYW0gaW1wb3J0IFJlcGx5S2V5Ym9hcmRNYXJrdXAKZnJvbSB0ZWxlZ3JhbS5leHQgaW1wb3J0IENhbGxiYWNrUXVlcnlIYW5kbGVyLCBDb21tYW5kSGFuZGxlciwgVXBkYXRlcgpmcm9tIHRlbGVib3QudHlwZXMgaW1wb3J0IElubGluZUtleWJvYXJkQnV0dG9uLCBJbmxpbmVLZXlib2FyZE1hcmt1cCwgQ2hhdFBlcm1pc3Npb25zCmZyb20gdGVsZWJvdCBpbXBvcnQgdHlwZXMKZnJvbSBkZWNpbWFsIGltcG9ydCBEZWNpbWFsLCBJbnZhbGlkT3BlcmF0aW9uCmltcG9ydCB0ZWxlZ3JhbQpmcm9tIHRlbGVncmFtLmNvbnN0YW50cyBpbXBvcnQgUGFyc2VNb2RlCmZyb20gdGVsZWdyYW0uY29uc3RhbnRzIGltcG9ydCBQYXJzZU1vZGUKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKZnJvbSB0ZWxlZ3JhbSBpbXBvcnQgVXBkYXRlCmZyb20gdGVsZWdyYW0uZXh0IGltcG9ydCBDYWxsYmFja0NvbnRleHQsIENvbW1hbmRIYW5kbGVyLCBVcGRhdGVyCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lLCB0aW1lZGVsdGEKZnJvbSB0ZWxlZ3JhbSBpbXBvcnQgVXBkYXRlLCBDYWxsYmFja1F1ZXJ5LCBJbmxpbmVLZXlib2FyZEJ1dHRvbiwgSW5saW5lS2V5Ym9hcmRNYXJrdXAKZnJvbSB0ZWxlZ3JhbS5leHQgaW1wb3J0IENhbGxiYWNrQ29udGV4dApmcm9tIHRlbGVib3QudHlwZXMgaW1wb3J0IFJlcGx5S2V5Ym9hcmRNYXJrdXAsIEtleWJvYXJkQnV0dG9uCmZyb20gdGVsZWdyYW0gaW1wb3J0IFVwZGF0ZSwgSW5saW5lS2V5Ym9hcmRNYXJrdXAsIElubGluZUtleWJvYXJkQnV0dG9uLCBSZXBseUtleWJvYXJkTWFya3VwCmZyb20gcmVxdWVzdHMuZXhjZXB0aW9ucyBpbXBvcnQgQ29ubmVjdFRpbWVvdXQsIEhUVFBFcnJvcgppbXBvcnQgb3MKaW1wb3J0IGNvbmN1cnJlbnQuZnV0dXJlcwppbXBvcnQgdHJhY2ViYWNrCmZyb20gdGVsZWJvdC50eXBlcyBpbXBvcnQgSW5saW5lS2V5Ym9hcmRNYXJrdXAsIElubGluZUtleWJvYXJkQnV0dG9uCmZyb20gdGVsZWJvdC50eXBlcyBpbXBvcnQgSW5saW5lS2V5Ym9hcmRNYXJrdXAsIElubGluZUtleWJvYXJkQnV0dG9uCmZyb20gdGhyZWFkaW5nIGltcG9ydCBUaHJlYWQKZnJvbSByZXF1ZXN0cyBpbXBvcnQgcG9zdAoKQURNSU4gPSBbODIwNTU2Nzg1MV0KZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3ICNuaMOzbSB1c2VyCkdST1VQX0NIQVRfSUQgPSAtMTAwMzI0MTAwMjQ3OCAjbmjDs20gYWRtaW4KT1RIRVJfR1JPVVBfQ0hBVF9JRCA9ICctMTAwMzY1Mzc5NjQ2MicgIyBpZCBuaMOzbSB0YiB4eApPVEhFUl9HUk9VUF9DSEFUX0lEX01ENSA9ICctMTAwMzQ5NDg1OTg3MicgIyBpZCBuaMOzbSB0YiBtZDUKCmJvdCA9IHRlbGVib3QuVGVsZUJvdCgiODIzNDU1NzI0NjpBQUh0aTRLa0xtYTQ1V2Q3N3k2WVdqVm9DSk9kazc1MWRpRSIpICMgYm90IHRiCmJvdDEgPSB0ZWxlYm90LlRlbGVCb3QoIjg1MDk4MzE5Mjc6QUFId0tPSUVtVExLeXdqSlMwcGdTN3Rqd3BuTjNRUDJsUDgiKSAjIGJvdCB0dW5nIHh4CmJvdDIgPSB0ZWxlYm90LlRlbGVCb3QoIjg1MDk4MzE5Mjc6QUFId0tPSUVtVExLeXdqSlMwcGdTN3Rqd3BuTjNRUDJsUDgiKSAjIGJvdCBjxrDhu6NjCmJvdDMgPSB0ZWxlYm90LlRlbGVCb3QoIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiKSAjIGJvdCBhZG1pbgpib3Q0ID0gdGVsZWJvdC5UZWxlQm90KCI4NTY2ODY4ODI0OkFBSGlqSEFwdjhjMzF2OVBwRVd1aDF5NmdTdWZiQldzQ1NNIikgIyBib3QgY2jDrW5oCgp1c2VyX2JhbGFuY2UgPSB7fQpnaXRjb2RlX2Ftb3VudHMgPSB7fQp1c2VkX2dpdGNvZGVzID0gW10KdXNlcl9zdGF0ZSA9IHt9CnVzZXJfYmV0X2hpc3RvcnkgPSB7fQp1c2VyX2JldHMgPSB7fQpjb2RlX3RpbWVycyA9IHt9CmRhaWx5X2Vhcm5pbmdzID0ge30KY2xpY2tlZF9saW5rcyA9IHt9CmNsaWNrZWRfcmVmZXJyYWxfbGlua3MgPSBzZXQoKQp1c2VyX3JlZmVycmFscyA9IHt9CnNlc3Npb25fcmVzdWx0c190eCA9IFtdCnNlc3Npb25fcmVzdWx0c19jbCA9IFtdCmxhc3RfYmV0X2Nsb3NlX21lc3NhZ2VfaWQgPSBOb25lCmFjY2VwdGluZ19iZXRzID0gVHJ1ZQp0b3RhbF90YWlfYmV0ID0ge30KdG90YWxfeGl1X2JldCA9IHt9CnRvdGFsX2xlX2JldCA9IHt9CnRvdGFsX2NoYW5fYmV0ID0ge30KdG90YWxfaHUgPSB7fQp0b3RhbF9iZXRfbG9zcyA9IHt9CnRvdGFsX2JldF93aW4gPSB7fQpsb2NraW5nX2dyb3VwID0gRmFsc2UKU0RfRklMRSA9ICJGSUxFL3NkLnR4dCIKQkFOX0ZJTEUgPSAiRklMRS9iYW4udHh0IgppY29ucyA9IFsn8J+PricgLCAn8J+qrScgLCAn8J+nqCcsJ/Cfp6cnXQoKZGVmIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIHVwZGF0ZWRfYmFsYW5jZSk6CiAgICB1c2VyX2lkID0gc3RyKHVzZXJfaWQpCiAgICBmaWxlX3BhdGggPSAiRklMRS9zZC50eHQiCiAgICBsaW5lcyA9IFtdCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH0ge3VwZGF0ZWRfYmFsYW5jZX1cbiIpCiAgICAgICAgcmV0dXJuCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAicisiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgIHVzZXJfaW5mbyA9IGxpbmUuc3RyaXAoKS5zcGxpdChtYXhzcGxpdD0yKQogICAgICAgICAgICBpZiB1c2VyX2luZm9bMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgIHdhbGxldF9zZWNvbmRhcnkgPSB1c2VyX2luZm9bMl0gaWYgbGVuKHVzZXJfaW5mbykgPT0gMyBlbHNlICIiCiAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge3VwZGF0ZWRfYmFsYW5jZX0ge3dhbGxldF9zZWNvbmRhcnl9XG4iIGlmIHdhbGxldF9zZWNvbmRhcnkgZWxzZSBmInt1c2VyX2lkfSB7dXBkYXRlZF9iYWxhbmNlfVxuIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lKQogICAgICAgIGYuc2VlaygwKQogICAgICAgIGYud3JpdGVsaW5lcyhsaW5lcykKICAgICAgICBmLnRydW5jYXRlKCkKCmRlZiB1cGRhdGVfaHVfZmlsZShhbW91bnQpOgogICAgdHJ5OgogICAgICAgIGZpbGVfcGF0aCA9ICJGSUxFL2h1LnR4dCIKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICBjb250ZW50cyA9IGZpbGUucmVhZCgpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfYW1vdW50ID0gaW50KGZsb2F0KGNvbnRlbnRzKSkgaWYgY29udGVudHMgZWxzZSAwCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY3VycmVudF9hbW91bnQgPSA1MDAwMCAgCiAgICAgICAgdXBkYXRlZF9hbW91bnQgPSBjdXJyZW50X2Ftb3VudCArIGFtb3VudAogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1cGRhdGVkX2Ftb3VudH1cbiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIHVwZGF0ZV9odV9maWxlOiB7ZX0iKQoKZGVmIHVwZGF0ZV92aXBfZmlsZSh1c2VyX2lkLCB2aXBfcG9pbnRzKToKICAgIGZpbGVfcGF0aCA9ICJGSUxFL3ZpcC50eHQiCiAgICB0cnk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbGluZXMgPSBbXQoKICAgICAgICB1c2VyX2ZvdW5kID0gRmFsc2UKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBsaW5lX3VzZXJfaWQsIGxpbmVfdmlwX3BvaW50cyA9IHBhcnRzCiAgICAgICAgICAgICAgICBpZiBsaW5lX3VzZXJfaWQgPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIG5ld192aXBfcG9pbnRzID0gaW50KGxpbmVfdmlwX3BvaW50cykgKyB2aXBfcG9pbnRzCiAgICAgICAgICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7bmV3X3ZpcF9wb2ludHN9XG4iKQogICAgICAgICAgICAgICAgICAgIHVzZXJfZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGZpbGUud3JpdGUobGluZSkKICAgICAgICAgICAgaWYgbm90IHVzZXJfZm91bmQ6CiAgICAgICAgICAgICAgICBmaWxlLndyaXRlKGYie3VzZXJfaWR9IHt2aXBfcG9pbnRzfVxuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gdXBkYXRlX3ZpcF9maWxlOiB7ZX0iKQoKZGVmIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGUsIGFtb3VudCwgd2luX2Ftb3VudCk6CiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KGZsb2F0KGFtb3VudCkpCiAgICAgICAgd2luX2Ftb3VudCA9IGludChmbG9hdCh3aW5fYW1vdW50KSkKICAgICAgICBmb3JtYXR0ZWRfYW1vdW50ID0gZm9ybWF0X2JhbGFuY2UoYW1vdW50KSAgCiAgICAgICAgZm9ybWF0dGVkX3dpbiA9IGZvcm1hdF9iYWxhbmNlKHdpbl9hbW91bnQpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzY2hvaS50eHQiLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIGZpbGUud3JpdGUoZiJ7dXNlcl9pZH0ge2JldF90eXBlfSBDxrDhu6NjOiB7Zm9ybWF0dGVkX2Ftb3VudH0gVGjhuq9uZzoge2Zvcm1hdHRlZF93aW59XG4iKQogICAgICAgIHVwZGF0ZV9jaHVvaV9maWxlKHVzZXJfaWQsIHdpbl9hbW91bnQpCiAgICAgICAgdXBkYXRlX3RvcGN1b2ModXNlcl9pZCwgYW1vdW50KQogICAgICAgIHVwZGF0ZV90aGFuZ3RodWEodXNlcl9pZCwgYW1vdW50LCB3aW5fYW1vdW50KQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSB0cm9uZyB1cGRhdGVfZ2FtZV9oaXN0b3J5OiB7ZX0iKQoKIiIiZGVmIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGUsIGFtb3VudCwgd2luX2Ftb3VudCk6CiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KGZsb2F0KGFtb3VudCkpCiAgICAgICAgd2luX2Ftb3VudCA9IGludChmbG9hdCh3aW5fYW1vdW50KSkKCiAgICAgICAgZm9ybWF0dGVkX2Ftb3VudCA9IGZvcm1hdF9iYWxhbmNlKGFtb3VudCkKICAgICAgICBmb3JtYXR0ZWRfd2luID0gZm9ybWF0X2JhbGFuY2Uod2luX2Ftb3VudCkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEdoaSB2w6BvIGxzY2hvaS50eHQ6IHt1c2VyX2lkfSB7YmV0X3R5cGV9IEPGsOG7o2M6IHtmb3JtYXR0ZWRfYW1vdW50fSBUaOG6r25nOiB7Zm9ybWF0dGVkX3dpbn0iKQogICAgICAgIHdpdGggb3BlbigibHNjaG9pLnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7YmV0X3R5cGV9IHtmb3JtYXR0ZWRfYW1vdW50fSB7Zm9ybWF0dGVkX3dpbn1cbiIpCgogICAgICAgIHVwZGF0ZV9jaHVvaV9maWxlKHVzZXJfaWQsIHdpbl9hbW91bnQpCiAgICAgICAgdXBkYXRlX3RvcGN1b2ModXNlcl9pZCwgYW1vdW50KQogICAgICAgIHVwZGF0ZV90aGFuZ3RodWEodXNlcl9pZCwgYW1vdW50LCB3aW5fYW1vdW50KQoKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBj4bqtcCBuaOG6rXQgbOG7i2NoIHPhu60gZ2FtZSBjaG8ge3VzZXJfaWR9IHwgQ8aw4bujYzoge2Zvcm1hdHRlZF9hbW91bnR9IHwgVGjhuq9uZzoge2Zvcm1hdHRlZF93aW59IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIHRyb25nIHVwZGF0ZV9nYW1lX2hpc3Rvcnk6IHtlfSIpIiIiCgpkZWYgdXBkYXRlX3RvcGN1b2ModXNlcl9pZCwgYW1vdW50KToKICAgIGZpbGVfcGF0aCA9ICJGSUxFL3RvcGN1b2MudHh0IgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgYW1vdW50ID0gaW50KGZsb2F0KGFtb3VudCkpCiAgICBsaW5lcyA9IFtdCiAgICBmb3VuZCA9IEZhbHNlCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIHBhc3MKCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAicisiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB1c2VyX2luZm8gPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHVzZXJfaW5mbykgPCAzOgogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgKyAiXG4iKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgaWYgdXNlcl9pbmZvWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdG9kYXlfYmV0ID0gaW50KGZsb2F0KHVzZXJfaW5mb1sxXSkpICsgYW1vdW50CiAgICAgICAgICAgICAgICAgICAgd2Vla19iZXQgPSBpbnQoZmxvYXQodXNlcl9pbmZvWzJdKSkgKyBhbW91bnQKICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgIHRvZGF5X2JldCA9IGFtb3VudAogICAgICAgICAgICAgICAgICAgIHdlZWtfYmV0ID0gYW1vdW50CiAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge3RvZGF5X2JldH0ge3dlZWtfYmV0fVxuIikKICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgKyAiXG4iKQoKICAgICAgICBpZiBub3QgZm91bmQ6CiAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7YW1vdW50fSB7YW1vdW50fVxuIikKCiAgICAgICAgZi5zZWVrKDApCiAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQogICAgICAgIGYudHJ1bmNhdGUoKQoKZGVmIHVwZGF0ZV9jaHVvaV9maWxlKHVzZXJfaWQsIHdpbl9hbW91bnQpOgogICAgZmlsZV9wYXRoID0gIkZJTEUvY2h1b2l0aGFuZ3RodWEudHh0IgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgdXNlcl9kYXRhID0gTm9uZQogICAgY2h1b2lfZGF0YSA9IFtdCgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBwYXNzCgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIHVzZXJfZGF0YSA9IHBhcnRzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNodW9pX2RhdGEuYXBwZW5kKHBhcnRzKQoKICAgICAgICBpZiB1c2VyX2RhdGE6CiAgICAgICAgICAgIGlmIHdpbl9hbW91bnQgPiAwOgogICAgICAgICAgICAgICAgdXNlcl9kYXRhWzFdID0gc3RyKGludCh1c2VyX2RhdGFbMV0pICsgMSkgIAogICAgICAgICAgICAgICAgdXNlcl9kYXRhWzJdID0gIjAiICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1c2VyX2RhdGFbMV0gPSAiMCIKICAgICAgICAgICAgICAgIHVzZXJfZGF0YVsyXSA9IHN0cihpbnQodXNlcl9kYXRhWzJdKSArIDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgd2luX2Ftb3VudCA+IDA6CiAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSBbdXNlcl9pZCwgIjEiLCAiMCJdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSBbdXNlcl9pZCwgIjAiLCAiMSJdCgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGRhdGEgaW4gY2h1b2lfZGF0YToKICAgICAgICAgICAgICAgIGZpbGUud3JpdGUoIiAiLmpvaW4oZGF0YSkgKyAiXG4iKQogICAgICAgICAgICBmaWxlLndyaXRlKCIgIi5qb2luKHVzZXJfZGF0YSkgKyAiXG4iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gdXBkYXRlX2NodW9pX2ZpbGU6IHtlfSIpCgpkZWYgdXBkYXRlX3RoYW5ndGh1YSh1c2VyX2lkLCBhbW91bnQsIHdpbl9hbW91bnQpOgogICAgZmlsZV9wYXRoID0gIkZJTEUvdGhhbmd0aHVhLnR4dCIKICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgIGxpbmVzID0gW10KICAgIGZvdW5kID0gRmFsc2UKCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIHBhc3MKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIrIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX3dpbiA9IGludChwYXJ0c1sxXSkgKyAod2luX2Ftb3VudCAtIGFtb3VudCBpZiB3aW5fYW1vdW50ID4gYW1vdW50IGVsc2UgMCkKICAgICAgICAgICAgICAgICAgICB0b3RhbF9sb3NzID0gaW50KHBhcnRzWzJdKSArIChhbW91bnQgaWYgd2luX2Ftb3VudCA9PSAwIGVsc2UgMCkKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge3RvdGFsX3dpbn0ge3RvdGFsX2xvc3N9XG4iKQogICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQobGluZSkKCiAgICAgICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgICAgIHRvdGFsX3dpbiA9IHdpbl9hbW91bnQgLSBhbW91bnQgaWYgd2luX2Ftb3VudCA+IGFtb3VudCBlbHNlIDAKICAgICAgICAgICAgICAgIHRvdGFsX2xvc3MgPSBhbW91bnQgaWYgd2luX2Ftb3VudCA9PSAwIGVsc2UgMAogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHt0b3RhbF93aW59IHt0b3RhbF9sb3NzfVxuIikKCiAgICAgICAgICAgIGYuc2VlaygwKQogICAgICAgICAgICBmLndyaXRlbGluZXMobGluZXMpCiAgICAgICAgICAgIGYudHJ1bmNhdGUoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB1cGRhdGVfdGhhbmd0aHVhOiB7ZX0iKQoKZGVmIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWQsIGFtb3VudF90b19hZGQpOgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgbGluZXMgPSBbXQogICAgdXBkYXRlZF9iYWxhbmNlID0gTm9uZQoKICAgIHdpdGggYmFsYW5jZV9sb2NrOgogICAgICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAicisiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgdXNlcl9pbmZvID0gbGluZS5zdHJpcCgpLnNwbGl0KG1heHNwbGl0PTIpCiAgICAgICAgICAgICAgICBpZiB1c2VyX2luZm9bMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IGludChmbG9hdCh1c2VyX2luZm9bMV0pKSAgIyBi4buPIC4wCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IDAKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudF90b19hZGQgPSBpbnQoZmxvYXQoYW1vdW50X3RvX2FkZCkpICAjIGLhu48gLjAKICAgICAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50X3RvX2FkZCA9IDAKICAgICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19hZGQKICAgICAgICAgICAgICAgICAgICB2aXBodSA9IHVzZXJfaW5mb1syXSBpZiBsZW4odXNlcl9pbmZvKSA9PSAzIGVsc2UgIiIKICAgICAgICAgICAgICAgICAgICBpZiB2aXBodToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfYmFsYW5jZX0ge3ZpcGh1fVxuIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2JhbGFuY2UgPSBuZXdfYmFsYW5jZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQobGluZSBpZiBsaW5lLmVuZHN3aXRoKCdcbicpIGVsc2UgbGluZSArICdcbicpCgogICAgICAgICAgICBmLnNlZWsoMCkKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQogICAgICAgICAgICBmLnRydW5jYXRlKCkKCiAgICByZXR1cm4gdXBkYXRlZF9iYWxhbmNlIGlmIHVwZGF0ZWRfYmFsYW5jZSBpcyBub3QgTm9uZSBlbHNlIDAKCmRlZiBnZXRfdmljaGluaCh1c2VyX2lkOiBpbnQpIC0+IGludDoKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRS9zZC50eHQiKToKICAgICAgICByZXR1cm4gMAoKICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAncicsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+PSAyIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRhdGFbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIDAKCmRlZiB0cnVjdW9jdGllbih1c2VyX2lkLCBhbW91bnQpOgogICAgcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJjdW9jdGllbi50eHQiKQogICAgbmV3X2xpbmVzID0gW10KICAgIHVzZXJfZm91bmQgPSBGYWxzZQoKICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld192YWx1ZSA9IG1heCgwLCBjdXJyZW50IC0gYW1vdW50KQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfdmFsdWV9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGxpbmUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQobGluZSkKCiAgICAgICAgaWYgdXNlcl9mb3VuZDoKICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyhuZXdfbGluZXMpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSB1c2VyX2lkIHt1c2VyX2lkfSB0cm9uZyBmaWxlIGN1b2N0aWVuLnR4dCIpCiAgICBlbHNlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBGaWxlIHtwYXRofSBraMO0bmcgdOG7k24gdOG6oWkiKQogICAKZGVmIGNvbmdfaG9hX2hvbmdfdGh1YSh1c2VyX2lkLCBhbW91bnQpOgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgcmVmZXJyZXJfaWQgPSBOb25lCiAgICByZWZfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJyZWYudHh0IikKICAgIHNkX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAic2QudHh0IikKICAgIHRvbmdob2Fob25nX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAidG9uZ2hvYWhvbmcudHh0IikKICAgIGlmIG9zLnBhdGguZXhpc3RzKHJlZl9wYXRoKToKICAgICAgICB3aXRoIG9wZW4ocmVmX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMiBhbmQgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICByZWZlcnJlcl9pZCA9IHBhcnRzWzFdCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgIGlmIG5vdCByZWZlcnJlcl9pZDoKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IG5nxrDhu51pIGdp4bubaSB0aGnhu4d1IGNobyB1c2VyIHt1c2VyX2lkfSIpCiAgICAgICAgcmV0dXJuCiAgICB0cnk6CiAgICAgICAgcmVmZXJyZXJfaWQgPSBzdHIocmVmZXJyZXJfaWQpCiAgICAgICAgaG9haG9uZyA9IGludChhbW91bnQgKiAwLjAyKQogICAgICAgIHVwZGF0ZWRfc2QgPSBGYWxzZQogICAgICAgIHNkX2xpbmVzID0gW10KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhzZF9wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNkX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIHBhcnRzIGFuZCBwYXJ0c1swXSA9PSByZWZlcnJlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGludChmbG9hdChwYXJ0c1sxXSkpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19iYWwgPSBjdXJyZW50ICsgaG9haG9uZwogICAgICAgICAgICAgICAgICAgICAgICBzZF9saW5lcy5hcHBlbmQoZiJ7cmVmZXJyZXJfaWR9IHtuZXdfYmFsfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9zZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEPhu5luZyAyJSAoe2hvYWhvbmd9KSBjaG8gcmVmZXJyZXIge3JlZmVycmVyX2lkfSB2w6BvIHNkLnR4dCIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2RfbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgnXG4nKSBlbHNlIGxpbmUgKyAnXG4nKQogICAgICAgIGlmIG5vdCB1cGRhdGVkX3NkOgogICAgICAgICAgICBzZF9saW5lcy5hcHBlbmQoZiJ7cmVmZXJyZXJfaWR9IHtob2Fob25nfVxuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFThuqFvIG3hu5tpIHbDoCBj4buZbmcgMiUgKHtob2Fob25nfSkgY2hvIHJlZmVycmVyIHtyZWZlcnJlcl9pZH0gdsOgbyBzZC50eHQiKQogICAgICAgIHdpdGggb3BlbihzZF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGVsaW5lcyhzZF9saW5lcykKICAgICAgICB1cGRhdGVkX3RvbmcgPSBGYWxzZQogICAgICAgIHRvbmdfbGluZXMgPSBbXQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHRvbmdob2Fob25nX3BhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4odG9uZ2hvYWhvbmdfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydHMgYW5kIHBhcnRzWzBdID09IHJlZmVycmVyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZ2F5ID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHVhbiA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmdheSA9IHR1YW4gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19uZ2F5ID0gbmdheSArIGhvYWhvbmcKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3R1YW4gPSB0dWFuICsgaG9haG9uZwogICAgICAgICAgICAgICAgICAgICAgICB0b25nX2xpbmVzLmFwcGVuZChmIntyZWZlcnJlcl9pZH0ge25ld19uZ2F5fSB7bmV3X3R1YW59XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX3RvbmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSAre2hvYWhvbmd9IHbDoG8gdOG7lW5nIGhvYSBo4buTbmcgcmVmZXJyZXIge3JlZmVycmVyX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZ19saW5lcy5hcHBlbmQobGluZSBpZiBsaW5lLmVuZHN3aXRoKCdcbicpIGVsc2UgbGluZSArICdcbicpCiAgICAgICAgaWYgbm90IHVwZGF0ZWRfdG9uZzoKICAgICAgICAgICAgdG9uZ19saW5lcy5hcHBlbmQoZiJ7cmVmZXJyZXJfaWR9IHtob2Fob25nfSB7aG9haG9uZ31cbiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBU4bqhbyBt4bubaSByZWZlcnJlciB7cmVmZXJyZXJfaWR9IHRyb25nIHRvbmdob2Fob25nLnR4dCB24bubaSB7aG9haG9uZ30iKQogICAgICAgIHdpdGggb3Blbih0b25naG9haG9uZ19wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGVsaW5lcyh0b25nX2xpbmVzKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBj4buZbmcgaG9hIGjhu5NuZyBjaG8ge3JlZmVycmVyX2lkfToge2V9IikKCiIiImRlZiBnZXRfcGhvbmVfbnVtYmVyKHVzZXJfaWQpOgogICAgZmlsZXBhdGggPSAiRklMRS9jaGVja3Ntcy50eHQiCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZXBhdGgpOgogICAgICAgIHJldHVybiBOb25lCiAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMiBhbmQgcGFydHNbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRzWzFdCiAgICByZXR1cm4gTm9uZSIiIgoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WydjaGVjayddKQpkZWYgY2hlY2t1c2VyKG1lc3NhZ2UpOgogICAgc2VuZGVyX2lkID0gc3RyKG1lc3NhZ2UuZnJvbV91c2VyLmlkKQogICAgaXNfYWRtaW4gPSBzdHIobWVzc2FnZS5mcm9tX3VzZXIuaWQpIGluIFtzdHIoaSkgZm9yIGkgaW4gQURNSU5dCiAgICBpZiBub3QgaXNfYWRtaW46CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYWRtaW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgaXNfYWRtaW4gPSBhbnkoc2VuZGVyX2lkID09IGxpbmUuc3RyaXAoKSBmb3IgbGluZSBpbiBmKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgaWYgbm90IGlzX2FkbWluOgogICAgICAgIHJldHVybgogICAgYXJncyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgpCiAgICBpZiBtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2U6CiAgICAgICAgdXNlcl9pZCA9IHN0cihtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UuZnJvbV91c2VyLmlkKQogICAgICAgIGZ1bGxuYW1lID0gZiJ7bWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlci5maXJzdF9uYW1lIG9yICcnfSB7bWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlci5sYXN0X25hbWUgb3IgJyd9Ii5zdHJpcCgpCiAgICBlbGlmIGxlbihhcmdzKSA9PSAyIGFuZCBhcmdzWzFdLmlzZGlnaXQoKToKICAgICAgICB1c2VyX2lkID0gYXJnc1sxXQogICAgICAgIGZ1bGxuYW1lID0gIiIKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuCiAgICBkZWYgcmVhZF9maWxlX2xpbmVzKGZpbGVwYXRoKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGYucmVhZGxpbmVzKCkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHJldHVybiBbXQogICAgaXNfYmFubmVkID0gRmFsc2UKICAgIGJhbl9yZWFzb24gPSAiIgogICAgZm9yIGxpbmUgaW4gcmVhZF9maWxlX2xpbmVzKCJGSUxFL2Jhbi50eHQiKToKICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgodXNlcl9pZCk6CiAgICAgICAgICAgIGlzX2Jhbm5lZCA9IFRydWUKICAgICAgICAgICAgYmFuX3JlYXNvbiA9IGxpbmUuc3RyaXAoKS5zcGxpdCgnICcsIDEpWzFdIGlmICcgJyBpbiBsaW5lIGVsc2UgIiIKICAgICAgICAgICAgYnJlYWsKICAgIGRlZiBmb3JtYXRfbnVtYmVyKG4pOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIGYie2ludChuKTosfSIucmVwbGFjZSgiLCIsICIuIikKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAiMCIKICAgIGJhbGFuY2UgPSAiMCIKICAgIGZvciBsaW5lIGluIHJlYWRfZmlsZV9saW5lcygiRklMRS9zZC50eHQiKToKICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgodXNlcl9pZCk6CiAgICAgICAgICAgIGJhbGFuY2UgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKVsxXQogICAgICAgICAgICBicmVhawogICAgd2luLCBsb3NlID0gIjAiLCAiMCIKICAgIGZvciBsaW5lIGluIHJlYWRfZmlsZV9saW5lcygiRklMRS90aGFuZ3RodWEudHh0Iik6CiAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKHVzZXJfaWQpOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMzoKICAgICAgICAgICAgICAgIHdpbiwgbG9zZSA9IHBhcnRzWzFdLCBwYXJ0c1syXQogICAgICAgICAgICBicmVhawogICAgdG9uZ19uYXBfbW9tbyA9IDAKICAgIHRvbmdfbmFwX2JhbmsgPSAwCiAgICBmb3IgbGluZSBpbiByZWFkX2ZpbGVfbGluZXMoIkZJTEUvbHNuYXAudHh0Iik6CiAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKHVzZXJfaWQpOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiIC0gIikKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSA0OgogICAgICAgICAgICAgICAgaWYgcGFydHNbMl0uc3RyaXAoKS51cHBlcigpID09ICJNT01PIjoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmdfbmFwX21vbW8gKz0gaW50KHBhcnRzWzNdKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZWxpZiBwYXJ0c1syXS5zdHJpcCgpLnVwcGVyKCkgPT0gIkJBTksiOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZ19uYXBfYmFuayArPSBpbnQocGFydHNbM10pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICB0b25nX3J1dF9tb21vID0gMAogICAgdG9uZ19ydXRfYmFuayA9IDAKICAgIGZvciBsaW5lIGluIHJlYWRfZmlsZV9saW5lcygiRklMRS9sc3J1dC50eHQiKToKICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgodXNlcl9pZCkgYW5kICJ0aMOgbmggY8O0bmciIGluIGxpbmUubG93ZXIoKToKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAtICIpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gNiBhbmQgcGFydHNbMl0uc3RyaXAoKS51cHBlcigpID09ICJNT01PIjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB0b25nX3J1dF9tb21vICs9IGludChwYXJ0c1szXSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGVsaWYgbGVuKHBhcnRzKSA+PSA3IGFuZCBwYXJ0c1syXS5zdHJpcCgpLnVwcGVyKCkgPT0gIkJBTksiOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHRvbmdfcnV0X2JhbmsgKz0gaW50KHBhcnRzWzVdKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgIHRvbmdfbmFwID0gdG9uZ19uYXBfbW9tbyArIHRvbmdfbmFwX2JhbmsKICAgIHRvbmdfcnV0ID0gdG9uZ19ydXRfbW9tbyArIHRvbmdfcnV0X2JhbmsKICAgIHRleHQgPSAoCiAgICAgICAgZiJOZ8aw4budaSBjaMahaSBJRDogPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2lkfSc+e3VzZXJfaWR9PC9hPlxuIgogICAgICAgIGYiSW5mbzogPGI+e2Z1bGxuYW1lfTwvYj5cbiIKICAgICAgICBmIiAgU+G7kSBkxrA6IHtmb3JtYXRfbnVtYmVyKGJhbGFuY2UpfVxuIgogICAgICAgIGYiIC0gIFRo4bqvbmc6IHtmb3JtYXRfbnVtYmVyKHdpbil9XG4iCiAgICAgICAgZiIgLSAgVGh1YToge2Zvcm1hdF9udW1iZXIobG9zZSl9XG4iCiAgICAgICAgZiIgLSAgTuG6oXA6IHtmb3JtYXRfbnVtYmVyKHRvbmdfbmFwKX1cbiIKICAgICAgICBmIiAgICDilJwgTU9NTzoge2Zvcm1hdF9udW1iZXIodG9uZ19uYXBfbW9tbyl9XG4iCiAgICAgICAgZiIgICAg4pSUIEJBTks6IHtmb3JtYXRfbnVtYmVyKHRvbmdfbmFwX2JhbmspfVxuIgogICAgICAgIGYiIC0gIFLDunQ6IHtmb3JtYXRfbnVtYmVyKHRvbmdfcnV0KX1cbiIKICAgICAgICBmIiAgICDilJwgTU9NTzoge2Zvcm1hdF9udW1iZXIodG9uZ19ydXRfbW9tbyl9XG4iCiAgICAgICAgZiIgICAg4pSUIEJBTks6IHtmb3JtYXRfbnVtYmVyKHRvbmdfcnV0X2JhbmspfSIKICAgICkKICAgIGlmIGlzX2Jhbm5lZDoKICAgICAgICB0ZXh0ICs9IGYiXG48Yj5CYW5uZXI6IHtiYW5fcmVhc29ufTwvYj4iCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgdGV4dCwgcGFyc2VfbW9kZT0iSFRNTCIpCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ3NkJywgJ1NEJywgJ3NEJywgJ1NkJ10pCmRlZiBzZChtZXNzYWdlKToKICAgIEdST1VQX0lEID0gLTEwMDM1ODk5NDIyODcKCiAgICBpZiBtZXNzYWdlLmNoYXQuaWQgIT0gR1JPVVBfSUQ6CiAgICAgICAgcmV0dXJuCgogICAgdXNlciA9IG1lc3NhZ2UuZnJvbV91c2VyCiAgICB1c2VyX2lkID0gdXNlci5pZCAgCiAgICAiIiJwaG9uZSA9IGdldF9waG9uZV9udW1iZXIodXNlcl9pZCkKICAgIGlmIHBob25lIGlzIE5vbmU6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAiVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIHThuqFpIEJPVDogQG5pa2V2MWJvdCIKICAgICAgICApCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFnDqnUgY+G6p3UgeMOhYyBtaW5oIHPhu5EgxJFp4buHbiB0aG/huqFpIHThu6sgdXNlciB7dXNlcl9pZH0iKQogICAgICAgIHJldHVybiIiIgoKICAgIGlmIG5vdCBhY2NlcHRpbmdfYmV0czoKICAgICAgICBoYW5kbGVfYmV0X3JlcXVlc3QodXNlcl9pZCwgbWVzc2FnZS5jaGF0LmlkLCBtZXNzYWdlLm1lc3NhZ2VfaWQsIG1lc3NhZ2UudGV4dCkKICAgICAgICByZXR1cm4KCiAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZSBvciBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4KCiAgICB2aV9jaGluaCA9IGdldF92aWNoaW5oKHVzZXJfaWQpCiAgICB0b3RhbF9iZXRfdG9kYXkgPSBnZXRfYmV0X3RvZGF5KHVzZXJfaWQpCiAgICB0b3RhbF9odSA9IGdldF90b3RhbF9odSh1c2VyX2lkKQoKICAgIGRlZiBnZXRfdG90YWxfZ29waHUodXNlcl9pZCk6CiAgICAgICAgdG90YWwgPSAwCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvZ29waHUudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyIGFuZCBwYXJ0c1swXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsICs9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiB0b3RhbAoKICAgIHRvdGFsX2dvcGh1ID0gZ2V0X3RvdGFsX2dvcGh1KHVzZXJfaWQpCgogICAgZGVmIGZtdCh4KToKICAgICAgICBpZiB4IGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiAiMCIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHggPSBmbG9hdCh4KQogICAgICAgICAgICBpZiB4LmlzX2ludGVnZXIoKToKICAgICAgICAgICAgICAgIHJldHVybiBmIntpbnQoeCk6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gZiJ7eDosLjJmfSIucmVwbGFjZSgiLCIsICIuIikucnN0cmlwKCIwIikucnN0cmlwKCIuIikKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBzdHIoeCkKCiAgICBmdWxsX25hbWUgPSB1c2VyLmZ1bGxfbmFtZQogICAgcHJvZmlsZV9saW5rID0gZic8YSBocmVmPSJ0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9Ij57ZnVsbF9uYW1lfTwvYT4nCgogICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgZiIiIgp7cHJvZmlsZV9saW5rfQpWw60gY2jDrW5oOiA8Yj57Zm10KHZpX2NoaW5oKX08L2I+ClThu5VuZyBjxrDhu6NjIGNobyBoxak6IDxiPntmbXQodG90YWxfZ29waHUpfTwvYj4KICAgICAgICAiIiIsCiAgICAgICAgcmVwbHlfdG9fbWVzc2FnZV9pZD1tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WyduYXAnXSkKZGVmIG5hcHRpZW4obWVzc2FnZSk6CiAgICBHUk9VUF9JRCA9IC0xMDAzNTg5OTQyMjg3CgogICAgaWYgbWVzc2FnZS5jaGF0LmlkICE9IEdST1VQX0lEOgogICAgICAgIHJldHVybgoKICAgIHVpZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgIGhhbmRsZV9iZXRfcmVxdWVzdCh1aWQsIG1lc3NhZ2UuY2hhdC5pZCwgbWVzc2FnZS5tZXNzYWdlX2lkLCBtZXNzYWdlLnRleHQpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcmV0dXJuCgogICAgaWYgaXNfdXNlcl9iYW5uZWQodWlkKToKICAgICAgICByZXR1cm4KCiAgICAiIiJwaG9uZSA9IGdldF9waG9uZV9udW1iZXIodWlkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgdOG6oWkgQk9UOiBAbmlrZXYxYm90IgogICAgICAgICkKICAgICAgICBwcmludChmIltERUJVR10gWcOqdSBj4bqndSB4w6FjIG1pbmggc+G7kSDEkWnhu4duIHRob+G6oWkgdOG7qyB1c2VyIHt1aWR9IikKICAgICAgICByZXR1cm4iIiIKCiAgICBtYXJrdXAgPSBJbmxpbmVLZXlib2FyZE1hcmt1cCgpCiAgICBidXR0b24gPSBJbmxpbmVLZXlib2FyZEJ1dHRvbigiTuG6oXAgdGnhu4FuIHThuqFpIMSRw6J5IiwgdXJsPSJodHRwczovL3QubWUvdGluaGxpbmhib3Q/c3RhcnQ9bmFwdGllbiIpCiAgICBtYXJrdXAuYWRkKGJ1dHRvbikKCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIkNsaWNrIG7DunQgbsOgeSDEkeG7gyBu4bqhcCB0aeG7gW4gbsOoIG7DrSwgbmjhu5sgbuG6oXAgxJHDum5nIG7hu5lpIGR1bmcgbmhhIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsndG9wJ10pCmRlZiB0b3BzZChtZXNzYWdlKToKICAgIEdST1VQX0lEID0gLTEwMDM1ODk5NDIyODcKICAgIGlmIG1lc3NhZ2UuY2hhdC5pZCAhPSBHUk9VUF9JRDoKICAgICAgICBwcmludChmIltERUJVR10gTOG7h25oIC90b3AgdOG7qyBuaMOzbSBraMO0bmcgaOG7o3AgbOG7hzoge21lc3NhZ2UuY2hhdC5pZH0iKQogICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHttZXNzYWdlLmZyb21fdXNlci5pZH0gZ+G7rWkgbOG7h25oIC90b3AiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRS9zZC50eHQiKToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gRmlsZSBGSUxFL3NkLnR4dCBraMO0bmcgdOG7k24gdOG6oWkiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdWlkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKCiAgICAgICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBI4buHIHRo4buRbmcgxJFhbmcga2jDtG5nIG5o4bqtbiBjxrDhu6NjIikKICAgICAgICAgICAgaGFuZGxlX2JldF9yZXF1ZXN0KHVpZCwgbWVzc2FnZS5jaGF0LmlkLCBtZXNzYWdlLm1lc3NhZ2VfaWQsIG1lc3NhZ2UudGV4dCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiB04burIHVzZXIge3VpZH0gbMOgIGZvcndhcmQsIGLhu48gcXVhLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1aWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dWlkfSDEkcOjIGLhu4sgYmFuLCBi4buPIHF1YS4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIiIicGhvbmUgPSBnZXRfcGhvbmVfbnVtYmVyKHVpZCkKICAgICAgICBpZiBwaG9uZSBpcyBOb25lOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgIlZ1aSBsw7JuZyB4w6FjIG1pbmggU8SQVCB04bqhaSBCT1Q6IEBuaWtldjFib3QiCiAgICAgICAgICAgICkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFnDqnUgY+G6p3UgeMOhYyBtaW5oIHPhu5EgxJFp4buHbiB0aG/huqFpIHThu6sgdXNlciB7dWlkfSIpCiAgICAgICAgICAgIHJldHVybiIiIgoKICAgICAgICBwcmludCgiW0RFQlVHXSBC4bqvdCDEkeG6p3UgeOG7rSBsw70gdG9wIHThu6sgRklMRS9zZC50eHQiKQogICAgICAgIHRvcF9saXN0ID0gW10KICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc2QudHh0IiwgJ3InLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IGludChwYXJ0c1swXSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcl9pZCBpbiBBRE1JTjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHZpY2hpbmggPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHZpY2hpbmggPj0gMTAwMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcF9saXN0LmFwcGVuZCgodXNlcl9pZCwgdmljaGluaCkpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeOG7rSBsw70gZMOybmc6IHtsaW5lfSB8IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUb3AgaOG7o3AgbOG7hyAo4omlMTAwMCk6IHt0b3BfbGlzdH0iKQogICAgICAgIHRvcF9iYWxhbmNlcyA9IHNvcnRlZCh0b3BfbGlzdCwga2V5PWxhbWJkYSB4OiB4WzFdLCByZXZlcnNlPVRydWUpWzozXQogICAgICAgIHByaW50KGYiW0RFQlVHXSBUb3Agc2F1IHPhuq9wIHjhur9wOiB7dG9wX2JhbGFuY2VzfSIpCgogICAgICAgIGRlZiBmbXQoeCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiBmIntpbnQoeCk6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHJldHVybiBzdHIoeCkKCiAgICAgICAgZGVmIG1hc2tfdXNlcl9pZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuIHN0cih1c2VyX2lkKVs6Nl0gKyAiKioqIgoKICAgICAgICBtc2cgPSAiPGI+8J+StSBUb3Agc+G7kSBkxrA8L2I+XG4iCiAgICAgICAgaXNfaW5fdG9wID0gRmFsc2UKICAgICAgICBmb3IgdXNlcl9pZCwgc29kdSBpbiB0b3BfYmFsYW5jZXM6CiAgICAgICAgICAgIGxpbmUgPSBmInttYXNrX3VzZXJfaWQodXNlcl9pZCl9IHtmbXQoc29kdSl9IgogICAgICAgICAgICBpZiB1c2VyX2lkID09IHVpZDoKICAgICAgICAgICAgICAgIG1zZyArPSBmIjxiPntsaW5lfTwvYj5cbiIKICAgICAgICAgICAgICAgIGlzX2luX3RvcCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG1zZyArPSBmIntsaW5lfVxuIgoKICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiB0b3AgY2h14bqpbiBi4buLIGfhu61pOlxue21zZy5zdHJpcCgpfSIpCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtc2cuc3RyaXAoKSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRvw6BuIGPhu6VjIHRyb25nIC90b3A6IHtlfSIpCgpkZWYgc2VuZF9jb25maXJtYXRpb24oY2hhdF9pZCwgcmVwbHlfdG9fbXNnX2lkLCB0ZXh0KToKICAgIG1hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKCkKICAgIG1hcmt1cC5yb3coCiAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIkPDsyIsIHVybD0iaHR0cHM6Ly90Lm1lL3RpbmhsaW5oYm90P3N0YXJ0PW5hcHRpZW4iKSwKICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigiS8OzIiwgdXJsPSJodHRwczovL3QubWUvdGluaGxpbmhib3Q/c3RhcnQ9bmFwdGllbiIpCiAgICApCiAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsIHRleHQsIHJlcGx5X3RvX21lc3NhZ2VfaWQ9cmVwbHlfdG9fbXNnX2lkLCByZXBseV9tYXJrdXA9bWFya3VwKQoKZGVmIGlzX2FkbWluX2J5ZSh1c2VyX2lkKToKICAgIGlmIHVzZXJfaWQgaW4gQURNSU5CWUU6CiAgICAgICAgcmV0dXJuIFRydWUKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYWRtaW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBhZG1pbnMgPSBbaW50KGxpbmUuc3RyaXAoKSkgZm9yIGxpbmUgaW4gZiBpZiBsaW5lLnN0cmlwKCkuaXNkaWdpdCgpXQogICAgICAgICAgICByZXR1cm4gdXNlcl9pZCBpbiBhZG1pbnMKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gRmFsc2UKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsiYnllIl0pCmRlZiBoYW5kbGVfYnllKG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgaWYgaXNfYWRtaW5fYnllKHVzZXJfaWQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmRlbGV0ZV9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgbWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB4w7NhIHRpbiBuaOG6r24gL2J5ZToge2V9IikKCiAgICAgICAgdGFyZ2V0X25hbWUgPSBOb25lCiAgICAgICAgdGFyZ2V0X2lkID0gTm9uZQoKICAgICAgICAjIDEuIE7hur91IHJlcGx5IGFpIMSRw7MKICAgICAgICBpZiBtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2U6CiAgICAgICAgICAgIHRhcmdldF9uYW1lID0gbWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlci5mdWxsX25hbWUKICAgICAgICAgICAgdGFyZ2V0X2lkID0gbWVzc2FnZS5yZXBseV90b19tZXNzYWdlLmZyb21fdXNlci5pZAoKICAgICAgICAjIDIuIE7hur91IG5o4bqtcCAvYnllIGvDqG0gQHVzZXJuYW1lIGhv4bq3YyB1c2VyX2lkCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcGFydHMgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPiAxOgogICAgICAgICAgICAgICAgbWVudGlvbiA9IHBhcnRzWzFdCiAgICAgICAgICAgICAgICBpZiBtZW50aW9uLnN0YXJ0c3dpdGgoIkAiKToKICAgICAgICAgICAgICAgICAgICB0YXJnZXRfbmFtZSA9IG1lbnRpb24KICAgICAgICAgICAgICAgIGVsaWYgbWVudGlvbi5pc2RpZ2l0KCk6CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X2lkID0gaW50KG1lbnRpb24pCgogICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gxJHGsOG7o2MsIGZhbGxiYWNrIGzDoCBjaMOtbmggbmfGsOG7nWkgZ+G7rWkKICAgICAgICBpZiBub3QgdGFyZ2V0X25hbWUgYW5kIG5vdCB0YXJnZXRfaWQ6CiAgICAgICAgICAgIHRhcmdldF9uYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICAgICAgICAgIHRhcmdldF9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgICAgICMgR+G7rWkgbsO6dCB4w6FjIG5o4bqtbgogICAgICAgIG51dHVybChtZXNzYWdlLCBmIkLhuqFuIGPDsyBtdeG7kW4ge3RhcmdldF9uYW1lfSBjw7p0IGto4buPaSBncm91cCBraMO0bmc/IikKCkFETUlOQ09OR1RJRU4gPSBbODIwNTU2Nzg1MV0KCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsibW9uZXkiXSkKZGVmIGhhbmRsZV9uaGFudGllbihtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgaWYgaXNfYWRtaW5fYnllKHVzZXJfaWQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmRlbGV0ZV9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgbWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB4w7NhIHRpbiBuaOG6r24gL21vbmV5OiB7ZX0iKQogICAgICAgIG51dHVybChtZXNzYWdlLCAiQuG6oW4gY8OzIG114buRbiBuaOG6rW4gbOG6oWkgc+G7kSB0aeG7gW4gYmFuIMSR4bqndSBraMO0bmc/IikKCkFETUlOQllFID0gWzgyMDU1Njc4NTFdCgpkZWYgbnV0dXJsKG1lc3NhZ2UsIHF1ZXN0aW9uX3RleHRfdGVtcGxhdGUpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgaWYgaXNpbnN0YW5jZShBRE1JTkJZRSwgbGlzdCk6CiAgICAgICAgaWYgdXNlcl9pZCBub3QgaW4gQURNSU5CWUU6CiAgICAgICAgICAgIHJldHVybgogICAgZWxpZiB1c2VyX2lkICE9IEFETUlOQllFOgogICAgICAgIHJldHVybgoKICAgIGlmIG5vdCBtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2U6CiAgICAgICAgcmV0dXJuCgogICAgdGFyZ2V0X3VzZXIgPSBtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UuZnJvbV91c2VyCiAgICBmdWxsbmFtZSA9IGYie3RhcmdldF91c2VyLmZpcnN0X25hbWUgb3IgJyd9IHt0YXJnZXRfdXNlci5sYXN0X25hbWUgb3IgJyd9Ii5zdHJpcCgpCiAgICBxdWVzdGlvbiA9IHF1ZXN0aW9uX3RleHRfdGVtcGxhdGUuZm9ybWF0KGZ1bGxuYW1lPWZ1bGxuYW1lKQogICAgc2VuZF9jb25maXJtYXRpb24obWVzc2FnZS5jaGF0LmlkLCBtZXNzYWdlLnJlcGx5X3RvX21lc3NhZ2UubWVzc2FnZV9pZCwgcXVlc3Rpb24pCgpkZWYgZW5zdXJlX2ZpbGVfZXhpc3RzKGZpbGVfbmFtZSk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9uYW1lKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoJycpCgpkZWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZDogaW50KSAtPiBib29sOgogICAgd2l0aCBvcGVuKEJBTl9GSUxFLCAncicpIGFzIGY6CiAgICAgICAgYmFubmVkX3VzZXJzID0gZi5yZWFkKCkuc3BsaXRsaW5lcygpCiAgICByZXR1cm4gc3RyKHVzZXJfaWQpIGluIGJhbm5lZF91c2VycwoKZGVmIGdlbmVyYXRlX21kNShpbnB1dF9zdHJpbmcpOgogICAgcmV0dXJuIG1kNShpbnB1dF9zdHJpbmcuZW5jb2RlKCd1dGYtOCcpKS5oZXhkaWdlc3QoKQoKZGVmIGdlbmVyYXRlX3JhbmRvbV9zdHJpbmcobGVuZ3RoLCBjaGFycz1zdHJpbmcuYXNjaWlfbGV0dGVycyk6CiAgICByZXR1cm4gJycuam9pbihyYW5kb20uY2hvaWNlKGNoYXJzKSBmb3IgXyBpbiByYW5nZShsZW5ndGgpKQoKZGVmIGdlbmVyYXRlX21kNV9zdHJpbmcoc2Vzc2lvbl9udW1iZXIpOgogICAgcmFuZG9tXzlfbGV0dGVycyA9IGdlbmVyYXRlX3JhbmRvbV9zdHJpbmcoOSkKICAgIHJhbmRvbV8zX2RpZ2l0cyA9IGdlbmVyYXRlX3JhbmRvbV9zdHJpbmcoMywgc3RyaW5nLmRpZ2l0cykKICAgIGtleV9tZDUgPSBmIlpJTUJBe3Nlc3Npb25fbnVtYmVyfV97cmFuZG9tXzlfbGV0dGVyc31fe3JhbmRvbV8zX2RpZ2l0c30iCiAgICBtZDVfaGFzaCA9IGhhc2hsaWIubWQ1KGtleV9tZDUuZW5jb2RlKCkpLmhleGRpZ2VzdCgpCiAgICByZXR1cm4ga2V5X21kNSwgbWQ1X2hhc2gKCmRlZiBzYXZlX3Nlc3Npb25fdG9fZmlsZSgpOgogICAgd2l0aCBvcGVuKCJGSUxFL3BoaWVuLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICBmaWxlLndyaXRlKHN0cihjdXJyZW50X3Nlc3Npb24pKQoKZGVmIGxvYWRfc2Vzc2lvbl9mcm9tX2ZpbGUoKToKICAgIGdsb2JhbCBjdXJyZW50X3Nlc3Npb24KICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvcGhpZW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBjb250ZW50ID0gZmlsZS5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICBpZiBjb250ZW50OgogICAgICAgICAgICAgICAgY3VycmVudF9zZXNzaW9uID0gaW50KGNvbnRlbnQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBjdXJyZW50X3Nlc3Npb24gPSAxCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgY3VycmVudF9zZXNzaW9uID0gMQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcHJpbnQoIkThu68gbGnhu4d1IGtow7RuZyBo4bujcCBs4buHIHRyb25nIHThu4dwIEZJTEUvcGhpZW4udHh0IikKICAgICAgICBjdXJyZW50X3Nlc3Npb24gPSAxCgpsb2FkX3Nlc3Npb25fZnJvbV9maWxlKCkKCmRlZiBmb3JtYXRfbnVtYmVyKG51bWJlcl9zdHIpOgogICAgdHJ5OgogICAgICAgIHJldHVybiAnezosfScuZm9ybWF0KGludChudW1iZXJfc3RyKSkucmVwbGFjZSgiLCIsICIuIikKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHJldHVybiAnMCcKCmRlZiBnZXRfYmFsYW5jZSh1c2VyX2lkOiBpbnQpIC0+IGludDoKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oU0RfRklMRSwgJ3InKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKHN0cih1c2VyX2lkKSk6CiAgICAgICAgICAgICAgICAgICAgYmFsYW5jZV9zdHIgPSBsaW5lLnNwbGl0KClbMV0KICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gZmxvYXQoYmFsYW5jZV9zdHIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChiYWxhbmNlKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJldHVybiAwCiAgICByZXR1cm4gMAoKZGVmIHJlYWRfc2Vzc2lvbl9udW1iZXIoKToKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oJ0ZJTEUvcGhpZW4udHh0JywgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICBzZXNzaW9uX251bWJlciA9IGZpbGUucmVhZGxpbmUoKS5zdHJpcCgpCiAgICAgICAgICAgIHJldHVybiBzZXNzaW9uX251bWJlcgogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJldHVybiAiMCIKCmRlZiBnZW5lcmF0ZV9yYW5kb21fbnVtYmVyKGxlbmd0aD03KToKICAgIHJldHVybiAnJy5qb2luKFtzdHIocmFuZG9tLnJhbmRpbnQoMCwgOSkpIGZvciBfIGluIHJhbmdlKGxlbmd0aCldKQoKZGVmIHJhbmRvbV92aXBfcG9pbnRzKGJldF9hbW91bnQpOgogICAgaWYgNDAwMDAgPD0gYmV0X2Ftb3VudCA8PSAxMDAwMDA6CiAgICAgICAgcG9pbnRzID0gWzAsIDEsIDIsIDNdCiAgICAgICAgcHJvYmFiaWxpdGllcyA9IFswLjY1LCAwLjI1LCAwLjI1LCAwLjE1XQogICAgZWxpZiAxMDEwMDAgPD0gYmV0X2Ftb3VudCA8PSAyMDAwMDA6CiAgICAgICAgcG9pbnRzID0gWzAsIDEsIDIsIDMsIDQsIDVdCiAgICAgICAgcHJvYmFiaWxpdGllcyA9IFswLjY1LCAwLjI1LCAwLjI1LCAwLjI1LCAwLjE1LCAwLjE1XQogICAgZWxpZiBiZXRfYW1vdW50ID49IDMwMDAwMDoKICAgICAgICBwb2ludHMgPSBbMCwgMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgOSwgMTBdCiAgICAgICAgcHJvYmFiaWxpdGllcyA9IFswLjYwLCAwLjI1LCAwLjI1LCAwLjI1LCAwLjI1LCAwLjI1LCAwLjI1LCAwLjE1LCAwLjE1LCAwLjA1LCAwLjAwMDVdCiAgICBlbHNlOgogICAgICAgIHJldHVybiAwCiAgICBpZiByYW5kb20ucmFuZG9tKCkgPD0gMC4yNToKICAgICAgICByZXR1cm4gcmFuZG9tLmNob2ljZXMocG9pbnRzLCBwcm9iYWJpbGl0aWVzKVswXQogICAgZWxzZToKICAgICAgICByZXR1cm4gMAoKZGVmIGdldF9iZXRfdG9kYXkodXNlcl9pZDogaW50KSAtPiBpbnQ6CiAgICBmaWxlX3BhdGggPSAiRklMRS90b3BjdW9jLnR4dCIKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiAwCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiICIpCiAgICAgICAgICAgIGlmIGRhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQoZmxvYXQoZGF0YVsxXSkpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgIHJldHVybiAwCgpkZWYgZ2V0X3ZpY2hpbmgodXNlcl9pZDogaW50KSAtPiBpbnQ6CiAgICBmaWxlX3BhdGggPSAiRklMRS9zZC50eHQiCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICByZXR1cm4gMAogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4oZGF0YSkgPj0gMiBhbmQgZGF0YVswXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChkYXRhWzFdKQogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgIHJldHVybiAwCgoiIiJkZWYgZ2V0X3ZpYmFpY2FvKHVzZXJfaWQ6IGludCkgLT4gaW50OgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJzZC50eHQiKToKICAgICAgICByZXR1cm4gMAoKICAgIHdpdGggb3Blbigic2QudHh0IiwgJ3InLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4oZGF0YSkgPj0gMyBhbmQgZGF0YVswXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChkYXRhWzJdKQogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgIHJldHVybiAwIiIiCgpkZWYgZ2V0X3RvdGFsX2h1KHVzZXJfaWQ6IGludCkgLT4gaW50OgogICAgZmlsZV9wYXRoID0gIkZJTEUvZ29waHUudHh0IgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEZpbGUgJ3tmaWxlX3BhdGh9JyBraMO0bmcgdOG7k24gdOG6oWkuIikKICAgICAgICByZXR1cm4gMAoKICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICBkYXRhID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKGRhdGEpID49IDIgYW5kIGRhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQoZGF0YVsxXSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBjaHV54buDbiDEkeG7lWkgc+G7kSB04burIGTDsm5nOiB7bGluZS5zdHJpcCgpfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgIHJldHVybiAwCgpkZWYgZ2V0X3RvdGFsX2h1X2FjY3VtdWxhdGVkKHVzZXJfaWQ6IGludCkgLT4gaW50OgogICAgZmlsZV9wYXRoID0gIkZJTEUvZ29waHUudHh0IgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEZpbGUgJ3tmaWxlX3BhdGh9JyBraMO0bmcgdOG7k24gdOG6oWkuIikKICAgICAgICByZXR1cm4gMAoKICAgIHRvdGFsX2h1ID0gMAogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4oZGF0YSkgPj0gMjoKICAgICAgICAgICAgICAgIHVpZCA9IGRhdGFbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgYW1vdW50X3N0ciA9IGRhdGFbMV0uc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgdWlkID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChhbW91bnRfc3RyKQogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9odSArPSBhbW91bnQKICAgICAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIETDsm5nIGzhu5dpIMSR4buLbmggZOG6oW5nIHPhu5E6ICd7YW1vdW50X3N0cn0nIHThu6sgdXNlcl9pZCB7dXNlcl9pZH0iKQogICAgcmV0dXJuIHRvdGFsX2h1Cgpib3Rfc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCmxhc3RfbWVzc2FnZV90aW1lID0ge30KCmRlZiBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgIGlmIHVzZXJfaWQgaW4gbGFzdF9tZXNzYWdlX3RpbWU6CiAgICAgICAgZWxhcHNlZF90aW1lID0gY3VycmVudF90aW1lIC0gbGFzdF9tZXNzYWdlX3RpbWVbdXNlcl9pZF0KICAgICAgICBpZiBlbGFwc2VkX3RpbWUgPCAxOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGxhc3RfbWVzc2FnZV90aW1lW3VzZXJfaWRdID0gY3VycmVudF90aW1lCiAgICByZXR1cm4gVHJ1ZQoKZGVmIG5vdGlmeV9ncm91cChmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIHRyYW5zYWN0aW9uX2NvZGUsIG5ld19iYWxhbmNlKToKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBtZXNzYWdlX3RleHQgPSAoZiIqTmfGsOG7nWkgZMO5bmc6KiAgW3tmdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pXG4iCiAgICAgICAgICAgICAgICAgICAgZiIqSUQ6KiBbe3VzZXJfaWR9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9KVxuIgogICAgICAgICAgICAgICAgICAgIGYiKlBoacOqbjoqICN7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqQ8aw4bujYzoqIHtiZXRfdHlwZX1cbiIKICAgICAgICAgICAgICAgICAgICBmIipT4buRIHRp4buBbjoqIHtiZXRfYW1vdW50fVxuIgogICAgICAgICAgICAgICAgICAgIGYiKk1HRDoqIHt0cmFuc2FjdGlvbl9jb2RlfVxuIgogICAgICAgICAgICAgICAgICAgIGYiU+G7kSBkxrA6IHtuZXdfYmFsYW5jZX0g4oKrIikKCiAgICB0cnk6CiAgICAgICAgYm90My5zZW5kX21lc3NhZ2UoR1JPVVBfQ0hBVF9JRCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5NQVJLRE9XTikKICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIMSRw6MgZ+G7rWkgdGjDoG5oIGPDtG5nIMSR4bq/biBuaMOzbS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ+G7rWkgdGluIG5o4bqvbiDEkeG6v24gbmjDs206IHtlfSIpCgpkZWYgbm90aWZ5X2dyb3VwMShmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIG5ld19iYWxhbmNlKToKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBtZXNzYWdlX3RleHQgPSAoCiAgICAgICAgZiIqTmfGsOG7nWkgZMO5bmc6KiBbe2Z1bGxuYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyX2lkfSlcbiIKICAgICAgICBmIipJRDoqIGB7dXNlcl9pZH1gXG4iCiAgICAgICAgZiIqUGhpw6puOiogI3tzZXNzaW9uX251bWJlcn1cbiIKICAgICAgICBmIipDxrDhu6NjOioge2JldF90eXBlfVxuIgogICAgICAgIGYiKlPhu5EgdGnhu4FuOioge2JldF9hbW91bnR9XG4iCiAgICAgICAgZiIqU+G7kSBkxrA6KiB7bmV3X2JhbGFuY2V9IOKCqyIKICAgICkKCiAgICB0cnk6CiAgICAgICAgYm90My5zZW5kX21lc3NhZ2UoR1JPVVBfQ0hBVF9JRCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5NQVJLRE9XTikKICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyBjxrDhu6NjIHRow6BuaCBjw7RuZyDEkeG6v24gbmjDs20uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRpbiBuaOG6r24gxJHhur9uIG5ow7NtOiB7ZX0iKQoKZGVmIG5vdGlmeV9ncm91cDIoZnVsbG5hbWUsIHVzZXJfaWQsIGJldF90eXBlLCBiZXRfYW1vdW50LCBuZXdfYmFsYW5jZSk6CiAgICBzZXNzaW9uX251bWJlciA9IHJlYWRfc2Vzc2lvbl9udW1iZXIoKQogICAgbWVzc2FnZV90ZXh0ID0gKAogICAgICAgIGYiKk5nxrDhu51pIGTDuW5nOiogW3tmdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pXG4iCiAgICAgICAgZiIqSUQ6KiBge3VzZXJfaWR9YFxuIgogICAgICAgIGYiKlBoacOqbjoqICN7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiIqQ8aw4bujYzoqIHtiZXRfdHlwZX1cbiIKICAgICAgICBmIipT4buRIHRp4buBbjoqIHtiZXRfYW1vdW50fVxuIgogICAgICAgIGYiKlPhu5EgZMawOioge25ld19iYWxhbmNlfSDigqsiCiAgICApCgogICAgdHJ5OgogICAgICAgIGJvdDMuc2VuZF9tZXNzYWdlKEdST1VQX0NIQVRfSUQsIG1lc3NhZ2VfdGV4dCwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuTUFSS0RPV04pCiAgICAgICAgcHJpbnQoIltERUJVR10gR+G7rWkgdGjDtG5nIGLDoW8gY8aw4bujYyBCQU8gdGjDoG5oIGPDtG5nIMSR4bq/biBuaMOzbS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ+G7rWkgdGluIG5o4bqvbiDEkeG6v24gbmjDs206IHtlfSIpCgpkZWYgbm90aWZ5X2dyb3VwMyhmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIG5ld19iYWxhbmNlKToKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBtZXNzYWdlX3RleHQgPSAoCiAgICAgICAgZiIqTmfGsOG7nWkgZMO5bmc6KiBbe2Z1bGxuYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyX2lkfSlcbiIKICAgICAgICBmIipJRDoqIGB7dXNlcl9pZH1gXG4iCiAgICAgICAgZiIqUGhpw6puOiogI3tzZXNzaW9uX251bWJlcn1cbiIKICAgICAgICBmIipDxrDhu6NjOioge2JldF90eXBlfVxuIgogICAgICAgIGYiKlPhu5EgdGnhu4FuOioge2JldF9hbW91bnR9XG4iCiAgICAgICAgZiIqU+G7kSBkxrA6KiB7bmV3X2JhbGFuY2V9IOKCqyIKICAgICkKCiAgICB0cnk6CiAgICAgICAgYm90My5zZW5kX21lc3NhZ2UoR1JPVVBfQ0hBVF9JRCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5NQVJLRE9XTikKICAgICAgICBwcmludChmIltERUJVR10gbm90aWZ5X2dyb3VwMyBn4butaSB0aMOgbmggY8O0bmcgY2hvIHVzZXJfaWQ9e3VzZXJfaWR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIG5vdGlmeV9ncm91cDM6IHtlfSIpCgpkZWYgbm90aWZ5X2dyb3VwNChmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIG5ld19iYWxhbmNlKTogCiAgICBzZXNzaW9uX251bWJlciA9IHJlYWRfc2Vzc2lvbl9udW1iZXIoKQogICAgbWVzc2FnZV90ZXh0ID0gKAogICAgICAgIGYiKk5nxrDhu51pIGTDuW5nOiogW3tmdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pXG4iCiAgICAgICAgZiIqSUQ6KiBge3VzZXJfaWR9YFxuIgogICAgICAgIGYiKlBoacOqbjoqICN7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiIqQ8aw4bujYzoqIHtiZXRfdHlwZX1cbiIKICAgICAgICBmIipT4buRIHRp4buBbjoqIHtiZXRfYW1vdW50fVxuIgogICAgICAgIGYiKlPhu5EgZMawOioge25ld19iYWxhbmNlfSIKICAgICkKCiAgICB0cnk6CiAgICAgICAgYm90My5zZW5kX21lc3NhZ2UoR1JPVVBfQ0hBVF9JRCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5NQVJLRE9XTikKICAgICAgICBwcmludChmIltERUJVR10gbm90aWZ5X2dyb3VwNCBn4butaSB0aMOgbmggY8O0bmcgY2hvIHVzZXJfaWQ9e3VzZXJfaWR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIG5vdGlmeV9ncm91cDQ6IHtlfSIpCgpkZWYgbm90aWZ5X2dyb3VwNShmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIG5ld19iYWxhbmNlKToKICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICBmIipOZ8aw4budaSBjaMahaToqIFt7ZnVsbG5hbWV9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9KVxuIgogICAgICAgIGYiKklEOiogYHt1c2VyX2lkfWBcbiIKICAgICAgICBmIipMb+G6oWkgY8aw4bujYzoqIHtiZXRfdHlwZX1cbiIKICAgICAgICBmIipT4buRIHRp4buBbiBjxrDhu6NjOioge2JldF9hbW91bnR9XG4iCiAgICAgICAgZiIqU+G7kSBkxrAgY8OybiBs4bqhaToqIHtuZXdfYmFsYW5jZX0iCiAgICApCiAgICB0cnk6CiAgICAgICAgYm90My5zZW5kX21lc3NhZ2UoR1JPVVBfQ0hBVF9JRCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5NQVJLRE9XTikKICAgICAgICBwcmludChmIltERUJVR10gbm90aWZ5X2dyb3VwNSBn4butaSB0aMOgbmggY8O0bmcgY2hvIHVzZXJfaWQ9e3VzZXJfaWR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIGfhu61pIG5vdGlmeV9ncm91cDU6IHtlfSIpCgpkZWYgZW5zdXJlX2ZpbGVfZm9sZGVyKCk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoIkZJTEUiKToKICAgICAgICBvcy5tYWtlZGlycygiRklMRSIpCgpkZWYgbG9nX2dvcGh1KHVzZXJfaWQsIGJldF9hbW91bnQpOgogICAgdHJ5OgogICAgICAgIGVuc3VyZV9maWxlX2ZvbGRlcigpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2dvcGh1LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7YmV0X2Ftb3VudH1cbiIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIOKchSDEkMOjIGdoaSB2w6BvIEZJTEUvZ29waHUudHh0OiB7dXNlcl9pZH0ge2JldF9hbW91bnR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBpbXBvcnQgdHJhY2ViYWNrCiAgICAgICAgcHJpbnQoZiJbRVJST1JdIOKdjCBM4buXaSBraGkgZ2hpIEZJTEUvZ29waHUudHh0Olxue3RyYWNlYmFjay5mb3JtYXRfZXhjKCl9IikKCmRlZiBoYW5kbGVfYmV0X3R4Y2wobWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGNoYXRfaWQgPSBtZXNzYWdlLmNoYXQuaWQKICAgIG1lc3NhZ2VfdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KCkKICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgIHJldHVybgogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgcmV0dXJuCiAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICByZXR1cm4KICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgIHJldHVybgogICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgIGhhbmRsZV9iZXRfcmVxdWVzdCh1c2VyX2lkLCBjaGF0X2lkLCBtZXNzYWdlLm1lc3NhZ2VfaWQsIG1lc3NhZ2UudGV4dCkKICAgICAgICByZXR1cm4KICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgdOG6oWkgQk9UOiBAbmlrZXYxYm90IikKICAgICAgICByZXR1cm4iIiIKICAgIGlmIGNoYXRfaWQgIT0gZ3JvdXBfY2hhdF9pZDoKICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsICJWdWkgbMOybmcgdGhhbSBnaWEgbmjDs20gQHZJeHg1Ml9yb29tIikKICAgICAgICByZXR1cm4KICAgIGlmIGxlbihtZXNzYWdlX3RleHQpICE9IDI6CiAgICAgICAgcmV0dXJuCiAgICBiZXRfdHlwZV9yYXcgPSBtZXNzYWdlX3RleHRbMF0ubG93ZXIoKQogICAgYmV0X2Ftb3VudF9zdHIgPSBtZXNzYWdlX3RleHRbMV0udXBwZXIoKQogICAgYmV0X3R5cGVfbWFwID0gewogICAgICAgICd0JzogJ1TDoGknLAogICAgICAgICd0IG1heCc6ICdUw6BpJywKICAgICAgICAneCc6ICdY4buJdScsCiAgICAgICAgJ3ggbWF4JzogJ1jhu4l1JywKICAgICAgICAnYyc6ICdDaOG6tW4nLAogICAgICAgICdjIG1heCc6ICdDaOG6tW4nLAogICAgICAgICdsJzogJ0zhursnLAogICAgICAgICdsIG1heCc6ICdM4bq7Jyx9CiAgICBpZiBiZXRfdHlwZV9yYXcgbm90IGluIGJldF90eXBlX21hcDoKICAgICAgICByZXR1cm4KICAgIGJldF90eXBlID0gYmV0X3R5cGVfbWFwW2JldF90eXBlX3Jhd10KICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKCiAgICBpZiBiYWxhbmNlIGlzIE5vbmUgb3IgYmFsYW5jZSA9PSAwOgogICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIjxiPlPhu5EgZMawIGtow7RuZyDEkeG7pzwvYj4iLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgIHJldHVybgogICAgaWYgYmFsYW5jZSA8IDUwMDA6CiAgICAgICAgYm90Mi5yZXBseV90byhtZXNzYWdlLCAiPGI+TWluIGPGsOG7o2MgaGnhu4duIHThuqFpIGzDoDo1LjAwMDwvYj4iLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgIHJldHVybgogICAgZGVmIHRvdGFsX2JldF9hbW91bnQoZmlsZW5hbWUpOgogICAgICAgIHRvdGFsID0gMAogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGYiRklMRS97ZmlsZW5hbWV9IiwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMyBhbmQgcGFydHNbMF0gPT0gZiIje3Nlc3Npb25fbnVtYmVyfSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsICs9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHRvdGFsCiAgICBpZiBiZXRfdHlwZSA9PSAnVMOgaSc6CiAgICAgICAgdG90YWxfdGhpcyA9IHRvdGFsX2JldF9hbW91bnQoJ3RhaS50eHQnKQogICAgICAgIHRvdGFsX29wcG9zaXRlID0gdG90YWxfYmV0X2Ftb3VudCgneGl1LnR4dCcpCiAgICAgICAgZmlsZV90aGlzID0gJ3RhaS50eHQnCiAgICAgICAgZmlsZV9vcHBvc2l0ZSA9ICd4aXUudHh0JwogICAgICAgIG9wcG9zaXRlX25hbWUgPSAnWOG7iXUnCiAgICBlbGlmIGJldF90eXBlID09ICdY4buJdSc6CiAgICAgICAgdG90YWxfdGhpcyA9IHRvdGFsX2JldF9hbW91bnQoJ3hpdS50eHQnKQogICAgICAgIHRvdGFsX29wcG9zaXRlID0gdG90YWxfYmV0X2Ftb3VudCgndGFpLnR4dCcpCiAgICAgICAgZmlsZV90aGlzID0gJ3hpdS50eHQnCiAgICAgICAgZmlsZV9vcHBvc2l0ZSA9ICd0YWkudHh0JwogICAgICAgIG9wcG9zaXRlX25hbWUgPSAnVMOgaScKICAgIGVsaWYgYmV0X3R5cGUgPT0gJ0No4bq1bic6CiAgICAgICAgdG90YWxfdGhpcyA9IHRvdGFsX2JldF9hbW91bnQoJ2NoYW4udHh0JykKICAgICAgICB0b3RhbF9vcHBvc2l0ZSA9IHRvdGFsX2JldF9hbW91bnQoJ2xlLnR4dCcpCiAgICAgICAgZmlsZV90aGlzID0gJ2NoYW4udHh0JwogICAgICAgIGZpbGVfb3Bwb3NpdGUgPSAnbGUudHh0JwogICAgICAgIG9wcG9zaXRlX25hbWUgPSAnTOG6uycKICAgIGVsc2U6ICAKICAgICAgICB0b3RhbF90aGlzID0gdG90YWxfYmV0X2Ftb3VudCgnbGUudHh0JykKICAgICAgICB0b3RhbF9vcHBvc2l0ZSA9IHRvdGFsX2JldF9hbW91bnQoJ2NoYW4udHh0JykKICAgICAgICBmaWxlX3RoaXMgPSAnbGUudHh0JwogICAgICAgIGZpbGVfb3Bwb3NpdGUgPSAnY2hhbi50eHQnCiAgICAgICAgb3Bwb3NpdGVfbmFtZSA9ICdDaOG6tW4nCiAgICBwcmludChmIltERUJVR10gVOG7lW5nIGPGsOG7o2Mge2JldF90eXBlfToge3RvdGFsX3RoaXN9LCBU4buVbmcgY8aw4bujYyB7b3Bwb3NpdGVfbmFtZX06IHt0b3RhbF9vcHBvc2l0ZX0iKQogICAgbWF4X2JldF9hbW91bnQgPSB0b3RhbF9vcHBvc2l0ZSArIDUwMDAwMCAtIHRvdGFsX3RoaXMKICAgIGlmIG1heF9iZXRfYW1vdW50IDw9IDA6CiAgICAgICAgYm90Mi5yZXBseV90byhtZXNzYWdlLCAiPGI+Q2jDqm5oIGzhu4djaCBraMO0bmcgcXXDoSA1MDAuMDAwPC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgcmV0dXJuCiAgICBpZiBiZXRfYW1vdW50X3N0ciA9PSAnTUFYJzoKICAgICAgICBiZXRfYW1vdW50ID0gbWluKGJhbGFuY2UsIG1heF9iZXRfYW1vdW50KQogICAgZWxzZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJldF9hbW91bnQgPSBpbnQoYmV0X2Ftb3VudF9zdHIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsICI8Yj5T4buRIGTGsCBraMO0bmcgxJHhu6c8L2I+IiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYmV0X2Ftb3VudCA8IDUwMDA6CiAgICAgICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIjxiPk1pbiBjxrDhu6NjIGhp4buHbiB04bqhaSBsw6A6NS4wMDA8L2I+IiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYmV0X2Ftb3VudCA+IG1heF9iZXRfYW1vdW50OgogICAgICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsIGYiPGI+TWF4IGPGsOG7o2MgaGnhu4duIHThuqFpIGzDoDoge2Zvcm1hdF9udW1iZXIoc3RyKG1heF9iZXRfYW1vdW50KSl9PC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmIkZJTEUve2ZpbGVfb3Bwb3NpdGV9IiwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gZiIje3Nlc3Npb25fbnVtYmVyfSIgYW5kIHBhcnRzWzFdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsICI8Yj5LaMO0bmcgxJHGsOG7o2MgcGjDqXAgxJHhurd0IDIgY+G7rWE8L2I+IiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwYXNzCiAgICBuZXdfYmFsYW5jZSA9IG1heChiYWxhbmNlIC0gYmV0X2Ftb3VudCwgMCkKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmFsYW5jZSkKICAgIHdpdGggb3BlbihmIkZJTEUve2ZpbGVfdGhpc30iLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgZi53cml0ZShmIiN7c2Vzc2lvbl9udW1iZXJ9IHt1c2VyX2lkfSB7YmV0X2Ftb3VudH1cbiIpCiAgICB3aXRoIG9wZW4oIkZJTEUvbHNjaG9pLnR4dCIsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICBzaG9ydF9jb2RlID0gYmV0X3R5cGVbMF0udXBwZXIoKSAgIyBULCBYLCBDLCBMCiAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7c2hvcnRfY29kZX0ge2JldF9hbW91bnR9XG4iKQogICAgbG9nX2dvcGh1KHVzZXJfaWQsIGJldF9hbW91bnQpCiAgICBmb3JtYXR0ZWRfYmFsYW5jZSA9IGZvcm1hdF9udW1iZXIoc3RyKG5ld19iYWxhbmNlKSkKICAgIHJhbmRvbV9udW1iZXIgPSBnZW5lcmF0ZV9yYW5kb21fbnVtYmVyKCkKICAgIG5vdGUgPSAie0PDom4gY+G7rWF9IiBpZiBiZXRfYW1vdW50ID09IG1heF9iZXRfYW1vdW50IGVsc2UgIiIKICAgIGJvdDIucmVwbHlfdG8oCiAgICAgICAgbWVzc2FnZSwKICAgICAgICBmIjxiPntyYW5kb20uY2hvaWNlKGljb25zKX3EkOG6t3QgdGjDoG5oIGPDtG5nIGvhu7MgWFggI3tzZXNzaW9uX251bWJlcn1cbntiZXRfdHlwZX0ge2Zvcm1hdF9udW1iZXIoc3RyKGJldF9hbW91bnQpKX3EkTwvYj5cbntub3RlfSIscGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICBmIsSQ4bq3dCB0aMOgbmggY8O0bmcga+G7syBYWCB7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiJNR0Q6IHtyYW5kb21fbnVtYmVyfVxuIgogICAgICAgIGYie2JldF90eXBlfSB7Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpfVxuIgogICAgICAgIGYiU+G7kSBkxrA6IHtmb3JtYXR0ZWRfYmFsYW5jZX0iKQogICAgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgbWVzc2FnZV90ZXh0KQogICAgdXNlcl9mdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUgb3IgIiIKICAgIG5vdGlmeV9ncm91cCgKICAgICAgICBmdWxsbmFtZT11c2VyX2Z1bGxuYW1lLAogICAgICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgICAgICBiZXRfdHlwZT1iZXRfdHlwZSwKICAgICAgICBiZXRfYW1vdW50PWZvcm1hdF9udW1iZXIoc3RyKGJldF9hbW91bnQpKSArICcg4oKrJywKICAgICAgICB0cmFuc2FjdGlvbl9jb2RlPXJhbmRvbV9udW1iZXIsCiAgICAgICAgbmV3X2JhbGFuY2U9Zm9ybWF0dGVkX2JhbGFuY2UpCiAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBjxrDhu6NjIHRow6BuaCBjw7RuZyBjaG8gdXNlciB7dXNlcl9pZH0iKQoKZGVmIGhhbmRsZV9iZXRfdHR4eGNjbGwobWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGNoYXRfaWQgPSBtZXNzYWdlLmNoYXQuaWQKICAgIG1lc3NhZ2VfdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KCkKICAgIHByaW50KGYiW0RFQlVHXSBSZWNlaXZlZCBiZXQgbWVzc2FnZSBmcm9tIHVzZXIge3VzZXJfaWR9OiB7bWVzc2FnZS50ZXh0fSIpCiAgICBpZiBsZW4obWVzc2FnZV90ZXh0KSAhPSAyOgogICAgICAgIHByaW50KCJbREVCVUddIFNhaSDEkeG7i25oIGThuqFuZywga2jDtG5nIHBo4bqjaSAyIHBo4bqnbiIpCiAgICAgICAgcmV0dXJuCgogICAgYmV0X2NvZGUgPSBtZXNzYWdlX3RleHRbMF0ubG93ZXIoKQogICAgYmV0X2Ftb3VudF9zdHIgPSBtZXNzYWdlX3RleHRbMV0udXBwZXIoKQogICAgcHJpbnQoZiJbREVCVUddIGJldF9jb2RlPXtiZXRfY29kZX0sIGJldF9hbW91bnRfc3RyPXtiZXRfYW1vdW50X3N0cn0iKQoKICAgIGJldF90eXBlcyA9IHsKICAgICAgICAidHQiOiAoInRhaS50eHQiLCAieGl1LnR4dCIsICJUw6BpIiwgIlQiKSwKICAgICAgICAieHgiOiAoInhpdS50eHQiLCAidGFpLnR4dCIsICJY4buJdSIsICJYIiksCiAgICAgICAgImNjIjogKCJjaGFuLnR4dCIsICJsZS50eHQiLCAiQ2jhurVuIiwgIkMiKSwKICAgICAgICAibGwiOiAoImxlLnR4dCIsICJjaGFuLnR4dCIsICJM4bq7IiwgIkwiKQogICAgfQoKICAgIGlmIGJldF9jb2RlIG5vdCBpbiBiZXRfdHlwZXM6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIGJldF9jb2RlICd7YmV0X2NvZGV9JyBraMO0bmcgbuG6sW0gdHJvbmcgYmV0X3R5cGVzIikKICAgICAgICByZXR1cm4KCiAgICBmaWxlX3RoaXMsIGZpbGVfb3Bwb3NpdGUsIGJldF9uYW1lLCBiZXRfc2hvcnQgPSBiZXRfdHlwZXNbYmV0X2NvZGVdCiAgICBwcmludChmIltERUJVR10gZmlsZV90aGlzPXtmaWxlX3RoaXN9LCBmaWxlX29wcG9zaXRlPXtmaWxlX29wcG9zaXRlfSwgYmV0X25hbWU9e2JldF9uYW1lfSwgYmV0X3Nob3J0PXtiZXRfc2hvcnR9IikKCiAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZSBvciBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKSBvciBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZSBvciBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICBwcmludCgiW0RFQlVHXSBC4buLIGNo4bq3biBi4bufaSDEkWnhu4F1IGtp4buHbiBraeG7g20gdHJhIHVzZXIvbWVzc2FnZSIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyBjaOG6pXAgbmjhuq1uIGPGsOG7o2MgbMO6YyBuw6B5LCBn4buNaSBoYW5kbGVfYmV0X3JlcXVlc3QiKQogICAgICAgIGhhbmRsZV9iZXRfcmVxdWVzdCh1c2VyX2lkLCBjaGF0X2lkLCBtZXNzYWdlLm1lc3NhZ2VfaWQsIG1lc3NhZ2UudGV4dCkKICAgICAgICByZXR1cm4KCiAgICAiIiJwaG9uZSA9IGdldF9waG9uZV9udW1iZXIodXNlcl9pZCkKICAgIGlmIHBob25lIGlzIE5vbmU6CiAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciBjaMawYSB4w6FjIG1pbmggc+G7kSDEkWnhu4duIHRob+G6oWkiKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIlZ1aSBsw7JuZyB4w6FjIG1pbmggU8SQVCB04bqhaSBCT1Q6IEBuaWtldjFib3QiKQogICAgICAgIHJldHVybiIiIgoKICAgIGlmIGNoYXRfaWQgIT0gZ3JvdXBfY2hhdF9pZDoKICAgICAgICBwcmludChmIltERUJVR10gVXNlciBraMO0bmcg4bufIG5ow7NtIMSRw7puZzoge2NoYXRfaWR9ICE9IHtncm91cF9jaGF0X2lkfSIpCiAgICAgICAgYm90Mi5yZXBseV90byhtZXNzYWdlLCAiVnVpIGzDsm5nIHRoYW0gZ2lhIG5ow7NtIEB2SXh4NTJfcm9vbSIpCiAgICAgICAgcmV0dXJuCgogICAgc2Vzc2lvbl9udW1iZXIgPSByZWFkX3Nlc3Npb25fbnVtYmVyKCkKICAgIGJhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkKQogICAgcHJpbnQoZiJbREVCVUddIHNlc3Npb25fbnVtYmVyPXtzZXNzaW9uX251bWJlcn0sIGJhbGFuY2U9e2JhbGFuY2V9IikKCiAgICBpZiBiYWxhbmNlIGlzIE5vbmUgb3IgYmFsYW5jZSA8IDUwMDA6CiAgICAgICAgcHJpbnQoIltERUJVR10gU+G7kSBkxrAga2jDtG5nIMSR4bunIGhv4bq3YyBuaOG7jyBoxqFuIDUwMDAiKQogICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIjxiPk1pbiBjxrDhu6NjIGhp4buHbiB04bqhaSBsw6A6IDUuMDAwPC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgcmV0dXJuCgogICAgZGVmIHJlYWRfdG90YWwoZmlsZSk6CiAgICAgICAgdG90YWwgPSAwCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZiJGSUxFL3tmaWxlfSIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbCArPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gdG90YWwKCiAgICB0b3RhbF90aGlzID0gcmVhZF90b3RhbChmaWxlX3RoaXMpCiAgICB0b3RhbF9vcHBvc2l0ZSA9IHJlYWRfdG90YWwoZmlsZV9vcHBvc2l0ZSkKICAgIHByaW50KGYiW0RFQlVHXSB0b3RhbF90aGlzPXt0b3RhbF90aGlzfSwgdG90YWxfb3Bwb3NpdGU9e3RvdGFsX29wcG9zaXRlfSIpCgogICAgbWF4X2JldF9hbW91bnQgPSB0b3RhbF9vcHBvc2l0ZSArIDUwMDAwMCAtIHRvdGFsX3RoaXMKICAgIHByaW50KGYiW0RFQlVHXSBtYXhfYmV0X2Ftb3VudD17bWF4X2JldF9hbW91bnR9IikKCiAgICBpZiBtYXhfYmV0X2Ftb3VudCA8PSAwOgogICAgICAgIHByaW50KCJbREVCVUddIG1heF9iZXRfYW1vdW50IDw9IDAsIGNow6puaCBs4buHY2gga2jDtG5nIHF1w6EgNTAwLjAwMCIpCiAgICAgICAgYm90Mi5yZXBseV90byhtZXNzYWdlLCAiPGI+Q2jDqm5oIGzhu4djaCBraMO0bmcgcXXDoSA1MDAuMDAwPC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgcmV0dXJuCgogICAgaWYgYmV0X2Ftb3VudF9zdHIgPT0gJ01BWCc6CiAgICAgICAgYmV0X2Ftb3VudCA9IG1pbihiYWxhbmNlLCBtYXhfYmV0X2Ftb3VudCkKICAgICAgICBwcmludChmIltERUJVR10gQmV0IGFtb3VudCBzZXQgdG8gTUFYOiB7YmV0X2Ftb3VudH0iKQogICAgZWxzZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJldF9hbW91bnQgPSBpbnQoYmV0X2Ftb3VudF9zdHIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBCZXQgYW1vdW50IHBhcnNlZCBpbnQ6IHtiZXRfYW1vdW50fSIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEJldCBhbW91bnQga2jDtG5nIHBo4bqjaSBz4buRIHbDoCBraMO0bmcgcGjhuqNpIE1BWCIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBT4buRIGTGsCBraMO0bmcgxJHhu6cgY2hvIGPGsOG7o2MiKQogICAgICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsICI8Yj5T4buRIGTGsCBraMO0bmcgxJHhu6c8L2I+IiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYmV0X2Ftb3VudCA8IDUwMDA6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEJldCBhbW91bnQgbmjhu48gaMahbiBtaW4gY8aw4bujYyIpCiAgICAgICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIjxiPk1pbiBjxrDhu6NjIGhp4buHbiB04bqhaSBsw6A6IDUuMDAwPC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGJldF9hbW91bnQgPiBtYXhfYmV0X2Ftb3VudDoKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gQmV0IGFtb3VudCB2xrDhu6N0IHF1w6EgbWF4X2JldF9hbW91bnQiKQogICAgICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsIGYiPGI+TWF4IGPGsOG7o2MgaGnhu4duIHThuqFpIGzDoDoge2Zvcm1hdF9udW1iZXIoc3RyKG1heF9iZXRfYW1vdW50KSl9PC9iPiIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZiJGSUxFL3tmaWxlX29wcG9zaXRlfSIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDIgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iIGFuZCBwYXJ0c1sxXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciDEkcOjIMSR4bq3dCBj4butYSDEkeG7kWkgbOG6rXAsIGtow7RuZyBjaG8gcGjDqXAgxJHhurd0IDIgY+G7rWEiKQogICAgICAgICAgICAgICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIjxiPktow7RuZyDEkcaw4bujYyBwaMOpcCDEkeG6t3QgMiBj4butYTwvYj4iLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHByaW50KCJbREVCVUddIEZpbGUgxJHhu5FpIGzhuq1wIGtow7RuZyB04buTbiB04bqhaSwgYuG7jyBxdWEga2nhu4NtIHRyYSDEkeG6t3QgMiBj4butYSIpCgogICAgbmV3X2JhbGFuY2UgPSBtYXgoYmFsYW5jZSAtIGJldF9hbW91bnQsIDApCiAgICBwcmludChmIltERUJVR10gQ+G6rXAgbmjhuq10IHPhu5EgZMawIG3hu5tpOiB7bmV3X2JhbGFuY2V9IikKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmFsYW5jZSkKICAgIHdpdGggb3BlbihmIkZJTEUve2ZpbGVfdGhpc30iLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShmIiN7c2Vzc2lvbl9udW1iZXJ9IHt1c2VyX2lkfSB7YmV0X2Ftb3VudH1cbiIpCgogICAgd2l0aCBvcGVuKCJGSUxFL2xzY2hvaS50eHQiLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7YmV0X3Nob3J0fSB7YmV0X2Ftb3VudH1cbiIpCgogICAgbG9nX2dvcGh1KHVzZXJfaWQsIGJldF9hbW91bnQpCgogICAgZm9ybWF0dGVkX2JhbGFuY2UgPSBmb3JtYXRfbnVtYmVyKHN0cihuZXdfYmFsYW5jZSkpCiAgICByYW5kb21fbnVtYmVyID0gZ2VuZXJhdGVfcmFuZG9tX251bWJlcigpCiAgICBub3RlID0gIntDw6JuIGPhu61hfSIgaWYgYmV0X2Ftb3VudCA9PSBtYXhfYmV0X2Ftb3VudCBlbHNlICIiCiAgICB0ZW1wX21lc3NhZ2UgPSBmIjxiPntyYW5kb20uY2hvaWNlKGljb25zKX0gxJDhurd0IHRow6BuaCBjw7RuZyBr4buzIFhYICAje3Nlc3Npb25fbnVtYmVyfVxue2JldF9uYW1lfSB7Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpfcSRPC9iPiB7e+G6qG4gZGFuaH19XG57bm90ZX0iCgogICAgdHJ5OgogICAgICAgIGJvdDIuZGVsZXRlX21lc3NhZ2UoY2hhdF9pZCwgbWVzc2FnZS5tZXNzYWdlX2lkKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeMOzYSBtZXNzYWdlOiB7ZX0iKQoKICAgIHRpbWUuc2xlZXAoMC4xKQogICAgYm90Mi5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgdGVtcF9tZXNzYWdlLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQoKICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICBmIsSQ4bq3dCB0aMOgbmggY8O0bmcga+G7syBYWCB7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiJNR0Q6IHtyYW5kb21fbnVtYmVyfVxuIgogICAgICAgIGYie2JldF9uYW1lfSB7e+G6qG4gZGFuaH19IHtmb3JtYXRfbnVtYmVyKHN0cihiZXRfYW1vdW50KSl9XG4iCiAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdHRlZF9iYWxhbmNlfSIKICAgICkKICAgIHNlbmRfbWVzc2FnZV90b191c2VyKHVzZXJfaWQsIG1lc3NhZ2VfdGV4dCkKCiAgICB1c2VyX2Z1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSBvciAiIgogICAgbm90aWZ5X2dyb3VwKAogICAgICAgIGZ1bGxuYW1lPXVzZXJfZnVsbG5hbWUsCiAgICAgICAgdXNlcl9pZD11c2VyX2lkLAogICAgICAgIGJldF90eXBlPWYie2JldF9uYW1lfSB7e+G6qG4gZGFuaH19IiwKICAgICAgICBiZXRfYW1vdW50PWZvcm1hdF9udW1iZXIoc3RyKGJldF9hbW91bnQpKSArICcg4oKrJywKICAgICAgICB0cmFuc2FjdGlvbl9jb2RlPXJhbmRvbV9udW1iZXIsCiAgICAgICAgbmV3X2JhbGFuY2U9Zm9ybWF0dGVkX2JhbGFuY2UKICAgICkKICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIGPGsOG7o2MgdGjDoG5oIGPDtG5nIGNobyB1c2VyIHt1c2VyX2lkfSIpCgpkZWYgcHJvY2Vzc19iZXRfZChtZXNzYWdlKToKICAgIGhhbmRsZV9iZXRfZChtZXNzYWdlKQpkZWYgaGFuZGxlX2JldF9kKG1lc3NhZ2UpOgogICAgaW1wb3J0IG9zCgogICAgYmV0X3R5cGVzID0gewogICAgICAgICdkMSc6ICgiRklMRS9kMS50eHQiLCAiRDEiKSwKICAgICAgICAnZDInOiAoIkZJTEUvZDIudHh0IiwgIkQyIiksCiAgICAgICAgJ2QzJzogKCJGSUxFL2QzLnR4dCIsICJEMyIpLAogICAgICAgICdkNCc6ICgiRklMRS9kNC50eHQiLCAiRDQiKSwKICAgICAgICAnZDUnOiAoIkZJTEUvZDUudHh0IiwgIkQ1IiksCiAgICAgICAgJ2Q2JzogKCJGSUxFL2Q2LnR4dCIsICJENiIpLAogICAgfQoKICAgIE1JTl9CRVQgPSAxMDAwCiAgICBNQVhfQkVUID0gMjAwMDAwCiAgICBNQVhfQkVUU19QRVJfU0VTU0lPTiA9IDIKICAgIE1BWF9EX0JFVF9UWVBFU19QRVJfU0VTU0lPTiA9IDMKCiAgICBkZWYgcmVhZF9iZXRzKGZpbGVfcGF0aCk6CiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgYmV0cyA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGJldHMuYXBwZW5kKChwYXJ0c1swXSwgcGFydHNbMV0sIGludChwYXJ0c1syXSkpKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gYmV0cwoKICAgIGRlZiB1c2VyX2JldF9zdW1tYXJ5KGJldHMsIHVzZXJfaWQsIHNlc3Npb25fbnVtYmVyKToKICAgICAgICBjb3VudCA9IDAKICAgICAgICB0b3RhbF9hbW91bnQgPSAwCiAgICAgICAgZm9yIHMsIHUsIGFtdCBpbiBiZXRzOgogICAgICAgICAgICBpZiB1ID09IHN0cih1c2VyX2lkKSBhbmQgcyA9PSBmIiN7c2Vzc2lvbl9udW1iZXJ9IjoKICAgICAgICAgICAgICAgIGNvdW50ICs9IDEKICAgICAgICAgICAgICAgIHRvdGFsX2Ftb3VudCArPSBhbXQKICAgICAgICByZXR1cm4gY291bnQsIHRvdGFsX2Ftb3VudAoKICAgIGRlZiB0b3RhbF9iZXRfaW5fc2Vzc2lvbihmaWxlX3BhdGgsIHNlc3Npb25fbnVtYmVyKToKICAgICAgICB0b3RhbCA9IDAKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWwgKz0gaW50KHBhcnRzWzJdKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiB0b3RhbAoKICAgIGRlZiBjb3VudF91c2VyX2RfYmV0X3R5cGVzKHVzZXJfaWQsIHNlc3Npb25fbnVtYmVyKToKICAgICAgICBiZXRfdHlwZV9jb3VudCA9IDAKICAgICAgICBmb3IgZmlsZV9wYXRoLCBfIGluIGJldF90eXBlcy52YWx1ZXMoKToKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iIGFuZCBwYXJ0c1sxXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJldF90eXBlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICByZXR1cm4gYmV0X3R5cGVfY291bnQKCiAgICBkZWYgZm9ybWF0X2Ftb3VudChhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgZGVmIGZvcm1hdF9udW1iZXIocyk6CiAgICAgICAgcmV0dXJuIGZvcm1hdF9hbW91bnQoaW50KHMpKQoKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgY2hhdF9pZCA9IG1lc3NhZ2UuY2hhdC5pZAogICAgdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLmxvd2VyKCkKCiAgICBwcmludChmIltERUJVR10gTmjhuq1uIGPGsOG7o2MgdOG7qyB1c2VyX2lkPXt1c2VyX2lkfSwgY2hhdF9pZD17Y2hhdF9pZH0sIHRleHQ9J3t0ZXh0fSciKQoKICAgIHBhcnRzID0gdGV4dC5zcGxpdCgpCiAgICBpZiBsZW4ocGFydHMpICE9IDI6CiAgICAgICAgcHJpbnQoIltERUJVR10gU2FpIMSR4buLbmggZOG6oW5nIGPGsOG7o2MsIGLhu48gcXVhIikKICAgICAgICByZXR1cm4KCiAgICBiZXRfY29kZSA9IHBhcnRzWzBdCiAgICBiZXRfYW1vdW50X3JhdyA9IHBhcnRzWzFdCgogICAgaWYgYmV0X2NvZGUgbm90IGluIGJldF90eXBlczoKICAgICAgICBwcmludChmIltERUJVR10gTG/huqFpIGPGsOG7o2Mga2jDtG5nIGjhu6NwIGzhu4c6IHtiZXRfY29kZX0iKQogICAgICAgIHJldHVybgoKICAgIGZpbGVfcGF0aCwgYmV0X25hbWUgPSBiZXRfdHlwZXNbYmV0X2NvZGVdCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGUgb3IgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCkgb3IgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWUgb3Igbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgcHJpbnQoIltERUJVR10gxJBp4buBdSBraeG7h24ga2jDtG5nIGNobyBwaMOpcCBjxrDhu6NjLCBi4buPIHF1YSIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgIHByaW50KCJbREVCVUddIEhp4buHbiBraMO0bmcgbmjhuq1uIGPGsOG7o2MsIHjhu60gbMO9IHnDqnUgY+G6p3UgY8aw4bujYyIpCiAgICAgICAgaGFuZGxlX2JldF9yZXF1ZXN0KHVzZXJfaWQsIGNoYXRfaWQsIG1lc3NhZ2UubWVzc2FnZV9pZCwgbWVzc2FnZS50ZXh0KQogICAgICAgIHJldHVybgoKICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBwcmludCgiW0RFQlVHXSBVc2VyIGNoxrBhIHjDoWMgbWluaCBz4buRIMSRaeG7h24gdGhv4bqhaSIpCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIHThuqFpIEJPVDogQG5pa2V2MWJvdCIpCiAgICAgICAgcmV0dXJuIiIiCgogICAgaWYgY2hhdF9pZCAhPSBncm91cF9jaGF0X2lkOgogICAgICAgIHByaW50KCJbREVCVUddIFVzZXIga2jDtG5nIOG7nyBuaMOzbSBjaMOtbmgsIHThu6sgY2jhu5FpIGPGsOG7o2MiKQogICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIlZ1aSBsw7JuZyB0aGFtIGdpYSBuaMOzbSBAdkl4eDUyX3Jvb20iKQogICAgICAgIHJldHVybgoKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIHByaW50KGYiW0RFQlVHXSBQaGnDqm4gY8aw4bujYyBoaeG7h24gdOG6oWk6IHtzZXNzaW9uX251bWJlcn0sIFPhu5EgZMawIHVzZXI6IHtiYWxhbmNlfSIpCgogICAgaWYgY291bnRfdXNlcl9kX2JldF90eXBlcyh1c2VyX2lkLCBzZXNzaW9uX251bWJlcikgPj0gTUFYX0RfQkVUX1RZUEVTX1BFUl9TRVNTSU9OOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIMSRw6MgY8aw4bujYyDEkeG7pyB7TUFYX0RfQkVUX1RZUEVTX1BFUl9TRVNTSU9OfSBsb+G6oWkgRCB0cm9uZyBwaGnDqm4iKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBiZXRfYW1vdW50ID0gaW50KGJldF9hbW91bnRfcmF3KQogICAgICAgIGlmIGJldF9hbW91bnQgPCBNSU5fQkVUIG9yIGJldF9hbW91bnQgPiBNQVhfQkVUOgogICAgICAgICAgICBwcmludChmIltERUJVR10gU+G7kSB0aeG7gW4gY8aw4bujYyBraMO0bmcgaOG7o3AgbOG7hzoge2JldF9hbW91bnR9IikKICAgICAgICAgICAgcmV0dXJuCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBwcmludCgiW0RFQlVHXSBT4buRIHRp4buBbiBjxrDhu6NjIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICByZXR1cm4KCiAgICBpZiBiZXRfYW1vdW50ID4gYmFsYW5jZToKICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgxJHhu6cgdGnhu4FuIGPGsOG7o2MiKQogICAgICAgIHJldHVybgoKICAgIGJldHMgPSByZWFkX2JldHMoZmlsZV9wYXRoKQogICAgYmV0X2NvdW50LCBiZXRfdG90YWwgPSB1c2VyX2JldF9zdW1tYXJ5KGJldHMsIHVzZXJfaWQsIHNlc3Npb25fbnVtYmVyKQogICAgaWYgYmV0X2NvdW50ID49IE1BWF9CRVRTX1BFUl9TRVNTSU9OOgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkOG6oXQgc+G7kSBs4bqnbiBjxrDhu6NjIHThu5FpIMSRYSBsb+G6oWkgRCIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBiZXRfdG90YWwgKyBiZXRfYW1vdW50ID4gTUFYX0JFVDoKICAgICAgICBwcmludCgiW0RFQlVHXSBU4buVbmcgY8aw4bujYyBuZ8aw4budaSBjaMahaSA+IDIwMC4wMDAiKQogICAgICAgIHJldHVybgoKICAgIHNlc3Npb25fdG90YWwgPSB0b3RhbF9iZXRfaW5fc2Vzc2lvbihmaWxlX3BhdGgsIHNlc3Npb25fbnVtYmVyKQogICAgaWYgc2Vzc2lvbl90b3RhbCArIGJldF9hbW91bnQgPiBNQVhfQkVUOgogICAgICAgIHByaW50KCJbREVCVUddIFThu5VuZyBjxrDhu6NjIHRvw6BuIGZpbGUgPiAyMDAuMDAwIikKICAgICAgICByZXR1cm4KICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKGYiI3tzZXNzaW9uX251bWJlcn0ge3VzZXJfaWR9IHtiZXRfYW1vdW50fVxuIikKICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKSAgCiAgICB0cnVjdW9jdGllbih1c2VyX2lkLCBiYWxhbmNlKQogICAgcmVwbHkgPSAoCiAgICAgICAgZiLEkOG6t3QgdGjDoG5oIGPDtG5nIGvhu7MgWFggI3tzZXNzaW9uX251bWJlcn1cbiIKICAgICAgICBmIkzhu4duaCB8IFPhu5EgxJFvw6FuIHwgVGnhu4FuIGPGsOG7o2NcbiIKICAgICAgICBmIkQgfCB7YmV0X25hbWV9IHwge2Zvcm1hdF9hbW91bnQoYmV0X2Ftb3VudCl9xJEiCiAgICApCiAgICBwcmludChmIltERUJVR10gR+G7rWkgcGjhuqNuIGjhu5NpIMSR4bq3dCBjxrDhu6NjIHRow6BuaCBjw7RuZyBjaG8gdXNlcl9pZD17dXNlcl9pZH0iKQogICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIHJlcGx5KQoKICAgIGZvcm1hdHRlZF9iYWxhbmNlID0gZm9ybWF0X2Ftb3VudChuZXdfYmFsYW5jZSkKICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICBmIsSQ4bq3dCBs4buHbmggdGjDoG5oIGPDtG5nIGvhu7MgWFgge3Nlc3Npb25fbnVtYmVyfVxuIgogICAgICAgIGYie2JldF9uYW1lfSB7Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpfcSRXG4iCiAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdHRlZF9iYWxhbmNlfSIKICAgICkKICAgIHNlbmRfbWVzc2FnZV90b191c2VyKHVzZXJfaWQsIG1lc3NhZ2VfdGV4dCkKCiAgICB1c2VyX2Z1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZQogICAgbm90aWZ5X2dyb3VwMSgKICAgICAgICBmdWxsbmFtZT11c2VyX2Z1bGxuYW1lLAogICAgICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgICAgICBiZXRfdHlwZT1mIntiZXRfbmFtZX0iLAogICAgICAgIGJldF9hbW91bnQ9Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpICsgJyDigqsnLAogICAgICAgIG5ld19iYWxhbmNlPWZvcm1hdHRlZF9iYWxhbmNlCiAgICApCgpkZWYgaGFuZGxlX2JldF9iYW8obWVzc2FnZSk6CiAgICBpbXBvcnQgb3MKICAgIE1JTl9CRVQgPSAxMDAwCiAgICBNQVhfQkVUID0gMjAwMAogICAgTUFYX0JFVFNfUEVSX1NFU1NJT04gPSAzCgogICAgbWVzc2FnZS50ZXh0ID0gbWVzc2FnZS50ZXh0LnVwcGVyKCkKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgY2hhdF9pZCA9IG1lc3NhZ2UuY2hhdC5pZAogICAgdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnVwcGVyKCkKCiAgICBwcmludChmIltERUJVR10gTmjhuq1uIGPGsOG7o2MgQkFPIHThu6sgdXNlcl9pZD17dXNlcl9pZH0sIGNoYXRfaWQ9e2NoYXRfaWR9LCB0ZXh0PSd7dGV4dH0nIikKCiAgICBwYXJ0cyA9IHRleHQuc3BsaXQoKQogICAgaWYgbGVuKHBhcnRzKSAhPSAzOgogICAgICAgIHByaW50KCJbREVCVUddIFNhaSDEkeG7i25oIGThuqFuZyBjxrDhu6NjIEJBTywgYuG7jyBxdWEiKQogICAgICAgIHJldHVybgoKICAgIGNvbW1hbmQsIGNob2ljZSwgYmV0X2Ftb3VudF9yYXcgPSBwYXJ0cwogICAgdmFsaWRfY2hvaWNlcyA9IFsnQUxMJywgJzEnLCAnMicsICczJywgJzQnLCAnNScsICc2J10KICAgIGlmIGNob2ljZSBub3QgaW4gdmFsaWRfY2hvaWNlczoKICAgICAgICBwcmludChmIltERUJVR10gTOG7sWEgY2jhu41uIEJBTyBraMO0bmcgaOG7o3AgbOG7hzoge2Nob2ljZX0iKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBiZXRfYW1vdW50ID0gaW50KGJldF9hbW91bnRfcmF3KQogICAgICAgIGlmIGJldF9hbW91bnQgPCBNSU5fQkVUIG9yIGJldF9hbW91bnQgPiBNQVhfQkVUOgogICAgICAgICAgICBwcmludChmIltERUJVR10gU+G7kSB0aeG7gW4gY8aw4bujYyBCQU8ga2jDtG5nIGjhu6NwIGzhu4c6IHtiZXRfYW1vdW50fSIpCiAgICAgICAgICAgIHJldHVybgogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcHJpbnQoIltERUJVR10gU+G7kSB0aeG7gW4gY8aw4bujYyBCQU8ga2jDtG5nIHBo4bqjaSBz4buRIG5ndXnDqm4gaOG7o3AgbOG7hyIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGUgb3IgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCkgb3IgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWUgb3Igbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgcHJpbnQoIltERUJVR10gxJBp4buBdSBraeG7h24ga2jDtG5nIGNobyBwaMOpcCBjxrDhu6NjIEJBTywgYuG7jyBxdWEiKQogICAgICAgIHJldHVybgoKICAgIGlmIG5vdCBhY2NlcHRpbmdfYmV0czoKICAgICAgICBwcmludCgiW0RFQlVHXSBIaeG7h24ga2jDtG5nIG5o4bqtbiBjxrDhu6NjIEJBTywgeOG7rSBsw70gecOqdSBj4bqndSBjxrDhu6NjIikKICAgICAgICBoYW5kbGVfYmV0X3JlcXVlc3QodXNlcl9pZCwgY2hhdF9pZCwgbWVzc2FnZS5tZXNzYWdlX2lkLCBtZXNzYWdlLnRleHQpCiAgICAgICAgcmV0dXJuCgogICAgIiIicGhvbmUgPSBnZXRfcGhvbmVfbnVtYmVyKHVzZXJfaWQpCiAgICBpZiBwaG9uZSBpcyBOb25lOgogICAgICAgIHByaW50KCJbREVCVUddIFVzZXIgY2jGsGEgeMOhYyBtaW5oIHPhu5EgxJFp4buHbiB0aG/huqFpIikKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgdOG6oWkgQk9UOiBAbmlrZXYxYm90IikKICAgICAgICByZXR1cm4iIiIKCiAgICBpZiBjaGF0X2lkICE9IGdyb3VwX2NoYXRfaWQ6CiAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciBraMO0bmcg4bufIG5ow7NtIGNow61uaCwgdOG7qyBjaOG7kWkgY8aw4bujYyBCQU8iKQogICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIlZ1aSBsw7JuZyB0aGFtIGdpYSBuaMOzbSBAdkl4eDUyX3Jvb20iKQogICAgICAgIHJldHVybgoKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIHByaW50KGYiW0RFQlVHXSBQaGnDqm4gY8aw4bujYyBCQU8gaGnhu4duIHThuqFpOiB7c2Vzc2lvbl9udW1iZXJ9LCBT4buRIGTGsCB1c2VyOiB7YmFsYW5jZX0iKQoKICAgIGlmIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyDEkeG7pyB0aeG7gW4gY8aw4bujYyBCQU8iKQogICAgICAgIHJldHVybgoKICAgIGJhb19maWxlID0gIkZJTEUvYmFvLnR4dCIKICAgIHVzZXJfYmV0cyA9IFtdCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhiYW9fZmlsZSk6CiAgICAgICAgd2l0aCBvcGVuKGJhb19maWxlLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gNDoKICAgICAgICAgICAgICAgICAgICBzZXNzLCB1aWQsIGNoLCBhbXQgPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgIGlmIHNlc3MgPT0gZiIje3Nlc3Npb25fbnVtYmVyfSIgYW5kIHVpZCA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfYmV0cy5hcHBlbmQoKGNoLCBpbnQoYW10KSkpCgogICAgaWYgYW55KGNoID09ICJBTEwiIGZvciBjaCwgXyBpbiB1c2VyX2JldHMpOgogICAgICAgIHByaW50KCJbREVCVUddIFVzZXIgxJHDoyBjxrDhu6NjIEFMTCwga2jDtG5nIG5o4bqtbiBjxrDhu6NjIHRow6ptIikKICAgICAgICByZXR1cm4KCiAgICBpZiBjaG9pY2UgPT0gIkFMTCIgYW5kIGxlbih1c2VyX2JldHMpID4gMDoKICAgICAgICBwcmludCgiW0RFQlVHXSBVc2VyIMSRw6MgY8aw4bujYyBz4buRLCBraMO0bmcgxJHGsOG7o2MgY8aw4bujYyBBTEwgdGjDqm0iKQogICAgICAgIHJldHVybgoKICAgIGlmIGNob2ljZSAhPSAiQUxMIjoKICAgICAgICBjdXJyZW50X2Nob2ljZXMgPSBzZXQoY2ggZm9yIGNoLCBfIGluIHVzZXJfYmV0cykKICAgICAgICBpZiBjaG9pY2Ugbm90IGluIGN1cnJlbnRfY2hvaWNlcyBhbmQgbGVuKGN1cnJlbnRfY2hvaWNlcykgPj0gTUFYX0JFVFNfUEVSX1NFU1NJT046CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIFVzZXIgxJHDoyBjxrDhu6NjIMSR4bunIDMgbG/huqFpIHPhu5EgQkFPIHLhu5NpLCBraMO0bmcgbmjhuq1uIHRow6ptIikKICAgICAgICAgICAgcmV0dXJuCgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFIik6CiAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiKQoKICAgIHdpdGggb3BlbihiYW9fZmlsZSwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGYud3JpdGUoZiIje3Nlc3Npb25fbnVtYmVyfSB7dXNlcl9pZH0ge2Nob2ljZX0ge2JldF9hbW91bnR9XG4iKQoKICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmFsYW5jZSkKICAgIGRlZiBmb3JtYXRfYW1vdW50KGFtb3VudCk6CiAgICAgICAgcmV0dXJuIGYie2Ftb3VudDosfSIucmVwbGFjZSgiLCIsICIuIikKCiAgICByZXBseSA9ICgKICAgICAgICBmIsSQ4bq3dCB0aMOgbmggY8O0bmcga+G7syBYWCAje3Nlc3Npb25fbnVtYmVyfVxuIgogICAgICAgIGYiTOG7h25oIHwgU+G7kSDEkW/DoW4gfCBUaeG7gW4gY8aw4bujY1xuIgogICAgICAgIGYiQsOjbyB8IHtjaG9pY2UubG93ZXIoKX0gfCB7Zm9ybWF0X2Ftb3VudChiZXRfYW1vdW50KX3EkSIpCiAgICBwcmludChmIltERUJVR10gR+G7rWkgcGjhuqNuIGjhu5NpIGPGsOG7o2MgQkFPIHRow6BuaCBjw7RuZyBjaG8gdXNlcl9pZD17dXNlcl9pZH0iKQogICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIHJlcGx5KQoKICAgIGZvcm1hdHRlZF9iYWxhbmNlID0gZm9ybWF0X2Ftb3VudChuZXdfYmFsYW5jZSkKICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICBmIsSQ4bq3dCBs4buHbmggdGjDoG5oIGPDtG5nIGvhu7MgWFgge3Nlc3Npb25fbnVtYmVyfVxuIgogICAgICAgIGYiQkFPIHwge2Nob2ljZX0gfCB7Zm9ybWF0X2Ftb3VudChiZXRfYW1vdW50KX3EkVxuIgogICAgICAgIGYiU+G7kSBkxrA6IHtmb3JtYXR0ZWRfYmFsYW5jZX3EkSIpCiAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCBtZXNzYWdlX3RleHQpCgogICAgdXNlcl9mdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZpcnN0X25hbWUKICAgIG5vdGlmeV9ncm91cDIoCiAgICAgICAgZnVsbG5hbWU9dXNlcl9mdWxsbmFtZSwKICAgICAgICB1c2VyX2lkPXVzZXJfaWQsCiAgICAgICAgYmV0X3R5cGU9IkLDo28iLAogICAgICAgIGJldF9hbW91bnQ9Zm9ybWF0X2Ftb3VudChiZXRfYW1vdW50KSArICIg4oKrIiwKICAgICAgICBuZXdfYmFsYW5jZT1mb3JtYXR0ZWRfYmFsYW5jZSkKCmRlZiBoYW5kbGVfYmV0X3NiKG1lc3NhZ2UpOgogICAgaW1wb3J0IG9zCgogICAgTUlOX0JFVCA9IDEwMDAKICAgIE1BWF9CRVQgPSAyMDAwMAogICAgVkFMSURfQ0hPSUNFUyA9IFtzdHIoaSkgZm9yIGkgaW4gcmFuZ2UoNCwgMTgpXQoKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgY2hhdF9pZCA9IG1lc3NhZ2UuY2hhdC5pZAogICAgdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnVwcGVyKCkKCiAgICBwcmludChmIltERUJVR10gTmjhuq1uIGPGsOG7o2MgU0IgdOG7qyB1c2VyX2lkPXt1c2VyX2lkfSwgY2hhdF9pZD17Y2hhdF9pZH0sIHRleHQ9J3t0ZXh0fSciKQoKICAgIHBhcnRzID0gdGV4dC5zcGxpdCgpCiAgICBpZiBsZW4ocGFydHMpICE9IDM6CiAgICAgICAgcHJpbnQoIltERUJVR10gU2FpIMSR4buLbmggZOG6oW5nIGPGsOG7o2MgU0IsIGLhu48gcXVhIikKICAgICAgICByZXR1cm4KCiAgICBjb21tYW5kLCBjaG9pY2UsIGJldF9hbW91bnRfcmF3ID0gcGFydHMKCiAgICBpZiBjaG9pY2Ugbm90IGluIFZBTElEX0NIT0lDRVM6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIFPhu5EgY2jhu41uIFNCIGtow7RuZyBo4bujcCBs4buHOiB7Y2hvaWNlfSIpCiAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIGJldF9hbW91bnQgPSBpbnQoYmV0X2Ftb3VudF9yYXcpCiAgICAgICAgaWYgYmV0X2Ftb3VudCA8IE1JTl9CRVQgb3IgYmV0X2Ftb3VudCA+IE1BWF9CRVQ6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBT4buRIHRp4buBbiBjxrDhu6NjIFNCIGtow7RuZyBo4bujcCBs4buHOiB7YmV0X2Ftb3VudH0iKQogICAgICAgICAgICByZXR1cm4KICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHByaW50KCJbREVCVUddIFPhu5EgdGnhu4FuIGPGsOG7o2MgU0Iga2jDtG5nIHBo4bqjaSBz4buRIG5ndXnDqm4gaOG7o3AgbOG7hyIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGUgb3IgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCkgb3IgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWUgb3Igbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgcHJpbnQoIltERUJVR10gxJBp4buBdSBraeG7h24ga2jDtG5nIGNobyBwaMOpcCBjxrDhu6NjIFNCLCBi4buPIHF1YSIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbm90IGFjY2VwdGluZ19iZXRzOgogICAgICAgIGhhbmRsZV9iZXRfcmVxdWVzdCh1c2VyX2lkLCBjaGF0X2lkLCBtZXNzYWdlLm1lc3NhZ2VfaWQsIG1lc3NhZ2UudGV4dCkKICAgICAgICByZXR1cm4KCiAgICAiIiJwaG9uZSA9IGdldF9waG9uZV9udW1iZXIodXNlcl9pZCkKICAgIGlmIHBob25lIGlzIE5vbmU6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIHThuqFpIEJPVDogQG5pa2V2MWJvdCIpCiAgICAgICAgcmV0dXJuIiIiCgogICAgaWYgY2hhdF9pZCAhPSBncm91cF9jaGF0X2lkOgogICAgICAgIGJvdDIucmVwbHlfdG8obWVzc2FnZSwgIlZ1aSBsw7JuZyB0aGFtIGdpYSBuaMOzbSBAdkl4eDUyX3Jvb20iKQogICAgICAgIHJldHVybgoKICAgIHNlc3Npb25fbnVtYmVyID0gcmVhZF9zZXNzaW9uX251bWJlcigpCiAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKCiAgICBpZiBiZXRfYW1vdW50ID4gYmFsYW5jZToKICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgxJHhu6cgdGnhu4FuIGPGsOG7o2MgU0IiKQogICAgICAgIHJldHVybgoKICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmFsYW5jZSkKCiAgICBzYl9maWxlID0gIkZJTEUvc2IudHh0IgogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFIik6CiAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiKQogICAgd2l0aCBvcGVuKHNiX2ZpbGUsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKGYiI3tzZXNzaW9uX251bWJlcn0ge3VzZXJfaWR9IHtjaG9pY2V9IHtiZXRfYW1vdW50fVxuIikKCiAgICBkZWYgZm9ybWF0X2Ftb3VudChhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgcmVwbHkgPSAoCiAgICAgICAgZiLEkOG6t3QgdGjDoG5oIGPDtG5nIGvhu7MgWFggI3tzZXNzaW9uX251bWJlcn1cbiIKICAgICAgICBmIkzhu4duaCB8IFPhu5EgxJFvw6FuIHwgVGnhu4FuIGPGsOG7o2NcbiIKICAgICAgICBmIlNCIHwge2Nob2ljZX0gfCB7Zm9ybWF0X2Ftb3VudChiZXRfYW1vdW50KX3igqsiCiAgICApCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgcmVwbHkpCgogICAgZm9ybWF0dGVkX2JhbGFuY2UgPSBmb3JtYXRfYW1vdW50KG5ld19iYWxhbmNlKQogICAgbWVzc2FnZV90ZXh0ID0gKAogICAgICAgIGYixJDhurd0IGzhu4duaCB0aMOgbmggY8O0bmcga+G7syBYWCB7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiJTQiB8IHtjaG9pY2V9IHwge2Zvcm1hdF9hbW91bnQoYmV0X2Ftb3VudCl94oKrXG4iCiAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdHRlZF9iYWxhbmNlfeKCqyIKICAgICkKICAgIHNlbmRfbWVzc2FnZV90b191c2VyKHVzZXJfaWQsIG1lc3NhZ2VfdGV4dCkKCiAgICB1c2VyX2Z1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZQogICAgbm90aWZ5X2dyb3VwMygKICAgICAgICBmdWxsbmFtZT11c2VyX2Z1bGxuYW1lLAogICAgICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgICAgICBiZXRfdHlwZT1mIlNCIHwge2Nob2ljZX0iLAogICAgICAgIGJldF9hbW91bnQ9Zm9ybWF0X2Ftb3VudChiZXRfYW1vdW50KSArICIg4oKrIiwKICAgICAgICBuZXdfYmFsYW5jZT1mb3JtYXR0ZWRfYmFsYW5jZSkKCmRlZiBoYW5kbGVfYmV0X3hpZW4obWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGNoYXRfaWQgPSBtZXNzYWdlLmNoYXQuaWQKICAgIGZ1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICBtZXNzYWdlX3RleHQgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCiAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZSBvciBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKSBvciBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZSBvciBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgIGlmIG5vdCBhY2NlcHRpbmdfYmV0czoKICAgICAgICBoYW5kbGVfYmV0X3JlcXVlc3QodXNlcl9pZCwgY2hhdF9pZCwgbWVzc2FnZS5tZXNzYWdlX2lkLCBtZXNzYWdlLnRleHQpCiAgICAgICAgcmV0dXJuCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgdOG6oWkgQk9UOiBAbmlrZXYxYm90IikKICAgICAgICByZXR1cm4iIiIKICAgIGlmIGNoYXRfaWQgIT0gZ3JvdXBfY2hhdF9pZDoKICAgICAgICBib3QyLnJlcGx5X3RvKG1lc3NhZ2UsICJWdWkgbMOybmcgdGhhbSBnaWEgbmjDs20gQHZJeHg1Ml9yb29tIikKICAgICAgICByZXR1cm4KICAgIGlmIGxlbihtZXNzYWdlX3RleHQpICE9IDI6CiAgICAgICAgcmV0dXJuCiAgICBjb21tYW5kID0gbWVzc2FnZV90ZXh0WzBdLmxvd2VyKCkKICAgIGJldF9hbW91bnRfc3RyID0gbWVzc2FnZV90ZXh0WzFdLnVwcGVyKCkKICAgIGlmIGNvbW1hbmQgbm90IGluIFsndGwnLCAndGMnLCAneGwnLCAneGMnXToKICAgICAgICByZXR1cm4KICAgIGlmIGNoYXRfaWQgIT0gZ3JvdXBfY2hhdF9pZDoKICAgICAgICByZXR1cm4KCiAgICBzZXNzaW9uX251bWJlciA9IHJlYWRfc2Vzc2lvbl9udW1iZXIoKQogICAgZmlsZV9tYXAgPSB7CiAgICAgICAgJ3RsJzogJ0ZJTEUvdGwudHh0JywKICAgICAgICAndGMnOiAnRklMRS90Yy50eHQnLAogICAgICAgICd4bCc6ICdGSUxFL3hsLnR4dCcsCiAgICAgICAgJ3hjJzogJ0ZJTEUveGMudHh0JwogICAgfQogICAgZmlsZV9uYW1lID0gZmlsZV9tYXBbY29tbWFuZF0KCiAgICBvcHBvc2l0ZV9tYXAgPSB7CiAgICAgICAgJ3RsJzogJ3RjJywKICAgICAgICAndGMnOiAndGwnLAogICAgICAgICd4bCc6ICd4YycsCiAgICAgICAgJ3hjJzogJ3hsJwogICAgfQogICAgb3Bwb3NpdGVfY29tbWFuZCA9IG9wcG9zaXRlX21hcC5nZXQoY29tbWFuZCkKICAgIGlmIG9wcG9zaXRlX2NvbW1hbmQ6CiAgICAgICAgb3Bwb3NpdGVfZmlsZSA9IGZpbGVfbWFwW29wcG9zaXRlX2NvbW1hbmRdCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMob3Bwb3NpdGVfZmlsZSk6CiAgICAgICAgICAgIHdpdGggb3BlbihvcHBvc2l0ZV9maWxlLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iIGFuZCBwYXJ0c1sxXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgIGJhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkKQogICAgaWYgYmFsYW5jZSBpcyBOb25lOgogICAgICAgIHJldHVybgogICAgYmFsYW5jZSA9IGludChiYWxhbmNlKQoKICAgIGlmIGJhbGFuY2UgPCAyMDAwMDoKICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIlThu5FpIHRoaeG7g3UgMjAuMDAwIiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICByZXR1cm4KCiAgICB0b3RhbF9iZXRfYW1vdW50ID0gMAogICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9uYW1lKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX2JldF9hbW91bnQgKz0gaW50KHBhcnRzWzJdKQoKICAgIG1heF9iZXRfYW1vdW50ID0gMjAwMDAwIC0gdG90YWxfYmV0X2Ftb3VudAoKICAgIGlmIG1heF9iZXRfYW1vdW50IDwgMjAwMDA6CiAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJU4buRaSDEkWEgY8aw4bujYyBoaeG7h24gdOG6oWk6IDAiLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgIHJldHVybgoKICAgIGFscmVhZHlfYmV0ID0gRmFsc2UKICAgIGlmIG9zLnBhdGguZXhpc3RzKGZpbGVfbmFtZSk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfbmFtZSwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAzIGFuZCBwYXJ0c1swXSA9PSBmIiN7c2Vzc2lvbl9udW1iZXJ9IiBhbmQgcGFydHNbMV0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIGFscmVhZHlfYmV0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICBpZiBhbHJlYWR5X2JldDoKICAgICAgICByZXR1cm4KCiAgICBpZiBiZXRfYW1vdW50X3N0ciA9PSAiTUFYIjoKICAgICAgICBpZiBiYWxhbmNlID49IG1heF9iZXRfYW1vdW50OgogICAgICAgICAgICBiZXRfYW1vdW50ID0gbWF4X2JldF9hbW91bnQKICAgICAgICBlbGlmIGJhbGFuY2UgPj0gMjAwMDA6CiAgICAgICAgICAgIGJldF9hbW91bnQgPSBiYWxhbmNlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJT4buRIGTGsCBraMO0bmcgxJHhu6ciLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICByZXR1cm4KICAgIGVsc2U6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBiZXRfYW1vdW50ID0gaW50KGJldF9hbW91bnRfc3RyKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgYmV0X2Ftb3VudCA8IDIwMDAwOgogICAgICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIlThu5FpIHRoaeG7g3UgMjAuMDAwIiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIGJldF9hbW91bnQgPiBtYXhfYmV0X2Ftb3VudDoKICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJD4butYSBuw6B5IGPDsm4gdOG7kWkgxJFhOiAiICsgZm9ybWF0X251bWJlcihzdHIobWF4X2JldF9hbW91bnQpKSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgIHJldHVybgoKICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG1heChuZXdfYmFsYW5jZSwgMCkpCiAgICB0cnVjdW9jdGllbih1c2VyX2lkLCBiYWxhbmNlKQoKICAgIHdpdGggb3BlbihmaWxlX25hbWUsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICBmLndyaXRlKGYiI3tzZXNzaW9uX251bWJlcn0ge3VzZXJfaWR9IHtiZXRfYW1vdW50fVxuIikKCiAgICB3aXRoIG9wZW4oJ0ZJTEUvbHNjaG9pLnR4dCcsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IHtjb21tYW5kLnVwcGVyKCl9IHtiZXRfYW1vdW50fVxuIikKCiAgICBmb3JtYXR0ZWRfYmFsYW5jZSA9IGZvcm1hdF9udW1iZXIoc3RyKG5ld19iYWxhbmNlKSkKICAgIGZvcm1hdHRlZF9iZXRfYW1vdW50ID0gZm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpCgogICAgYm90LnJlcGx5X3RvKAogICAgICAgIG1lc3NhZ2UsCiAgICAgICAgZiI8Yj7EkOG6t3QgdGjDoG5oIGPDtG5nIGvhu7MgWFgge3Nlc3Npb25fbnVtYmVyfVxuWGnDqm4ge2NvbW1hbmQudXBwZXIoKX0ge2Zvcm1hdHRlZF9iZXRfYW1vdW50fTwvYj4iLAogICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICkKICAgIHNlbmRfbWVzc2FnZV90b191c2VyKHVzZXJfaWQsIGYixJDhurd0IHRow6BuaCBjw7RuZyBr4buzIFhYIHtzZXNzaW9uX251bWJlcn1cbntjb21tYW5kLnVwcGVyKCl9IHtmb3JtYXR0ZWRfYmV0X2Ftb3VudH3EkVxuU+G7kSBkxrA6IHtmb3JtYXR0ZWRfYmFsYW5jZX0iKQoKICAgIG5vdGlmeV9ncm91cDQoCiAgICAgICAgZnVsbG5hbWU9ZnVsbG5hbWUsCiAgICAgICAgdXNlcl9pZD11c2VyX2lkLAogICAgICAgIGJldF90eXBlPWNvbW1hbmQudXBwZXIoKSwKICAgICAgICBiZXRfYW1vdW50PWYie2Zvcm1hdHRlZF9iZXRfYW1vdW50fSDigqsiLAogICAgICAgIG5ld19iYWxhbmNlPWYie2Zvcm1hdHRlZF9iYWxhbmNlfSDigqsiCiAgICApCgpkZWYgaGFuZGxlX2JldF9tZDUobWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGNoYXRfaWQgPSBtZXNzYWdlLmNoYXQuaWQKICAgIGZ1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICBtZXNzYWdlX3RleHQgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCgogICAgaWYgbGVuKG1lc3NhZ2VfdGV4dCkgIT0gMjoKICAgICAgICByZXR1cm4KCiAgICBjb21tYW5kID0gbWVzc2FnZV90ZXh0WzBdLmxvd2VyKCkKICAgIGJldF9hbW91bnRfc3RyID0gbWVzc2FnZV90ZXh0WzFdLnJlcGxhY2UoIi4iLCAiIikucmVwbGFjZSgiLCIsICIiKQoKICAgIGlmIGNvbW1hbmQgbm90IGluIFsnbXQnLCAnbXgnLCAnbWwnLCAnbWMnXToKICAgICAgICByZXR1cm4KCiAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZSBvciBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKSBvciBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZSBvciBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4KCiAgICBpZiBub3QgYWNjZXB0aW5nX2JldHM6CiAgICAgICAgaGFuZGxlX2JldF9yZXF1ZXN0KHVzZXJfaWQsIGNoYXRfaWQsIG1lc3NhZ2UubWVzc2FnZV9pZCwgbWVzc2FnZS50ZXh0KQogICAgICAgIHJldHVybgoKICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgIHJldHVybgoKICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgdOG6oWkgQk9UOiBAbmlrZXYxYm90IikKICAgICAgICByZXR1cm4iIiIKCiAgICBpZiBjaGF0X2lkICE9IGdyb3VwX2NoYXRfaWQ6CiAgICAgICAgYm90Mi5yZXBseV90byhtZXNzYWdlLCAiVnVpIGzDsm5nIHRoYW0gZ2lhIG5ow7NtIEB2SXh4NTJfcm9vbSIpCiAgICAgICAgcmV0dXJuCgogICAgc2Vzc2lvbl9udW1iZXIgPSByZWFkX3Nlc3Npb25fbnVtYmVyKCkKICAgIGZpbGVfbWFwID0gewogICAgICAgICdtdCc6ICdGSUxFL210LnR4dCcsCiAgICAgICAgJ214JzogJ0ZJTEUvbXgudHh0JywKICAgICAgICAnbWwnOiAnRklMRS9tbC50eHQnLAogICAgICAgICdtYyc6ICdGSUxFL21jLnR4dCcKICAgIH0KCiAgICBjb25mbGljdF9tYXAgPSB7CiAgICAgICAgJ210JzogWydteCddLAogICAgICAgICdteCc6IFsnbXQnXSwKICAgICAgICAnbWwnOiBbJ21jJ10sCiAgICAgICAgJ21jJzogWydtbCddCiAgICB9CgogICAgZm9yIGNvbmZsaWN0X2NvbW1hbmQgaW4gY29uZmxpY3RfbWFwLmdldChjb21tYW5kLCBbXSk6CiAgICAgICAgY29uZmxpY3RfZmlsZSA9IGZpbGVfbWFwW2NvbmZsaWN0X2NvbW1hbmRdCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoY29uZmxpY3RfZmlsZSk6CiAgICAgICAgICAgIHdpdGggb3Blbihjb25mbGljdF9maWxlLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iIGFuZCBwYXJ0c1sxXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgIGZpbGVfbmFtZSA9IGZpbGVfbWFwW2NvbW1hbmRdCiAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIGlmIGJhbGFuY2UgaXMgTm9uZToKICAgICAgICByZXR1cm4KICAgIGJhbGFuY2UgPSBpbnQoYmFsYW5jZSkKCiAgICBpZiBiYWxhbmNlIDwgMTAwMDoKICAgICAgICByZXR1cm4KCiAgICBhbHJlYWR5X2JldCA9IEZhbHNlCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlX25hbWUpOgogICAgICAgIHdpdGggb3BlbihmaWxlX25hbWUsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMyBhbmQgcGFydHNbMF0gPT0gZiIje3Nlc3Npb25fbnVtYmVyfSIgYW5kIHBhcnRzWzFdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBhbHJlYWR5X2JldCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgaWYgYWxyZWFkeV9iZXQ6CiAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIGJldF9hbW91bnQgPSBpbnQoYmV0X2Ftb3VudF9zdHIpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICByZXR1cm4KCiAgICBpZiBiZXRfYW1vdW50IDwgMTAwMCBvciBiZXRfYW1vdW50ID4gNTAwMDAwIG9yIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgIHJldHVybgoKICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmFsYW5jZSkKCiAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgZi53cml0ZShmIiN7c2Vzc2lvbl9udW1iZXJ9IHt1c2VyX2lkfSB7YmV0X2Ftb3VudH1cbiIpCgogICAgd2l0aCBvcGVuKCdGSUxFL2xzY2hvaS50eHQnLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7Y29tbWFuZC51cHBlcigpfSB7YmV0X2Ftb3VudH1cbiIpCgogICAgZm9ybWF0dGVkX2JhbGFuY2UgPSBmb3JtYXRfbnVtYmVyKHN0cihuZXdfYmFsYW5jZSkpCiAgICBmb3JtYXR0ZWRfYmV0X2Ftb3VudCA9IGZvcm1hdF9udW1iZXIoc3RyKGJldF9hbW91bnQpKQoKICAgIG1kNV9jb2RlID0gIiIKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbWQ1LnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmICc6JyBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgIG1kNV9jb2RlID0gbGluZS5zcGxpdCgnOicsIDEpWzFdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgZXhjZXB0OgogICAgICAgIG1kNV9jb2RlID0gIuOFpOOFpOOFpCIKCiAgICB0cmFuc2FjdGlvbl9pZCA9IHJhbmRvbS5yYW5kaW50KDEwMDAwMCwgOTk5OTk5KQoKICAgIHNlbmRfbWVzc2FnZV90b191c2VyKAogICAgICAgIHVzZXJfaWQsCiAgICAgICAgZiLEkOG6t3QgdGjDoG5oIGPDtG5nIGvhu7MgTUQ1ICN7c2Vzc2lvbl9udW1iZXJ9XG4iCiAgICAgICAgZiJNw6MgZ2lhbyBk4buLY2g6IHt0cmFuc2FjdGlvbl9pZH1cbiIKICAgICAgICBmIk7hu5lpIGR1bmc6IDxiPntjb21tYW5kLnVwcGVyKCl9PC9iPlxuIgogICAgICAgIGYiVGnhu4FuIMSR4bq3dDogPGI+e2Zvcm1hdHRlZF9iZXRfYW1vdW50fTwvYj5cbiIKICAgICAgICBmIlPhu5EgZMawOiB7Zm9ybWF0dGVkX2JhbGFuY2V9XG4iCiAgICAgICAgZiJNRDU6IDxjb2RlPnttZDVfY29kZX08L2NvZGU+IiwKICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIikKCiAgICBib3QucmVwbHlfdG8obWVzc2FnZSwKICAgICAgICBmIjxiPsSQ4bq3dCB0aMOgbmggY8O0bmcga+G7syBNRDUgI3tzZXNzaW9uX251bWJlcn1cbntjb21tYW5kLnVwcGVyKCl9IHtmb3JtYXR0ZWRfYmV0X2Ftb3VudH3EkTwvYj4iLAogICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCgogICAgbm90aWZ5X2dyb3VwNSgKICAgICAgICBmdWxsbmFtZT1mdWxsbmFtZSwKICAgICAgICB1c2VyX2lkPXVzZXJfaWQsCiAgICAgICAgYmV0X3R5cGU9Y29tbWFuZC51cHBlcigpLAogICAgICAgIGJldF9hbW91bnQ9ZiJ7Zm9ybWF0dGVkX2JldF9hbW91bnR9IOKCqyIsCiAgICAgICAgbmV3X2JhbGFuY2U9ZiJ7Zm9ybWF0dGVkX2JhbGFuY2V9IOKCqyIpCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiAoCiAgICBtZXNzYWdlLnRleHQgYW5kICgKICAgICAgICAoCiAgICAgICAgICAgIG1lc3NhZ2UudGV4dFswXS5sb3dlcigpIGluIFsndCcsICd4JywgJ2MnLCAnbCddCiAgICAgICAgICAgIGFuZCBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpWzBdLmxvd2VyKCkgbm90IGluIFsndHQnLCAneHgnLCAnY2MnLCAnbGwnXQogICAgICAgICkKICAgICAgICBvciBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpWzBdLmxvd2VyKCkgaW4gWyd0dCcsICd4eCcsICdjYycsICdsbCddCiAgICAgICAgb3IgbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKVswXS5sb3dlcigpIGluIFsnZDEnLCAnZDInLCAnZDMnLCAnZDQnLCAnZDUnLCAnZDYnXQogICAgICAgIG9yIG1lc3NhZ2UudGV4dC5zdHJpcCgpLnVwcGVyKCkuc3RhcnRzd2l0aCgiQkFPICIpCiAgICAgICAgb3IgbWVzc2FnZS50ZXh0LnN0cmlwKCkudXBwZXIoKS5zdGFydHN3aXRoKCJTQiAiKQogICAgICAgIG9yIG1lc3NhZ2UudGV4dC5sb3dlcigpLnN0YXJ0c3dpdGgoKCd0bCcsICd0YycsICd4bCcsICd4YycpKQogICAgICAgIG9yIG1lc3NhZ2UudGV4dC5sb3dlcigpLnN0YXJ0c3dpdGgoKCdtdCcsICdteCcsICdtbCcsICdtYycpKQogICAgKQopKQpkZWYgcHJvY2Vzc19iZXQobWVzc2FnZSk6CiAgICB0ZXh0ID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkKICAgIHBhcnRzID0gdGV4dC5zcGxpdCgpCiAgICBjb21tYW5kID0gcGFydHNbMF0ubG93ZXIoKQogICAgaWYgY29tbWFuZCBpbiBbJ3QnLCAneCcsICdjJywgJ2wnXSBhbmQgY29tbWFuZCBub3QgaW4gWyd0dCcsICd4eCcsICdjYycsICdsbCddOgogICAgICAgIGhhbmRsZV9iZXRfdHhjbChtZXNzYWdlKQogICAgZWxpZiBjb21tYW5kIGluIFsndHQnLCAneHgnLCAnY2MnLCAnbGwnXToKICAgICAgICBoYW5kbGVfYmV0X3R0eHhjY2xsKG1lc3NhZ2UpCiAgICBlbGlmIGNvbW1hbmQgaW4gWydkMScsICdkMicsICdkMycsICdkNCcsICdkNScsICdkNiddOgogICAgICAgIGhhbmRsZV9iZXRfZChtZXNzYWdlKQogICAgZWxpZiB0ZXh0LnVwcGVyKCkuc3RhcnRzd2l0aCgiQkFPICIpOgogICAgICAgIGhhbmRsZV9iZXRfYmFvKG1lc3NhZ2UpCiAgICBlbGlmIHRleHQudXBwZXIoKS5zdGFydHN3aXRoKCJTQiAiKToKICAgICAgICBoYW5kbGVfYmV0X3NiKG1lc3NhZ2UpCiAgICBlbGlmIGNvbW1hbmQgaW4gWyd0bCcsICd0YycsICd4bCcsICd4YyddOgogICAgICAgIGhhbmRsZV9iZXRfeGllbihtZXNzYWdlKQogICAgZWxpZiBjb21tYW5kIGluIFsnbXQnLCAnbXgnLCAnbWwnLCAnbWMnXToKICAgICAgICBoYW5kbGVfYmV0X21kNShtZXNzYWdlKQoKZGVmIGNhbGN1bGF0ZV9tYXhfYmV0KHNlc3Npb25fbnVtYmVyKToKICAgIG1heF9iZXQgPSA1MDAwMDAKICAgIHJldHVybiBtYXhfYmV0CgpkZWYgZm9ybWF0X2JldHMoZmlsZV9uYW1lLCBzZXNzaW9uX251bWJlcik6CiAgICB0b3RhbF9iZXQgPSByZWFkX2JldHNfZnJvbV9maWxlKGZpbGVfbmFtZSwgc2Vzc2lvbl9udW1iZXIpCiAgICByZXR1cm4gZm9ybWF0X251bWJlcih0b3RhbF9iZXQpCgpkZWYgcmVhZF9iZXRzX2Zyb21fZmlsZShmaWxlX25hbWUsIHNlc3Npb25fbnVtYmVyKToKICAgIHRvdGFsX2JldCA9IDAKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX2JldCArPSBpbnQocGFydHNbMl0pCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgcGFzcwogICAgcmV0dXJuIHRvdGFsX2JldAoKZGVmIGNoZWNrX2FuZF9ub3RpZnlfYmV0cygpOgogICAgZGVmIGhhc19iZXRzX2luX2ZpbGUoZmlsZV9wYXRoLCBzZXNzaW9uX251bWJlcik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aChmIiN7c2Vzc2lvbl9udW1iZXJ9Iik6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGU6IHtmaWxlX3BhdGh9IikKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKCdwaGllbi50eHQnLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICBzZXNzaW9ucyA9IFtsaW5lLnN0cmlwKCkucmVwbGFjZSgnIycsICcnKSBmb3IgbGluZSBpbiBmaWxlIGlmIGxpbmUuc3RyaXAoKV0KCiAgICAgICAgICAgIGZvciBzZXNzaW9uX251bWJlciBpbiBzZXNzaW9uczoKICAgICAgICAgICAgICAgIGZvdW5kX2JldCA9IEZhbHNlCgogICAgICAgICAgICAgICAgZm9yIGZpbGVfbmFtZSBpbiBvcy5saXN0ZGlyKCJGSUxFIik6CiAgICAgICAgICAgICAgICAgICAgaWYgZmlsZV9uYW1lLmVuZHN3aXRoKCcudHh0Jyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsIGZpbGVfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzX2JldHNfaW5fZmlsZShmaWxlX3BhdGgsIHNlc3Npb25fbnVtYmVyKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2JldCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrICAKICAgICAgICAgICAgICAgIGlmIGZvdW5kX2JldDoKICAgICAgICAgICAgICAgICAgICBzZW5kX2JldHRpbmdfbm90aWZpY2F0aW9ucyhzZXNzaW9uX251bWJlcikKCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludCgiW0VSUk9SXSBLaMO0bmcgdMOsbSB0aOG6pXkgJ3BoaWVuLnR4dCciKQogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFWENFUFRJT05dIHtlfSIpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKCmRlZiBjYWxjdWxhdGVfdG90YWxfd2lubmluZ3NfbG9zc2VzKHNlc3Npb25fbnVtYmVyLCByZXN1bHRfdHgsIHJlc3VsdF9jbCk6CiAgICB0b3RhbF9iZXRfd2luID0gMAogICAgdG90YWxfYmV0X2xvc3MgPSAwCiAgICBkaXJlY3RvcnkgPSAiRklMRSIgIAogICAgZm9yIGZpbGVfbmFtZSBpbiBvcy5saXN0ZGlyKGRpcmVjdG9yeSk6CiAgICAgICAgaWYgbm90IGZpbGVfbmFtZS5lbmRzd2l0aCgnLnR4dCcpOgogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oZGlyZWN0b3J5LCBmaWxlX25hbWUpCgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J2lnbm9yZScpIGFzIGZpbGU6ICAjIOKchSBUaMOqbSBlcnJvcnM9J2lnbm9yZScKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMyBhbmQgcGFydHNbMF0gPT0gZiIje3Nlc3Npb25fbnVtYmVyfSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChwYXJ0c1syXSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFjDoWMgxJHhu4tuaCBsb+G6oWkgY8aw4bujYyB0aGVvIHTDqm4gZmlsZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG93ZXJfbmFtZSA9IGZpbGVfbmFtZS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAndGFpJyBpbiBsb3dlcl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3dpbiA9IChyZXN1bHRfdHggPT0gJ1TDoGknKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiAneGl1JyBpbiBsb3dlcl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3dpbiA9IChyZXN1bHRfdHggPT0gJ1jhu4l1JykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgJ2NoYW4nIGluIGxvd2VyX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfd2luID0gKHJlc3VsdF9jbCA9PSAnQ2jhurVuJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgJ2xlJyBpbiBsb3dlcl9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3dpbiA9IChyZXN1bHRfY2wgPT0gJ0zhursnKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZSAgIyBC4buPIHF1YSBjw6FjIGZpbGUga2jDtG5nIHjDoWMgxJHhu4tuaAoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzX3dpbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9iZXRfd2luICs9IGFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9iZXRfbG9zcyArPSBhbW91bnQKCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gU2FpIHPhu5EgdGnhu4FuIHThuqFpIGTDsm5nOiB7bGluZS5zdHJpcCgpfSB0cm9uZyBmaWxlIHtmaWxlX25hbWV9IikKCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGU6IHtmaWxlX3BhdGh9IikKICAgICAgICBleGNlcHQgSU9FcnJvciBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIMSR4buNYyBmaWxlIHtmaWxlX3BhdGh9OiB7ZX0iKQoKICAgIHJldHVybiB0b3RhbF9iZXRfd2luLCB0b3RhbF9iZXRfbG9zcwoKZGVmIGdldF9sYXN0X3Nlc3Npb25fbnVtYmVyKGZpbGVfbmFtZSk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfbmFtZSwgJ3InKSBhcyBmaWxlOgogICAgICAgICAgICBsaW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKICAgICAgICAgICAgaWYgbGluZXM6CgogICAgICAgICAgICAgICAgbGFzdF9saW5lID0gbGluZXNbLTFdLnN0cmlwKCkKCiAgICAgICAgICAgICAgICBpZiBsYXN0X2xpbmUuc3RhcnRzd2l0aCgiIyIpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQobGFzdF9saW5lLnNwbGl0KClbMF1bMTpdKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHByaW50KGYiV2FybmluZzogRmlsZSB7ZmlsZV9uYW1lfSBub3QgZm91bmQuIikKICAgIHJldHVybiBOb25lCgpkZWYgdGFvX2ZpbGVfbWFjX2RpbmgoKToKICAgIHRodV9tdWMgPSAiRklMRSIKICAgIG9zLm1ha2VkaXJzKHRodV9tdWMsIGV4aXN0X29rPVRydWUpICAKICAgIG5vaV9kdW5nID0gewogICAgICAgICJwaGllbi50eHQiOiAiMSIsCiAgICAgICAgImtxdGFpLnR4dCI6ICI1MCIsCiAgICAgICAgImtxeGl1LnR4dCI6ICI1MCIsCiAgICAgICAgImtxY2hhbi50eHQiOiAiNTAiLAogICAgICAgICJrcWxlLnR4dCI6ICI1MCJ9CiAgICBmb3IgdGVuX2ZpbGUsIGdpYV90cmkgaW4gbm9pX2R1bmcuaXRlbXMoKToKICAgICAgICBkdW9uZ19kYW4gPSBvcy5wYXRoLmpvaW4odGh1X211YywgdGVuX2ZpbGUpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZHVvbmdfZGFuKToKICAgICAgICAgICAgY29udGludWUgIAogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGR1b25nX2RhbiwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZShnaWFfdHJpKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyB04bqhbyBmaWxlICd7ZHVvbmdfZGFufScgduG7m2kgbuG7mWkgZHVuZzoge2dpYV90cml9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBLaMO0bmcgdGjhu4MgdOG6oW8gZmlsZSAne2R1b25nX2Rhbn0nOiB7ZX0iKQogICAgcmV0dXJuIE5vbmUKCmRlZiBjaGVja19mb3JfYmV0cyhzZXNzaW9uX251bWJlcik6CiAgICBpbXBvcnQgb3MKICAgIGZvbGRlciA9ICdGSUxFJwogICAgb3MubWFrZWRpcnMoZm9sZGVyLCBleGlzdF9vaz1UcnVlKQogICAgZmlsZXMgPSBbCiAgICAgICAgJ3RhaS50eHQnLCAneGl1LnR4dCcsICdjaGFuLnR4dCcsICdsZS50eHQnLAogICAgICAgICd0bC50eHQnLCAndGMudHh0JywgJ3hsLnR4dCcsICd4Yy50eHQnLAogICAgICAgICdkMS50eHQnLCAnZDIudHh0JywgJ2QzLnR4dCcsICdkNC50eHQnLCAnZDUudHh0JywgJ2Q2LnR4dCcsCiAgICAgICAgJ2Jhby50eHQnLCAnc2IudHh0JywnbXQudHh0JywnbXgudHh0JywnbWMudHh0JywnbWwudHh0JwogICAgXQoKICAgIHdhcm5lZF9maWxlcyA9IHNldCgpCgogICAgZm9yIGZpbGVfbmFtZSBpbiBmaWxlczoKICAgICAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCBmaWxlX25hbWUpCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIGlmIGZpbGVfbmFtZSBub3QgaW4gd2FybmVkX2ZpbGVzOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgdOG6oW8ge2ZpbGVfcGF0aH0iKQogICAgICAgICAgICAgICAgd2FybmVkX2ZpbGVzLmFkZChmaWxlX25hbWUpCiAgICAgICAgICAgIG9wZW4oZmlsZV9wYXRoLCAndycpLmNsb3NlKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aChmIiN7c2Vzc2lvbl9udW1iZXJ9Iik6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICByZXR1cm4gRmFsc2UKCmRlZiBkaW5oZGFuZyhhbW91bnQpOgogICAgdHJ5OgogICAgICAgIGFtb3VudCA9IGZsb2F0KGFtb3VudCkgCiAgICAgICAgaWYgYW1vdW50LmlzX2ludGVnZXIoKToKICAgICAgICAgICAgYW1vdW50ID0gaW50KGFtb3VudCkgIAogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpICAKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHJldHVybiAiMCIKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRhaWtob2FuIikKZGVmIHRhaWtob2FuKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBjYWxsLmZyb21fdXNlci5pZAogICAgICAgIGZ1bGxuYW1lID0gY2FsbC5mcm9tX3VzZXIuZnVsbF9uYW1lCgogICAgICAgIGZvbGRlciA9ICJGSUxFIgogICAgICAgIHNkX3BhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnc2QudHh0JykKICAgICAgICB0b3BjdW9jX3BhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAndG9wY3VvYy50eHQnKQogICAgICAgIGNodW9pX3BhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnY2h1b2l0aGFuZ3RodWEudHh0JykKCiAgICAgICAgc29kdSA9IDAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihzZF9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIHNkX2ZpbGU6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBzZF9maWxlOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIHVpZCwgdmljaGluaCA9IHBhcnRzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGludCh1aWQpID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb2R1ID0gZmxvYXQodmljaGluaCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkOG7jWMgc+G7kSBkxrAgKHbDrSBjaMOtbmgpOiB7c29kdX0gY2hvIG5nxrDhu51pIGTDuW5nIElEIHt1c2VyX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlICd7c2RfcGF0aH0nIikKCiAgICAgICAgY3VvY19ob21uYXkgPSAwCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4odG9wY3VvY19wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGJldF9maWxlOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gYmV0X2ZpbGU6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMzoKICAgICAgICAgICAgICAgICAgICAgICAgdWlkLCBiZXRfdG9kYXksIF8gPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgICAgICBpZiBpbnQodWlkKSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VvY19ob21uYXkgPSBmbG9hdChiZXRfdG9kYXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDhu41jIGPGsOG7o2MgaMO0bSBuYXk6IHtjdW9jX2hvbW5heX0gY2hvIG5nxrDhu51pIGTDuW5nIElEIHt1c2VyX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlICd7dG9wY3VvY19wYXRofSciKQoKICAgICAgICBjaHVvaV90aGFuZywgY2h1b2lfdGh1YSA9IDAsIDAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihjaHVvaV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGNodW9pX2ZpbGU6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBjaHVvaV9maWxlOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHVpZCwgdGhhbmcsIHRodWEgPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgICAgICBpZiBpbnQodWlkKSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2h1b2lfdGhhbmcgPSBpbnQoZmxvYXQodGhhbmcpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2h1b2lfdGh1YSA9IGludChmbG9hdCh0aHVhKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkOG7jWMgY2h14buXaSB0aOG6r25nL3RodWE6IHtjaHVvaV90aGFuZ30gdGjhuq9uZywge2NodW9pX3RodWF9IHRodWEgY2hvIG5nxrDhu51pIGTDuW5nIElEIHt1c2VyX2lkfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlICd7Y2h1b2lfcGF0aH0nIikKCiAgICAgICAgdmlldG5hbV90eiA9IHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKQogICAgICAgIG5vdyA9IGRhdGV0aW1lLm5vdyh2aWV0bmFtX3R6KQogICAgICAgIG5nYXlfaGllbnRhaSA9IG5vdy5zdHJmdGltZSgiJWQvJW0vJVkiKQoKICAgICAgICBzb2R1X2Zvcm1hdHRlZCA9IGRpbmhkYW5nKHNvZHUpCiAgICAgICAgY3VvY19ob21uYXlfZm9ybWF0dGVkID0gZGluaGRhbmcoY3VvY19ob21uYXkpCiMgICAgICAgICAgICBmIkPGsOG7o2MgaMO0bSBuYXk6IHtjdW9jX2hvbW5heV9mb3JtYXR0ZWR9XG4iCgogICAgICAgIG1lc3NhZ2UgPSAoCiAgICAgICAgICAgIGYiWGluIGNow6BvIHtmdWxsbmFtZX1cbiIKICAgICAgICAgICAgZiJT4buRIGTGsCBj4bunYSBi4bqhbjoge3NvZHVfZm9ybWF0dGVkfVxuIgogICAgICAgICAgICBmIj09PT09PT09PT09PT09PT09PT09PVxuIgogICAgICAgICAgICBmIk5nw6B5OiB7bmdheV9oaWVudGFpfVxuIgogICAgICAgICAgICBmIkNodeG7l2kgdGjhuq9uZzoge2NodW9pX3RoYW5nfVxuIgogICAgICAgICAgICBmIkNodeG7l2kgdGh1YToge2NodW9pX3RodWF9IgogICAgICAgICkKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeSgKICAgICAgICAgICAgY2FsbC5pZCwKICAgICAgICAgICAgdGV4dD1tZXNzYWdlLAogICAgICAgICAgICBzaG93X2FsZXJ0PVRydWUKICAgICAgICApCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gdMOgaSBraG/huqNuOiB7ZX0iKQoKYWNjZXB0aW5nX2JldHMgPSBGYWxzZQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogVHJ1ZSwgY29udGVudF90eXBlcz1bJ3RleHQnLCAncGhvdG8nLCAnc3RpY2tlcicsICdhbmltYXRpb24nLCAndmlkZW8nLCAnZG9jdW1lbnQnXSkKZGVmIGRlbGV0ZV91bndhbnRlZF9tZXNzYWdlcyhtZXNzYWdlKToKICAgIGdsb2JhbCBhY2NlcHRpbmdfYmV0cwoKICAgIGlmIGFjY2VwdGluZ19iZXRzOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBib3QuZGVsZXRlX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIG1lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHjDs2EgbWVzc2FnZV9pZCB7bWVzc2FnZS5tZXNzYWdlX2lkfSBj4bunYSB1c2VyIHttZXNzYWdlLmZyb21fdXNlci5pZH0gduG7m2kgbuG7mWkgZHVuZyB0eXBlIHttZXNzYWdlLmNvbnRlbnRfdHlwZX0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBLaMO0bmcgdGjhu4MgeMOzYSBtZXNzYWdlX2lkIHttZXNzYWdlLm1lc3NhZ2VfaWR9IGPhu6dhIHVzZXIge21lc3NhZ2UuZnJvbV91c2VyLmlkfToge2V9IikKCnNlc3Npb25fdGltZV9jb3VudGVyID0gewogICAgMzA6IDAsCiAgICA2MDogMCwKICAgIDkwOiAwLAogICAgMDogMAp9CgpkZWYgZ2VuZXJhdGVfZHluYW1pY190aW1lKCk6CiAgICBtYXhfY291bnRzID0gezMwOiA2LCA2MDogMiwgOTA6IDEsIDA6IDF9CgogICAgYXZhaWxhYmxlID0gW10KICAgIGZvciB0IGluIFszMCwgNjAsIDkwLCAwXToKICAgICAgICBpZiBzZXNzaW9uX3RpbWVfY291bnRlclt0XSA8IG1heF9jb3VudHNbdF06CiAgICAgICAgICAgIGF2YWlsYWJsZS5hcHBlbmQodCkKCiAgICBpZiAzMCBpbiBhdmFpbGFibGU6CiAgICAgICAgY2hvc2VuID0gMzAKICAgIGVsc2U6CiAgICAgICAgY2hvc2VuID0gcmFuZG9tLmNob2ljZShhdmFpbGFibGUpCgogICAgc2Vzc2lvbl90aW1lX2NvdW50ZXJbY2hvc2VuXSArPSAxCiAgICByZXR1cm4gY2hvc2VuCgpUSU1FX0RJU1RSSUJVVElPTiA9IFsxMjBdCmN1cnJlbnRfdGltZV9jeWNsZSA9IFtdCmN1cnJlbnRfY3ljbGVfaW5kZXggPSAwCgpkZWYgZ2V0X3RvdGFsX3RpbWVfZm9yX3Nlc3Npb24oc2Vzc2lvbl9udW1iZXIpOgogICAgZ2xvYmFsIGN1cnJlbnRfdGltZV9jeWNsZSwgY3VycmVudF9jeWNsZV9pbmRleAogICAgaWYgbm90IGN1cnJlbnRfdGltZV9jeWNsZSBvciBjdXJyZW50X2N5Y2xlX2luZGV4ID49IGxlbihjdXJyZW50X3RpbWVfY3ljbGUpOgogICAgICAgIGN1cnJlbnRfdGltZV9jeWNsZSA9IFRJTUVfRElTVFJJQlVUSU9OWzpdCiAgICAgICAgcmFuZG9tLnNodWZmbGUoY3VycmVudF90aW1lX2N5Y2xlKQogICAgICAgIGN1cnJlbnRfY3ljbGVfaW5kZXggPSAwCiAgICB0aW1lX2Zvcl9zZXNzaW9uID0gY3VycmVudF90aW1lX2N5Y2xlW2N1cnJlbnRfY3ljbGVfaW5kZXhdCiAgICBjdXJyZW50X2N5Y2xlX2luZGV4ICs9IDEKICAgIHByaW50KGYiW0RFQlVHXSBQaGnDqm4gI3tzZXNzaW9uX251bWJlcn0gY8OzIHRo4budaSBnaWFuIGPGsOG7o2M6IHt0aW1lX2Zvcl9zZXNzaW9ufXMiKQogICAgcmV0dXJuIHRpbWVfZm9yX3Nlc3Npb24KCiAgICAiIiIKICAgIHdoaWxlIFRydWU6CiAgICAgICAgI2lmIGNoZWNrX2Zvcl9iZXRzKHNlc3Npb25fbnVtYmVyKToKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIGJyZWFrCiAgICAiIiIKCmRlZiBzZW5kX2JldHRpbmdfbm90aWZpY2F0aW9ucyhzZXNzaW9uX251bWJlcik6CiAgICBnbG9iYWwgYWNjZXB0aW5nX2JldHMsIGxhc3RfYmV0X2Nsb3NlX21lc3NhZ2VfaWQKCiAgICB0b3RhbF90aW1lID0gZ2V0X3RvdGFsX3RpbWVfZm9yX3Nlc3Npb24oc2Vzc2lvbl9udW1iZXIpCiAgICBhY2NlcHRpbmdfYmV0cyA9IFRydWUKICAgIHN0YXJ0X3RpbWUgPSBOb25lCgogICAgd2hpbGUgVHJ1ZToKICAgICAgICAjaWYgY2hlY2tfZm9yX2JldHMoc2Vzc2lvbl9udW1iZXIpOgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGJyZWFrCiAgICAgICAgCiAgICB0aW1lLnNsZWVwKDIpCgogICAgYW5ub3VuY2VkID0gc2V0KCkKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIGVsYXBzZWQgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICByZW1haW5pbmcgPSBpbnQodG90YWxfdGltZSAtIGVsYXBzZWQpCiAgICAgICAgaWYgcmVtYWluaW5nIDwgMDoKICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgaWYgcmVtYWluaW5nIGluIFs5OSwgNzksIDU5LCAzOSwgMTksIDldIGFuZCByZW1haW5pbmcgbm90IGluIGFubm91bmNlZDoKICAgICAgICAgICAgYW5ub3VuY2VkLmFkZChyZW1haW5pbmcpCiAgICAgICAgICAgIGZvbGRlciA9ICJGSUxFIgogICAgICAgICAgICBib251c190ZXh0ID0gZ2V0X2JvbnVzX3N0YXR1c190ZXh0KCkKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShncm91cF9jaGF0X2lkLAogICAgZiIiIgo8Yj5Dw7JuIHtyZW1haW5pbmd9cyDEkeG7gyBjxrDhu6NjIHBoacOqbiAje3Nlc3Npb25fbnVtYmVyfQrwn5S1IFTDgEkgOiB7Zm9ybWF0X2JldHMob3MucGF0aC5qb2luKGZvbGRlciwgJ3RhaS50eHQnKSwgc2Vzc2lvbl9udW1iZXIpfQrwn5S0IFjhu4hVIDoge2Zvcm1hdF9iZXRzKG9zLnBhdGguam9pbihmb2xkZXIsICd4aXUudHh0JyksIHNlc3Npb25fbnVtYmVyKX0KCuKaqu+4jyBDSOG6tE46IHtmb3JtYXRfYmV0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCAnY2hhbi50eHQnKSwgc2Vzc2lvbl9udW1iZXIpfQrimqvvuI8gTOG6uiAgOiB7Zm9ybWF0X2JldHMob3MucGF0aC5qb2luKGZvbGRlciwgJ2xlLnR4dCcpLCBzZXNzaW9uX251bWJlcil9PC9iPgoKe2JvbnVzX3RleHR9CiIiIiwKICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwsCiAgICByZXBseV9tYXJrdXA9dHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAoKS5yb3coCiAgICAgICAgdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIk7huqFwIFRp4buBbiIsIHVybD0iaHR0cHM6Ly90Lm1lL3RpbmhsaW5oYm90P3N0YXJ0PW5hcHRpZW4iKSwKICAgICAgICB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiVMOgaSBraG/huqNuIiwgY2FsbGJhY2tfZGF0YT0idGFpa2hvYW4iKQogICAgKQopCgogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCgogICAgYWNjZXB0aW5nX2JldHMgPSBGYWxzZQogICAgY2xvc2VfYmV0X21lc3NhZ2UgPSBib3Quc2VuZF9tZXNzYWdlKGdyb3VwX2NoYXRfaWQsICI8Yj5OZ8awbmcgbmjhuq1uIGPGsOG7o2M8L2I+IiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgIGxhc3RfYmV0X2Nsb3NlX21lc3NhZ2VfaWQgPSBjbG9zZV9iZXRfbWVzc2FnZS5tZXNzYWdlX2lkCiAgICB0aW1lLnNsZWVwKDEpCiAgICB0cnk6CiAgICAgICAgcm9vbV9maWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAicm9vbS50eHQiKQogICAgICAgIHdpdGggb3Blbihyb29tX2ZpbGVfcGF0aCwgInIrIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgY29udGVudCA9IGYucmVhZCgpLnN0cmlwKCkKICAgICAgICAgICAgaWYgY29udGVudC51cHBlcigpID09ICJUUlVFIjoKICAgICAgICAgICAgICAgIGYuc2VlaygwKQogICAgICAgICAgICAgICAgZi53cml0ZSgiRkFMU0UiKQogICAgICAgICAgICAgICAgZi50cnVuY2F0ZSgpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgcm9vbS50eHQ6IHtlfSIpCgogICAgZm9sZGVyID0gIkZJTEUiCiAgICB0bF9iZXQgPSBmb3JtYXRfYmV0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCAndGwudHh0JyksIHNlc3Npb25fbnVtYmVyKQogICAgdGNfYmV0ID0gZm9ybWF0X2JldHMob3MucGF0aC5qb2luKGZvbGRlciwgJ3RjLnR4dCcpLCBzZXNzaW9uX251bWJlcikKICAgIHhsX2JldCA9IGZvcm1hdF9iZXRzKG9zLnBhdGguam9pbihmb2xkZXIsICd4bC50eHQnKSwgc2Vzc2lvbl9udW1iZXIpCiAgICB4Y19iZXQgPSBmb3JtYXRfYmV0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCAneGMudHh0JyksIHNlc3Npb25fbnVtYmVyKQoKICAgIHhpZW5fY3VvY19maWxlID0gIiIKICAgIGlmIHRsX2JldCBhbmQgdGxfYmV0ICE9ICIwIjoKICAgICAgICB4aWVuX2N1b2NfZmlsZSArPSBmIlRMIDoge3RsX2JldH1cbiIKICAgIGlmIHRjX2JldCBhbmQgdGNfYmV0ICE9ICIwIjoKICAgICAgICB4aWVuX2N1b2NfZmlsZSArPSBmIlRDIDoge3RjX2JldH1cbiIKICAgIGlmIHhsX2JldCBhbmQgeGxfYmV0ICE9ICIwIjoKICAgICAgICB4aWVuX2N1b2NfZmlsZSArPSBmIlhMIDoge3hsX2JldH1cbiIKICAgIGlmIHhjX2JldCBhbmQgeGNfYmV0ICE9ICIwIjoKICAgICAgICB4aWVuX2N1b2NfZmlsZSArPSBmIlhDIDoge3hjX2JldH1cbiIKCiAgICBib3Quc2VuZF9tZXNzYWdlKGdyb3VwX2NoYXRfaWQsCiAgICBmIiIiCjxiPkjhur90IHRo4budaSBnaWFuIMSR4bq3dCBjxrDhu6NjLCBjaHXhuqluIGLhu4sgdHVuZyBYWCBr4buzICN7c2Vzc2lvbl9udW1iZXJ9CvCflLUgVMOASSA6IHtmb3JtYXRfYmV0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCAndGFpLnR4dCcpLCBzZXNzaW9uX251bWJlcil9CvCflLQgWOG7iFUgOiB7Zm9ybWF0X2JldHMob3MucGF0aC5qb2luKGZvbGRlciwgJ3hpdS50eHQnKSwgc2Vzc2lvbl9udW1iZXIpfQoK4pqq77iPIENI4bq0Tjoge2Zvcm1hdF9iZXRzKG9zLnBhdGguam9pbihmb2xkZXIsICdjaGFuLnR4dCcpLCBzZXNzaW9uX251bWJlcil9CuKaq++4jyBM4bq6ICA6IHtmb3JtYXRfYmV0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCAnbGUudHh0JyksIHNlc3Npb25fbnVtYmVyKX0KCnt4aWVuX2N1b2NfZmlsZX08L2I+Cntib251c190ZXh0fQoKIiIiLAogICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAopCgogICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICBncm91cF9jaGF0X2lkLAogICAgICAgIGYiPGI+8J+SpULhuq90IMSR4bqndSB0dW5nIFhYIGvhu7MgI3tzZXNzaW9uX251bWJlcn3wn5KlPC9iPiIsCiAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgKQoKZGVmIHNlbmRfZGljZV9ncm91cF9jaGF0KGdyb3VwX2NoYXRfaWQpOgogICAgZGljZV92YWx1ZXMgPSBbTm9uZSwgTm9uZSwgTm9uZV0KCiAgICBkZWYgc2VuZF9zaW5nbGVfZGljZShpbmRleCwgZGVsYXkpOgogICAgICAgIHRpbWUuc2xlZXAoZGVsYXkpCiAgICAgICAgdmFsdWUgPSAwCiAgICAgICAgd2hpbGUgdmFsdWUgPT0gMDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdXJsID0gZidodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e2JvdDEudG9rZW59L3NlbmREaWNlP2NoYXRfaWQ9e2dyb3VwX2NoYXRfaWR9JwogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQodXJsKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbVGhyZWFkIHtpbmRleCsxfV0gR+G7rWkgZGljZTogSFRUUCB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IikKICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgICAgICAgICAgICAgaWYgJ3Jlc3VsdCcgaW4gZGF0YSBhbmQgJ2RpY2UnIGluIGRhdGFbJ3Jlc3VsdCddOgogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGRhdGFbJ3Jlc3VsdCddWydkaWNlJ11bJ3ZhbHVlJ10KICAgICAgICAgICAgICAgICAgICAgICAgaWYgdmFsdWUgIT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpY2VfdmFsdWVzW2luZGV4XSA9IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltUaHJlYWQge2luZGV4KzF9XSBOaOG6rW4gZ2nDoSB0cuG7iyBkaWNlOiB7dmFsdWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltUaHJlYWQge2luZGV4KzF9XSBHacOhIHRy4buLIGRpY2Ugbmjhuq1uIMSRxrDhu6NjIGzDoCAwLCB0aOG7rSBs4bqhaS4uLiIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbVGhyZWFkIHtpbmRleCsxfV0gS2jDtG5nIHTDrG0gdGjhuqV5IGvhur90IHF14bqjIGRpY2UgdHJvbmcgcGjhuqNuIGjhu5NpLiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW1RocmVhZCB7aW5kZXgrMX1dIEzhu5dpIEhUVFA6IHtyZXNwb25zZS5zdGF0dXNfY29kZX0gLSB7cmVzcG9uc2UudGV4dH0iKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjUsIDIuNSkpCiAgICAgICAgICAgIGV4Y2VwdCByZXF1ZXN0cy5SZXF1ZXN0RXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltUaHJlYWQge2luZGV4KzF9XSBM4buXaSBn4butaSBkaWNlOiB7ZX0iKQogICAgICAgICAgICAgICAgdGltZS5zbGVlcChyYW5kb20udW5pZm9ybSgwLjUsIDIuNSkpCgogICAgZGVsYXlzID0gWzAuNSwgMS41LCAyLjBdCgogICAgdGhyZWFkcyA9IFtdCiAgICBmb3IgaSBpbiByYW5nZSgzKToKICAgICAgICB0aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZW5kX3NpbmdsZV9kaWNlLCBhcmdzPShpLCBkZWxheXNbaV0pKQogICAgICAgIHRocmVhZHMuYXBwZW5kKHRocmVhZCkKICAgICAgICB0aHJlYWQuc3RhcnQoKQoKICAgIGZvciB0aHJlYWQgaW4gdGhyZWFkczoKICAgICAgICB0aHJlYWQuam9pbigpCgogICAgcHJpbnQoZiJL4bq/dCBxdeG6oyAzIHZpw6puIHjDumMgeOG6r2M6IHtkaWNlX3ZhbHVlc30iKQogICAgcmV0dXJuIGRpY2VfdmFsdWVzCgpkZWYgdXBkYXRlX2ZpbGVfdmFsdWUoZmlsZXBhdGgsIGNoYW5nZSk6CiAgICBjdXJyZW50X3ZhbHVlID0gMAogICAgdHJ5OgogICAgICAgIGNvbnRlbnQgPSByZWFkX2ZpbGVfY29udGVudChmaWxlcGF0aCkKICAgICAgICBpZiBjb250ZW50IGFuZCBjb250ZW50LnN0cmlwKCk6CiAgICAgICAgICAgIGN1cnJlbnRfdmFsdWUgPSBpbnQoY29udGVudC5zdHJpcCgpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KGYiW0lORk9dIEZpbGUge2ZpbGVwYXRofSBpcyBlbXB0eSBvciBjb250ZW50IGlzIG5vdCBudW1lcmljLCB0cmVhdGluZyBhcyAwIGZvciB1cGRhdGUuIikKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBGaWxlIHtmaWxlcGF0aH0gZG9lcyBub3QgY29udGFpbiBhIHZhbGlkIGludGVnZXIuIFRyZWF0aW5nIGFzIDAgZm9yIHVwZGF0ZS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBDb3VsZCBub3QgcmVhZCB7ZmlsZXBhdGh9IG9yIGNvbnZlcnQgdG8gaW50LCB0cmVhdGluZyBhcyAwIGZvciB1cGRhdGU6IHtlfSIpCgogICAgbmV3X3ZhbHVlID0gY3VycmVudF92YWx1ZSArIGNoYW5nZQogICAgd3JpdGVfZmlsZV9jb250ZW50KGZpbGVwYXRoLCBzdHIobmV3X3ZhbHVlKSkKICAgIHByaW50KGYiW0RFQlVHXSBVcGRhdGVkIHtmaWxlcGF0aH06IHtjdXJyZW50X3ZhbHVlfSAtPiB7bmV3X3ZhbHVlfSAoQ2hhbmdlOiB7Y2hhbmdlfSkiKQoKZGVmIHVwZGF0ZV9maWxlX3ZhbHVlKGZpbGVwYXRoLCBjaGFuZ2UpOgogICAgY3VycmVudF92YWx1ZSA9IDAKICAgIHRyeToKICAgICAgICBjb250ZW50ID0gcmVhZF9maWxlX2NvbnRlbnQoZmlsZXBhdGgpCiAgICAgICAgaWYgY29udGVudCBhbmQgY29udGVudC5zdHJpcCgpOgogICAgICAgICAgICBjdXJyZW50X3ZhbHVlID0gaW50KGNvbnRlbnQuc3RyaXAoKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludChmIltJTkZPXSBGaWxlIHtmaWxlcGF0aH0gaXMgZW1wdHkgb3IgY29udGVudCBpcyBub3QgbnVtZXJpYywgdHJlYXRpbmcgYXMgMCBmb3IgdXBkYXRlLiIpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBwcmludChmIltFUlJPUl0gRmlsZSB7ZmlsZXBhdGh9IGRvZXMgbm90IGNvbnRhaW4gYSB2YWxpZCBpbnRlZ2VyLiBUcmVhdGluZyBhcyAwIGZvciB1cGRhdGUuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gQ291bGQgbm90IHJlYWQge2ZpbGVwYXRofSBvciBjb252ZXJ0IHRvIGludCwgdHJlYXRpbmcgYXMgMCBmb3IgdXBkYXRlOiB7ZX0iKQoKICAgIG5ld192YWx1ZSA9IGN1cnJlbnRfdmFsdWUgKyBjaGFuZ2UKICAgIHdyaXRlX2ZpbGVfY29udGVudChmaWxlcGF0aCwgc3RyKG5ld192YWx1ZSkpCiAgICBwcmludChmIltERUJVR10gVXBkYXRlZCB7ZmlsZXBhdGh9OiB7Y3VycmVudF92YWx1ZX0gLT4ge25ld192YWx1ZX0gKENoYW5nZToge2NoYW5nZX0pIikKCmRlZiBtZDVfaXNfd2luKGNvbW1hbmQsIHRvdGFsKToKICAgIGxhc3RfZGlnaXQgPSB0b3RhbCAlIDEwCiAgICBpZiBjb21tYW5kID09ICdtdCc6CiAgICAgICAgcmV0dXJuIGxhc3RfZGlnaXQgaW4gWzUsIDYsIDcsIDgsIDldCiAgICBlbGlmIGNvbW1hbmQgPT0gJ214JzoKICAgICAgICByZXR1cm4gbGFzdF9kaWdpdCBpbiBbMCwgMSwgMiwgMywgNF0KICAgIGVsaWYgY29tbWFuZCA9PSAnbWMnOgogICAgICAgIHJldHVybiBsYXN0X2RpZ2l0IGluIFswLCAyLCA0LCA2LCA4XQogICAgZWxpZiBjb21tYW5kID09ICdtbCc6CiAgICAgICAgcmV0dXJuIGxhc3RfZGlnaXQgaW4gWzEsIDMsIDUsIDcsIDldCiAgICBlbHNlOgogICAgICAgIHJldHVybiBOb25lICAKCmRlZiBkX2lzX3dpbihjb21tYW5kLCBkaWNlX3ZhbHVlcyk6CiAgICB0cnk6CiAgICAgICAgZF9udW0gPSBpbnQoY29tbWFuZC5sb3dlcigpLnJlcGxhY2UoJ2QnLCAnJykpCiAgICBleGNlcHQ6CiAgICAgICAgcmV0dXJuIDAgCiAgICByZXR1cm4gZGljZV92YWx1ZXMuY291bnQoZF9udW0pCgpkZWYgeGllbl9pc193aW4oY29tbWFuZCwgZGljZV92YWx1ZXMpOgogICAgdG90YWwgPSBzdW0oZGljZV92YWx1ZXMpCiAgICBjb21tYW5kID0gY29tbWFuZC5sb3dlcigpCgogICAgaWYgY29tbWFuZCA9PSAndGMnOgogICAgICAgIHJldHVybiB0b3RhbCBpbiBbMTIsIDE0LCAxNiwgMThdCiAgICBlbGlmIGNvbW1hbmQgPT0gJ3RsJzoKICAgICAgICByZXR1cm4gdG90YWwgaW4gWzExLCAxMywgMTUsIDE3XQogICAgZWxpZiBjb21tYW5kID09ICd4bCc6CiAgICAgICAgcmV0dXJuIHRvdGFsIGluIFszLCA1LCA3LCA5XQogICAgZWxpZiBjb21tYW5kID09ICd4Yyc6CiAgICAgICAgcmV0dXJuIHRvdGFsIGluIFs0LCA2LCA4LCAxMF0KICAgIHJldHVybiBGYWxzZQoKZGVmIGJhb19pc193aW4oY29tbWFuZCwgZGljZV92YWx1ZXMpOgogICAgY29tbWFuZCA9IGNvbW1hbmQubG93ZXIoKS5zdHJpcCgpCiAgICBpZiAnYWxsJyBpbiBjb21tYW5kOgogICAgICAgIHJldHVybiBkaWNlX3ZhbHVlc1swXSA9PSBkaWNlX3ZhbHVlc1sxXSA9PSBkaWNlX3ZhbHVlc1syXQogICAgaWYgY29tbWFuZC5zdGFydHN3aXRoKCdiw6NvJyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXJnZXQgPSBpbnQoY29tbWFuZC5yZXBsYWNlKCdiw6NvJywgJycpLnN0cmlwKCkpCiAgICAgICAgICAgIHJldHVybiBkaWNlX3ZhbHVlcy5jb3VudCh0YXJnZXQpID09IDMKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgaWYgY29tbWFuZC5zdGFydHN3aXRoKCdzYicpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZWN0ZWQgPSBpbnQoY29tbWFuZC5yZXBsYWNlKCdzYicsICcnKS5zdHJpcCgpKQogICAgICAgICAgICB0b3RhbCA9IHN1bShkaWNlX3ZhbHVlcykKICAgICAgICAgICAgcmV0dXJuIHRvdGFsID09IHNlbGVjdGVkCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIHJldHVybiBGYWxzZQoKZGVmIHNiX2lzX3dpbihjb21tYW5kLCBkaWNlX3ZhbHVlcyk6CiAgICBjb21tYW5kID0gY29tbWFuZC5sb3dlcigpLnN0cmlwKCkKCiAgICBpZiBjb21tYW5kLnN0YXJ0c3dpdGgoJ3NiJyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxlY3RlZCA9IGludChjb21tYW5kLnJlcGxhY2UoJ3NiJywgJycpLnN0cmlwKCkpCiAgICAgICAgICAgIHRvdGFsID0gc3VtKGRpY2VfdmFsdWVzKQogICAgICAgICAgICByZXR1cm4gdG90YWwgPT0gc2VsZWN0ZWQKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIHJldHVybiBGYWxzZQoKZGVmIHhpZW5fZ2V0X3RpbGUoY29tbWFuZCk6CiAgICBjb21tYW5kID0gY29tbWFuZC5sb3dlcigpCiAgICBpZiBjb21tYW5kIGluIFsndGMnLCAneGwnXToKICAgICAgICByZXR1cm4gMy45CiAgICBlbGlmIGNvbW1hbmQgaW4gWyd0bCcsICd4YyddOgogICAgICAgIHJldHVybiAzLjMKICAgIHJldHVybiAwCgpkZWYgYmFvX2dldF90aWxlKGNvbW1hbmQpOgogICAgY29tbWFuZCA9IGNvbW1hbmQubG93ZXIoKS5zdHJpcCgpCgogICAgaWYgJ2FsbCcgaW4gY29tbWFuZDoKICAgICAgICByZXR1cm4gMjAgCiAgICBpZiBjb21tYW5kLnN0YXJ0c3dpdGgoJ2JhbycpOgogICAgICAgIHRyeToKICAgICAgICAgICAgbnVtID0gaW50KGNvbW1hbmQucmVwbGFjZSgnYmFvJywgJycpLnN0cmlwKCkpCiAgICAgICAgICAgIGlmIDEgPD0gbnVtIDw9IDY6CiAgICAgICAgICAgICAgICByZXR1cm4gMTIwIAogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcmV0dXJuIDAKCiAgICByZXR1cm4gMAoKZGVmIHNiX2dldF90aWxlKGNvbW1hbmQpOgogICAgY29tbWFuZCA9IGNvbW1hbmQubG93ZXIoKS5zdHJpcCgpCgogICAgaWYgY29tbWFuZC5zdGFydHN3aXRoKCdzYicpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZWN0ZWQgPSBpbnQoY29tbWFuZC5yZXBsYWNlKCdzYicsICcnKS5zdHJpcCgpKQogICAgICAgICAgICBpZiBzZWxlY3RlZCBpbiBbNCwgMTddOgogICAgICAgICAgICAgICAgcmV0dXJuIDMwCiAgICAgICAgICAgIGVsaWYgc2VsZWN0ZWQgaW4gWzUsIDE2XToKICAgICAgICAgICAgICAgIHJldHVybiAxMwogICAgICAgICAgICBlbGlmIHNlbGVjdGVkIGluIFs2LCAxNV06CiAgICAgICAgICAgICAgICByZXR1cm4gOC4yCiAgICAgICAgICAgIGVsaWYgc2VsZWN0ZWQgaW4gWzcsIDE0XToKICAgICAgICAgICAgICAgIHJldHVybiA1LjgKICAgICAgICAgICAgZWxpZiBzZWxlY3RlZCBpbiBbOCwgMTNdOgogICAgICAgICAgICAgICAgcmV0dXJuIDUuMgogICAgICAgICAgICBlbGlmIHNlbGVjdGVkIGluIFs5LCAxMl06CiAgICAgICAgICAgICAgICByZXR1cm4gNC44CiAgICAgICAgICAgIGVsaWYgc2VsZWN0ZWQgaW4gWzEwLCAxMV06CiAgICAgICAgICAgICAgICByZXR1cm4gNC44CiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4gMAoKICAgIHJldHVybiAwCgpkZWYgZ2V0X2JvbnVzX3N0YXR1c190ZXh0KCk6CiAgICB0cnk6CiAgICAgICAgaHVib251c19wYXRoID0gIkZJTEUvaHVib251cy50eHQiCiAgICAgICAgc2lldWh1Ym9udXNfcGF0aCA9ICJGSUxFL3NpZXVodWJvbnVzLnR4dCIKCiAgICAgICAgZm9yIHBhdGgsIGxhYmVsIGluIFsoaHVib251c19wYXRoLCAi8J+UpSBIxaggQk9OVVMgMTAwLjAwMCDwn5SlIiksIChzaWV1aHVib251c19wYXRoLCAi8J+UpSBIxaggQk9OVVMgMjAwLjAwMCDwn5SlIildOgogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGYucmVhZCgpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBjb250ZW50LnN0YXJ0c3dpdGgoIlRSVUUiKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGYiPGI+e2xhYmVsfTwvYj4iCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBraeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgSMWpIEJvbnVzOiB7ZX0iKQogICAgcmV0dXJuICIiCgpkZWYgc2VuZF9yZXN1bHRfbm90aWZpY2F0aW9ucyhzZXNzaW9uX251bWJlciwgZGljZV92YWx1ZXMsIHRvdGFsX2RpY2UsIHJlc3VsdF90eCwgcmVzdWx0X2NsLCB0b3RhbF9iZXRfd2luLCB0b3RhbF9iZXRfbG9zcyk6CiAgICBhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbiA9IHt9CiAgICBpbXBvcnQgb3MsIHRocmVhZGluZwogICAgZnJvbSB0ZWxlYm90IGltcG9ydCB0eXBlcwogICAgcHJpbnQoZiJbREVCVUddIELhuq90IMSR4bqndSBzZW5kX3Jlc3VsdF9ub3RpZmljYXRpb25zIGNobyBwaGnDqm4gI3tzZXNzaW9uX251bWJlcn0iKQogICAgbWQ1X3BhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnbWQ1LnR4dCcpCiAgICBrZXltZDVfcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdrZXltZDUudHh0JykKICAgIG1kNV9oYXNoX2N1cnJlbnQgPSByZWFkX2ZpbGVfY29udGVudChtZDVfcGF0aCkuc3BsaXQoJyA6ICcpWy0xXS5zdHJpcCgpCiAgICBrZXlfbWQ1X2N1cnJlbnQgPSByZWFkX2ZpbGVfY29udGVudChrZXltZDVfcGF0aCkuc3BsaXQoJyA6ICcpWy0xXS5zdHJpcCgpCiAgICBwcmludChmIltERUJVR10gTUQ1IGhp4buHbiB04bqhaToge21kNV9oYXNoX2N1cnJlbnR9LCBLRVk6IHtrZXlfbWQ1X2N1cnJlbnR9IikKICAgIGtleV9tZDVfbW9pLCBtZDVfaGFzaF9tb2kgPSBnZW5lcmF0ZV9tZDVfc3RyaW5nKHNlc3Npb25fbnVtYmVyICsgMSkKICAgIHByaW50KGYiW0RFQlVHXSBNRDUgbeG7m2kgKGNobyBr4buzICN7c2Vzc2lvbl9udW1iZXIrMX0pOiB7bWQ1X2hhc2hfbW9pfSwgS0VZIG3hu5tpOiB7a2V5X21kNV9tb2l9IikKICAgIGRpc3BsYXlfbGFzdF8xMF90eCA9ICcgJy5qb2luKHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdtYXRwaGllbnR4LnR4dCcpKS5zcGxpdCgpWzo6LTFdWzoxMF0pCiAgICBkaXNwbGF5X2xhc3RfMTBfY2wgPSAnICcuam9pbihyZWFkX2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4oZm9sZGVyLCAnbWF0cGhpZW5jbC50eHQnKSkuc3BsaXQoKVs6Oi0xXVs6MTBdKQogICAgcHJpbnQoZiJbREVCVUddIDEwIFRYIGfhuqduIG5o4bqldDoge2Rpc3BsYXlfbGFzdF8xMF90eH0iKQogICAgcHJpbnQoZiJbREVCVUddIDEwIENMIGfhuqduIG5o4bqldDoge2Rpc3BsYXlfbGFzdF8xMF9jbH0iKQogICAgY29udHJpYnV0aW9uID0gMAogICAgaWYgdG90YWxfYmV0X2xvc3MgPiB0b3RhbF9iZXRfd2luOgogICAgICAgIGVmZmVjdGl2ZV9sb3NzID0gdG90YWxfYmV0X2xvc3MgLSB0b3RhbF9iZXRfd2luCiAgICAgICAgY29udHJpYnV0aW9uID0gaW50KDAuMDUgKiBlZmZlY3RpdmVfbG9zcykKICAgICAgICB1cGRhdGVfaHVfZmlsZShjb250cmlidXRpb24pCiAgICB0cnk6CiAgICAgICAgdXBkYXRlZF9odSA9IGludChmbG9hdChyZWFkX2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4oZm9sZGVyLCAnaHUudHh0JykpKSkKICAgIGV4Y2VwdDoKICAgICAgICB1cGRhdGVkX2h1ID0gMAogICAgcHJpbnQoZiJbREVCVUddIFThu5VuZyBjxrDhu6NjIHRo4bqvbmc6IHt0b3RhbF9iZXRfd2lufSwgdOG7lW5nIGPGsOG7o2MgdGh1YToge3RvdGFsX2JldF9sb3NzfSwgY29udHJpYnV0aW9uOiB7Y29udHJpYnV0aW9ufSIpCiAgICBwcmludChmIltERUJVR10gU+G7kSB0aeG7gW4gdHJvbmcgaMWpIHNhdSBj4bqtcCBuaOG6rXQ6IHt1cGRhdGVkX2h1fSIpCiAgICB0b3RhbF9iZXRfd2luX2Zvcm1hdHRlZCA9IGZvcm1hdF9udW1iZXIodG90YWxfYmV0X3dpbikKICAgIHRvdGFsX2JldF9sb3NzX2Zvcm1hdHRlZCA9IGZvcm1hdF9udW1iZXIodG90YWxfYmV0X2xvc3MpCiAgICB1cGRhdGVkX2h1X2Zvcm1hdHRlZCA9IGZvcm1hdF9udW1iZXIodXBkYXRlZF9odSkKICAgIGNvbnRyaWJ1dGlvbl9mb3JtYXR0ZWQgPSBmb3JtYXRfbnVtYmVyKGNvbnRyaWJ1dGlvbikKICAgIGRpY2VfdmFsdWVzX3N0ciA9ICcgJy5qb2luKG1hcChzdHIsIGRpY2VfdmFsdWVzKSkKICAgIHNwZWNpYWxfbWQ1X2JldHMgPSBnZW5lcmF0ZV90aGFuZ3RodWFfbWQ1X2xpbmVzKHNlc3Npb25fbnVtYmVyKQogICAgdG90YWxfbWQ1X3dpbl92YWwsIHRvdGFsX21kNV9sb3NzX3ZhbCA9IDAsIDAKICAgIGZvciB1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW5fZmxhZywgYW1vdW50LCBtZDVfY29kZSwga2V5X21kNV9jb2RlIGluIHNwZWNpYWxfbWQ1X2JldHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0b3RhbCA9IGludChrZXlfbWQ1X2NvZGUuc3RyaXAoKS5zcGxpdCgnXycpWy0xXSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHRvdGFsID0gdG90YWxfZGljZQogICAgICAgIHdpbl9zdGF0dXMgPSBtZDVfaXNfd2luKGNvbW1hbmQsIHRvdGFsKQogICAgICAgIGlmIHdpbl9zdGF0dXMgaXMgTm9uZToKICAgICAgICAgICAgd2luX3N0YXR1cyA9IGlzX3dpbl9mbGFnCiAgICAgICAgdGhhbmd0aHVhX21kNSh1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCB3aW5fc3RhdHVzLCBhbW91bnQsIG1kNV9jb2RlLCBrZXlfbWQ1X2NvZGUpCiAgICAgICAgaWYgd2luX3N0YXR1czoKICAgICAgICAgICAgdG90YWxfbWQ1X3dpbl92YWwgKz0gYW1vdW50CiAgICAgICAgZWxzZToKICAgICAgICAgICAgdG90YWxfbWQ1X2xvc3NfdmFsICs9IGFtb3VudAogICAgcHJpbnQoZiJbREVCVUddIFThu5VuZyBNRDUgdGjhuq9uZzoge3RvdGFsX21kNV93aW5fdmFsfSwgVOG7lW5nIE1ENSB0aHVhOiB7dG90YWxfbWQ1X2xvc3NfdmFsfSIpCiAgICBkX3Jlc3VsdHMgPSBnZW5lcmF0ZV90aGFuZ3RodWFfZF9saW5lcyhzZXNzaW9uX251bWJlciwgZGljZV92YWx1ZXMpCiAgICB0b3RhbF9kX3dpbiA9IDAKICAgIHRvdGFsX2RfbG9zcyA9IDAKICAgIGZvciB1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW4sIGFtb3VudCwgdGlsZV9tdWx0aXBsaWVyIGluIGRfcmVzdWx0czoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRfbnVtID0gaW50KGNvbW1hbmQubG93ZXIoKS5yZXBsYWNlKCdkJywgJycpKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgZF9udW0gPSAwCiAgICAgICAgbWF0Y2hfY291bnQgPSBkaWNlX3ZhbHVlcy5jb3VudChkX251bSkKICAgICAgICBpZiBtYXRjaF9jb3VudCA9PSAxOgogICAgICAgICAgICB0aWxlX211bHRpcGxpZXIgPSAxLjkKICAgICAgICBlbGlmIG1hdGNoX2NvdW50ID09IDI6CiAgICAgICAgICAgIHRpbGVfbXVsdGlwbGllciA9IDIuOAogICAgICAgIGVsaWYgbWF0Y2hfY291bnQgPT0gMzoKICAgICAgICAgICAgdGlsZV9tdWx0aXBsaWVyID0gMy43CiAgICAgICAgZWxzZToKICAgICAgICAgICAgdGlsZV9tdWx0aXBsaWVyID0gMAogICAgICAgIGlzX3dpbiA9IG1hdGNoX2NvdW50ID4gMAogICAgICAgIHRoYW5ndGh1YV9kKHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGlzX3dpbiwgYW1vdW50LCB0aWxlX211bHRpcGxpZXIpCiAgICAgICAgaWYgaXNfd2luOgogICAgICAgICAgICB0b3RhbF9kX3dpbiArPSBpbnQoYW1vdW50ICogdGlsZV9tdWx0aXBsaWVyKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRvdGFsX2RfbG9zcyArPSBhbW91bnQKICAgIHByaW50KGYiW0RFQlVHXSBU4buVbmcgRCB0aOG6r25nOiB7dG90YWxfZF93aW59LCBU4buVbmcgRCB0aHVhOiB7dG90YWxfZF9sb3NzfSIpCiAgICB4aWVuX3Jlc3VsdHMgPSBnZW5lcmF0ZV90aGFuZ3RodWFfeGllbl9saW5lcyhzZXNzaW9uX251bWJlcikKICAgIHRvdGFsX3hpZW5fd2luID0gMAogICAgdG90YWxfeGllbl9sb3NzID0gMAogICAgZm9yIHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGFtb3VudCBpbiB4aWVuX3Jlc3VsdHM6CiAgICAgICAgaXNfd2luID0geGllbl9pc193aW4oY29tbWFuZCwgZGljZV92YWx1ZXMpCiAgICAgICAgdGlsZV9tdWx0aXBsaWVyID0geGllbl9nZXRfdGlsZShjb21tYW5kKQogICAgICAgIHRoYW5ndGh1YV94aWVuKHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGlzX3dpbiwgYW1vdW50LCB0aWxlX211bHRpcGxpZXIpCiAgICAgICAgaWYgaXNfd2luOgogICAgICAgICAgICB0b3RhbF94aWVuX3dpbiArPSBpbnQoYW1vdW50ICogdGlsZV9tdWx0aXBsaWVyKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRvdGFsX3hpZW5fbG9zcyArPSBhbW91bnQKICAgIHByaW50KGYiW0RFQlVHXSBU4buVbmcgWGnDqm4gdGjhuq9uZzoge3RvdGFsX3hpZW5fd2lufSwgVOG7lW5nIFhpw6puIHRodWE6IHt0b3RhbF94aWVuX2xvc3N9IikKICAgIGJhb19yZXN1bHRzID0gZ2VuZXJhdGVfdGhhbmd0aHVhX2Jhb19saW5lcyhzZXNzaW9uX251bWJlcikKICAgIHRvdGFsX2Jhb193aW4gPSAwCiAgICB0b3RhbF9iYW9fbG9zcyA9IDAKICAgIGZvciB1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBhbW91bnQgaW4gYmFvX3Jlc3VsdHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpc193aW4gPSBiYW9faXNfd2luKGNvbW1hbmQsIGRpY2VfdmFsdWVzKQogICAgICAgICAgICB0aWxlX211bHRpcGxpZXIgPSBiYW9fZ2V0X3RpbGUoY29tbWFuZCkKICAgICAgICAgICAgdGhhbmd0aHVhX2Jhbyh1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW4sIGFtb3VudCwgdGlsZV9tdWx0aXBsaWVyKQogICAgICAgICAgICBpZiBpc193aW46CiAgICAgICAgICAgICAgICB0b3RhbF9iYW9fd2luICs9IGludChhbW91bnQgKiB0aWxlX211bHRpcGxpZXIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0b3RhbF9iYW9fbG9zcyArPSBhbW91bnQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSB44butIGzDvSBCw6NvIC0gdXNlcjoge3VzZXJfaWR9LCBjb21tYW5kOiB7Y29tbWFuZH0sIGFtb3VudDoge2Ftb3VudH0sIGVycm9yOiB7ZX0iKQogICAgcHJpbnQoZiJbREVCVUddIFThu5VuZyBCw6NvIHRo4bqvbmc6IHt0b3RhbF9iYW9fd2lufSwgVOG7lW5nIELDo28gdGh1YToge3RvdGFsX2Jhb19sb3NzfSIpCgogICAgc2JfcmVzdWx0cyA9IGdlbmVyYXRlX3RoYW5ndGh1YV9zYl9saW5lcyhzZXNzaW9uX251bWJlcikKICAgIHRvdGFsX3NiX3dpbiA9IDAKICAgIHRvdGFsX3NiX2xvc3MgPSAwCiAgICBmb3IgdXNlcl9pZCwgc2VzcywgY29tbWFuZCwgYW1vdW50IGluIHNiX3Jlc3VsdHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpc193aW4gPSBzYl9pc193aW4oY29tbWFuZCwgZGljZV92YWx1ZXMpCiAgICAgICAgICAgIHRpbGVfbXVsdGlwbGllciA9IHNiX2dldF90aWxlKGNvbW1hbmQpCiAgICAgICAgICAgIHRoYW5ndGh1YV9zYih1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW4sIGFtb3VudCwgdGlsZV9tdWx0aXBsaWVyKQogICAgICAgICAgICBpZiBpc193aW46CiAgICAgICAgICAgICAgICB0b3RhbF9zYl93aW4gKz0gaW50KGFtb3VudCAqIHRpbGVfbXVsdGlwbGllcikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHRvdGFsX3NiX2xvc3MgKz0gYW1vdW50CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgeOG7rSBsw70gU0IgLSB1c2VyOiB7dXNlcl9pZH0sIGNvbW1hbmQ6IHtjb21tYW5kfSwgYW1vdW50OiB7YW1vdW50fSwgZXJyb3I6IHtlfSIpCiAgICBwcmludChmIltERUJVR10gVOG7lW5nIFNCIHRo4bqvbmc6IHt0b3RhbF9zYl93aW59LCBU4buVbmcgU0IgdGh1YToge3RvdGFsX3NiX2xvc3N9IikKICAgIHBlbmRpbmdfbm9odSA9IE5vbmUKICAgIGlmIGRpY2VfdmFsdWVzID09IFsxLCAxLCAxXToKICAgICAgIHByaW50KCJbREVCVUddIE7hu5QgSMWoIDEgMSAxIikKICAgICAgIHBlbmRpbmdfbm9odSA9ICgnTuG7lCBIxaggMSAxIDEnLCAnMSAxIDEnKQogICAgZWxpZiBkaWNlX3ZhbHVlcyA9PSBbNiwgNiwgNl06CiAgICAgICAgcHJpbnQoIltERUJVR10gTuG7lCBIxaggNiA2IDYiKQogICAgICAgIHBlbmRpbmdfbm9odSA9ICgnTuG7lCBIxaggNiA2IDYnLCAnNiA2IDYnKQogICAgICAgIHNlbmRfbm90aWZpY2F0aW9ucyhhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbiwgc2Vzc2lvbl9udW1iZXIsIHJlc3VsdF90eCwgcmVzdWx0X2NsKQogICAgaWYgcGVuZGluZ19ub2h1OgogICAgICAgZXZlbnRfdGl0bGUsIGRpY2Vfc3RyID0gcGVuZGluZ19ub2h1CiAgICAgICB0aGFuZ3RodWFfbm9odShzZXNzaW9uX251bWJlciwgY29udHJpYnV0aW9uLCBldmVudF90aXRsZSwgZGljZV9zdHIpCiAgICAgICAKICAgIHBlbmRpbmdfbm9odSA9IE5vbmUKICAgIGlmIGRpY2VfdmFsdWVzID09IFsxLCAxLCAxXToKICAgICAgIHByaW50KCJbREVCVUddIE7hu5QgSMWoIDEgMSAxIikKICAgICAgIHBlbmRpbmdfbm9odSA9ICgnTuG7lCBIxaggMSAxIDEnLCAnMSAxIDEnKQogICAgZWxpZiBkaWNlX3ZhbHVlcyA9PSBbNiwgNiwgNl06CiAgICAgICAgcHJpbnQoIltERUJVR10gTuG7lCBIxaggNiA2IDYiKQogICAgICAgIHBlbmRpbmdfbm9odSA9ICgnTuG7lCBIxaggNiA2IDYnLCAnNiA2IDYnKQogICAgICAgIHNlbmRfbm90aWZpY2F0aW9ucyhhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbiwgc2Vzc2lvbl9udW1iZXIsIHJlc3VsdF90eCwgcmVzdWx0X2NsKQogICAgaWYgcGVuZGluZ19ub2h1OgogICAgICAgZXZlbnRfdGl0bGUsIGRpY2Vfc3RyID0gcGVuZGluZ19ub2h1CiAgICAgICB0aGFuZ3RodWFfbm9odWJvbnVzKHNlc3Npb25fbnVtYmVyLCBjb250cmlidXRpb24sIGV2ZW50X3RpdGxlLCBkaWNlX3N0cikKICAgICAgIAogICAgICAgCiAgICBpZiByZXN1bHRfY2wgPT0gJ0No4bq1bic6CiAgICAgICAgdXBkYXRlX2ZpbGVfdmFsdWUob3MucGF0aC5qb2luKGZvbGRlciwgJ2txY2hhbi50eHQnKSwgMSkKICAgICAgICB1cGRhdGVfZmlsZV92YWx1ZShvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3FsZS50eHQnKSwgLTEpCiAgICAgICAgcHJpbnQoIltERUJVR10gQ0wgVXBkYXRlOiBDaOG6tW4gKCsxKSwgTOG6uyAoLTEpIikKICAgIGVsaWYgcmVzdWx0X2NsID09ICdM4bq7JzoKICAgICAgICB1cGRhdGVfZmlsZV92YWx1ZShvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3FsZS50eHQnKSwgMSkKICAgICAgICB1cGRhdGVfZmlsZV92YWx1ZShvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3FjaGFuLnR4dCcpLCAtMSkKICAgICAgICBwcmludCgiW0RFQlVHXSBDTCBVcGRhdGU6IEzhursgKCsxKSwgQ2jhurVuICgtMSkiKQogICAgdHJ5OgogICAgICAgIHZhbF90YWkgPSBpbnQocmVhZF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKGZvbGRlciwgJ2txdGFpLnR4dCcpKSBvciAwKQogICAgICAgIHZhbF94aXUgPSBpbnQocmVhZF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKGZvbGRlciwgJ2txeGl1LnR4dCcpKSBvciAwKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgdmFsX3RhaSA9IHZhbF94aXUgPSAwCiAgICAgICAgcHJpbnQoIltFUlJPUl0gS2jDtG5nIMSR4buNYyDEkcaw4bujYyBmaWxlIFRYIGNvdW50ZXIuIMSQ4bq3dCBt4bq3YyDEkeG7i25oIDAuIikKICAgIHByaW50KGYiW0RFQlVHXSBUWCBDb3VudGVyIEJhbGFuY2UgQ2hlY2s6IFTDoGk9e3ZhbF90YWl9LCBY4buJdT17dmFsX3hpdX0uIEJhbGFuY2VkOiB7dmFsX3RhaSA9PSB2YWxfeGl1fSIpCiAgICBpZiB2YWxfdGFpID09IHZhbF94aXU6CiAgICAgICAgaWYgKHJlc3VsdF90eCA9PSAnVMOgaScgYW5kIHJlc3VsdF9jbCA9PSAnQ2jhurVuJykgb3IgKHJlc3VsdF90eCA9PSAnWOG7iXUnIGFuZCByZXN1bHRfY2wgPT0gJ0zhursnKToKICAgICAgICAgICAgaWYgcmVzdWx0X3R4ID09ICdUw6BpJzoKICAgICAgICAgICAgICAgIHVwZGF0ZV9maWxlX3ZhbHVlKG9zLnBhdGguam9pbihmb2xkZXIsICdrcXRhaS50eHQnKSwgMSkKICAgICAgICAgICAgICAgIHVwZGF0ZV9maWxlX3ZhbHVlKG9zLnBhdGguam9pbihmb2xkZXIsICdrcXhpdS50eHQnKSwgLTEpCiAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBUWCBVcGRhdGU6IFTDoGkgKCsxKSwgWOG7iXUgKC0xKSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1cGRhdGVfZmlsZV92YWx1ZShvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3F4aXUudHh0JyksIDEpCiAgICAgICAgICAgICAgICB1cGRhdGVfZmlsZV92YWx1ZShvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3F0YWkudHh0JyksIC0xKQogICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVFggVXBkYXRlOiBY4buJdSAoKzEpLCBUw6BpICgtMSkiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIFJvbGwgb3V0Y29tZSBraMO0bmcga2jhu5twIMSRaeG7gXUga2nhu4duIHVwZGF0ZSBUWC4gQuG7jyBxdWEuIikKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIltERUJVR10gVFggY291bnRlcnMgY2jGsGEgY8OibiBi4bqxbmcuIEtow7RuZyB1cGRhdGUuIikKICAgIHJlc3VsdHNfbWFwID0gewogICAgICAgICdUw6BpJzogKCd0YWkudHh0JywgJ1TDoGknLCAneGl1LnR4dCcsICdY4buJdScpLAogICAgICAgICdY4buJdSc6ICgneGl1LnR4dCcsICdY4buJdScsICd0YWkudHh0JywgJ1TDoGknKSwKICAgICAgICAnQ2jhurVuJzogKCdjaGFuLnR4dCcsICdDaOG6tW4nLCAnbGUudHh0JywgJ0zhursnKSwKICAgICAgICAnTOG6uyc6ICgnbGUudHh0JywgJ0zhursnLCAnY2hhbi50eHQnLCAnQ2jhurVuJyl9CiAgICB1c2VyX3Jlc3VsdHNfdHhfd2luID0gY2FsY3VsYXRlX3VzZXJfcmVzdWx0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCByZXN1bHRzX21hcFtyZXN1bHRfdHhdWzBdKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNfbWFwW3Jlc3VsdF90eF1bMV0sIHJlc3VsdF90eCwgc2Vzc2lvbl9udW1iZXIpCiAgICB1c2VyX3Jlc3VsdHNfdHhfbG9zcyA9IGNhbGN1bGF0ZV91c2VyX3Jlc3VsdHMob3MucGF0aC5qb2luKGZvbGRlciwgcmVzdWx0c19tYXBbcmVzdWx0X3R4XVsyXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c19tYXBbcmVzdWx0X3R4XVszXSwgcmVzdWx0X3R4LCBzZXNzaW9uX251bWJlcikKICAgIHVzZXJfcmVzdWx0c19jbF93aW4gPSBjYWxjdWxhdGVfdXNlcl9yZXN1bHRzKG9zLnBhdGguam9pbihmb2xkZXIsIHJlc3VsdHNfbWFwW3Jlc3VsdF9jbF1bMF0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c19tYXBbcmVzdWx0X2NsXVsxXSwgcmVzdWx0X2NsLCBzZXNzaW9uX251bWJlcikKICAgIHVzZXJfcmVzdWx0c19jbF9sb3NzID0gY2FsY3VsYXRlX3VzZXJfcmVzdWx0cyhvcy5wYXRoLmpvaW4oZm9sZGVyLCByZXN1bHRzX21hcFtyZXN1bHRfY2xdWzJdKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzX21hcFtyZXN1bHRfY2xdWzNdLCByZXN1bHRfY2wsIHNlc3Npb25fbnVtYmVyKQogICAgcHJpbnQoZiJbREVCVUddIFRYIHdpbiB1c2VycyBjb3VudDoge2xlbih1c2VyX3Jlc3VsdHNfdHhfd2luKX0iKQogICAgcHJpbnQoZiJbREVCVUddIFRYIGxvc3MgdXNlcnMgY291bnQ6IHtsZW4odXNlcl9yZXN1bHRzX3R4X2xvc3MpfSIpCiAgICBwcmludChmIltERUJVR10gQ0wgd2luIHVzZXJzIGNvdW50OiB7bGVuKHVzZXJfcmVzdWx0c19jbF93aW4pfSIpCiAgICBwcmludChmIltERUJVR10gQ0wgbG9zcyB1c2VycyBjb3VudDoge2xlbih1c2VyX3Jlc3VsdHNfY2xfbG9zcyl9IikKICAgIGZvciB1c2VyX2lkLCBkYXRhIGluIHVzZXJfcmVzdWx0c190eF93aW4uaXRlbXMoKToKICAgICAgICBhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbi5zZXRkZWZhdWx0KHVzZXJfaWQsIHsKICAgICAgICAgICAgJ3R4X291dGNvbWUnOiAnd2luJywgJ3R4X2JldCc6IGRhdGFbJ3RvdGFsX2JldCddLCAndHhfd2lubmluZ3MnOiBkYXRhWyd0b3RhbF93aW5uaW5ncyddCiAgICAgICAgfSkKICAgIGZvciB1c2VyX2lkLCBkYXRhIGluIHVzZXJfcmVzdWx0c190eF9sb3NzLml0ZW1zKCk6CiAgICAgICAgYWxsX3VzZXJzX2Zvcl9ub3RpZmljYXRpb24uc2V0ZGVmYXVsdCh1c2VyX2lkLCB7fSkudXBkYXRlKHsKICAgICAgICAgICAgJ3R4X291dGNvbWUnOiAnbG9zcycsICd0eF9iZXQnOiBkYXRhWyd0b3RhbF9iZXQnXSwgJ3R4X3dpbm5pbmdzJzogZGF0YVsndG90YWxfd2lubmluZ3MnXQogICAgICAgIH0pCiAgICBmb3IgdXNlcl9pZCwgZGF0YSBpbiB1c2VyX3Jlc3VsdHNfY2xfd2luLml0ZW1zKCk6CiAgICAgICAgYWxsX3VzZXJzX2Zvcl9ub3RpZmljYXRpb24uc2V0ZGVmYXVsdCh1c2VyX2lkLCB7fSkudXBkYXRlKHsKICAgICAgICAgICAgJ2NsX291dGNvbWUnOiAnd2luJywgJ2NsX2JldCc6IGRhdGFbJ3RvdGFsX2JldCddLCAnY2xfd2lubmluZ3MnOiBkYXRhWyd0b3RhbF93aW5uaW5ncyddCiAgICAgICAgfSkKICAgIGZvciB1c2VyX2lkLCBkYXRhIGluIHVzZXJfcmVzdWx0c19jbF9sb3NzLml0ZW1zKCk6CiAgICAgICAgYWxsX3VzZXJzX2Zvcl9ub3RpZmljYXRpb24uc2V0ZGVmYXVsdCh1c2VyX2lkLCB7fSkudXBkYXRlKHsKICAgICAgICAgICAgJ2NsX291dGNvbWUnOiAnbG9zcycsICdjbF9iZXQnOiBkYXRhWyd0b3RhbF9iZXQnXSwgJ2NsX3dpbm5pbmdzJzogZGF0YVsndG90YWxfd2lubmluZ3MnXQogICAgICAgIH0pCiAgICBpZiBhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbjoKICAgICAgICB0ID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VuZF9ub3RpZmljYXRpb25zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzPShhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbiwgc2Vzc2lvbl9udW1iZXIsIHJlc3VsdF90eCwgcmVzdWx0X2NsKSwgZGFlbW9uPVRydWUpCiAgICAgICAgdC5zdGFydCgpCiAgICAgICAgdC5qb2luKCkKICAgIHdyaXRlX2ZpbGVfY29udGVudChtZDVfcGF0aCwgZiIje3Nlc3Npb25fbnVtYmVyICsgMX0gOiB7bWQ1X2hhc2hfbW9pfSIpCiAgICB3cml0ZV9maWxlX2NvbnRlbnQoa2V5bWQ1X3BhdGgsIGYiI3tzZXNzaW9uX251bWJlciArIDF9IDoge2tleV9tZDVfbW9pfSIpCiAgICBtaW5fY3VvYyA9IDcwMDAgaWYgdXBkYXRlZF9odSA+PSA1MDAwMDAgZWxzZSA1MDAwCiAgICBib251c19saW5lID0gZ2V0X2JvbnVzX3N0YXR1c190ZXh0KCkKICAgIGJvbnVzX3RleHQgPSBmIlxu4pSDIHtib251c19saW5lfSIgaWYgYm9udXNfbGluZS5zdHJpcCgpIGVsc2UgIiIKCiAgICBoZWFkZXIgPSBmIiIiPGI+S+G6vlQgUVXhuqIgS+G7siAje3Nlc3Npb25fbnVtYmVyfTwvYj4K4pSP4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSTCuKUgyA8Yj57ZGljZV92YWx1ZXNfc3RyfSAoe3RvdGFsX2RpY2V9KSAge3Jlc3VsdF90eH0ge3Jlc3VsdF9jbH0geyfwn5S1JyBpZiByZXN1bHRfdHg9PSdUw6BpJyBlbHNlICfwn5S0J30geyfimqrvuI8nIGlmIHJlc3VsdF9jbD09J0No4bq1bicgZWxzZSAn4pqr77iPJ308L2I+CuKUgyIiIgogICAgaWYgKGxlbih1c2VyX3Jlc3VsdHNfdHhfd2luKSArIGxlbih1c2VyX3Jlc3VsdHNfdHhfbG9zcykgPiAwKSBvciAobGVuKHVzZXJfcmVzdWx0c19jbF93aW4pICsgbGVuKHVzZXJfcmVzdWx0c19jbF9sb3NzKSA+IDApOgogICAgICAgIGJvZHkgPSBmIiIiCuKUgyBU4buVbmcgdGjhuq9uZyBUWDogPGI+e3RvdGFsX2JldF93aW5fZm9ybWF0dGVkfTwvYj4K4pSDIFThu5VuZyB0aHVhIFRYOiA8Yj57dG90YWxfYmV0X2xvc3NfZm9ybWF0dGVkfTwvYj4K4pSDIEPhu5luZyB2w6BvIGjFqTogPGI+e2NvbnRyaWJ1dGlvbl9mb3JtYXR0ZWR9PC9iPgrilIMgVOG7lW5nIGjFqSBoaeG7h24gdOG6oWk6IDxiPnt1cGRhdGVkX2h1X2Zvcm1hdHRlZH08L2I+e2JvbnVzX3RleHR9IiIiCiAgICBlbHNlOgogICAgICAgIGJvZHkgPSBmIiIiCuKUgyBU4buVbmcgaMWpIGhp4buHbiB04bqhaTogPGI+e3VwZGF0ZWRfaHVfZm9ybWF0dGVkfTwvYj57Ym9udXNfdGV4dH0iIiIKICAgIGZvb3RlciA9ICIiIgrilJfilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilJsiIiIKICAgIHN0YXRzID0gZiIiIgo8YmxvY2txdW90ZSBleHBhbmRhYmxlPlRo4buRbmcga8OqIGvhur90IHF14bqjIGfhuqduIMSRw6J5CntkaXNwbGF5X2xhc3RfMTBfdHh9CvCflLUgVMOASToge2Zvcm1hdF9udW1iZXIocmVhZF9maWxlX2NvbnRlbnQob3MucGF0aC5qb2luKGZvbGRlciwgJ2txdGFpLnR4dCcpKSBvciAnMCcpfSB8IPCflLQgWOG7iFU6IHtmb3JtYXRfbnVtYmVyKHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdrcXhpdS50eHQnKSkgb3IgJzAnKX0KCntkaXNwbGF5X2xhc3RfMTBfY2x9CuKaqu+4jyBDSOG6tE46IHtmb3JtYXRfbnVtYmVyKHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdrcWNoYW4udHh0JykpIG9yICcwJyl9IHwg4pqr77iPIEzhuro6IHtmb3JtYXRfbnVtYmVyKHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdrcWxlLnR4dCcpKSBvciAnMCcpfQoKPGI+TUQ1OjwvYj4gPGNvZGU+e21kNV9oYXNoX2N1cnJlbnR9PC9jb2RlPgo8Yj5LRVk6PC9iPiA8Y29kZT57a2V5X21kNV9jdXJyZW50fTwvY29kZT4KVOG7lW5nIHRo4bqvbmcgTUQ1OiB7Zm9ybWF0X251bWJlcih0b3RhbF9tZDVfd2luX3ZhbCl9ClThu5VuZyB0aHVhIE1ENToge2Zvcm1hdF9udW1iZXIodG90YWxfbWQ1X2xvc3NfdmFsKX0KCjxiPlhpbiBt4budaSDEkeG6t3QgY8aw4bujYyBjaG8ga+G7syB0dW5nIFhYICN7c2Vzc2lvbl9udW1iZXIgKyAxfTwvYj4KPGJsb2NrcXVvdGU+VkQ6IFQgNTAwMDAgaG/hurdjIEMgMzAwMDA8L2Jsb2NrcXVvdGU+CjxibG9ja3F1b3RlPi0gQm90IHRy4bqjIGzhu51pIG3hu5tpIMSRxrDhu6NjIHTDrW5oIGzDoCBo4bujcCBs4buHCi0gVGnhu4FuIGPGsOG7o2MgdOG7kWkgdGhp4buDdSA8Yj57Zm9ybWF0X251bWJlcihzdHIobWluX2N1b2MpKX08L2I+Ci0gTOG7h2NoIGPhu61hIHThu5FpIMSRYSA8Yj41MDAuMDAwPC9iPjwvYmxvY2txdW90ZT4KPGI+TUQ1Ojxjb2RlPnttZDVfaGFzaF9tb2l9PC9jb2RlPjwvYj4KPGI+LSAxMjBzIGPhu6dhIGvhu7MgWFggI3tzZXNzaW9uX251bWJlciArIDF9IGLhuq90IMSR4bqndTwvYj4KPC9ibG9ja3F1b3RlPgoiIiIKICAgIG1lc3NhZ2VfdGV4dCA9IGhlYWRlciArIGJvZHkgKyBmb290ZXIgKyBzdGF0cwoKICAgIGlmIGJvdCBhbmQgZ3JvdXBfY2hhdF9pZDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1hcmt1cCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICAgICAgbWFya3VwLmFkZCh0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiWmltYmEgW0JvdF0iLCB1cmw9Imh0dHBzOi8vdC5tZS90aW5obGluaGJvdCIpKQogICAgICAgICAgICBtYXJrdXAucm93KAogICAgICAgICAgICAgICAgdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIkzhu4tjaCBz4butIFhYIiwgdXJsPSJodHRwczovL3QubWUva3F4eHRpbmhsaW5oIiksCiAgICAgICAgICAgICAgICB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiTOG7i2NoIHPhu60gTUQ1IiwgdXJsPSJodHRwczovL3QubWUva3FtZDV0aW5obGluaCIpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShncm91cF9jaGF0X2lkLCBtZXNzYWdlX3RleHQsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwsIHJlcGx5X21hcmt1cD1tYXJrdXApCiAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgZ+G7rWkgbWVzc2FnZSBr4bq/dCBxdeG6oyBsw6puIGdyb3VwIHbhu5tpIG1hcmt1cCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgbWVzc2FnZSBsw6puIGdyb3VwOiB7ZX0iKQoKICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbmRfcmVzdWx0X25vdGlmaWNhdGlvbnNfb3RoZXJfYm90LCBhcmdzPShzZXNzaW9uX251bWJlciwgZGljZV92YWx1ZXMsIHRvdGFsX2RpY2UsIHJlc3VsdF90eCwgcmVzdWx0X2NsKSwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbmRfbWQ1X25vdGlmaWNhdGlvbl9vdGhlcl9ncm91cCwgYXJncz0oc2Vzc2lvbl9udW1iZXIsIG1kNV9oYXNoX2N1cnJlbnQsIGtleV9tZDVfY3VycmVudCksIGRhZW1vbj1UcnVlKS5zdGFydCgpCgogICAgcHJpbnQoIltERUJVR10gS+G6v3QgdGjDumMgc2VuZF9yZXN1bHRfbm90aWZpY2F0aW9ucyIpCgpkZWYgc2VuZF9ub3RpZmljYXRpb25zKGFsbF91c2Vyc19mb3Jfbm90aWZpY2F0aW9uLCBzZXNzaW9uX251bWJlciwgYWN0dWFsX3Jlc3VsdF90eCwgYWN0dWFsX3Jlc3VsdF9jbCk6CiAgICBpZiBub3QgYWxsX3VzZXJzX2Zvcl9ub3RpZmljYXRpb246CiAgICAgICAgcHJpbnQoIltERUJVR10gS2jDtG5nIGPDsyBuZ8aw4budaSBkw7luZyBuw6BvIMSR4buDIHRow7RuZyBiw6FvLiIpCiAgICAgICAgcmV0dXJuCgogICAgcHJpbnQoZiJbREVCVUddIELhuq90IMSR4bqndSBn4butaSB0aMO0bmcgYsOhbyBjaG8ge2xlbihhbGxfdXNlcnNfZm9yX25vdGlmaWNhdGlvbil9IG5nxrDhu51pIGTDuW5nLiIpCiAgICBiZXRfdHlwZV9tYXBwaW5nID0gewogICAgICAgICJUw6BpIjogIlQiLAogICAgICAgICJY4buJdSI6ICJYIiwKICAgICAgICAiQ2jhurVuIjogIkMiLAogICAgICAgICJM4bq7IjogIkwiCiAgICB9CgogICAgZm9yIHVzZXJfaWQsIG91dGNvbWVzIGluIGFsbF91c2Vyc19mb3Jfbm90aWZpY2F0aW9uLml0ZW1zKCk6CiAgICAgICAgaWYgJ3R4X291dGNvbWUnIGluIG91dGNvbWVzOgogICAgICAgICAgICB0eF9iZXQgPSBvdXRjb21lc1sndHhfYmV0J10KICAgICAgICAgICAgdHhfd2lubmluZ3MgPSBvdXRjb21lc1sndHhfd2lubmluZ3MnXQoKICAgICAgICAgICAgaWYgb3V0Y29tZXNbJ3R4X291dGNvbWUnXSA9PSAnd2luJzoKICAgICAgICAgICAgICAgIGFtb3VudF90b19hZGRfdHggPSB0eF9iZXQgKyB0eF93aW5uaW5ncwogICAgICAgICAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgYW1vdW50X3RvX2FkZF90eCkKICAgICAgICAgICAgICAgIG5ld19iYWxhbmNlID0gaW50KGdldF92aWNoaW5oKHVzZXJfaWQpKQoKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBmJycnCuKchSBL4buzIHtzZXNzaW9uX251bWJlcn06IFRo4bqvbmcgUm9vbQp7YmV0X3R5cGVfbWFwcGluZ1thY3R1YWxfcmVzdWx0X3R4XX0ge2Zvcm1hdF9udW1iZXIodHhfYmV0KX0KVGnhu4FuIHRo4bqvbmc6IHtmb3JtYXRfbnVtYmVyKGFtb3VudF90b19hZGRfdHgpfQpT4buRIGTGsDoge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0KJycnCiAgICAgICAgICAgICAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCBtZXNzYWdlLnN0cmlwKCksIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgICAgICB1cGRhdGVfZ2FtZV9oaXN0b3J5KHVzZXJfaWQsIGJldF90eXBlX21hcHBpbmdbYWN0dWFsX3Jlc3VsdF90eF0sIHR4X2JldCwgYW1vdW50X3RvX2FkZF90eCkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBTZW50IFRYIHdpbiBub3RpZmljYXRpb24gdG8gdXNlciB7dXNlcl9pZH0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbWVzc2FnZSA9IGYnJycK4p2MIEvhu7Mge3Nlc3Npb25fbnVtYmVyfTogVGh1YSBSb29tIHtmb3JtYXRfbnVtYmVyKHR4X2JldCl9CicnJwogICAgICAgICAgICAgICAgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgbWVzc2FnZS5zdHJpcCgpLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBiZXRfdHlwZV9tYXBwaW5nW2FjdHVhbF9yZXN1bHRfdHhdLCB0eF9iZXQsIDApCiAgICAgICAgICAgICAgICBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgdHhfYmV0KQoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBTZW50IFRYIGxvc3Mgbm90aWZpY2F0aW9uIHRvIHVzZXIge3VzZXJfaWR9IikKCiAgICAgICAgaWYgJ2NsX291dGNvbWUnIGluIG91dGNvbWVzOgogICAgICAgICAgICBjbF9iZXQgPSBvdXRjb21lc1snY2xfYmV0J10KICAgICAgICAgICAgY2xfd2lubmluZ3MgPSBvdXRjb21lc1snY2xfd2lubmluZ3MnXQoKICAgICAgICAgICAgaWYgb3V0Y29tZXNbJ2NsX291dGNvbWUnXSA9PSAnd2luJzoKICAgICAgICAgICAgICAgIGFtb3VudF90b19hZGRfY2wgPSBjbF9iZXQgKyBjbF93aW5uaW5ncwogICAgICAgICAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgYW1vdW50X3RvX2FkZF9jbCkKICAgICAgICAgICAgICAgIG5ld19iYWxhbmNlID0gaW50KGdldF92aWNoaW5oKHVzZXJfaWQpKQoKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBmJycnCuKchSBL4buzIHtzZXNzaW9uX251bWJlcn06IFRo4bqvbmcgUm9vbQp7YmV0X3R5cGVfbWFwcGluZ1thY3R1YWxfcmVzdWx0X2NsXX0ge2Zvcm1hdF9udW1iZXIoY2xfYmV0KX0KVGnhu4FuIHRo4bqvbmc6IHtmb3JtYXRfbnVtYmVyKGFtb3VudF90b19hZGRfY2wpfQpT4buRIGTGsDoge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0KJycnCiAgICAgICAgICAgICAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCBtZXNzYWdlLnN0cmlwKCksIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgICAgICB1cGRhdGVfZ2FtZV9oaXN0b3J5KHVzZXJfaWQsIGJldF90eXBlX21hcHBpbmdbYWN0dWFsX3Jlc3VsdF9jbF0sIGNsX2JldCwgYW1vdW50X3RvX2FkZF9jbCkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBTZW50IENMIHdpbiBub3RpZmljYXRpb24gdG8gdXNlciB7dXNlcl9pZH0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbWVzc2FnZSA9IGYnJycK4p2MIEvhu7Mge3Nlc3Npb25fbnVtYmVyfTogVGh1YSBSb29tIHtmb3JtYXRfbnVtYmVyKGNsX2JldCl9CicnJwogICAgICAgICAgICAgICAgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgbWVzc2FnZS5zdHJpcCgpLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBiZXRfdHlwZV9tYXBwaW5nW2FjdHVhbF9yZXN1bHRfY2xdLCBjbF9iZXQsIDApCiAgICAgICAgICAgICAgICBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgY2xfYmV0KQoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBTZW50IENMIGxvc3Mgbm90aWZpY2F0aW9uIHRvIHVzZXIge3VzZXJfaWR9IikKCiAgICBwcmludChmIltERUJVR10gSG/DoG4gdOG6pXQgZ+G7rWkgdGjDtG5nIGLDoW8gY2hvIHThuqV0IGPhuqMgbmfGsOG7nWkgZMO5bmcuIikKCmRlZiB0aGFuZ3RodWFfbWQ1KHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGlzX3dpbiwgYW1vdW50LCBtZDVfY29kZSwga2V5X21kNV9jb2RlKTogCiAgICBkZWYgZm9ybWF0X251bWJlcihuKToKICAgICAgICByZXR1cm4gIns6LH0iLmZvcm1hdChuKS5yZXBsYWNlKCcsJywgJy4nKQoKICAgIGRlZiByZWFkX3VzZXJfYmFsYW5jZSh1c2VyX2lkKToKICAgICAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdzZC50eHQnKQogICAgICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gdXNlcl9pZF9zdHI6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQocGFydHNbMV0pCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICByZXR1cm4gMAogICAgICAgIHJldHVybiAwCgogICAgZGVmIHVwZGF0ZV91c2VyX2JhbGFuY2UodXNlcl9pZCwgYW1vdW50X3RvX2FkZCk6CiAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnc2QudHh0JykKICAgICAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkKQogICAgICAgIGxpbmVzID0gW10KICAgICAgICB1cGRhdGVkID0gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgbGluZXMgPSBbXQoKICAgICAgICBuZXdfbGluZXMgPSBbXQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gdXNlcl9pZF9zdHI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9iYWxhbmNlID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IDAKICAgICAgICAgICAgICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlICsgYW1vdW50X3RvX2FkZAogICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChmInt1c2VyX2lkX3N0cn0ge25ld19iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGxpbmUpCgogICAgICAgIGlmIG5vdCB1cGRhdGVkOgogICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGYie3VzZXJfaWRfc3RyfSB7YW1vdW50X3RvX2FkZH1cbiIpCgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X2xpbmVzKQogICAgICAgICAgICBwcmludChmIltERUJVR10g4pyFIEPhuq1wIG5o4bqtdCBz4buRIGTGsCB1c2VyIHt1c2VyX2lkX3N0cn06IHsnKycgaWYgYW1vdW50X3RvX2FkZCA+PSAwIGVsc2UgJyd9e2Ftb3VudF90b19hZGR9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSDinYwgR2hpIGZpbGUgc+G7kSBkxrAgdXNlciBs4buXaToge2V9IikKCiAgICBkZWYgY2FsY3VsYXRlX3dpbl9hbW91bnQoYmV0X2Ftb3VudCk6CiAgICAgICAgcGF5b3V0X3JhdGUgPSAxLjk1CiAgICAgICAgcmV0dXJuIGludChiZXRfYW1vdW50ICogcGF5b3V0X3JhdGUpCgogICAgdHJ5OgogICAgICAgIG1kNV92YWx1ZSA9IHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdtZDUudHh0JykpLnN0cmlwKCkuc3BsaXQoJzonKVstMV0uc3RyaXAoKQogICAgICAgIGtleV92YWx1ZSA9IHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdrZXltZDUudHh0JykpLnN0cmlwKCkuc3BsaXQoJzonKVstMV0uc3RyaXAoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIG1kNV92YWx1ZSA9ICJOL0EiCiAgICAgICAga2V5X3ZhbHVlID0gIk4vQSIKICAgICAgICBwcmludChmIltFUlJPUl0g4p2MIEtow7RuZyDEkeG7jWMgxJHGsOG7o2MgTUQ1IGhv4bq3YyBLRVk6IHtlfSIpCgogICAgY29tbWFuZF91cHBlciA9IGNvbW1hbmQudXBwZXIoKQogICAgYW1vdW50X3N0ciA9IGZvcm1hdF9udW1iZXIoYW1vdW50KQogICAgcmVzdWx0X3RleHQgPSAiIgogICAgYmFsYW5jZSA9IDAKCiAgICBpZiBpc193aW46CiAgICAgICAgd2luX2Ftb3VudF92YWwgPSBjYWxjdWxhdGVfd2luX2Ftb3VudChhbW91bnQpCiAgICAgICAgdXBkYXRlX3VzZXJfYmFsYW5jZSh1c2VyX2lkLCB3aW5fYW1vdW50X3ZhbCkKICAgICAgICBiYWxhbmNlID0gcmVhZF91c2VyX2JhbGFuY2UodXNlcl9pZCkKICAgICAgICByZXN1bHRfdGV4dCA9ICgKICAgICAgICAgICAgZiJL4buzIE1ENToge3Nlc3N9XG4iCiAgICAgICAgICAgIGYiTuG7mWkgZHVuZzogPGI+e2NvbW1hbmRfdXBwZXJ9IHthbW91bnR9PC9iPlxuIgogICAgICAgICAgICBmIlRy4bqhbmcgdGjDoWk6IOKchSBUaOG6r25nIHgxLjk1XG4iCiAgICAgICAgICAgIGYiVGnhu4FuIHRo4bqvbmc6IHtmb3JtYXRfbnVtYmVyKHdpbl9hbW91bnRfdmFsKX1cbiIKICAgICAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdF9udW1iZXIoYmFsYW5jZSl9XG4iCiAgICAgICAgICAgIGYiTUQ1OiA8Y29kZT57bWQ1X3ZhbHVlfTwvY29kZT5cbiIKICAgICAgICAgICAgZiJLRVk6IDxjb2RlPntrZXlfdmFsdWV9PC9jb2RlPiIKICAgICAgICApCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBjb21tYW5kX3VwcGVyLCBhbW91bnQsIHdpbl9hbW91bnRfdmFsKQogICAgZWxzZToKICAgICAgICBiYWxhbmNlID0gcmVhZF91c2VyX2JhbGFuY2UodXNlcl9pZCkKICAgICAgICByZXN1bHRfdGV4dCA9ICgKICAgICAgICAgICAgZiJL4buzIE1ENToge3Nlc3N9XG4iCiAgICAgICAgICAgIGYiTuG7mWkgZHVuZzogPGI+e2NvbW1hbmRfdXBwZXJ9IHthbW91bnR9PC9iPlxuIgogICAgICAgICAgICBmIlRy4bqhbmcgdGjDoWk6IOKdjCBUaHVhXG4iCiAgICAgICAgICAgIGYiU+G7kSBkxrA6IHtmb3JtYXRfbnVtYmVyKGJhbGFuY2UpfVxuIgogICAgICAgICAgICBmIk1ENTogPGNvZGU+e21kNV92YWx1ZX08L2NvZGU+XG4iCiAgICAgICAgICAgIGYiS0VZOiA8Y29kZT57a2V5X3ZhbHVlfTwvY29kZT4iCiAgICAgICAgKQogICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgY29tbWFuZF91cHBlciwgYW1vdW50LCAwKQogICAgICAgIGNvbmdfaG9hX2hvbmdfdGh1YSh1c2VyX2lkLCBhbW91bnQpCiAgICBwcmludChmIltERUJVR10g8J+TpCBUaW4gbmjhuq9uIHPhur0gZ+G7rWkgxJHhur9uIHVzZXIge3VzZXJfaWR9Olxue3Jlc3VsdF90ZXh0fSIpCiAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCByZXN1bHRfdGV4dCkKCmRlZiB0aGFuZ3RodWFfZCh1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW4sIGFtb3VudCwgdGlsZV9tdWx0aXBsaWVyKToKICAgIGRlZiBmb3JtYXRfbnVtYmVyKG4pOgogICAgICAgIHJldHVybiAiezosfSIuZm9ybWF0KG4pLnJlcGxhY2UoJywnLCAnLicpCgogICAgZGVmIHJlYWRfdXNlcl9iYWxhbmNlKHVzZXJfaWQpOgogICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ3NkLnR4dCcpCiAgICAgICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgcmV0dXJuIDAKCiAgICBkZWYgdXBkYXRlX3VzZXJfYmFsYW5jZSh1c2VyX2lkLCBhbW91bnRfdG9fYWRkKToKICAgICAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdzZC50eHQnKQogICAgICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWQpCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIHVwZGF0ZWQgPSBGYWxzZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBsaW5lcyA9IFtdCgogICAgICAgIG5ld19saW5lcyA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9iYWxhbmNlID0gMAogICAgICAgICAgICAgICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgKyBhbW91bnRfdG9fYWRkCiAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGYie3VzZXJfaWRfc3RyfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgdXBkYXRlZCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQobGluZSkKCiAgICAgICAgaWYgbm90IHVwZGF0ZWQ6CiAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZF9zdHJ9IHthbW91bnRfdG9fYWRkfVxuIikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyhuZXdfbGluZXMpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDinIUgQ+G6rXAgbmjhuq10IHPhu5EgZMawIHVzZXIge3VzZXJfaWRfc3RyfTogeycrJyBpZiBhbW91bnRfdG9fYWRkID49IDAgZWxzZSAnJ317YW1vdW50X3RvX2FkZH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbRVJST1JdIOKdjCBHaGkgZmlsZSBz4buRIGTGsCB1c2VyIGzhu5dpOiB7ZX0iKQoKICAgIGNvbW1hbmRfdXBwZXIgPSBjb21tYW5kLnVwcGVyKCkKICAgIGFtb3VudF9zdHIgPSBmb3JtYXRfbnVtYmVyKGFtb3VudCkKICAgIGJhbGFuY2UgPSAwCiAgICB3aW5fYW1vdW50ID0gMAogICAgCiAgICBpZiBpc193aW46CiAgICAgICAgd2luX2Ftb3VudCA9IGludChhbW91bnQgKiB0aWxlX211bHRpcGxpZXIpCiAgICAgICAgdXBkYXRlX3VzZXJfYmFsYW5jZSh1c2VyX2lkLCB3aW5fYW1vdW50KQogICAgICAgIGJhbGFuY2UgPSByZWFkX3VzZXJfYmFsYW5jZSh1c2VyX2lkKQogICAgICAgIHJlc3VsdF90ZXh0ID0gKAogICAgICAgICAgICBmIuKchSBL4buzIHtzZXNzfTogVGjhuq9uZyBs4buHbmgge2NvbW1hbmRfdXBwZXJ9XG4iCiAgICAgICAgICAgIGYie2NvbW1hbmRfdXBwZXJ9IHthbW91bnRfc3RyfSB4IHt0aWxlX211bHRpcGxpZXJ9IDoge2Zvcm1hdF9udW1iZXIod2luX2Ftb3VudCl9XG4iCiAgICAgICAgICAgIGYiU+G7kSBkxrA6IHtmb3JtYXRfbnVtYmVyKGJhbGFuY2UpfSIKICAgICAgICApCiAgICBlbHNlOgogICAgICAgIGJhbGFuY2UgPSByZWFkX3VzZXJfYmFsYW5jZSh1c2VyX2lkKQogICAgICAgIHJlc3VsdF90ZXh0ID0gKAogICAgICAgICAgICBmIuKdjCBL4buzIHtzZXNzfTogVGh1YSBs4buHbmgge2NvbW1hbmRfdXBwZXJ9IHthbW91bnRfc3RyfSIKICAgICAgICApCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBjb21tYW5kX3VwcGVyLCBhbW91bnQsIHdpbl9hbW91bnQpCgogICAgICAgIGNvbmdfaG9hX2hvbmdfdGh1YSh1c2VyX2lkLCBhbW91bnQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIOKchSBD4buZbmcgaG9hIGjhu5NuZyBjaG8gdXNlciB7dXNlcl9pZH0gdsOsIHRodWEgY8aw4bujYyBEIikKCiAgICBwcmludChmIltERUJVR10g8J+TpCBUaW4gbmjhuq9uIGfhu61pIHVzZXIge3VzZXJfaWR9Olxue3Jlc3VsdF90ZXh0fSIpCiAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCByZXN1bHRfdGV4dCkKCmRlZiB0aGFuZ3RodWFfeGllbih1c2VyX2lkLCBzZXNzLCBjb21tYW5kLCBpc193aW4sIGFtb3VudCwgdGlsZV9tdWx0aXBsaWVyKToKICAgIGRlZiBmb3JtYXRfbnVtYmVyKG4pOgogICAgICAgIHJldHVybiAiezosfSIuZm9ybWF0KG4pLnJlcGxhY2UoJywnLCAnLicpCgogICAgZGVmIHJlYWRfdXNlcl9iYWxhbmNlKHVzZXJfaWQpOgogICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ3NkLnR4dCcpCiAgICAgICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgcmV0dXJuIDAKCiAgICBkZWYgdXBkYXRlX3VzZXJfYmFsYW5jZSh1c2VyX2lkLCBhbW91bnRfdG9fYWRkKToKICAgICAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsICdzZC50eHQnKQogICAgICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWQpCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIHVwZGF0ZWQgPSBGYWxzZQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBsaW5lcyA9IFtdCgogICAgICAgIG5ld19saW5lcyA9IFtdCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9iYWxhbmNlID0gMAogICAgICAgICAgICAgICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgKyBhbW91bnRfdG9fYWRkCiAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGYie3VzZXJfaWRfc3RyfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgdXBkYXRlZCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQobGluZSkKCiAgICAgICAgaWYgbm90IHVwZGF0ZWQ6CiAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZF9zdHJ9IHthbW91bnRfdG9fYWRkfVxuIikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyhuZXdfbGluZXMpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDinIUgQ+G6rXAgbmjhuq10IHPhu5EgZMawIHVzZXIge3VzZXJfaWRfc3RyfTogeycrJyBpZiBhbW91bnRfdG9fYWRkID49IDAgZWxzZSAnJ317YW1vdW50X3RvX2FkZH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbRVJST1JdIOKdjCBHaGkgZmlsZSBz4buRIGTGsCB1c2VyIGzhu5dpOiB7ZX0iKQoKICAgIGNvbW1hbmRfdXBwZXIgPSBjb21tYW5kLnVwcGVyKCkKICAgIGFtb3VudF9zdHIgPSBmb3JtYXRfbnVtYmVyKGFtb3VudCkKICAgIGJhbGFuY2UgPSAwCgogICAgaWYgaXNfd2luOgogICAgICAgIHdpbl9hbW91bnQgPSBpbnQoYW1vdW50ICogdGlsZV9tdWx0aXBsaWVyKQogICAgICAgIHVwZGF0ZV91c2VyX2JhbGFuY2UodXNlcl9pZCwgd2luX2Ftb3VudCkKICAgICAgICBiYWxhbmNlID0gcmVhZF91c2VyX2JhbGFuY2UodXNlcl9pZCkKICAgICAgICByZXN1bHRfdGV4dCA9ICgKICAgICAgICAgICAgZiLinIUgS+G7syBYWDoge3Nlc3N9IFRo4bqvbmcgbOG7h25oIFhpw6puXG4iCiAgICAgICAgICAgIGYie2NvbW1hbmRfdXBwZXJ9IHthbW91bnRfc3RyfSB4IHt0aWxlX211bHRpcGxpZXJ9IDoge2Zvcm1hdF9udW1iZXIod2luX2Ftb3VudCl9XG4iCiAgICAgICAgICAgIGYiU+G7kSBkxrA6IHtmb3JtYXRfbnVtYmVyKGJhbGFuY2UpfSIKICAgICAgICApCiAgICBlbHNlOgogICAgICAgIGJhbGFuY2UgPSByZWFkX3VzZXJfYmFsYW5jZSh1c2VyX2lkKQogICAgICAgIHJlc3VsdF90ZXh0ID0gKAogICAgICAgICAgICBmIuKdjCBL4buzIFhYOiB7c2Vzc30gVGh1YSBs4buHbmggWGnDqm5cbiIKICAgICAgICAgICAgZiJ7Y29tbWFuZF91cHBlcn0ge2Ftb3VudF9zdHJ9IgogICAgICAgICkKCiAgICBwcmludChmIltERUJVR10g8J+TpCBUaW4gbmjhuq9uIGfhu61pIHVzZXIge3VzZXJfaWR9Olxue3Jlc3VsdF90ZXh0fSIpCiAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCByZXN1bHRfdGV4dCkKCmRlZiB0aGFuZ3RodWFfYmFvKHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGlzX3dpbiwgYW1vdW50LCB0aWxlX211bHRpcGxpZXIpOgogICAgZGVmIGZvcm1hdF9udW1iZXIobik6CiAgICAgICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQobikucmVwbGFjZSgnLCcsICcuJykKCiAgICBkZWYgcmVhZF91c2VyX2JhbGFuY2UodXNlcl9pZCk6CiAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnc2QudHh0JykKICAgICAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkKQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KHBhcnRzWzFdKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiB1cGRhdGVfdXNlcl9iYWxhbmNlKHVzZXJfaWQsIGFtb3VudF90b19hZGQpOgogICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ3NkLnR4dCcpCiAgICAgICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgICAgICBsaW5lcyA9IFtdCiAgICAgICAgdXBkYXRlZCA9IEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIGxpbmVzID0gW10KCiAgICAgICAgbmV3X2xpbmVzID0gW10KICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSAwCiAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19hZGQKICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZF9zdHJ9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChsaW5lKQoKICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChmInt1c2VyX2lkX3N0cn0ge2Ftb3VudF90b19hZGR9XG4iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKG5ld19saW5lcykKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIOKchSBD4bqtcCBuaOG6rXQgc+G7kSBkxrAgdXNlciB7dXNlcl9pZF9zdHJ9OiB7JysnIGlmIGFtb3VudF90b19hZGQgPj0gMCBlbHNlICcnfXthbW91bnRfdG9fYWRkfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0g4p2MIEdoaSBmaWxlIHPhu5EgZMawIHVzZXIgbOG7l2k6IHtlfSIpCgogICAgYW1vdW50X3N0ciA9IGZvcm1hdF9udW1iZXIoYW1vdW50KQogICAgYmFsYW5jZSA9IDAKICAgIGNvbW1hbmRfdXBwZXIgPSBjb21tYW5kLnVwcGVyKCkucmVwbGFjZSgiQkFPIiwgIiIpLnN0cmlwKCkKCiAgICBpZiBpc193aW46CiAgICAgICAgd2luX2Ftb3VudCA9IGludChhbW91bnQgKiB0aWxlX211bHRpcGxpZXIpCiAgICAgICAgdXBkYXRlX3VzZXJfYmFsYW5jZSh1c2VyX2lkLCB3aW5fYW1vdW50KQogICAgICAgIGJhbGFuY2UgPSByZWFkX3VzZXJfYmFsYW5jZSh1c2VyX2lkKQoKICAgICAgICBpZiBjb21tYW5kX3VwcGVyID09ICJBTEwiOgogICAgICAgICAgICByZXN1bHRfdGV4dCA9ICgKICAgICAgICAgICAgICAgIGYi4pyFIEvhu7MgWFg6IHtzZXNzfSBUaOG6r25nIGzhu4duaCBCw6NvIEFMTCB7YW1vdW50X3N0cn0geCB7dGlsZV9tdWx0aXBsaWVyfSA6IHtmb3JtYXRfbnVtYmVyKHdpbl9hbW91bnQpfVxuIgogICAgICAgICAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdF9udW1iZXIoYmFsYW5jZSl9IgogICAgICAgICAgICApCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmVzdWx0X3RleHQgPSAoCiAgICAgICAgICAgICAgICBmIuKchSBL4buzIFhYOiB7c2Vzc30gVGjhuq9uZyBs4buHbmggQsOjbyB7Y29tbWFuZF91cHBlcn0geCB7YW1vdW50X3N0cn0geCB7dGlsZV9tdWx0aXBsaWVyfSA6IHtmb3JtYXRfbnVtYmVyKHdpbl9hbW91bnQpfVxuIgogICAgICAgICAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdF9udW1iZXIoYmFsYW5jZSl9IgogICAgICAgICAgICApCiAgICBlbHNlOgogICAgICAgIGlmIGNvbW1hbmRfdXBwZXIgPT0gIkFMTCI6CiAgICAgICAgICAgIHJlc3VsdF90ZXh0ID0gZiLinYwgS+G7syBYWDoge3Nlc3N9IFRodWEgbOG7h25oIELDo28gQUxMIHthbW91bnRfc3RyfSIKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXN1bHRfdGV4dCA9IGYi4p2MIEvhu7MgWFg6IHtzZXNzfSBUaHVhIGzhu4duaCBCw6NvIHtjb21tYW5kX3VwcGVyfSB7YW1vdW50X3N0cn0iCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBjb21tYW5kX3VwcGVyLCBhbW91bnQsIHdpbl9hbW91bnQpCiAgICAgICAgY29uZ19ob2FfaG9uZ190aHVhKHVzZXJfaWQsIGFtb3VudCkKICAgICAgICBwcmludChmIltERUJVR10g4pyFIEPhu5luZyBob2EgaOG7k25nIGNobyB1c2VyIHt1c2VyX2lkfSB2w6wgdGh1YSBjxrDhu6NjIELDo28iKQogICAgcHJpbnQoZiJbREVCVUddIPCfk6QgVGluIG5o4bqvbiBn4butaSB1c2VyIHt1c2VyX2lkfTpcbntyZXN1bHRfdGV4dH0iKQogICAgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgcmVzdWx0X3RleHQpCgpkZWYgdGhhbmd0aHVhX3NiKHVzZXJfaWQsIHNlc3MsIGNvbW1hbmQsIGlzX3dpbiwgYW1vdW50LCB0aWxlX211bHRpcGxpZXIpOgogICAgZGVmIGZvcm1hdF9udW1iZXIobik6CiAgICAgICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQobikucmVwbGFjZSgnLCcsICcuJykKCiAgICBkZWYgcmVhZF91c2VyX2JhbGFuY2UodXNlcl9pZCk6CiAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnc2QudHh0JykKICAgICAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkKQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KHBhcnRzWzFdKQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiB1cGRhdGVfdXNlcl9iYWxhbmNlKHVzZXJfaWQsIGFtb3VudF90b19hZGQpOgogICAgICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ3NkLnR4dCcpCiAgICAgICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgICAgICBsaW5lcyA9IFtdCiAgICAgICAgdXBkYXRlZCA9IEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIGxpbmVzID0gW10KCiAgICAgICAgbmV3X2xpbmVzID0gW10KICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSAwCiAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19hZGQKICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZF9zdHJ9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChsaW5lKQoKICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChmInt1c2VyX2lkX3N0cn0ge2Ftb3VudF90b19hZGR9XG4iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKG5ld19saW5lcykKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIOKchSBD4bqtcCBuaOG6rXQgc+G7kSBkxrAgdXNlciB7dXNlcl9pZF9zdHJ9OiB7JysnIGlmIGFtb3VudF90b19hZGQgPj0gMCBlbHNlICcnfXthbW91bnRfdG9fYWRkfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0g4p2MIEdoaSBmaWxlIHPhu5EgZMawIHVzZXIgbOG7l2k6IHtlfSIpCgogICAgYW1vdW50X3N0ciA9IGZvcm1hdF9udW1iZXIoYW1vdW50KQogICAgY29tbWFuZF91cHBlciA9IGYiU0Ige2NvbW1hbmQudXBwZXIoKX0iCiAgICB3aW5fYW1vdW50ID0gaW50KGFtb3VudCAqIHRpbGVfbXVsdGlwbGllcikgaWYgaXNfd2luIGVsc2UgMAoKICAgIGlmIGlzX3dpbjoKICAgICAgICB1cGRhdGVfdXNlcl9iYWxhbmNlKHVzZXJfaWQsIHdpbl9hbW91bnQpCiAgICAgICAgYmFsYW5jZSA9IHJlYWRfdXNlcl9iYWxhbmNlKHVzZXJfaWQpCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBjb21tYW5kX3VwcGVyLCBhbW91bnQsIHdpbl9hbW91bnQpCiAgICAgICAgY29uZ19ob2FfaG9uZ190aGFuZyh1c2VyX2lkLCBhbW91bnQsIHdpbl9hbW91bnQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIOKchSBD4buZbmcgaG9hIGjhu5NuZyBjaG8gdXNlciB7dXNlcl9pZH0gdsOsIHRo4bqvbmcgY8aw4bujYyBTQiIpCgogICAgICAgIHJlc3VsdF90ZXh0ID0gKAogICAgICAgICAgICBmIuKchSBL4buzIHtzZXNzfTogVGjhuq9uZyBs4buHbmhcbiIKICAgICAgICAgICAgZiJ7Y29tbWFuZF91cHBlcn0ge2Ftb3VudF9zdHJ9IHgge3RpbGVfbXVsdGlwbGllcn0gPSB7Zm9ybWF0X251bWJlcih3aW5fYW1vdW50KX1cbiIKICAgICAgICAgICAgZiJT4buRIGTGsDoge2Zvcm1hdF9udW1iZXIoYmFsYW5jZSl9IgogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgYmFsYW5jZSA9IHJlYWRfdXNlcl9iYWxhbmNlKHVzZXJfaWQpCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBjb21tYW5kX3VwcGVyLCBhbW91bnQsIHdpbl9hbW91bnQpCiAgICAgICAgY29uZ19ob2FfaG9uZ190aHVhKHVzZXJfaWQsIGFtb3VudCkKICAgICAgICBwcmludChmIltERUJVR10g4pyFIEPhu5luZyBob2EgaOG7k25nIGNobyB1c2VyIHt1c2VyX2lkfSB2w6wgdGh1YSBjxrDhu6NjIFNCIikKCiAgICAgICAgcmVzdWx0X3RleHQgPSBmIuKdjCBL4buzIHtzZXNzfTogVGh1YSBs4buHbmgge2NvbW1hbmRfdXBwZXJ9IHthbW91bnRfc3RyfSIKCiAgICBwcmludChmIltERUJVR10g8J+TpCBUaW4gbmjhuq9uIGfhu61pIHVzZXIge3VzZXJfaWR9Olxue3Jlc3VsdF90ZXh0fSIpCiAgICBzZW5kX21lc3NhZ2VfdG9fdXNlcih1c2VyX2lkLCByZXN1bHRfdGV4dCkKCmRlZiB0aGFuZ3RodWFfbm9odShzZXNzaW9uX251bWJlciwgaHVfdG90YWwsIGV2ZW50X3RpdGxlLCBkaWNlX2Rlc2NyaXB0aW9uKToKICAgIHRvdGFsX2h1X2Ftb3VudF9zdHIgPSByZWFkX2ZpbGVfY29udGVudChvcy5wYXRoLmpvaW4oZm9sZGVyLCAnaHUudHh0JykpCiAgICB0b3RhbF9odV9hbW91bnQgPSBpbnQoZmxvYXQodG90YWxfaHVfYW1vdW50X3N0cikpIGlmIHRvdGFsX2h1X2Ftb3VudF9zdHIgZWxzZSAwCgogICAgY29udHJpYnV0aW9ucyA9IHt9CiAgICB0b3RhbF9iZXRfYW1vdW50ID0gMAogICAgaWYgZGljZV9kZXNjcmlwdGlvbiA9PSAiNiA2IDYiOgogICAgICAgIGZpbGVzX3RvX2NoZWNrID0gW29zLnBhdGguam9pbihmb2xkZXIsICJ0YWkudHh0IiksIG9zLnBhdGguam9pbihmb2xkZXIsICJjaGFuLnR4dCIpXQogICAgZWxpZiBkaWNlX2Rlc2NyaXB0aW9uID09ICIxIDEgMSI6CiAgICAgICAgZmlsZXNfdG9fY2hlY2sgPSBbb3MucGF0aC5qb2luKGZvbGRlciwgInhpdS50eHQiKSwgb3MucGF0aC5qb2luKGZvbGRlciwgImxlLnR4dCIpXQogICAgZWxzZToKICAgICAgICByZXR1cm4gIAogICAgZm9yIGZpbGVfcGF0aCBpbiBmaWxlc190b19jaGVjazoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIHBhcnRzIGFuZCBwYXJ0c1swXSA9PSBmIiN7c2Vzc2lvbl9udW1iZXJ9IjoKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IHBhcnRzWzFdCiAgICAgICAgICAgICAgICAgICAgICAgIGJldF9hbW91bnQgPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyaWJ1dGlvbnNbdXNlcl9pZF0gPSBjb250cmlidXRpb25zLmdldCh1c2VyX2lkLCAwKSArIGJldF9hbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxfYmV0X2Ftb3VudCArPSBiZXRfYW1vdW50CiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBjb250aW51ZQoKICAgIG51bWJlcl9vZl91c2VycyA9IGxlbihjb250cmlidXRpb25zKQoKICAgIGlmIGNvbnRyaWJ1dGlvbnMgYW5kIHRvdGFsX2JldF9hbW91bnQgPiAwOgogICAgICAgIHVzZXJfcmV3YXJkcyA9IFtdCgogICAgICAgIGZvciB1c2VyX2lkLCBjb250cmlidXRpb24gaW4gY29udHJpYnV0aW9ucy5pdGVtcygpOgogICAgICAgICAgICByZXdhcmRfcmF0aW8gPSBjb250cmlidXRpb24gLyB0b3RhbF9iZXRfYW1vdW50CiAgICAgICAgICAgIHJld2FyZCA9IHRvdGFsX2h1X2Ftb3VudCAqIHJld2FyZF9yYXRpbwoKICAgICAgICAgICAgY3VycmVudF9iYWxhbmNlID0gZmxvYXQoZ2V0X2JhbGFuY2UodXNlcl9pZCkpCiAgICAgICAgICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlICsgcmV3YXJkCiAgICAgICAgICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWxhbmNlKQoKICAgICAgICAgICAgdXNlcl9yZXdhcmRzLmFwcGVuZCgoCiAgICAgICAgICAgICAgICBoaWRlX3VzZXJfaWQodXNlcl9pZCksCiAgICAgICAgICAgICAgICBmb3JtYXRfYmFsYW5jZShjb250cmlidXRpb24pLAogICAgICAgICAgICAgICAgZm9ybWF0X2JhbGFuY2UocmV3YXJkKQogICAgICAgICAgICApKQoKICAgICAgICAgICAgc2VuZF91c2VyKAogICAgICAgICAgICAgICAgdXNlcl9pZCwKICAgICAgICAgICAgICAgIGYi4pyFIENow7pjIG3hu6tuZyBi4bqhbiDEkcOjIG5o4bqtbiDEkcaw4bujYyB0aeG7gW4gbuG7lSBoxakg8J+UpToge2Zvcm1hdF9iYWxhbmNlKHJld2FyZCl9XG4iCiAgICAgICAgICAgICAgICBmIlPhu5EgZMawOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgICAgICkKCiAgICAgICAgcmV3YXJkX2xpbmVzID0gIlxuIi5qb2luKAogICAgICAgICAgICBmIntoaWR9IHwge2NvbnRyaWJ9IHwge3Jld2FyZH0iIGZvciBoaWQsIGNvbnRyaWIsIHJld2FyZCBpbiB1c2VyX3Jld2FyZHMKICAgICAgICApCgogICAgICAgIG1lc3NhZ2UgPSAoCiAgICAgICAgICAgIGYi8J+npyB7ZXZlbnRfdGl0bGV9IPCfp6dcbiIKICAgICAgICAgICAgZiJT4buRIHRp4buBbiBu4buVIGjFqToge2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2h1X2Ftb3VudCl9XG4iCiAgICAgICAgICAgIGYiVOG7lW5nIGfDs3AgaMWpIHbDoCBjxrDhu6NjIHRyb25nIGvhu7MgY+G7p2Ege251bWJlcl9vZl91c2Vyc30gbmfGsOG7nWkgbMOgOiB7Zm9ybWF0X2JhbGFuY2UodG90YWxfYmV0X2Ftb3VudCl9XG4iCiAgICAgICAgICAgIGYiTeG7l2kgbmfGsOG7nWkgbmjhuq1uIMSRxrDhu6NjIHRp4buBbiB0aMaw4bufbmcgdOG7tyBs4buHIHbhu5tpIHPhu5EgdGnhu4FuIGfDs3AgaMWpIHbDoCBjxrDhu6NjIHRyb25nIGvhu7NcblxuIgogICAgICAgICAgICBmIklEIHwgR8OzcCBIxakgLSBDxrDhu6NjIHwgTmjhuq1uIMSRxrDhu6NjXG4iCiAgICAgICAgICAgIGYie3Jld2FyZF9saW5lc31cblxuIgogICAgICAgICAgICBmIlRJ4buATiBIxaggVFLhu54gVuG7gCAwIgogICAgICAgICkKCiAgICAgICAgcmVzZXRfaHVfZmlsZSgpCiAgICAgICAgcmVzZXRfZ29waHVfZmlsZSgpCgogICAgICAgIHNlbnRfbWVzc2FnZSA9IGJvdC5zZW5kX21lc3NhZ2UoZ3JvdXBfY2hhdF9pZCwgbWVzc2FnZSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICBpZiBudW1iZXJfb2ZfdXNlcnMgPiAwOgogICAgICAgICAgICBib3QucGluX2NoYXRfbWVzc2FnZShncm91cF9jaGF0X2lkLCBzZW50X21lc3NhZ2UubWVzc2FnZV9pZCkKICAgIGVsc2U6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgZ3JvdXBfY2hhdF9pZCwKICAgICAgICAgICAgZiJ7ZXZlbnRfdGl0bGV9XG5T4buQIFRJ4buATiBO4buUIEjFqDoge2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2h1X2Ftb3VudCl9XG5LSMOUTkcgQ8OTIEFJIE5I4bqsTiDEkMav4buiQyBUSeG7gE4gSMWoIiwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKCmRlZiB0aGFuZ3RodWFfbm9odWJvbnVzKHNlc3Npb25fbnVtYmVyLCBodV90b3RhbCwgZXZlbnRfdGl0bGUsIGRpY2VfZGVzY3JpcHRpb24pOgogICAgYm9udXNfYW1vdW50ID0gMAoKICAgIGlmIHJlYWRfZmlsZV9jb250ZW50KCJGSUxFL2h1Ym9udXMudHh0Iikuc3RyaXAoKSA9PSAiVFJVRSI6CiAgICAgICAgYm9udXNfYW1vdW50ID0gMTAwMDAwCiAgICAgICAgYm9udXNfZmlsZV9wYXRoID0gIkZJTEUvaHVib251cy50eHQiCiAgICBlbGlmIHJlYWRfZmlsZV9jb250ZW50KCJGSUxFL3NpZXVodWJvbnVzLnR4dCIpLnN0cmlwKCkgPT0gIlRSVUUiOgogICAgICAgIGJvbnVzX2Ftb3VudCA9IDIwMDAwMAogICAgICAgIGJvbnVzX2ZpbGVfcGF0aCA9ICJGSUxFL3NpZXVodWJvbnVzLnR4dCIKICAgIGVsc2U6CiAgICAgICAgcHJpbnQoIltOT0hVXSBLaMO0bmcgY8OzIGZpbGUgYm9udXMgbsOgbyDEkWFuZyBi4bqtdCAoVFJVRSkuIikKICAgICAgICByZXR1cm4KCiAgICBjb250cmlidXRpb25zID0ge30KICAgIHRvdGFsX2JldF9hbW91bnQgPSAwCgogICAgaWYgZGljZV9kZXNjcmlwdGlvbiA9PSAiNiA2IDYiOgogICAgICAgIGZpbGVzX3RvX2NoZWNrID0gW29zLnBhdGguam9pbihmb2xkZXIsICJ0YWkudHh0IiksIG9zLnBhdGguam9pbihmb2xkZXIsICJjaGFuLnR4dCIpXQogICAgZWxpZiBkaWNlX2Rlc2NyaXB0aW9uID09ICIxIDEgMSI6CiAgICAgICAgZmlsZXNfdG9fY2hlY2sgPSBbb3MucGF0aC5qb2luKGZvbGRlciwgInhpdS50eHQiKSwgb3MucGF0aC5qb2luKGZvbGRlciwgImxlLnR4dCIpXQogICAgZWxzZToKICAgICAgICByZXR1cm4KCiAgICBmb3IgZmlsZV9wYXRoIGluIGZpbGVzX3RvX2NoZWNrOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydHMgYW5kIHBhcnRzWzBdID09IGYiI3tzZXNzaW9uX251bWJlcn0iOgogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2lkID0gcGFydHNbMV0KICAgICAgICAgICAgICAgICAgICAgICAgYmV0X2Ftb3VudCA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICAgICAgY29udHJpYnV0aW9uc1t1c2VyX2lkXSA9IGNvbnRyaWJ1dGlvbnMuZ2V0KHVzZXJfaWQsIDApICsgYmV0X2Ftb3VudAogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9iZXRfYW1vdW50ICs9IGJldF9hbW91bnQKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgbnVtYmVyX29mX3VzZXJzID0gbGVuKGNvbnRyaWJ1dGlvbnMpCgogICAgaWYgY29udHJpYnV0aW9ucyBhbmQgdG90YWxfYmV0X2Ftb3VudCA+IDA6CiAgICAgICAgdXNlcl9yZXdhcmRzID0gW10KCiAgICAgICAgZm9yIHVzZXJfaWQsIGNvbnRyaWJ1dGlvbiBpbiBjb250cmlidXRpb25zLml0ZW1zKCk6CiAgICAgICAgICAgIHJld2FyZF9yYXRpbyA9IGNvbnRyaWJ1dGlvbiAvIHRvdGFsX2JldF9hbW91bnQKICAgICAgICAgICAgcmV3YXJkID0gYm9udXNfYW1vdW50ICogcmV3YXJkX3JhdGlvCgogICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBmbG9hdChnZXRfYmFsYW5jZSh1c2VyX2lkKSkKICAgICAgICAgICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgKyByZXdhcmQKICAgICAgICAgICAgdXBkYXRlX2JhbGFuY2UodXNlcl9pZCwgbmV3X2JhbGFuY2UpCgogICAgICAgICAgICB1c2VyX3Jld2FyZHMuYXBwZW5kKCgKICAgICAgICAgICAgICAgIGhpZGVfdXNlcl9pZCh1c2VyX2lkKSwKICAgICAgICAgICAgICAgIGZvcm1hdF9iYWxhbmNlKGNvbnRyaWJ1dGlvbiksCiAgICAgICAgICAgICAgICBmb3JtYXRfYmFsYW5jZShyZXdhcmQpCiAgICAgICAgICAgICkpCgogICAgICAgICAgICBzZW5kX3VzZXIoCiAgICAgICAgICAgICAgICB1c2VyX2lkLAogICAgICAgICAgICAgICAgZiLwn5SlIENow7pjIG3hu6tuZyBi4bqhbiDEkcOjIG5o4bqtbiDEkcaw4bujYyB0aeG7gW4gSMWoIEJPTlVTIPCflKU6IDxiPntmb3JtYXRfYmFsYW5jZShyZXdhcmQpfTwvYj5cbiIKICAgICAgICAgICAgICAgIGYiU+G7kSBkxrAgbeG7m2k6IDxiPntmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9PC9iPiIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgICAgICkKCiAgICAgICAgcmV3YXJkX2xpbmVzID0gIlxuIi5qb2luKAogICAgICAgICAgICBmIntoaWR9IHwge2NvbnRyaWJ9IHwge3Jld2FyZH0iIGZvciBoaWQsIGNvbnRyaWIsIHJld2FyZCBpbiB1c2VyX3Jld2FyZHMKICAgICAgICApCgogICAgICAgIG1lc3NhZ2UgPSAoCiAgICAgICAgICAgIGYi8J+UpSA8Yj57ZXZlbnRfdGl0bGV9PC9iPiDwn5SlXG4iCiAgICAgICAgICAgIGYiU+G7kSB0aeG7gW4gY2hpYSBIxaggQk9OVVM6IDxiPntmb3JtYXRfYmFsYW5jZShib251c19hbW91bnQpfTwvYj5cbiIKICAgICAgICAgICAgZiJU4buVbmcgY8aw4bujYyBj4bunYSA8Yj57bnVtYmVyX29mX3VzZXJzfTwvYj4gbmfGsOG7nWkgbMOgOiA8Yj57Zm9ybWF0X2JhbGFuY2UodG90YWxfYmV0X2Ftb3VudCl9PC9iPlxuIgogICAgICAgICAgICBmIjxiPklEIHwgQ8aw4bujYyB8IE5o4bqtbjwvYj5cbiIKICAgICAgICAgICAgZiJ7cmV3YXJkX2xpbmVzfVxuXG4iCiAgICAgICAgICAgIGYiPGI+SMWoIEJPTlVTIMSQw4MgQknhur5OIE3huqRUPC9iPiIKICAgICAgICApCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oYm9udXNfZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKCJGQUxTRSIpCiAgICAgICAgICAgIHByaW50KGYiW0FVVE8tSFVdIOKchSDEkMOjIGNodXnhu4NuIHtib251c19maWxlX3BhdGh9IHbhu4EgRkFMU0Ugc2F1IGtoaSBu4buVIGjFqS4iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbQVVUTy1IVV0g4p2MIEzhu5dpIGtoaSDEkeG7lWkge2JvbnVzX2ZpbGVfcGF0aH06IHtlfSIpCgogICAgICAgIHNlbnRfbWVzc2FnZSA9IGJvdC5zZW5kX21lc3NhZ2UoZ3JvdXBfY2hhdF9pZCwgbWVzc2FnZSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICBpZiBudW1iZXJfb2ZfdXNlcnMgPiAwOgogICAgICAgICAgICBib3QucGluX2NoYXRfbWVzc2FnZShncm91cF9jaGF0X2lkLCBzZW50X21lc3NhZ2UubWVzc2FnZV9pZCkKCiAgICBlbHNlOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGdyb3VwX2NoYXRfaWQsCiAgICAgICAgICAgIGYiPGI+e2V2ZW50X3RpdGxlfTwvYj5cbiIKICAgICAgICAgICAgZiJT4buQIFRJ4buATiBIxaggQk9OVVM6IDxiPntmb3JtYXRfYmFsYW5jZShib251c19hbW91bnQpfTwvYj5cbiIKICAgICAgICAgICAgZiJLSMOUTkcgQ8OTIEFJIMSQ4bq2VCBDxq/hu6JDIFRST05HIFBIScOKTiIsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICApCgpkZWYgc2VuZF9ub3RpZmljYXRpb25zX3RvX3VzZXJzKHJlc3VsdCwgdmFsdWUsIHNlc3Npb25fbnVtYmVyLCByZXN1bHRfdHhfb3JfY2wpOgogICAgaWYgdmFsdWU6CiAgICAgICAgdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCgKICAgICAgICAgICAgdGFyZ2V0PXNlbmRfbm90aWZpY2F0aW9ucywKICAgICAgICAgICAgYXJncz0odmFsdWUsIHJlc3VsdF90eF9vcl9jbCwgc2Vzc2lvbl9udW1iZXIsIHJlc3VsdF90eF9vcl9jbCkKICAgICAgICApCiAgICAgICAgdGhyZWFkLnN0YXJ0KCkKCmRlZiBwcm9jZXNzX2RpY2VfcmVzdWx0cyhkaWNlX3ZhbHVlcywgc2Vzc2lvbl9udW1iZXIsIHRvdGFsX2JldF9sb3NzKToKICAgIGNvbnRyaWJ1dGlvbiA9IGVuc3VyZV9udW1iZXIoMC4wNSAqIHRvdGFsX2JldF9sb3NzKQogICAgdXBkYXRlX2h1X2ZpbGUoY29udHJpYnV0aW9uKQoKICAgIGRpY2VfdmFsdWVzX3N0ciA9ICcgJy5qb2luKG1hcChzdHIsIGRpY2VfdmFsdWVzKSkKCiAgICB0b3RhbF9tZDVfd2luLCB0b3RhbF9tZDVfbG9zcyA9IHRoYW5ndGh1YV9tZDUoKQoKICAgIHJldHVybiBjb250cmlidXRpb24sIGRpY2VfdmFsdWVzX3N0ciwgdG90YWxfbWQ1X3dpbiwgdG90YWxfbWQ1X2xvc3MKCmJhbGFuY2VfbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKCiIiImRlZiBjaGVja19iZXR0aW5nX3Jlc3VsdHMoc2Vzc2lvbl9udW1iZXIsIHJlc3VsdF90eCwgcmVzdWx0X2NsLCB0b3RhbF9iZXRfd2luLCB0b3RhbF9iZXRfbG9zcyk6CiAgICBkaWNlX3ZhbHVlcyA9IHNlbmRfZGljZV9ncm91cF9jaGF0KGdyb3VwX2NoYXRfaWQpCiAgICBwcmludChmIltERUJVR10gS+G6v3QgcXXhuqMgeMOtIG5n4bqndToge2RpY2VfdmFsdWVzfSIpCgogICAgdGxfYmV0ID0gcmVhZF9iZXRzX2Zyb21fZmlsZSgndGwudHh0Jywgc2Vzc2lvbl9udW1iZXIpCiAgICB0Y19iZXQgPSByZWFkX2JldHNfZnJvbV9maWxlKCd0Yy50eHQnLCBzZXNzaW9uX251bWJlcikKICAgIHhsX2JldCA9IHJlYWRfYmV0c19mcm9tX2ZpbGUoJ3hsLnR4dCcsIHNlc3Npb25fbnVtYmVyKQogICAgeGNfYmV0ID0gcmVhZF9iZXRzX2Zyb21fZmlsZSgneGMudHh0Jywgc2Vzc2lvbl9udW1iZXIpCgogICAgcmVzdWx0cyA9IFtdCgogICAgaWYgdGxfYmV0OgogICAgICAgIHJlc3VsdF90bCA9IGNoZWNrX3RsX2JldChkaWNlX3ZhbHVlcywgdGxfYmV0KQogICAgICAgIHJlc3VsdHMuYXBwZW5kKHJlc3VsdF90bCkKCiAgICBpZiB0Y19iZXQ6CiAgICAgICAgcmVzdWx0X3RjID0gY2hlY2tfdGNfYmV0KGRpY2VfdmFsdWVzLCB0Y19iZXQpCiAgICAgICAgcmVzdWx0cy5hcHBlbmQocmVzdWx0X3RjKQoKICAgIGlmIHhsX2JldDoKICAgICAgICByZXN1bHRfeGwgPSBjaGVja194bF9iZXQoZGljZV92YWx1ZXMsIHhsX2JldCkKICAgICAgICByZXN1bHRzLmFwcGVuZChyZXN1bHRfeGwpCgogICAgaWYgeGNfYmV0OgogICAgICAgIHJlc3VsdF94YyA9IGNoZWNrX3hjX2JldChkaWNlX3ZhbHVlcywgeGNfYmV0KQogICAgICAgIHJlc3VsdHMuYXBwZW5kKHJlc3VsdF94YykKCiAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgdXNlcl9pZCA9IHJlc3VsdFsndXNlcl9pZCddCiAgICAgICAgc2Vzc2lvbl9udW1iZXIgPSByZXN1bHRbJ3Nlc3Npb25fbnVtYmVyJ10KICAgICAgICBiZXRfdHlwZSA9IHJlc3VsdFsnYmV0X3R5cGUnXQogICAgICAgIGJldF9hbW91bnQgPSByZXN1bHRbJ2JldF9hbW91bnQnXQogICAgICAgIHdpbl9hbW91bnQgPSByZXN1bHRbJ3dpbl9hbW91bnQnXQogICAgICAgIGJldF9jb250ZW50ID0gcmVzdWx0WydiZXRfY29udGVudCddCgogICAgICAgIGlmIHJlc3VsdFsnd2luJ106CiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIuKche+4jyBL4buzIFhYOiB7c2Vzc2lvbl9udW1iZXJ9IHRo4bqvbmcgeGnDqm4ge2JldF9jb250ZW50fSB7Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpfSB4IHtyZXN1bHRbJ211bHRpcGxpZXInXX0gPSB7Zm9ybWF0X251bWJlcihzdHIod2luX2Ftb3VudCkpfSIKCiAgICAgICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGVbOjJdLCBiZXRfYW1vdW50LCB3aW5fYW1vdW50KQoKICAgICAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgd2luX2Ftb3VudCArIGJldF9hbW91bnQpCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIuKdjO+4jyBL4buzIFhYOiB7c2Vzc2lvbl9udW1iZXJ9IFRodWEgWGnDqm4ge2JldF9jb250ZW50fSB7Zm9ybWF0X251bWJlcihzdHIoYmV0X2Ftb3VudCkpfSIKCiAgICAgICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGVbOjJdLCBiZXRfYW1vdW50LCAwKQoKICAgICAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgMCkKCiAgICAgICAgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgbWVzc2FnZSkiIiIKCmRlZiBjaGVja190bF9iZXQoZGljZV92YWx1ZXMsIGJldCk6CiAgICBiZXRfbnVtYmVycyA9IFsxMSwgMTMsIDE1LCAxN10KICAgIG11bHRpcGxpZXIgPSAzLjMKICAgIHdpbl9hbW91bnQgPSAwCgogICAgaWYgYW55KGRpY2UgaW4gYmV0X251bWJlcnMgZm9yIGRpY2UgaW4gZGljZV92YWx1ZXMpOgogICAgICAgIHdpbl9hbW91bnQgPSBiZXQgKiBtdWx0aXBsaWVyCiAgICAgICAgd2luID0gVHJ1ZQogICAgZWxzZToKICAgICAgICB3aW4gPSBGYWxzZQoKICAgIHJldHVybiB7CiAgICAgICAgJ3VzZXJfaWQnOiBiZXRbJ3VzZXJfaWQnXSwKICAgICAgICAnc2Vzc2lvbl9udW1iZXInOiBiZXRbJ3Nlc3Npb25fbnVtYmVyJ10sCiAgICAgICAgJ2JldF90eXBlJzogJ1RMJywKICAgICAgICAnYmV0X2Ftb3VudCc6IGJldFsnYW1vdW50J10sCiAgICAgICAgJ3dpbl9hbW91bnQnOiB3aW5fYW1vdW50LAogICAgICAgICd3aW4nOiB3aW4sCiAgICAgICAgJ2JldF9jb250ZW50JzogIlRMIiwKICAgICAgICAnbXVsdGlwbGllcic6IG11bHRpcGxpZXIKICAgIH0KCmRlZiBjaGVja190Y19iZXQoZGljZV92YWx1ZXMsIGJldCk6CiAgICBiZXRfbnVtYmVycyA9IFsxMiwgMTQsIDE2LCAxOF0KICAgIG11bHRpcGxpZXIgPSAzLjkKICAgIHdpbl9hbW91bnQgPSAwCgogICAgaWYgYW55KGRpY2UgaW4gYmV0X251bWJlcnMgZm9yIGRpY2UgaW4gZGljZV92YWx1ZXMpOgogICAgICAgIHdpbl9hbW91bnQgPSBiZXQgKiBtdWx0aXBsaWVyCiAgICAgICAgd2luID0gVHJ1ZQogICAgZWxzZToKICAgICAgICB3aW4gPSBGYWxzZQoKICAgIHJldHVybiB7CiAgICAgICAgJ3VzZXJfaWQnOiBiZXRbJ3VzZXJfaWQnXSwKICAgICAgICAnc2Vzc2lvbl9udW1iZXInOiBiZXRbJ3Nlc3Npb25fbnVtYmVyJ10sCiAgICAgICAgJ2JldF90eXBlJzogJ1RDJywKICAgICAgICAnYmV0X2Ftb3VudCc6IGJldFsnYW1vdW50J10sCiAgICAgICAgJ3dpbl9hbW91bnQnOiB3aW5fYW1vdW50LAogICAgICAgICd3aW4nOiB3aW4sCiAgICAgICAgJ2JldF9jb250ZW50JzogIlRDIiwKICAgICAgICAnbXVsdGlwbGllcic6IG11bHRpcGxpZXIKICAgIH0KCmRlZiBjaGVja194bF9iZXQoZGljZV92YWx1ZXMsIGJldCk6CiAgICBiZXRfbnVtYmVycyA9IFszLCA1LCA3LCA5XQogICAgbXVsdGlwbGllciA9IDMuOQogICAgd2luX2Ftb3VudCA9IDAKCiAgICBpZiBhbnkoZGljZSBpbiBiZXRfbnVtYmVycyBmb3IgZGljZSBpbiBkaWNlX3ZhbHVlcyk6CiAgICAgICAgd2luX2Ftb3VudCA9IGJldCAqIG11bHRpcGxpZXIKICAgICAgICB3aW4gPSBUcnVlCiAgICBlbHNlOgogICAgICAgIHdpbiA9IEZhbHNlCgogICAgcmV0dXJuIHsKICAgICAgICAndXNlcl9pZCc6IGJldFsndXNlcl9pZCddLAogICAgICAgICdzZXNzaW9uX251bWJlcic6IGJldFsnc2Vzc2lvbl9udW1iZXInXSwKICAgICAgICAnYmV0X3R5cGUnOiAnWEwnLAogICAgICAgICdiZXRfYW1vdW50JzogYmV0WydhbW91bnQnXSwKICAgICAgICAnd2luX2Ftb3VudCc6IHdpbl9hbW91bnQsCiAgICAgICAgJ3dpbic6IHdpbiwKICAgICAgICAnYmV0X2NvbnRlbnQnOiAiWEwiLAogICAgICAgICdtdWx0aXBsaWVyJzogbXVsdGlwbGllcgogICAgfQoKZGVmIGNoZWNrX3hjX2JldChkaWNlX3ZhbHVlcywgYmV0KToKICAgIGJldF9udW1iZXJzID0gWzQsIDYsIDgsIDEwXQogICAgbXVsdGlwbGllciA9IDMuMwogICAgd2luX2Ftb3VudCA9IDAKCiAgICBpZiBhbnkoZGljZSBpbiBiZXRfbnVtYmVycyBmb3IgZGljZSBpbiBkaWNlX3ZhbHVlcyk6CiAgICAgICAgd2luX2Ftb3VudCA9IGJldCAqIG11bHRpcGxpZXIKICAgICAgICB3aW4gPSBUcnVlCiAgICBlbHNlOgogICAgICAgIHdpbiA9IEZhbHNlCgogICAgcmV0dXJuIHsKICAgICAgICAndXNlcl9pZCc6IGJldFsndXNlcl9pZCddLAogICAgICAgICdzZXNzaW9uX251bWJlcic6IGJldFsnc2Vzc2lvbl9udW1iZXInXSwKICAgICAgICAnYmV0X3R5cGUnOiAnWEMnLAogICAgICAgICdiZXRfYW1vdW50JzogYmV0WydhbW91bnQnXSwKICAgICAgICAnd2luX2Ftb3VudCc6IHdpbl9hbW91bnQsCiAgICAgICAgJ3dpbic6IHdpbiwKICAgICAgICAnYmV0X2NvbnRlbnQnOiAiWEMiLAogICAgICAgICdtdWx0aXBsaWVyJzogbXVsdGlwbGllcgogICAgfQoKCiAgICAgICAgICAgICN0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiTOG7i2NoIHPhu60gTUQ1IiwgdXJsPSJodHRwczovL3QubWUva2luZ2NsdWJfa3FtZDUiKQoKZGVmIGluY3JlYXNlX2ZpbGVfdmFsdWUoZmlsZW5hbWUpOgogICAgZm9sZGVyID0gIkZJTEUiCiAgICBmaWxlcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsIGZpbGVuYW1lKQoKICAgIHRyeToKICAgICAgICBjdXJyZW50ID0gaW50KHJlYWRfZmlsZV9jb250ZW50KGZpbGVwYXRoKSBvciAnMCcpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBjdXJyZW50ID0gMAoKICAgIHBhaXJzID0gewogICAgICAgICdrcXRhaS50eHQnOiAna3F4aXUudHh0JywKICAgICAgICAna3F4aXUudHh0JzogJ2txdGFpLnR4dCcsCiAgICAgICAgJ2txY2hhbi50eHQnOiAna3FsZS50eHQnLAogICAgICAgICdrcWxlLnR4dCc6ICdrcWNoYW4udHh0JwogICAgfQoKICAgIG9wcG9zaXRlX2ZpbGUgPSBwYWlycy5nZXQoZmlsZW5hbWUpCiAgICBpZiBub3Qgb3Bwb3NpdGVfZmlsZToKICAgICAgICByZXR1cm4KCiAgICBvcHBvc2l0ZV9maWxlcGF0aCA9IG9zLnBhdGguam9pbihmb2xkZXIsIG9wcG9zaXRlX2ZpbGUpCgogICAgdHJ5OgogICAgICAgIG9wcG9zaXRlX3ZhbHVlID0gaW50KHJlYWRfZmlsZV9jb250ZW50KG9wcG9zaXRlX2ZpbGVwYXRoKSBvciAnMCcpCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBvcHBvc2l0ZV92YWx1ZSA9IDAKCiAgICBjdXJyZW50ICs9IDEKICAgIG9wcG9zaXRlX3ZhbHVlID0gbWF4KDAsIDEwMCAtIGN1cnJlbnQpCgogICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgZmlsZS53cml0ZShzdHIoY3VycmVudCkpCiAgICB3aXRoIG9wZW4ob3Bwb3NpdGVfZmlsZXBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICBmaWxlLndyaXRlKHN0cihvcHBvc2l0ZV92YWx1ZSkpCgpkZWYgZ2VuZXJhdGVfdGhhbmd0aHVhX21kNV9saW5lcyhzZXNzaW9uX251bWJlcik6CiAgICBmb2xkZXIgPSAiRklMRSIKICAgIHJlc3VsdF9maWxlcyA9IHsKICAgICAgICAibXQiOiBvcy5wYXRoLmpvaW4oZm9sZGVyLCAibXQudHh0IiksCiAgICAgICAgIm14Ijogb3MucGF0aC5qb2luKGZvbGRlciwgIm14LnR4dCIpLAogICAgICAgICJtYyI6IG9zLnBhdGguam9pbihmb2xkZXIsICJtYy50eHQiKSwKICAgICAgICAibWwiOiBvcy5wYXRoLmpvaW4oZm9sZGVyLCAibWwudHh0IikKICAgIH0KCiAgICBtZDVfY29udGVudCA9IHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdtZDUudHh0JykpCiAgICBrZXltZDVfY29udGVudCA9IHJlYWRfZmlsZV9jb250ZW50KG9zLnBhdGguam9pbihmb2xkZXIsICdrZXltZDUudHh0JykpCiAgICBtZDVfcGFydHMgPSBtZDVfY29udGVudC5zcGxpdCgiIDogIikKICAgIGtleV9wYXJ0cyA9IGtleW1kNV9jb250ZW50LnNwbGl0KCIgOiAiKQogICAgbWQ1X2NvZGUgPSBtZDVfcGFydHNbMV0gaWYgbGVuKG1kNV9wYXJ0cykgPiAxIGVsc2UgIk4vQSIKICAgIGtleW1kNV9jb2RlID0ga2V5X3BhcnRzWzFdIGlmIGxlbihrZXlfcGFydHMpID4gMSBlbHNlICJOL0EiCgogICAgcmVhbF9rZXkgPSBrZXltZDVfY29kZS5sb3dlcigpCgogICAgcmVzdWx0ID0gW10KCiAgICBmb3IgY29kZSwgZmlsZXBhdGggaW4gcmVzdWx0X2ZpbGVzLml0ZW1zKCk6CiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVwYXRoKToKICAgICAgICAgICAgY29udGludWUKICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lLnN0YXJ0c3dpdGgoZiIje3Nlc3Npb25fbnVtYmVyfSAiKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDM6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB1c2VyX2lkID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICBpc193aW4gPSAocmVhbF9rZXkgPT0gY29kZSkKICAgICAgICAgICAgICAgICAgICByZXN1bHQuYXBwZW5kKCh1c2VyX2lkLCBzZXNzaW9uX251bWJlciwgY29kZSwgaXNfd2luLCBhbW91bnQsIG1kNV9jb2RlLCBrZXltZDVfY29kZSkpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICByZXR1cm4gcmVzdWx0CgpkZWYgZ2VuZXJhdGVfdGhhbmd0aHVhX2RfbGluZXMoc2Vzc2lvbl9udW1iZXIsIGRpY2VfdmFsdWVzKToKICAgIHJlc3VsdHMgPSBbXQogICAgZm9yIGkgaW4gcmFuZ2UoMSwgNyk6CiAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCBmJ2R7aX0udHh0JykKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZXBhdGgpOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lLnN0cmlwKCkgb3Igbm90IGxpbmUuc3RhcnRzd2l0aCgnIycpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDM6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3NfbnVtID0gaW50KHBhcnRzWzBdWzE6XSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJfaWQgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2Vzc19udW0gPT0gc2Vzc2lvbl9udW1iZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kID0gZidke2l9JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfd2luID0gaSBpbiBbaW50KGQpIGZvciBkIGluIGRpY2VfdmFsdWVzXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGlsZV9tdWx0aXBsaWVyID0gZGljZV92YWx1ZXMuY291bnQoaSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKCh1c2VyX2lkLCBzZXNzaW9uX251bWJlciwgY29tbWFuZCwgaXNfd2luLCBhbW91bnQsIHRpbGVfbXVsdGlwbGllcikpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gS2jDtG5nIHRo4buDIMSR4buNYyBmaWxlIGR7aX0udHh0OiB7ZX0iKQogICAgcmV0dXJuIHJlc3VsdHMKCmRlZiBnZW5lcmF0ZV90aGFuZ3RodWFfeGllbl9saW5lcyhzZXNzaW9uX251bWJlcik6CiAgICByZXN1bHRzID0gW10KICAgIHhpZW5fZmlsZXMgPSBbJ3hsJywgJ3hjJywgJ3RsJywgJ3RjJ10KCiAgICBmb3IgY21kIGluIHhpZW5fZmlsZXM6CiAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCBmJ3tjbWR9LnR4dCcpCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVwYXRoKToKICAgICAgICAgICAgY29udGludWUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbGluZS5zdHJpcCgpIG9yIG5vdCBsaW5lLnN0YXJ0c3dpdGgoJyMnKToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzX251bSA9IGludChwYXJ0c1swXVsxOl0pIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZXNzX251bSA9PSBzZXNzaW9uX251bWJlcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKCh1c2VyX2lkLCBzZXNzaW9uX251bWJlciwgY21kLnVwcGVyKCksIGFtb3VudCkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gS2jDtG5nIHRo4buDIMSR4buNYyBmaWxlIHtjbWR9LnR4dDoge2V9IikKICAgIHJldHVybiByZXN1bHRzCgpkZWYgZ2VuZXJhdGVfdGhhbmd0aHVhX2Jhb19saW5lcyhzZXNzaW9uX251bWJlcik6CiAgICByZXN1bHRzID0gW10KICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgJ2Jhby50eHQnKSAgCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZXBhdGgpOgogICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlIGJhby50eHQiKQogICAgICAgIHJldHVybiByZXN1bHRzCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBpZiBub3QgbGluZS5zdHJpcCgpIG9yIG5vdCBsaW5lLnN0YXJ0c3dpdGgoJyMnKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDQ6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTklOR10gRMOybmcgc2FpIMSR4buLbmggZOG6oW5nOiB7bGluZS5zdHJpcCgpfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZXNzX251bSA9IGludChwYXJ0c1swXVsxOl0pCiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICBjb21tYW5kID0gcGFydHNbMl0KICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSBpbnQocGFydHNbM10pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIMOpcCBraeG7g3UgZMOybmc6IHtsaW5lLnN0cmlwKCl9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgc2Vzc19udW0gIT0gc2Vzc2lvbl9udW1iZXI6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHJlc3VsdHMuYXBwZW5kKCh1c2VyX2lkLCBzZXNzaW9uX251bWJlciwgY29tbWFuZCwgYW1vdW50KSkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEtow7RuZyB0aOG7gyDEkeG7jWMgZmlsZSBiYW8udHh0OiB7ZX0iKQoKICAgIHJldHVybiByZXN1bHRzCgpkZWYgZ2VuZXJhdGVfdGhhbmd0aHVhX3NiX2xpbmVzKHNlc3Npb25fbnVtYmVyKToKICAgIHJlc3VsdHMgPSBbXQogICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZm9sZGVyLCAnc2IudHh0JykgIAoKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlcGF0aCk6CiAgICAgICAgcHJpbnQoIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgc2IudHh0IikKICAgICAgICByZXR1cm4gcmVzdWx0cwoKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lLnN0cmlwKCkgb3Igbm90IGxpbmUuc3RhcnRzd2l0aCgnIycpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpIDwgNDoKICAgICAgICAgICAgICAgICAgICBwcmludChmIltXQVJOSU5HXSBEw7JuZyBzYWkgxJHhu4tuaCBk4bqhbmc6IHtsaW5lLnN0cmlwKCl9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlc3NfbnVtID0gaW50KHBhcnRzWzBdWzE6XSkKICAgICAgICAgICAgICAgICAgICB1c2VyX2lkID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgIGNvbW1hbmQgPSBwYXJ0c1syXQogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChwYXJ0c1szXSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgw6lwIGtp4buDdSBkw7JuZzoge2xpbmUuc3RyaXAoKX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBzZXNzX251bSAhPSBzZXNzaW9uX251bWJlcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcmVzdWx0cy5hcHBlbmQoKHVzZXJfaWQsIHNlc3Npb25fbnVtYmVyLCBjb21tYW5kLCBhbW91bnQpKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBLaMO0bmcgdGjhu4MgxJHhu41jIGZpbGUgc2IudHh0OiB7ZX0iKQoKICAgIHJldHVybiByZXN1bHRzCgoiIiI8Yj5NRDU6PC9iPiA8Y29kZT57bWQ1X2hhc2h9PC9jb2RlPgo8Yj5LRVk6PC9iPiA8Y29kZT57a2V5X21kNX08L2NvZGU+CgpU4buVbmcgdGjhuq9uZzoge2Zvcm1hdF9udW1iZXIodG90YWxfbWQ1X3dpbil9ClThu5VuZyB0aHVhOiB7Zm9ybWF0X251bWJlcih0b3RhbF9tZDVfbG9zcyl9IiIiCgpkZWYgdXBkYXRlX3Jlc3VsdF9jb3VudHMocmVzdWx0X3R4LCByZXN1bHRfY2wpOgogICAgZm9sZGVyID0gIkZJTEUiCiAgICB1cGRhdGVfYmFsYW5jZWRfY291bnRzKAogICAgICAgIG9zLnBhdGguam9pbihmb2xkZXIsICdrcXRhaS50eHQnKSwKICAgICAgICBvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3F4aXUudHh0JyksCiAgICAgICAgcmVzdWx0X3R4ID09ICdUw6BpJwogICAgKQogICAgdXBkYXRlX2JhbGFuY2VkX2NvdW50cygKICAgICAgICBvcy5wYXRoLmpvaW4oZm9sZGVyLCAna3FjaGFuLnR4dCcpLAogICAgICAgIG9zLnBhdGguam9pbihmb2xkZXIsICdrcWxlLnR4dCcpLAogICAgICAgIHJlc3VsdF9jbCA9PSAnQ2jhurVuJwogICAgKQoKZGVmIHVwZGF0ZV9iYWxhbmNlZF9jb3VudHMoZmlsZV9hLCBmaWxlX2IsIGlzX2Ffd2lubmVyKToKICAgIHZhbHVlX2EgPSByZWFkX2ZpbGVfYXNfaW50KGZpbGVfYSkKICAgIHZhbHVlX2IgPSByZWFkX2ZpbGVfYXNfaW50KGZpbGVfYikKCiAgICBpZiBpc19hX3dpbm5lcjoKICAgICAgICB2YWx1ZV9hICs9IDEKICAgICAgICB2YWx1ZV9iIC09IDEKICAgIGVsc2U6CiAgICAgICAgdmFsdWVfYSAtPSAxCiAgICAgICAgdmFsdWVfYiArPSAxCgogICAgdG90YWwgPSB2YWx1ZV9hICsgdmFsdWVfYgogICAgaWYgdG90YWwgIT0gMTAwOgogICAgICAgIGlmIHRvdGFsID4gMTAwOgogICAgICAgICAgICBkaWZmZXJlbmNlID0gdG90YWwgLSAxMDAKICAgICAgICAgICAgaWYgaXNfYV93aW5uZXI6CiAgICAgICAgICAgICAgICB2YWx1ZV9iIC09IGRpZmZlcmVuY2UKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHZhbHVlX2EgLT0gZGlmZmVyZW5jZQogICAgICAgIGVsaWYgdG90YWwgPCAxMDA6CiAgICAgICAgICAgIGRpZmZlcmVuY2UgPSAxMDAgLSB0b3RhbAogICAgICAgICAgICBpZiBpc19hX3dpbm5lcjoKICAgICAgICAgICAgICAgIHZhbHVlX2IgKz0gZGlmZmVyZW5jZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdmFsdWVfYSArPSBkaWZmZXJlbmNlCgogICAgd3JpdGVfZmlsZV9jb250ZW50KGZpbGVfYSwgc3RyKHZhbHVlX2EpKQogICAgd3JpdGVfZmlsZV9jb250ZW50KGZpbGVfYiwgc3RyKHZhbHVlX2IpKQoKZGVmIHJlYWRfZmlsZV9hc19pbnQoZmlsZV9wYXRoKToKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIHJldHVybiBpbnQoZmlsZS5yZWFkKCkuc3RyaXAoKSkKICAgIGV4Y2VwdCAoRmlsZU5vdEZvdW5kRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgIHJldHVybiAwCgpkZWYgd3JpdGVfZmlsZV9jb250ZW50KGZpbGVfcGF0aCwgY29udGVudCk6CiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgZmlsZS53cml0ZShjb250ZW50KQoKZGVmIGluY3JlbWVudF9yZXN1bHRfY291bnQoZmlsZV9hLCBmaWxlX2IsIGlzX2Ffd2lubmVyKToKICAgIHVwZGF0ZV9iYWxhbmNlZF9jb3VudHMoZmlsZV9hLCBmaWxlX2IsIGlzX2Ffd2lubmVyKQoKZGVmIGNhbGN1bGF0ZV91c2VyX3Jlc3VsdHMoZmlsZV9wYXRoLCByZXN1bHRfdHlwZSwgcmVzdWx0X3R4LCBzZXNzaW9uX251bWJlcik6CiAgICB1c2VyX3RvdGFscyA9IHt9CgogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMyBhbmQgcGFydHNbMF0gPT0gZiIje3Nlc3Npb25fbnVtYmVyfSI6CiAgICAgICAgICAgICAgICB1c2VyX2lkID0gcGFydHNbMV0KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBiZXRfYW1vdW50ID0gaW50KHBhcnRzWzJdKQoKICAgICAgICAgICAgICAgICAgICBpZiByZXN1bHRfdHlwZSA9PSByZXN1bHRfdHg6CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbm5pbmdzID0gYmV0X2Ftb3VudCAqIDAuOTUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICB3aW5uaW5ncyA9IC1iZXRfYW1vdW50ICogMC45NQoKICAgICAgICAgICAgICAgICAgICBpZiB1c2VyX2lkIG5vdCBpbiB1c2VyX3RvdGFsczoKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl90b3RhbHNbdXNlcl9pZF0gPSB7J3RvdGFsX2JldCc6IDAsICd0b3RhbF93aW5uaW5ncyc6IDB9CgogICAgICAgICAgICAgICAgICAgIHVzZXJfdG90YWxzW3VzZXJfaWRdWyd0b3RhbF9iZXQnXSArPSBiZXRfYW1vdW50CiAgICAgICAgICAgICAgICAgICAgdXNlcl90b3RhbHNbdXNlcl9pZF1bJ3RvdGFsX3dpbm5pbmdzJ10gKz0gd2lubmluZ3MKCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IEludmFsaWQgYW1vdW50ICd7cGFydHNbMl19JyBpbiBmaWxlICd7ZmlsZV9wYXRofScuIFNraXBwaW5nIGxpbmUuIikKCiAgICByZXR1cm4gdXNlcl90b3RhbHMKCmZvbGRlciA9ICJGSUxFIgoKZGVmIHNhdmVfc2Vzc2lvbl9oaXN0b3J5X3RvX2ZpbGVfdHgoKToKICAgIGdsb2JhbCBzZXNzaW9uX3Jlc3VsdHNfdHgKICAgIGxhc3RfMTBfc2Vzc2lvbnMgPSBzZXNzaW9uX3Jlc3VsdHNfdHhbLTEwOl0KICAgIGRpc3BsYXlfbGFzdF8xMCA9ICIgIi5qb2luKFsi8J+UtSIgaWYgc2Vzc2lvbiA9PSAnVMOgaScgZWxzZSAi8J+UtCIgZm9yIHNlc3Npb24gaW4gbGFzdF8xMF9zZXNzaW9uc10pCiAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKGZvbGRlciwgIm1hdHBoaWVudHgudHh0IiksICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICBmaWxlLndyaXRlKGRpc3BsYXlfbGFzdF8xMCkKCmRlZiBsb2FkX3Nlc3Npb25faGlzdG9yeV9mcm9tX2ZpbGVfdHgoKToKICAgIGdsb2JhbCBzZXNzaW9uX3Jlc3VsdHNfdHgKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKGZvbGRlciwgIm1hdHBoaWVudHgudHh0IiksICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgc2Vzc2lvbl9oaXN0b3J5ID0gZmlsZS5yZWFkKCkuc3BsaXQoKQogICAgICAgICAgICBzZXNzaW9uX3Jlc3VsdHNfdHggPSBbJ1TDoGknIGlmIHNlc3Npb24gPT0gJ/CflLUnIGVsc2UgJ1jhu4l1JyBmb3Igc2Vzc2lvbiBpbiBzZXNzaW9uX2hpc3RvcnldCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgc2Vzc2lvbl9yZXN1bHRzX3R4ID0gW10KCmRlZiBzYXZlX3Nlc3Npb25faGlzdG9yeV90b19maWxlX2NsKCk6CiAgICBnbG9iYWwgc2Vzc2lvbl9yZXN1bHRzX2NsCiAgICBsYXN0XzEwX3Nlc3Npb25zID0gc2Vzc2lvbl9yZXN1bHRzX2NsWy0xMDpdCiAgICBkaXNwbGF5X2xhc3RfMTAgPSAiICIuam9pbihbIuKaqu+4jyIgaWYgc2Vzc2lvbiA9PSAnQ2jhurVuJyBlbHNlICLimqvvuI8iIGZvciBzZXNzaW9uIGluIGxhc3RfMTBfc2Vzc2lvbnNdKQogICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihmb2xkZXIsICJtYXRwaGllbmNsLnR4dCIpLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZmlsZS53cml0ZShkaXNwbGF5X2xhc3RfMTApCgpkZWYgbG9hZF9zZXNzaW9uX2hpc3RvcnlfZnJvbV9maWxlX2NsKCk6CiAgICBnbG9iYWwgc2Vzc2lvbl9yZXN1bHRzX2NsCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihmb2xkZXIsICJtYXRwaGllbmNsLnR4dCIpLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIHNlc3Npb25faGlzdG9yeSA9IGZpbGUucmVhZCgpLnNwbGl0KCkKICAgICAgICAgICAgc2Vzc2lvbl9yZXN1bHRzX2NsID0gWydDaOG6tW4nIGlmIHNlc3Npb24gPT0gJ+Kaqu+4jycgZWxzZSAnTOG6uycgZm9yIHNlc3Npb24gaW4gc2Vzc2lvbl9oaXN0b3J5XQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHNlc3Npb25fcmVzdWx0c19jbCA9IFtdCgpkZWYgcmVhZF9maWxlX2NvbnRlbnQoZmlsZW5hbWUpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlbmFtZSwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICByZXR1cm4gZmlsZS5yZWFkKCkuc3RyaXAoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJldHVybiAnJwogICAgZXhjZXB0IFVuaWNvZGVEZWNvZGVFcnJvciBhcyBlOgogICAgICAgIHJldHVybiAnJwoKZGVmIHdyaXRlX2ZpbGVfY29udGVudChmaWxlbmFtZSwgY29udGVudCk6CiAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICBmaWxlLndyaXRlKGNvbnRlbnQpCgpkZWYgZW5zdXJlX251bWJlcih2YWx1ZSk6CiAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCBkaWN0KToKICAgICAgICB2YWx1ZSA9IHZhbHVlLmdldCgndG90YWwnLCAwKQogICAgZWxpZiBpc2luc3RhbmNlKHZhbHVlLCBzdHIpOgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsdWUgPSBpbnQodmFsdWUpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHZhbHVlID0gMAogICAgZWxpZiBub3QgaXNpbnN0YW5jZSh2YWx1ZSwgKGludCwgZmxvYXQpKToKICAgICAgICB2YWx1ZSA9IDAKCiAgICByZXR1cm4gdmFsdWUKCmRlZiBkZXRlcm1pbmVfd2lubmVycyhkaWNlX3JvbGxzLCBiZXRzKToKICAgIGRpY2Vfc3RyID0gJyAnLmpvaW4obWFwKHN0ciwgZGljZV9yb2xscykpCiAgICBpZiBkaWNlX3N0ciA9PSAnMSAxIDEnOgogICAgICAgIHdpbm5pbmdfY29uZGl0aW9uID0gWydY4buJdScsICdM4bq7J10KICAgIGVsaWYgZGljZV9zdHIgPT0gJzYgNiA2JzoKICAgICAgICB3aW5uaW5nX2NvbmRpdGlvbiA9IFsnVMOgaScsICdDaOG6tW4nXQogICAgZWxzZToKICAgICAgICB3aW5uaW5nX2NvbmRpdGlvbiA9IFtdCgogICAgd2lubmVycyA9IHt9CiAgICBmb3IgdXNlcl9pZCwgYmV0X2luZm8gaW4gYmV0cy5pdGVtcygpOgogICAgICAgIGlmIGFueShiZXRfdHlwZSBpbiB3aW5uaW5nX2NvbmRpdGlvbiBmb3IgYmV0X3R5cGUgaW4gYmV0X2luZm9bJ2JldF90eXBlJ10pOgogICAgICAgICAgICB3aW5uZXJzW3VzZXJfaWRdID0gYmV0X2luZm9bJ2JldF9hbW91bnQnXQoKICAgIHJldHVybiB3aW5uZXJzCgpkZWYgcmVzZXRfaHVfZmlsZSgpOgogICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihmb2xkZXIsICdodS50eHQnKSwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgIGZpbGUud3JpdGUoIjAiKQoKZGVmIHJlc2V0X2dvcGh1X2ZpbGUoKToKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKGZvbGRlciwgJ2dvcGh1LnR4dCcpLCAndycsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGZpbGUud3JpdGUoIiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEtow7RuZyB0aOG7gyB4w7NhIG7hu5lpIGR1bmcgZmlsZSBnb3BodS50eHQ6IHtlfSIpCgpkZWYgY2xlYXJfYmV0X2ZpbGUoZmlsZW5hbWUpOgogICAgb3BlbihmaWxlbmFtZSwgJ3cnKS5jbG9zZSgpCgpkZWYgc2VuZF9tZXNzYWdlX3RvX3VzZXIodXNlcl9pZCwgbWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKToKICAgIGJvdF90b2tlbiA9IGJvdDQudG9rZW4gIAogICAgdXJsID0gZidodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e2JvdF90b2tlbn0vc2VuZE1lc3NhZ2UnCiAgICBwYXlsb2FkID0gewogICAgICAgICdjaGF0X2lkJzogdXNlcl9pZCwKICAgICAgICAndGV4dCc6IG1lc3NhZ2VfdGV4dCwKICAgICAgICAncGFyc2VfbW9kZSc6IHBhcnNlX21vZGUKICAgIH0KICAgIHByaW50KGYiW0RFQlVHXSBH4butaSB0aW4gbmjhuq9uIMSR4bq/biB1c2VyX2lkPXt1c2VyX2lkfSB24bubaSBu4buZaSBkdW5nOiB7bWVzc2FnZV90ZXh0Wzo1MF19Li4uIikKCiAgICB0cnk6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1wYXlsb2FkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBIVFRQIHN0YXR1czoge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSIpCiAgICAgICAgcmVzcG9uc2VfZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBSZXNwb25zZSBkYXRhOiB7cmVzcG9uc2VfZGF0YX0iKQoKICAgICAgICBpZiBub3QgcmVzcG9uc2VfZGF0YS5nZXQoJ29rJywgRmFsc2UpOgogICAgICAgICAgICBlcnJvcl9tZXNzYWdlID0gcmVzcG9uc2VfZGF0YS5nZXQoJ2Rlc2NyaXB0aW9uJywgJ1Vua25vd24gZXJyb3InKQogICAgICAgICAgICBsb2dnaW5nLmVycm9yKGYiRXJyb3Igc2VuZGluZyBtZXNzYWdlOiB7ZXJyb3JfbWVzc2FnZX0iKQogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgdGluIG5o4bqvbjoge2Vycm9yX21lc3NhZ2V9IikKICAgIGV4Y2VwdCByZXF1ZXN0cy5SZXF1ZXN0RXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nZ2luZy5lcnJvcihmIkZhaWxlZCB0byBzZW5kIG1lc3NhZ2UgdG8gdXNlciB7dXNlcl9pZH06IHtlfSIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEV4Y2VwdGlvbiBn4butaSB0aW4gbmjhuq9uOiB7ZX0iKQoKZGVmIHNlbmRfdXNlcih1c2VyX2lkLCBtZXNzYWdlX3RleHQsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpOgogICAgYm90X3Rva2VuID0gYm90NC50b2tlbiAgCiAgICB1cmwgPSBmJ2h0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7Ym90X3Rva2VufS9zZW5kTWVzc2FnZScKICAgIHBheWxvYWQgPSB7CiAgICAgICAgJ2NoYXRfaWQnOiB1c2VyX2lkLAogICAgICAgICd0ZXh0JzogbWVzc2FnZV90ZXh0LAogICAgICAgICdwYXJzZV9tb2RlJzogcGFyc2VfbW9kZQogICAgfQogICAgcHJpbnQoZiJbREVCVUddIEfhu61pIHRpbiBuaOG6r24gKHNlbmRfdXNlcikgxJHhur9uIHVzZXJfaWQ9e3VzZXJfaWR9IHbhu5tpIG7hu5lpIGR1bmc6IHttZXNzYWdlX3RleHRbOjUwXX0uLi4iKQoKICAgIHRyeToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QodXJsLCBqc29uPXBheWxvYWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEhUVFAgc3RhdHVzIChzZW5kX3VzZXIpOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IikKICAgICAgICByZXNwb25zZV9kYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFJlc3BvbnNlIGRhdGEgKHNlbmRfdXNlcik6IHtyZXNwb25zZV9kYXRhfSIpCgogICAgICAgIGlmIG5vdCByZXNwb25zZV9kYXRhLmdldCgnb2snLCBGYWxzZSk6CiAgICAgICAgICAgIGVycm9yX21lc3NhZ2UgPSByZXNwb25zZV9kYXRhLmdldCgnZGVzY3JpcHRpb24nLCAnVW5rbm93biBlcnJvcicpCiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJFcnJvciBzZW5kaW5nIG1lc3NhZ2U6IHtlcnJvcl9tZXNzYWdlfSIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSB0aW4gbmjhuq9uIChzZW5kX3VzZXIpOiB7ZXJyb3JfbWVzc2FnZX0iKQogICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dnaW5nLmVycm9yKGYiRmFpbGVkIHRvIHNlbmQgbWVzc2FnZSB0byB1c2VyIHt1c2VyX2lkfToge2V9IikKICAgICAgICBwcmludChmIltERUJVR10gRXhjZXB0aW9uIGfhu61pIHRpbiBuaOG6r24gKHNlbmRfdXNlcik6IHtlfSIpCgpkZWYgaGlkZV91c2VyX2lkKHVzZXJfaWQpOgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgcmV0dXJuICcqJyAqIChsZW4odXNlcl9pZCkgLSA1KSArIHVzZXJfaWRbLTU6XQoKZGVmIGZvcm1hdF9iYWxhbmNlKGJhbGFuY2UpOgogICAgcmV0dXJuICd7OiwuMGZ9Jy5mb3JtYXQoYmFsYW5jZSkucmVwbGFjZSgnLCcsICcuJykKCmRlZiBzZW5kX3Jlc3VsdF9ub3RpZmljYXRpb25zX290aGVyX2JvdChzZXNzaW9uX251bWJlciwgZGljZV92YWx1ZXMsIHRvdGFsX2RpY2UsIHJlc3VsdF90eCwgcmVzdWx0X2NsKToKICAgIG1lc3NhZ2UgPSBmIjxiPktRIEvhu7IgI3tzZXNzaW9uX251bWJlcn0geyfwn5S1JyBpZiByZXN1bHRfdHggPT0gJ1TDoGknIGVsc2UgJ/CflLQnfVxueycgJy5qb2luKG1hcChzdHIsIGRpY2VfdmFsdWVzKSl9ICh7dG90YWxfZGljZX0pICB7cmVzdWx0X3R4LnVwcGVyKCl9PC9iPiIKCiAgICBwcmludChmIltERUJVR10gR+G7rWkga+G6v3QgcXXhuqMgWFggxJHhur9uIG5ow7NtIHBo4bulOiB7T1RIRVJfR1JPVVBfQ0hBVF9JRH0iKQogICAgcHJpbnQoZiJbREVCVUddIE7hu5lpIGR1bmcgdGluIG5o4bqvbjoge21lc3NhZ2V9IikKCiAgICB1cmwgPSBmJ2h0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7Ym90LnRva2VufS9zZW5kTWVzc2FnZScKICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KAogICAgICAgIHVybCwKICAgICAgICBwYXJhbXM9ewogICAgICAgICAgICAnY2hhdF9pZCc6IE9USEVSX0dST1VQX0NIQVRfSUQsCiAgICAgICAgICAgICd0ZXh0JzogbWVzc2FnZSwKICAgICAgICAgICAgJ3BhcnNlX21vZGUnOiAnSFRNTCcKICAgICAgICB9CiAgICApCgogICAgcHJpbnQoZiJbREVCVUddIFN0YXR1cyBjb2RlOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IikKICAgIHByaW50KGYiW0RFQlVHXSBSZXNwb25zZSB0ZXh0OiB7cmVzcG9uc2UudGV4dH0iKQoKICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlICE9IDIwMDoKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIGvhur90IHF14bqjIFhYOiB7cmVzcG9uc2UudGV4dH0iKQoKZGVmIHNlbmRfbWQ1X25vdGlmaWNhdGlvbl9vdGhlcl9ncm91cChzZXNzaW9uX251bWJlciwgbWQ1X2hhc2gsIGtleV9tZDUpOgogICAgaWYgbm90IGtleV9tZDU6CiAgICAgICAgcHJpbnQoIltFUlJPUl0ga2V5X21kNSBi4buLIHLhu5duZy4gS2jDtG5nIHRo4buDIGfhu61pIHRow7RuZyBiw6FvLiIpCiAgICAgICAgcmV0dXJuICAKCiAgICBrZXlfbWQ1X2xhc3RfZGlnaXQgPSBrZXlfbWQ1Wy0xXQogICAgbWVzc2FnZSA9IGYiPGI+S1EgTUQ1ICN7c2Vzc2lvbl9udW1iZXJ9IHtrZXlfbWQ1X2xhc3RfZGlnaXR9PC9iPiIKCiAgICBwcmludChmIltERUJVR10gR+G7rWkgbcOjIE1ENSDEkeG6v24gbmjDs20gcGjhu6U6IHtPVEhFUl9HUk9VUF9DSEFUX0lEX01ENX0iKQogICAgcHJpbnQoZiJbREVCVUddIE7hu5lpIGR1bmcgTUQ1OiB7bWVzc2FnZX0iKQoKICAgIHVybCA9IGYnaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdHtib3QudG9rZW59L3NlbmRNZXNzYWdlJwogICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoCiAgICAgICAgdXJsLAogICAgICAgIHBhcmFtcz17CiAgICAgICAgICAgICdjaGF0X2lkJzogT1RIRVJfR1JPVVBfQ0hBVF9JRF9NRDUsCiAgICAgICAgICAgICd0ZXh0JzogbWVzc2FnZSwKICAgICAgICAgICAgJ3BhcnNlX21vZGUnOiAnSFRNTCcKICAgICAgICB9CiAgICApCgogICAgcHJpbnQoZiJbREVCVUddIFN0YXR1cyBjb2RlOiB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9IikKICAgIHByaW50KGYiW0RFQlVHXSBSZXNwb25zZSB0ZXh0OiB7cmVzcG9uc2UudGV4dH0iKQoKICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlICE9IDIwMDoKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIG3DoyBNRDU6IHtyZXNwb25zZS50ZXh0fSIpCgpkZWYgaGFuZGxlX2JldF9yZXF1ZXN0KHVzZXJfaWQsIGNoYXRfaWQsIG1lc3NhZ2VfaWQsIG1lc3NhZ2VfdGV4dCk6CiAgICBnbG9iYWwgYWNjZXB0aW5nX2JldHMKCiAgICBpZiBub3QgYWNjZXB0aW5nX2JldHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QuZGVsZXRlX21lc3NhZ2UoY2hhdF9pZCwgbWVzc2FnZV9pZCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4KCiAgICBwcm9jZXNzX2JldCh1c2VyX2lkLCBtZXNzYWdlX3RleHQpCgppbXBvcnQgdGltZQppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IHRyYWNlYmFjawppbXBvcnQgdGltZQppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBvcwppbXBvcnQgdHJhY2ViYWNrCgpkZWYgc2V0X3Jvb21fc3RhdHVzX3RydWUoKToKICAgIHRyeToKICAgICAgICByb29tX2ZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJyb29tLnR4dCIpCiAgICAgICAgd2l0aCBvcGVuKHJvb21fZmlsZV9wYXRoLCAicisiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICBpZiBjb250ZW50LnVwcGVyKCkgPT0gIkZBTFNFIjoKICAgICAgICAgICAgICAgIGYuc2VlaygwKQogICAgICAgICAgICAgICAgZi53cml0ZSgiVFJVRSIpCiAgICAgICAgICAgICAgICBmLnRydW5jYXRlKCkKICAgICAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgxJHhu5VpIHJvb20udHh0IHThu6sgRkFMU0UgdGjDoG5oIFRSVUUiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IHJvb20udHh0IHNhbmcgVFJVRToge2V9IikKCmRlZiBtYWluX2xvb3AoKToKICAgIGdsb2JhbCBjdXJyZW50X3Nlc3Npb24sIGFjY2VwdGluZ19iZXRzLCBzZXNzaW9uX3Jlc3VsdHNfdHgsIHNlc3Npb25fcmVzdWx0c19jbAogICAgbG9hZF9zZXNzaW9uX2hpc3RvcnlfZnJvbV9maWxlX3R4KCkKICAgIGxvYWRfc2Vzc2lvbl9oaXN0b3J5X2Zyb21fZmlsZV9jbCgpCiAgICB3aGlsZSBUcnVlOgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIELhuq90IMSR4bqndSBwaGnDqm4gI3tjdXJyZW50X3Nlc3Npb259IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VuZF9iZXR0aW5nX25vdGlmaWNhdGlvbnMoY3VycmVudF9zZXNzaW9uKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kg4bufIHNlbmRfYmV0dGluZ19ub3RpZmljYXRpb25zOiB7ZX0iKQogICAgICAgICAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkaWNlX3ZhbHVlcyA9IHNlbmRfZGljZV9ncm91cF9jaGF0KGdyb3VwX2NoYXRfaWQpCiAgICAgICAgICAgICAgICB0b3RhbF9kaWNlID0gc3VtKGRpY2VfdmFsdWVzKQogICAgICAgICAgICAgICAgcmVzdWx0X3R4ID0gIljhu4l1IiBpZiB0b3RhbF9kaWNlIDw9IDEwIGVsc2UgIlTDoGkiCiAgICAgICAgICAgICAgICByZXN1bHRfY2wgPSAiQ2jhurVuIiBpZiB0b3RhbF9kaWNlICUgMiA9PSAwIGVsc2UgIkzhursiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgdMOtbmgga+G6v3QgcXXhuqMgeMO6YyB44bqvYzoge2V9IikKICAgICAgICAgICAgICAgIHRyYWNlYmFjay5wcmludF9leGMoKQogICAgICAgICAgICAgICAgY29udGludWUgICMgQuG7jyBxdWEgdsOybmcgbOG6t3AgbuG6v3UgbOG7l2kg4bufIMSRw6J5CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0b3RhbF9iZXRfd2luLCB0b3RhbF9iZXRfbG9zcyA9IGNhbGN1bGF0ZV90b3RhbF93aW5uaW5nc19sb3NzZXMoY3VycmVudF9zZXNzaW9uLCByZXN1bHRfdHgsIHJlc3VsdF9jbCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIHTDrW5oIHThu5VuZyB0aOG6r25nIHRodWEgY8aw4bujYzoge2V9IikKICAgICAgICAgICAgICAgIHRyYWNlYmFjay5wcmludF9leGMoKQogICAgICAgICAgICAgICAgdG90YWxfYmV0X3dpbiA9IHRvdGFsX2JldF9sb3NzID0gMAoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbigiRklMRSIsICdodS50eHQnKSwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgICAgIHRvdGFsX2h1ID0gaW50KGZpbGUucmVhZCgpLnN0cmlwKCkpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gUmVhZCB0b3RhbF9odToge3RvdGFsX2h1fSIpCiAgICAgICAgICAgIGV4Y2VwdCAoRmlsZU5vdEZvdW5kRXJyb3IsIFZhbHVlRXJyb3IpOgogICAgICAgICAgICAgICAgdG90YWxfaHUgPSAwCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQ291bGQgbm90IHJlYWQgaHUudHh0LCBkZWZhdWx0aW5nIHRvdGFsX2h1IHRvOiB7dG90YWxfaHV9IikKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlc3Npb25fcmVzdWx0c190eC5hcHBlbmQocmVzdWx0X3R4KQogICAgICAgICAgICAgICAgc2Vzc2lvbl9yZXN1bHRzX2NsLmFwcGVuZChyZXN1bHRfY2wpCiAgICAgICAgICAgICAgICBzYXZlX3Nlc3Npb25faGlzdG9yeV90b19maWxlX3R4KCkKICAgICAgICAgICAgICAgIHNhdmVfc2Vzc2lvbl9oaXN0b3J5X3RvX2ZpbGVfY2woKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIGzGsHUgbOG7i2NoIHPhu60gcGhpw6puOiB7ZX0iKQogICAgICAgICAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCgogICAgICAgICAgICB0aW1lLnNsZWVwKDAuMSkKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbmRfcmVzdWx0X25vdGlmaWNhdGlvbnMoY3VycmVudF9zZXNzaW9uLCBkaWNlX3ZhbHVlcywgdG90YWxfZGljZSwgcmVzdWx0X3R4LCByZXN1bHRfY2wsIHRvdGFsX2JldF93aW4sIHRvdGFsX2JldF9sb3NzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIGvhur90IHF14bqjOiB7ZX0iKQogICAgICAgICAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhY2NlcHRpbmdfYmV0cyA9IFRydWUKICAgICAgICAgICAgICAgIHNldF9yb29tX3N0YXR1c190cnVlKCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfc2Vzc2lvbiArPSAxCiAgICAgICAgICAgICAgICBzYXZlX3Nlc3Npb25fdG9fZmlsZSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgcGhpw6puOiB7ZX0iKQogICAgICAgICAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSB44bqjeSByYSB0cm9uZyBtYWluX2xvb3A6IHtlfS4gxJBhbmcgdOG6o2kgbOG6oWkgY2jGsMahbmcgdHLDrG5oLi4uIikKICAgICAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKCnRhb19maWxlX21hY19kaW5oKCkKZGVmIHN0YXJ0X2JvdDIoKToKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBC4bqvdCDEkeG6p3UgcG9sbGluZyBib3QyLi4uIikKICAgICAgICAgICAgYm90LnBvbGxpbmcobm9uZV9zdG9wPVRydWUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9pbmZvID0gdHJhY2ViYWNrLmZvcm1hdF9leGMoKQoKICAgICAgICAgICAgIyBJbiBs4buXaSByYSB0ZXJtaW5hbAogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeOG6o3kgcmEgdHJvbmcgYm90LnBvbGxpbmc6IHtlfSIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBDaGkgdGnhur90IGzhu5dpOlxue2Vycm9yX2luZm99IikKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gxJBhbmcga2jhu59pIMSR4buZbmcgbOG6oWkgYm90IHNhdSA1IGdpw6J5Li4uIikKCiAgICAgICAgICAgIHRpbWUuc2xlZXAoNSkKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBwcmludCgiW0RFQlVHXSBC4bqvdCDEkeG6p3UgY2jhuqF5IGJvdC4uLiIpCiAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zdGFydF9ib3QyKS5zdGFydCgpCiAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1tYWluX2xvb3ApLnN0YXJ0KCk=').decode('utf-8'))
