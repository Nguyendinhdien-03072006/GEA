
import base64
exec(base64.b64decode('IyA9PT09PSBBVVRPIElOU1RBTEwgUkVRVUlSRUQgUEFDS0FHRVMgPT09PT0KaW1wb3J0IHN5cwppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgaW1wb3J0bGliCgpfUkVRVUlSRURfUEFDS0FHRVMgPSB7CiAgICAjIHRoZW8gecOqdSBj4bqndSBj4bunYSBi4bqhbgogICAgInRlbGVncmFtIjogInB5dGhvbi10ZWxlZ3JhbS1ib3Q9PTEzLjciLAoKICAgICMgdGVsZWJvdAogICAgInRlbGVib3QiOiAicHlUZWxlZ3JhbUJvdEFQSSIsCgogICAgIyBpbWFnZQogICAgIlBJTCI6ICJQaWxsb3ciLAoKICAgICMgdGltZXpvbmUKICAgICJweXR6IjogInB5dHoiLAoKICAgICMgaHR0cAogICAgInJlcXVlc3RzIjogInJlcXVlc3RzIiwKfQoKZGVmIGVuc3VyZV9pbXBvcnQobW9kdWxlX25hbWU6IHN0ciwgcGlwX25hbWU6IHN0cik6CiAgICB0cnk6CiAgICAgICAgcmV0dXJuIGltcG9ydGxpYi5pbXBvcnRfbW9kdWxlKG1vZHVsZV9uYW1lKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwcmludChmIltBVVRPLUlOU1RBTExdIMSQYW5nIGPDoGkge3BpcF9uYW1lfSAuLi4iKQogICAgICAgIHN1YnByb2Nlc3MuY2hlY2tfY2FsbChbc3lzLmV4ZWN1dGFibGUsICItbSIsICJwaXAiLCAiaW5zdGFsbCIsIHBpcF9uYW1lXSkKICAgICAgICByZXR1cm4gaW1wb3J0bGliLmltcG9ydF9tb2R1bGUobW9kdWxlX25hbWUpCgpmb3IgbW9kLCBwa2cgaW4gX1JFUVVJUkVEX1BBQ0tBR0VTLml0ZW1zKCk6CiAgICBlbnN1cmVfaW1wb3J0KG1vZCwgcGtnKQoKIyA9PT09PSBFTkQgQVVUTyBJTlNUQUxMID09PT09Cgpmcm9tIHRlbGVncmFtLmNvbnN0YW50cyBpbXBvcnQgUGFyc2VNb2RlCmltcG9ydCBzaHV0aWwKZnJvbSB0ZWxlZ3JhbSBpbXBvcnQgVXBkYXRlLCBSZXBseUtleWJvYXJkTWFya3VwLCBJbmxpbmVLZXlib2FyZEJ1dHRvbiwgSW5saW5lS2V5Ym9hcmRNYXJrdXAKZnJvbSB0ZWxlZ3JhbS5leHQgaW1wb3J0IFVwZGF0ZXIsIENvbW1hbmRIYW5kbGVyLCBNZXNzYWdlSGFuZGxlciwgZmlsdGVycywgQ2FsbGJhY2tDb250ZXh0CmZyb20gdGVsZWdyYW0uZXh0IGltcG9ydCBVcGRhdGVyLCBDb21tYW5kSGFuZGxlciwgQ2FsbGJhY2tRdWVyeUhhbmRsZXIKaW1wb3J0IG9zCmltcG9ydCB0ZW1wZmlsZQppbXBvcnQgc3lzCmltcG9ydCB0cmFjZWJhY2sKaW1wb3J0IHJhbmRvbQppbXBvcnQgc3RyaW5nCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gdGVsZWdyYW0uZXJyb3IgaW1wb3J0IFRlbGVncmFtRXJyb3IKaW1wb3J0IHB5dHoKaW1wb3J0IHRpbWUKaW1wb3J0IHJlCmltcG9ydCByZXF1ZXN0cwpmcm9tIHRlbGVncmFtIGltcG9ydCBLZXlib2FyZEJ1dHRvbgpmcm9tIHRlbGVncmFtIGltcG9ydCBCb3QKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUgYXMgZHQsIHRpbWV6b25lLCB0aW1lZGVsdGEKaW1wb3J0IGRhdGV0aW1lIGFzIGR0CmZyb20gZGF0ZXRpbWUgaW1wb3J0IHRpbWV6b25lCmZyb20gdGVsZWdyYW0uZXh0IGltcG9ydCBDYWxsYmFja0NvbnRleHQKaW1wb3J0IHRlbGVncmFtCmZyb20gY29uY3VycmVudC5mdXR1cmVzIGltcG9ydCBUaHJlYWRQb29sRXhlY3V0b3IKaW1wb3J0IHRocmVhZGluZwpmcm9tIHRlbGVncmFtIGltcG9ydCBJbmxpbmVLZXlib2FyZEJ1dHRvbiwgSW5saW5lS2V5Ym9hcmRNYXJrdXAsIFJlcGx5S2V5Ym9hcmRNYXJrdXAKZnJvbSB0ZWxlZ3JhbS5lcnJvciBpbXBvcnQgVGVsZWdyYW1FcnJvciwgQmFkUmVxdWVzdApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgdGltZWRlbHRhLCB0aW1lem9uZQppbXBvcnQgdHJhY2ViYWNrCmltcG9ydCB0ZWxlYm90CmZyb20gdGVsZWJvdCBpbXBvcnQgdHlwZXMKZnJvbSB0ZWxlYm90LnR5cGVzIGltcG9ydCBJbmxpbmVLZXlib2FyZEJ1dHRvbiwgSW5saW5lS2V5Ym9hcmRNYXJrdXAKZnJvbSB0ZWxlYm90LmFwaWhlbHBlciBpbXBvcnQgQXBpVGVsZWdyYW1FeGNlcHRpb24KZnJvbSB0aHJlYWRpbmcgaW1wb3J0IFRocmVhZApmcm9tIHRlbGVib3QudHlwZXMgaW1wb3J0IFJlcGx5S2V5Ym9hcmRNYXJrdXAsIEtleWJvYXJkQnV0dG9uCmZyb20gdGVsZWdyYW0gaW1wb3J0IE1lc3NhZ2UKZnJvbSB0ZWxlYm90LnR5cGVzIGltcG9ydCBDYWxsYmFja1F1ZXJ5LCBJbmxpbmVLZXlib2FyZEJ1dHRvbiwgSW5saW5lS2V5Ym9hcmRNYXJrdXAsIE1lc3NhZ2UsIEtleWJvYXJkQnV0dG9uLCBSZXBseUtleWJvYXJkTWFya3VwCmltcG9ydCBweXR6CmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmZyb20gdGVsZWJvdCBpbXBvcnQgVGVsZUJvdApmcm9tIGlvIGltcG9ydCBCeXRlc0lPCmZyb20gUElMIGltcG9ydCBJbWFnZQpmcm9tIFBJTCBpbXBvcnQgSW1hZ2UsIEltYWdlRHJhdwpmcm9tIGlvIGltcG9ydCBCeXRlc0lPCmltcG9ydCBqc29uCmltcG9ydCBqc29uCmltcG9ydCBvcwpmcm9tIGh0bWwgaW1wb3J0IGVzY2FwZQpmcm9tIHRlbGVib3QudHlwZXMgaW1wb3J0IENoYXRBZG1pbmlzdHJhdG9yUmlnaHRzCgpBRE1JTiA9IFs4MjA1NTY3ODUxXSAjIGlkIGFkbWluCkdST1VQID0gIi0xMDAzNTg5OTQyMjg3IiAjIGlkIG5ow7NtIHJvb20KQURNSU4gPSAiLTEwMDMyNDEwMDI0NzgiICMgaWQgbmjDs20gYWRtaW4KYm90ID0gdGVsZWJvdC5UZWxlQm90KCI4NTY2ODY4ODI0OkFBSGlqSEFwdjhjMzF2OVBwRVd1aDF5NmdTdWZiQldzQ1NNIikgIyB0b2tlbiBib3QgY2jDrW5oCmJvdDEgPSB0ZWxlYm90LlRlbGVCb3QoIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiKSAjIHRva2VuIGJvdCBhZG1pbgpib3QyID0gdGVsZWJvdC5UZWxlQm90KCI4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFIikgIyB0b2tlbiBib3Qgcm9vbQpib3QzID0gdGVsZWJvdC5UZWxlQm90KCI4NDkzNzAzMjk3OkFBSFNmOHdUeGlwbjdURVRQMUI5WVNXcWFSNjBHbEpzVkhjIikgIyB0b2tlbiBib3QgbuG6oXAgcsO6dApib3R0YnNvbG8gPSBUZWxlQm90KCI4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFIiwgcGFyc2VfbW9kZT0iSFRNTCIpICMgYm90IHRiIHNvbG8KTUlOSU1VTV9CRVQgPSAxMDAwCk1BWElNVU1fQkVUID0gMzAwMDAwCnRkX3R1cm5zID0ge30KdXNlcl9iZXRzID0ge30Kc3BhbV9jb3VudCA9IHt9Cmxhc3RfYmV0X3RpbWUgPSB7fQpsYXN0X3JlcGx5X3RpbWUgPSB7fQpib3Rfc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCmxhc3RfbWVzc2FnZV90aW1lID0ge30KcGVuZGluZ19iZXRzID0ge30KcGVuZGluZ19yZXN1bHRzID0ge30KbGFzdF9jYWxsYmFja190aW1lID0ge30KYm93bGluZ19iZXRzID0ge30KdXNlcl9kaWNlX3JvbGxlZCA9IHt9CnVzZXJfbGFzdF9naWZ0X3RpbWUgPSB7fQpsYXN0X3N0YXJ0X3RpbWUgPSB7fQp0ZW1wX3JlZl9kaWN0ID0ge30Kc29sb190aW1lcnMgPSB7fQphZG1pbl9hbW91bnRfc2VsZWN0aW9uID0ge30KYWRtaW5fdHJ1X2Ftb3VudCA9IHt9CnBlbmRpbmdfYWN0aW9uID0ge30KZ2FtZV9pbl9wcm9ncmVzcyA9IEZhbHNlCmFjY2VwdGluZ19iZXRzID0gVHJ1ZQpGT0xERVIgPSAiRklMRSIKb3MubWFrZWRpcnMoRk9MREVSLCBleGlzdF9vaz1UcnVlKQoKVEFOVEhVX0ZJTEUgPSAnRklMRS90YW50aHUudHh0JwpTRF9GSUxFID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNkLnR4dCIpCkJBTl9GSUxFID0gb3MucGF0aC5qb2luKCJGSUxFIiwgImJhbi50eHQiKQpIVVNMT1RfRklMRSA9IG9zLnBhdGguam9pbigiRklMRSIsICJodXNsb3QudHh0IikKU09MT19GSUxFID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNvbG8uanNvbiIpClNPTE9fTUVTU0FHRVNfRklMRSA9IG9zLnBhdGguam9pbigiRklMRSIsICJsdXVzb2xvLmpzb24iKQoKRklMRVMgPSBbCiAgICAndXNlci50eHQnLCAnc2QudHh0JywnY3VvY3RpZW4udHh0JywgJ3ZpcC50eHQnLCAndG9wY3VvYy50eHQnLCAndGhhbmd0aHVhLnR4dCcsCiAgICAnbWFuYXAudHh0JywgJ2NodW9pdGhhbmd0aHVhLnR4dCcsICdsc25hcC50eHQnLCAnbHNydXQudHh0JywKICAgICdtb21vLnR4dCcsICdiYW5rLnR4dCcsICdnaWZ0LnR4dCcsICdiYW4udHh0JywgJ2xzY2hvaS50eHQnLCAneHh0ZC50eHQnLAogICAgIm5oaWVtdnUudHh0IiwgInNhby50eHQiLCAiYm9uZy50eHQiLCAia2VvLnR4dCIsICJuZ3VvaXR1eWV0LnR4dCIsCiAgICAiY2F5dGhvbmcudHh0IiwgImNheXRob25nZGFjYmlldC50eHQiLCAiZHMudHh0IiwgInRhbnRodS50eHQiLCAiZGFuaGFudGFudGh1LnR4dCIsCiAgICAicmVmLnR4dCIsICJyZWZfdGVtcC50eHQiLCAibHNjaG9pLnR4dCIsICJ0b25naG9haG9uZy50eHQiLCAicm9vbS50eHQiLCAiZDEudHh0IiwKICAgICJkMi50eHQiLCAiZDMudHh0IiwgImQ0LnR4dCIsICJkNS50eHQiLCAiZDYudHh0IiwgImJhby50eHQiLCAic2IudHh0IiwgIm10LnR4dCIsCiAgICAibXgudHh0IiwgIm1jLnR4dCIsICJtbC50eHQiLCJodWJvbnVzLnR4dCIsICJzaWV1aHVib251cy50eHQiLCJtZXNzYWdlaWQudHh0Il0KCmlmIG5vdCBvcy5wYXRoLmV4aXN0cyhGT0xERVIpOgogICAgb3MubWFrZWRpcnMoRk9MREVSKQogICAgcHJpbnQoZiJb4pyUXSDEkMOjIHThuqFvIHRoxrAgbeG7pWM6IHtGT0xERVJ9IikKCmZvciBmaWxlX25hbWUgaW4gRklMRVM6CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oRk9MREVSLCBmaWxlX25hbWUpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAndycsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGlmIGZpbGVfbmFtZSA9PSAidGFudGh1LnR4dCI6CiAgICAgICAgICAgICAgICBmLndyaXRlKCIxMCIpCiAgICAgICAgICAgICAgICBwcmludChmIlsrXSDEkMOjIHThuqFvIHtmaWxlX25hbWV9IHbhu5tpIG7hu5lpIGR1bmc6IDEwIikKICAgICAgICAgICAgZWxpZiBmaWxlX25hbWUgPT0gInJvb20udHh0IjoKICAgICAgICAgICAgICAgIGYud3JpdGUoIlRSVUUiKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbK10gxJDDoyB04bqhbyB7ZmlsZV9uYW1lfSB24bubaSBu4buZaSBkdW5nOiBUUlVFIikKICAgICAgICAgICAgZWxpZiBmaWxlX25hbWUgPT0gImh1Ym9udXMudHh0IjoKICAgICAgICAgICAgICAgIGYud3JpdGUoIkZBTFNFIikKICAgICAgICAgICAgICAgIHByaW50KGYiWytdIMSQw6MgdOG6oW8ge2ZpbGVfbmFtZX0gduG7m2kgbuG7mWkgZHVuZzogRkFMU0UiKQogICAgICAgICAgICBlbGlmIGZpbGVfbmFtZSA9PSAic2lldWh1Ym9udXMudHh0IjoKICAgICAgICAgICAgICAgIGYud3JpdGUoIkZBTFNFIikKICAgICAgICAgICAgICAgIHByaW50KGYiWytdIMSQw6MgdOG6oW8ge2ZpbGVfbmFtZX0gduG7m2kgbuG7mWkgZHVuZzogRkFMU0UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZi53cml0ZSgiIikKICAgICAgICAgICAgICAgIHByaW50KGYiWytdIMSQw6MgdOG6oW8ge2ZpbGVfbmFtZX0gKHRy4buRbmcpIikKCmpzb25fZmlsZXMgPSBbInNvbG8uanNvbiIsICJsdXVzb2xvLmpzb24iXQpmb3IganNvbl9uYW1lIGluIGpzb25fZmlsZXM6CiAgICBqc29uX3BhdGggPSBvcy5wYXRoLmpvaW4oRk9MREVSLCBqc29uX25hbWUpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoanNvbl9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oanNvbl9wYXRoLCAndycsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcCh7fSwgZiwgZW5zdXJlX2FzY2lpPUZhbHNlLCBpbmRlbnQ9NCkKCmRlZiBnZXRfdmlldG5hbV90aW1lKCk6CiAgICB2aWV0bmFtX3RpbWV6b25lID0gdGltZXpvbmUodGltZWRlbHRhKGhvdXJzPTcpKQogICAgdmlldG5hbV90aW1lID0gZGF0ZXRpbWUubm93KHZpZXRuYW1fdGltZXpvbmUpCiAgICByZXR1cm4gdmlldG5hbV90aW1lLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCgpkZWYgZm9ybWF0X251bWJlcihuKToKICAgIHJldHVybiBmIntpbnQobik6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgpkZWYgcmVhZF9zZXNzaW9uX251bWJlcigpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbigiRklMRS9waGllbi50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIHJldHVybiBmaWxlLnJlYWRsaW5lKCkuc3RyaXAoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJldHVybiAiMCIKCmRlZiByZWFkX21hbmFwKHVzZXJfaWQpOgogICAgdHJ5OgogICAgICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJtYW5hcC50eHQiKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyDEkeG7jWMgdGjDtG5nIHRpbiBtw6MgbuG6oXAgY2hvIG5nxrDhu51pIGTDuW5nIElEOiB7dXNlcl9pZH0uIikKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgbeG7nyBmaWxlIEZJTEUvbWFuYXAudHh0LiIpCiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJBhbmcgeOG7rSBsw70gZMOybmc6IHtsaW5lLnN0cmlwKCl9IikKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCAyOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJbREVCVUddIETDsm5nIGtow7RuZyBo4bujcCBs4buHICh0aGnhur91IHRow7RuZyB0aW4gbcOjIG7huqFwKS4gQuG7jyBxdWEgZMOybmcgbsOgeS4iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBsaW5lX3VzZXJfaWQgPSBwYXJ0c1swXQogICAgICAgICAgICAgICAgaWYgbGluZV91c2VyX2lkID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBtYW5hcCA9ICcgJy5qb2luKHBhcnRzWzE6XSkKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyB0w6xtIHRo4bqleSBtw6MgbuG6oXA6IHttYW5hcH0gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBtYW5hcAogICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgbcOjIG7huqFwIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgRklMRS9tYW5hcC50eHQuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIMSR4buNYyBmaWxlIEZJTEUvbWFuYXAudHh0OiB7c3RyKGUpfSIpCiAgICByZXR1cm4gTm9uZQoKZGVmIHVwZGF0ZV9zb3RpZW4odXNlcl9pZCwgYW1vdW50KToKICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyBj4buZbmcgdGjDqm0ge2Ftb3VudH0gdsOgbyB2w60gY2jDrW5oIGPhu6dhIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSIpCgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNkLnR4dCIpCiAgICBsaW5lcyA9IFtdCiAgICB1c2VyX2ZvdW5kID0gRmFsc2UKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBsaW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIHVzZXJfZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCgogICAgICAgICAgICAgICAgaWYgbGVuKHVzZXJfZGF0YSkgPj0gMiBhbmQgdXNlcl9kYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHZpY2hpbmggPSBpbnQodXNlcl9kYXRhWzFdKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IHZpY2hpbmggKyBhbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQ+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZy4gU+G7kSBkxrAgbeG7m2k6IHtuZXdfYmFsYW5jZX0iKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgY2h1eeG7g24gxJHhu5VpIHPhu5EgdHJvbmcgZMOybmc6IHtsaW5lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUud3JpdGUobGluZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZmlsZS53cml0ZShsaW5lKQoKICAgICAgICAgICAgaWYgbm90IHVzZXJfZm91bmQ6CiAgICAgICAgICAgICAgICBmaWxlLndyaXRlKGYie3VzZXJfaWR9IHthbW91bnR9IDBcbiIpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVGjDqm0gbeG7m2kgdXNlciB7dXNlcl9pZH0gduG7m2kgc+G7kSBkxrAge2Ftb3VudH0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGPhuq1wIG5o4bqtdCBz4buRIGTGsDoge2V9IikKCmRlZiByZWFkX21hbmFwX2ZpbGUoKToKICAgIG1hbmFwX2RhdGEgPSB7fQogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgIm1hbmFwLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyOgogICAgICAgICAgICAgICAgICAgIG1hbmFwX2RhdGFbcGFydHNbMV1dID0gcGFydHNbMF0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgxJHhu41jIGZpbGUgRklMRS9tYW5hcC50eHQ6IHtlfSIpCiAgICByZXR1cm4gbWFuYXBfZGF0YQoKZGVmIHBvcF9iZXQodXNlcl9pZCk6CiAgICByZXR1cm4gcGVuZGluZ19iZXRzLnBvcCh1c2VyX2lkLCBOb25lKQoKZGVmIHNhdmVfYmV0KHVzZXJfaWQsIGFtb3VudCwgdG90YWwwLCBjdW1fb2Rkcz0xLjApOgogICAgcGVuZGluZ19iZXRzW3VzZXJfaWRdID0gKGFtb3VudCwgdG90YWwwLCBjdW1fb2RkcykKCmRlZiBzYXZlX3Jlc3VsdCh1c2VyX2lkLCBhbW91bnQsIG9kZHMsIHdpbiwgbmV3X2JhbCk6CiAgICBwZW5kaW5nX3Jlc3VsdHNbdXNlcl9pZF0gPSAoYW1vdW50LCBvZGRzLCB3aW4sIG5ld19iYWwpCgpkZWYgcG9wX3Jlc3VsdCh1c2VyX2lkKToKICAgIHJldHVybiBwZW5kaW5nX3Jlc3VsdHMucG9wKHVzZXJfaWQsIE5vbmUpCgpzeW1ib2xzX21hcCA9IFsKICAgICgnYmFyJywgICAnYmFyJyksCiAgICAoJ25obycsICAgJ2dyYXBlJyksCiAgICAoJ2NoYW5oJywgJ2xlbW9uJyksCiAgICAoJzcnLCAgICAgJ3NldmVuJyksCl0KCkJFVF9EID0gewogICAgIkRUIjogMS45NSwKICAgICJEWCI6IDEuOTUsCiAgICAiREMiOiAxLjk1LAogICAgIkRMIjogMS45NSwKfQoKV0lOX0wgPSB7CiAgICAiRFQiOiBbMTEsIDEyLCAxMywgMTQsIDE1LCAxNiwgMTcsIDE4XSwKICAgICJEWCI6IFszLCA0LCA1LCA2LCA3LCA4LCA5LCAxMF0sCiAgICAiREMiOiBbNCwgNiwgOCwgMTAsIDEyLCAxNCwgMTYsIDE4XSwKICAgICJETCI6IFszLCA1LCA3LCA5LCAxMSwgMTMsIDE1LCAxN10sCn0KCkJFVF9NVUxUSVBMSUVSUyA9IHsKICAgICJYWFQiOiAxLjk1LAogICAgIlhYWCI6IDEuOTUsCiAgICAiWFhDIjogMS45NSwKICAgICJYWEwiOiAxLjk1LAogICAgIkQxIjogNC44LAogICAgIkQyIjogNC44LAogICAgIkQzIjogNC44LAogICAgIkQ0IjogNC44LAogICAgIkQ1IjogNC44LAogICAgIkQ2IjogNC44LAp9CgpXSU5fUE9JTlRTID0gewogICAgIlhYVCI6IFs0LCA1LCA2XSwKICAgICJYWFgiOiBbMSwgMiwgM10sCiAgICAiWFhDIjogWzIsIDQsIDZdLAogICAgIlhYTCI6IFsxLCAzLCA1XSwKICAgICJEMSI6IFsxXSwKICAgICJEMiI6IFsyXSwKICAgICJEMyI6IFszXSwKICAgICJENCI6IFs0XSwKICAgICJENSI6IFs1XSwKICAgICJENiI6IFs2XSwKfQoKT0REUyA9IHsKICAgIDI6ICAoOTksICAgMS4wMSksIDM6ICAoMzAsICAgMS4wNiksIDQ6ICAoMTEsICAgMS4xNiksCiAgICA1OiAgKDUuMiwgIDEuMzIpLCA2OiAgKDMuMSwgIDEuNiksICA3OiAgKDIuMDUsIDIuMDUpLAogICAgODogICgxLjYsICAzLjEpLCAgOTogICgxLjMyLCA1LjIpLCAxMDogKDEuMTYsIDExKSwKICAgIDExOiAoMS4wNiwgMzApLCAgIDEyOiAoMS4wMSwgOTkpLAp9CgpkZWYgZm9ybWF0X2N1cnJlbmN5KGFtb3VudCk6CiAgICByZXR1cm4gZiJ7YW1vdW50Oix9Ii5yZXBsYWNlKCIsIiwgIi4iKQoKZGVmIGNvbmdkaWVtdmlwKHVzZXJfaWQ6IGludCwgYmV0X2Ftb3VudDogaW50KToKICAgICIiIgogICAgMzAwLjAwMCA9ICsxIFZJUAogICAgNjAwLjAwMCA9ICsyIFZJUAogICAgIiIiCiAgICB2aXBfYWRkID0gYmV0X2Ftb3VudCAvLyAzMDAwMDAKICAgIGlmIHZpcF9hZGQgPD0gMDoKICAgICAgICByZXR1cm4KCiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAidmlwLnR4dCIpCiAgICBvcy5tYWtlZGlycygiRklMRSIsIGV4aXN0X29rPVRydWUpCgogICAgbGluZXMgPSBbXQogICAgZm91bmQgPSBGYWxzZQoKICAgIGN1cnJlbnRfdmlwLCBtYXhfdmlwID0gZ2V0X3ZpcCh1c2VyX2lkKQogICAgbmV3X3ZpcCA9IG1pbihjdXJyZW50X3ZpcCArIHZpcF9hZGQsIG1heF92aXApCgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgcGFzcwoKICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGRhdGEgYW5kIGRhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7bmV3X3ZpcH0ge21heF92aXB9XG4iKQogICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBmLndyaXRlKGxpbmUpCgogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7bmV3X3ZpcH0ge21heF92aXB9XG4iKQoKZGVmIHVwZGF0ZV9zZCh1c2VyX2lkLCBhbW91bnRfY2hhbmdlKToKICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyBj4bqtcCBuaOG6rXQgc+G7kSBkxrAgY2hvIHVzZXJfaWQge3VzZXJfaWR9LiBUaGF5IMSR4buVaToge2Ftb3VudF9jaGFuZ2V9IikKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJzZC50eHQiKQogICAgbGluZXMgPSBbXQogICAgdXNlcl9mb3VuZCA9IEZhbHNlCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBsaW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIHVzZXJfZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4odXNlcl9kYXRhKSA+PSAyIGFuZCB1c2VyX2RhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdmljaGluaCA9IGludCh1c2VyX2RhdGFbMV0pCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld19iYWxhbmNlID0gdmljaGluaCArIGFtb3VudF9jaGFuZ2UKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQ+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZywgc+G7kSBkxrAgbeG7m2k6IHtuZXdfYmFsYW5jZX0iKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgY2h1eeG7g24gxJHhu5VpIHPhu5E6IHtsaW5lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGUud3JpdGUobGluZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZmlsZS53cml0ZShsaW5lKQogICAgICAgICAgICBpZiBub3QgdXNlcl9mb3VuZDoKICAgICAgICAgICAgICAgIGZpbGUud3JpdGUoZiJ7dXNlcl9pZH0ge2Ftb3VudF9jaGFuZ2V9XG4iKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFRow6ptIHVzZXIgbeG7m2kge3VzZXJfaWR9IHbhu5tpIHPhu5EgZMawIHthbW91bnRfY2hhbmdlfSIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IHPhu5EgZMawOiB7ZX0iKQoKZGVmIGdldF9iYWxhbmNlKHVzZXJfaWQ6IGludCkgLT4gaW50OgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNkLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKHN0cih1c2VyX2lkKSk6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgYmFsYW5jZV9zdHIgPSBwYXJ0c1sxXQogICAgICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gZmxvYXQoYmFsYW5jZV9zdHIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQoYmFsYW5jZSkKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUge2ZpbGVfcGF0aH0uIFRy4bqjIHbhu4Egc+G7kSBkxrAgPSAwLiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSDEkeG7jWMgc+G7kSBkxrAgdOG7qyB7ZmlsZV9wYXRofToge2V9IikKICAgIHJldHVybiAwCgpkZWYgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgdXBkYXRlZF9iYWxhbmNlKToKICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJzZC50eHQiKQogICAgbGluZXMgPSBbXQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyKyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICB1c2VyX2luZm8gPSBsaW5lLnN0cmlwKCkuc3BsaXQobWF4c3BsaXQ9MikKICAgICAgICAgICAgICAgIGlmIHVzZXJfaW5mb1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIHdhbGxldF9zZWNvbmRhcnkgPSB1c2VyX2luZm9bMl0gaWYgbGVuKHVzZXJfaW5mbykgPiAyIGVsc2UgIiIKICAgICAgICAgICAgICAgICAgICBpZiB3YWxsZXRfc2Vjb25kYXJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge3VwZGF0ZWRfYmFsYW5jZX0ge3dhbGxldF9zZWNvbmRhcnl9XG4iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7dXBkYXRlZF9iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUpCiAgICAgICAgICAgIGYuc2VlaygwKQogICAgICAgICAgICBmLndyaXRlbGluZXMobGluZXMpCiAgICAgICAgICAgIGYudHJ1bmNhdGUoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBGaWxlIHtmaWxlX3BhdGh9IGtow7RuZyB04buTbiB04bqhaS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IHbDrSBjaMOtbmg6IHtlfSIpCgpkZWYgdXBkYXRlX2JhbGFuY2UodXNlcl9pZCwgbmIpOgogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgbGluZXMsIHVwZCA9IFtdLCBGYWxzZQogICAgaWYgb3MucGF0aC5leGlzdHMoU0RfRklMRSk6CiAgICAgICAgd2l0aCBvcGVuKFNEX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIEwgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gTC5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIHBhcnRzIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmJ9XG4iKQogICAgICAgICAgICAgICAgICAgIHVwZCA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKEwpCiAgICBpZiBub3QgdXBkOgogICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmJ9XG4iKQogICAgd2l0aCBvcGVuKFNEX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlbGluZXMobGluZXMpCgpkZWYgYWRkX3RyZWVfdG9fdXNlcih1c2VyX2lkKToKICAgIGZpbGVwYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgImNheXRob25nLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIGxpbmVzID0gW10KCiAgICB1cGRhdGVkID0gRmFsc2UKICAgIHdpdGggb3BlbihmaWxlcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgoc3RyKHVzZXJfaWQpKToKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpbnQocGFydHNbMV0pIGlmIGxlbihwYXJ0cykgPiAxIGVsc2UgMAogICAgICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7Y3VycmVudCArIDF9XG4iKQogICAgICAgICAgICAgICAgdXBkYXRlZCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGYud3JpdGUobGluZSkKICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSAxXG4iKQoKZGVmIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGUsIGFtb3VudCwgd2luX2Ftb3VudCk6CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAibHNjaG9pLnR4dCIpCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSB7YmV0X3R5cGV9IHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfVxuIikKICAgIHVwZGF0ZV9jaHVvaV9maWxlKHVzZXJfaWQsIHdpbl9hbW91bnQpCiAgICB1cGRhdGVfdG9wY3VvYyh1c2VyX2lkLCBhbW91bnQpCiAgICB1cGRhdGVfdGhhbmd0aHVhKHVzZXJfaWQsIGFtb3VudCwgd2luX2Ftb3VudCkKCmRlZiB1cGRhdGVfY2h1b2lfZmlsZSh1c2VyX2lkLCB3aW5fYW1vdW50KToKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJjaHVvaXRoYW5ndGh1YS50eHQiKQogICAgdXNlcl9kYXRhID0gTm9uZQogICAgY2h1b2lfZGF0YSA9IFtdCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgcGFydHMgYW5kIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSBwYXJ0cwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBjaHVvaV9kYXRhLmFwcGVuZChwYXJ0cykKCiAgICAgICAgaWYgdXNlcl9kYXRhOgogICAgICAgICAgICBpZiB3aW5fYW1vdW50ID4gMDoKICAgICAgICAgICAgICAgIHVzZXJfZGF0YVsxXSA9IHN0cihpbnQodXNlcl9kYXRhWzFdKSArIDEpCiAgICAgICAgICAgICAgICB1c2VyX2RhdGFbMl0gPSAiMCIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVzZXJfZGF0YVsxXSA9ICIwIgogICAgICAgICAgICAgICAgdXNlcl9kYXRhWzJdID0gc3RyKGludCh1c2VyX2RhdGFbMl0pICsgMSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiB3aW5fYW1vdW50ID4gMDoKICAgICAgICAgICAgICAgIHVzZXJfZGF0YSA9IFtzdHIodXNlcl9pZCksICIxIiwgIjAiXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgdXNlcl9kYXRhID0gW3N0cih1c2VyX2lkKSwgIjAiLCAiMSJdCgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGRhdGEgaW4gY2h1b2lfZGF0YToKICAgICAgICAgICAgICAgIGZpbGUud3JpdGUoIiAiLmpvaW4oZGF0YSkgKyAiXG4iKQogICAgICAgICAgICBmaWxlLndyaXRlKCIgIi5qb2luKHVzZXJfZGF0YSkgKyAiXG4iKQoKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAjIE7hur91IGZpbGUgY2jGsGEgdOG7k24gdOG6oWkgdGjDrCB04bqhbyBt4bubaSB24bubaSBk4buvIGxp4buHdSB1c2VyIGhp4buHbiB04bqhaQogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgaWYgd2luX2Ftb3VudCA+IDA6CiAgICAgICAgICAgICAgICB1c2VyX2RhdGEgPSBbc3RyKHVzZXJfaWQpLCAiMSIsICIwIl0KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVzZXJfZGF0YSA9IFtzdHIodXNlcl9pZCksICIwIiwgIjEiXQogICAgICAgICAgICBmaWxlLndyaXRlKCIgIi5qb2luKHVzZXJfZGF0YSkgKyAiXG4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IGNodW9pdGhhbmd0aHVhLnR4dDoge2V9IikKCmRlZiB1cGRhdGVfdG9wY3VvYyh1c2VyX2lkLCBhbW91bnQpOgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRvcGN1b2MudHh0IikKICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgIGxpbmVzID0gW10KICAgIGZvdW5kID0gRmFsc2UKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIrIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHVzZXJfaW5mbyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiB1c2VyX2luZm8gYW5kIHVzZXJfaW5mb1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIHRvZGF5X2JldCA9IGludCh1c2VyX2luZm9bMV0pICsgYW1vdW50CiAgICAgICAgICAgICAgICAgICAgd2Vla19iZXQgPSBpbnQodXNlcl9pbmZvWzJdKSArIGFtb3VudAogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7dG9kYXlfYmV0fSB7d2Vla19iZXR9XG4iKQogICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQobGluZSkKICAgICAgICAgICAgaWYgbm90IGZvdW5kOgogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHthbW91bnR9IHthbW91bnR9XG4iKQogICAgICAgICAgICBmLnNlZWsoMCkKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQogICAgICAgICAgICBmLnRydW5jYXRlKCkKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH0ge2Ftb3VudH0ge2Ftb3VudH1cbiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdG9wY3VvYy50eHQ6IHtlfSIpCgpkZWYgdXBkYXRlX3RoYW5ndGh1YSh1c2VyX2lkLCBhbW91bnQsIHdpbl9hbW91bnQpOgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRoYW5ndGh1YS50eHQiKQogICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgbGluZXMgPSBbXQogICAgZm91bmQgPSBGYWxzZQoKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAicisiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgdXNlcl9pbmZvID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIHVzZXJfaW5mbyBhbmQgdXNlcl9pbmZvWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgdG90YWxfd2luID0gaW50KHVzZXJfaW5mb1sxXSkgKyAod2luX2Ftb3VudCAtIGFtb3VudCBpZiB3aW5fYW1vdW50ID4gYW1vdW50IGVsc2UgMCkKICAgICAgICAgICAgICAgICAgICB0b3RhbF9sb3NzID0gaW50KHVzZXJfaW5mb1syXSkgKyAoYW1vdW50IGlmIHdpbl9hbW91bnQgPT0gMCBlbHNlIDApCiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHt0b3RhbF93aW59IHt0b3RhbF9sb3NzfVxuIikKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUpCiAgICAgICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgICAgIHRvdGFsX3dpbiA9IHdpbl9hbW91bnQgLSBhbW91bnQgaWYgd2luX2Ftb3VudCA+IGFtb3VudCBlbHNlIDAKICAgICAgICAgICAgICAgIHRvdGFsX2xvc3MgPSBhbW91bnQgaWYgd2luX2Ftb3VudCA9PSAwIGVsc2UgMAogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHt0b3RhbF93aW59IHt0b3RhbF9sb3NzfVxuIikKICAgICAgICAgICAgZi5zZWVrKDApCiAgICAgICAgICAgIGYud3JpdGVsaW5lcyhsaW5lcykKICAgICAgICAgICAgZi50cnVuY2F0ZSgpCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICB0b3RhbF93aW4gPSB3aW5fYW1vdW50IC0gYW1vdW50IGlmIHdpbl9hbW91bnQgPiBhbW91bnQgZWxzZSAwCiAgICAgICAgICAgIHRvdGFsX2xvc3MgPSBhbW91bnQgaWYgd2luX2Ftb3VudCA9PSAwIGVsc2UgMAogICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IHt0b3RhbF93aW59IHt0b3RhbF9sb3NzfVxuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0aGFuZ3RodWEudHh0OiB7ZX0iKQoKZGVmIGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgaWYgdXNlcl9pZCBpbiBsYXN0X21lc3NhZ2VfdGltZToKICAgICAgICBlbGFwc2VkX3RpbWUgPSBjdXJyZW50X3RpbWUgLSBsYXN0X21lc3NhZ2VfdGltZVt1c2VyX2lkXQogICAgICAgIGlmIGVsYXBzZWRfdGltZSA8IDE6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgbGFzdF9tZXNzYWdlX3RpbWVbdXNlcl9pZF0gPSBjdXJyZW50X3RpbWUKICAgIHJldHVybiBUcnVlCgpkZWYgZGVjb2RlX3Nsb3RfdmFsdWUodmFsdWU6IGludCkgLT4gbGlzdFt0dXBsZVtzdHIsIHN0cl1dOgogICAgbiA9IHZhbHVlIC0gMQogICAgcmVzOiBsaXN0W3R1cGxlW3N0ciwgc3RyXV0gPSBbXQogICAgZm9yIF8gaW4gcmFuZ2UoMyk6CiAgICAgICAgaWR4ID0gbiAlIDQKICAgICAgICByZXMuYXBwZW5kKHN5bWJvbHNfbWFwW2lkeF0pCiAgICAgICAgbiAvLz0gNAogICAgcmV0dXJuIHJlcwoKZGVmIHVuYmFuX3VzZXIodXNlcl9pZDogaW50KSAtPiBOb25lOgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgImJhbi50eHQiKQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICBpZiBub3QgbGluZS5zdGFydHN3aXRoKGYie3VzZXJfaWR9ICIpIGFuZCBsaW5lLnN0cmlwKCkgIT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIGZpbGUud3JpdGUobGluZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjDs2Ega2jhu49pIGRhbmggc8OhY2ggYmFuOiB7ZX0iKQoKZGVmIGNoZWNrX2Jhbih1c2VyX2lkOiBpbnQpIC0+IGJvb2w6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKEJBTl9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIGJhbm5lZF91c2VycyA9IFtsaW5lLnNwbGl0KClbMF0gZm9yIGxpbmUgaW4gZmlsZS5yZWFkKCkuc3BsaXRsaW5lcygpXQogICAgICAgICAgICByZXR1cm4gc3RyKHVzZXJfaWQpIGluIGJhbm5lZF91c2VycwogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIGJhbl91c2VyKHVzZXJfaWQ6IGludCwgcmVhc29uOiBzdHIpIC0+IE5vbmU6CiAgICB3aXRoIG9wZW4oQkFOX0ZJTEUsICdhJywgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICBpZiByZWFzb246CiAgICAgICAgICAgIGZpbGUud3JpdGUoZiJ7dXNlcl9pZH0ge3JlYXNvbn1cbiIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfVxuIikKCmRlZiBrZXlib2FyZGJ1dHRvbigpOgogICAga2V5Ym9hcmQgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAga2V5Ym9hcmQucm93KCfwn46yIERhbmggc8OhY2ggR2FtZScsICfwn5GkIFTDoGkgS2hv4bqjbicpCiAgICBrZXlib2FyZC5yb3coJ/CfkrUgTuG6oXAgdGnhu4FuJywgJ/CfkrggUsO6dCB0aeG7gW4nKQogICAga2V5Ym9hcmQucm93KCfwn46WIEJYSCDwn46WJywgJ/CfjLogSG9hIEjhu5NuZycpCiAgICByZXR1cm4ga2V5Ym9hcmQKCmRlZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkOiBpbnQpIC0+IGJvb2w6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKEJBTl9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGJhbm5lZF91c2VycyA9IHtsaW5lLnNwbGl0KClbMF0gZm9yIGxpbmUgaW4gZiBpZiBsaW5lLnN0cmlwKCl9CiAgICAgICAgcmV0dXJuIHN0cih1c2VyX2lkKSBpbiBiYW5uZWRfdXNlcnMKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBnZXRfaHVzbG90X2JhbGFuY2UoKToKICAgIHRyeToKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoSFVTTE9UX0ZJTEUpOgogICAgICAgICAgICB3aXRoIG9wZW4oSFVTTE9UX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoIjEwMDAwIikKICAgICAgICAgICAgcmV0dXJuIDEwMDAwCiAgICAgICAgd2l0aCBvcGVuKEhVU0xPVF9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGJhbGFuY2UgPSBmLnJlYWQoKS5zdHJpcCgpCiAgICAgICAgICAgIHJldHVybiBpbnQoYmFsYW5jZSkgaWYgYmFsYW5jZS5pc2RpZ2l0KCkgZWxzZSAwCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAwCgpkZWYgZGRzZChhbW91bnQpOgogICAgcmV0dXJuIGYie2Ftb3VudDosfSIucmVwbGFjZSgiLCIsICIuIikKCmRlZiBmb3JtYXRfYmFsYW5jZShiYWxhbmNlOiBpbnQpIC0+IHN0cjoKICAgIHJldHVybiBmb3JtYXQoYmFsYW5jZSwgIiwiKS5yZXBsYWNlKCIsIiwgIi4iKQoKZGVmIGZpeHNkKGFtb3VudCk6CiAgICByZXR1cm4gIns6LC4wZn0iLmZvcm1hdChhbW91bnQpLnJlcGxhY2UoIiwiLCAiLiIpCgpkZWYgZ2V0X3ZpY2hpbmgodXNlcl9pZDogaW50KSAtPiBpbnQ6CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAic2QudHh0IikKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiAwCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+PSAyIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRhdGFbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIDAKCmRlZiBnZXRfYmV0X3RvZGF5KHVzZXJfaWQ6IGludCkgLT4gaW50OgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRvcGN1b2MudHh0IikKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiAwCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGRhdGEgYW5kIGRhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQoZGF0YVsxXSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICByZXR1cm4gMAoKZGVmIGdldF9iZXRfd2Vlayh1c2VyX2lkOiBpbnQpIC0+IGludDoKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ0b3BjdW9jLnR4dCIpCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICByZXR1cm4gMAogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4oZGF0YSkgPj0gMyBhbmQgZGF0YVswXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChkYXRhWzJdKQogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgIHJldHVybiAwCgpkZWYgZ2V0X3dpbih1c2VyX2lkOiBpbnQpIC0+IGludDoKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ0aGFuZ3RodWEudHh0IikKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiAwCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+PSAyIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRhdGFbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIDAKCmRlZiBnZXRfbG9zcyh1c2VyX2lkOiBpbnQpIC0+IGludDoKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ0aGFuZ3RodWEudHh0IikKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiAwCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+PSAzIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRhdGFbMl0pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIDAKCmRlZiBnZXRfbWFuYXAodXNlcl9pZDogaW50KSAtPiBzdHI6CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAibWFuYXAudHh0IikKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICBkYXRhID0gbGluZS5zdHJpcCgpLnNwbGl0KCIgIiwgMSkKICAgICAgICAgICAgICAgIGlmIGxlbihkYXRhKSA9PSAyIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVsxXQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHBhc3MKICAgIHJldHVybiAiIgoKZGVmIGdldF92aXAodXNlcl9pZDogaW50KSAtPiB0dXBsZVtpbnQsIGludF06CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAidmlwLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBkYXRhIGFuZCBkYXRhWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oZGF0YSkgPj0gMzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChkYXRhWzFdKSwgaW50KGRhdGFbMl0pCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgcGFzcwogICAgcmV0dXJuIDAsIDAKCmRlZiB1cGRhdGVfdmlwKHVzZXJfaWQ6IGludCwgbmV3X2xldmVsOiBpbnQsIG5ld19wb2ludHM6IGludCkgLT4gTm9uZToKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ2aXAudHh0IikKICAgIHVwZGF0ZWRfbGluZXMgPSBbXQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgZGF0YSBhbmQgZGF0YVswXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19sZXZlbH0ge25ld19wb2ludHN9XG4iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChsaW5lKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHBhc3MKICAgIGlmIG5vdCBhbnkobGluZS5zdGFydHN3aXRoKHN0cih1c2VyX2lkKSArICIgIikgZm9yIGxpbmUgaW4gdXBkYXRlZF9saW5lcyk6CiAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19sZXZlbH0ge25ld19wb2ludHN9XG4iKQogICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgIGZpbGUud3JpdGVsaW5lcyh1cGRhdGVkX2xpbmVzKQoKZGVmIGdldF93aW5fbG9zc19zdHJlYWsodXNlcl9pZDogaW50KSAtPiB0dXBsZVtpbnQsIGludF06CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAiY2h1b2l0aGFuZ3RodWEudHh0IikKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICBkYXRhID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGRhdGEgYW5kIGRhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KGRhdGFbMV0pLCBpbnQoZGF0YVsyXSkKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwYXNzCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIMSR4buNYyBjaHVvaXRoYW5ndGh1YS50eHQ6IHtlfSIpCiAgICByZXR1cm4gMCwgMAoKZGVmIGNoZWNrX3VzZXJfdW5sb2NrKHVzZXJfaWQ6IHN0cikgLT4gYm9vbDoKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ0b3BjdW9jLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmaWxlOgogICAgICAgICAgICAgICAgZGF0YSA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBkYXRhIGFuZCBkYXRhWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9jdW9jID0gaW50KGRhdGFbMV0pCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0b3RhbF9jdW9jID49IDUwMDAwCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSDEkeG7jWMgdG9wY3VvYy50eHQ6IHtlfSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgZ2V0X2RldHVfY291bnQodXNlcl9pZCk6CiAgICBkZXR1X2NvdW50ID0gMAogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInJlZi50eHQiKQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAiKQogICAgICAgICAgICAgICAgaWYgbGVuKGRhdGEpID49IDIgYW5kIGRhdGFbMV0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIGRldHVfY291bnQgKz0gMQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHBhc3MKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIMSR4buNYyByZWYudHh0OiB7ZX0iKQogICAgcmV0dXJuIGRldHVfY291bnQKCmRlZiBnZXRfcmVmX2luZm8odXNlcl9pZCk6CiAgICB1c2VyX2lkID0gc3RyKHVzZXJfaWQpCiAgICBmaWxlcGF0aCA9ICJGSUxFL3Rvbmdob2Fob25nLnR4dCIKICAgIGhvYV9ob25nX2hvbV9uYXkgPSAwCiAgICBob2FfaG9uZ190dWFuX25heSA9IDAKCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlcGF0aCk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBob2FfaG9uZ19ob21fbmF5ID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgICAgICBob2FfaG9uZ190dWFuX25heSA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICBob2FfaG9uZ190b25nID0gaG9hX2hvbmdfdHVhbl9uYXkKCiAgICByZXR1cm4gaG9hX2hvbmdfaG9tX25heSwgaG9hX2hvbmdfdHVhbl9uYXksIGhvYV9ob25nX3RvbmcKCmRlZiBjaGVja191c2VyX2V4aXN0cyh1c2VyX2lkKToKICAgIGZpbGVfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJ1c2VyLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgaWYgc3RyKHVzZXJfaWQpIGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBhZGRfdXNlcl90b19maWxlKHVzZXJfaWQpOgogICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInVzZXIudHh0IikKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH1cbiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBnaGkgdXNlci50eHQ6IHtlfSIpCgpkZWYgc2V0X3JlZmVycmVyKHVzZXJfaWQsIHJlZl9pZCk6CiAgICByZWZfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJyZWYudHh0IikKICAgIGhvYWhvbmdfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJob2Fob25nLnR4dCIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHJlZl9wYXRoLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH0ge3JlZl9pZH1cbiIpCiAgICAgICAgd2l0aCBvcGVuKGhvYWhvbmdfcGF0aCwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IDAgMCAwXG4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ2hpIGZpbGUgcmVmIGhv4bq3YyBob2Fob25nOiB7ZX0iKQoKZGVmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICB3YXJuaW5nX3RocmVzaG9sZHMgPSBbNSwgMTAsIDE1XQogICAgcHJpbnQoZiJbREVCVUddIEtp4buDbSB0cmEgc3BhbSBjaG8gdXNlciBJRDoge3VzZXJfaWR9LCBUaOG7nWkgZ2lhbiBoaeG7h24gdOG6oWk6IHtjdXJyZW50X3RpbWV9IikKCiAgICBpZiB1c2VyX2lkIGluIGxhc3RfcmVwbHlfdGltZToKICAgICAgICBsYXN0X21zZ190aW1lID0gbGFzdF9yZXBseV90aW1lW3VzZXJfaWRdCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRo4budaSBnaWFuIHRpbiBuaOG6r24gdHLGsOG7m2MgY+G7p2EgdXNlciB7dXNlcl9pZH06IHtsYXN0X21zZ190aW1lfSIpCgogICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIGxhc3RfbXNnX3RpbWUgPCAxOgogICAgICAgICAgICBpZiB1c2VyX2lkIG5vdCBpbiBzcGFtX2NvdW50OgogICAgICAgICAgICAgICAgc3BhbV9jb3VudFt1c2VyX2lkXSA9IDAKICAgICAgICAgICAgc3BhbV9jb3VudFt1c2VyX2lkXSArPSAxCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSBn4butaSB0aW4gbmjhuq9uIHF1w6EgbmhhbmguIFThu5VuZyBz4buRIGzhuqduIHNwYW06IHtzcGFtX2NvdW50W3VzZXJfaWRdfSIpCgogICAgICAgICAgICBpZiBzcGFtX2NvdW50W3VzZXJfaWRdIGluIHdhcm5pbmdfdGhyZXNob2xkczoKICAgICAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgdGV4dD0iQuG6oW4gxJFhbmcgdGhhbyB0w6FjIHF1w6EgbmhhbmgsIHZ1aSBsw7JuZyDEkeG7o2kgNXMgc2F1IG3hu5tpIHRp4bq/cCB04bulYyB0aGFvIHTDoWMgdHLDoW5oIGLhu4sga2hvw6EgdMOgaSBraG/huqNuIHbEqW5oIHZp4buFbiIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBD4bqjbmggYsOhbyBzcGFtIGfhu61pIMSR4bq/biB1c2VyIHt1c2VyX2lkfSIpCgogICAgICAgICAgICBlbGlmIHNwYW1fY291bnRbdXNlcl9pZF0gPT0gMjA6CiAgICAgICAgICAgICAgICBiYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSDEkcOjIMSR4bqhdCBuZ8aw4buhbmcgc3BhbSAyMC4gQuG6r3QgxJHhuqd1IGtow7NhIHTDoGkga2hv4bqjbi4iKQoKICAgICAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9iYW4udHh0IiwgImEiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH0gU3BhbSBCT1RcbiIpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gxJHDoyBi4buLIHRow6ptIHbDoG8gZGFuaCBzw6FjaCBi4buLIGPhuqVtLiIpCgogICAgICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgICAgICB0ZXh0PWYiVMOgaSBraG/huqNuIGPhu6dhIGLhuqFuIMSRw6MgYuG7iyBraG/DoSwgc+G7kSBkxrAgaGnhu4duIHThuqFpIHtmb3JtYXRfYmFsYW5jZShiYWxhbmNlKX1cbkzDvSBkbzogPGI+U3BhbSBCT1Q8L2I+XG5WdWkgbMOybmcgbGnDqm4gaOG7hyBhZG1pbiDEkeG7gyBt4bufIGtow7NhIiwKICAgICAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gR+G7rWkgdGjDtG5nIGLDoW8ga2jDs2EgdMOgaSBraG/huqNuIMSR4bq/biB1c2VyIHt1c2VyX2lkfSIpCgogICAgICAgICAgICAgICAgbm90aWZ5X2JvdCA9IHRlbGVib3QuVGVsZUJvdCgiODIzNDU1NzI0NjpBQUh0aTRLa0xtYTQ1V2Q3N3k2WVdqVm9DSk9kazc1MWRpRSIpCiAgICAgICAgICAgICAgICBub3RpZnlfbWVzc2FnZSA9ICgKICAgICAgICAgICAgICAgICAgICBmIktow7NhIHTDoGkga2hv4bqjbiB7dXNlcl9pZH0gdHLDqm4gdG/DoG4gc2V2ZXJcbiIKICAgICAgICAgICAgICAgICAgICBmIkzDvSBkbzogPGI+U3BhbSBCT1Q8L2I+IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgbm90aWZ5X2JvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICAgICAgY2hhdF9pZD0iLTEwMDM1ODk5NDIyODciLAogICAgICAgICAgICAgICAgICAgIHRleHQ9bm90aWZ5X21lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyBraMOzYSB0w6BpIGtob+G6o24gdXNlciB7dXNlcl9pZH0gbMOqbiBuaMOzbSBhZG1pbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgZWxzZToKICAgICAgICBzcGFtX2NvdW50W3VzZXJfaWRdID0gMAogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaGnhur90IGzhuq1wIGLhu5kgxJHhur9tIHNwYW0gY2hvIHVzZXIge3VzZXJfaWR9IHbhu4EgMCIpCgogICAgbGFzdF9yZXBseV90aW1lW3VzZXJfaWRdID0gY3VycmVudF90aW1lCiAgICBwcmludChmIltERUJVR10gQ+G6rXAgbmjhuq10IHRo4budaSBnaWFuIGfhu61pIHRpbiBuaOG6r24gY3Xhu5FpIGPDuW5nIGPhu6dhIHVzZXIge3VzZXJfaWR9OiB7Y3VycmVudF90aW1lfSIpCiAgICByZXR1cm4gRmFsc2UKCmRlZiB3cml0ZV90b19maWxlcyh1c2VyX2lkKToKICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWQpCiAgICBmb2xkZXIgPSAiRklMRSIKICAgIG9zLm1ha2VkaXJzKGZvbGRlciwgZXhpc3Rfb2s9VHJ1ZSkKICAgIGRlZiBlbnN1cmVfZmlsZV9leGlzdHMoZmlsZW5hbWUsIGRlZmF1bHRfY29udGVudD0iIik6CiAgICAgICAgZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKGZvbGRlciwgZmlsZW5hbWUpCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoZGVmYXVsdF9jb250ZW50KQogICAgICAgIHJldHVybiBmaWxlX3BhdGgKICAgIGZpbGVzX3dpdGhfZGVmYXVsdHMgPSB7CiAgICAgICAgInVzZXIudHh0IjogIiIsCiAgICAgICAgInNkLnR4dCI6ICIiLAogICAgICAgICJ2aXAudHh0IjogIiIsCiAgICAgICAgInRvcGN1b2MudHh0IjogIiIsCiAgICAgICAgInRoYW5ndGh1YS50eHQiOiAiIiwKICAgICAgICAibWFuYXAudHh0IjogIiIsCiAgICAgICAgImNodW9pdGhhbmd0aHVhLnR4dCI6ICIiLAogICAgICAgICJuaGllbXZ1LnR4dCI6ICIiLAogICAgICAgICJsc2Nob2kudHh0IjogIiIsCiAgICAgICAgImJhbi50eHQiOiAiIiwKICAgICAgICAic2FvLnR4dCI6ICIiLAogICAgICAgICJiYW5rLnR4dCI6ICIiLAogICAgICAgICJtb21vLnR4dCI6ICIiLAogICAgICAgICJib25nLnR4dCI6ICIiLAogICAgICAgICJrZW8udHh0IjogIiIsCiAgICAgICAgIm5ndW9pdHV5ZXQudHh0IjogIiIsCiAgICAgICAgImNheXRob25nLnR4dCI6ICIiLAogICAgICAgICJjYXl0aG9uZ2RhY2JpZXQudHh0IjogIiIsCiAgICAgICAgInh4dGQudHh0IjogIiIsCiAgICAgICAgImRzLnR4dCI6ICIiCiAgICAgICAgfQogICAgZmlsZV9wYXRocyA9IHt9CiAgICBmb3IgZmlsZSwgZGVmYXVsdF9jb250ZW50IGluIGZpbGVzX3dpdGhfZGVmYXVsdHMuaXRlbXMoKToKICAgICAgICBmaWxlX3BhdGhzW2ZpbGVdID0gZW5zdXJlX2ZpbGVfZXhpc3RzKGZpbGUsIGRlZmF1bHRfY29udGVudCkKICAgIGRlZiBmaWxlX2NvbnRhaW5zKGZpbGVfcGF0aCwgdGV4dCk6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICByZXR1cm4gdGV4dCBpbiBmLnJlYWQoKQogICAgaWYgbm90IGZpbGVfY29udGFpbnMoZmlsZV9wYXRoc1sidXNlci50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGhzWyJ1c2VyLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9XG4iKQoKICAgIGlmIG5vdCBmaWxlX2NvbnRhaW5zKGZpbGVfcGF0aHNbInNkLnR4dCJdLCB1c2VyX2lkX3N0cik6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aHNbInNkLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IDBcbiIpCgogICAgaWYgbm90IGZpbGVfY29udGFpbnMoZmlsZV9wYXRoc1sidmlwLnR4dCJdLCB1c2VyX2lkX3N0cik6CiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aHNbInZpcC50eHQiXSwgJ2EnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWRfc3RyfSAwIDBcbiIpCgogICAgaWYgbm90IGZpbGVfY29udGFpbnMoZmlsZV9wYXRoc1sidG9wY3VvYy50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGhzWyJ0b3BjdW9jLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IDAgMFxuIikKCiAgICBpZiBub3QgZmlsZV9jb250YWlucyhmaWxlX3BhdGhzWyJ0aGFuZ3RodWEudHh0Il0sIHVzZXJfaWRfc3RyKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoc1sidGhhbmd0aHVhLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IDAgMFxuIikKCiAgICBpZiBub3QgZmlsZV9jb250YWlucyhmaWxlX3BhdGhzWyJtYW5hcC50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIG1hbmFwX2NvZGUgPSBnZW5lcmF0ZV9tYW5hcCgpCiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aHNbIm1hbmFwLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IHttYW5hcF9jb2RlfVxuIikKCiAgICBpZiBub3QgZmlsZV9jb250YWlucyhmaWxlX3BhdGhzWyJjaHVvaXRoYW5ndGh1YS50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGhzWyJjaHVvaXRoYW5ndGh1YS50eHQiXSwgJ2EnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWRfc3RyfSAwIDBcbiIpCgogICAgaWYgbm90IGZpbGVfY29udGFpbnMoZmlsZV9wYXRoc1sibmhpZW12dS50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGhzWyJuaGllbXZ1LnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IDBcbiIpCgogICAgaWYgbm90IGZpbGVfY29udGFpbnMoZmlsZV9wYXRoc1sieHh0ZC50eHQiXSwgdXNlcl9pZF9zdHIpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGhzWyJ4eHRkLnR4dCJdLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF9zdHJ9IDBcbiIpCgpkZWYgZ2VuZXJhdGVfbWFuYXAoKToKICAgIHJldHVybiAiVElOSExJTkgiICsgJycuam9pbihyYW5kb20uY2hvaWNlcyhzdHJpbmcuYXNjaWlfdXBwZXJjYXNlICsgc3RyaW5nLmRpZ2l0cywgaz04KSkKCmRlZiBzYXZlX3JlZl90ZW1wKHVzZXJfaWQsIHJlZl9pZCk6CiAgICB0ZW1wX3JlZl9kaWN0W3N0cih1c2VyX2lkKV0gPSByZWZfaWQKICAgIHByaW50KGYiW0RFQlVHXSBMxrB1IHJlZiB04bqhbSBjaG8gdXNlciB7dXNlcl9pZH06IHtyZWZfaWR9IikKCmRlZiBnZXRfcmVmX3RlbXAodXNlcl9pZCk6CiAgICByZXR1cm4gdGVtcF9yZWZfZGljdC5wb3Aoc3RyKHVzZXJfaWQpLCBOb25lKQoKIiIiZGVmIGdldF9waG9uZV9udW1iZXIodXNlcl9pZCk6CiAgICBmaWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAiY2hlY2tzbXMudHh0IikKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHJldHVybiBOb25lCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0c1sxXQogICAgcmV0dXJuIE5vbmUiIiIKCmRlZiBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgYW1vdW50KToKICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgIHJlZmVycmVyX2lkID0gTm9uZQogICAgcmVmX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAicmVmLnR4dCIpCiAgICBzZF9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNkLnR4dCIpCiAgICB0b25naG9haG9uZ19wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRvbmdob2Fob25nLnR4dCIpCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhyZWZfcGF0aCk6CiAgICAgICAgd2l0aCBvcGVuKHJlZl9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgcmVmZXJyZXJfaWQgPSBwYXJ0c1sxXQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICBpZiBub3QgcmVmZXJyZXJfaWQ6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBuZ8aw4budaSBnaeG7m2kgdGhp4buHdSBjaG8gdXNlciB7dXNlcl9pZH0iKQogICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIHJlZmVycmVyX2lkID0gc3RyKHJlZmVycmVyX2lkKQogICAgICAgIGhvYWhvbmcgPSBpbnQoYW1vdW50ICogMC4wMikKICAgICAgICB1cGRhdGVkX3NkID0gRmFsc2UKICAgICAgICBzZF9saW5lcyA9IFtdCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2RfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihzZF9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBwYXJ0cyBhbmQgcGFydHNbMF0gPT0gcmVmZXJyZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpbnQoZmxvYXQocGFydHNbMV0pKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gMAogICAgICAgICAgICAgICAgICAgICAgICBuZXdfYmFsID0gY3VycmVudCArIGhvYWhvbmcKICAgICAgICAgICAgICAgICAgICAgICAgc2RfbGluZXMuYXBwZW5kKGYie3JlZmVycmVyX2lkfSB7bmV3X2JhbH1cbiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfc2QgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBD4buZbmcgMiUgKHtob2Fob25nfSkgY2hvIHJlZmVycmVyIHtyZWZlcnJlcl9pZH0gdsOgbyBzZC50eHQiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNkX2xpbmVzLmFwcGVuZChsaW5lIGlmIGxpbmUuZW5kc3dpdGgoJ1xuJykgZWxzZSBsaW5lICsgJ1xuJykKICAgICAgICBpZiBub3QgdXBkYXRlZF9zZDoKICAgICAgICAgICAgc2RfbGluZXMuYXBwZW5kKGYie3JlZmVycmVyX2lkfSB7aG9haG9uZ31cbiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBU4bqhbyBt4bubaSB2w6AgY+G7mW5nIDIlICh7aG9haG9uZ30pIGNobyByZWZlcnJlciB7cmVmZXJyZXJfaWR9IHbDoG8gc2QudHh0IikKICAgICAgICB3aXRoIG9wZW4oc2RfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlbGluZXMoc2RfbGluZXMpCiAgICAgICAgdXBkYXRlZF90b25nID0gRmFsc2UKICAgICAgICB0b25nX2xpbmVzID0gW10KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0b25naG9haG9uZ19wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHRvbmdob2Fob25nX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIHBhcnRzIGFuZCBwYXJ0c1swXSA9PSByZWZlcnJlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmdheSA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR1YW4gPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5nYXkgPSB0dWFuID0gMAogICAgICAgICAgICAgICAgICAgICAgICBuZXdfbmdheSA9IG5nYXkgKyBob2Fob25nCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld190dWFuID0gdHVhbiArIGhvYWhvbmcKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZ19saW5lcy5hcHBlbmQoZiJ7cmVmZXJyZXJfaWR9IHtuZXdfbmdheX0ge25ld190dWFufVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF90b25nID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gK3tob2Fob25nfSB2w6BvIHThu5VuZyBob2EgaOG7k25nIHJlZmVycmVyIHtyZWZlcnJlcl9pZH0iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmdfbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgnXG4nKSBlbHNlIGxpbmUgKyAnXG4nKQogICAgICAgIGlmIG5vdCB1cGRhdGVkX3Rvbmc6CiAgICAgICAgICAgIHRvbmdfbGluZXMuYXBwZW5kKGYie3JlZmVycmVyX2lkfSB7aG9haG9uZ30ge2hvYWhvbmd9XG4iKQogICAgICAgICAgICBwcmludChmIltERUJVR10gVOG6oW8gbeG7m2kgcmVmZXJyZXIge3JlZmVycmVyX2lkfSB0cm9uZyB0b25naG9haG9uZy50eHQgduG7m2kge2hvYWhvbmd9IikKICAgICAgICB3aXRoIG9wZW4odG9uZ2hvYWhvbmdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlbGluZXModG9uZ19saW5lcykKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgY+G7mW5nIGhvYSBo4buTbmcgY2hvIHtyZWZlcnJlcl9pZH06IHtlfSIpCgpkZWYgaXNfdXNlcl9pbl9zb2xvX3Jvb20odXNlcl9pZCk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoU09MT19GSUxFKToKICAgICAgICByZXR1cm4gRmFsc2UsIE5vbmUsIE5vbmUsIDAKICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCiAgICBmb3IgY29kZSwgaW5mbyBpbiBkYXRhLml0ZW1zKCk6CiAgICAgICAgaWYgaW5mby5nZXQoInN0YXR1cyIpID09ICIyLzIiIGFuZCAoaW5mby5nZXQoInVzZXJfaWQiKSA9PSB1c2VyX2lkIG9yIGluZm8uZ2V0KCJ1c2VyX2pvaW4iKSA9PSB1c2VyX2lkKToKICAgICAgICAgICAgYW1vdW50ID0gaW5mby5nZXQoImFtb3VudCIsIDApCiAgICAgICAgICAgIHJldHVybiBUcnVlLCBjb2RlLCBpbmZvLCBhbW91bnQKICAgIHJldHVybiBGYWxzZSwgTm9uZSwgTm9uZSwgMAoKZGVmIGlzX3VzZXJfaW5fbG5fYmV0KHVzZXJfaWQpOgogICAgYmV0ID0gdXNlcl9iZXRzLmdldCh1c2VyX2lkKQogICAgaWYgYmV0IGFuZCBpc2luc3RhbmNlKGJldCwgZGljdCk6CiAgICAgICAgcmV0dXJuIFRydWUsIGJldC5nZXQoJ2JldF9hbW91bnQnLCAwKQogICAgcmV0dXJuIEZhbHNlLCAwCgpkZWYgZW5kX3R1cm5fZm9yX3VzZXIodXNlcl9pZCk6CiAgICAiIiJSZXNldCB0cuG6oW5nIHRow6FpIGPGsOG7o2MgdsOgIGPDoWMgY+G7nSDEkeG7gyB1c2VyIGPDsyB0aOG7gyBjxrDhu6NjIHRp4bq/cC4iIiIKICAgIHVzZXJfYmV0cy5wb3AodXNlcl9pZCwgTm9uZSkKICAgIHVzZXJfZGljZV9yb2xsZWQucG9wKHVzZXJfaWQsIE5vbmUpCiAgICBwcmludChmIltERUJVR10gxJDDoyByZXNldCB0cuG6oW5nIHRow6FpIGPGsOG7o2MgY2hvIHVzZXIge3VzZXJfaWR9IikKCmRlZiBsdXV2YW9zb2xveHgodXNlcl9pZCwgbWFfZnVsbCwgYW1vdW50KToKICAgIGRhdGEgPSB7fQogICAgaWYgb3MucGF0aC5leGlzdHMoU09MT19GSUxFKToKICAgICAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgIGRhdGFbbWFfZnVsbF0gPSB7CiAgICAgICAgInVzZXJfaWQiOiB1c2VyX2lkLAogICAgICAgICJhbW91bnQiOiBhbW91bnQsCiAgICAgICAgInN0YXR1cyI6ICIxLzIiLAogICAgICAgICJ1c2VyX2pvaW4iOiAiIiwKICAgICAgICAidXNlcl93aW4iOiAiIiwKICAgICAgICAidGltZSI6IGludCh0aW1lLnRpbWUoKSkKICAgIH0KICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBqc29uLmR1bXAoZGF0YSwgZiwgaW5kZW50PTIsIGVuc3VyZV9hc2NpaT1GYWxzZSkKICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGzGsHUgcGjDsm5nIFNPTE8ge21hX2Z1bGx9IGNobyB1c2VyIHt1c2VyX2lkfSB2w6BvIGZpbGUiKQoKZGVmIGx1dXNvbG8ocm9vbV9jb2RlLCBtZXNzYWdlX2lkKToKICAgIHRyeToKICAgICAgICBkYXRhID0ge30KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhTT0xPX01FU1NBR0VTX0ZJTEUpOgogICAgICAgICAgICB3aXRoIG9wZW4oU09MT19NRVNTQUdFU19GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCgogICAgICAgIGRhdGFbcm9vbV9jb2RlXSA9IG1lc3NhZ2VfaWQKICAgICAgICB3aXRoIG9wZW4oU09MT19NRVNTQUdFU19GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbTOG7lkldIEtow7RuZyB0aOG7gyBsxrB1IFNPTE9fTUVTU0FHRSB7cm9vbV9jb2RlfToge2V9IikKCmRlZiB4b2Fzb2xvKHJvb21fY29kZSk6CiAgICB0cnk6CiAgICAgICAgZ3JvdXBfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhTT0xPX01FU1NBR0VTX0ZJTEUpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgd2l0aCBvcGVuKFNPTE9fTUVTU0FHRVNfRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCgogICAgICAgIGlmIHJvb21fY29kZSBpbiBkYXRhOgogICAgICAgICAgICBtZXNzYWdlX2lkID0gZGF0YVtyb29tX2NvZGVdCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJvdHRic29sby5kZWxldGVfbWVzc2FnZShncm91cF9pZCwgbWVzc2FnZV9pZCkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHjDs2EgdGluIG5o4bqvbiBTT0xPIHBow7JuZyB7cm9vbV9jb2RlfSBraOG7j2kgbmjDs20uIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBkZWxfZXJyOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbTOG7lkldIEtow7RuZyB0aOG7gyB4w7NhIG1lc3NhZ2VfaWQge21lc3NhZ2VfaWR9IHRyb25nIG5ow7NtOiB7ZGVsX2Vycn0iKQoKICAgICAgICAgICAgZGVsIGRhdGFbcm9vbV9jb2RlXQogICAgICAgICAgICB3aXRoIG9wZW4oU09MT19NRVNTQUdFU19GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBqc29uLmR1bXAoZGF0YSwgZiwgaW5kZW50PTIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0zhu5ZJXSBLaMO0bmcgdGjhu4MgeOG7rSBsw70geG9hc29sbyh7cm9vbV9jb2RlfSk6IHtlfSIpCgpkZWYgdGJzb2xveHgocm9vbV9jb2RlLCB1c2VyMSwgdXNlcjIsIHh4MSwgeHgyLCB0aWVuX3RoYW5nKToKICAgIHRyeToKICAgICAgICBncm91cF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICAgICAgZGVmIGYoeCk6IHJldHVybiAiezosfSIuZm9ybWF0KHgpLnJlcGxhY2UoIiwiLCAiLiIpCiAgICAgICAgaWYgeHgxID09IHh4MjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdTEgPSBmIjx0Zy1zcG9pbGVyPjxhIGhyZWY9J3RnOi8vdXNlcj9pZD17dXNlcjF9Jz57dXNlcjF9PC9hPjwvdGctc3BvaWxlcj4iCiAgICAgICAgdTIgPSBmIjx0Zy1zcG9pbGVyPjxhIGhyZWY9J3RnOi8vdXNlcj9pZD17dXNlcjJ9Jz57dXNlcjJ9PC9hPjwvdGctc3BvaWxlcj4iCgogICAgICAgIGlmIHh4MSA+IHh4MjoKICAgICAgICAgICAgd2lubmVyX2luZm8gPSBmInt1MX0gS1Eg8J+OsiB7eHgxfSB0aOG6r25nIDxiPuKchSB7Zih0aWVuX3RoYW5nKX3EkTwvYj4iCiAgICAgICAgICAgIGxvc2VyX2luZm8gPSBmInt1Mn0gS1Eg8J+OsiB7eHgyfSB0aOG6r25nIDxiPuKchSBW4bqrbiBsw6AgY8OhaSBu4buLdCB0aMO0aTwvYj4iCiAgICAgICAgZWxzZToKICAgICAgICAgICAgd2lubmVyX2luZm8gPSBmInt1Mn0gS1Eg8J+OsiB7eHgyfSB0aOG6r25nIDxiPuKchSB7Zih0aWVuX3RoYW5nKX3EkTwvYj4iCiAgICAgICAgICAgIGxvc2VyX2luZm8gPSBmInt1MX0gS1Eg8J+OsiB7eHgxfSB0aOG6r25nIDxiPuKchSBW4bqrbiBsw6AgY8OhaSBu4buLdCB0aMO0aTwvYj4iCiAgICAgICAgcm9vbV9uYW1lID0gcm9vbV9jb2RlLnNwbGl0KCctJylbMF0KICAgICAgICBtZXNzYWdlID0gKAogICAgICAgICAgICBmIlBow7JuZyBzb2xve3Jvb21fbmFtZX1cbiIKICAgICAgICAgICAgZiJ7d2lubmVyX2luZm99XG4iCiAgICAgICAgICAgIGYie2xvc2VyX2luZm99IikKICAgICAgICBib3R0YnNvbG8uc2VuZF9tZXNzYWdlKGdyb3VwX2lkLCBtZXNzYWdlLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltM4buWSV0gS2jDtG5nIHRo4buDIGfhu61pIHRic29sb3h4IHBow7JuZyB7cm9vbV9jb2RlfToge2V9IikKCmRlZiB0YnNvbG8odXNlcl9pZCwgbWFfZnVsbCwgYW1vdW50KToKICAgIHRyeToKICAgICAgICBncm91cF9pZCA9IC0xMDAzNTg5OTQyMjg3CgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFNPTE9fRklMRSk6CiAgICAgICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIHNvbG9fZGF0YSA9IGpzb24ubG9hZChmKQogICAgICAgICAgICByb29tID0gc29sb19kYXRhLmdldChtYV9mdWxsKQogICAgICAgICAgICBpZiByb29tIGFuZCByb29tLmdldCgic3RhdHVzIikgPT0gIjIvMiI6CiAgICAgICAgICAgICAgICB4b2Fzb2xvKG1hX2Z1bGwpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGfhu61pIHRow7RuZyBiw6FvIFNPTE8gdsOsIHBow7JuZyB7bWFfZnVsbH0gxJHDoyDEkeG7pyAyLzIuIikKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNoYXQgPSBib3QuZ2V0X2NoYXQoaW50KHVzZXJfaWQpKQogICAgICAgICAgICBmdWxsbmFtZSA9IGNoYXQuZmlyc3RfbmFtZSBvciAiIgogICAgICAgICAgICBpZiBjaGF0Lmxhc3RfbmFtZToKICAgICAgICAgICAgICAgIGZ1bGxuYW1lICs9ICIgIiArIGNoYXQubGFzdF9uYW1lCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBmdWxsbmFtZSA9ICLjhaTjhaTjhaQiCgogICAgICAgIG1hX2Z1bGxfaHRtbCA9IGVzY2FwZShtYV9mdWxsKQoKICAgICAgICBmb3JtYXRfYmFsYW5jZSA9ICJ7Oix9Ii5mb3JtYXQoYW1vdW50KS5yZXBsYWNlKCIsIiwgIi4iKQogICAgICAgIHVzZXJfbGluayA9IGYnPGEgaHJlZj0idGc6Ly91c2VyP2lkPXt1c2VyX2lkfSI+e2Z1bGxuYW1lfSAtIHt1c2VyX2lkfTwvYT4nCiAgICAgICAgdGV4dCA9ICgKICAgICAgICAgICAgZiLwn4+GIDxiPlBIw5JORyBTT0xPIFhYIPCfjrI8L2I+XG4iCiAgICAgICAgICAgIGYiLSBDaOG7pyBwaMOybmc6IHt1c2VyX2xpbmt9XG4iCiAgICAgICAgICAgIGYiLSBT4buRIHRp4buBbjogPGI+e2Zvcm1hdF9iYWxhbmNlfcSRPC9iPlxuIgogICAgICAgICAgICBmIi0gTcOjIHBow7JuZzogPGNvZGU+e21hX2Z1bGxfaHRtbH08L2NvZGU+XG5cbiIKICAgICAgICAgICAgZiJC4bqlbSB2w7QgbsO6dCBkxrDhu5tpIG7DoHkgxJHhu4MgdGhhbSBnaWEg8J+Rh/CfkYciCiAgICAgICAgKQoKICAgICAgICBqb2luX2xpbmsgPSBmImh0dHBzOi8vdC5tZS90aW5obGluaGJvdD9zdGFydD1TT0xPVkxYWC17bWFfZnVsbH0iCiAgICAgICAgam9pbl9idXR0b24gPSBJbmxpbmVLZXlib2FyZE1hcmt1cCgpCiAgICAgICAgam9pbl9idXR0b24uYWRkKElubGluZUtleWJvYXJkQnV0dG9uKGYiU09MTyB7Zm9ybWF0X2JhbGFuY2V9IHwge2Z1bGxuYW1lfSIsIHVybD1qb2luX2xpbmspKQoKICAgICAgICBtc2cgPSBib3R0YnNvbG8uc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBncm91cF9pZCwKICAgICAgICAgICAgdGV4dCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPWpvaW5fYnV0dG9uLAogICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICkKICAgICAgICBib3R0YnNvbG8ucGluX2NoYXRfbWVzc2FnZShncm91cF9pZCwgbXNnLm1lc3NhZ2VfaWQsIGRpc2FibGVfbm90aWZpY2F0aW9uPVRydWUpCiAgICAgICAgbHV1c29sbyhtYV9mdWxsLCBtc2cubWVzc2FnZV9pZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbQk9UIFBI4bukXSBM4buXaSBn4butaSBTT0xPIHbDoG8gbmjDs206IHtlfSIpCgpkZWYgZm9ybWF0X21vbmV5KHgpOgogICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQoeCkucmVwbGFjZSgiLCIsICIuIikKCmRlZiB0YW9fdGhvbmdfYmFvX3RoYW5nKHNob3J0X2NvZGUsIGFtb3VudCwgdXNlcjEsIHVzZXIyLCB4eDEsIHh4MiwgdGllbl90aGFuZywgc29fZHUpOgogICAgcmV0dXJuICgKICAgICAgICBmIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBXG4iCiAgICAgICAgZiLilKPinqQgU09MTyBYw7pjIHjhuq9jXG4iCiAgICAgICAgZiLilKPinqQgUGjDsm5nIHPhu5E6IHtzaG9ydF9jb2RlfVxuIgogICAgICAgIGYi4pSj4p6kIFRp4buBbiBjxrDhu6NjOiA8Yj57Zm9ybWF0X21vbmV5KGFtb3VudCl9PC9iPlxuIgogICAgICAgIGYi4pSj4p6kIEtRIPCfjrIge3VzZXIxfTogPGI+e3h4MX08L2I+XG4iCiAgICAgICAgZiLilKPinqQgS1Eg8J+OsiB7dXNlcjJ9OiA8Yj57eHgyfTwvYj5cbiIKICAgICAgICBmIuKUo+KepCBUUuG6oE5HIFRIw4FJIDogPGI+VEjhuq5OR+KchTwvYj5cbiIKICAgICAgICBmIuKUo+KepCBUaeG7gW4gdGjhuq9uZzogPGI+e2Zvcm1hdF9tb25leSh0aWVuX3RoYW5nKX08L2I+XG4iCiAgICAgICAgZiLilKPinqQgU+G7kSBkxrA6IDxiPntmb3JtYXRfbW9uZXkoc29fZHUpfTwvYj5cbiIKICAgICAgICBmIuKUlyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIgogICAgKQoKZGVmIHRhb190aG9uZ19iYW9fdGh1YShzaG9ydF9jb2RlLCBhbW91bnQsIHVzZXIxLCB1c2VyMiwgeHgxLCB4eDIsIHNvX2R1KToKICAgIHJldHVybiAoCiAgICAgICAgZiLilI8g4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgVxuIgogICAgICAgIGYi4pSj4p6kIFNPTE8gWMO6YyB44bqvY1xuIgogICAgICAgIGYi4pSj4p6kIFBow7JuZyBz4buROiB7c2hvcnRfY29kZX1cbiIKICAgICAgICBmIuKUo+KepCBUaeG7gW4gY8aw4bujYzogPGI+e2Zvcm1hdF9tb25leShhbW91bnQpfTwvYj5cbiIKICAgICAgICBmIuKUo+KepCBLUSDwn46yIHt1c2VyMX06IDxiPnt4eDF9PC9iPlxuIgogICAgICAgIGYi4pSj4p6kIEtRIPCfjrIge3VzZXIyfTogPGI+e3h4Mn08L2I+XG4iCiAgICAgICAgZiLilKPinqQgVFLhuqBORyBUSMOBSSA6IDxiPlRIVUEg4p2MPC9iPlxuIgogICAgICAgIGYi4pSj4p6kIFPhu5EgZMawOiA8Yj57Zm9ybWF0X21vbmV5KHNvX2R1KX08L2I+XG4iCiAgICAgICAgZiLilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIKICAgICkKCmRlZiB4dXRodWF4eChib3QsIFNPTE9fRklMRSwgU0RfRklMRSk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoU09MT19GSUxFKToKICAgICAgICBwcmludCgiW0RFQlVHXSBGaWxlIHNvbG8uanNvbiBraMO0bmcgdOG7k24gdOG6oWkuIikKICAgICAgICByZXR1cm4KCiAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZGF0YSA9IGpzb24ubG9hZChmKQoKICAgIGJhbCA9IHt9CiAgICBpZiBvcy5wYXRoLmV4aXN0cyhTRF9GSUxFKToKICAgICAgICB3aXRoIG9wZW4oU0RfRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyOgogICAgICAgICAgICAgICAgICAgIHVpZCwgdmFsID0gcGFydHNbMF0sIHBhcnRzWzFdCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBiYWxbdWlkXSA9IGludCh2YWwpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICBiYWxbdWlkXSA9IDAKCiAgICB1cGRhdGVkID0gRmFsc2UKICAgIGZvciByb29tX2NvZGUsIHJvb20gaW4gbGlzdChkYXRhLml0ZW1zKCkpOgogICAgICAgIGlmIHJvb20uZ2V0KCJzdGF0dXMiKSAhPSAiMi8yIjoKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgdXNlcjEgPSByb29tLmdldCgidXNlcl9pZCIpCiAgICAgICAgdXNlcjIgPSByb29tLmdldCgidXNlcl9qb2luIikKICAgICAgICBhbW91bnQgPSByb29tLmdldCgiYW1vdW50IiwgMCkKICAgICAgICBzaG9ydF9jb2RlID0gcm9vbV9jb2RlLnNwbGl0KCItIilbMF0KICAgICAgICB1c2VyX3h4ID0gcm9vbS5nZXQoInVzZXJfeHgiLCB7fSkKCiAgICAgICAgaWYgInVzZXJfd2luIiBpbiByb29tIGFuZCB1c2VyMSBpbiB1c2VyX3h4IGFuZCB1c2VyMiBpbiB1c2VyX3h4OgogICAgICAgICAgICB3aW5uZXIgPSByb29tWyJ1c2VyX3dpbiJdCiAgICAgICAgICAgIGxvc2VyID0gdXNlcjIgaWYgd2lubmVyID09IHVzZXIxIGVsc2UgdXNlcjEKICAgICAgICAgICAgeHgxID0gdXNlcl94eC5nZXQodXNlcjEsIDApCiAgICAgICAgICAgIHh4MiA9IHVzZXJfeHguZ2V0KHVzZXIyLCAwKQogICAgICAgICAgICBwcmludChmIltERUJVR10gQ8OzIHVzZXJfd2luIHPhurVuIHRyb25nIHBow7JuZyB7cm9vbV9jb2RlfToge3dpbm5lcn0iKQogICAgICAgIGVsaWYgKHVzZXIxIGluIHVzZXJfeHggYW5kIHVzZXIyIG5vdCBpbiB1c2VyX3h4KSBvciAodXNlcjIgaW4gdXNlcl94eCBhbmQgdXNlcjEgbm90IGluIHVzZXJfeHgpOgogICAgICAgICAgICBpZiB1c2VyMSBpbiB1c2VyX3h4OgogICAgICAgICAgICAgICAgd2lubmVyLCBsb3NlciA9IHVzZXIxLCB1c2VyMgogICAgICAgICAgICAgICAgeHgxLCB4eDIgPSB1c2VyX3h4LmdldCh1c2VyMSwgMCksIDAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHdpbm5lciwgbG9zZXIgPSB1c2VyMiwgdXNlcjEKICAgICAgICAgICAgICAgIHh4MiwgeHgxID0gdXNlcl94eC5nZXQodXNlcjIsIDApLCAwCgogICAgICAgICAgICByb29tWyJ1c2VyX3dpbiJdID0gd2lubmVyCiAgICAgICAgICAgIHJvb21bInVzZXJfeHgiXVtsb3Nlcl0gPSAwCiAgICAgICAgICAgIHJvb21bInJlc3VsdCJdID0ge3dpbm5lcjogIndpbiIsIGxvc2VyOiAibG9zZSJ9CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBU4buxIMSR4buZbmcgeMOhYyDEkeG7i25oIHRo4bqvbmcgdGh1YSBwaMOybmcge3Jvb21fY29kZX06IHt3aW5uZXJ9IHRo4bqvbmcge2xvc2VyfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgdGllbl90aGFuZyA9IGludChhbW91bnQgKiAxLjk3KQogICAgICAgIGJhbFt3aW5uZXJdID0gYmFsLmdldCh3aW5uZXIsIDApICsgdGllbl90aGFuZwogICAgICAgIGJhbFtsb3Nlcl0gPSBiYWwuZ2V0KGxvc2VyLCAwKQoKICAgICAgICBjb25nX2hvYV9ob25nX3RodWEobG9zZXIsIGFtb3VudCkKICAgICAgICBlbmRfdHVybl9mb3JfdXNlcih3aW5uZXIpCgogICAgICAgIG1zZ193aW4gPSB0YW9fdGhvbmdfYmFvX3RoYW5nKHNob3J0X2NvZGUsIGFtb3VudCwgdXNlcjEsIHVzZXIyLCB4eDEsIHh4MiwgdGllbl90aGFuZywgYmFsW3dpbm5lcl0pCiAgICAgICAgbXNnX2xvc2UgPSB0YW9fdGhvbmdfYmFvX3RodWEoc2hvcnRfY29kZSwgYW1vdW50LCB1c2VyMSwgdXNlcjIsIHh4MSwgeHgyLCBiYWxbbG9zZXJdKQoKICAgICAgICBtYXJrdXAgPSB0eXBlcy5SZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAgICAgIG1hcmt1cC5yb3codHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfjrIgRGFuaCBzw6FjaCBHYW1lIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5GkIFTDoGkgS2hv4bqjbiIpKQogICAgICAgIG1hcmt1cC5yb3codHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfkrUgTuG6oXAgdGnhu4FuIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5K4IFLDunQgdGnhu4FuIikpCiAgICAgICAgbWFya3VwLnJvdyh0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+OliBCWEgg8J+OliIpLCB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+MuiBIb2EgSOG7k25nIikpCgogICAgICAgIHRyeToKICAgICAgICAgICAgbXNnMSA9IGJvdC5zZW5kX21lc3NhZ2Uod2lubmVyLCBtc2dfd2luLCBwYXJzZV9tb2RlPSJIVE1MIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKICAgICAgICAgICAgbXNnMiA9IGJvdC5zZW5kX21lc3NhZ2UobG9zZXIsIG1zZ19sb3NlLCBwYXJzZV9tb2RlPSJIVE1MIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIGvhur90IHF14bqjIHBow7JuZyB7cm9vbV9jb2RlfSBjaG8ge3dpbm5lcn0gdsOgIHtsb3Nlcn0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIGfhu61pIHRpbiBuaOG6r24gcGjDsm5nIHtyb29tX2NvZGV9OiB7ZX0iKQoKICAgICAgICB0YnNvbG94eChyb29tX2NvZGUsIHVzZXIxLCB1c2VyMiwgeHgxLCB4eDIsIHRpZW5fdGhhbmcpCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFIik6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKCJGSUxFIikKICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKCJGSUxFIiwgInNvbG94eC50eHQiKSwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmX2hpc3Rvcnk6CiAgICAgICAgICAgIGZfaGlzdG9yeS53cml0ZShqc29uLmR1bXBzKHsKICAgICAgICAgICAgICAgICJyb29tX2NvZGUiOiByb29tX2NvZGUsCiAgICAgICAgICAgICAgICAidXNlcl9pZCI6IHVzZXIxLAogICAgICAgICAgICAgICAgInVzZXJfam9pbiI6IHVzZXIyLAogICAgICAgICAgICAgICAgImFtb3VudCI6IGFtb3VudCwKICAgICAgICAgICAgICAgICJ1c2VyX3dpbiI6IHdpbm5lciwKICAgICAgICAgICAgICAgICJ1c2VyX3h4Ijogcm9vbS5nZXQoInVzZXJfeHgiLCB7fSksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogcm9vbS5nZXQoInN0YXR1cyIsICIiKQogICAgICAgICAgICB9LCBlbnN1cmVfYXNjaWk9RmFsc2UpICsgIlxuIikKCiAgICAgICAgZGF0YS5wb3Aocm9vbV9jb2RlLCBOb25lKQogICAgICAgIHVwZGF0ZWQgPSBUcnVlCgogICAgaWYgdXBkYXRlZDoKICAgICAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MiwgZW5zdXJlX2FzY2lpPUZhbHNlKQogICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciB1aWQsIHZhbCBpbiBiYWwuaXRlbXMoKToKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dWlkfSB7dmFsfVxuIikKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIGPhuq1wIG5o4bqtdCBzb2xvLmpzb24gdsOgIHPhu5EgZMawIG5nxrDhu51pIGNoxqFpLiIpCgpkZWYgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYW1vdW50KToKICAgIHBhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAiY3VvY3RpZW4udHh0IikKICAgIG5ld19saW5lcyA9IFtdCiAgICB1c2VyX2ZvdW5kID0gRmFsc2UKCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyIGFuZCBwYXJ0c1swXSA9PSBzdHIodXNlcl9pZCk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfdmFsdWUgPSBtYXgoMCwgY3VycmVudCAtIGFtb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmV3X3ZhbHVlfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9mb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBuZXdfbGluZXMuYXBwZW5kKGxpbmUpCgogICAgICAgIGlmIHVzZXJfZm91bmQ6CiAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X2xpbmVzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgdXNlcl9pZCB7dXNlcl9pZH0gdHJvbmcgZmlsZSBjdW9jdGllbi50eHQiKQogICAgZWxzZToKICAgICAgICBwcmludChmIltERUJVR10gRmlsZSB7cGF0aH0ga2jDtG5nIHThu5NuIHThuqFpIikKCiIiIkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbnRlbnRfdHlwZXM9Wydjb250YWN0J10pCmRlZiBoYW5kbGVfY29udGFjdChtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgY29udGFjdCA9IG1lc3NhZ2UuY29udGFjdAogICAgZmlsZV9wYXRoID0gIkZJTEUvY2hlY2tzbXMudHh0IgogICAgbHV1dmF4b2F0bihtZXNzYWdlKQogICAgaWYgZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgIGlmIHVzZXJfaWQgIT0gY29udGFjdC51c2VyX2lkOgogICAgICAgIHJldHVybgogICAgbnVtYmVyID0gY29udGFjdC5waG9uZV9udW1iZXIKICAgIGlmIG5vdCBudW1iZXIuc3RhcnRzd2l0aCgiKyIpOgogICAgICAgIG51bWJlciA9ICIrODQiICsgbnVtYmVyWy05Ol0KICAgIG9zLm1ha2VkaXJzKCJGSUxFIiwgZXhpc3Rfb2s9VHJ1ZSkKICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IHtudW1iZXJ9XG4iKQogICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYiQuG6oW4gxJHDoyB4w6FjIHRo4buxYyBTxJBUOiB7bnVtYmVyfSIpCiAgICBtZXNzYWdlLnRleHQgPSAiL3N0YXJ0IgogICAgc3RhcnQobWVzc2FnZSkiIiIKCmRlZiBzaG93X25hcHRpZW5fbWVudShtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gc3RyKG1lc3NhZ2UuZnJvbV91c2VyLmlkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyB5w6p1IGPhuqd1IG7huqFwIHRp4buBbi4iKQogICAgICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgICAgIGlmIHBob25lIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gY2jGsGEgeMOhYyBtaW5oIFPEkFQuIikKICAgICAgICAgICAgbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSwgb25lX3RpbWVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICAgICAgY29udGFjdF9idXR0b24gPSBLZXlib2FyZEJ1dHRvbigi8J+TsSBTaGFyZSBOdW1iZXIiLCByZXF1ZXN0X2NvbnRhY3Q9VHJ1ZSkKICAgICAgICAgICAgbWFya3VwLmFkZChjb250YWN0X2J1dHRvbikKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD0iVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIMSR4buDIHRp4bq/cCB04bulYzoiLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPW1hcmt1cAogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybiIiIgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0sIGtow7RuZyBjaG8gcGjDqXAgbuG6oXAgdGnhu4FuLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIG1zZyA9ICJWdWkgbMOybmcgY2jhu41uIGvDqm5oIG7huqFwOiIKICAgICAgICBrZXlib2FyZCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICBidG5fYmFuayA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJCQU5LIiwgY2FsbGJhY2tfZGF0YT0ibmFwYmFuayIpCiAgICAgICAgYnRuX21vbW8gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiTU9NTyIsIGNhbGxiYWNrX2RhdGE9Im5hcG1vbW8iKQogICAgICAgIGJ0bl90aGVjYW8gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiVEjhurogQ8OATyIsIGNhbGxiYWNrX2RhdGE9InRoZWNhbyIpCiAgICAgICAga2V5Ym9hcmQucm93KGJ0bl9tb21vLCBidG5fYmFuaykKICAgICAgICBrZXlib2FyZC5yb3coYnRuX3RoZWNhbykKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIHThuqFvIGPDoWMgbsO6dDogQkFOSywgTU9NTywgVEjhurogQ8OATy4iKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PW1zZywKICAgICAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgZ+G7rWkgbWVudSBu4bqhcCB0aeG7gW4uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gc2hvd19uYXB0aWVuX21lbnU6IHtlfSIpCgpkZWYgdGhhbWdpYXNvbG9faGFuZGxlcih1c2VyX2lkLCByb29tX2NvZGUsIGNoYXRfaWQpOgogICAgdHJ5OgogICAgICAgIHVzZXJfam9pbiA9IHN0cih1c2VyX2lkKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhTT0xPX0ZJTEUpOgogICAgICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJQaMOybmcgbsOgeSDEkcOjIMSR4bunIG5nxrDhu51pIGhv4bq3YyDEkcOjIGjhur90IGjhuqFuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZChmKQoKICAgICAgICBmb3Igcm9vbSBpbiBkYXRhLnZhbHVlcygpOgogICAgICAgICAgICBpZiAocm9vbS5nZXQoInVzZXJfaWQiKSA9PSB1c2VyX2pvaW4gb3Igcm9vbS5nZXQoInVzZXJfam9pbiIpID09IHVzZXJfam9pbikgYW5kIG5vdCByb29tLmdldCgidXNlcl93aW4iKToKICAgICAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIkLhuqFuIMSRw6MgdOG6oW8gaG/hurdjIHRoYW0gZ2lhIHBow7JuZywgdnVpIGzDsm5nIHR1bmcgWFgiKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIHJvb21fY29kZSBub3QgaW4gZGF0YToKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiUGjDsm5nIG7DoHkgxJHDoyDEkeG7pyBuZ8aw4budaSBob+G6t2MgxJHDoyBo4bq/dCBo4bqhbiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICByb29tID0gZGF0YVtyb29tX2NvZGVdCiAgICAgICAgaWYgcm9vbS5nZXQoInN0YXR1cyIpID09ICIyLzIiOgogICAgICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJQaMOybmcgbsOgeSDEkWFuZyB0aGkgxJHhuqV1IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHRyeToKICAgICAgICAgICAgYW1vdW50ID0gaW50KHJvb21fY29kZS5zcGxpdCgiLSIpWzFdKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIk3DoyBwaMOybmcga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc29kdSA9IDAKICAgICAgICBsaW5lcyA9IFtdCiAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFNEX0ZJTEUpOgogICAgICAgICAgICB3aXRoIG9wZW4oU0RfRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICB1aWQsIHZhbCA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgdWlkID09IHVzZXJfam9pbjoKICAgICAgICAgICAgICAgICAgICAgICAgc29kdSA9IGludCh2YWwpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZCgodWlkLCB2YWwpKQoKICAgICAgICBpZiBub3QgZm91bmQgb3Igc29kdSA8IGFtb3VudDoKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiU+G7kSBkxrAga2jDtG5nIMSR4bunIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIG5ld19iYWxhbmNlID0gc29kdSAtIGFtb3VudAogICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciB1aWQsIHZhbCBpbiBsaW5lczoKICAgICAgICAgICAgICAgIGlmIHVpZCA9PSB1c2VyX2pvaW46CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmInt1aWR9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dWlkfSB7dmFsfVxuIikKCiAgICAgICAgcm9vbVsidXNlcl9qb2luIl0gPSB1c2VyX2pvaW4KICAgICAgICByb29tWyJzdGF0dXMiXSA9ICIyLzIiCgogICAgICAgIHhvYXNvbG8ocm9vbV9jb2RlKQogICAgICAgIHRydWN1b2N0aWVuKHVzZXJfaWQsIGFtb3VudCkKCiAgICAgICAgZGF0YVtyb29tX2NvZGVdID0gcm9vbQogICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGluZGVudD0yLCBlbnN1cmVfYXNjaWk9RmFsc2UpCgogICAgICAgIGRlZiBmKHgpOiByZXR1cm4gIns6LH0iLmZvcm1hdCh4KS5yZXBsYWNlKCIsIiwgIi4iKQoKICAgICAgICBrZXlib2FyZF9wbGF5ZXIgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgIGtleWJvYXJkX3BsYXllci5hZGQoS2V5Ym9hcmRCdXR0b24oIvCfjrIiKSkKCiAgICAgICAgbXNnX3BsYXllciA9IGYiIiJC4bqhbiDEkeG6t3QgY8aw4bujYyB7ZihhbW91bnQpfSB2w6BvIHBow7JuZyB0aGkgxJHhuqV1IHtyb29tX2NvZGUuc3BsaXQoJy0nKVswXX0KVGnhu4FuIGPGsOG7o2M6IHtmKGFtb3VudCl9ClRp4bq/biBow6BuaCB0dW5nIFhYIMSR4buDIHRoaSDEkeG6pXUsIDxiPnNhdSAxMjBzIG7hur91IGtow7RuZyB0dW5nLCBi4bqhbiBjw7MgdGjhu4MgZMO5bmcgbOG7h25oCjxjb2RlPi9odXlzb2xvIHtyb29tX2NvZGV9PC9jb2RlPiDEkeG7gyBo4buneSBwaMOybmcKPGNvZGU+L2NoZWNrc29sbyB7cm9vbV9jb2RlfTwvY29kZT4gxJHhu4MgYsOhbyBjw6FvIHbhu5tpIEFkbWluIG7hur91IMSR4buRaSB0aOG7pyBraMO0bmcgdHVuZyBYWDwvYj4KICAgICAgICAiIiIKCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCBtc2dfcGxheWVyLCBwYXJzZV9tb2RlPSJIVE1MIiwgcmVwbHlfbWFya3VwPWtleWJvYXJkX3BsYXllcikKCiAgICAgICAgY3JlYXRvcl9pZCA9IGludChyb29tWyJ1c2VyX2lkIl0pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjaGF0ID0gYm90LmdldF9jaGF0KGNyZWF0b3JfaWQpCiAgICAgICAgICAgIGZ1bGxuYW1lID0gY2hhdC5maXJzdF9uYW1lIG9yICIiCiAgICAgICAgICAgIGlmIGNoYXQubGFzdF9uYW1lOgogICAgICAgICAgICAgICAgZnVsbG5hbWUgKz0gIiAiICsgY2hhdC5sYXN0X25hbWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBmdWxsbmFtZSA9ICIiCgogICAgICAgIG1hcmtkb3duX3VzZXIgPSBmIklEIHt1c2VyX2pvaW59fHtmdWxsbmFtZX0iCiAgICAgICAgbGlua191c2VyID0gZiJbe21hcmtkb3duX3VzZXJ9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfam9pbn0pIgoKICAgICAgICBtc2dfY3JlYXRvciA9ICgKICAgICAgICAgICAgZiJ7bGlua191c2VyfSDEkcOjIHbDoG8gcGjDsm5nIHRoaSDEkeG6pXUge3Jvb21fY29kZS5zcGxpdCgnLScpWzBdfVxuIgogICAgICAgICAgICBmIlRp4bq/biBow6BuaCB0dW5nIFhYIMSR4buDIHRoaSDEkeG6pXUuXG4iCiAgICAgICAgICAgIGYiKlNhdSAxMjBzIG7hur91IGtow7RuZyB0dW5nIHPhur0gYuG7iyB44butIHRodWEhKiIKICAgICAgICApCgogICAgICAgIGtleWJvYXJkX2NyZWF0b3IgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgIGtleWJvYXJkX2NyZWF0b3IuYWRkKEtleWJvYXJkQnV0dG9uKCLwn46yIikpCgogICAgICAgIHNlbnRfbXNnX2NyZWF0b3IgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjcmVhdG9yX2lkLAogICAgICAgICAgICBtc2dfY3JlYXRvciwKICAgICAgICAgICAgcGFyc2VfbW9kZT0iTWFya2Rvd24iLAogICAgICAgICAgICByZXBseV9tYXJrdXA9a2V5Ym9hcmRfY3JlYXRvcgogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIHRyb25nIC9zb2xvOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0Lmxvd2VyKCkuc3RhcnRzd2l0aCgnL3N0YXJ0JykpCmRlZiBzdGFydChtZXNzYWdlKToKICAgIGRlZiBlbmFibGVfYXV0b19kZWxldGUoY2hhdF9pZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7VE9LRU59L3NldENoYXRQZXJtaXNzaW9ucyIKICAgICAgICAgICAgZGF0YSA9IHsKICAgICAgICAgICAgICAgICJjaGF0X2lkIjogY2hhdF9pZCwKICAgICAgICAgICAgICAgICJtZXNzYWdlX2F1dG9fZGVsZXRlX3RpbWUiOiA4NjQwMAogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QodXJsLCBqc29uPWRhdGEpCiAgICAgICAgICAgIHByaW50KGYiW0FVVE8tREVMRVRFXSDEkMOjIGLhuq10IGF1dG8geMOzYSB0aW4gbmjhuq9uIDI0aCBjaG8gY2hhdCB7Y2hhdF9pZH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbQVVUTy1ERUxFVEVdIEzhu5dpOiB7ZX0iKQoKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgIHByaW50KGYiW0RFQlVHXSAvc3RhcnQgdOG7qyB1c2VyIHt1c2VyX2lkfSIpCgogICAgdHJ5OgogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIGLhu4sgbG/huqFpIHbDrCBmb3J3YXJkIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIGPFqSBoxqFuIHRo4budaSBnaWFuIGJvdCBzdGFydCIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciBi4buLIGJhbiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIGLhu4sgY2jhurduIGRvIHNwYW0iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIFVzZXIga2jDtG5nIMSR4bunIMSRaeG7gXUga2nhu4duIGfhu61pIHRpbiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiB1c2VyX2lkIGluIGxhc3Rfc3RhcnRfdGltZSBhbmQgdGltZS50aW1lKCkgLSBsYXN0X3N0YXJ0X3RpbWVbdXNlcl9pZF0gPCAxOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBVc2VyIHNwYW0gL3N0YXJ0IHF1w6EgbmhhbmgiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgbGFzdF9zdGFydF90aW1lW3VzZXJfaWRdID0gdGltZS50aW1lKCkKICAgICAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnNwbGl0KCkKCiAgICAgICAgaWYgbGVuKGFyZ3MpID4gMToKICAgICAgICAgICAgcGFyYW0gPSBhcmdzWzFdLmxvd2VyKCkKCiAgICAgICAgICAgIGlmIHBhcmFtLnN0YXJ0c3dpdGgoInNvbG92bHh4LSIpOgogICAgICAgICAgICAgICAgcm9vbV9jb2RlID0gcGFyYW1bbGVuKCJzb2xvdmx4eC0iKTpdCiAgICAgICAgICAgICAgICBjaGF0X2lkID0gbWVzc2FnZS5jaGF0LmlkCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVsOgbyBwaMOybmcgU09MTyB04buxIMSR4buZbmcgduG7m2kgY29kZToge3Jvb21fY29kZX0iKQogICAgICAgICAgICAgICAgdGhhbWdpYXNvbG9faGFuZGxlcih1c2VyX2lkLCByb29tX2NvZGUsIGNoYXRfaWQpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIHBhcmFtID09ICJuYXB0aWVuIjoKICAgICAgICAgICAgICAgIHByaW50KCJbREVCVUddIFRydXkgY+G6rXAgbWVudSBu4bqhcCB0aeG7gW4gdOG7qyBsaW5rIikKICAgICAgICAgICAgICAgIHJldHVybiBzaG93X25hcHRpZW5fbWVudShtZXNzYWdlKQoKICAgICAgICAgICAgaWYgcGFyYW0uaXNkaWdpdCgpOgogICAgICAgICAgICAgICAgdGVtcF9yZWZfaWQgPSBpbnQocGFyYW0pCiAgICAgICAgICAgICAgICBpZiB0ZW1wX3JlZl9pZCAhPSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIHNhdmVfcmVmX3RlbXAodXNlcl9pZCwgdGVtcF9yZWZfaWQpCgogICAgICAgIHJlZl9pZCA9IGdldF9yZWZfdGVtcCh1c2VyX2lkKQogICAgICAgIGlmIHJlZl9pZDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFBo4bulYyBo4buTaSByZWZfaWQge3JlZl9pZH0gY2hvIHVzZXIge3VzZXJfaWR9IikKCiAgICAgICAgZnVsbG5hbWUgPSBmInttZXNzYWdlLmZyb21fdXNlci5maXJzdF9uYW1lfSB7bWVzc2FnZS5mcm9tX3VzZXIubGFzdF9uYW1lIG9yICcnfSIuc3RyaXAoKQogICAgICAgIHJlZl9ub3RpY2UsIHF1YXRhbmdfbm90aWNlID0gIiIsICIiCiAgICAgICAgZGFfbmhhbiA9IEZhbHNlCgogICAgICAgIGRhbmhhbnRhbnRodV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgImRhbmhhbnRhbnRodS50eHQiKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGRhbmhhbnRhbnRodV9wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKGRhbmhhbnRhbnRodV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBpZiB1c2VyX2lkX3N0ciBpbiBmLnJlYWQoKS5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgZGFfbmhhbiA9IFRydWUKICAgICAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBVc2VyIMSRw6MgdOG7q25nIG5o4bqtbiBxdcOgIHTDom4gdGjhu6ciKQoKICAgICAgICBzZF9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNkLnR4dCIpCiAgICAgICAgaWYgbm90IGRhX25oYW4gYW5kIG9zLnBhdGguZXhpc3RzKHNkX3BhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4oc2RfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgodXNlcl9pZF9zdHIgKyAiICIpOgogICAgICAgICAgICAgICAgICAgICAgICBkYV9uaGFuID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBxdWF0YW5nX25vdGljZSA9ICLEkMOjIGjhur90IHF1w6AgdMOibiB0aOG7pyIKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciDEkcOjIGPDsyB0w6BpIGtob+G6o24sIGtow7RuZyDEkcaw4bujYyBuaOG6rW4gdMOibiB0aOG7pyIpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIHRhbnRodV9wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRhbnRodS50eHQiKQogICAgICAgIGlmIG5vdCBkYV9uaGFuOgogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHModGFudGh1X3BhdGgpOgogICAgICAgICAgICAgICAgcXVhdGFuZ19ub3RpY2UgPSAixJDDoyBo4bq/dCBxdcOgIHTDom4gdGjhu6ciCiAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgdOG7k24gdOG6oWkgdGFudGh1LnR4dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4odGFudGh1X3BhdGgsICJyKyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBjb3VudCA9IGludChmLnJlYWQoKS5zdHJpcCgpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgY291bnQgPSAwCgogICAgICAgICAgICAgICAgICAgIGlmIGNvdW50IDw9IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIHF1YXRhbmdfbm90aWNlID0gIsSQw6MgaOG6v3QgcXXDoCB0w6JuIHRo4bunIgogICAgICAgICAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgY8OybiBzdeG6pXQgdMOibiB0aOG7pyIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgZi5zZWVrKDApCiAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoc3RyKGNvdW50IC0gMSkpCiAgICAgICAgICAgICAgICAgICAgICAgIGYudHJ1bmNhdGUoKQogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVHLhu6sgc3XhuqV0IHTDom4gdGjhu6c6IGPDsm4gbOG6oWkge2NvdW50IC0gMX0iKQoKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMsIGZvdW5kID0gW10sIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHNkX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKHNkX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZnNkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGZzZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBpbnQoZmxvYXQocGFydHNbMV0pKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlICsgMjAwMAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWRfc3RyfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQ+G7mW5nIDIwMDA6IHtjdXJyZW50X2JhbGFuY2V9IC0+IHtuZXdfYmFsYW5jZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgnXG4nKSBlbHNlIGxpbmUgKyAnXG4nKQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGZvdW5kOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWRfc3RyfSAyMDAwXG4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFThuqFvIHTDoGkga2hv4bqjbiBt4bubaSB24bubaSAyMDAwIikKCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihzZF9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZzZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZzZC53cml0ZWxpbmVzKGxpbmVzKQoKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGRhbmhhbnRhbnRodV9wYXRoLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZkdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZkdC53cml0ZShmInt1c2VyX2lkX3N0cn1cbiIpCgogICAgICAgICAgICAgICAgICAgICAgICBxdWF0YW5nX25vdGljZSA9ICJC4bqhbiDEkcOjIG5o4bqtbiDEkcaw4bujYyAyLjAwMCB04burIHF1w6AgdMOibiB0aOG7pyIKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlZl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldF9yZWZlcnJlcih1c2VyX2lkLCByZWZfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZfbm90aWNlID0gZiJC4bqhbiDEkcOjIG5o4bqtbiB7cmVmX2lkfSBsw6BtIHPGsCBwaOG7pVxuXG4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gR2hpIG5o4bqtbiByZWZfaWQ6IHtyZWZfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHJlZl9pZCwgZiJC4bqhbiDEkcOjIG5o4bqtbiB7dXNlcl9pZH0gbMOgbSDEkeG7hyB04butIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gR+G7rWkgdOG7m2kgcmVmX2lkIGzhu5dpOiB7ZX0iKQoKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiByZWZfaWQgYW5kIG5vdCBjaGVja191c2VyX2V4aXN0cyh1c2VyX2lkKToKICAgICAgICAgICAgICAgIHNldF9yZWZlcnJlcih1c2VyX2lkLCByZWZfaWQpCiAgICAgICAgICAgICAgICByZWZfbm90aWNlID0gZiJC4bqhbiDEkcOjIG5o4bqtbiB7cmVmX2lkfSBsw6BtIHPGsCBwaOG7pVxuXG4iCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gR2hpIG5o4bqtbiByZWZfaWQgKG114buZbik6IHtyZWZfaWR9IikKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHJlZl9pZCwgZiJC4bqhbiDEkcOjIG5o4bqtbiB7dXNlcl9pZH0gbMOgbSDEkeG7hyB04butIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gR+G7rWkgdOG7m2kgcmVmX2lkIGzhu5dpOiB7ZX0iKQoKICAgICAgICBmdWxsX21lc3NhZ2UgPSAoCiAgICAgICAgICAgIGYie3JlZl9ub3RpY2V9IgogICAgICAgICAgICBmIntxdWF0YW5nX25vdGljZX1cbiIKICAgICAgICAgICAgZiJJRCBj4bunYSBi4bqhbiBsw6AgPGNvZGU+e3VzZXJfaWR9PC9jb2RlPlxuXG4iCiAgICAgICAgICAgIGYi8J+RiSBUaGFtIGdpYSBSb29tIFRYIMSR4buDIHPEg24gaMWpIHThuqFpIGh0dHBzOi8vdC5tZS9yb29tdGluaGxpbmhcbiIKICAgICAgICAgICAgZiLwn5GJIFRoYW0gZ2lhIENoYW5uZWwgVGluaCBMaW5oIMSR4buDIG5o4bqtbiB0aMO0bmcgYsOhbyBnYW1lIHThuqFpIGh0dHBzOi8vdC5tZS9jaGFubmVsdGluaGxpbmgiCiAgICAgICAgKQoKICAgICAgICBtYXJrdXAgPSB0eXBlcy5SZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAgICAgIG1hcmt1cC5yb3codHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfjrIgRGFuaCBzw6FjaCBHYW1lIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5GkIFTDoGkgS2hv4bqjbiIpKQogICAgICAgIG1hcmt1cC5yb3codHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfkrUgTuG6oXAgdGnhu4FuIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5K4IFLDunQgdGnhu4FuIikpCiAgICAgICAgbWFya3VwLnJvdyh0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+OliBCWEgg8J+OliIpLCB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+MuiBIb2EgSOG7k25nIikpCgogICAgICAgIGJvdF9tc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD1mdWxsX21lc3NhZ2UsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXAsCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgKQoKICAgICAgICBwcmludChmIltERUJVR10gR+G7rWkgdGluIGNow6BvIHbDoCB44butIGzDvSBob8OgbiB04bqldCBjaG8gdXNlciB7dXNlcl9pZH0iKQoKICAgICAgICAjIOKtkCBC4bqsVCBBVVRPIERFTEVURSAyNEgg4bueIMSQw4JZCiAgICAgICAgZW5hYmxlX2F1dG9fZGVsZXRlKG1lc3NhZ2UuY2hhdC5pZCkKCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9d3JpdGVfdG9fZmlsZXMsIGFyZ3M9KHVzZXJfaWQsKSkuc3RhcnQoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBHaGkgdGjDtG5nIHRpbiB1c2VyIElEIHt1c2VyX2lkfSB2w6BvIGZpbGUuIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIHRyb25nIGjDoG0gL3N0YXJ0OiB7ZX0iKQoKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dC5zdHJpcCgpID09ICLwn46yIERhbmggc8OhY2ggR2FtZSIpCmRlZiBnYW1lKG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIGLhu4sgbG/huqFpIHbDrCBmb3J3YXJkIikKICAgICAgICByZXR1cm4KICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgIHByaW50KCJbREVCVUddIFRpbiBuaOG6r24gY8WpIGjGoW4gdGjhu51pIGdpYW4gYm90IHN0YXJ0IikKICAgICAgICByZXR1cm4KICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgIHByaW50KCJbREVCVUddIFVzZXIgYuG7iyBiYW4iKQogICAgICAgIHJldHVybgogICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIGLhu4sgY2jhurduIGRvIHNwYW0iKQogICAgICAgIHJldHVybgogICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgcHJpbnQoIltERUJVR10gVXNlciBraMO0bmcgxJHhu6cgxJFp4buBdSBraeG7h24gZ+G7rWkiKQogICAgICAgIHJldHVybgoKICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICBtYXJrdXAgPSB0eXBlcy5SZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgIGNvbnRhY3RfYnV0dG9uID0gdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfk7EgU2hhcmUgTnVtYmVyIiwgcmVxdWVzdF9jb250YWN0PVRydWUpCiAgICAgICAgbWFya3VwLmFkZChjb250YWN0X2J1dHRvbikKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgxJHhu4MgdGnhur9wIHThu6VjOiIsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXAKICAgICAgICApCiAgICAgICAgcmV0dXJuIiIiCgogICAga2V5Ym9hcmQgPSB0eXBlcy5JbmxpbmVLZXlib2FyZE1hcmt1cCgpCiAgICBrZXlib2FyZC5hZGQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCflKUgVMOgaSB44buJdSBTxINuIGjFqSDwn5SlIiwgY2FsbGJhY2tfZGF0YT0ndGFpeGl1c2FuaHUnKSkKICAgIGtleWJvYXJkLnJvdygKICAgICAgICB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+OsiBUcsOqbiBkxrDhu5tpIOKshu+4j+Ksh++4jyIsIGNhbGxiYWNrX2RhdGE9J3RyZW5kdW9pJyksCiAgICAgICAgdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfjrIgWMO6YyB44bqvYyAzIHZpw6puIPCfjrIiLCBjYWxsYmFja19kYXRhPSd4dWN4YWNiYXZpZW4nKQogICAgKQogICAga2V5Ym9hcmQucm93KAogICAgICAgIHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCLwn46zIEJvd2xpbmcg8J+OsyIsIGNhbGxiYWNrX2RhdGE9J2Jvd2xpbmcnKSwKICAgICAgICB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+OsCBTTE9UIDcgNyA3IPCfjrAiLCBjYWxsYmFja19kYXRhPSdzbG90Nzc3JykKICAgICkKICAgIGtleWJvYXJkLmFkZCh0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+UpSBUw6BpIFjhu4l1IE1ENSDwn5SlIiwgY2FsbGJhY2tfZGF0YT0ndGFpeGl1bWQ1JykpCiAgICBrZXlib2FyZC5yb3coCiAgICAgICAgdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfjrIgWMO6YyB44bqvYyBM4bubbiBOaOG7jyIsIGNhbGxiYWNrX2RhdGE9J3h1Y3hhY2xvbmhvJyksCiAgICAgICAgdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfjrIgWMO6YyB44bqvYyIsIGNhbGxiYWNrX2RhdGE9J3h1Y3hhYycpCiAgICApCiAgICBrZXlib2FyZC5hZGQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfj4YgU29sbyBYw7pjIFjhuq9jIPCfj4YiLCBjYWxsYmFja19kYXRhPSdzb2xveHVjeGFjJykpCgogICAgYm90X21zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgdGV4dD0iVnVpIGzDsm5nIGNo4buNbiBHYW1lOiIsCiAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkLAogICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICApCmdhbWVfbWVzc2FnZXMgPSB7CiAgICAidGFpeGl1c2FuaHUiOiAoCiIiIjxiPvCfkqVHQU1FIFTDgEkgWOG7iFUgU8SCTiBIxajwn5KlPC9iPgpOaMOzbSDEkeG7gyBjaMahaSBnYW1lOiBodHRwczovL3QubWUvcm9vbXRpbmhsaW5oCkzGsHUgw70gY8OhYyBs4buHbmggc2F1IMSRxrDhu6NjIGNoxqFpIHThuqFpIFJvb20sIG7hur91IGNoxqFpIHThuqFpIEJvdCBz4bq9IGzDoCBnYW1lIGtow6FjIHbDoCBjw6FjaCB0w61uaCBr4bq/dCBxdeG6oyBraMOhYyBzbyB24bubaSBSb29tLgotLS0tLS0tLS0tLS0tLS0tLS0tLQo8Yj5HQU1FIFTDgEkvWOG7iFUvQ0jhurROL0zhurogVOG6oEkgUk9PTTwvYj4KLSBUOiBU4buVbmcgMyB2acOqbiB4w7pjIHjhuq9jIHThu6sgMTEgLSAxOCBUw6BpLgotIFg6IFThu5VuZyAzIHZpw6puIHjDumMgeOG6r2MgdOG7qyAzIC0gMTAgWOG7iXUuCi0gQzogVOG7lW5nIDMgdmnDqm4geMO6YyB44bqvYyBsw6Agc+G7kSBDaOG6tW4uCi0gTDogVOG7lW5nIDMgdmnDqm4geMO6YyB44bqvYyBsw6Agc+G7kSBM4bq7LgrigKIgVOG7tyBs4buHIHRy4bqjIHRoxrDhu59uZyAxLjk1CuKAoiBC4bqhbiBjw7MgY8ahIGjhu5lpIGNoaWEgaMWpIG7hur91IG7hu5UgaMWpIDMgdmnDqm4geMO6YyB44bqvYyBnaeG7kW5nIG5oYXUgxJHhu4F1IGzDoCAxIGhv4bq3YyA2IOG7nyBnYW1lIFRYQ0wuCkzhu4duaCBjxrDhu6NjOiBbVC9YL0MvTF0gW3Rp4buBbiBjaMahaV0KVkQ6IDxiPlQgMjAwMDA8L2I+Ci0gQ8aw4bujYyDhuqluIGRhbmg6IFRUL1hYL0NDL0xMIFt0aeG7gW4gY2jGoWldIFZEOiA8Yj5UVCAyMDAwMDwvYj4KLSBDxrDhu6NjIHThuqV0IHRheTogxJDhu5VpIHRp4buBbiBjxrDhu6NjIHRow6BuaCBNQVggVkQ6IDxiPlQgTUFYPC9iPgoiIiIKICAgICksCiAgICAiZG9hbnh4cm9vbSI6ICgKIiIiPGI+R0FNRSDEkE/DgU4gWMOaQyBY4bquQyBU4bqgSSBST09NPC9iPgpDaGnhur9uIHRo4bqvbmcga2hpIDEgdHJvbmcgMyB2acOqbiB4w7pjIHjhuq9jIGPDsyBr4bq/dCBxdeG6oyB0csO5bmcgc+G7kSBi4bqhbiBjaOG7jW4uCuKAoiBUcsO5bmcgMSB2acOqbjogMSDEgk4gMS45CuKAoiBUcsO5bmcgMiB2acOqbjogMSDEgk4gMi44CuKAoiBUcsO5bmcgMyB2acOqbjogMSDEgk4gMy43Ckzhu4duaCBjxrDhu6NjOiA8Yj5EW3Phu5EgY2jhu41uIDEtNl0gW3Rp4buBbiBjaMahaV08L2I+ClZEOiA8Yj5ENiAyMDAwMDwvYj4iIiIKICAgICksCiAgICAic2ljYm9yb29tIjogKAoiIiI8Yj5HQU1FIMSQT8OBTiBU4buUTkcgMyBYw5pDIFjhuq5DIFThuqBJIFJPT008L2I+CkNoaeG6v24gdGjhuq9uZyBraGkgdOG7lW5nIDMgdmnDqm4geMO6YyB44bqvYyBsw6Aga+G6v3QgcXXhuqMgdHLDuW5nIHPhu5EgYuG6oW4gY2jhu41uLgrigKIgVOG7tyBs4buHIHRy4bqjIHRoxrDhu59uZzoK4oCiIDQgLSAxNyB8IMOXMzAK4oCiIDUgLSAxNiB8IMOXMTMK4oCiIDYgLSAxNSB8IMOXOC4yCuKAoiA3IC0gMTQgfCDDlzUuOArigKIgOCAtIDEzIHwgw5c1LjIK4oCiIDkgLSAxMiB8IMOXNC44CuKAoiAxMCAtIDExIHwgw5c0LjgKTOG7h25oIGPGsOG7o2M6IDxiPlNCIFtz4buRIGNo4buNbiA0LTE3XSBbdGnhu4FuIGNoxqFpXTwvYj4KVkQ6IDxiPlNCIDExIDIwMDAwPC9iPiIiIgogICAgKSwKICAgICJiYW9yb29tIjogKAogICAgICAgICIiIjxiPkdBTUUgxJBPw4FOIDMgWMOaQyBY4bquQyBHSeG7kE5HIE5IQVUgVOG6oEkgUk9PTSAoQsODTyk8L2I+CkNoaeG6v24gdGjhuq9uZyBraGkgMyB2acOqbiB4w7pjIHjhuq9jIHJhIHPhu5EgdHLDuW5nIG5oYXUgdsOgIMSRw7puZyB24bubaSBz4buRIG5nxrDhu51pIGNoxqFpIMSRw6MgY8aw4bujYyBob+G6t2Mga2hpIDMgdmnDqm4geMO6YyB44bqvYyByYSBz4buRIHRyw7luZyBuaGF1IChi4bqldCBr4buzKS4K4oCiIELhu5ggQkEgLSAxIMSCTiAxMjAK4oCiIELDg08gQuG6pFQgS+G7siAtIDEgxIJOIDIwCkzhu4duaCBjxrDhu6NjOiBCQU8gW3Phu5EgY2jhu41uIDEtNiBob+G6t2MgQUxMXSBbdGnhu4FuIGNoxqFpXQpWRDogPGI+QkFPIDQgNTAwMDwvYj4gaG/hurdjIDxiPkJBTyBBTEwgMTAwMDA8L2I+IiIiCiAgICApLAogICAgInhpZW50eGNsIjogKAoiIiI8Yj5HQU1FIFhJw4pOIFThuqBJIFJPT008L2I+CkNoaeG6v24gdGjhuq9uZyBraGkgMiBj4butYSBjw7Mga+G6v3QgcXXhuqMgdHLDuW5nIHPhu5EgYuG6oW4gY2jhu41uLgrigKIgIFRDICAxMiwxNCwxNiwxOCAgMSDEgk4gIDMuOQrigKIgIFRMICAxMSwxMywxNSwxNyAgMSDEgk4gMy4zCuKAoiAgWEwgIDMsNSw3LDkgICAgMSDEgk4gMy45CuKAoiAgWEMgIDQsNiw4LDEwICAgIDEgxIJOIDMuMwpM4buHbmggY8aw4bujYzogW2zhu4duaF0gW3Rp4buBbiBjaMahaV0KVkQ6IDxiPlRDIDIwMDAwPC9iPiIiIgogICAgKSwKfQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidGFpeGl1c2FuaHUiKQpkZWYgdGFpeGl1c2FuaHUoY2FsbCk6CiAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBhbGxnYW1lKGNhbGwsICJ0YWl4aXVzYW5odSIpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJkb2FueHhyb29tIikKZGVmIGRvYW54eHJvb20oY2FsbCk6CiAgICBhbGxnYW1lKGNhbGwsICJkb2FueHhyb29tIikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInNpY2Jvcm9vbSIpCmRlZiBzaWNib3Jvb20oY2FsbCk6CiAgICBhbGxnYW1lKGNhbGwsICJzaWNib3Jvb20iKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiYmFvcm9vbSIpCmRlZiBiYW9yb29tKGNhbGwpOgogICAgYWxsZ2FtZShjYWxsLCAiYmFvcm9vbSIpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJ4aWVudHhjbCIpCmRlZiB4aWVudHhjbChjYWxsKToKICAgIGFsbGdhbWUoY2FsbCwgInhpZW50eGNsIikKCmRlZiBhbGxnYW1lKGNhbGwsIGdhbWVfdHlwZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBtZXNzYWdlID0gY2FsbC5tZXNzYWdlCgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICBtZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4OgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHjDs2EgaW5saW5lIGtleWJvYXJkOiB7ZXh9IikKCiAgICAgICAgbmV3X3RleHQgPSBnYW1lX21lc3NhZ2VzLmdldChnYW1lX3R5cGUsICJDaOG7jW4gbeG7mXQgZ2FtZSIpCiAgICAgICAgYnV0dG9ucyA9IFsKICAgICAgICAgICAgKCLEkG/DoW4gWFggUm9vbSIsICdkb2FueHhyb29tJyksCiAgICAgICAgICAgICgiU0lDQk8gUk9PTSIsICdzaWNib3Jvb20nKSwKICAgICAgICAgICAgKCJCw4NPIFJPT00iLCAnYmFvcm9vbScpLAogICAgICAgICAgICAoIlhpw6puIFRYQ0wiLCAneGllbnR4Y2wnKQogICAgICAgIF0KICAgICAgICBrZXlib2FyZCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKHJvd193aWR0aD0yKQogICAgICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihidXR0b25zKSwgMik6CiAgICAgICAgICAgIHJvdyA9IFtdCiAgICAgICAgICAgIGZvciBqIGluIHJhbmdlKDIpOgogICAgICAgICAgICAgICAgaWYgaSArIGogPCBsZW4oYnV0dG9ucyk6CiAgICAgICAgICAgICAgICAgICAgbGFiZWwsIGNhbGxiYWNrID0gYnV0dG9uc1tpICsgal0KICAgICAgICAgICAgICAgICAgICByb3cuYXBwZW5kKHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKGxhYmVsLCBjYWxsYmFja19kYXRhPWNhbGxiYWNrKSkKICAgICAgICAgICAga2V5Ym9hcmQucm93KCpyb3cpCgogICAgICAgIGJvdF9tc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD1uZXdfdGV4dCwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBhbGxnYW1lIDItMjoge2V9IikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRyZW5kdW9pIikKZGVmIHRyZW5kdW9pKGNhbGwpOgogICAgdHJlbmR1b2koY2FsbCwgInRyZW5kdW9pIikKZGVmIHRyZW5kdW9pKGNhbGwsIGdhbWVfdHlwZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBtZXNzYWdlID0gY2FsbC5tZXNzYWdlCgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBuZXdfdGV4dCA9ICgKICAgICAgICAgICAgIjxiPljDumMgeOG6r2MgdHLDqm4gZMaw4bubaSDirIbvuI/irIc8L2I+XG5cbiIKICAgICAgICAgICAgIjHvuI/ig6MgTmfGsOG7nWkgY2jGoWkgbmjhuq1wIFREICsgc+G7kSB0aeG7gW4gY8aw4bujYy4gU2F1IGtoaSBnaGkgbmjhuq1uIGJvdCBz4bq9IHR1bmcgMiDwn46yIGzGsOG7o3QgxJHhuqd1IHRpw6puLCAiCiAgICAgICAgICAgICJuZ8aw4budaSBjaMahaSBz4bq9IGThu7EgxJFvw6FuIOKshu+4jyAoY2FvIGjGoW4pIGhv4bq3YyDirIfvuI8gKG5o4buPIGjGoW4pIDIg8J+OsiB24burYSB0dW5nLlxuXG4iCiAgICAgICAgICAgICIy77iP4oOjIEJvdCBz4bq9IHRp4bq/cCB04bulYyB0dW5nIDIg8J+OsiB2w6Agc28gc8OhbmggduG7m2kgZOG7sSDEkW/DoW4gxJHDoyBjaOG7jW4sIG7hur91IHRyw7luZyBraOG7m3Agc+G6vSB0aOG6r25nIGPGsOG7o2NcbiIKICAgICAgICAgICAgIjxiPkhvw6AgbeG6pXQgNTAlIHRp4buBbiBjxrDhu6NjXG4iCiAgICAgICAgICAgICJLaGkgY8aw4bujYyB0csOqbiA1MGsgdGjDrCB04burIGzGsOG7o3Qg8J+OsiB0aOG7qSA1IHRy4bufIGzDqm4gc+G6vSBjw7MgY8ahIGjhu5lpIG5o4bqtbiDEkcaw4bujYyAxIPCfjLIgKDIwJSk8L2I+IgogICAgICAgICkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3JlcGx5X21hcmt1cCgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjDs2EgYsOgbiBwaMOtbSBjxak6IHtlfSIpCgogICAgICAgIHJlcGx5X21hcmt1cCA9IFJlcGx5S2V5Ym9hcmRNYXJrdXAocmVzaXplX2tleWJvYXJkPVRydWUpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OsiBEYW5oIHPDoWNoIEdhbWUnKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkaQgVMOgaSBLaG/huqNuJykpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+StSBO4bqhcCB0aeG7gW4nKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkrggUsO6dCB0aeG7gW4nKSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn46WIEJYSCDwn46WJyksIEtleWJvYXJkQnV0dG9uKCfwn4y6IEhvYSBI4buTbmcnKSkKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQoKICAgICAgICBib3RfbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9bmV3X3RleHQsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1yZXBseV9tYXJrdXAKICAgICAgICApCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRyZW5kdW9pOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbTogcmUubWF0Y2gocicoP2kpXlREXHMrXGQrJCcsIG0udGV4dC5zdHJpcCgpKSkKZGVmIGdhbWV0ZChtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgYW1vdW50ID0gaW50KG1lc3NhZ2UudGV4dC5zcGxpdCgpWzFdKQogICAgbm93ID0gdGltZS50aW1lKCkKCiAgICBpZiB1c2VyX2lkIGluIGxhc3RfY2FsbGJhY2tfdGltZSBhbmQgbm93IC0gbGFzdF9jYWxsYmFja190aW1lW3VzZXJfaWRdIDwgMjoKICAgICAgICByZXR1cm4KICAgIGxhc3RfY2FsbGJhY2tfdGltZVt1c2VyX2lkXSA9IG5vdwoKICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgIHJldHVybgogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgcmV0dXJuCiAgICBpZiB1c2VyX2lkIGluIHVzZXJfYmV0czoKICAgICAgICByZXR1cm4KICAgIGlmIGFtb3VudCA8IE1JTklNVU1fQkVUOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIlThu5FpIHRoaeG7g3Uge2Zvcm1hdF9iYWxhbmNlKE1JTklNVU1fQkVUKX3EkSIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBhbW91bnQgPiBNQVhJTVVNX0JFVDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiJU4buRaSDEkWEge2Zvcm1hdF9iYWxhbmNlKE1BWElNVU1fQkVUKX3EkSIpCiAgICAgICAgcmV0dXJuCgogICAgYmFsID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIGlmIGJhbCA8IGFtb3VudDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyIpCiAgICAgICAgcmV0dXJuCgogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgYmFsIC0gYW1vdW50KQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYW1vdW50KQogICAgdXNlcl9iZXRzW3VzZXJfaWRdID0geydiZXRfYW1vdW50JzogYW1vdW50fQogICAgdGRfdHVybnNbdXNlcl9pZF0gPSB0ZF90dXJucy5nZXQodXNlcl9pZCwgMCkgKyAxCgogICAgdHJ5OgogICAgICAgIGQxID0gYm90LnNlbmRfZGljZShtZXNzYWdlLmNoYXQuaWQsIGVtb2ppPSLwn46yIikKICAgICAgICBkMiA9IGJvdC5zZW5kX2RpY2UobWVzc2FnZS5jaGF0LmlkLCBlbW9qaT0i8J+OsiIpCgoKICAgICAgICB0b3RhbDAgPSBkMS5kaWNlLnZhbHVlICsgZDIuZGljZS52YWx1ZQogICAgICAgIHNhdmVfYmV0KHVzZXJfaWQsIGFtb3VudCwgdG90YWwwLCBjdW1fb2Rkcz0xLjApCiAgICAgICAgdV9vZGRzLCBvX29kZHMgPSBPRERTW3RvdGFsMF0KCiAgICAgICAgbWFya3VwID0gSW5saW5lS2V5Ym9hcmRNYXJrdXAoKQogICAgICAgIG1hcmt1cC5yb3coCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYi4qyH77iPIETGsOG7m2kgeHt1X29kZHN9IiwgY2FsbGJhY2tfZGF0YT1mImR1b2lfe3RvdGFsMH1fe3VzZXJfaWR9IiksCiAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKGYi4qyG77iPIFRyw6puIHh7b19vZGRzfSIsIGNhbGxiYWNrX2RhdGE9ZiJ0cmVuX3t0b3RhbDB9X3t1c2VyX2lkfSIpCiAgICAgICAgKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIGYie2QxLmRpY2UudmFsdWV9ICsge2QyLmRpY2UudmFsdWV9ID0ge3RvdGFsMH0iLHJlcGx5X21hcmt1cD1tYXJrdXApCgoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gZ2FtZXRkOiB7ZX0iKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGM6IGMuZGF0YS5zcGxpdCgiXyIpWzBdIGluICgiZHVvaSIsICJ0cmVuIikpCmRlZiBvbl9yZXN1bHQoY2FsbCk6CiAgICBhY3Rpb24sIHRvdGFsMF9zdHIsIHVzZXJfaWRfc3RyID0gY2FsbC5kYXRhLnNwbGl0KCJfIikKICAgIHVzZXJfaWQgPSBpbnQodXNlcl9pZF9zdHIpCiAgICBub3cgPSB0aW1lLnRpbWUoKQoKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkICE9IHVzZXJfaWQ6CiAgICAgICAgcmV0dXJuIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIHVzZXJfaWQgaW4gbGFzdF9jYWxsYmFja190aW1lIGFuZCBub3cgLSBsYXN0X2NhbGxiYWNrX3RpbWVbdXNlcl9pZF0gPCAyOgogICAgICAgIHJldHVybiBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBsYXN0X2NhbGxiYWNrX3RpbWVbdXNlcl9pZF0gPSBub3cKCiAgICB0cnk6CiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQogICAgZXhjZXB0OgogICAgICAgIHBhc3MKCiAgICB0cnk6CiAgICAgICAgZDEgPSBib3Quc2VuZF9kaWNlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBlbW9qaT0i8J+OsiIpCiAgICAgICAgZDIgPSBib3Quc2VuZF9kaWNlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBlbW9qaT0i8J+OsiIpCiAgICAgICAgdjEsIHYyID0gZDEuZGljZS52YWx1ZSwgZDIuZGljZS52YWx1ZQogICAgICAgIHRvdGFsMSA9IHYxICsgdjIKCgogICAgZXhjZXB0OgogICAgICAgIHJldHVybiBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgogICAgYW1vdW50LCB0b3RhbDAsIGN1bV9vZGRzID0gcG9wX2JldCh1c2VyX2lkKQogICAgdV9vZGRzX29sZCwgb19vZGRzX29sZCA9IE9ERFNbdG90YWwwXQoKICAgIHRleHQgPSAiIgogICAgbWFya3VwID0gTm9uZQoKICAgIGlmIChhY3Rpb24gPT0gImR1b2kiIGFuZCB0b3RhbDEgPCB0b3RhbDApIG9yIChhY3Rpb24gPT0gInRyZW4iIGFuZCB0b3RhbDEgPiB0b3RhbDApOgogICAgICAgIG9kZHMgPSB1X29kZHNfb2xkIGlmIGFjdGlvbiA9PSAiZHVvaSIgZWxzZSBvX29kZHNfb2xkCiAgICAgICAgaWYgY3VtX29kZHMgPT0gMDoKICAgICAgICAgICAgY3VtX29kZHMgPSAxLjAKICAgICAgICBuZXdfY3VtID0gY3VtX29kZHMgKiBvZGRzCiAgICAgICAgd2luID0gaW50KGFtb3VudCAqIG5ld19jdW0pCiAgICAgICAgbmV3X2JhbCA9IGdldF9iYWxhbmNlKHVzZXJfaWQpICsgd2luCgogICAgICAgIHNhdmVfYmV0KHVzZXJfaWQsIGFtb3VudCwgdG90YWwxLCBuZXdfY3VtKQogICAgICAgIHNhdmVfcmVzdWx0KHVzZXJfaWQsIGFtb3VudCwgcm91bmQobmV3X2N1bSwgNiksIHdpbiwgbmV3X2JhbCkKICAgICAgICB1cGRhdGVfY2h1b2lfZmlsZSh1c2VyX2lkLCB3aW4pCiAgICAgICAgdXBkYXRlX3RoYW5ndGh1YSh1c2VyX2lkLCBhbW91bnQsIHdpbikKICAgICAgICB1cGRhdGVfZ2FtZV9oaXN0b3J5KHVzZXJfaWQsIGFjdGlvbi51cHBlcigpLCBhbW91bnQsIHdpbiAtIGFtb3VudCkKCiAgICAgICAgdV9vZGRzLCBvX29kZHMgPSBPRERTLmdldCh0b3RhbDEsICgxLCAxKSkKICAgICAgICB0ZXh0ID0gZiJ7djF9ICsge3YyfSA9IHt0b3RhbDF9XG7inIUgVGjhuq9uZyB4e3JvdW5kKG5ld19jdW0sIDIpfSAoK3tmb3JtYXRfYmFsYW5jZSh3aW4gLSBhbW91bnQpfSkiCgogICAgICAgIG1hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICBtYXJrdXAucm93KAogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIuKsh++4jyBExrDhu5tpIHh7dV9vZGRzfSIsIGNhbGxiYWNrX2RhdGE9ZiJkdW9pX3t0b3RhbDF9X3t1c2VyX2lkfSIpLAogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIuKshu+4jyBUcsOqbiB4e29fb2Rkc30iLCBjYWxsYmFja19kYXRhPWYidHJlbl97dG90YWwxfV97dXNlcl9pZH0iKQogICAgICAgICkKICAgICAgICBtYXJrdXAucm93KAogICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIvCfkrUgTmjhuq1uIHRp4buBbiB4e3JvdW5kKG5ld19jdW0sIDIpfSIsIGNhbGxiYWNrX2RhdGE9ZiJjb2xsZWN0X3t1c2VyX2lkfSIpCiAgICAgICAgKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSB0aOG6r25nOiBjxrDhu6NjIHthbW91bnR9LCB0aOG6r25nIHt3aW4tYW1vdW50fSwgdOG7lW5nIHtuZXdfYmFsfSIpCiAgICAgICAgc2VuZF9hZG1pbl90ZCgKICAgICAgICAgICAgbWVzc2FnZT1jYWxsLm1lc3NhZ2UsCiAgICAgICAgICAgIGJldF90eXBlPWFjdGlvbi51cHBlcigpLAogICAgICAgICAgICBhbW91bnQ9YW1vdW50LAogICAgICAgICAgICB3aW5fYW1vdW50PXdpbiAtIGFtb3VudCwKICAgICAgICAgICAgZGljZV92YWx1ZT1mInt2MX0gKyB7djJ9ID0ge3RvdGFsMX0iLAogICAgICAgICAgICBuZXdfYmFsYW5jZT1uZXdfYmFsLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICBzdGF0dXM9IlRI4bquTkfinIUiLAogICAgICAgICAgICB1c2VyX2lkPXVzZXJfaWQsCiAgICAgICAgICAgIGZ1bGxuYW1lPWNhbGwuZnJvbV91c2VyLmZ1bGxfbmFtZSwKICAgICAgICAgICAgdXNlcm5hbWU9Y2FsbC5mcm9tX3VzZXIudXNlcm5hbWUKICAgICAgICApCgogICAgZWxpZiB0b3RhbDEgPT0gdG90YWwwOgogICAgICAgIHJldCA9IGFtb3VudCAvLyAyCiAgICAgICAgbmV3X2JhbCA9IGdldF9iYWxhbmNlKHVzZXJfaWQpICsgcmV0CiAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgbmV3X2JhbCkKICAgICAgICB1cGRhdGVfY2h1b2lfZmlsZSh1c2VyX2lkLCAwKQogICAgICAgIHVwZGF0ZV90aGFuZ3RodWEodXNlcl9pZCwgcmV0LCAwKQogICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYWN0aW9uLnVwcGVyKCksIGFtb3VudCwgLXJldCkKICAgICAgICB0ZXh0ID0gZiJ7djF9ICsge3YyfSA9IHt0b3RhbDF9XG7wn5SBIEjDsmEgLSBob8OgbiB7Zm9ybWF0X2JhbGFuY2UocmV0KX0gKOKIkntmb3JtYXRfYmFsYW5jZShyZXQpfSkiCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFVzZXIge3VzZXJfaWR9IGjDsmE6IGPGsOG7o2Mge2Ftb3VudH0sIHRy4bqjIGzhuqFpIHtyZXR9LCB04buVbmcge25ld19iYWx9IikKICAgICAgICBzZW5kX2FkbWluX3RkKAogICAgICAgICAgICBtZXNzYWdlPWNhbGwubWVzc2FnZSwKICAgICAgICAgICAgYmV0X3R5cGU9YWN0aW9uLnVwcGVyKCksCiAgICAgICAgICAgIGFtb3VudD1hbW91bnQsCiAgICAgICAgICAgIHdpbl9hbW91bnQ9LXJldCwKICAgICAgICAgICAgZGljZV92YWx1ZT1mInt2MX0gKyB7djJ9ID0ge3RvdGFsMX0iLAogICAgICAgICAgICBuZXdfYmFsYW5jZT1uZXdfYmFsLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICBzdGF0dXM9IkjDkkHwn5SBIiwKICAgICAgICAgICAgdXNlcl9pZD11c2VyX2lkLAogICAgICAgICAgICBmdWxsbmFtZT1jYWxsLmZyb21fdXNlci5mdWxsX25hbWUsCiAgICAgICAgICAgIHVzZXJuYW1lPWNhbGwuZnJvbV91c2VyLnVzZXJuYW1lCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICBuZXdfYmFsID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgICAgICB1cGRhdGVfY2h1b2lfZmlsZSh1c2VyX2lkLCAwKQogICAgICAgIHVwZGF0ZV90aGFuZ3RodWEodXNlcl9pZCwgYW1vdW50LCAwKQogICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYWN0aW9uLnVwcGVyKCksIGFtb3VudCwgLWFtb3VudCkKICAgICAgICBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgYW1vdW50KQogICAgICAgIHRleHQgPSBmInt2MX0gKyB7djJ9ID0ge3RvdGFsMX1cbuKdjCBUaHVhIHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfSAo4oiSe2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9KSIKICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gdGh1YTogY8aw4bujYyB7YW1vdW50fSwgbeG6pXQge2Ftb3VudH0sIHThu5VuZyB7bmV3X2JhbH0iKQogICAgICAgIHNlbmRfYWRtaW5fdGQoCiAgICAgICAgICAgIG1lc3NhZ2U9Y2FsbC5tZXNzYWdlLAogICAgICAgICAgICBiZXRfdHlwZT1hY3Rpb24udXBwZXIoKSwKICAgICAgICAgICAgYW1vdW50PWFtb3VudCwKICAgICAgICAgICAgd2luX2Ftb3VudD0tYW1vdW50LAogICAgICAgICAgICBkaWNlX3ZhbHVlPWYie3YxfSArIHt2Mn0gPSB7dG90YWwxfSIsCiAgICAgICAgICAgIG5ld19iYWxhbmNlPW5ld19iYWwsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHN0YXR1cz0iVEhVQeKdjCIsCiAgICAgICAgICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgICAgICAgICAgZnVsbG5hbWU9Y2FsbC5mcm9tX3VzZXIuZnVsbF9uYW1lLAogICAgICAgICAgICB1c2VybmFtZT1jYWxsLmZyb21fdXNlci51c2VybmFtZQogICAgICAgICkKCiAgICB1c2VyX2JldHMucG9wKHVzZXJfaWQsIE5vbmUpCgogICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgdGV4dCwgcmVwbHlfbWFya3VwPW1hcmt1cCkKICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjOiBjLmRhdGEuc3RhcnRzd2l0aCgiY29sbGVjdF8iKSkKZGVmIG9uX2NvbGxlY3QoY2FsbCk6CiAgICB1c2VyX2lkID0gaW50KGNhbGwuZGF0YS5zcGxpdCgiXyIpWzFdKQogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgIT0gdXNlcl9pZDoKICAgICAgICByZXR1cm4gYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgdHJ5OgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsIHJlcGx5X21hcmt1cD1Ob25lKQoKICAgICAgICBhbW91bnQsIHRvdGFsLCBjdW1fb2RkcyA9IHBvcF9iZXQodXNlcl9pZCkKICAgICAgICB3aW4gPSBpbnQoYW1vdW50ICogY3VtX29kZHMpCiAgICAgICAgcHJvZml0ID0gd2luIC0gYW1vdW50CiAgICAgICAgbmV3X2JhbCA9IGdldF9iYWxhbmNlKHVzZXJfaWQpICsgd2luCgogICAgICAgIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWQsIG5ld19iYWwpCiAgICAgICAgdXBkYXRlX3RoYW5ndGh1YSh1c2VyX2lkLCBhbW91bnQsIHdpbikKICAgICAgICB1cGRhdGVfY2h1b2lfZmlsZSh1c2VyX2lkLCB3aW4pCiAgICAgICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCAiVEQiLCBhbW91bnQsIHByb2ZpdCkKCiAgICAgICAgbXNnID0gKAogICAgICAgICAgICBmIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBXG4iCiAgICAgICAgICAgIGYi4pSj4p6kIE7hu5lpIGR1bmcgY8aw4bujYzogVERcbiIKICAgICAgICAgICAgZiLilKPinqQgU+G7kSB0aeG7gW4gY8aw4bujYzoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9xJFcbiIKICAgICAgICAgICAgZiLilKPinqQgVOG7iSBs4buHIHRo4bqvbmc6IHh7cm91bmQoY3VtX29kZHMsIDIpfVxuIgogICAgICAgICAgICBmIuKUo+KepCBT4buRIHRp4buBbiBuaOG6rW46IHtmb3JtYXRfYmFsYW5jZSh3aW4pfcSRXG4iCiAgICAgICAgICAgIGYi4pSj4p6kIFPhu5EgZMawIG3hu5tpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbCl9xJFcbiIKICAgICAgICAgICAgZiLilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIKICAgICAgICApCgogICAgICAgIG1zZ19zZW50ID0gYm90LnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgbXNnKQoKICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gxJHDoyBuaOG6rW4gdGnhu4FuOiB7d2lufSAoTMOjaToge3Byb2ZpdH0pLCB04buVbmcge25ld19iYWx9IikKICAgICAgICBzZW5kX2FkbWluX3RkKAogICAgICAgICAgICBtZXNzYWdlPWNhbGwubWVzc2FnZSwKICAgICAgICAgICAgYmV0X3R5cGU9IlREIiwKICAgICAgICAgICAgYW1vdW50PWFtb3VudCwKICAgICAgICAgICAgd2luX2Ftb3VudD1wcm9maXQsCiAgICAgICAgICAgIGRpY2VfdmFsdWU9ZiJU4buVbmcgY3Xhu5FpOiB7dG90YWx9IiwKICAgICAgICAgICAgbmV3X2JhbGFuY2U9bmV3X2JhbCwKICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgc3RhdHVzPSLinIUgxJDDoyBuaOG6rW4iLAogICAgICAgICAgICB1c2VyX2lkPWNhbGwuZnJvbV91c2VyLmlkLAogICAgICAgICAgICBmdWxsbmFtZT1jYWxsLmZyb21fdXNlci5mdWxsX25hbWUsCiAgICAgICAgICAgIHVzZXJuYW1lPWNhbGwuZnJvbV91c2VyLnVzZXJuYW1lCiAgICAgICAgKQoKICAgICAgICBpZiB1c2VyX2lkIGluIHVzZXJfYmV0czoKICAgICAgICAgICAgZGVsIHVzZXJfYmV0c1t1c2VyX2lkXQoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgeOG7rSBsw70gbmjhuq1uIHRp4buBbjoge2V9IikKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgoKZnJvbSB0ZWxlYm90IGltcG9ydCBUZWxlQm90CgpkZWYgc2VuZF9hZG1pbl90ZChtZXNzYWdlLCBiZXRfdHlwZSwgYW1vdW50LCB3aW5fYW1vdW50LCBkaWNlX3ZhbHVlLAogICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSwgbWVzc2FnZV9pZCwgc3RhdHVzLCB1c2VyX2lkLCBmdWxsbmFtZSwgdXNlcm5hbWUpOgoKICAgIEJPVDFfVE9LRU4gPSAiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIKICAgIEdST1VQX0lEID0gLTEwMDMyNDEwMDI0NzgKCiAgICBmdWxsbmFtZSA9IGZ1bGxuYW1lIG9yICIiCiAgICB1c2VybmFtZSA9IGYiQHt1c2VybmFtZX0iIGlmIHVzZXJuYW1lIGVsc2UgIiIKICAgIGRpY2VfdmFsdWUgPSBkaWNlX3ZhbHVlIG9yICIiCgogICAgbm90aWZpY2F0aW9uID0gZiIiIgrilI/ilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEK4pSj4p6kIE5nxrDhu51pIGTDuW5nOiA8YSBocmVmPSd0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9Jz48Yj57ZnVsbG5hbWV9PC9iPjwvYT4K4pSj4p6kIFVzZXJuYW1lOiB7dXNlcm5hbWV9CuKUo+KepCBJRDogPGNvZGU+e3VzZXJfaWR9PC9jb2RlPgrilKPinqQgTUdEOiB7bWVzc2FnZV9pZH0K4pSj4p6kIE7hu5lpIGR1bmcgxJHhurd0OiA8Yj57YmV0X3R5cGV9PC9iPgrilKPinqQgU+G7kSB4dSDEkeG6t3Q6IDxiPntmb3JtYXRfYmFsYW5jZShhbW91bnQpfTwvYj4K4pSj4p6kIFPhu5EgeHUgdGjhuq9uZzogPGI+e2Zvcm1hdF9iYWxhbmNlKHdpbl9hbW91bnQpfTwvYj4K4pSj4p6kIEvhur90IHF14bqjOiA8Yj57ZGljZV92YWx1ZX08L2I+CuKUo+KepCBT4buRIGTGsDogPGI+e2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX08L2I+CuKUo+KepCBUcuG6oW5nIHRow6FpOiA8Yj57c3RhdHVzfTwvYj4K4pSX4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCiIiIgoKICAgIHRyeToKICAgICAgICBib3QgPSBUZWxlQm90KEJPVDFfVE9LRU4pCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgR1JPVVBfSUQsCiAgICAgICAgICAgIG5vdGlmaWNhdGlvbiwKICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIsCiAgICAgICAgICAgIGRpc2FibGVfd2ViX3BhZ2VfcHJldmlldz1UcnVlCiAgICAgICAgKQogICAgICAgIHByaW50KCJbREVCVUddIEfhu61pIHRow7RuZyBiw6FvIFTEkCB0aMOgbmggY8O0bmcuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIFTEkDoge2V9IikKCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJ4dWN4YWNiYXZpZW4iKQpkZWYgeHVjeGFjYmF2aWVuKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgbWVzc2FnZSA9IGNhbGwubWVzc2FnZQogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0ZW1wX21lc3NhZ2UgPSAiIiI8Yj48Y29kZT7wn46yPC9jb2RlPiBYw5pDIFjhuq5DIDMtMTg8Y29kZT7wn46yPC9jb2RlPjwvYj4KTuG7mWkgZHVuZyB8ICBT4buRIMSRaeG7g20gIHwgIFThu7cgbOG7hyB0cuG6oyB0aMaw4bufbmcKPGI+REM8L2I+ICAgIHwgIDQsNiw4LDEwLDEyLDE0LDE2LDE4ICAgIHwgIHgxLjk1CjxiPkRMPC9iPiAgICB8ICAzLDUsNyw5LDExLDEzLDE1LDE3ICAgfCAgeDEuOTUKPGI+RFg8L2I+ICAgIHwgIDMsNCw1LDYsNyw4LDksMTAgICAgIHwgIHgxLjk1CjxiPkRUPC9iPiAgICB8ICAxMSwxMiwxMywxNCwxNSwxNiwxNywxOCAgfCAgeDEuOTUKClPhu5EgeHUgY2jGoWkgdOG7kWkgdGhp4buDdSBsw6AgMS4wMDAgdsOgIHThu5FpIMSRYSBsw6AgMzAwLjAwMApDw6FjaCBjaMahaToKCltO4buZaSBkdW5nXSBbeHUgY8aw4bujY10KLVZEOiA8Yj5EQyAxMDAwMDwvYj4gaG/hurdjIDxiPkRUIDEwMDAwPC9iPiIiIgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICBtZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB4b8OhIGlubGluZSBrZXlib2FyZCB0cm9uZyB4dWN4YWNiYXZpZW46IHtlfSIpCgogICAgICAgIHJlcGx5X21hcmt1cCA9IFJlcGx5S2V5Ym9hcmRNYXJrdXAocmVzaXplX2tleWJvYXJkPVRydWUpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OsiBEYW5oIHPDoWNoIEdhbWUnKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkaQgVMOgaSBLaG/huqNuJykpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+StSBO4bqhcCB0aeG7gW4nKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkrggUsO6dCB0aeG7gW4nKSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn46WIEJYSCDwn46WJyksIEtleWJvYXJkQnV0dG9uKCfwn4y6IEhvYSBI4buTbmcnKSkKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD10ZW1wX21lc3NhZ2UsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1yZXBseV9tYXJrdXAKICAgICAgICApCgoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeHVjeGFjYmF2aWVuOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogcmUubWF0Y2gocicoP2kpXihkdHxkeHxkY3xkbClccysoXGQrKSQnLCBtZXNzYWdlLnRleHQpKQpkZWYgcHJvY2Vzc19iZXQobWVzc2FnZSk6CiAgICBoYW5kbGVfYmV0KG1lc3NhZ2UsIGJvdCkKCmRlZiBoYW5kbGVfYmV0KG1lc3NhZ2UsIGJvdCk6CiAgICBnbG9iYWwgZ2FtZV9pbl9wcm9ncmVzcwogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBpZiBnYW1lX2luX3Byb2dyZXNzIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlIG9yIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgIHJldHVybgoKICAgIG1hdGNoID0gcmUubWF0Y2gocicoP2kpXihkdHxkeHxkY3xkbClccysoXGQrKScsIG1lc3NhZ2UudGV4dCkKICAgIGlmIG5vdCBtYXRjaDoKICAgICAgICByZXR1cm4KCiAgICBiZXRfdHlwZSA9IG1hdGNoLmdyb3VwKDEpLnVwcGVyKCkKICAgIGFtb3VudCA9IGludChtYXRjaC5ncm91cCgyKSkKCiAgICBpZiBhbW91bnQgPCBNSU5JTVVNX0JFVDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiJU4buRaSB0aGnhu4N1IHtmb3JtYXRfYmFsYW5jZShNSU5JTVVNX0JFVCl9IikKICAgICAgICByZXR1cm4KICAgIGlmIGFtb3VudCA+IE1BWElNVU1fQkVUOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIlThu5FpIMSRYSB7Zm9ybWF0X2JhbGFuY2UoTUFYSU1VTV9CRVQpfSIpCiAgICAgICAgcmV0dXJuCgogICAgdXNlcl9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIGlmIHVzZXJfYmFsYW5jZSA8IGFtb3VudDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyIpCiAgICAgICAgcmV0dXJuCgogICAgZ2FtZV9pbl9wcm9ncmVzcyA9IFRydWUKICAgIG5ld19iYWxhbmNlID0gdXNlcl9iYWxhbmNlIC0gYW1vdW50CiAgICB1cGRhdGVfdmljaGluaCh1c2VyX2lkLCBuZXdfYmFsYW5jZSkKICAgIHRydWN1b2N0aWVuKHVzZXJfaWQsIGFtb3VudCkKCiAgICBkaWNlX3Jlc3VsdHMgPSBbYm90LnNlbmRfZGljZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgcmVwbHlfdG9fbWVzc2FnZV9pZD1tZXNzYWdlLm1lc3NhZ2VfaWQpIGZvciBfIGluIHJhbmdlKDMpXQogICAgZGljZV92YWx1ZXMgPSBbZGljZS5kaWNlLnZhbHVlIGZvciBkaWNlIGluIGRpY2VfcmVzdWx0cyBpZiBkaWNlIGFuZCBkaWNlLmRpY2VdCiAgICB0b3RhbF9kaWNlID0gc3VtKGRpY2VfdmFsdWVzKQoKICAgIHdpbl9hbW91bnQgPSBpbnQoYW1vdW50ICogQkVUX0RbYmV0X3R5cGVdKSBpZiB0b3RhbF9kaWNlIGluIFdJTl9MW2JldF90eXBlXSBlbHNlIDAKICAgIG5ld19iYWxhbmNlICs9IHdpbl9hbW91bnQKICAgIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWQsIG5ld19iYWxhbmNlKQoKICAgIGlmIHdpbl9hbW91bnQgPT0gMDoKICAgICAgICBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgYW1vdW50KQoKICAgIHN0YXR1cyA9ICLinIUgVGjhuq9uZyIgaWYgd2luX2Ftb3VudCA+IDAgZWxzZSAi4p2MIFRodWEiCiAgICBtZXNzYWdlX2lkID0gcmFuZG9tLnJhbmRpbnQoMTAwMDAwLCA5OTk5OTkpCgogICAgcmVwb3J0ID0gZ2VuZXJhdGVfZ2FtZShtZXNzYWdlX2lkLCBtZXNzYWdlLmZyb21fdXNlciwgYmV0X3R5cGUsIGFtb3VudCwgd2luX2Ftb3VudCwgZGljZV92YWx1ZXMsIG5ld19iYWxhbmNlLCBzdGF0dXMpCiAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgcmVwb3J0LCByZXBseV9tYXJrdXA9a2V5Ym9hcmRidXR0b24oKSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X3R5cGUsIGFtb3VudCwgd2luX2Ftb3VudCkKICAgIHNlbmRfYWRtaW5fbm90aShib3QsIG1lc3NhZ2UsIGJldF90eXBlLCBhbW91bnQsIHdpbl9hbW91bnQsIGRpY2VfdmFsdWVzLCBuZXdfYmFsYW5jZSwgbWVzc2FnZV9pZCwgc3RhdHVzKQoKICAgIGdhbWVfaW5fcHJvZ3Jlc3MgPSBGYWxzZQoKZGVmIGdlbmVyYXRlX2dhbWUobWVzc2FnZV9pZCwgdXNlcl9pbmZvLCBiZXRfdHlwZSwgYW1vdW50LCB3aW5fYW1vdW50LCBkaWNlX3ZhbHVlcywgbmV3X2JhbGFuY2UsIHN0YXR1cyk6CiAgICBiZXRfZGlzcGxheSA9IHsiRFQiOiAiVCIsICJEWCI6ICJYIiwgIkRDIjogIkMiLCAiREwiOiAiTCJ9LmdldChiZXRfdHlwZSwgYmV0X3R5cGUpCiAgICB0b3RhbF9kaWNlID0gc3VtKGRpY2VfdmFsdWVzKQoKICAgIGlmIGJldF90eXBlIGluIFsiRFQiLCAiRFgiXToKICAgICAgICByZXN1bHRfbGFiZWwgPSAiVMOASSIgaWYgdG90YWxfZGljZSA+PSAxMSBlbHNlICJY4buIVSIKICAgIGVsaWYgYmV0X3R5cGUgaW4gWyJEQyIsICJETCJdOgogICAgICAgIHJlc3VsdF9sYWJlbCA9ICJDSOG6tE4iIGlmIHRvdGFsX2RpY2UgJSAyID09IDAgZWxzZSAiTOG6uiIKICAgIGVsc2U6CiAgICAgICAgcmVzdWx0X2xhYmVsID0gIiIKCiAgICBsb3NzX2Ftb3VudCA9IGFtb3VudCBpZiB3aW5fYW1vdW50ID09IDAgZWxzZSB3aW5fYW1vdW50CgogICAgcmV0dXJuIGYiIiIK4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEK4pSj4p6kIEdhbWU6IDxiPvCfjrIgMy0xODwvYj4K4pSj4p6kIE1HRDogPGI+e21lc3NhZ2VfaWR9PC9iPgrilKPinqQgTmfGsOG7nWkgY2jGoWk6IDxhIGhyZWY9J3RnOi8vdXNlcj9pZD17dXNlcl9pbmZvLmlkfSc+PGI+e3VzZXJfaW5mby5mdWxsX25hbWV9PC9iPjwvYT4K4pSj4p6kIE7hu5lpIGR1bmcgxJHhurd0OiA8Yj57YmV0X2Rpc3BsYXl9IHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfTwvYj4K4pSj4p6kIEvhur90IHF14bqjOiA8Yj57JyAnLmpvaW4obWFwKHN0ciwgZGljZV92YWx1ZXMpKX0gKHt0b3RhbF9kaWNlfSkge3Jlc3VsdF9sYWJlbH08L2I+CuKUo+KepCA8Yj57c3RhdHVzfSAoeyctJyBpZiB3aW5fYW1vdW50ID09IDAgZWxzZSAnKyd9e2Zvcm1hdF9iYWxhbmNlKGxvc3NfYW1vdW50KX0pPC9iPgrilKPinqQgU+G7kSBkxrA6IDxiPntmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9PC9iPgrilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgQogICAgIiIiCgpmcm9tIHRlbGVib3QgaW1wb3J0IFRlbGVCb3QKaW1wb3J0IGh0bWwKCmRlZiBzZW5kX2FkbWluX25vdGkoYm90LCBtZXNzYWdlLCBiZXRfdHlwZSwgYW1vdW50LCB3aW5fYW1vdW50LAogICAgICAgICAgICAgICAgICAgIGRpY2VfdmFsdWVzLCBuZXdfYmFsYW5jZSwgbWVzc2FnZV9pZCwgc3RhdHVzKToKCiAgICBCT1QxX1RPS0VOID0gIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiCiAgICBHUk9VUF9JRCA9IC0xMDAzMjQxMDAyNDc4CgogICAgdXNlcl9pbmZvID0gbWVzc2FnZS5mcm9tX3VzZXIKICAgIGZ1bGxuYW1lX2VzY2FwZWQgPSBodG1sLmVzY2FwZSh1c2VyX2luZm8uZnVsbF9uYW1lIG9yICIiKQoKICAgIG5vdGlmaWNhdGlvbiA9IGYiIiIK4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEK4pSj4p6kIE5nxrDhu51pIGTDuW5nOiA8YSBocmVmPSd0ZzovL3VzZXI/aWQ9e3VzZXJfaW5mby5pZH0nPjxiPntmdWxsbmFtZV9lc2NhcGVkfTwvYj48L2E+CuKUo+KepCBJRDogPGNvZGU+e3VzZXJfaW5mby5pZH08L2NvZGU+CuKUo+KepCBNR0Q6IHttZXNzYWdlX2lkfQrilKPinqQgTuG7mWkgZHVuZyDEkeG6t3Q6IHtodG1sLmVzY2FwZShiZXRfdHlwZSl9CuKUo+KepCBT4buRIHh1IMSR4bq3dDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9CuKUo+KepCBT4buRIHh1IHRo4bqvbmc6IHtmb3JtYXRfYmFsYW5jZSh3aW5fYW1vdW50KX0K4pSj4p6kIEvhur90IHF14bqjOiB7JyAnLmpvaW4obWFwKHN0ciwgZGljZV92YWx1ZXMpKX0gKFThu5VuZzoge3N1bShkaWNlX3ZhbHVlcyl9KQrilKPinqQgU+G7kSBkxrA6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9CuKUo+KepCBUcuG6oW5nIHRow6FpOiB7aHRtbC5lc2NhcGUoc3RhdHVzKX0K4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEKIiIiCgogICAgdHJ5OgogICAgICAgIGFkbWluX2JvdCA9IFRlbGVCb3QoQk9UMV9UT0tFTikKICAgICAgICBhZG1pbl9ib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBHUk9VUF9JRCwKICAgICAgICAgICAgbm90aWZpY2F0aW9uLAogICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIiwKICAgICAgICAgICAgZGlzYWJsZV93ZWJfcGFnZV9wcmV2aWV3PVRydWUKICAgICAgICApCiAgICAgICAgcHJpbnQoIltERUJVR10gR+G7rWkgdGjDtG5nIGLDoW8gYWRtaW4gdGjDoG5oIGPDtG5nLiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBn4butaSB0aMO0bmcgYsOhbyBhZG1pbjoge2V9IikKCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJib3dsaW5nIikKZGVmIGJvd2xpbmcoY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IGNhbGwuZnJvbV91c2VyLmlkCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0oY2FsbC5tZXNzYWdlKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNhbGwubWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICB0ZW1wX21lc3NhZ2UgPSAiIiI8Yj48Y29kZT7wn46zPC9jb2RlPiBHYW1lIEJvd2xpbmcgPGNvZGU+8J+OszwvY29kZT48L2I+Ck7hu5lpIGR1bmcgfCAgU+G7kSBraSBjw7JuIGzhuqFpICB8ICBUcuG6oyB0aMaw4bufbmcKPGI+IEJDPC9iPiAgICB8ICAwLCAyLCA2ICB8ICB4MS45NQo8Yj4gQkw8L2I+ICAgIHwgIDEsIDMsIDUgIHwgIHgxLjk1CjxiPiBCWDwvYj4gICAgfCAgMCwgMSwgMiAgfCAgeDEuOTUKPGI+IEJUPC9iPiAgICB8ICAzLCA1LCA2ICB8ICB4MS45NQpT4buRIHh1IGNoxqFpIHThu5FpIHRoaeG7g3UgbMOgIDEuMDAwIHbDoCB04buRaSDEkWEgbMOgIDMwMC4wMDAKCkPDoWNoIGNoxqFpOgotIENoYXQgdOG6oWkgxJHDonkgdGhlbyBjw7ogcGjDoXA6Ck7hu5lpIGR1bmcgW2ThuqV1IGPDoWNoXSBbeHUgY8aw4bujY10KVkQ6IDxiPkJDIDEwMDAwPC9iPiBob+G6t2MgPGI+QkwgMTAwMDA8L2I+IiIiCgogICAgICAgIGtleWJvYXJkID0gdHlwZXMuUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICBrZXlib2FyZC5yb3coCiAgICAgICAgICAgIHR5cGVzLktleWJvYXJkQnV0dG9uKCfwn46yIERhbmggc8OhY2ggR2FtZScpLAogICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbign8J+RpCBUw6BpIEtob+G6o24nKSkKICAgICAgICBrZXlib2FyZC5yb3coCiAgICAgICAgICAgIHR5cGVzLktleWJvYXJkQnV0dG9uKCfwn5K1IE7huqFwIHRp4buBbicpLAogICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbign8J+SuCBSw7p0IHRp4buBbicpKQogICAgICAgIGtleWJvYXJkLnJvdygKICAgICAgICAgICAgdHlwZXMuS2V5Ym9hcmRCdXR0b24oJ/CfjpYgQlhIIPCfjpYnKSwKICAgICAgICAgICAgdHlwZXMuS2V5Ym9hcmRCdXR0b24oJ/CfjLogSG9hIEjhu5NuZycpKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXRlbXBfbWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBib3dsaW5nOiB7ZX0iKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiYm93bGluZyIpCmRlZiBib3dsaW5nKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBjYWxsLmZyb21fdXNlci5pZAogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKGNhbGwubWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjYWxsLm1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKCiAgICAgICAgdGVtcF9tZXNzYWdlID0gIiIiPGI+8J+boCDEkGFuZyBi4bqjbyB0csOsPC9iPiIiIgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9dGVtcF9tZXNzYWdlLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBib3dsaW5nOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbTogcmUubWF0Y2gociJeKEJDfEJMfEJUfEJYKSBcZCskIiwgbS50ZXh0LnVwcGVyKCkpKQpkZWYgb25fYmV0KG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICB0eHQgPSBtZXNzYWdlLnRleHQudXBwZXIoKS5zdHJpcCgpCiAgICBub3cgPSB0aW1lLnRpbWUoKQoKICAgIGlmIHVzZXJfaWQgaW4gbGFzdF9jYWxsYmFja190aW1lIGFuZCBub3cgLSBsYXN0X2NhbGxiYWNrX3RpbWVbdXNlcl9pZF0gPCAyOgogICAgICAgIHJldHVybgogICAgbGFzdF9jYWxsYmFja190aW1lW3VzZXJfaWRdID0gbm93CgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcmV0dXJuCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgIGlmIHVzZXJfaWQgaW4gdXNlcl9iZXRzOgogICAgICAgIHJldHVybgoKICAgIGNtZCwgYW1vdW50X3N0ciA9IHR4dC5zcGxpdCgpCiAgICBhbW91bnQgPSBpbnQoYW1vdW50X3N0cikKCiAgICBpZiBhbW91bnQgPCBNSU5JTVVNX0JFVDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiJU4buRaSB0aGnhu4N1IHtmb3JtYXRfYmFsYW5jZShNSU5JTVVNX0JFVCl9IikKICAgICAgICByZXR1cm4KICAgIGlmIGFtb3VudCA+IE1BWElNVU1fQkVUOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIlThu5FpIMSRYSB7Zm9ybWF0X2JhbGFuY2UoTUFYSU1VTV9CRVQpfSIpCiAgICAgICAgcmV0dXJuCgogICAgYmFsID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIGlmIGJhbCA8IGFtb3VudDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyIpCiAgICAgICAgcmV0dXJuCgogICAgdXBkYXRlX2JhbGFuY2UodXNlcl9pZCwgYmFsIC0gYW1vdW50KQogICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYW1vdW50KQogICAgZGljZV9tc2cgPSBib3Quc2VuZF9kaWNlKG1lc3NhZ2UuY2hhdC5pZCwgZW1vamk9J/CfjrMnKQoKICAgIGJvd2xpbmdfYmV0c1t1c2VyX2lkXSA9IHsKICAgICAgICAiY2hvaWNlIjogY21kLAogICAgICAgICJhbW91bnQiOiBhbW91bnQsCiAgICAgICAgImluaXRpYWxfYmFsYW5jZSI6IGJhbCwKICAgICAgICAiZGljZV9tZXNzYWdlX2lkIjogZGljZV9tc2cubWVzc2FnZV9pZAogICAgfQoKICAgIHZhbCA9IGRpY2VfbXNnLmRpY2UudmFsdWUKICAgIHBpbnNfaGl0ID0gNiAtIHZhbCBpZiB2YWwgIT0gMCBlbHNlIDYKICAgIGlmIHBpbnNfaGl0ID09IDU6CiAgICAgICAgcGluc19oaXQgPSA2CiAgICBlbGlmIHBpbnNfaGl0ID09IDQ6CiAgICAgICAgcGluc19oaXQgPSA1CgogICAga2kgPSBwaW5zX2hpdAogICAgd2luID0gRmFsc2UKCiAgICBpZiBjbWQgPT0gIkJDIjoKICAgICAgICB3aW4gPSBraSBpbiBbMCwgMiwgNl0KICAgIGVsaWYgY21kID09ICJCTCI6CiAgICAgICAgd2luID0ga2kgaW4gWzEsIDMsIDVdCiAgICBlbGlmIGNtZCA9PSAiQlgiOgogICAgICAgIHdpbiA9IGtpIGluIFswLCAxLCAyXQogICAgZWxpZiBjbWQgPT0gIkJUIjoKICAgICAgICB3aW4gPSBraSBpbiBbMywgNSwgNl0KCiAgICBwcml6ZSA9IGludChhbW91bnQgKiAxLjk1KSBpZiB3aW4gZWxzZSAwCiAgICBuZXdfYmFsID0gYmFsIC0gYW1vdW50ICsgcHJpemUKICAgIHVwZGF0ZV9iYWxhbmNlKHVzZXJfaWQsIG5ld19iYWwpCgogICAgaWYgbm90IHdpbjoKICAgICAgICBjb25nX2hvYV9ob25nX3RodWEodXNlcl9pZCwgYW1vdW50KQoKICAgIG91dGNvbWVfdGV4dCA9ICgKICAgICAgICBmIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBXG4iCiAgICAgICAgZiLilKPinqQgR2FtZTogPGI+8J+Os0Jvd2xpbmfwn46zPC9iPlxuIgogICAgICAgIGYi4pSj4p6kIE5nxrDhu51pIGNoxqFpOiA8YSBocmVmPSd0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9Jz48Yj57bmFtZX08L2I+PC9hPlxuIgogICAgICAgIGYi4pSj4p6kIE7hu5lpIGR1bmcgxJHhurd0OiA8Yj57Y21kfSB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50KX08L2I+XG4iCiAgICAgICAgZiLilKPinqQgS+G6v3QgcXXhuqM6IDxiPntwaW5zX2hpdH08L2I+XG4iCiAgICApCgogICAgaWYgd2luOgogICAgICAgIG91dGNvbWVfdGV4dCArPSAoCiAgICAgICAgICAgIGYi4pSj4p6kIOKchSBUaOG6r25nICgre2Zvcm1hdF9iYWxhbmNlKHByaXplKX0pXG4iCiAgICAgICAgICAgIGYi4pSj4p6kIFPhu5EgZMawOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbCl9XG4iCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICBvdXRjb21lX3RleHQgKz0gKAogICAgICAgICAgICBmIuKUo+KepCDinYwgVGh1YSAoLXtmb3JtYXRfYmFsYW5jZShhbW91bnQpfSlcbiIKICAgICAgICAgICAgZiLilKPinqQgU+G7kSBkxrA6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsKX1cbiIKICAgICAgICApCgogICAgb3V0Y29tZV90ZXh0ICs9IGYi4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEiCgogICAga2V5Ym9hcmQgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAga2V5Ym9hcmQucm93KCfwn46yIERhbmggc8OhY2ggR2FtZScsICfwn5GkIFTDoGkgS2hv4bqjbicpCiAgICBrZXlib2FyZC5yb3coJ/CfkrUgTuG6oXAgdGnhu4FuJywgJ/CfkrggUsO6dCB0aeG7gW4nKQogICAga2V5Ym9hcmQucm93KCfwn46WIEJYSCDwn46WJywgJ/CfjLogSG9hIEjhu5NuZycpCgogICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIG91dGNvbWVfdGV4dCwgcGFyc2VfbW9kZT0iSFRNTCIsIHJlcGx5X21hcmt1cD1rZXlib2FyZCkKICAgIHN0YXR1cyA9ICLinIUgVGjhuq9uZyIgaWYgd2luIGVsc2UgIuKdjCBUaHVhIgogICAgbmRpZW4obWVzc2FnZSwgY21kLCBhbW91bnQsIHByaXplLCBwaW5zX2hpdCwgbmV3X2JhbCwgZGljZV9tc2cubWVzc2FnZV9pZCwgc3RhdHVzKQogICAgYm93bGluZ19iZXRzLnBvcCh1c2VyX2lkLCBOb25lKQoKZGVmIG5kaWVuKG1lc3NhZ2UsIGJldF90eXBlLCBhbW91bnQsIHdpbl9hbW91bnQsIGRpY2VfdmFsdWUsIG5ld19iYWxhbmNlLCBtZXNzYWdlX2lkLCBzdGF0dXMpOgogICAgQk9UMV9UT0tFTiA9ICI4MDc5MzE3MDM3OkFBRkswdGh0Yk9UZDBWZ3laeUExMVZyRTNlSjV5UFA2dXRZIgogICAgR1JPVVBfSUQgPSAtMTAwMzI0MTAwMjQ3OAoKICAgIHVzZXJfaW5mbyA9IG1lc3NhZ2UuZnJvbV91c2VyCiAgICBmdWxsbmFtZSA9IHVzZXJfaW5mby5mdWxsX25hbWUgb3IgIiIKICAgIHVzZXJuYW1lID0gZiJAe3VzZXJfaW5mby51c2VybmFtZX0iIGlmIHVzZXJfaW5mby51c2VybmFtZSBlbHNlICIiCiAgICBkaWNlX3ZhbHVlID0gZGljZV92YWx1ZSBvciAiIgoKICAgIG5vdGlmaWNhdGlvbiA9IGYiIiIK4pSP4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCuKUo+KepCBOZ8aw4budaSBkw7luZzogPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2luZm8uaWR9Jz48Yj57ZnVsbG5hbWV9PC9iPjwvYT4K4pSj4p6kIFVzZXJuYW1lOiB7dXNlcm5hbWV9CuKUo+KepCBJRDogPGNvZGU+e3VzZXJfaW5mby5pZH08L2NvZGU+CuKUo+KepCBNR0Q6IHttZXNzYWdlX2lkfQrilKPinqQgTuG7mWkgZHVuZyDEkeG6t3Q6IDxiPntiZXRfdHlwZX08L2I+CuKUo+KepCBT4buRIHh1IMSR4bq3dDogPGI+e2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9PC9iPgrilKPinqQgU+G7kSB4dSB0aOG6r25nOiA8Yj57Zm9ybWF0X2JhbGFuY2Uod2luX2Ftb3VudCl9PC9iPgrilKPinqQgS+G6v3QgcXXhuqM6IDxiPntkaWNlX3ZhbHVlfTwvYj4K4pSj4p6kIFPhu5EgZMawOiA8Yj57Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfTwvYj4K4pSj4p6kIFRy4bqhbmcgdGjDoWk6IDxiPntzdGF0dXN9PC9iPgrilJfilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEKIiIiCgogICAgdHJ5OgogICAgICAgIGFkbWluX2JvdCA9IHRlbGVib3QuVGVsZUJvdChCT1QxX1RPS0VOKQogICAgICAgIGFkbWluX2JvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEdST1VQX0lELAogICAgICAgICAgICBub3RpZmljYXRpb24sCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiLAogICAgICAgICAgICBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZQogICAgICAgICkKICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyBuZGllbiB0aMOgbmggY8O0bmcuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIG5kaWVuOiB7ZX0iKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAic2xvdDc3NyIpCmRlZiBzbG90Nzc3X2NhbGxiYWNrKGNhbGwpOgogICAgc2xvdDc3NyhjYWxsKQoKZGVmIHNsb3Q3NzcoY2FsbCwgZ2FtZV90eXBlPSJxdWF5aHU3NzciKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gY2FsbC5mcm9tX3VzZXIuaWQKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGh1c2xvdCA9IGdldF9odXNsb3RfYmFsYW5jZSgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3JlcGx5X21hcmt1cCgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPU5vbmUKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcGFzcwogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCiAgICAgICAgdGVtcF9tZXNzYWdlID0gZiIiIjxjb2RlPvCfjrA8L2NvZGU+IEdhbWUgUXVheSBTTE9UIDcgNyA3IDxjb2RlPvCfjrA8L2NvZGU+CgpDw6FjaCBjaMahaToKLSBDaOG7iSBj4bqnbiBn4butaSA8Y29kZT7wn46wPC9jb2RlPiBjaG8gYm90LCBu4bq/dSBr4bq/dCBxdeG6oyBsw6AgNyA3IDcgYuG6oW4gc+G6vSB0aOG6r25nIHRvw6BuIGLhu5kgdGnhu4FuIGjFqSEKCk3hu5dpIGzGsOG7o3QgcXVheSB04buRbiAyLjAwMCB4dS4KSMWpIGhp4buHbiB04bqhaSBsw6AgPGI+e2Rkc2QoaHVzbG90KX0geHU8L2I+IiIiCgogICAgICAgIHJlcGx5X21hcmt1cCA9IFJlcGx5S2V5Ym9hcmRNYXJrdXAocmVzaXplX2tleWJvYXJkPVRydWUpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OsiBEYW5oIHPDoWNoIEdhbWUnKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkaQgVMOgaSBLaG/huqNuJykpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+StSBO4bqhcCB0aeG7gW4nKSwgS2V5Ym9hcmRCdXR0b24oJ/CfkrggUsO6dCB0aeG7gW4nKSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn46WIEJYSCDwn46WJyksIEtleWJvYXJkQnV0dG9uKCfwn4y6IEhvYSBI4buTbmcnKSkKCiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD10ZW1wX21lc3NhZ2UsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1yZXBseV9tYXJrdXAKICAgICAgICApCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBzbG90Nzc3OiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29udGVudF90eXBlcz1bImRpY2UiXSkKZGVmIGhhbmRsZV9hbGxfZGljZShtZXNzYWdlKToKICAgIGRlZiBmb3JtYXRfbW9uZXkoeCk6CiAgICAgICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQoeCkucmVwbGFjZSgiLCIsICIuIikKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gc3RyKG1lc3NhZ2UuZnJvbV91c2VyLmlkKQogICAgICAgIGNoYXRfaWQgPSBtZXNzYWdlLmNoYXQuaWQKICAgICAgICBmdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZQogICAgICAgIEFETUlOX0lEID0gIjgyMDU1Njc4NTEiCiAgICAgICAgaWYgKG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlKSBhbmQgKHVzZXJfaWQgIT0gQURNSU5fSUQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiB04burIHVzZXIge3VzZXJfaWR9IGzDoCB0aW4gxJHGsOG7o2MgZm9yd2FyZCwgYuG7jyBxdWEuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKSBvciBpc191c2VyX2Jhbm5lZChpbnQodXNlcl9pZCkpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiB04burIHVzZXIge3VzZXJfaWR9IGLhu4sgeGVtIGzDoCBzcGFtIGhv4bq3YyDEkcOjIGLhu4sgYmFuLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGVtb2ppID0gbWVzc2FnZS5kaWNlLmVtb2ppCiAgICAgICAgdmFsdWUgPSBtZXNzYWdlLmRpY2UudmFsdWUKICAgICAgICBwcmludChmIltERUJVR10gRW1vamk6IHtlbW9qaX0gfCBWYWx1ZToge3ZhbHVlfSIpCiAgICAgICAgaWYgZW1vamkgPT0gIvCfjrAiOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gY2jGoWkgU0xPVCDwn46wIikKICAgICAgICAgICAgc2RfZmlsZSA9ICJGSUxFL3NkLnR4dCIKICAgICAgICAgICAgaHVfZmlsZSA9ICJGSUxFL2h1c2xvdC50eHQiCgogICAgICAgICAgICB1c2VyX2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkKQogICAgICAgICAgICBpZiB1c2VyX2JhbGFuY2UgPCAyMDAwOgogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiU+G7kSBkxrAga2jDtG5nIMSR4bunIMSR4buDIHF1YXkgU0xPVCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgdXBkYXRlX2JhbGFuY2UodXNlcl9pZCwgdXNlcl9iYWxhbmNlIC0gMjAwMCkKICAgICAgICAgICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgMjAwMCkKICAgICAgICAgICAgZGVjb2RlZCA9IGRlY29kZV9zbG90X3ZhbHVlKHZhbHVlKQogICAgICAgICAgICBkZWNvZGVkX3N0ciA9ICcgJy5qb2luKGVuZyBmb3IgdmlldCwgZW5nIGluIGRlY29kZWQpCiAgICAgICAgICAgIHZpZXRfbmFtZXMgPSBbdmlldCBmb3IgdmlldCwgZW5nIGluIGRlY29kZWRdCiAgICAgICAgICAgIGlzX2phY2twb3QgPSAodmlldF9uYW1lcyA9PSBbIjciLCAiNyIsICI3Il0pCgogICAgICAgICAgICBpZiBpc19qYWNrcG90OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGh1X2Ftb3VudCA9IGludChvcGVuKGh1X2ZpbGUpLnJlYWQoKS5zdHJpcCgpKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIGh1X2Ftb3VudCA9IDAKICAgICAgICAgICAgICAgIHVzZXJfYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWQpICsgaHVfYW1vdW50CiAgICAgICAgICAgICAgICB1cGRhdGVfYmFsYW5jZSh1c2VyX2lkLCB1c2VyX2JhbGFuY2UpCiAgICAgICAgICAgICAgICBvcGVuKGh1X2ZpbGUsICJ3Iikud3JpdGUoIjEwMDAwIikKCiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsIGYiIiLilI8g4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgQrilKPinqQgR2FtZTogU0xPVCA3IDcgNwrilKPinqQgU+G7kSB4dSDEkeG6t3Q6IDIuMDAwCuKUo+KepCBT4buRIHh1IHRo4bqvbmc6IHtmb3JtYXRfbW9uZXkoaHVfYW1vdW50KX0K4pSj4p6kIEvhur90IHF14bqjOiB7ZGVjb2RlZF9zdHJ9CuKUo+KepCBT4buRIGTGsDoge2Zvcm1hdF9tb25leSh1c2VyX2JhbGFuY2UpfQrilKPinqQgVHLhuqFuZyB0aMOhaTogVEjhuq5ORyDinIUK4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEiIiIpCiAgICAgICAgICAgICAgICBlbmRfdHVybl9mb3JfdXNlcih1c2VyX2lkKQogICAgICAgICAgICAgICAgdGhvbmdiYW9zbG90KAogICAgICAgIHVzZXJfaW5mbz1tZXNzYWdlLmZyb21fdXNlciwKICAgICAgICBmdWxsbmFtZT1mdWxsbmFtZSwKICAgICAgICB1c2VybmFtZT1tZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwKICAgICAgICBtZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICB3aW5fYW1vdW50PWh1X2Ftb3VudCwKICAgICAgICBkaWNlX3ZhbHVlPWRlY29kZWRfc3RyLAogICAgICAgIG5ld19iYWxhbmNlPXVzZXJfYmFsYW5jZSwKICAgICAgICBzdGF0dXM9IlRI4bquTkcg4pyFIgogICAgKQogICAgICAgICAgICAgICAgdGhvbmdiYW9ub2h1c2xvdCh1c2VyX2lkLCBmdWxsbmFtZSwgaHVfYW1vdW50LCBqYWNrcG90PVRydWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaHVfYW1vdW50ID0gaW50KG9wZW4oaHVfZmlsZSkucmVhZCgpLnN0cmlwKCkpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgaHVfYW1vdW50ID0gMAogICAgICAgICAgICAgICAgaHVfYW1vdW50ICs9IDEwMAogICAgICAgICAgICAgICAgb3BlbihodV9maWxlLCAidyIpLndyaXRlKHN0cihodV9hbW91bnQpKQogICAgICAgICAgICAgICAgdXNlcl9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKCiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXAgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OsicpLCBLZXlib2FyZEJ1dHRvbign8J+OsCcpKQogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OsycpKQoKICAgICAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgZiIiIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBCuKUo+KepCBHYW1lOiBTTE9UCuKUo+KepCBT4buRIHh1IMSR4bq3dDogMi4wMDAK4pSj4p6kIEvhur90IHF14bqjOiB7ZGVjb2RlZF9zdHJ9CuKUo+KepCBT4buRIGTGsDoge2Zvcm1hdF9tb25leSh1c2VyX2JhbGFuY2UpfQrilKPinqQgVHLhuqFuZyB0aMOhaTogVEhVQSDinYwK4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEiIiIsIHJlcGx5X21hcmt1cD1yZXBseV9tYXJrdXApCiAgICAgICAgICAgICAgICBlbmRfdHVybl9mb3JfdXNlcih1c2VyX2lkKQogICAgICAgICAgICAgICAgdGhvbmdiYW9zbG90KAogICAgICAgIHVzZXJfaW5mbz1tZXNzYWdlLmZyb21fdXNlciwKICAgICAgICBmdWxsbmFtZT1mdWxsbmFtZSwKICAgICAgICB1c2VybmFtZT1tZXNzYWdlLmZyb21fdXNlci51c2VybmFtZSwKICAgICAgICBtZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICB3aW5fYW1vdW50PTAsCiAgICAgICAgZGljZV92YWx1ZT1kZWNvZGVkX3N0ciwKICAgICAgICBuZXdfYmFsYW5jZT11c2VyX2JhbGFuY2UsCiAgICAgICAgc3RhdHVzPSJUSFVBIOKdjCIKICAgICkKCgogICAgICAgIGVsaWYgZW1vamkgPT0gIvCfjrIiOgogICAgICAgICAgICBzb2xvX3BsYXlpbmcgPSBGYWxzZQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhTT0xPX0ZJTEUpOgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKFNPTE9fRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIGZvciBjb2RlLCBpbmZvIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBpbmZvLmdldCgic3RhdHVzIikgPT0gIjIvMiIgYW5kIChpbmZvLmdldCgidXNlcl9pZCIpID09IHVzZXJfaWQgb3IgaW5mby5nZXQoInVzZXJfam9pbiIpID09IHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgICAgICBzb2xvX3BsYXlpbmcgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIHJvb21fY29kZSA9IGNvZGUKICAgICAgICAgICAgICAgICAgICAgICAgcm9vbSA9IGluZm8KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGlmIHNvbG9fcGxheWluZzoKICAgICAgICAgICAgICAgIGtldHF1YSA9IHZhbHVlCiAgICAgICAgICAgICAgICBhbW91bnQgPSByb29tLmdldCgiYW1vdW50IiwgMCkKICAgICAgICAgICAgICAgIHNob3J0X2NvZGUgPSByb29tX2NvZGUuc3BsaXQoIi0iKVswXQoKICAgICAgICAgICAgICAgIGlmICJ1c2VyX3h4IiBub3QgaW4gcm9vbToKICAgICAgICAgICAgICAgICAgICByb29tWyJ1c2VyX3h4Il0gPSB7fQogICAgICAgICAgICAgICAgaWYgInVzZXJfd2luIiBub3QgaW4gcm9vbToKICAgICAgICAgICAgICAgICAgICByb29tWyJ1c2VyX3dpbiJdID0gIiIKCiAgICAgICAgICAgICAgICBpZiB1c2VyX2lkIGluIHJvb21bInVzZXJfeHgiXToKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gxJHDoyB0dW5nIHjDumMgeOG6r2MgdHLGsOG7m2MgxJHDsywgYuG7jyBxdWEuIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICAgICByb29tWyJ1c2VyX3h4Il1bdXNlcl9pZF0gPSBrZXRxdWEKICAgICAgICAgICAgICAgIGRhdGFbcm9vbV9jb2RlXSA9IHJvb20KCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGluZGVudD0yLCBlbnN1cmVfYXNjaWk9RmFsc2UpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQ+G6rXAgbmjhuq10IGvhur90IHF14bqjIHR1bmcgeMO6YyB44bqvYyBj4bunYSB1c2VyIHt1c2VyX2lkfSB0cm9uZyBwaMOybmcge3Jvb21fY29kZX0uIikKCiAgICAgICAgICAgICAgICBpZiB1c2VyX2lkID09IHJvb20uZ2V0KCJ1c2VyX2lkIik6CiAgICAgICAgICAgICAgICAgICAgb3RoZXJfaWQgPSByb29tLmdldCgidXNlcl9qb2luIikKICAgICAgICAgICAgICAgIGVsaWYgdXNlcl9pZCA9PSByb29tLmdldCgidXNlcl9qb2luIik6CiAgICAgICAgICAgICAgICAgICAgb3RoZXJfaWQgPSByb29tLmdldCgidXNlcl9pZCIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSBraMO0bmcgcGjhuqNpIGNo4bunIHBow7JuZyBoYXkgbmfGsOG7nWkgdGhhbSBnaWEuIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgICAgICBpZiBub3Qgb3RoZXJfaWQ6CiAgICAgICAgICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJC4bqhbiDEkcOjIHRoYW0gZ2lhIHBow7JuZyBob+G6t2MgY2jGsGEgdHVuZyBYWC4iKQogICAgICAgICAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQ4buRaSB0aOG7pyBjaMawYSBjw7MgaG/hurdjIGNoxrBhIHR1bmcgeMO6YyB44bqvYy4iKQogICAgICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgICAgIGV4dHJhX25vdGUgPSAiIgogICAgICAgICAgICAgICAgaWYga2V0cXVhID09IDE6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfbm90ZSA9ICJcbkPhuqd1IG5ndXnhu4duIMSRaSAsIGJp4bq/dCDEkcOidSB0aOG6sW5nIGtpYSBjxaluZyByYSAxIgogICAgICAgICAgICAgICAgZWxpZiBrZXRxdWEgPT0gNjoKICAgICAgICAgICAgICAgICAgICBleHRyYV9ub3RlID0gIlxuQuG6oW4gdsO0IMSR4buLY2ggY21uciBy4buTaSBnw6F5IGzDqm4gdGjDtGkgbsOgbyIKCiAgICAgICAgICAgICAgICBpZiBvdGhlcl9pZCBub3QgaW4gcm9vbVsidXNlcl94eCJdOgogICAgICAgICAgICAgICAgICAgIG1zZ193YWl0ID0gKAogICAgICAgICAgICAgICAgICAgICAgICBmIlBow7JuZyBTT0xPOiA8Yj57c2hvcnRfY29kZX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYiVGnhu4FuIGPGsOG7o2M6IDxiPntmb3JtYXRfbW9uZXkoYW1vdW50KX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYiS+G6v3QgcXXhuqMgY+G7p2EgYuG6oW4gbMOgIDxiPntrZXRxdWF9PC9iPiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgaWYgZXh0cmFfbm90ZToKICAgICAgICAgICAgICAgICAgICAgICAgbXNnX3dhaXQgKz0gZiJ7ZXh0cmFfbm90ZX0iCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbXNnX3dhaXQgKz0gIlxuVnVpIGzDsm5nIMSR4bujaSDEkeG7kWkgdGjhu6cgdHVuZyBYWCIKCiAgICAgICAgICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIG1zZ193YWl0LCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG90aGVyX2lkLCAixJDhu5FpIHRo4bunIMSRw6MgdHVuZyBYWCB4b25nLCBi4bqhbiBow6N5IG5oYW5oIGNow7NuZyB0dW5nIFhYIMSR4buDIHBow6JuIMSR4buLbmggdGjhuq9uZyBi4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgecOqdSBj4bqndSBjaOG7nSDEkeG7kWkgdGjhu6cgdHVuZyBYWCBjaG8gdXNlciB7dXNlcl9pZH0gdsOgIMSR4buRaSB0aOG7pyB7b3RoZXJfaWR9LiIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAgICAgYm90LnJlcGx5X3RvKAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgZiJQaMOybmcgU09MTzogPGI+e3Nob3J0X2NvZGV9PC9iPlxuIgogICAgICAgICAgICAgICAgICAgIGYiVGnhu4FuIGPGsOG7o2M6IDxiPntmb3JtYXRfbW9uZXkoYW1vdW50KX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgZiJL4bq/dCBxdeG6oyBj4bunYSBi4bqhbiBsw6AgPGI+e2tldHF1YX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgZiJUaeG6v24gaMOgbmggeOG7rSBsw70gdHLhuq1uIMSR4bqldSIsCiAgICAgICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIpCgogICAgICAgICAgICAgICAgdXNlcjEsIHVzZXIyID0gcm9vbVsidXNlcl9pZCJdLCByb29tWyJ1c2VyX2pvaW4iXQogICAgICAgICAgICAgICAgeHgxID0gcm9vbVsidXNlcl94eCJdLmdldCh1c2VyMSkKICAgICAgICAgICAgICAgIHh4MiA9IHJvb21bInVzZXJfeHgiXS5nZXQodXNlcjIpCgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEvhur90IHF14bqjIHR1bmcgWFg6IHVzZXIxPXt1c2VyMX0gLT4ge3h4MX0sIHVzZXIyPXt1c2VyMn0gLT4ge3h4Mn0iKQoKICAgICAgICAgICAgICAgIGJhbCA9IHt9CiAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhTRF9GSUxFKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oU0RfRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCwgdmFsID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbFt1c2VyX2lkXSA9IGludCh2YWwpCgogICAgICAgICAgICAgICAgaWYgeHgxID09IHh4MjoKICAgICAgICAgICAgICAgICAgICBiYWxbdXNlcjFdID0gYmFsLmdldCh1c2VyMSwgMCkgKyBhbW91bnQKICAgICAgICAgICAgICAgICAgICBiYWxbdXNlcjJdID0gYmFsLmdldCh1c2VyMiwgMCkgKyBhbW91bnQKICAgICAgICAgICAgICAgICAgICBtc2cgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEgXG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFNPTE8gWMO6YyB44bqvY1xuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBQaMOybmcgc+G7kToge3Nob3J0X2NvZGV9XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIEtRIPCfjrIge3VzZXIxfTogPGI+e3h4MX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIEtRIPCfjrIge3VzZXIyfTogPGI+e3h4Mn08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFRS4bqgTkcgVEjDgUkgOiA8Yj5IT8OA8J+YkTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsIG1zZywgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShvdGhlcl9pZCwgbXNnLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgICAgICAgICBlbmRfdHVybl9mb3JfdXNlcih1c2VyX2lkKQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUcuG6rW4gxJHhuqV1IGjDsmEsIGPhu5luZyB0cuG6oyBs4bqhaSB0aeG7gW4gY8aw4bujYyBjaG8gMiB1c2VyLiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGlmIHh4MSA+IHh4MjoKICAgICAgICAgICAgICAgICAgICAgICAgd2lubmVyLCBsb3NlciA9IHVzZXIxLCB1c2VyMgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbm5lciwgbG9zZXIgPSB1c2VyMiwgdXNlcjEKICAgICAgICAgICAgICAgICAgICB0aWVuX3RoYW5nID0gaW50KGFtb3VudCAqIDEuOTcpCiAgICAgICAgICAgICAgICAgICAgdGJzb2xveHgocm9vbV9jb2RlLCB1c2VyMSwgdXNlcjIsIHh4MSwgeHgyLCB0aWVuX3RoYW5nKQogICAgICAgICAgICAgICAgICAgIGJhbFt3aW5uZXJdID0gYmFsLmdldCh3aW5uZXIsIDApICsgdGllbl90aGFuZwogICAgICAgICAgICAgICAgICAgIHJvb21bInVzZXJfd2luIl0gPSB3aW5uZXIKICAgICAgICAgICAgICAgICAgICBtc2dfd2luID0gKAogICAgICAgICAgICAgICAgICAgICAgICBmIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIFxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBTT0xPIFjDumMgeOG6r2NcbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilKPinqQgUGjDsm5nIHPhu5E6IHtzaG9ydF9jb2RlfVxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBUaeG7gW4gY8aw4bujYzogPGI+e2Zvcm1hdF9tb25leShhbW91bnQpfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilKPinqQgS1Eg8J+OsiB7dXNlcjF9OiA8Yj57eHgxfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilKPinqQgS1Eg8J+OsiB7dXNlcjJ9OiA8Yj57eHgyfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilKPinqQgVFLhuqBORyBUSMOBSSA6IDxiPlRI4bquTkfinIU8L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFRp4buBbiB0aOG6r25nOiA8Yj57Zm9ybWF0X21vbmV5KHRpZW5fdGhhbmcpfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilKPinqQgU+G7kSBkxrA6IDxiPntmb3JtYXRfbW9uZXkoYmFsW3dpbm5lcl0pfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgbXNnX2xvc2UgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEgXG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFNPTE8gWMO6YyB44bqvY1xuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBQaMOybmcgc+G7kToge3Nob3J0X2NvZGV9XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFRp4buBbiBjxrDhu6NjOiA8Yj57Zm9ybWF0X21vbmV5KGFtb3VudCl9PC9iPlxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBLUSDwn46yIHt1c2VyMX06IDxiPnt4eDF9PC9iPlxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBLUSDwn46yIHt1c2VyMn06IDxiPnt4eDJ9PC9iPlxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIuKUo+KepCBUUuG6oE5HIFRIw4FJIDogPGI+VEhVQSDinYw8L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgICAgIGYi4pSj4p6kIFPhu5EgZMawOiA8Yj57Zm9ybWF0X21vbmV5KGJhbFtsb3Nlcl0pfTwvYj5cbiIKICAgICAgICAgICAgICAgICAgICAgICAgZiLilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgY29uZ19ob2FfaG9uZ190aHVhKGxvc2VyLCBhbW91bnQpCiAgICAgICAgICAgICAgICAgICAgZW5kX3R1cm5fZm9yX3VzZXIodXNlcl9pZCkKICAgICAgICAgICAgICAgICAgICBtYXJrdXAgPSB0eXBlcy5SZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAgICAgICAgICAgICAgICAgIG1hcmt1cC5yb3coCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn46yIERhbmggc8OhY2ggR2FtZSIpLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+RpCBUw6BpIEtob+G6o24iKSkKICAgICAgICAgICAgICAgICAgICBtYXJrdXAucm93KAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+StSBO4bqhcCB0aeG7gW4iKSwKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfkrggUsO6dCB0aeG7gW4iKSkKICAgICAgICAgICAgICAgICAgICBtYXJrdXAucm93KAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+OliBCWEgg8J+OliIpLAogICAgICAgICAgICAgICAgICAgICAgICB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+MuiBIb2EgSOG7k25nIikpCiAgICAgICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSh3aW5uZXIsIG1zZ193aW4sIHBhcnNlX21vZGU9IkhUTUwiLCByZXBseV9tYXJrdXA9bWFya3VwKQogICAgICAgICAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobG9zZXIsIG1zZ19sb3NlLCBwYXJzZV9tb2RlPSJIVE1MIiwgcmVwbHlfbWFya3VwPW1hcmt1cCkKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gS+G6v3QgdGjDumMgdHLhuq1uIMSR4bqldTogTmfGsOG7nWkgdGjhuq9uZyB7d2lubmVyfSwgTmfGsOG7nWkgdGh1YSB7bG9zZXJ9LCBUaeG7gW4gdGjhuq9uZyB7dGllbl90aGFuZ30iKQoKICAgICAgICAgICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZm9yIHVzZXJfaWQsIHZhbCBpbiBiYWwuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7dmFsfVxuIikKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGPhuq1wIG5o4bqtdCBz4buRIGTGsCBuZ8aw4budaSBjaMahaSB2w6BvIHtTRF9GSUxFfSIpCgogICAgICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFIik6CiAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiKQoKICAgICAgICAgICAgICAgIGhpc3RvcnlfZW50cnkgPSB7CiAgICAgICAgICAgICAgICAgICAgInJvb21fY29kZSI6IHJvb21fY29kZSwKICAgICAgICAgICAgICAgICAgICAidXNlcl9pZCI6IHVzZXIxLAogICAgICAgICAgICAgICAgICAgICJ1c2VyX2pvaW4iOiB1c2VyMiwKICAgICAgICAgICAgICAgICAgICAiYW1vdW50IjogYW1vdW50LAogICAgICAgICAgICAgICAgICAgICJ1c2VyX3dpbiI6IHJvb20uZ2V0KCJ1c2VyX3dpbiIsICIiKSwKICAgICAgICAgICAgICAgICAgICAidXNlcl94eCI6IHJvb20uZ2V0KCJ1c2VyX3h4Iiwge30pLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiByb29tLmdldCgic3RhdHVzIiwgIiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc29sb3h4LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZl9oaXN0b3J5OgogICAgICAgICAgICAgICAgICAgIGZfaGlzdG9yeS53cml0ZShqc29uLmR1bXBzKGhpc3RvcnlfZW50cnksIGVuc3VyZV9hc2NpaT1GYWxzZSkgKyAiXG4iKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgbMawdSBs4buLY2ggc+G7rSB0cuG6rW4gxJHhuqV1IHBow7JuZyB7cm9vbV9jb2RlfSB2w6BvIHNvbG94eC50eHQiKQoKICAgICAgICAgICAgICAgIGRhdGEucG9wKHJvb21fY29kZSwgTm9uZSkKICAgICAgICAgICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXAoZGF0YSwgZiwgaW5kZW50PTIsIGVuc3VyZV9hc2NpaT1GYWxzZSkKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiB1c2VyX2RpY2Vfcm9sbGVkLmdldCh1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIHVzZXJfZGljZV9yb2xsZWRbdXNlcl9pZF0gPSBUcnVlCgogICAgICAgICAgICAgICAgdXNlcl9iZXQgPSB1c2VyX2JldHMuZ2V0KHVzZXJfaWQpCiAgICAgICAgICAgICAgICBpZiBub3QgdXNlcl9iZXQgb3IgJ2JldF9jaG9pY2UnIG5vdCBpbiB1c2VyX2JldCBvciAnYmV0X2Ftb3VudCcgbm90IGluIHVzZXJfYmV0OgogICAgICAgICAgICAgICAgICAgIHVzZXJfZGljZV9yb2xsZWQucG9wKHVzZXJfaWQsIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAgICAgYmV0X2Ftb3VudCA9IHVzZXJfYmV0WydiZXRfYW1vdW50J10KICAgICAgICAgICAgICAgIGJldF9jaG9pY2UgPSB1c2VyX2JldFsnYmV0X2Nob2ljZSddCiAgICAgICAgICAgICAgICB1c2VyX2RpY2UgPSB2YWx1ZQogICAgICAgICAgICAgICAgY3VycmVudF9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uX2lkID0gcmFuZG9tLnJhbmRpbnQoMTAwMDAwLCA5OTk5OTkpCgogICAgICAgICAgICAgICAgYm90X2RpY2VfbWVzc2FnZSA9IGJvdC5zZW5kX2RpY2UoY2hhdF9pZD1jaGF0X2lkLCByZXBseV90b19tZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZCkKICAgICAgICAgICAgICAgIGJvdF9kaWNlID0gYm90X2RpY2VfbWVzc2FnZS5kaWNlLnZhbHVlCgogICAgICAgICAgICAgICAgdXNlcl93aW5zID0gRmFsc2UKICAgICAgICAgICAgICAgIHdpbm5pbmdzID0gMAogICAgICAgICAgICAgICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UKCiAgICAgICAgICAgICAgICBpZiB1c2VyX2RpY2UgPT0gYm90X2RpY2U6CiAgICAgICAgICAgICAgICAgICAgbmV3X2JhbGFuY2UgKz0gYmV0X2Ftb3VudAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWQsIG5ld19iYWxhbmNlKQogICAgICAgICAgICAgICAgICAgIHJlc3VsdF90ZXh0ID0gZiIiIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBCuKUo+KepCBNR0Q6IDxiPnt0cmFuc2FjdGlvbl9pZH08L2I+CuKUo+KepCBC4bqhbjogPGI+e3VzZXJfZGljZX08L2I+CuKUo+KepCBCb3Q6IDxiPntib3RfZGljZX08L2I+CuKUo+KepCBT4buRIHh1IMSR4bq3dDogPGI+e2Zvcm1hdF9tb25leShiZXRfYW1vdW50KX08L2I+CuKUo+KepCBT4buRIHh1IHRo4bqvbmc6IDxiPjA8L2I+CuKUo+KepCBT4buRIGTGsDogPGI+e2Zvcm1hdF9tb25leShuZXdfYmFsYW5jZSl9PC9iPgrilKPinqQgVHLhuqFuZyB0aMOhaTogPGI+SMOSQTwvYj4K4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEiIiIKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgaWYgYmV0X2Nob2ljZSA9PSAnbGFyZ2UnOgogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX3dpbnMgPSB1c2VyX2RpY2UgPiBib3RfZGljZQogICAgICAgICAgICAgICAgICAgIGVsaWYgYmV0X2Nob2ljZSA9PSAnc21hbGwnOgogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX3dpbnMgPSB1c2VyX2RpY2UgPCBib3RfZGljZQoKICAgICAgICAgICAgICAgICAgICBpZiB1c2VyX3dpbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHdpbm5pbmdzID0gaW50KGJldF9hbW91bnQgKiAxLjk1KQogICAgICAgICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSArPSB3aW5uaW5ncwogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfdmljaGluaCh1c2VyX2lkLCBuZXdfYmFsYW5jZSkKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0X3RleHQgPSBmIiIi4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEK4pSj4p6kIE1HRDogPGI+e3RyYW5zYWN0aW9uX2lkfTwvYj4K4pSj4p6kIE7hu5lpIGR1bmcgxJHhurd0OiA8Yj57J0zhu5tuJyBpZiBiZXRfY2hvaWNlID09ICdsYXJnZScgZWxzZSAnTmjhu48nfTwvYj4K4pSj4p6kIELhuqFuOiA8Yj57dXNlcl9kaWNlfTwvYj4K4pSj4p6kIEJvdDogPGI+e2JvdF9kaWNlfTwvYj4K4pSj4p6kIFPhu5EgeHUgxJHhurd0OiA8Yj57Zm9ybWF0X21vbmV5KGJldF9hbW91bnQpfTwvYj4K4pSj4p6kIFPhu5EgeHUgdGjhuq9uZzogPGI+e2Zvcm1hdF9tb25leSh3aW5uaW5ncyl9PC9iPgrilKPinqQgU+G7kSBkxrA6IDxiPntmb3JtYXRfbW9uZXkobmV3X2JhbGFuY2UpfTwvYj4K4pSj4p6kIFRy4bqhbmcgdGjDoWk6IDxiPlRI4bquTkcg4pyFPC9iPgrilJcg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSIiIgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdF90ZXh0ID0gZiIiIuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBCuKUo+KepCBNR0Q6IDxiPnt0cmFuc2FjdGlvbl9pZH08L2I+CuKUo+KepCBO4buZaSBkdW5nIMSR4bq3dDogPGI+eydM4bubbicgaWYgYmV0X2Nob2ljZSA9PSAnbGFyZ2UnIGVsc2UgJ05o4buPJ308L2I+CuKUo+KepCBC4bqhbjogPGI+e3VzZXJfZGljZX08L2I+CuKUo+KepCBCb3Q6IDxiPntib3RfZGljZX08L2I+CuKUo+KepCBT4buRIHh1IMSR4bq3dDogPGI+e2Zvcm1hdF9tb25leShiZXRfYW1vdW50KX08L2I+CuKUo+KepCBT4buRIGTGsDogPGI+e2Zvcm1hdF9tb25leShuZXdfYmFsYW5jZSl9PC9iPgrilKPinqQgVHLhuqFuZyB0aMOhaTogPGI+VEhVQSDinYw8L2I+CuKUlyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIiIiCgogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cC5rZXlib2FyZCA9IFsKICAgICAgICAgICAgICAgICAgICBbJ/CfjrIgRGFuaCBzw6FjaCBHYW1lJywgJ/CfkaQgVMOgaSBLaG/huqNuJ10sCiAgICAgICAgICAgICAgICAgICAgWyfwn5K1IE7huqFwIHRp4buBbicsICfwn5K4IFLDunQgdGnhu4FuJ10sCiAgICAgICAgICAgICAgICAgICAgWyfwn46WIEJYSCDwn46WJywgJ/CfjLogSG9hIEjhu5NuZyddCiAgICAgICAgICAgICAgICBdCgogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCByZXN1bHRfdGV4dCwgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cCwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGltcG9ydCBhc3luY2lvCiAgICAgICAgICAgICAgICBhc3luY2lvLnJ1bihub3RpZnlfYWRtaW4odXNlcl9pZCxmdWxsbmFtZSxiZXRfY2hvaWNlLGJldF9hbW91bnQsdXNlcl9kaWNlLGJvdF9kaWNlLGN1cnJlbnRfYmFsYW5jZSxuZXdfYmFsYW5jZSx3aW5uaW5ncyx0cmFuc2FjdGlvbl9pZCkpCgoKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgI25vdGlmeV9hZG1pbih1c2VyX2lkLCBmdWxsbmFtZSwgYmV0X2Nob2ljZSwgYmV0X2Ftb3VudCx1c2VyX2RpY2UsIGJvdF9kaWNlLCBjdXJyZW50X2JhbGFuY2UsbmV3X2JhbGFuY2UsIHdpbm5pbmdzLCB0cmFuc2FjdGlvbl9pZCkKICAgICAgICAgICAgICAgIHVwZGF0ZV9nYW1lX2hpc3RvcnkodXNlcl9pZCwgYmV0X2Nob2ljZSwgYmV0X2Ftb3VudCwgd2lubmluZ3MpCiAgICAgICAgICAgICAgICB1c2VyX2JldHMucG9wKHVzZXJfaWQsIE5vbmUpCiAgICAgICAgICAgICAgICB1c2VyX2RpY2Vfcm9sbGVkLnBvcCh1c2VyX2lkLCBOb25lKQogICAgICAgICAgICAgICAgZW5kX3R1cm5fZm9yX3VzZXIodXNlcl9pZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBwYXNzCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgeOG7rSBsw70gZGljZToge2V9IikKCmRlZiB0aG9uZ2Jhb3Nsb3QodXNlcl9pbmZvLCBmdWxsbmFtZSwgdXNlcm5hbWUsIG1lc3NhZ2VfaWQsIHdpbl9hbW91bnQsIGRpY2VfdmFsdWUsIG5ld19iYWxhbmNlLCBzdGF0dXMpOgogICAgaW1wb3J0IHRlbGVib3QKCiAgICBCT1QxX1RPS0VOID0gIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiCiAgICBHUk9VUF9JRCA9IC0xMDAzMjQxMDAyNDc4CgogICAgYm90MSA9IHRlbGVib3QuVGVsZUJvdChCT1QxX1RPS0VOKQoKICAgIGRlZiBmb3JtYXRfYmFsYW5jZSh4KToKICAgICAgICByZXR1cm4gIns6LH0iLmZvcm1hdChpbnQoeCkpLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgdHJ5OgogICAgICAgIG1zZyA9ICgKICAgICAgICAgICAgIuKUj+KUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgVxuIgogICAgICAgICAgICBmIuKUo+KepCBOZ8aw4budaSBkw7luZzogPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2luZm8uaWR9Jz48Yj57ZnVsbG5hbWV9PC9iPjwvYT5cbiIKICAgICAgICAgICAgZiLilKPinqQgVXNlcm5hbWU6IEB7dXNlcm5hbWUgaWYgdXNlcm5hbWUgZWxzZSAnS2jDtG5nIGPDsyd9XG4iCiAgICAgICAgICAgIGYi4pSj4p6kIElEOiA8Y29kZT57dXNlcl9pbmZvLmlkfTwvY29kZT5cbiIKICAgICAgICAgICAgZiLilKPinqQgTUdEOiB7bWVzc2FnZV9pZH1cbiIKICAgICAgICAgICAgZiLilKPinqQgTuG7mWkgZHVuZyDEkeG6t3Q6IDxiPvCfjrA8L2I+XG4iCiAgICAgICAgICAgIGYi4pSj4p6kIFPhu5EgeHUgxJHhurd0OiA8Yj4yLjAwMDwvYj5cbiIKICAgICAgICAgICAgZiLilKPinqQgU+G7kSB4dSB0aOG6r25nOiA8Yj57Zm9ybWF0X2JhbGFuY2Uod2luX2Ftb3VudCl9PC9iPlxuIgogICAgICAgICAgICBmIuKUo+KepCBL4bq/dCBxdeG6ozogPGI+e2RpY2VfdmFsdWV9PC9iPlxuIgogICAgICAgICAgICBmIuKUo+KepCBT4buRIGTGsDogPGI+e2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX08L2I+XG4iCiAgICAgICAgICAgIGYi4pSj4p6kIFRy4bqhbmcgdGjDoWk6IDxiPntzdGF0dXN9PC9iPlxuIgogICAgICAgICAgICAi4pSX4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBIgogICAgICAgICkKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShHUk9VUF9JRCwgbXNnLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gR+G7rWkgdGjDtG5nIGLDoW8gU0xPVCB0aOG6pXQgYuG6oWk6IHtlfSIpCgpkZWYgdGhvbmdiYW9ub2h1c2xvdCh1c2VyX2lkOiBpbnQsIGZ1bGxuYW1lOiBzdHIsIGh1X2Ftb3VudDogaW50LCBqYWNrcG90PUZhbHNlKToKICAgIGJvdF90b2tlbiA9ICc4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFJwogICAgYm90ID0gdGVsZWJvdC5UZWxlQm90KGJvdF90b2tlbikKCiAgICBjaGF0X2lkID0gLTEwMDM1ODk5NDIyODcKICAgIGlmIGphY2twb3Q6CiAgICAgICAgdGV4dCA9ICgKICAgICAgICAgICAgZiLwn46wQ2jDumMgbeG7q25nIG5nxrDhu51pIGNoxqFpIDxhIGhyZWY9J3RnOi8vdXNlcj9pZD17dXNlcl9pZH0nPntmdWxsbmFtZX08L2E+IHbhu6thIG7hu5UgaMWpIFNMT1QgNzc3IHbDoCBuaOG6rW4gIgogICAgICAgICAgICBmIjxiPntmb3JtYXRfY3VycmVuY3koaHVfYW1vdW50KX08L2I+IgogICAgICAgICkKICAgIGVsc2U6CiAgICAgICAgdGV4dCA9ICgKICAgICAgICAgICAgZiLwn46wTmfGsOG7nWkgY2jGoWkgPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2lkfSc+e2Z1bGxuYW1lfTwvYT4gduG7q2EgdGjhuq9uZyBTTE9UIHbDoCBuaOG6rW4gIgogICAgICAgICAgICBmIjxiPntmb3JtYXRfY3VycmVuY3koaHVfYW1vdW50KX08L2I+IgogICAgICAgICkKCiAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9Y2hhdF9pZCwgdGV4dD10ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidGFpeGl1bWQ1IikKZGVmIGhhbmRsZV90eGNsbWQ1KGNhbGwpOgogICAgdGFpeGl1bWQ1KGNhbGwsICJ0YWl4aXVtZDUiKQpkZWYgdGFpeGl1bWQ1KGNhbGwsIGdhbWVfdHlwZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IGNhbGwuZnJvbV91c2VyLmlkCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHBhc3MKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgdGVtcF9tZXNzYWdlID0gIiIiCjxiPvCfkqUgR0FNRSBDSOG6tE4gTOG6uiBNRDUgVOG6oEkgUk9PTSDwn5KlPC9iPgpOaMOzbSDEkeG7gyBjaMahaSBnYW1lOiBodHRwczovL3QubWUvcm9vbXRpbmhsaW5oCkzGsHUgw70gY8OhYyBs4buHbmggc2F1IMSRxrDhu6NjIGNoxqFpIHThuqFpIFJvb20sIG7hur91IGNoxqFpIHThuqFpIEJvdCBz4bq9IGzDoCBnYW1lIGtow6FjIHbDoCBjw6FjaCB0w61uaCBr4bq/dCBxdeG6oyBraMOhYyBzbyB24bubaSBSb29tLgoKPGk+Qm90IHPhur0gdOG6oW8gMSBLRVkgdHLGsOG7m2Mgc2F1IMSRw7MgSGFzaCB0aMOgbmggY2h14buXaSBNRDUgdsOgIGfhu61pIGzDqm4gR3JvdXAsIGNodeG7l2kgTUQ1IGzDoCBkdXkgbmjhuqV0IHbDoCBraMO0bmcgdGjhu4Mgc+G7rWEgxJHhu5VpLgpOZ8aw4budaSBjaMahaSBjw7MgMTAwcyDEkeG7gyDEkeG6t3QgY8aw4bujYyBUWENMIE1ENSwgc2F1IDEwMHMgc+G6vSBjw7RuZyBi4buRIEtFWSDEkcOjIHThuqFvLiBL4bq+VCBRVeG6oiDEkcaw4bujYyB0w61uaCBi4bqxbmcgc+G7kSBjdeG7kWkgY8O5bmcgY+G7p2EgS0VZLgpOZ8aw4budaSBjaMahaSBjw7MgdGjhu4MgY29weSBLRVkgdsOgIGTDoW4gdsOgbyBtZDUuY3ogxJHhu4Mga2nhu4NtIHRyYSBNRDUgxJHDoyBjw7RuZyBi4buRIGPDsyB0csO5bmcgduG7m2kgTUQ1IGNoZWNrIMSRxrDhu6NjIGhheSBraMO0bmcuPC9pPgotLS0tLS0tLS0tLS0tLS0tLS0tLQo8Yj5HQU1FIFRYQ0wgTUQ1IHggMS45NTwvYj4KTuG7mWkgZHVuZyAgfCBT4buRIGN14buRaSB8IFThu7cgbOG7hyB0cuG6oyB0aMaw4bufbmcKTVQgICAgfCA1IDYgNyA4IDkgICAgIHwgMS45NQpNWCAgICB8IDAgMSAyIDMgNCAgICAgfCAxLjk1Ck1DICAgIHwgMCAyIDQgNiA4ICAgICB8IDEuOTUKTUwgICAgfCAxIDMgNSA3IDkgICAgIHwgMS45NQoK4oCiIFThu7cgbOG7hyB0cuG6oyB0aMaw4bufbmcgMS45NQpM4buHbmggY8aw4bujYzogW01UL01YL01DL01MXSBbdGnhu4FuIGNoxqFpXQpWRDogPGI+TVQgMjAwMDA8L2I+CiIiIgogICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXRlbXBfbWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB0YWl4aXVtZDU6IHtlfSIpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhIGluIFsieHVjeGFjbG9uaG8iLCAieHVjeGFjbG9ubmhvIl0pCmRlZiB4dWN4YWNsb25obyhjYWxsKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gY2FsbC5mcm9tX3VzZXIuaWQKICAgICAgICBtZXNzYWdlID0gY2FsbC5tZXNzYWdlCgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIG1lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPU5vbmUKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB4w7NhIGlubGluZSBrZXlib2FyZDoge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYm90LmRlbGV0ZV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgdGVtcF9tZXNzYWdlID0gIiIiCjxiPjxjb2RlPvCfjrI8L2NvZGU+IEdBTUUgTOG6rkMgWMONIE5H4bqmVSBM4buaTiBOSOG7jiA8Y29kZT7wn46yPC9jb2RlPjwvYj4KRMO5bmcga+G6v3QgcXXhuqMgeMOtIG5n4bqndSBj4bunYSBi4bqhbiDEkeG7gyBzbyBzw6FuaCB24bubaSBCb3QKTuG6v3Uga+G6v3QgcXXhuqMgxJHDum5nIG5oxrAgYuG6oW4gxJHDoyBjaOG7jW4gdGjDrCBi4bqhbiBz4bq9IGNoaeG6v24gdGjhuq9uZwpU4bu3IGzhu4cgdHLhuqMgdGjGsOG7n25nOiAxLjk1CkPDoWNoIGNoxqFpOiA8Yj5MTiBbU+G7kSB4dV08L2I+ClbDrSBk4bulOiAgIDxiPkxOIDUwMDAwPC9iPgoiIiIKICAgICAgICByZXBseV9tYXJrdXAgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlKQogICAgICAgIHJlcGx5X21hcmt1cC5yb3coS2V5Ym9hcmRCdXR0b24oJ/CfjrIgRGFuaCBzw6FjaCBHYW1lJyksIEtleWJvYXJkQnV0dG9uKCfwn5GkIFTDoGkgS2hv4bqjbicpKQogICAgICAgIHJlcGx5X21hcmt1cC5yb3coS2V5Ym9hcmRCdXR0b24oJ/CfkrUgTuG6oXAgdGnhu4FuJyksIEtleWJvYXJkQnV0dG9uKCfwn5K4IFLDunQgdGnhu4FuJykpCiAgICAgICAgcmVwbHlfbWFya3VwLnJvdyhLZXlib2FyZEJ1dHRvbign8J+OliBCWEgg8J+OlicpLCBLZXlib2FyZEJ1dHRvbign8J+MuiBIb2EgSOG7k25nJykpCgogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCiAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXRlbXBfbWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cAogICAgICAgICkKCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB4dWN4YWNsb25obzoge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IHJlLm1hdGNoKHInKD9pKV5sblxzKyhcZCspJCcsIG1lc3NhZ2UudGV4dCkpCmRlZiB4dWN4YWNsb25obyhtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBzdHIobWVzc2FnZS5mcm9tX3VzZXIuaWQpCiAgICBjaGF0X2lkID0gbWVzc2FnZS5jaGF0LmlkCiAgICBtZXNzYWdlX3RleHQgPSBtZXNzYWdlLnRleHQuc3RyaXAoKQoKICAgIHNvbG9fcGxheWluZywgcm9vbV9jb2RlLCBfLCBzb2xvX2Ftb3VudCA9IGlzX3VzZXJfaW5fc29sb19yb29tKHVzZXJfaWQpCiAgICBsbl9wbGF5aW5nLCBsbl9hbW91bnQgPSBpc191c2VyX2luX2xuX2JldCh1c2VyX2lkKQoKICAgIGlmIHNvbG9fcGxheWluZzoKICAgICAgICByZXR1cm4KICAgIGlmIGxuX3BsYXlpbmc6CiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcmV0dXJuCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgXywgYW1vdW50X3N0ciA9IG1lc3NhZ2VfdGV4dC5zcGxpdCgpCiAgICAgICAgYW1vdW50ID0gaW50KGFtb3VudF9zdHIpCiAgICAgICAgYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWQpCiAgICAgICAgaWYgYW1vdW50ID4gYmFsYW5jZToKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiU+G7kSBkxrAga2jDtG5nIMSR4bunIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYW1vdW50IDwgTUlOSU1VTV9CRVQ6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgZiJU4buRaSB0aGnhu4N1IHtmb3JtYXRfYmFsYW5jZShNSU5JTVVNX0JFVCl9IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYW1vdW50ID4gTUFYSU1VTV9CRVQ6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgZiJU4buRaSDEkWEge2Zvcm1hdF9iYWxhbmNlKE1BWElNVU1fQkVUKX0iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgYmFsYW5jZSAtIGFtb3VudCkKICAgICAgICB0cnVjdW9jdGllbih1c2VyX2lkLCBhbW91bnQpCiAgICAgICAgdXNlcl9iZXRzW3VzZXJfaWRdID0geydiZXRfYW1vdW50JzogYW1vdW50fQogICAgICAgIGZvcm1hdHRlZF9hbW91bnQgPSBmb3JtYXRfYmFsYW5jZShhbW91bnQpCgogICAgICAgIGtleWJvYXJkID0gWwogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigiQ2jhu41uIEzhu5tuIiwgY2FsbGJhY2tfZGF0YT0nbGFyZ2UnKSwKICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCJDaOG7jW4gTmjhu48iLCBjYWxsYmFja19kYXRhPSdzbWFsbCcpCiAgICAgICAgICAgIF0KICAgICAgICBdCiAgICAgICAgcmVwbHlfbWFya3VwID0gSW5saW5lS2V5Ym9hcmRNYXJrdXAoa2V5Ym9hcmQpCgogICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkLAogICAgICAgICAgICAiIiLimqDvuI8gVnVpIGzDsm5nIGNo4buNbiBM4bubbiBob+G6t2MgTmjhu48KCuKaoO+4jyBDaOG7jW4gTOG7m24gbuG6v3UgeMOtIG5n4bqndSBj4bunYSBi4bqhbiBM4bubbiBoxqFuIHjDrSBuZ+G6p3UgY+G7p2EgQm90IGLhuqFuIHPhur0gdGjhuq9uZwoK4pqg77iPIENo4buNbiBOaOG7jyBu4bq/dSB4w60gbmfhuqd1IGPhu6dhIGLhuqFuIE5o4buPIGjGoW4geMOtIG5n4bqndSBj4bunYSBCb3QgYuG6oW4gc+G6vSB0aOG6r25nIiIiLAogICAgICAgICAgICByZXBseV9tYXJrdXA9cmVwbHlfbWFya3VwCiAgICAgICAgKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcGFzcwoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSBpbiBbJ2xhcmdlJywgJ3NtYWxsJ10pCmRlZiB0cmFsb2lsbihjYWxsKToKICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICBjaGF0X2lkID0gY2FsbC5tZXNzYWdlLmNoYXQuaWQKICAgIG1lc3NhZ2VfaWQgPSBjYWxsLm1lc3NhZ2UubWVzc2FnZV9pZAoKICAgIHByaW50KGYiW0RFQlVHXSBDYWxsYmFjayB04burIHVzZXIge3VzZXJfaWR9IC0gQ2jhu41uOiB7Y2FsbC5kYXRhfSIpCgogICAgdHJ5OgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKGNoYXRfaWQ9Y2hhdF9pZCwgbWVzc2FnZV9pZD1tZXNzYWdlX2lkLCByZXBseV9tYXJrdXA9Tm9uZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeMOzYSBpbmxpbmUga2V5Ym9hcmQ6IHtlfSIpCgogICAgbm93ID0gdGltZS50aW1lKCkKICAgIGlmIHVzZXJfaWQgaW4gbGFzdF9iZXRfdGltZSBhbmQgbm93IC0gbGFzdF9iZXRfdGltZVt1c2VyX2lkXSA8IDI6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIFVzZXIge3VzZXJfaWR9IHNwYW0gY2FsbGJhY2sgcXXDoSBuaGFuaC4iKQogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICByZXR1cm4KICAgIGxhc3RfYmV0X3RpbWVbdXNlcl9pZF0gPSBub3cKCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gxJFhbmcgYuG7iyBiYW4uIikKICAgICAgICByZXR1cm4KCiAgICBpZiB1c2VyX2lkIGluIHVzZXJfYmV0cyBhbmQgJ2JldF9jaG9pY2UnIGluIHVzZXJfYmV0c1t1c2VyX2lkXToKICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0gxJHDoyBjaOG7jW4gY+G7rWEgdHLGsOG7m2MgxJHDsy4iKQogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICByZXR1cm4KCiAgICBiZXRfZGF0YSA9IHVzZXJfYmV0cy5nZXQodXNlcl9pZCkKICAgIGlmIG5vdCBiZXRfZGF0YSBvciBiZXRfZGF0YS5nZXQoJ2JldF9hbW91bnQnLCAwKSA8PSAwOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgZOG7ryBsaeG7h3UgY8aw4bujYyBob+G6t2MgdGnhu4FuIGPGsOG7o2MgPD0gMCBjaG8gdXNlciB7dXNlcl9pZH0iKQogICAgICAgIHJldHVybgoKICAgIGJldF9hbW91bnQgPSBiZXRfZGF0YVsnYmV0X2Ftb3VudCddCiAgICB1c2VyX2Nob2ljZSA9IGNhbGwuZGF0YQogICAgdXNlcl9iZXRzW3VzZXJfaWRdWydiZXRfY2hvaWNlJ10gPSB1c2VyX2Nob2ljZQoKICAgIGZvcm1hdHRlZF9hbW91bnQgPSBmb3JtYXRfYmFsYW5jZShiZXRfYW1vdW50KQoKICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSBjaOG7jW4ge3VzZXJfY2hvaWNlfSB24bubaSBz4buRIHRp4buBbiBjxrDhu6NjIHtmb3JtYXR0ZWRfYW1vdW50fSIpCgogICAgbmV3X3RleHQgPSBmIiIi4pyFIELhuqFuIMSRw6MgY2jhu41uIHsnTOG7m24nIGlmIHVzZXJfY2hvaWNlID09ICdsYXJnZScgZWxzZSAnTmjhu48nfQoK4pyFIFRp4buBbiBjxrDhu6NjIGzDoDoge2Zvcm1hdHRlZF9hbW91bnR9CgrimqDvuI8gTuG6v3UgeMOtIG5n4bqndSBj4bunYSBi4bqhbiB7J0zhu5tuJyBpZiB1c2VyX2Nob2ljZSA9PSAnbGFyZ2UnIGVsc2UgJ05o4buPJ30gaMahbiBj4bunYSBib3QgYuG6oW4gc+G6vSB0aOG6r25nCgpC4bqvdCDEkeG6p3UgY2jGoWkgaMOjeSBn4butaSBiaeG7g3UgdMaw4bujbmcg8J+OsiDEkeG7gyB0dW5nIHjDumMgeOG6r2MuCiIiIgoKICAgIGtleWJvYXJkID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSkKICAgIGtleWJvYXJkLmFkZChLZXlib2FyZEJ1dHRvbigi8J+OsiIpKQoKICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9Y2hhdF9pZCwgdGV4dD1uZXdfdGV4dCwgcmVwbHlfbWFya3VwPWtleWJvYXJkLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQoKICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCmFzeW5jIGRlZiBub3RpZnlfYWRtaW4oCiAgICB1c2VyX2lkOiBpbnQsCiAgICBmdWxsbmFtZTogc3RyLAogICAgYmV0X2Nob2ljZTogc3RyLAogICAgYmV0X2Ftb3VudDogaW50LAogICAgdXNlcl9kaWNlOiBpbnQsCiAgICBib3RfZGljZTogaW50LAogICAgY3VycmVudF9iYWxhbmNlOiBpbnQsCiAgICBuZXdfYmFsYW5jZTogaW50LAogICAgd2lubmluZ3M6IGludCA9IDAsCiAgICB0cmFuc2FjdGlvbl9pZDogaW50ID0gMAopOgogICAgaW1wb3J0IGh0bWwKICAgIEJPVDFfVE9LRU4gPSAiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIKICAgIEdST1VQX0lEID0gLTEwMDMyNDEwMDI0NzgKCiAgICBpZiB3aW5uaW5ncyA+IDA6CiAgICAgICAgc3RhdHVzID0gIlRI4bquTkcg4pyFIgogICAgICAgIGFkZGl0aW9uYWxfaW5mbyA9IGYi4pSj4p6kIFPhu5EgeHUgdGjhuq9uZzoge2Zvcm1hdF9iYWxhbmNlKHdpbm5pbmdzKX1cbiIKICAgIGVsaWYgdXNlcl9kaWNlID09IGJvdF9kaWNlOgogICAgICAgIHN0YXR1cyA9ICJIw5JBIgogICAgICAgIGFkZGl0aW9uYWxfaW5mbyA9ICIiCiAgICBlbHNlOgogICAgICAgIHN0YXR1cyA9ICJUSFVBIOKdjCIKICAgICAgICBhZGRpdGlvbmFsX2luZm8gPSAiIgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWQpCiAgICAgICAgICAgIHJlZmVycmVyX2lkID0gTm9uZQogICAgICAgICAgICByZWZfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJyZWYudHh0IikKICAgICAgICAgICAgc2RfcGF0aCA9IG9zLnBhdGguam9pbigiRklMRSIsICJzZC50eHQiKQoKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocmVmX3BhdGgpOgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKHJlZl9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJyZXJfaWQgPSBwYXJ0c1sxXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgIGlmIHJlZmVycmVyX2lkOgogICAgICAgICAgICAgICAgaG9haG9uZyA9IGludChiZXRfYW1vdW50ICogMC4wMikKICAgICAgICAgICAgICAgIGxpbmVzID0gW10KICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBGYWxzZQoKICAgICAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHNkX3BhdGgpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihzZF9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpIDwgMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdWlkLCB2YWwgPSBwYXJ0cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdWlkID09IHJlZmVycmVyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld3ZhbCA9IGludCh2YWwpICsgaG9haG9uZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1aWR9IHtuZXd2YWx9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lIGlmIGxpbmUuZW5kc3dpdGgoIlxuIikgZWxzZSBsaW5lICsgIlxuIikKCiAgICAgICAgICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7cmVmZXJyZXJfaWR9IHtob2Fob25nfVxuIikKCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oc2RfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyhsaW5lcykKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gY+G7mW5nIGhvYSBo4buTbmcgdHJvbmcgbm90aWZ5X2FkbWluOiB7ZX0iKQoKICAgIGZvcm1hdHRlZF9mdWxsbmFtZSA9IGh0bWwuZXNjYXBlKGZ1bGxuYW1lKQoKICAgIG1lc3NhZ2UgPSBmIiIiCuKUjyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBCuKUo+KepCBOZ8aw4budaSBkw7luZzogPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2lkfSc+PGI+e2Zvcm1hdHRlZF9mdWxsbmFtZX08L2I+PC9hPgrilKPinqQgSUQ6IDxjb2RlPnt1c2VyX2lkfTwvY29kZT4K4pSj4p6kIE1HRDoge3RyYW5zYWN0aW9uX2lkfQrilKPinqQgTuG7mWkgZHVuZyDEkeG6t3Q6IDxiPnsnTOG7m24nIGlmIGJldF9jaG9pY2UgPT0gJ2xhcmdlJyBlbHNlICdOaOG7jyd9PC9iPgrilKPinqQgS+G6v3QgcXXhuqMgY+G7p2EgQuG6oE46IHt1c2VyX2RpY2V9CuKUo+KepCBL4bq/dCBxdeG6oyBj4bunYSBCT1Q6IHtib3RfZGljZX0K4pSj4p6kIFPhu5EgZMawOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfQrilKPinqQgVHLhuqFuZyB0aMOhaTogPGI+e3N0YXR1c308L2I+CuKUo+KepCBT4buRIHh1IMSR4bq3dDoge2Zvcm1hdF9iYWxhbmNlKGJldF9hbW91bnQpfQp7YWRkaXRpb25hbF9pbmZvfeKUlyDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBCiIiIgoKICAgIGFkbWluX2JvdCA9IEJvdCh0b2tlbj1CT1QxX1RPS0VOKQoKICAgIGF3YWl0IGFkbWluX2JvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgY2hhdF9pZD1HUk9VUF9JRCwKICAgICAgICB0ZXh0PW1lc3NhZ2UsCiAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZQogICAgKQoKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInh1Y3hhYyIpCmRlZiB4dWN4YWMoY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IGNhbGwuZnJvbV91c2VyLmlkCiAgICAgICAgbWVzc2FnZSA9IGNhbGwubWVzc2FnZQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3JlcGx5X21hcmt1cCgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHhvw6EgaW5saW5lIGtleWJvYXJkOiB7ZX0iKQoKICAgICAgICB0ZW1wX21lc3NhZ2UgPSAiIiIKPGNvZGU+8J+OsjwvY29kZT4gR0FNRSBM4bquQyBYw40gTkfhuqZVIDxjb2RlPvCfjrI8L2NvZGU+Ck7hu5lpIGR1bmcgfCAgU+G7kSDEkWnhu4NtICB8ICBU4bu3IGzhu4cgdHLhuqMgdGjGsOG7n25nCiA8Yj5YWEM8L2I+ICAgIHwgIDIsIDQsIDYgIHwgIHgxLjk1CiA8Yj5YWEw8L2I+ICAgIHwgIDEsIDMsIDUgIHwgIHgxLjk1CiA8Yj5YWFg8L2I+ICAgIHwgIDEsIDIsIDMgIHwgIHgxLjk1CiA8Yj5YWFQ8L2I+ICAgIHwgIDQsIDUsIDYgIHwgIHgxLjk1CiA8Yj5EMTwvYj4gICAgfCAgMSAgfCAgeDQuOAogPGI+RDI8L2I+ICAgIHwgIDIgIHwgIHg0LjgKIDxiPkQzPC9iPiAgICB8ICAzICB8ICB4NC44CiA8Yj5ENDwvYj4gICAgfCAgNCAgfCAgeDQuOAogPGI+RDU8L2I+ICAgIHwgIDUgIHwgIHg0LjgKIDxiPkQ2PC9iPiAgICB8ICA2ICB8ICB4NC44ClPhu5EgeHUgY2jGoWkgdOG7kWkgdGhp4buDdSBsw6AgMS4wMDAgdsOgIHThu5FpIMSRYSBsw6AgMzAwLjAwMApDw6FjaCBjaMahaToKCltO4buZaSBkdW5nXSBbeHUgY8aw4bujY10KLVZEOiBYWEMgMTAwMDAgaG/hurdjIFhYTCAxMDAwMAoiIiIKCiAgICAgICAgcmVwbHlfbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn46yIERhbmggc8OhY2ggR2FtZScpLCBLZXlib2FyZEJ1dHRvbign8J+RpCBUw6BpIEtob+G6o24nKSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn5K1IE7huqFwIHRp4buBbicpLCBLZXlib2FyZEJ1dHRvbign8J+SuCBSw7p0IHRp4buBbicpKQogICAgICAgIHJlcGx5X21hcmt1cC5yb3coS2V5Ym9hcmRCdXR0b24oJ/CfjpYgQlhIIPCfjpYnKSwgS2V5Ym9hcmRCdXR0b24oJ/CfjLogSG9hIEjhu5NuZycpKQoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXRlbXBfbWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cAogICAgICAgICkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeHVjeGFjOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogcmUubWF0Y2gocicoP2kpXih4eHR8eHh4fHh4Y3x4eGx8ZDF8ZDJ8ZDN8ZDR8ZDV8ZDYpXHMrKFxkKykkJywgbWVzc2FnZS50ZXh0KSkKZGVmIHgobWVzc2FnZSk6CiAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgcmV0dXJuCgogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgcmV0dXJuCgogICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICByZXR1cm4KCiAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4KCiAgICBtZXNzYWdlX3RleHQgPSBtZXNzYWdlLnRleHQKICAgIG1hdGNoID0gcmUubWF0Y2gocicoP2kpXih4eHR8eHh4fHh4Y3x4eGx8ZDF8ZDJ8ZDN8ZDR8ZDV8ZDYpXHMrKFxkKykkJywgbWVzc2FnZV90ZXh0KQogICAgaWYgbm90IG1hdGNoOgogICAgICAgIHJldHVybgoKICAgIGJldF90eXBlID0gbWF0Y2guZ3JvdXAoMSkudXBwZXIoKQogICAgdHJ5OgogICAgICAgIGFtb3VudCA9IGludChtYXRjaC5ncm91cCgyKSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHJldHVybgoKICAgIGlmIGFtb3VudCA8IE1JTklNVU1fQkVUOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIlThu5FpIHRoaeG7g3Uge2Zvcm1hdF9iYWxhbmNlKE1JTklNVU1fQkVUKX0iKQogICAgICAgIHJldHVybgoKICAgIGlmIGFtb3VudCA+IE1BWElNVU1fQkVUOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIlThu5FpIMSRYSB7Zm9ybWF0X2JhbGFuY2UoTUFYSU1VTV9CRVQpfSIpCiAgICAgICAgcmV0dXJuCgogICAgdXNlcl9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgIGlmIHVzZXJfYmFsYW5jZSA8IGFtb3VudDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD0iU+G7kSBkxrAga2jDtG5nIMSR4bunIgogICAgICAgICkKICAgICAgICByZXR1cm4KCiAgICBuZXdfYmFsYW5jZSA9IHVzZXJfYmFsYW5jZSAtIGFtb3VudAogICAgd2luX2Ftb3VudCA9IDAKICAgIHN0YXR1cyA9ICJUSFVB4p2MIgoKICAgIGRpY2VfcmVzdWx0ID0gYm90LnNlbmRfZGljZSgKICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICByZXBseV90b19tZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZAogICAgKQogICAgZGljZV92YWx1ZSA9IGRpY2VfcmVzdWx0LmRpY2UudmFsdWUgaWYgZGljZV9yZXN1bHQgYW5kIGRpY2VfcmVzdWx0LmRpY2UgZWxzZSAwCgogICAgaWYgZGljZV92YWx1ZSBpbiBXSU5fUE9JTlRTLmdldChiZXRfdHlwZSwgW10pOgogICAgICAgIHdpbl9hbW91bnQgPSBpbnQoYW1vdW50ICogQkVUX01VTFRJUExJRVJTW2JldF90eXBlXSkKICAgICAgICBuZXdfYmFsYW5jZSArPSB3aW5fYW1vdW50CiAgICAgICAgc3RhdHVzID0gIlRI4bquTkfinIUiCiAgICBlbHNlOgogICAgICAgIGNvbmdfaG9hX2hvbmdfdGh1YSh1c2VyX2lkLCBhbW91bnQpCgogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgbmV3X2JhbGFuY2UpCiAgICB0cnVjdW9jdGllbih1c2VyX2lkLCBhbW91bnQpCiAgICBtZXNzYWdlX2lkID0gcmFuZG9tLnJhbmRpbnQoMTAwMDAwLCA5OTk5OTkpCgogICAgcmVwb3J0ID0gZ2VuZXJhdGVfZ2FtZV9yZXBvcnQoCiAgICAgICAgbWVzc2FnZV9pZD1tZXNzYWdlX2lkLAogICAgICAgIGJldF90eXBlPWJldF90eXBlLAogICAgICAgIGFtb3VudD1hbW91bnQsCiAgICAgICAgd2luX2Ftb3VudD13aW5fYW1vdW50LAogICAgICAgIGRpY2VfdmFsdWU9ZGljZV92YWx1ZSwKICAgICAgICBuZXdfYmFsYW5jZT1uZXdfYmFsYW5jZSwKICAgICAgICBzdGF0dXM9c3RhdHVzCiAgICApCgogICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgIHJlcG9ydCwKICAgICAgICByZXBseV9tYXJrdXA9a2V5Ym9hcmRidXR0b24oKSwKICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICApCgogICAgdXBkYXRlX2dhbWVfaGlzdG9yeSh1c2VyX2lkLCBiZXRfdHlwZSwgYW1vdW50LCB3aW5fYW1vdW50KQogICAgaW1wb3J0IGFzeW5jaW8KICAgIGFzeW5jaW8ucnVuKHNlbmRfYWRtaW5fbm90aWZpY2F0aW9uKG1lc3NhZ2UsIGJldF90eXBlLCBhbW91bnQsIHdpbl9hbW91bnQsIGRpY2VfdmFsdWUsIG5ld19iYWxhbmNlLCBtZXNzYWdlX2lkLCBzdGF0dXMpKQoKZGVmIGdlbmVyYXRlX2dhbWVfcmVwb3J0KG1lc3NhZ2VfaWQsIGJldF90eXBlLCBhbW91bnQsIHdpbl9hbW91bnQsIGRpY2VfdmFsdWUsIG5ld19iYWxhbmNlLCBzdGF0dXMpOgogICAgcmV0dXJuIGYiIiIK4pSPIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEK4pSj4p6kIE1HRDoge21lc3NhZ2VfaWR9CuKUo+KepCBO4buZaSBkdW5nIMSR4bq3dDoge2JldF90eXBlfQrilKPinqQgU+G7kSB4dSDEkeG6t3Q6IHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfQrilKPinqQgU+G7kSB4dSB0aOG6r25nOiB7Zm9ybWF0X2JhbGFuY2Uod2luX2Ftb3VudCl9CuKUo+KepCBL4bq/dCBxdeG6ozoge2RpY2VfdmFsdWV9CuKUo+KepCBT4buRIGTGsDogPGI+e2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX08L2I+CuKUo+KepCBUcuG6oW5nIHRow6FpOiA8Yj57c3RhdHVzfTwvYj4K4pSXIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEg4pSBIOKUgSDilIEKICAgICIiIgoKYXN5bmMgZGVmIHNlbmRfYWRtaW5fbm90aWZpY2F0aW9uKAogICAgbWVzc2FnZSwKICAgIGJldF90eXBlLAogICAgYW1vdW50LAogICAgd2luX2Ftb3VudCwKICAgIGRpY2VfdmFsdWUsCiAgICBuZXdfYmFsYW5jZSwKICAgIG1lc3NhZ2VfaWQsCiAgICBzdGF0dXMKKToKICAgIEJPVDFfVE9LRU4gPSAiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIKICAgIEdST1VQX0lEID0gLTEwMDMyNDEwMDI0NzgKCiAgICB1c2VyX2luZm8gPSBtZXNzYWdlLmZyb21fdXNlcgogICAgZnVsbF9uYW1lID0gdXNlcl9pbmZvLmZpcnN0X25hbWUgb3IgIiIKICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgZnVsbF9uYW1lICs9IGYiIHt1c2VyX2luZm8ubGFzdF9uYW1lfSIKCiAgICBub3RpZmljYXRpb24gPSBmIiIiCuKUj+KUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgeKUgQrilKPinqQgTmfGsOG7nWkgZMO5bmc6IDxhIGhyZWY9J3RnOi8vdXNlcj9pZD17dXNlcl9pbmZvLmlkfSc+PGI+e2Z1bGxfbmFtZX08L2I+PC9hPgrilKPinqQgSUQ6IDxjb2RlPnt1c2VyX2luZm8uaWR9PC9jb2RlPgrilKPinqQgTUdEOiB7bWVzc2FnZV9pZH0K4pSj4p6kIE7hu5lpIGR1bmcgxJHhurd0OiB7YmV0X3R5cGV9CuKUo+KepCBT4buRIHh1IMSR4bq3dDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9CuKUo+KepCBT4buRIHh1IHRo4bqvbmc6IHtmb3JtYXRfYmFsYW5jZSh3aW5fYW1vdW50KX0K4pSj4p6kIEvhur90IHF14bqjOiB7ZGljZV92YWx1ZX0K4pSj4p6kIFPhu5EgZMawOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfQrilKPinqQgVHLhuqFuZyB0aMOhaToge3N0YXR1c30K4pSX4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSB4pSBCiIiIgoKICAgIGJvdCA9IEJvdCh0b2tlbj1CT1QxX1RPS0VOKQoKICAgIHRyeToKICAgICAgICBhd2FpdCBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPUdST1VQX0lELAogICAgICAgICAgICB0ZXh0PW5vdGlmaWNhdGlvbiwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIHbhu4EgbmjDs20uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvOiB7ZX0iKQoKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInNvbG94dWN4YWMiKQpkZWYgc29sb3h1Y3hhYyhjYWxsKToKICAgIHNvbG94dWN4YWMoY2FsbCwgInNvbG94dWN4YWMiKQpkZWYgc29sb3h1Y3hhYyhjYWxsLCBnYW1lX3R5cGUpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBjYWxsLmZyb21fdXNlci5pZAogICAgICAgIG1lc3NhZ2UgPSBjYWxsLm1lc3NhZ2UKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGRlZiBnZXRfc29sb19yb29tc19mcm9tX2pzb24oKToKICAgICAgICAgICAgc29sb19maWxlID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInNvbG8uanNvbiIpCiAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhzb2xvX2ZpbGUpOgogICAgICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3Blbihzb2xvX2ZpbGUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCiAgICAgICAgICAgICAgICBzb2xvX3Jvb21zID0gW10KICAgICAgICAgICAgICAgIGZvciByb29tX2NvZGUsIHJvb20gaW4gZGF0YS5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IHJvb20uZ2V0KCJzdGF0dXMiLCAiMS8yIikKICAgICAgICAgICAgICAgICAgICBpZiBzdGF0dXMgPT0gIjEvMiI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNvbG9fcm9vbXMuYXBwZW5kKGYiPGNvZGU+L3NvbG8ge3Jvb21fY29kZX08L2NvZGU+IHtzdGF0dXN9IikKICAgICAgICAgICAgICAgIHJldHVybiAiXG4iLmpvaW4oc29sb19yb29tcykgaWYgc29sb19yb29tcyBlbHNlICIiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSDEkeG7jWMgc29sby5qc29uOiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuICIiCgogICAgICAgIHNvbG9fcm9vbXNfbGlzdCA9IGdldF9zb2xvX3Jvb21zX2Zyb21fanNvbigpCgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIG1lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPU5vbmUKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB4b8OhIGlubGluZSBrZXlib2FyZDoge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYm90LmRlbGV0ZV9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZTI6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHhvw6EgdGluIG5o4bqvbjoge2UyfSIpCgogICAgICAgIHRlbXBfbWVzc2FnZSA9IGYiIiIKPGI+PGNvZGU+8J+OsjwvY29kZT4gR0FNRSBTT0xPIFjDmkMgWOG6rkMgPGNvZGU+8J+OsjwvY29kZT48L2I+ClThuqFvIHBow7JuZyB2w6AgbeG7nWkgYuG6oW4gYsOoIHRoYW0gZ2lhIMSR4bqldSB4w7pjIHjhuq9jLiBL4bq/dCBxdeG6oyBk4buxYSB2w6BvIHjDumMgeOG6r2MgY+G7p2EgY2jhu6cgcGjDsm5nIHbDoCDEkeG7kWkgdGjhu6cuIE5nxrDhu51pIGPDsyBr4bq/dCBxdeG6oyBjYW8gaMahbiBz4bq9IHRo4bqvbmcuCi0gQ2jGoWkgdOG7kWkgdGhp4buDdSAxLjAwMCB2w6AgdOG7kWkgxJFhIDEuMDAwLjAwMAotIFThu4kgbOG7hyB0cuG6oyB0aMaw4bufbmcgMS45NS4KQ8OhY2ggY2jGoWk6CnNvbG8gW1Phu5EgeHVdIMSR4buDIHThuqFvIHBow7JuZyBjaMahaQovc29sbyBbTcOjIHBow7JuZ10gxJHhu4MgdsOgbyBwaMOybmcgY2jGoWkKL2h1eXNvbG8gW03DoyBwaMOybmddIMSR4buDIGh14bu3IHBow7JuZyAoQ2jhu4kgaHXhu7cga2hpIGNoxrBhIGPDsyBhaSB2w6BvLCBjaOG7iSDEkcaw4bujYyBodeG7tyBzYXUgMiBwaMO6dCB04bqhbyBwaMOybmcpCi9jaGVja3NvbG8gW03DoyBwaMOybmddIMSR4buDIGLDoW8gY8OhbyBu4bq/dSDEkeG7kWkgdGjhu6cga2jDtG5nIHR1bmcgWFggc2F1IDEyMHMgKE5nxrDhu51pIGtow7RuZyB0dW5nIHPhur0gYuG7iyB44butIHRodWEpCgpEYW5oIHPDoWNoIGPDoWMgcGjDsm5nIFNPTE8gaGnhu4duIHThuqFpOgp7c29sb19yb29tc19saXN0fQoiIiIKCiAgICAgICAgcmVwbHlfbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn46yIERhbmggc8OhY2ggR2FtZScpLCBLZXlib2FyZEJ1dHRvbign8J+RpCBUw6BpIEtob+G6o24nKSkKICAgICAgICByZXBseV9tYXJrdXAucm93KEtleWJvYXJkQnV0dG9uKCfwn5K1IE7huqFwIHRp4buBbicpLCBLZXlib2FyZEJ1dHRvbign8J+SuCBSw7p0IHRp4buBbicpKQogICAgICAgIHJlcGx5X21hcmt1cC5yb3coS2V5Ym9hcmRCdXR0b24oJ/CfjpYgQlhIIPCfjpYnKSwgS2V5Ym9hcmRCdXR0b24oJ/CfjLogSG9hIEjhu5NuZycpKQoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXRlbXBfbWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cAogICAgICAgICkKCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBzb2xveHVjeGFjOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0Lmxvd2VyKCkuc3RhcnRzd2l0aCgic29sbyAiKSkKZGVmIHNvbG94eChtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQoKICAgICAgICAjIENo4bq3biBmb3J3YXJkIGhv4bq3YyB0aW4gbmjhuq9uIGPFqQogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBuZ8aw4budaSBkw7luZwogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgVMOhY2ggbOG7h25oIFNPTE8KICAgICAgICBwYXJ0cyA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KCkKICAgICAgICBpZiBsZW4ocGFydHMpICE9IDIgb3Igbm90IHBhcnRzWzFdLmlzZGlnaXQoKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgICAgICBhbW91bnQgPSBpbnQocGFydHNbMV0pCgogICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSDEkWFuZyBjaMahaSBTT0xPIGhv4bq3YyBMTgogICAgICAgIHNvbG9fcGxheWluZywgcm9vbV9jb2RlLCBfLCBzb2xvX2Ftb3VudCA9IGlzX3VzZXJfaW5fc29sb19yb29tKHVzZXJfaWQpCiAgICAgICAgbG5fcGxheWluZywgbG5fYW1vdW50ID0gaXNfdXNlcl9pbl9sbl9iZXQodXNlcl9pZCkKICAgICAgICBpZiBsbl9wbGF5aW5nIG9yIHNvbG9fcGxheWluZzoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgQ2hlY2sgZ2nhu5tpIGjhuqFuIHPhu5EgdGnhu4FuCiAgICAgICAgaWYgYW1vdW50IDwgMTAwMCBvciBhbW91bnQgPiAxMDAwMDAwMDoKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJLaMO0bmcgdGjhu4MgdOG6oW8gcGjDsm5nLCBraeG7g20gdHJhIHPhu5EgZMawIGhv4bq3YyBz4buRIHRp4buBbiB04bqhbyBwaMOybmciKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyBMb2FkIFNPTE9fRklMRSBhbiB0b8OgbgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKFNPTE9fRklMRSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWRzKGNvbnRlbnQpIGlmIGNvbnRlbnQgZWxzZSB7fQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgZGF0YSA9IHt9CiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGF0YSA9IHt9CgogICAgICAgICMgS2nhu4NtIHRyYSB1c2VyIMSRw6MgY8OzIHBow7JuZyBjaMawYQogICAgICAgIGZvciByb29tX2NvZGUsIHJvb20gaW4gZGF0YS5pdGVtcygpOgogICAgICAgICAgICBpZiAocm9vbVsidXNlcl9pZCJdID09IHVzZXJfaWQgb3Igcm9vbS5nZXQoInVzZXJfam9pbiIsICIiKSA9PSB1c2VyX2lkKSBhbmQgcm9vbS5nZXQoInVzZXJfd2luIiwgIiIpID09ICIiOgogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJC4bqhbiDEkcOjIHThuqFvIGhv4bq3YyB0aGFtIGdpYSBwaMOybmcsIHZ1aSBsw7JuZyB0dW5nIFhYIHRyxrDhu5tjIGtoaSB04bqhbyBwaMOybmcgbeG7m2kiKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgTG9hZCBz4buRIGTGsCB04burIFNEX0ZJTEUgYW4gdG/DoG4KICAgICAgICBsaW5lcyA9IFtdCiAgICAgICAgc29kdSA9IDAKICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoU0RfRklMRSk6CiAgICAgICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdWlkLCB2YWwgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1aWQgPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvZHUgPSBpbnQodmFsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZCgodWlkLCB2YWwpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIGLhu48gcXVhIGTDsm5nIGzhu5dpCgogICAgICAgIGlmIG5vdCBmb3VuZCBvciBzb2R1IDwgYW1vdW50OgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIktow7RuZyB0aOG7gyB04bqhbyBwaMOybmcsIGtp4buDbSB0cmEgc+G7kSBkxrAgaG/hurdjIHPhu5EgdGnhu4FuIHThuqFvIHBow7JuZyIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIEPhuq1wIG5o4bqtdCBz4buRIGTGsAogICAgICAgIG5ld19iYWxhbmNlID0gc29kdSAtIGFtb3VudAogICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciB1aWQsIHZhbCBpbiBsaW5lczoKICAgICAgICAgICAgICAgIGlmIHVpZCA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dWlkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGYie3VpZH0ge3ZhbH1cbiIpCgogICAgICAgICMgU2luaCBtw6MgcGjDsm5nCiAgICAgICAgbWFfcGhvbmcgPSAnJy5qb2luKHJhbmRvbS5jaG9pY2VzKCIwMTIzNDU2Nzg5Iiwgaz02KSkKICAgICAgICBtYV9mdWxsID0gZiJ7bWFfcGhvbmd9LXthbW91bnR9IgoKICAgICAgICAjIEzGsHUgcGjDsm5nICYgdHLhu6sgY8aw4bujYwogICAgICAgIGx1dXZhb3NvbG94eCh1c2VyX2lkLCBtYV9mdWxsLCBhbW91bnQpCiAgICAgICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYW1vdW50KQoKICAgICAgICBkZWYgZih4KTogcmV0dXJuICJ7Oix9Ii5mb3JtYXQoeCkucmVwbGFjZSgiLCIsICIuIikKCiAgICAgICAgIyBUaMO0bmcgYsOhbwogICAgICAgIG1zZyA9IGYiIiItIFThuqFvIHBow7JuZyBTT0xPIFjDumMgeOG6r2MgdGjDoG5oIGPDtG5nCi0gTcOjIHBow7JuZzogPGNvZGU+e21hX2Z1bGx9PC9jb2RlPgotIFPhu5EgdGnhu4FuOiB7ZihhbW91bnQpfcSRCi0gU+G7kSBkxrA6IHtmKG5ld19iYWxhbmNlKX3EkQpDb3B5IGzhu4duaCBzYXUgxJHhu4MgZ+G7rWkgY2hvIGLhuqFuIGLDqAo8Y29kZT4vc29sbyB7bWFfZnVsbH08L2NvZGU+IMSR4buDIHbDoG8gcGjDsm5nCjxjb2RlPi9odXlzb2xvIHttYV9mdWxsfTwvY29kZT4gxJHhu4MgaOG7p3kgcGjDsm5nIChDaOG7iSBjw7MgY2jhu6cgcGjDsm5nIMSRxrDhu6NjIGTDuW5nIHNhdSAxMjBzIHThuqFvIHBow7JuZykKPGNvZGU+L2NoZWNrc29sbyB7bWFfZnVsbH08L2NvZGU+IMSR4buDIGLDoW8gY8OhbyBu4bq/dSDEkeG7kWkgdGjhu6cga2jDtG5nIHR1bmcgWFggc2F1IDEyMHMgKE5nxrDhu51pIGtow7RuZyB0dW5nIHPhur0gYuG7iyB44butIHRodWEpIiIiCgogICAgICAgIG1hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICBtYXJrdXAuYWRkKElubGluZUtleWJvYXJkQnV0dG9uKCJHUk9VUCBUSU5IIExJTkgiLCB1cmw9Imh0dHBzOi8vdC5tZS9yb29tdGluaGxpbmgiKSkKCiAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBtc2csIHBhcnNlX21vZGU9IkhUTUwiLCByZXBseV9tYXJrdXA9bWFya3VwKQoKCiAgICAgICAgIyBH4butaSB0aMO0bmcgYsOhbyBzb2xvCiAgICAgICAgdGJzb2xvKHVzZXJfaWQsIG1hX2Z1bGwsIGFtb3VudCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIHRyb25nIGjDoG0gc29sb3h4OiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WyJzb2xvIl0pCmRlZiB0aGFtZ2lhc29sb3h4KG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHBhcnRzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgcm9vbV9jb2RlID0gcGFydHNbMV0KICAgICAgICB1c2VyX2pvaW4gPSBzdHIodXNlcl9pZCkKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoU09MT19GSUxFKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgd2l0aCBvcGVuKFNPTE9fRklMRSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCiAgICAgICAgZm9yIHJvb20gaW4gZGF0YS52YWx1ZXMoKToKICAgICAgICAgICAgaWYgKHJvb20uZ2V0KCJ1c2VyX2lkIikgPT0gdXNlcl9qb2luIG9yIHJvb20uZ2V0KCJ1c2VyX2pvaW4iKSA9PSB1c2VyX2pvaW4pIGFuZCBub3Qgcm9vbS5nZXQoInVzZXJfd2luIik6CiAgICAgICAgICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgIkLhuqFuIMSRw6MgdOG6oW8gaG/hurdjIHRoYW0gZ2lhIHBow7JuZywgdnVpIGzDsm5nIHR1bmcgWFgiCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiByb29tX2NvZGUgbm90IGluIGRhdGE6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHJvb20gPSBkYXRhW3Jvb21fY29kZV0KCiAgICAgICAgaWYgcm9vbS5nZXQoInN0YXR1cyIpID09ICIyLzIiOgogICAgICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJQaMOybmcgbsOgeSDEkWFuZyB0aGkgxJHhuqV1IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhbW91bnQgPSBpbnQocm9vbV9jb2RlLnNwbGl0KCItIilbMV0pCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICByZXR1cm4KICAgICAgICBzb2R1ID0gMAogICAgICAgIGxpbmVzID0gW10KICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoU0RfRklMRSk6CiAgICAgICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHVpZCwgdmFsID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiB1aWQgPT0gdXNlcl9qb2luOgogICAgICAgICAgICAgICAgICAgICAgICBzb2R1ID0gaW50KHZhbCkKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKCh1aWQsIHZhbCkpCiAgICAgICAgaWYgbm90IGZvdW5kIG9yIHNvZHUgPCBhbW91bnQ6CiAgICAgICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIG5ld19iYWxhbmNlID0gc29kdSAtIGFtb3VudAogICAgICAgIHdpdGggb3BlbihTRF9GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciB1aWQsIHZhbCBpbiBsaW5lczoKICAgICAgICAgICAgICAgIGlmIHVpZCA9PSB1c2VyX2pvaW46CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmInt1aWR9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dWlkfSB7dmFsfVxuIikKICAgICAgICByb29tWyJ1c2VyX2pvaW4iXSA9IHVzZXJfam9pbgogICAgICAgIHJvb21bInN0YXR1cyJdID0gIjIvMiIKICAgICAgICB4b2Fzb2xvKHJvb21fY29kZSkKICAgICAgICB0cnVjdW9jdGllbih1c2VyX2lkLCBhbW91bnQpCiAgICAgICAgZGF0YVtyb29tX2NvZGVdID0gcm9vbQogICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGluZGVudD0yLCBlbnN1cmVfYXNjaWk9RmFsc2UpCiAgICAgICAgZGVmIGYoeCk6IHJldHVybiAiezosfSIuZm9ybWF0KHgpLnJlcGxhY2UoIiwiLCAiLiIpCiAgICAgICAga2V5Ym9hcmRfcGxheWVyID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSwgb25lX3RpbWVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICBrZXlib2FyZF9wbGF5ZXIuYWRkKEtleWJvYXJkQnV0dG9uKCLwn46yIikpCiAgICAgICAgbXNnX3BsYXllciA9IGYiIiJC4bqhbiDEkeG6t3QgY8aw4bujYyB7ZihhbW91bnQpfSB2w6BvIHBow7JuZyB0aGkgxJHhuqV1IHtyb29tX2NvZGUuc3BsaXQoJy0nKVswXX0KVGnhu4FuIGPGsOG7o2M6IHtmKGFtb3VudCl9ClRp4bq/biBow6BuaCB0dW5nIFhYIMSR4buDIHRoaSDEkeG6pXUsIDxiPnNhdSAxMjBzIG7hur91IGtow7RuZyB0dW5nLCBi4bqhbiBjw7MgdGjhu4MgZMO5bmcgbOG7h25oCjxjb2RlPi9odXlzb2xvIHtyb29tX2NvZGV9PC9jb2RlPiDEkeG7gyBo4buneSBwaMOybmcKPGNvZGU+L2NoZWNrc29sbyB7cm9vbV9jb2RlfTwvY29kZT4gxJHhu4MgYsOhbyBjw6FvIHbhu5tpIEFkbWluIG7hur91IMSR4buRaSB0aOG7pyBraMO0bmcgdHVuZyBYWDwvYj4KICAgICAgICAiIiIKICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIG1zZ19wbGF5ZXIsIHBhcnNlX21vZGU9IkhUTUwiLCByZXBseV9tYXJrdXA9a2V5Ym9hcmRfcGxheWVyKQoKICAgICAgICBjcmVhdG9yX2lkID0gcm9vbVsidXNlcl9pZCJdCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjaGF0ID0gYm90LmdldF9jaGF0KGludCh1c2VyX2pvaW4pKQogICAgICAgICAgICBmdWxsbmFtZSA9IGNoYXQuZmlyc3RfbmFtZSBvciAiIgogICAgICAgICAgICBpZiBjaGF0Lmxhc3RfbmFtZToKICAgICAgICAgICAgICAgIGZ1bGxuYW1lICs9ICIgIiArIGNoYXQubGFzdF9uYW1lCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBmdWxsbmFtZSA9ICIiCgogICAgICAgIG1hcmtkb3duX3VzZXIgPSBmIklEIHt1c2VyX2pvaW59fHtmdWxsbmFtZX0iCiAgICAgICAgbGlua191c2VyID0gZiJbe21hcmtkb3duX3VzZXJ9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfam9pbn0pIgoKICAgICAgICBtc2dfY3JlYXRvciA9ICgKICAgICAgICAgICAgZiJ7bGlua191c2VyfSDEkcOjIHbDoG8gcGjDsm5nIHRoaSDEkeG6pXUge3Jvb21fY29kZS5zcGxpdCgnLScpWzBdfVxuIgogICAgICAgICAgICBmIlRp4bq/biBow6BuaCB0dW5nIFhYIMSR4buDIHRoaSDEkeG6pXUuXG4iCiAgICAgICAgICAgIGYiKlNhdSAxMjBzIG7hur91IGtow7RuZyB0dW5nIHPhur0gYuG7iyB44butIHRodWEhKiIKICAgICAgICApCgogICAgICAgIGtleWJvYXJkX2NyZWF0b3IgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgIGtleWJvYXJkX2NyZWF0b3IuYWRkKEtleWJvYXJkQnV0dG9uKCLwn46yIikpCgogICAgICAgIHNlbnRfY3JlYXRvciA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGludChjcmVhdG9yX2lkKSwKICAgICAgICAgICAgbXNnX2NyZWF0b3IsCiAgICAgICAgICAgIHBhcnNlX21vZGU9Ik1hcmtkb3duIiwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkX2NyZWF0b3IKICAgICAgICApCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSB0cm9uZyAvc29sbzoge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnaHV5c29sbyddKQpkZWYgaHV5c29sbyhtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQoKICAgICAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgICAgIGlmIGxlbihhcmdzKSAhPSAyOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBTYWkgY8O6IHBow6FwIGzhu4duaCAvaHV5c29sbyIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB1c2VyX2lkID0gc3RyKHVzZXJfaWQpCiAgICAgICAgY2hhdF9pZCA9IG1lc3NhZ2UuY2hhdC5pZAogICAgICAgIG1hX2Z1bGwgPSBhcmdzWzFdCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkfSB5w6p1IGPhuqd1IGh14bu3IHBow7JuZyB7bWFfZnVsbH0iKQoKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoU09MT19GSUxFKToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gU09MT19GSUxFIGtow7RuZyB04buTbiB04bqhaSIpCiAgICAgICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJQaMOybmcgxJHDoyBo4bq/dCBo4bqhbiBob+G6t2Mga2jDtG5nIHThu5NuIHThuqFpIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZChmKQoKICAgICAgICByb29tID0gZGF0YS5nZXQobWFfZnVsbCkKICAgICAgICBpZiBub3Qgcm9vbToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFBow7JuZyB7bWFfZnVsbH0ga2jDtG5nIHThu5NuIHThuqFpIHRyb25nIGThu68gbGnhu4d1IikKICAgICAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIlBow7JuZyDEkcOjIGjhur90IGjhuqFuIGhv4bq3YyBraMO0bmcgdOG7k24gdOG6oWkiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgcm9vbS5nZXQoInVzZXJfaWQiKSAhPSB1c2VyX2lkOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7dXNlcl9pZH0ga2jDtG5nIHBo4bqjaSBjaOG7pyBwaMOybmcge21hX2Z1bGx9IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGNyZWF0ZWRfdGltZSA9IHJvb20uZ2V0KCJ0aW1lIikKICAgICAgICBpZiBub3QgY3JlYXRlZF90aW1lOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGPDsyB0csaw4budbmcgdGltZSB0cm9uZyBwaMOybmcge21hX2Z1bGx9IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGVsYXBzZWQgPSBpbnQodGltZS50aW1lKCkgLSBjcmVhdGVkX3RpbWUpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRo4budaSBnaWFuIMSRw6MgdHLDtGkgcXVhIHThu6sga2hpIHThuqFvIHBow7JuZyB7bWFfZnVsbH06IHtlbGFwc2VkfSBnacOieSIpCgogICAgICAgIGlmIGVsYXBzZWQgPCAxMjA6CiAgICAgICAgICAgIHJlbWFpbmluZyA9IDEyMCAtIGVsYXBzZWQKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIENoxrBhIMSR4bunIDEyMCBnacOieSwgY8OybiBs4bqhaSB7cmVtYWluaW5nfSBnacOieSDEkeG7gyDEkcaw4bujYyBodeG7tyIpCiAgICAgICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsIGYiVnVpIGzDsm5nIMSR4bujaSB0aMOqbSB7cmVtYWluaW5nfSBnacOieSBu4buvYSBt4bubaSDEkcaw4bujYyBo4buneSBwaMOybmciKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYW1vdW50ID0gcm9vbS5nZXQoImFtb3VudCIsIDApCiAgICAgICAgdXBkYXRlZF9saW5lcyA9IFtdCiAgICAgICAgcmVmdW5kZWQgPSBGYWxzZQoKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhTRF9GSUxFKToKICAgICAgICAgICAgd2l0aCBvcGVuKFNEX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgdWlkLCB2YWwgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIHVpZCA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGludCh2YWwpICsgaW50KGFtb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQoZiJ7dWlkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICByZWZ1bmRlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgaG/DoG4gdGnhu4FuIHthbW91bnR9xJEgY2hvIHVzZXIge3VzZXJfaWR9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChmInt1aWR9IHt2YWx9XG4iKQogICAgICAgICAgICB3aXRoIG9wZW4oU0RfRklMRSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKHVwZGF0ZWRfbGluZXMpCgogICAgICAgIGlmIG5vdCByZWZ1bmRlZDoKICAgICAgICAgICAgcHJpbnQoZiJbTOG7lkldIEtow7RuZyB0w6xtIHRo4bqleSB1c2VyIHt1c2VyX2lkfSB0cm9uZyB7U0RfRklMRX0gxJHhu4MgaG/DoG4gdGnhu4FuIikKCiAgICAgICAgZGF0YS5wb3AobWFfZnVsbCkKICAgICAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBpbmRlbnQ9MiwgZW5zdXJlX2FzY2lpPUZhbHNlKQoKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyB4b8OhIGThu68gbGnhu4d1IHBow7JuZyB7bWFfZnVsbH0ga2jhu49pIFNPTE9fRklMRSIpCiAgICAgICAgeG9hc29sbyhtYV9mdWxsKQoKICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiSOG7p3kgcGjDsm5nIHRow6BuaCBjw7RuZyIpCgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHjDoWMgbmjhuq1uIGh14bu3IHBow7JuZyBjaG8gdXNlciB7dXNlcl9pZH0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gdHJvbmcgaHV5c29sbzoge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnY2hlY2tzb2xvJ10pCmRlZiBjaGVja3NvbG8obWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBCT1QxX1RPS0VOID0gIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiCiAgICAgICAgR1JPVVBfSUQgPSAtMTAwMzI0MTAwMjQ3OAogICAgICAgIFNPTE9fRklMRSA9ICJGSUxFL3NvbG8uanNvbiIKICAgICAgICBib3QxID0gdGVsZWJvdC5UZWxlQm90KEJPVDFfVE9LRU4pCgogICAgICAgIGFyZ3MgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgaWYgbGVuKGFyZ3MpICE9IDI6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIFNhaSBjw7ogcGjDoXAgL2NoZWNrc29sbyIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtYV9waG9uZyA9IGFyZ3NbMV0KICAgICAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkKQogICAgICAgIGZ1bGxuYW1lID0gZiJ7bWVzc2FnZS5mcm9tX3VzZXIuZmlyc3RfbmFtZSBvciAnJ30ge21lc3NhZ2UuZnJvbV91c2VyLmxhc3RfbmFtZSBvciAnJ30iLnN0cmlwKCkKICAgICAgICBjaGF0X2lkID0gbWVzc2FnZS5jaGF0LmlkCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZF9zdHJ9ICh7ZnVsbG5hbWV9KSBn4butaSB5w6p1IGPhuqd1IC9jaGVja3NvbG8gduG7m2kgbcOjIHBow7JuZzoge21hX3Bob25nfSIpCgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhTT0xPX0ZJTEUpOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBGaWxlIFNPTE8ga2jDtG5nIHThu5NuIHThuqFpIikKICAgICAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIlBow7JuZyDEkcOjIGjhur90IGjhuqFuIGhv4bq3YyBraMO0bmcgdOG7k24gdOG6oWkiKQoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHdpdGggb3BlbihTT0xPX0ZJTEUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZChmKQoKICAgICAgICByb29tID0gZGF0YS5nZXQobWFfcGhvbmcpCiAgICAgICAgaWYgbm90IHJvb206CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgcGjDsm5nIHttYV9waG9uZ30iKQogICAgICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiUGjDsm5nIMSRw6MgaOG6v3QgaOG6oW4gaG/hurdjIGtow7RuZyB04buTbiB04bqhaSIpCgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgcm9vbS5nZXQoInVzZXJfaWQiKSA9PSB1c2VyX2lkX3N0cjoKICAgICAgICAgICAgb3Bwb25lbnRfaWQgPSByb29tLmdldCgidXNlcl9qb2luIiwgIiIpCiAgICAgICAgICAgIHJvbGUgPSAiY2jhu6cgcGjDsm5nIgogICAgICAgIGVsaWYgcm9vbS5nZXQoInVzZXJfam9pbiIpID09IHVzZXJfaWRfc3RyOgogICAgICAgICAgICBvcHBvbmVudF9pZCA9IHJvb20uZ2V0KCJ1c2VyX2lkIiwgIiIpCiAgICAgICAgICAgIHJvbGUgPSAibmfGsOG7nWkgdGhhbSBnaWEiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gTmfGsOG7nWkgZMO5bmcga2jDtG5nIHRodeG7mWMgcGjDsm5nIG7DoHkiKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIGzDoCB7cm9sZX0sIMSR4buRaSB0aOG7pzoge29wcG9uZW50X2lkfSIpCgogICAgICAgIGlmIG5vdCBvcHBvbmVudF9pZDoKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gUGjDsm5nIGNoxrBhIGPDsyDEkeG7kWkgdGjhu6cgxJHhu4MgYsOhbyBjw6FvIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHJvbGxzID0gcm9vbS5nZXQoInVzZXJfeHgiLCB7fSkKICAgICAgICBpZiB1c2VyX2lkX3N0ciBub3QgaW4gcm9sbHM6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHt1c2VyX2lkX3N0cn0gY2jGsGEgdHVuZyBYWCwga2jDtG5nIHRo4buDIGLDoW8gY8OhbyIpCiAgICAgICAgICAgIHNlbnQgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJC4bqhbiDEkcOjIHThuqFvIGhv4bq3YyB0aGFtIGdpYSBwaMOybmcgdnVpIGzDsm5nIHR1bmcgWFgiKQoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGNyZWF0ZWRfdGltZSA9IHJvb20uZ2V0KCJ0aW1lIikKICAgICAgICBpZiBub3QgY3JlYXRlZF90aW1lOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGPDsyB0csaw4budbmcgdGltZSB0cm9uZyBwaMOybmcge21hX3Bob25nfSIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBlbGFwc2VkID0gaW50KHRpbWUudGltZSgpIC0gY3JlYXRlZF90aW1lKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaOG7nWkgZ2lhbiB0csO0aSBxdWE6IHtlbGFwc2VkfXMgKHnDqnUgY+G6p3UgMTIwcykiKQogICAgICAgIGlmIGVsYXBzZWQgPCAxMjA6CiAgICAgICAgICAgIHJlbWFpbmluZyA9IDEyMCAtIGVsYXBzZWQKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIENoxrBhIMSR4bunIDEyMHMsIGPDsm4gbOG6oWkge3JlbWFpbmluZ31zIikKICAgICAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgZiJWdWkgbMOybmcgxJHhu6NpIHRow6ptIHtyZW1haW5pbmd9IGdpw6J5IG7hu69hIG3hu5tpIGPDsyB0aOG7gyBiw6FvIGPDoW8iKQoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHJlcG9ydCA9ICgKICAgICAgICAgICAgZiLwn5OiIDxiPkLDgU8gQ8OBTyBTT0xPPC9iPlxuIgogICAgICAgICAgICBmIvCfkaQgTmfGsOG7nWkgZMO5bmcgKHtyb2xlfSk6IDxiPntmdWxsbmFtZX08L2I+XG4iCiAgICAgICAgICAgIGYi8J+GlCBJRCBuZ8aw4budaSBiw6FvIGPDoW86IDxjb2RlPnt1c2VyX2lkX3N0cn08L2NvZGU+XG5cbiIKICAgICAgICAgICAgZiLwn46vIMSQ4buRaSB0aOG7pyAoY2jGsGEgdHVuZyBYWCk6IDxjb2RlPntvcHBvbmVudF9pZH08L2NvZGU+XG4iCiAgICAgICAgICAgIGYi8J+UkCBNw6MgcGjDsm5nOiA8Y29kZT57bWFfcGhvbmd9PC9jb2RlPlxuXG4iCiAgICAgICAgICAgIGYi4puUIEzhu4duaCB44butIHRodWE6XG4iCiAgICAgICAgICAgIGYiPGNvZGU+L3RodWEge29wcG9uZW50X2lkfSB7bWFfcGhvbmd9PC9jb2RlPlxuXG4iCiAgICAgICAgICAgIGYi8J+RriBBRE1JTiB44butIGzDvTogQGthaWFhYTE4IgogICAgICAgICkKCiAgICAgICAgc2VudCA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIsSQw6MgZ+G7rWkgYsOhbyBjw6FvIMSR4bq/biBBZG1pbiwgYuG6oW4gdnVpIGzDsm5nIMSR4bujaSIpCgoKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShHUk9VUF9JRCwgcmVwb3J0LCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSBiw6FvIGPDoW8gdOG7qyB1c2VyIHt1c2VyX2lkX3N0cn0gcGjDsm5nIHttYV9waG9uZ30gxJHhur9uIGdyb3VwIGFkbWluIHtHUk9VUF9JRH0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gdHJvbmcgY2hlY2tzb2xvOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9Wyd0aHVhJ10pCmRlZiB0aHVhKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIEFETUlOX0lEID0gIjgyMDU1Njc4NTEiCiAgICAgICAgdXNlcl9pZCA9IHN0cihtZXNzYWdlLmZyb21fdXNlci5pZCkKICAgICAgICBpZiB1c2VyX2lkICE9IEFETUlOX0lEOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgICAgIGlmIGxlbihhcmdzKSAhPSAzOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBTYWkgY8O6IHBow6FwIGzhu4duaCAvdGh1YS4gxJDhu4tuaCBk4bqhbmcgxJHDum5nOiAvdGh1YSBbdXNlcl9pZF90aHVhXSBbbWFfcGhvbmddIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbG9zZXJfaWQgPSBhcmdzWzFdCiAgICAgICAgbWFfcGhvbmcgPSBhcmdzWzJdCiAgICAgICAgdXNlcl9pZCA9IHN0cihtZXNzYWdlLmZyb21fdXNlci5pZCkKICAgICAgICBwcmludChmIltERUJVR10gQWRtaW4ge3VzZXJfaWR9IHnDqnUgY+G6p3UgeOG7rSB0aHVhIHVzZXIge2xvc2VyX2lkfSB0cm9uZyBwaMOybmcge21hX3Bob25nfSIpCiAgICAgICAgU09MT19GSUxFID0gIkZJTEUvc29sby5qc29uIgogICAgICAgIFNEX0ZJTEUgPSAiRklMRS9zZC50eHQiCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKFNPTE9fRklMRSk6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEZpbGUgc29sby5qc29uIGtow7RuZyB04buTbiB04bqhaS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICB3aXRoIG9wZW4oU09MT19GSUxFLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgICAgICByb29tID0gZGF0YS5nZXQobWFfcGhvbmcpCiAgICAgICAgaWYgbm90IHJvb206CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgcGjDsm5nIHttYV9waG9uZ30gdHJvbmcgZOG7ryBsaeG7h3UuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgcm9vbS5nZXQoInVzZXJfaWQiKSA9PSBsb3Nlcl9pZDoKICAgICAgICAgICAgd2lubmVyX2lkID0gcm9vbS5nZXQoInVzZXJfam9pbiIsICIiKQogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgdGh1YSBsw6AgY2jhu6cgcGjDsm5nLiBOZ8aw4budaSB0aOG6r25nOiB7d2lubmVyX2lkfSIpCiAgICAgICAgZWxpZiByb29tLmdldCgidXNlcl9qb2luIikgPT0gbG9zZXJfaWQ6CiAgICAgICAgICAgIHdpbm5lcl9pZCA9IHJvb20uZ2V0KCJ1c2VyX2lkIiwgIiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSB0aHVhIGzDoCBuZ8aw4budaSB0aGFtIGdpYS4gTmfGsOG7nWkgdGjhuq9uZzoge3dpbm5lcl9pZH0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSB7bG9zZXJfaWR9IGtow7RuZyB0aHXhu5ljIHBow7JuZyB7bWFfcGhvbmd9IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IHdpbm5lcl9pZDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB4w6FjIMSR4buLbmggxJHGsOG7o2MgbmfGsOG7nWkgdGjhuq9uZyB2w6wgxJHhu5FpIHRo4bunIGNoxrBhIHbDoG8gcGjDsm5nLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIHdpbm5lcl9pZCBub3QgaW4gcm9vbS5nZXQoInVzZXJfeHgiLCB7fSk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSB0aOG6r25nIHt3aW5uZXJfaWR9IGNoxrBhIHR1bmcgeMO6YyB44bqvYy4gS2jDtG5nIHRo4buDIHjhu60gdGh1YS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICByb29tWyJ1c2VyX3dpbiJdID0gd2lubmVyX2lkCiAgICAgICAgaWYgInVzZXJfeHgiIG5vdCBpbiByb29tOgogICAgICAgICAgICByb29tWyJ1c2VyX3h4Il0gPSB7fQogICAgICAgIHJvb21bInVzZXJfeHgiXVtsb3Nlcl9pZF0gPSAwCiAgICAgICAgZGF0YVttYV9waG9uZ10gPSByb29tCiAgICAgICAgd2l0aCBvcGVuKFNPTE9fRklMRSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAoZGF0YSwgZiwgaW5kZW50PTIsIGVuc3VyZV9hc2NpaT1GYWxzZSkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBj4bqtcCBuaOG6rXQgdXNlcl93aW4gPSB7d2lubmVyX2lkfSB2w6Agc2V0IMSRaeG7g20ge2xvc2VyX2lkfSA9IDAgdHJvbmcgcGjDsm5nIHttYV9waG9uZ30iKQogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCBmIsSQw6MgeOG7rSB0aHVhIGNobyA8Y29kZT57bG9zZXJfaWR9PC9jb2RlPiB0cm9uZyBwaMOybmcgPGNvZGU+e21hX3Bob25nfTwvY29kZT4iLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICB4dXRodWF4eChib3QsIFNPTE9fRklMRSwgU0RfRklMRSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gdHJvbmcgL3RodWE6IHtlfSIpCgpkZWYgaXNfcm9vbV9vcGVuKCk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3Jvb20udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBzdGF0dXMgPSBmLnJlYWQoKS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgcmV0dXJuIHN0YXR1cyA9PSAidHJ1ZSIKICAgIGV4Y2VwdDoKICAgICAgICByZXR1cm4gRmFsc2UKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dC5sb3dlcigpLnN0YXJ0c3dpdGgoKCd0dCcsICd4eCcsICdjYycsICdsbCcpKSkKZGVmIGN1b2Nyb29tKG1lc3NhZ2UpOgogICAgZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICB0cnk6CiAgICAgICAgZ2xvYmFsIGFjY2VwdGluZ19iZXRzCiAgICAgICAgdXNlcl9pZCA9IHN0cihtZXNzYWdlLmZyb21fdXNlci5pZCkKICAgICAgICBjaGF0X2lkID0gbWVzc2FnZS5jaGF0LmlkCiAgICAgICAgbWVzc2FnZV90ZXh0ID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkubG93ZXIoKS5zcGxpdCgpCgogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgaXNfcm9vbV9vcGVuKCk6CiAgICAgICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAiS2jDtG5nIMSRxrDhu6NjIHBow6lwIGPGsOG7o2MgdsOgbyBsw7pjIG7DoHkiLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBsZW4obWVzc2FnZV90ZXh0KSAhPSAyOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvcGhpZW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgc2Vzc2lvbiA9IGYucmVhZCgpLnN0cmlwKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBjdW9jID0gbWVzc2FnZV90ZXh0WzBdCiAgICAgICAgYmV0X2lucHV0ID0gbWVzc2FnZV90ZXh0WzFdCgogICAgICAgIGN1b2NfbWFwID0gewogICAgICAgICAgICAndHQnOiAoJ1TDoGknLCAndGFpLnR4dCcsICd4aXUudHh0JyksCiAgICAgICAgICAgICd4eCc6ICgnWOG7iXUnLCAneGl1LnR4dCcsICd0YWkudHh0JyksCiAgICAgICAgICAgICdjYyc6ICgnQ2jhurVuJywgJ2NoYW4udHh0JywgJ2xlLnR4dCcpLAogICAgICAgICAgICAnbGwnOiAoJ0zhursnLCAnbGUudHh0JywgJ2NoYW4udHh0JykKICAgICAgICB9CgogICAgICAgIGN1b2Nfa2V5ID0gY3VvYy5yZXBsYWNlKCIgbWF4IiwgIiIpCiAgICAgICAgaWYgY3VvY19rZXkgbm90IGluIGN1b2NfbWFwOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYmV0X3R5cGUsIGZpbGVfY3VvYywgZmlsZV9kb2kgPSBjdW9jX21hcFtjdW9jX2tleV0KICAgICAgICBmaWxlX2N1b2MgPSAiRklMRS8iICsgZmlsZV9jdW9jCiAgICAgICAgZmlsZV9kb2kgPSAiRklMRS8iICsgZmlsZV9kb2kKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9kb2ksICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMyBhbmQgcGFydHNbMF0ucmVwbGFjZSgnIycsICcnKSA9PSBzZXNzaW9uIGFuZCBwYXJ0c1sxXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgZiJLaMO0bmcgxJHGsOG7o2MgcGjDqXAgxJHhurd0IDIgY+G7rWEiLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgc2RfcGF0aCA9ICJGSUxFL3NkLnR4dCIKICAgICAgICBiYWxhbmNlID0gMAogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKHNkX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCh1c2VyX2lkICsgIiAiKToKICAgICAgICAgICAgICAgICAgICBiYWxhbmNlID0gaW50KGxpbmUuc3RyaXAoKS5zcGxpdCgpWzFdKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZGVmIHRvdGFsX2JldChwYXRoKToKICAgICAgICAgICAgdG90YWwgPSAwCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDMgYW5kIHBhcnRzWzBdLnJlcGxhY2UoJyMnLCAnJykgPT0gc2Vzc2lvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbCArPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gdG90YWwKCiAgICAgICAgdG90YWxfY3VycmVudCA9IHRvdGFsX2JldChmaWxlX2N1b2MpCiAgICAgICAgdG90YWxfb3RoZXIgPSB0b3RhbF9iZXQoZmlsZV9kb2kpCiAgICAgICAgbWF4X2FsbG93ZWQgPSB0b3RhbF9vdGhlciArIDUwMDAwMCAtIHRvdGFsX2N1cnJlbnQKCiAgICAgICAgaWYgbWF4X2FsbG93ZWQgPD0gMDoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgYmV0X2lucHV0ID09ICdtYXgnOgogICAgICAgICAgICBiZXRfYW1vdW50ID0gbWluKGJhbGFuY2UsIG1heF9hbGxvd2VkKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJldF9hbW91bnQgPSBpbnQoYmV0X2lucHV0KQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIGJldF9hbW91bnQgPCAxMDAwMDA6CiAgICAgICAgICAgICAgICBib3QucmVwbHlfdG8obWVzc2FnZSwgIlThu5FpIHRoaeG7g3UgMTAwLjAwMCIsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgICAgIGlmIGJldF9hbW91bnQgPiBiYWxhbmNlOgogICAgICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJT4buRIGTGsCBraMO0bmcgxJHhu6ciLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICBpZiBiZXRfYW1vdW50ID4gbWF4X2FsbG93ZWQ6CiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgaWYgYmV0X2Ftb3VudCA8IDEwMDAwMDoKICAgICAgICAgICAgYm90LnJlcGx5X3RvKG1lc3NhZ2UsICJU4buRaSB0aGnhu4N1IDEwMC4wMDAiLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgbm90ZSA9ICIoQ8OibiBj4butYSkiIGlmIGJldF9hbW91bnQgPT0gbWF4X2FsbG93ZWQgZWxzZSAiIgogICAgICAgIG5ld19iYWxhbmNlID0gYmFsYW5jZSAtIGJldF9hbW91bnQKCiAgICAgICAgdHJ1Y3VvY3RpZW4odXNlcl9pZCwgYmV0X2Ftb3VudCkKCiAgICAgICAgZm9yIGkgaW4gcmFuZ2UobGVuKGxpbmVzKSk6CiAgICAgICAgICAgIGlmIGxpbmVzW2ldLnN0YXJ0c3dpdGgodXNlcl9pZCArICIgIik6CiAgICAgICAgICAgICAgICBsaW5lc1tpXSA9IGYie3VzZXJfaWR9IHtuZXdfYmFsYW5jZX1cbiIKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgd2l0aCBvcGVuKHNkX3BhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQogICAgICAgIHdpdGggb3BlbihmaWxlX2N1b2MsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmIiN7c2Vzc2lvbn0ge3VzZXJfaWR9IHtiZXRfYW1vdW50fVxuIikKICAgICAgICBib3QyLnNlbmRfbWVzc2FnZShncm91cF9jaGF0X2lkLAogICAgICAgICAgICBmIjxiPvCfjq4gxJDhurd0IHRow6BuaCBjw7RuZyB04bqhaSBib3Qga+G7syBYWCAje3Nlc3Npb259XG57YmV0X3R5cGV9IHtmb3JtYXRfbnVtYmVyKGJldF9hbW91bnQpfcSRPC9iPlxue25vdGV9IiwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICByYW5kb21fY29kZSA9IHN0cihyYW5kb20ucmFuZGludCgxMDAwMDAwLCA5OTk5OTk5KSkKICAgICAgICBzZW50ID0gYm90LnJlcGx5X3RvKAogICAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgICBmIsSQ4bq3dCB0aMOgbmggY8O0bmcga+G7syBYWCAje3Nlc3Npb259XG4iCiAgICAgICAgICAgIGYiTUdEOiB7cmFuZG9tX2NvZGV9XG4iCiAgICAgICAgICAgIGYie2JldF90eXBlfSB7Zm9ybWF0X251bWJlcihiZXRfYW1vdW50KX3EkVxuIgogICAgICAgICAgICBmIlPhu5EgZMawOiB7Zm9ybWF0X251bWJlcihuZXdfYmFsYW5jZSl9xJEiKQoKICAgICAgICBmdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZSBvciAi44WkIgogICAgICAgIG5vdGlmeV9ncm91cCgKICAgICAgICAgICAgZnVsbG5hbWU9ZnVsbG5hbWUsCiAgICAgICAgICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgICAgICAgICAgYmV0X3R5cGU9YmV0X3R5cGUsCiAgICAgICAgICAgIGJldF9hbW91bnQ9ZiJ7Zm9ybWF0X251bWJlcihiZXRfYW1vdW50KX0g4oKrIiwKICAgICAgICAgICAgdHJhbnNhY3Rpb25fY29kZT1yYW5kb21fY29kZSwKICAgICAgICAgICAgbmV3X2JhbGFuY2U9Zm9ybWF0X251bWJlcihuZXdfYmFsYW5jZSkpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIHt1c2VyX2lkfSBjxrDhu6NjIHtiZXRfdHlwZX0ge2JldF9hbW91bnR9xJEgfCBDw7JuOiB7bmV3X2JhbGFuY2V9xJEiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB7ZX0iKQoKZGVmIG5vdGlmeV9ncm91cChmdWxsbmFtZSwgdXNlcl9pZCwgYmV0X3R5cGUsIGJldF9hbW91bnQsIHRyYW5zYWN0aW9uX2NvZGUsIG5ld19iYWxhbmNlKToKICAgIGJvdDFfdG9rZW4gPSAiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIKICAgIGJvdDEgPSBUZWxlQm90KGJvdDFfdG9rZW4pCiAgICBBRE1JTiA9IC0xMDAzMjQxMDAyNDc4CiAgICBzZXNzaW9uX251bWJlciA9IHJlYWRfc2Vzc2lvbl9udW1iZXIoKQogICAgbWVzc2FnZV90ZXh0ID0gKGYiKk5nxrDhu51pIGTDuW5nOiogIFt7ZnVsbG5hbWV9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9KVxuIgogICAgICAgICAgICAgICAgICAgIGYiKklEOiogW3t1c2VyX2lkfV0odGc6Ly91c2VyP2lkPXt1c2VyX2lkfSlcbiIKICAgICAgICAgICAgICAgICAgICBmIipQaGnDqm46KiAje3Nlc3Npb25fbnVtYmVyfVxuIgogICAgICAgICAgICAgICAgICAgIGYiKkPGsOG7o2M6KiB7YmV0X3R5cGV9XG4iCiAgICAgICAgICAgICAgICAgICAgZiIqU+G7kSB0aeG7gW46KiB7YmV0X2Ftb3VudH1cbiIKICAgICAgICAgICAgICAgICAgICBmIipNR0Q6KiB7dHJhbnNhY3Rpb25fY29kZX1cbiIKICAgICAgICAgICAgICAgICAgICBmIlPhu5EgZMawOiB7bmV3X2JhbGFuY2V9IOKCqyIpCiAgICB0cnk6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoQURNSU4sIG1lc3NhZ2VfdGV4dCwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuTUFSS0RPV04pCiAgICAgICAgcHJpbnQoIltERUJVR10gVGluIG5o4bqvbiDEkcOjIGfhu61pIHRow6BuaCBjw7RuZyDEkeG6v24gbmjDs20uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRpbiBuaOG6r24gxJHhur9uIG5ow7NtOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0ID09ICLwn5GkIFTDoGkgS2hv4bqjbiIpCmRlZiB0ayhtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgecOqdSBj4bqndSB4ZW0gdMOgaSBraG/huqNuLiIpCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIFRpbiBuaOG6r24gxJHDoyDEkcaw4bujYyBjaHV54buDbiB0aeG6v3AsIGLhu48gcXVhLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIMSRxrDhu6NjIGfhu61pIHRyxrDhu5tjIGtoaSBib3QgYuG6r3QgxJHhuqd1LCBi4buPIHF1YS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBuZ2hpIG5n4budIGfhu61pIHNwYW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIHRo4buDIGfhu61pIHRpbiBuaOG6r24uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIiIicGhvbmUgPSBnZXRfcGhvbmVfbnVtYmVyKHVzZXJfaWQpCiAgICAgICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICAgICAgbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSwgb25lX3RpbWVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICAgICAgbWFya3VwLmFkZChLZXlib2FyZEJ1dHRvbigi8J+TsSBTaGFyZSBOdW1iZXIiLCByZXF1ZXN0X2NvbnRhY3Q9VHJ1ZSkpCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAiVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIMSR4buDIHRp4bq/cCB04bulYzoiLCByZXBseV9tYXJrdXA9bWFya3VwKQogICAgICAgICAgICByZXR1cm4iIiIKICAgICAgICB1c2VybmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLnVzZXJuYW1lIG9yICJOb1VzZXJuYW1lIgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUw6puIG5nxrDhu51pIGTDuW5nOiB7dXNlcm5hbWV9IikKICAgICAgICB2aV9jaGluaCA9IGdldF92aWNoaW5oKHVzZXJfaWQpCiAgICAgICAgdG90YWxfYmV0X3RvZGF5ID0gZ2V0X2JldF90b2RheSh1c2VyX2lkKQogICAgICAgIHRvdGFsX2JldF93ZWVrID0gZ2V0X2JldF93ZWVrKHVzZXJfaWQpCiAgICAgICAgdG90YWxfd2lucyA9IGdldF93aW4odXNlcl9pZCkKICAgICAgICB0b3RhbF9sb3NzZXMgPSBnZXRfbG9zcyh1c2VyX2lkKQogICAgICAgIG1hbmFwX2NvZGUgPSBnZXRfbWFuYXAodXNlcl9pZCkKICAgICAgICBwcmludChmIltERUJVR10gVGjDtG5nIHRpbiB0w6BpIGtob+G6o246IFbDrSBjaMOtbmggLSB7dmlfY2hpbmh9LCBU4buVbmcgY8aw4bujYyBow7RtIG5heSAtIHt0b3RhbF9iZXRfdG9kYXl9LCBU4buVbmcgY8aw4bujYyB0deG6p24gbsOgeSAtIHt0b3RhbF9iZXRfd2Vla30iKQogICAgICAgIHZpcF9sZXZlbCwgdmlwX3BvaW50cyA9IGdldF92aXAodXNlcl9pZCkKICAgICAgICBwcmludChmIltERUJVR10gQ+G6pXAgVklQOiB7dmlwX2xldmVsfSwgxJBp4buDbSBWSVA6IHt2aXBfcG9pbnRzfSIpCiAgICAgICAgcmVxdWlyZWRfcG9pbnRzID0gdmlwX2xldmVsICogMTAwICsgOTkKICAgICAgICB3aGlsZSB2aXBfcG9pbnRzID49IHJlcXVpcmVkX3BvaW50czoKICAgICAgICAgICAgdmlwX2xldmVsICs9IDEKICAgICAgICAgICAgdmlwX3BvaW50cyA9IDAKICAgICAgICAgICAgcmVxdWlyZWRfcG9pbnRzID0gdmlwX2xldmVsICogMTAwICsgOTkKICAgICAgICAgICAgdXBkYXRlX3ZpcCh1c2VyX2lkLCB2aXBfbGV2ZWwsIHZpcF9wb2ludHMpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBD4bqtcCBuaOG6rXQgY+G6pXAgVklQOiB7dmlwX2xldmVsfSwgxJBp4buDbSBWSVAgY8OybiBs4bqhaToge3ZpcF9wb2ludHN9IikKICAgICAgICBjaHVvaV93aW4sIGNodW9pX2xvc3MgPSBnZXRfd2luX2xvc3Nfc3RyZWFrKHVzZXJfaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIENodeG7l2kgdGjhuq9uZzoge2NodW9pX3dpbn0sIENodeG7l2kgdGh1YToge2NodW9pX2xvc3N9IikKICAgICAgICBpc191bmxvY2tlZCA9IGNoZWNrX3VzZXJfdW5sb2NrKHVzZXJfaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIG3hu58ga2jDs2E6IHtpc191bmxvY2tlZH0iKQogICAgICAgIHVzZXJfdW5sb2NrZWQgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3R0LnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgdHRfZmlsZToKICAgICAgICAgICAgICAgIGxpbmVzID0gdHRfZmlsZS5yZWFkbGluZXMoKQogICAgICAgICAgICAgICAgaWYgYW55KGxpbmUuc3RyaXAoKSA9PSBzdHIodXNlcl9pZCkgZm9yIGxpbmUgaW4gbGluZXMpOgogICAgICAgICAgICAgICAgICAgIHVzZXJfdW5sb2NrZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBjw7MgdHJvbmcgZGFuaCBzw6FjaCBt4bufIGtow7NhIHTDom4gdGjhu6cuIikKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlIEZJTEUvdHQudHh0LiIpCiAgICAgICAgbW9tb19waG9uZSA9ICIwIgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL21vbW8udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBtb21vX2ZpbGU6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBtb21vX2ZpbGU6CiAgICAgICAgICAgICAgICAgICAgdXNlcl9kYXRhID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBsZW4odXNlcl9kYXRhKSA+PSAyIGFuZCB1c2VyX2RhdGFbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgICAgICBtb21vX3Bob25lID0gIioqKioqKiIgKyB1c2VyX2RhdGFbMV1bLTQ6XQogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gU+G7kSDEkWnhu4duIHRob+G6oWkgbW9tbyBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHttb21vX3Bob25lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgZmlsZSBGSUxFL21vbW8udHh0LiIpCiAgICAgICAgdmlldG5hbV90eiA9IHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKQogICAgICAgIGRhdGVfdGltZSA9IGRhdGV0aW1lLm5vdyh2aWV0bmFtX3R6KS5zdHJmdGltZSgiJWQvJW0vJVkiKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8OgeSBnaeG7nSBoaeG7h24gdOG6oWk6IHtkYXRlX3RpbWV9IikKICAgICAgICBtZXNzYWdlX3RleHQgPSAoCiAgICAgICAgICAgIGYi8J+RpCBJRDogPGNvZGU+e3VzZXJfaWR9PC9jb2RlPlxuIgogICAgICAgICAgICBmIvCfkrAgU+G7kSBkxrAgdsOtIGNow61uaDogPGI+e2Zvcm1hdF9iYWxhbmNlKHZpX2NoaW5oKX08L2I+XG4iCiAgICAgICAgICAgIGYi8J+RkSBWaXA6IDxiPnt2aXBfbGV2ZWx9ICh7dmlwX3BvaW50c30ve3JlcXVpcmVkX3BvaW50c30pPC9iPlxuIgogICAgICAgICAgICBmIi0gQ8aw4bujYyBow7RtIG5heTogPGI+e2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2JldF90b2RheSl9PC9iPlxuIgogICAgICAgICAgICBmIi0gQ8aw4bujYyB0deG6p24gbsOgeTogPGI+e2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2JldF93ZWVrKX08L2I+XG4iCiAgICAgICAgICAgIGYiLSBU4buVbmcgdGjhuq9uZzogPGI+e2Zvcm1hdF9iYWxhbmNlKHRvdGFsX3dpbnMpfTwvYj5cbiIKICAgICAgICAgICAgZiItIFThu5VuZyB0aHVhOiA8Yj57Zm9ybWF0X2JhbGFuY2UodG90YWxfbG9zc2VzKX08L2I+XG4iCiAgICAgICAgICAgIGYiLSBNw6MgbuG6oXAgdGnhu4FuOiA8Y29kZT57bWFuYXBfY29kZX08L2NvZGU+XG4iCiAgICAgICAgICAgIGYiPT09PT09PT09PT09PT09PT09PT09XG4iCiAgICAgICAgICAgIGYie2RhdGVfdGltZX06XG4iCiAgICAgICAgICAgIGYiQ2h14buXaSB0aOG6r25nOiA8Yj57Y2h1b2lfd2lufTwvYj5cbiIKICAgICAgICAgICAgZiJDaHXhu5dpIHRodWE6IDxiPntjaHVvaV9sb3NzfTwvYj4iKQogICAgICAgIGtleWJvYXJkID0gWwogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+SsCBO4bqhcCB0aeG7gW4iLCBjYWxsYmFja19kYXRhPSJudCIpLAogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIvCfkrAgUsO6dCB0aeG7gW4iLCBjYWxsYmFja19kYXRhPSJydCIpCiAgICAgICAgICAgIF0sCiAgICAgICAgICAgIFsKICAgICAgICAgICAgICAgIElubGluZUtleWJvYXJkQnV0dG9uKCLwn5K4IENodXnhu4NuIFRp4buBbiIsIGNhbGxiYWNrX2RhdGE9ImN0IiksCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+OgSBNdWEgR2lmdCIsIGNhbGxiYWNrX2RhdGE9Im1nIikKICAgICAgICAgICAgXSwKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIuKGl++4jyBMUyBO4bqhcCIsIGNhbGxiYWNrX2RhdGE9ImxzbiIpLAogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIuKGmO+4jyBMUyBSw7p0IiwgY2FsbGJhY2tfZGF0YT0ibHNyIikKICAgICAgICAgICAgXQogICAgICAgIF0KICAgICAgICBpZiBub3QgdXNlcl91bmxvY2tlZDoKICAgICAgICAgICAga2V5Ym9hcmQuYXBwZW5kKFtJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+UkCBN4bufIGtow7NhIHTDom4gdGjhu6ciLCBjYWxsYmFja19kYXRhPSJtb2tob2F0YW50aHUiKV0pCiAgICAgICAgcHJpbnQoIltERUJVR10gR+G7rWkgdGluIG5o4bqvbiB0w6BpIGtob+G6o24gduG7m2kgY8OhYyBuw7p0IMSRaeG7gXUgaMaw4bubbmcuIikKICAgICAgICByZXBseV9tYXJrdXAgPSBJbmxpbmVLZXlib2FyZE1hcmt1cChrZXlib2FyZCkKICAgICAgICBzZW50ID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9bWVzc2FnZV90ZXh0LAogICAgICAgICAgICByZXBseV9tYXJrdXA9cmVwbHlfbWFya3VwLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgdHJvbmcgaMOgbSB0azoge2V9IikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gIm50IikKZGVmIG50KGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgbuG6oXAgdGnhu4FuLiIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyB4w7NhIGLDoG4gcGjDrW0gdHLGsOG7m2MgxJHDsy4iKQogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0sIGtow7RuZyBjaG8gcGjDqXAgbuG6oXAgdGnhu4FuLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlID0gIlZ1aSBsw7JuZyBjaOG7jW4ga8OqbmggbuG6oXAiCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gecOqdSBj4bqndSBjaOG7jW4ga8OqbmggbuG6oXAgxJHDoyDEkcaw4bujYyBjaHXhuqluIGLhu4suIikKCiAgICAgICAga2V5Ym9hcmQgPSB0eXBlcy5JbmxpbmVLZXlib2FyZE1hcmt1cCgpCiAgICAgICAgYnRuX2JhbmsgPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiQkFOSyIsIGNhbGxiYWNrX2RhdGE9Im5hcGJhbmsiKQogICAgICAgIGJ0bl9tb21vID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIk1PTU8iLCBjYWxsYmFja19kYXRhPSJuYXBtb21vIikKICAgICAgICBidG5fdGhlY2FvID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIlRI4bq6IEPDgE8iLCBjYWxsYmFja19kYXRhPSJ0aGVjYW8iKQogICAgICAgIGtleWJvYXJkLnJvdyhidG5fbW9tbywgYnRuX2JhbmspCiAgICAgICAga2V5Ym9hcmQucm93KGJ0bl90aGVjYW8pCiAgICAgICAgcHJpbnQoIltERUJVR10gxJDDoyB04bqhbyBjw6FjIG7DunQ6IEJBTkssIE1PTU8sIFRI4bq6IEPDgE8uIikKCiAgICAgICAgc2VudF9tc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PW1lc3NhZ2UsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZCwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aW4gbmjhuq9uIHbhu5tpIGLDoG4gcGjDrW0gdMO5eSBjaOG7jW4uIikKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHRy4bqjIGzhu51pIGNhbGxiYWNrIHF1ZXJ5LiIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB0cm9uZyBow6BtIG50OiB7ZX0iKQoKZGVmIGVuc3VyZV9maWxlX2V4cyhmaWxlbmFtZSwgZGVmYXVsdF9jb250ZW50PSIiKToKICAgIHBhc3MKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlbmFtZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZW5hbWUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoZGVmYXVsdF9jb250ZW50KQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgdOG6oW8gZmlsZSB7ZmlsZW5hbWV9IHbDoCBnaGkgbuG7mWkgZHVuZyBt4bq3YyDEkeG7i25oLiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHThuqFvIGZpbGUge2ZpbGVuYW1lfToge3N0cihlKX0iKQogICAgZWxzZToKICAgICAgICBwYXNzCgpkZWYgZ2VuZXJhdGVfcXIoYmFuaywgYWNjb3VudCwgb3duZXIsIGFtb3VudCwgbWVtbyk6CiAgICB1cmwgPSBmImh0dHBzOi8vYXBpcXIud2ViMm0uY29tL2FwaS9nZW5lcmF0ZS97YmFua30ve2FjY291bnR9L3tvd25lcn0/YW1vdW50PXthbW91bnR9Jm1lbW89e21lbW99JmlzX21hc2s9MCZiZz0iCiAgICB0cnk6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQodXJsLCB0aW1lb3V0PTUpCiAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICB3aXRoIHRlbXBmaWxlLk5hbWVkVGVtcG9yYXJ5RmlsZShkZWxldGU9RmFsc2UsIHN1ZmZpeD0iLnBuZyIpIGFzIHRlbXBfZmlsZToKICAgICAgICAgICAgICAgIHRlbXBfZmlsZS53cml0ZShyZXNwb25zZS5jb250ZW50KQogICAgICAgICAgICAgICAgcmV0dXJuIHRlbXBfZmlsZS5uYW1lCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gS2jDtG5nIHRo4buDIHThuqFvIG3DoyBRUi4gTcOjIGzhu5dpOiIsIHJlc3BvbnNlLnN0YXR1c19jb2RlKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgdOG6oW8gbcOjIFFSOiB7ZX0iKQogICAgICAgIHJldHVybiBOb25lCgpkZWYgc2VuZF9xcl9hbmRfZGVsZXRlKGNoYXRfaWQsIHFyX3BhdGgpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3Blbihxcl9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICBib3Quc2VuZF9waG90byhjaGF0X2lkLCBmKQogICAgICAgIG9zLnJlbW92ZShxcl9wYXRoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHhvw6EgbcOjIFFSIHThuqFpOiB7cXJfcGF0aH0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBH4butaSBob+G6t2MgeG/DoSBtw6MgUVIgdGjhuqV0IGLhuqFpOiB7ZX0iKQoKZGVmIHJlYWRfYmFua19pbmZvKCk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2JrLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBbbGluZS5zdHJpcCgpIGZvciBsaW5lIGluIGYgaWYgbGluZS5zdHJpcCgpXQogICAgICAgIGlmIG5vdCBsaW5lczoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBzZWxlY3RlZCA9IHJhbmRvbS5jaG9pY2UobGluZXMpIGlmIGxlbihsaW5lcykgPiAxIGVsc2UgbGluZXNbMF0KICAgICAgICBwYXJ0cyA9IHNlbGVjdGVkLnNwbGl0KCI7IikKICAgICAgICBpZiBsZW4ocGFydHMpID49IDM6CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAibmFtZSI6IHBhcnRzWzBdLnN0cmlwKCksCiAgICAgICAgICAgICAgICAiYWNjb3VudCI6IHBhcnRzWzFdLnN0cmlwKCksCiAgICAgICAgICAgICAgICAib3duZXIiOiBwYXJ0c1syXS5zdHJpcCgpCiAgICAgICAgICAgIH0KICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgxJHhu41jIEZJTEUvYmsudHh0OiB7ZX0iKQogICAgcmV0dXJuIE5vbmUKCmRlZiByZWFkX21vbW9faW5mbygpOgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbigiRklMRS9tbS50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIG51bWJlcnMgPSBbbGluZS5zdHJpcCgpIGZvciBsaW5lIGluIGYgaWYgbGluZS5zdHJpcCgpXQogICAgICAgIGlmIG5vdCBudW1iZXJzOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIG51bWJlciA9IHJhbmRvbS5jaG9pY2UobnVtYmVycykgaWYgbGVuKG51bWJlcnMpID4gMSBlbHNlIG51bWJlcnNbMF0KICAgICAgICByZXR1cm4geyJudW1iZXIiOiBudW1iZXJ9CiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIMSR4buNYyBGSUxFL21tLnR4dDoge2V9IikKICAgIHJldHVybiBOb25lCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhIGluIFsibmFwYmFuayIsICJuYXBtb21vIl0pCmRlZiB0cmFsb2luYXB0aWVuKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgZnVsbG5hbWUgPSBjYWxsLmZyb21fdXNlci5mdWxsX25hbWUKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IHnDqnUgY+G6p3UgbuG6oXAgdGnhu4FuICh7Y2FsbC5kYXRhfSkuIikKICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3JlcGx5X21hcmt1cCgKICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPU5vbmUpCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICBkZWYgcmVhZF9tYW5hcF9mb3JfdXNlcih1aWQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbWFuYXAudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyIGFuZCBwYXJ0c1swXSA9PSB1aWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFydHNbMV0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIMSR4buNYyBtYW5hcC50eHQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgbWFuYXAgPSByZWFkX21hbmFwX2Zvcl91c2VyKHVzZXJfaWQpCiAgICAgICAgaWYgbm90IG1hbmFwOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBiYWxhbmNlID0gaW50KG1hbmFwKSBpZiBtYW5hcC5pc2RpZ2l0KCkgZWxzZSAwCiAgICAgICAgaXNfbW9tbyA9IChjYWxsLmRhdGEgPT0gIm5hcG1vbW8iKQogICAgICAgIG1vbmV5X2J1dHRvbnMgPSBbCiAgICAgICAgICAgICgiMTAuMDAwIiwgIjEwMDAwIiksICgiMjAuMDAwIiwgIjIwMDAwIiksCiAgICAgICAgICAgICgiNTAuMDAwIiwgIjUwMDAwIiksICgiMTAwLjAwMCIsICIxMDAwMDAiKSwKICAgICAgICAgICAgKCIyMDAuMDAwIiwgIjIwMDAwMCIpLCAoIjUwMC4wMDAiLCAiNTAwMDAwIiksCiAgICAgICAgICAgICgiMS4wMDAuMDAwIiwgIjEwMDAwMDAiKSwgKCIyLjAwMC4wMDAiLCAiMjAwMDAwMCIpLAogICAgICAgICAgICAoIjUuMDAwLjAwMCIsICI1MDAwMDAwIiksICgiMTAuMDAwLjAwMCIsICIxMDAwMDAwMCIpXQogICAgICAgIG1hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKHJvd193aWR0aD0yKQogICAgICAgIHJvd3MgPSBbbW9uZXlfYnV0dG9uc1tpOmkrMl0gZm9yIGkgaW4gcmFuZ2UoMCwgbGVuKG1vbmV5X2J1dHRvbnMpLCAyKV0KICAgICAgICBmb3Igcm93IGluIHJvd3M6CiAgICAgICAgICAgIG1hcmt1cC5yb3coCiAgICAgICAgICAgICAgICAqW0lubGluZUtleWJvYXJkQnV0dG9uKGxhYmVsLCBjYWxsYmFja19kYXRhPWYie2NhbGwuZGF0YX1fe3ZhbHVlfSIpIGZvciBsYWJlbCwgdmFsdWUgaW4gcm93XSkKICAgICAgICBpZiBpc19tb21vOgogICAgICAgICAgICBjYXB0aW9uID0gKAogICAgICAgICAgICAgICAgIlZ1aSBsw7JuZyBjaOG7jW4gYsOqbiBkxrDhu5tpOlxuXG4iCiAgICAgICAgICAgICAgICAi4p6h77iPIELhuqFuIGPDsyB0aOG7gyB04bqhbyDEkcahbiB0aGVvIGPDuiBwaMOhcDogL25hcG1vbW8gW3Phu5EgdGnhu4FuXVxuIgogICAgICAgICAgICAgICAgIlZEOiAvbmFwbW9tbyAxMDAwMCIpCiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD1jYXB0aW9uLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPW1hcmt1cCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBjYXB0aW9uID0gKAogICAgICAgICAgICAgICAgIlZ1aSBsw7JuZyBjaOG7jW4gYsOqbiBkxrDhu5tpOlxuXG4iCiAgICAgICAgICAgICAgICAi4p6h77iPIELhuqFuIGPDsyB0aOG7gyB04bqhbyDEkcahbiB0aGVvIGPDuiBwaMOhcDogL25hcGJhbmsgW3Phu5EgdGnhu4FuXVxuIgogICAgICAgICAgICAgICAgIlZEOiAvbmFwYmFuayAxMDAwMCIpCiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD1jYXB0aW9uLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPW1hcmt1cCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgeOG7rSBsw70gbuG6oXAgdGnhu4FuOiB7ZX0iKQoKcGVuZGluZ191c2VycyA9IHNldCgpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJ0aGVjYW8iKQpkZWYgaHVvbmdkYW5fbmFwdGhlKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDhuqVuIG7DunQgVGjhursgY8OgbyIpCgogICAgICAgICMg8J+nuSBYw7NhIG7DunQgY8WpCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICAjIPCfk4sgSMaw4bubbmcgZOG6q24gbuG6oXAgdGjhursKICAgICAgICBodW9uZ2RhbiA9ICgKICAgICAgICAgICAgIuKeoe+4jyBEw7luZyBs4buHbmg6IDxiPi9uYXB0aGUgW0xv4bqhaSB0aOG6u10gW23hu4duaCBnacOhXSBbbcOjIHRo4bq7XSBbc2VyaV08L2I+XG4iCiAgICAgICAgICAgICJWRDogPGNvZGU+L25hcHRoZSBWSUVUVEVMIDUwMDAwMCAxMTk5MzQyOTc4NDM3NyAxMDAwMDg4MzAyNjM1MzwvY29kZT5cblxuIgogICAgICAgICAgICAiLSBDaOG7iSDDoXAgZOG7pW5nIGNobyBjw6FjIGxv4bqhaSB0aOG6uyBuaMawOiAiCiAgICAgICAgICAgICI8Yj5WSUVUVEVMLCBNT0JJRk9ORSwgVklOQVBIT05FLCBWSUVUTkFNTU9CSUxFLCBaSU5HLCBHQVJFTkEsIFZDT0lOLCBTQ09JTjwvYj5cbiIKICAgICAgICAgICAgIi0gTeG7h25oIGdpw6EgaOG7o3AgbOG7hzogPGI+MTAuMDAwLCAyMC4wMDAsIDMwLjAwMCwgNTAuMDAwLCAxMDAuMDAwLCAyMDAuMDAwLCAzMDAuMDAwLCA1MDAuMDAwLCAxLjAwMC4wMDA8L2I+IgogICAgICAgICkKCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIGh1b25nZGFuLAogICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBn4butaSBoxrDhu5tuZyBk4bqrbiBu4bqhcCB0aOG6uzoge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsibmFwdGhlIl0pCmRlZiBuYXB0aGVjYW8obWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgQURNSU5fQk9UX1RPS0VOID0gIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiCiAgICAgICAgQURNSU5fR1JPVVBfSUQgPSAtMTAwMzI0MTAwMjQ3OAogICAgICAgIGFkbWluX2JvdCA9IHRlbGVib3QuVGVsZUJvdChBRE1JTl9CT1RfVE9LRU4pCgogICAgICAgIGRlZiBmb3JtYXRfYmFsYW5jZSh4KToKICAgICAgICAgICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQoaW50KHgpKS5yZXBsYWNlKCIsIiwgIi4iKQoKICAgICAgICAjIEPDoWMgbG/huqFpIHRo4bq7IGjhu6NwIGzhu4cKICAgICAgICBjYXJkX3R5cGVzID0gWyJWSUVUVEVMIiwgIk1PQklGT05FIiwgIlZJTkFQSE9ORSIsICJWSUVUTkFNTU9CSUxFIiwKICAgICAgICAgICAgICAgICAgICAgICJaSU5HIiwgIkdBUkVOQSIsICJWQ09JTiIsICJTQ09JTiJdCiAgICAgICAgdmFsaWRfYW1vdW50cyA9IFsiMTAwMDAiLCAiMjAwMDAiLCAiMzAwMDAiLCAiNTAwMDAiLCAiMTAwMDAwIiwKICAgICAgICAgICAgICAgICAgICAgICAgICIyMDAwMDAiLCAiMzAwMDAwIiwgIjUwMDAwMCIsICIxMDAwMDAwIl0KCiAgICAgICAgdXNlcl9pZCA9IHN0cihtZXNzYWdlLmZyb21fdXNlci5pZCkKICAgICAgICBmdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZSBvciAiTmfGsOG7nWkgZMO5bmciCiAgICAgICAgdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KCkKCiAgICAgICAgIyDinIUgS2nhu4NtIHRyYSBjw7ogcGjDoXAKICAgICAgICBpZiBsZW4odGV4dCkgIT0gNToKICAgICAgICAgICAgYm90LnJlcGx5X3RvKAogICAgICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgICAgICLinqHvuI8gPGI+L25hcHRoZSBbTG/huqFpIHRo4bq7XSBbbeG7h25oIGdpw6FdIFttw6MgdGjhurtdIFtzZXJpXTwvYj5cbiIKICAgICAgICAgICAgICAgICJWRDogPGNvZGU+L25hcHRoZSBWSUVUVEVMIDUwMDAwMCAxMTk5MzQyOTc4NDM3NyAxMDAwMDg4MzAyNjM1MzwvY29kZT4iLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIKICAgICAgICAgICAgKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgXywgbG9haXRoZSwgbWVuaGdpYSwgbWF0aGUsIHNlcmkgPSB0ZXh0CiAgICAgICAgbG9haXRoZSA9IGxvYWl0aGUudXBwZXIoKS5zdHJpcCgpCiAgICAgICAgbWVuaGdpYV9jbGVhbiA9IG1lbmhnaWEucmVwbGFjZSgiLiIsICIiKS5yZXBsYWNlKCIsIiwgIiIpLnN0cmlwKCkKCiAgICAgICAgIyDinIUgS2nhu4NtIHRyYSBsb+G6oWkgdGjhursgdsOgIG3hu4duaCBnacOhCiAgICAgICAgaWYgbG9haXRoZSBub3QgaW4gY2FyZF90eXBlczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVuaGdpYV9jbGVhbiBub3QgaW4gdmFsaWRfYW1vdW50czoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMg4pyFIEtp4buDbSB0cmEgbcOjIHRo4bq7IHbDoCBzZXJpIGNo4buJIGzDoCBz4buRCiAgICAgICAgaWYgbm90IG1hdGhlLmlzZGlnaXQoKSBvciBub3Qgc2VyaS5pc2RpZ2l0KCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIOKchSDEkOG6o20gYuG6o28gZmlsZSBsxrB1IHRo4bq7IHThu5NuIHThuqFpCiAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGNhcmRzX2ZpbGUgPSAiRklMRS9jYXJkc2QudHh0IgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhjYXJkc19maWxlKToKICAgICAgICAgICAgb3BlbihjYXJkc19maWxlLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpLmNsb3NlKCkKCiAgICAgICAgIyDinIUgS2nhu4NtIHRyYSB0csO5bmcgdGjhursgKG3DoyB0aOG6uyAmIHNlcmkpCiAgICAgICAgd2l0aCBvcGVuKGNhcmRzX2ZpbGUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gW3Auc3RyaXAoKSBmb3IgcCBpbiBsaW5lLnN0cmlwKCkuc3BsaXQoInwiKV0KICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gNToKICAgICAgICAgICAgICAgICAgICBvbGRfbWF0aGUsIG9sZF9zZXJpID0gcGFydHNbM10sIHBhcnRzWzRdCiAgICAgICAgICAgICAgICAgICAgaWYgbWF0aGUgPT0gb2xkX21hdGhlIGFuZCBzZXJpID09IG9sZF9zZXJpOgogICAgICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIuKaoO+4jyBUaOG6uyBuw6B5IMSRw6MgxJHGsOG7o2Mgc+G7rSBk4bulbmciLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMg4pyFIEzGsHUgdOG6oW0gdsOgbyBwZW5kaW5nX2NhcmRzLnR4dAogICAgICAgIG9zLm1ha2VkaXJzKCJkYXRhIiwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICB3aXRoIG9wZW4oImRhdGEvcGVuZGluZ19jYXJkcy50eHQiLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZH18e2xvYWl0aGV9fHttZW5oZ2lhX2NsZWFufXx7bWF0aGV9fHtzZXJpfVxuIikKCiAgICAgICAgIyDinIUgR+G7rWkgbWVudSB4w6FjIG5o4bqtbgogICAgICAgIG1hcmt1cCA9IHRlbGVib3QudHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAocm93X3dpZHRoPTIpCiAgICAgICAgbWFya3VwLmFkZCgKICAgICAgICAgICAgdGVsZWJvdC50eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiWMOhYyBuaOG6rW4iLCBjYWxsYmFja19kYXRhPWYieGFjbmhhbl97dXNlcl9pZH0iKSwKICAgICAgICAgICAgdGVsZWJvdC50eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiSOG7p3kgYuG7jyIsIGNhbGxiYWNrX2RhdGE9ZiJodXlib197dXNlcl9pZH0iKQogICAgICAgICkKCiAgICAgICAgY2FwdGlvbiA9ICgKICAgICAgICAgICAgIvCflJYgPGI+WMOhYyBuaOG6rW4gdGjDtG5nIHRpbiB0aOG6uyBjw6BvIGLDqm4gZMaw4bubaTo8L2I+XG5cbiIKICAgICAgICAgICAgZiJMb+G6oWkgdGjhurs6IDxiPntsb2FpdGhlfTwvYj5cbiIKICAgICAgICAgICAgZiJN4buHbmggZ2nDoTogPGI+e2Zvcm1hdF9iYWxhbmNlKG1lbmhnaWFfY2xlYW4pfcSRPC9iPlxuIgogICAgICAgICAgICBmIk3DoyB0aOG6uzogPGNvZGU+e21hdGhlfTwvY29kZT5cbiIKICAgICAgICAgICAgZiJTZXJpOiA8Y29kZT57c2VyaX08L2NvZGU+XG5cbiIKICAgICAgICAgICAgIi0gSMOjeSDhuqVuIDxiPljDoWMgbmjhuq1uPC9iPiDEkeG7gyB44butIGzDvSBu4bqhcCB0aOG6uyDwn5GHIgogICAgICAgICkKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgY2FwdGlvbiwgcGFyc2VfbW9kZT0iSFRNTCIsIHJlcGx5X21hcmt1cD1tYXJrdXApCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBuYXB0aGVjYW86IHtlfSIpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhLnN0YXJ0c3dpdGgoKCJ4YWNuaGFuXyIsICJodXlib18iKSkpCmRlZiB4dWx5KGNhbGwpOgogICAgdHJ5OgogICAgICAgIEFETUlOX0JPVF9UT0tFTiA9ICI4MDc5MzE3MDM3OkFBRkswdGh0Yk9UZDBWZ3laeUExMVZyRTNlSjV5UFA2dXRZIgogICAgICAgIEFETUlOX0dST1VQX0lEID0gLTEwMDMyNDEwMDI0NzgKICAgICAgICBhZG1pbl9ib3QgPSB0ZWxlYm90LlRlbGVCb3QoQURNSU5fQk9UX1RPS0VOKQogICAgICAgIGRlZiBmb3JtYXRfYmFsYW5jZSh4KToKICAgICAgICAgICAgcmV0dXJuICJ7Oix9Ii5mb3JtYXQoaW50KHgpKS5yZXBsYWNlKCIsIiwgIi4iKQogICAgICAgIHVzZXJfaWQgPSBjYWxsLmRhdGEuc3BsaXQoIl8iKVsxXQogICAgICAgIGlmIHVzZXJfaWQgaW4gcGVuZGluZ191c2VyczoKICAgICAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkLCAixJBhbmcgeOG7rSBsw70sIHZ1aSBsw7JuZyBjaOG7nS4uLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHBlbmRpbmdfdXNlcnMuYWRkKHVzZXJfaWQpCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLCByZXBseV9tYXJrdXA9Tm9uZSkKICAgICAgICBpZiBjYWxsLmRhdGEuc3RhcnRzd2l0aCgiaHV5Ym9fIik6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsICJI4buneSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICBwZW5kaW5nX3VzZXJzLmRpc2NhcmQodXNlcl9pZCkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgd2l0aCBvcGVuKCJkYXRhL3BlbmRpbmdfY2FyZHMudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKCiAgICAgICAgZm91bmQgPSBOb25lCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIGluZm8gPSBsaW5lLnN0cmlwKCkuc3BsaXQoInwiKQogICAgICAgICAgICBpZiBpbmZvWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICBmb3VuZCA9IGluZm8KICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgcGVuZGluZ191c2Vycy5kaXNjYXJkKHVzZXJfaWQpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBfLCBsb2FpdGhlLCBtZW5oZ2lhLCBtYXRoZSwgc2VyaSA9IGZvdW5kCiAgICAgICAgZnVsbG5hbWUgPSBjYWxsLmZyb21fdXNlci5mdWxsX25hbWUgb3IgIk5nxrDhu51pIGTDuW5nIgogICAgICAgIHVzZXJuYW1lID0gY2FsbC5mcm9tX3VzZXIudXNlcm5hbWUgb3IgIktow7RuZyBjw7MgdXNlcm5hbWUiCgogICAgICAgICMgTeG7nyBGSUxFL2NhcmRzZC50eHQsIG7hur91IGNoxrBhIGPDsyB0aMOsIHThuqFvCiAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGNhcmRzX2ZpbGUgPSAiRklMRS9jYXJkc2QudHh0IgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhjYXJkc19maWxlKToKICAgICAgICAgICAgb3BlbihjYXJkc19maWxlLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpLmNsb3NlKCkKCiAgICAgICAgZnVsbF9saW5lID0gZiJ7dXNlcl9pZH0gfCB7bG9haXRoZX0gfCB7bWVuaGdpYX0gfCB7bWF0aGV9IHwge3Nlcml9IgogICAgICAgIHdpdGggb3BlbihjYXJkc19maWxlLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGlmIGFueShmdWxsX2xpbmUuc3RyaXAoKSA9PSBsaW5lLnN0cmlwKCkgZm9yIGxpbmUgaW4gZik6CiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAiVGjhursgbsOgeSDEkcOjIMSRxrDhu6NjIHPhu60gZOG7pW5nIiwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgICAgICBwZW5kaW5nX3VzZXJzLmRpc2NhcmQodXNlcl9pZCkKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIEzGsHUgdGjhursgbeG7m2kKICAgICAgICB3aXRoIG9wZW4oY2FyZHNfZmlsZSwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGZ1bGxfbGluZSArICJcbiIpCgogICAgICAgICMgR+G7rWkgc2FuZyBuaMOzbSBhZG1pbgogICAgICAgIHVzZXJfbGluayA9IGYnPGEgaHJlZj0idGc6Ly91c2VyP2lkPXt1c2VyX2lkfSI+e2Z1bGxuYW1lfTwvYT4nCiAgICAgICAgbXNnX2FkbWluID0gKAogICAgICAgICAgICBmInt1c2VyX2xpbmt9XG4iCiAgICAgICAgICAgIGYi8J+GlCBJRDogPGNvZGU+e3VzZXJfaWR9PC9jb2RlPlxuIgogICAgICAgICAgICBmIvCfkrggU+G7kSB0aeG7gW46IDxiPntmb3JtYXRfYmFsYW5jZShtZW5oZ2lhKX3EkTwvYj5cbiIKICAgICAgICAgICAgZiLwn5KwIEvDqm5oIG7huqFwOiBUSOG6uiBDw4BPXG4iCiAgICAgICAgICAgIGYi8J+SsyBMb+G6oWkgdGjhurs6IHtsb2FpdGhlfVxuIgogICAgICAgICAgICBmIuKeoe+4jyBNw6MgdGjhurs6IDxjb2RlPnttYXRoZX08L2NvZGU+XG4iCiAgICAgICAgICAgIGYi4p6h77iPIFNlcmk6IDxjb2RlPntzZXJpfTwvY29kZT5cbiIKICAgICAgICAgICAgZiLinqHvuI8gRHV54buHdDogPGNvZGU+TkFQVEhFIHt1c2VyX2lkfSB7bWVuaGdpYX08L2NvZGU+XG4iCiAgICAgICAgICAgIGYi4p6h77iPIEjhu6d5OiA8Y29kZT5IVVkge3VzZXJfaWR9PC9jb2RlPlxuIgogICAgICAgICAgICBmIuKeoe+4jyBBRE1JTiDGoEkgVVNFUiBU4bqgTyDEkMagTjogQHt1c2VybmFtZX0iCiAgICAgICAgKQoKICAgICAgICBhZG1pbl9ib3Quc2VuZF9tZXNzYWdlKEFETUlOX0dST1VQX0lELCBtc2dfYWRtaW4sIHBhcnNlX21vZGU9IkhUTUwiKQoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAixJBhbmcgeOG7rSBsw70sIHZ1aSBsw7JuZyDEkeG7o2kuLi4iLCBwYXJzZV9tb2RlPSJIVE1MIikKCiAgICAgICAgIyBYw7NhIGto4buPaSBwZW5kaW5nCiAgICAgICAgd2l0aCBvcGVuKCJkYXRhL3BlbmRpbmdfY2FyZHMudHh0IiwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIGlmIHVzZXJfaWQgbm90IGluIGxpbmU6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShsaW5lKQogICAgICAgIHBlbmRpbmdfdXNlcnMuZGlzY2FyZCh1c2VyX2lkKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB4dWx5OiB7ZX0iKQogICAgICAgIHBlbmRpbmdfdXNlcnMuZGlzY2FyZCh1c2VyX2lkKQoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YS5zdGFydHN3aXRoKCJuYXBtb21vXyIpIG9yIGNhbGwuZGF0YS5zdGFydHN3aXRoKCJuYXBiYW5rXyIpKQpkZWYgbmFwc290aWVuKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgZnVsbG5hbWUgPSBjYWxsLmZyb21fdXNlci5mdWxsX25hbWUKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGNo4buNbiBz4buRIHRp4buBbiB7Y2FsbC5kYXRhfSIpCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQoKICAgICAgICAjIFjDs2EgaW5saW5lIGtleWJvYXJkIGPFqQogICAgICAgIHRyeToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdGjhu4MgeMOzYSBuw7p0IGPFqToge2V9IikKCiAgICAgICAgcGFydHMgPSBjYWxsLmRhdGEuc3BsaXQoIl8iKQogICAgICAgIG1ldGhvZCA9IHBhcnRzWzBdCiAgICAgICAgYW1vdW50ID0gcGFydHNbMV0KCiAgICAgICAgZGVmIHJlYWRfbWFuYXBfZm9yX3VzZXIodWlkKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL21hbmFwLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gdWlkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnRzWzFdCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSDEkeG7jWMgbWFuYXAudHh0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICBtYW5hcCA9IHJlYWRfbWFuYXBfZm9yX3VzZXIodXNlcl9pZCkKICAgICAgICBpZiBub3QgbWFuYXA6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBtZXRob2QgPT0gIm5hcG1vbW8iOgogICAgICAgICAgICBtb21vID0gcmVhZF9tb21vX2luZm8oKQogICAgICAgICAgICBpZiBub3QgbW9tbzoKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgIyA9PT09PSBOb3RpZnkgYWRtaW4gdHLGsOG7m2MgPT09PT0KICAgICAgICAgICAgbm90aWZ5X2FkbWluX25ld19vcmRlcihmdWxsbmFtZSwgdXNlcl9pZCwgYW1vdW50LCBUcnVlLCBudW1iZXI9bW9tb1snbnVtYmVyJ10sIG1hbmFwPW1hbmFwKQoKICAgICAgICAgICAgY2FwdGlvbiA9IGYiIiJDaHV54buDbiB0aeG7gW4gdsOgbwo8Yj7inqHvuI8gTU9NTzogPGNvZGU+e21vbW9bJ251bWJlciddfTwvY29kZT4g8J+RiCBDTElDSyDEkOG7giBDT1BZCuKeoe+4jyBT4buRIHRp4buBbjoge2Zvcm1hdF9iYWxhbmNlKGludChhbW91bnQpKX0K4p6h77iPIE7hu5lpIGR1bmc6IDxjb2RlPnttYW5hcH08L2NvZGU+IPCfkYggQ0xJQ0sgxJDhu4IgQ09QWTwvYj4KCkzGsHUgw706IE7huqFwIHThu5FpIHRoaeG7g3UgMTAuMDAwxJEuIFPhu5EgTW9NbyBt4buXaSBs4bqnbiBu4bqhcCBjw7MgdGjhu4Mga2jDoWMgbmhhdSwgbeG7l2kgbOG6p24gbuG6oXAgdsOgbyBCb3QgxJHhu4MgbOG6pXkgc+G7kSDEkWFuZyBob+G6oXQgxJHhu5luZy4KPGk+QuG6oW4gY+G6p24gY8aw4bujYyAxMDAlIHPhu5EgdGnhu4FuIG7huqFwIG3hu5tpIGPDsyB0aOG7gyByw7p0PC9pPgpUZWxlZ3JhbSBo4buXIHRy4bujIGh0dHBzOi8vdC5tZS9yb29tdGluaGxpbmgiIiIKCiAgICAgICAgICAgIHFyX3VybCA9IGYiaHR0cHM6Ly9tb21vc3YzLmFwaW1pZW5waGkuY29tL2FwaS9RUkNvZGU/cGhvbmU9e21vbW9bJ251bWJlciddfSZhbW91bnQ9e2Ftb3VudH0mbm90ZT17bWFuYXB9IgoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQocXJfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgICAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgICAgICAgICBpbWcgPSBJbWFnZS5vcGVuKEJ5dGVzSU8ocmVzcG9uc2UuY29udGVudCkpLmNvbnZlcnQoIlJHQiIpCiAgICAgICAgICAgICAgICBpbWdfYnl0ZXMgPSBCeXRlc0lPKCkKICAgICAgICAgICAgICAgIGltZy5zYXZlKGltZ19ieXRlcywgZm9ybWF0PSJQTkciKQogICAgICAgICAgICAgICAgaW1nX2J5dGVzLnNlZWsoMCkKCiAgICAgICAgICAgICAgICBzZW50X3Bob3RvID0gYm90LnNlbmRfcGhvdG8oCiAgICAgICAgICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgICAgICBwaG90bz1pbWdfYnl0ZXMsCiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbj1jYXB0aW9uLAogICAgICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBsdXV2YXhvYXRuKHNlbnRfcGhvdG8pCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB04bqjaSBRUiBNT01POiB7ZX0iKQogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgY2FwdGlvbiwgcGFyc2VfbW9kZT0iSFRNTCIpCgogICAgICAgIGVsaWYgbWV0aG9kID09ICJuYXBiYW5rIjoKICAgICAgICAgICAgYmFua19pbmZvID0gcmVhZF9iYW5rX2luZm8oKQogICAgICAgICAgICBpZiBub3QgYmFua19pbmZvOgogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICAjID09PT09IE5vdGlmeSBhZG1pbiB0csaw4bubYyA9PT09PQogICAgICAgICAgICBub3RpZnlfYWRtaW5fbmV3X29yZGVyKGZ1bGxuYW1lLCB1c2VyX2lkLCBhbW91bnQsIEZhbHNlLCBudW1iZXI9YmFua19pbmZvWydhY2NvdW50J10sIG1hbmFwPW1hbmFwKQoKICAgICAgICAgICAgY2FwdGlvbiA9IGYiIiJRdcOpdCBtw6MgdHLDqm4gaG/hurdjIENodXnhu4NuIHRp4buBbiB2w6BvCvCfj6YgTmfDom4gaMOgbmc6IHtiYW5rX2luZm9bJ25hbWUnXX0K8J+RpCBUw6puIGNo4bunIHTDoGkga2hv4bqjbjogPGNvZGU+e2JhbmtfaW5mb1snb3duZXInXX08L2NvZGU+CvCfkrMgU+G7kSBUw6BpIEtob+G6o246IDxjb2RlPntiYW5rX2luZm9bJ2FjY291bnQnXX08L2NvZGU+IPCfkYggTkjhuqRQIFbDgE8gU+G7kCBUSyDEkOG7giBDT1BZCjxiPuKeoe+4jyBT4buRIHRp4buBbjoge2Zvcm1hdF9iYWxhbmNlKGludChhbW91bnQpKX0K4p6h77iPIE7hu5lpIGR1bmcgY2h1eeG7g24gdGnhu4FuIGzDoAo8Y29kZT57bWFuYXB9PC9jb2RlPiDwn5GIIENMSUNLIMSQ4buCIENPUFkKTuG6oFAgVOG7kEkgVEhJ4buCVSAxMEs8L2I+CgpWVUkgTMOSTkcgTkjhuqxQIMSQw5pORyBO4buYSSBEVU5HLCBT4buQIFRJ4buATiBU4buQSSBUSEnhu4JVIEzDgCA2Sy4gTuG6vlUgS0jDlE5HIEPDkyBO4buYSSBEVU5HIEhP4bq2QyBTQUkgTuG7mEkgRFVORyBT4bq8IEtIw5RORyDEkMav4buiQyBIT8OATiBUUuG6ogoKVGVsZWdyYW0gaOG7lyB0cuG7oyBodHRwczovL3QubWUvcm9vbXRpbmhsaW5oIiIiCgogICAgICAgICAgICBxcl91cmwgPSBmImh0dHBzOi8vaW1nLnZpZXRxci5pby9pbWFnZS97YmFua19pbmZvWyduYW1lJ10ucmVwbGFjZSgnICcsICcnKX0te2JhbmtfaW5mb1snYWNjb3VudCddfS1uYXAucG5nP2Ftb3VudD17YW1vdW50fSZhZGRJbmZvPXttYW5hcH0iCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChxcl91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgICAgIGltZyA9IEltYWdlLm9wZW4oQnl0ZXNJTyhyZXNwb25zZS5jb250ZW50KSkuY29udmVydCgiUkdCIikKICAgICAgICAgICAgICAgIGltZ19ieXRlcyA9IEJ5dGVzSU8oKQogICAgICAgICAgICAgICAgaW1nLnNhdmUoaW1nX2J5dGVzLCBmb3JtYXQ9IlBORyIpCiAgICAgICAgICAgICAgICBpbWdfYnl0ZXMuc2VlaygwKQoKICAgICAgICAgICAgICAgIHNlbnRfcGhvdG8gPSBib3Quc2VuZF9waG90bygKICAgICAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgIHBob3RvPWltZ19ieXRlcywKICAgICAgICAgICAgICAgICAgICBjYXB0aW9uPWNhcHRpb24sCiAgICAgICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGx1dXZheG9hdG4oc2VudF9waG90bykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHThuqNpIFFSIEJBTks6IHtlfSIpCiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBjYXB0aW9uLCBwYXJzZV9tb2RlPSJIVE1MIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHjhu60gbMO9IGNo4buNbiBz4buRIHRp4buBbjoge2V9IikKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBtZXNzYWdlLnRleHQgYW5kIG1lc3NhZ2UudGV4dC51cHBlcigpLnN0YXJ0c3dpdGgoIkhVWSAiKSkKZGVmIGh1eV90aGUobWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgQURNSU5fSUQgPSA4MjA1NTY3ODUxCiAgICAgICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgIT0gQURNSU5fSUQ6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBVc2VyIHttZXNzYWdlLmZyb21fdXNlci5pZH0gY+G7kSBn4bqvbmcgZMO5bmcgbOG7h25oIEhVWSBuaMawbmcga2jDtG5nIGPDsyBxdXnhu4FuLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHBhcnRzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMjoKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gU2FpIGPDuiBwaMOhcCBIVVkg4oCUIGPhuqduIGThuqFuZzogSFVZIFt1c2VyX2lkXSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRhcmdldF9pZCA9IHBhcnRzWzFdCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEFkbWluIHttZXNzYWdlLmZyb21fdXNlci5pZH0gZ+G7rWkgSFVZIMSR4bq/biB1c2VyIHt0YXJnZXRfaWR9IikKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoaW50KHRhcmdldF9pZCksICJUaOG6uyBs4buXaSIsIHBhcnNlX21vZGU9IkhUTUwiKQogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4pyFIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gJ1Ro4bq7IGzhu5dpJyB04bubaSB1c2VyIDxjb2RlPnt0YXJnZXRfaWR9PC9jb2RlPiIsIHBhcnNlX21vZGU9IkhUTUwiKQogICAgICAgICAgICBwcmludChmIltERUJVR10gR+G7rWkgdGjDoG5oIGPDtG5nIHRow7RuZyBiw6FvICdUaOG6uyBs4buXaScgY2hvIHVzZXIge3RhcmdldF9pZH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyBn4butaSB0aW4gbmjhuq9uIGNobyB1c2VyIHt0YXJnZXRfaWR9OiB7ZX0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB0cm9uZyBow6BtIEhVWToge2V9IikKCmRlZiByZWFkX21hbmFwX2Zvcl91c2VyKHVpZCk6CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL21hbmFwLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gdWlkOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0c1sxXQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSDEkeG7jWMgbWFuYXAudHh0OiB7ZX0iKQogICAgcmV0dXJuIE5vbmUKCgpkZWYgbm90aWZ5X2FkbWluX25ld19vcmRlcigKICAgIGZ1bGxuYW1lLAogICAgdXNlcl9pZCwKICAgIGJhbGFuY2UsCiAgICBpc19tb21vOiBib29sLAogICAgbnVtYmVyPU5vbmUsCiAgICBtYW5hcD1Ob25lLAogICAgYmFua19uYW1lPU5vbmUsCiAgICBvd25lcj1Ob25lCik6CiAgICBBRE1JTiA9ICItMTAwMzI0MTAwMjQ3OCIKCiAgICB0cnk6CiAgICAgICAgbWV0aG9kID0gIk1PTU8iIGlmIGlzX21vbW8gZWxzZSAiQkFOSyIKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBiYWxhbmNlX2ludCA9IGludChiYWxhbmNlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGJhbGFuY2VfaW50ID0gMAoKICAgICAgICAjIC0tLS0gRklYOiBO4buZaSBkdW5nIG7huqFwIGx1w7RuIGPDsyAtLS0tCiAgICAgICAgbmFwX2NvbnRlbnQgPSBtYW5hcCBpZiBtYW5hcCBlbHNlIGYiTkFQe21ldGhvZH1fe3VzZXJfaWR9IgoKICAgICAgICBjYXB0aW9uID0gZiIiIgrwn5GkIE5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWV9CvCfhpQgSUQ6IDxjb2RlPnt1c2VyX2lkfTwvY29kZT4K8J+SuCBT4buRIHRp4buBbjoge2Zvcm1hdF9iYWxhbmNlKGJhbGFuY2VfaW50KX0K8J+SsCBLw6puaCBu4bqhcDoge21ldGhvZH0KIiIiCgogICAgICAgICMgPT09PT0gTU9NTyA9PT09PQogICAgICAgIGlmIGlzX21vbW86CiAgICAgICAgICAgIGNhcHRpb24gKz0gZiIiIvCfk7EgU8SQVCBNT01POiA8Y29kZT57bnVtYmVyIG9yICdLaMO0bmcgcsO1J308L2NvZGU+CvCfk50gTuG7mWkgZHVuZyBu4bqhcDogPGNvZGU+e25hcF9jb250ZW50fTwvY29kZT4KQURNSU46IEBrYWlhYWExOAoiIiIKCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2FwdGlvbiArPSBmIiIi8J+SsyBT4buRIFRLOiA8Y29kZT57bnVtYmVyIG9yICdLaMO0bmcgcsO1J308L2NvZGU+CvCfk50gTuG7mWkgZHVuZyBu4bqhcDogPGNvZGU+e25hcF9jb250ZW50fTwvY29kZT4KQURNSU46IEBrYWlhYWExOAoiIiIKCiAgICAgICAgY2FwdGlvbiArPSBmIiIiCuKeoe+4jyBEdXnhu4d0IMSRxqFuOgo8Y29kZT5OQVB7bWV0aG9kfSB7dXNlcl9pZH0ge2JhbGFuY2VfaW50fTwvY29kZT4KIiIiCgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPUFETUlOLAogICAgICAgICAgICB0ZXh0PWNhcHRpb24sCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgKQoKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyDEkcahbiBu4bqhcCB7bWV0aG9kfSBj4bunYSB7dXNlcl9pZH0uIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvIGFkbWluIChub3RpZnlfYWRtaW5fbmV3X29yZGVyKToge2V9IikKCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bIm5hcG1vbW8iXSkKZGVmIG5hcF9tb21vKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIGZ1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgbuG6oXAgTU9NTy4iKQoKICAgICAgICAjID09PT09IENo4bq3biBzcGFtIC8gZm9yd2FyZCA9PT09PQogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyA9PT09PSBLaeG7g20gdHJhIHPhu5EgdGnhu4FuID09PT09CiAgICAgICAgYXJncyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgpCiAgICAgICAgaWYgbGVuKGFyZ3MpIDwgMiBvciBub3QgYXJnc1sxXS5pc2RpZ2l0KCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBhbW91bnQgPSBpbnQoYXJnc1sxXSkgICAjIENIVVnhu4JOIFNBTkcgSU5UCgogICAgICAgICMgPT09PT0gS0nhu4JNIFRSQSBNSU4vTUFYID09PT09CiAgICAgICAgTUlOX05BUCA9IDEwMDAwICAgICAgICAgICAjIDEwLjAwMAogICAgICAgIE1BWF9OQVAgPSAzMDAwMDAwMDAgICAgICAgIyAzMDAgdHJp4buHdQoKICAgICAgICBpZiBhbW91bnQgPCBNSU5fTkFQOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgZiJU4buRaSB0aGnhu4N1IG7huqFwIDEwLjAwMCIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBhbW91bnQgPiBNQVhfTkFQOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgZiJU4buRaSDEkWEgbuG6oXAgMzAwLjAwMC4wMDAiLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIKICAgICAgICAgICAgKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyA9PT09PSBM4bqleSB0aMO0bmcgdGluIE1PTU8gKyBtw6MgbuG6oXAgPT09PT0KICAgICAgICBtb21vID0gcmVhZF9tb21vX2luZm8oKQogICAgICAgIGlmIG5vdCBtb21vOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBtYW5hcCA9IHJlYWRfbWFuYXBfZm9yX3VzZXIoc3RyKHVzZXJfaWQpKQogICAgICAgIGlmIG5vdCBtYW5hcDoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgPT09PT0gVGjDtG5nIGLDoW8gYWRtaW4gdHLGsOG7m2MgPT09PT0KICAgICAgICBub3RpZnlfYWRtaW5fbmV3X29yZGVyKAogICAgICAgICAgICBmdWxsbmFtZSwgdXNlcl9pZCwgc3RyKGFtb3VudCksIFRydWUsCiAgICAgICAgICAgIG51bWJlcj1tb21vWydudW1iZXInXSwgbWFuYXA9bWFuYXAKICAgICAgICApCgogICAgICAgICMgPT09PT0gTuG7mWkgZHVuZyBn4butaSBuZ8aw4budaSBkw7luZyA9PT09PQogICAgICAgIGNhcHRpb24gPSBmIiIiQ2h1eeG7g24gdGnhu4FuIHbDoG8KPGI+4p6h77iPIE1PTU86IDxjb2RlPnttb21vWydudW1iZXInXX08L2NvZGU+CuKeoe+4jyBT4buRIHRp4buBbjoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9CuKeoe+4jyBO4buZaSBkdW5nOiA8Y29kZT57bWFuYXB9PC9jb2RlPjwvYj4KCjxpPkLhuqFuIGPhuqduIGPGsOG7o2MgMTAwJSBz4buRIHRp4buBbiBu4bqhcCBt4bubaSBjw7MgdGjhu4MgcsO6dDwvaT4KVGVsZWdyYW0gaOG7lyB0cuG7oyBodHRwczovL3QubWUvcm9vbXRpbmhsaW5oIiIiCgogICAgICAgICMgPT09PT0gVOG6oW8gUVIgTU9NTyA9PT09PQogICAgICAgIHFyX3VybCA9IGYiaHR0cHM6Ly9tb21vc3YzLmFwaW1pZW5waGkuY29tL2FwaS9RUkNvZGU/cGhvbmU9e21vbW9bJ251bWJlciddfSZhbW91bnQ9e2Ftb3VudH0mbm90ZT17bWFuYXB9IgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KHFyX3VybCwgdGltZW91dD0xMCkKICAgICAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCgogICAgICAgICAgICBpbWcgPSBJbWFnZS5vcGVuKEJ5dGVzSU8ocmVzcG9uc2UuY29udGVudCkpLmNvbnZlcnQoIlJHQiIpCiAgICAgICAgICAgIGltZ19ieXRlcyA9IEJ5dGVzSU8oKQogICAgICAgICAgICBpbWcuc2F2ZShpbWdfYnl0ZXMsIGZvcm1hdD0iUE5HIikKICAgICAgICAgICAgaW1nX2J5dGVzLnNlZWsoMCkKCiAgICAgICAgICAgIHNlbnRfcGhvdG8gPSBib3Quc2VuZF9waG90bygKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgcGhvdG89aW1nX2J5dGVzLAogICAgICAgICAgICAgICAgY2FwdGlvbj1jYXB0aW9uLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iSFRNTCIKICAgICAgICAgICAgKQogICAgICAgICAgICBsdXV2YXhvYXRuKHNlbnRfcGhvdG8pCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB04bqjaSDEkcaw4bujYyBRUiwgZMO5bmcgc2VuZF9tZXNzYWdlOiB7ZX0iKQogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgY2FwdGlvbiwgcGFyc2VfbW9kZT0iSFRNTCIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSAvbmFwbW9tbzoge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsibmFwYmFuayJdKQpkZWYgbmFwX2JhbmsobWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgeGVtIHTDoGkga2hv4bqjbi4iKQoKICAgICAgICAjID09PT09IENo4bq3biBzcGFtIC8gZm9yd2FyZCA9PT09PQogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIyA9PT09PSBM4bqleSBz4buRIHRp4buBbiA9PT09PQogICAgICAgIGFyZ3MgPSBtZXNzYWdlLnRleHQuc3BsaXQoKQogICAgICAgIGlmIGxlbihhcmdzKSA8IDIgb3Igbm90IGFyZ3NbMV0uaXNkaWdpdCgpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYW1vdW50ID0gaW50KGFyZ3NbMV0pICAjIENIVVnhu4JOIFNBTkcgSU5UCgogICAgICAgICMgPT09PT0gR0nhu5pJIEjhuqBOIE1JTiAmIE1BWCA9PT09PQogICAgICAgIE1JTl9OQVAgPSAxMDAwMAogICAgICAgIE1BWF9OQVAgPSAzMDAwMDAwMDAKCiAgICAgICAgaWYgYW1vdW50IDwgTUlOX05BUDoKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIG1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgICJU4buRaSB0aGnhu4N1IG7huqFwIDEwLjAwMCIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBhbW91bnQgPiBNQVhfTkFQOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgIlThu5FpIMSRYSBu4bqhcCAzMDAuMDAwLjAwMCIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjID09PT09IEzhuqV5IHRow7RuZyB0aW4gbmfDom4gaMOgbmcgPT09PT0KICAgICAgICB1c2VyX2lkID0gc3RyKG1lc3NhZ2UuZnJvbV91c2VyLmlkKQogICAgICAgIGZ1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCgogICAgICAgIGJhbmtfaW5mbyA9IHJlYWRfYmFua19pbmZvKCkKICAgICAgICBpZiBub3QgYmFua19pbmZvOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgbWFuYXAgPSByZWFkX21hbmFwX2Zvcl91c2VyKHVzZXJfaWQpCiAgICAgICAgaWYgbm90IG1hbmFwOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgY2FwdGlvbiA9IGYiIiJRdcOpdCBtw6MgdHLDqm4gaG/hurdjIENodXnhu4NuIHRp4buBbiB2w6BvCvCfj6YgTmfDom4gaMOgbmc6IHtiYW5rX2luZm9bJ25hbWUnXX0K8J+RpCBUw6puIGNo4bunIHTDoGkga2hv4bqjbjogPGNvZGU+e2JhbmtfaW5mb1snb3duZXInXX08L2NvZGU+CvCfkrMgU+G7kSBUw6BpIEtob+G6o246IDxjb2RlPntiYW5rX2luZm9bJ2FjY291bnQnXX08L2NvZGU+IPCfkYggTkjhuqRQIFbDgE8gU+G7kCBUSyDEkOG7giBDT1BZCjxiPuKeoe+4jyBT4buRIHRp4buBbjoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9CuKeoe+4jyBO4buZaSBkdW5nIGNodXnhu4NuIHRp4buBbiBsw6AKPGNvZGU+e21hbmFwfTwvY29kZT4g8J+RiCBDTElDSyDEkOG7giBDT1BZCk7huqBQIFThu5BJIFRISeG7glUgMTBLPC9iPgoKVlVJIEzDkk5HIE5I4bqsUCDEkMOaTkcgTuG7mEkgRFVORywgU+G7kCBUSeG7gE4gVOG7kEkgVEhJ4buCVSBMw4AgNksuIE7hur5VIEtIw5RORyBDw5MgTuG7mEkgRFVORyBIT+G6tkMgU0FJIE7hu5hJIERVTkcgU+G6vCBLSMOUTkcgxJDGr+G7okMgSE/DgE4gVFLhuqIKClRlbGVncmFtIGjhu5cgdHLhu6MgaHR0cHM6Ly90Lm1lL3Jvb210aW5obGluaCIiIgoKICAgICAgICBxcl91cmwgPSAoCiAgICAgICAgICAgIGYiaHR0cHM6Ly9pbWcudmlldHFyLmlvL2ltYWdlLyIKICAgICAgICAgICAgZiJ7YmFua19pbmZvWyduYW1lJ10ucmVwbGFjZSgnICcsICcnKX0te2JhbmtfaW5mb1snYWNjb3VudCddfS1uYXAucG5nIgogICAgICAgICAgICBmIj9hbW91bnQ9e2Ftb3VudH0mYWRkSW5mbz17bWFuYXB9IgogICAgICAgICkKCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChxcl91cmwsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQoKICAgICAgICAgICAgaW1nID0gSW1hZ2Uub3BlbihCeXRlc0lPKHJlc3BvbnNlLmNvbnRlbnQpKS5jb252ZXJ0KCJSR0IiKQogICAgICAgICAgICBpbWdfYnl0ZXMgPSBCeXRlc0lPKCkKICAgICAgICAgICAgaW1nLnNhdmUoaW1nX2J5dGVzLCBmb3JtYXQ9IlBORyIpCiAgICAgICAgICAgIGltZ19ieXRlcy5zZWVrKDApCgogICAgICAgICAgICBzZW50X3Bob3RvID0gYm90LnNlbmRfcGhvdG8oCiAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHBob3RvPWltZ19ieXRlcywKICAgICAgICAgICAgICAgIGNhcHRpb249Y2FwdGlvbiwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIGx1dXZheG9hdG4oc2VudF9waG90bykKCiAgICAgICAgICAgIG5vdGlmeV9hZG1pbl9uZXdfb3JkZXIoCiAgICAgICAgICAgICAgICBmdWxsbmFtZSwgdXNlcl9pZCwgc3RyKGFtb3VudCksIEZhbHNlLAogICAgICAgICAgICAgICAgbnVtYmVyPWJhbmtfaW5mb1snYWNjb3VudCddLAogICAgICAgICAgICAgICAgbWFuYXA9bWFuYXAsCiAgICAgICAgICAgICAgICBiYW5rX25hbWU9YmFua19pbmZvWyduYW1lJ10sCiAgICAgICAgICAgICAgICBvd25lcj1iYW5rX2luZm9bJ293bmVyJ10KICAgICAgICAgICAgKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB04bqjaSBRUiBCQU5LOiB7ZX0iKQogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgY2FwdGlvbiwgcGFyc2VfbW9kZT0iSFRNTCIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSAvbmFwYmFuazoge2V9IikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInJ0IikKZGVmIHJ0KGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSB5w6p1IGPhuqd1IHLDunQgdGnhu4FuLiIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlID0gIiIi8J+SuCA8Yj5Sw7p0IHh1IHRoZW8gY8O6IHBow6FwOjwvYj4KPGJsb2NrcXVvdGU+PGNvZGU+L21vbW8gW1Phu5EgbW9tb10rW1Phu5EgeHVdPC9jb2RlPjwvYmxvY2txdW90ZT4KVkQ6IC9tb21vIDA5MDkwOTA5OTkgNTAwMDAKUsO6dCB04buRaSB0aGnhu4N1IDUwLjAwMCB4dQoKPGJsb2NrcXVvdGU+PGNvZGU+L2JhbmsgW2JhbmsgbmFtZV0gW3Phu5EgdMOgaSBraG/huqNuXSBbc+G7kSB4dSBj4bqnbiByw7p0XTwvY29kZT48L2Jsb2NrcXVvdGU+ClZEOiAvYmFuayBNQiAwOTk5OTk5OTkgMTAwMDAwClLDunQgdOG7kWkgdGhp4buDdSAxMDAuMDAwIHh1Cgo8YmxvY2txdW90ZSBleHBhbmRhYmxlPkRhbmggc8OhY2ggQmFuayBOYW1lCklDQiAtPiBWaWV0aW5CYW5rClZDQiAtPiBWaWV0Y29tYmFuawpCSURWIC0+IEJJRFYKVkJBIC0+IEFncmliYW5rCk9DQiAtPiBPQ0IKTUIgLT4gTUJCYW5rClRDQiAtPiBUZWNoY29tYmFuawpBQ0IgLT4gQUNCClZQQiAtPiBWUEJhbmsKVFBCIC0+IFRQQmFuawpTVEIgLT4gU2Fjb21iYW5rCkhEQiAtPiBIREJhbmsKVkNDQiAtPiBWaWV0Q2FwaXRhbEJhbmsKQlZCYW5rIC0+IEJWQmFuawpTQ0IgLT4gU0NCClZJQiAtPiBWSUIKU0hCIC0+IFNIQgpFSUIgLT4gRXhpbWJhbmsKTVNCIC0+IE1TQgpDQUtFIC0+IENBS0UKVWJhbmsgLT4gVWJhbmsKVElNTyAtPiBUaW1vClNHSUNCIC0+IFNhaWdvbkJhbmsKQkFCIC0+IEJhY0FCYW5rClBWQ0IgLT4gUFZjb21CYW5rCk9jZWFuYmFuayAtPiBPY2VhbmJhbmsKTkNCIC0+IE5DQgpTSEJWTiAtPiBTaGluaGFuQmFuawpBQkIgLT4gQUJCQU5LClZBQiAtPiBWaWV0QUJhbmsKTkFCIC0+IE5hbUFCYW5rClBHQiAtPiBQR0JhbmsKVklFVEJBTksgLT4gVmlldEJhbmsKQlZCIC0+IEJhb1ZpZXRCYW5rClNFQUIgLT4gU2VBQmFuawpDT09QQkFOSyAtPiBDT09QQkFOSwpMUEIgLT4gTGllblZpZXRQb3N0QmFuawpLTEIgLT4gS2llbkxvbmdCYW5rClNDVk4gLT4gU3RhbmRhcmRDaGFydGVyZWQKUEJWTiAtPiBQdWJsaWNCYW5rCklWQiAtPiBJbmRvdmluYUJhbmsKSFNCQyAtPiBIU0JDCkRPQiAtPiBEb25nQUJhbmsKQ0lNQiAtPiBDSU1CCkNCQiAtPiBDQkJhbms8L2Jsb2NrcXVvdGU+IiIiCgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gxJBhbmcgZ+G7rWkgaMaw4bubbmcgZOG6q24gcsO6dCB0aeG7gW4uIikKICAgICAgICAgICAgc2VudF9tc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9bWVzc2FnZSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBUZWxlZ3JhbUVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ+G7rWkgdGluIG5o4bqvbiByw7p0IHRp4buBbjoge2V9IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRyb25nIGjDoG0gcnQ6IHtlfSIpCgpkZWYgZGluaGRhbmcoYW1vdW50KToKICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyDEkeG7i25oIGThuqFuZyBz4buRIHRp4buBbjoge2Ftb3VudH0iKQogICAgcmV0dXJuIGYie2ludChhbW91bnQpOix9Ii5yZXBsYWNlKCIsIiwgIi4iKQoKZGVmIGdldF9jdW9jX2Nhbl90aGlldSh1c2VyX2lkKToKICAgICIiIlRy4bqjIHbhu4Egc+G7kSB0aeG7gW4gdXNlciBjw7JuIGPhuqduIGPGsOG7o2MgxJHhu4MgxJHhu6cgxJFp4buBdSBraeG7h24gcsO6dCIiIgogICAgcGF0aCA9ICJGSUxFL2N1b2N0aWVuLnR4dCIKICAgIGlmIG9zLnBhdGguZXhpc3RzKHBhdGgpOgogICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMAogICAgcmV0dXJuIDAKCiIiIgogICAgaGFzX3ZhbGlkX3RvcHVwID0gRmFsc2UKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbHNuYXAudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAtICIpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDQgYW5kIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGludChwYXJ0c1szXSkgPj0gNTAwMDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNfdmFsaWRfdG9wdXAgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgxJHhu41jIEZJTEUvbHNuYXAudHh0OiB7ZX0iKQoKICAgIGlmIG5vdCBoYXNfdmFsaWRfdG9wdXA6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iQ+G6p24gMSBs4buHbmggbuG6oXAgw610IG5o4bqldCA1MC4wMDAgxJHhu4MgcsO6dCIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBjaMawYSBjw7MgbOG7h25oIG7huqFwIGjhu6NwIGzhu4cuIikKICAgICAgICByZXR1cm4KICAgICAgICAiIiIKCmRlZiBjYXBuaGF0X3NvZHUodXNlcl9pZCwgYW1vdW50LCB0cnU9VHJ1ZSk6CiAgICBwYXRoID0gIkZJTEUvc2QudHh0IgogICAgbGluZXMgPSBbXQogICAgZm91bmQgPSBGYWxzZQogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQoKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIHVpZCwgYmFsID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGludCh1aWQpID09IGludCh1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBiYWwgPSBpbnQoYmFsKQogICAgICAgICAgICAgICAgICAgIGlmIHRydToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYmFsID49IGFtb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbCAtPSBhbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7dWlkfSB7YmFsfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgxJHhu6cgc+G7kSBkxrAgxJHhu4MgdHLhu6s6IHtiYWx9IDwge2Ftb3VudH0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmInt1aWR9IHtiYWx9XG4iKSAgIyBob+G6t2MgYuG7jyBxdWEgZ2hpLCB0deG7syBi4bqhbgogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhbCArPSBhbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShmInt1aWR9IHtiYWx9XG4iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGxpbmUpCgogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIG5ld19iYWwgPSAwIGlmIHRydSBlbHNlIGFtb3VudAogICAgICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7bmV3X2JhbH1cbiIpCgogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGPhuq1wIG5o4bqtdCBz4buRIGTGsDoge2V9IikKICAgICAgICByZXR1cm4gRmFsc2UKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnbW9tbyddKQpkZWYgcnV0bW9tbyhtZXNzYWdlOiBNZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgbWVzc2FnZV90ZXh0ID0gbWVzc2FnZS50ZXh0CiAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgZ+G7rWkgbOG7h25oIHLDunQgTU9NTzoge21lc3NhZ2VfdGV4dH0iKQoKICAgICMgPT09PT09IEtJ4buCTSBUUkEgVOG7lE5HIE7huqBQIFThu6ogRklMRS9sc25hcC50eHQgPT09PT09CiAgICB0b3RhbF9uYXAgPSAwCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzbmFwLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoIiAtICIpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpIDwgNDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdWlkLCBfLCBuYXBfdHlwZSwgYW1vdW50X3N0ciA9IHBhcnRzCiAgICAgICAgICAgICAgICBpZiBzdHIodXNlcl9pZCkgIT0gdWlkOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gaW50KGFtb3VudF9zdHIpCiAgICAgICAgICAgICAgICAgICAgdG90YWxfbmFwICs9IGFtb3VudAogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludCgiW0RFQlVHXSBGSUxFL2xzbmFwLnR4dCBraMO0bmcgdOG7k24gdOG6oWkuIikKCiAgICAiIiIKICAgIGlmIHRvdGFsX25hcCA8IDUwMDAwOgogICAgICAgIGlmIHRvdGFsX25hcCA9PSAwOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9IkLhuqFuIGPhuqduIG7huqFwIDUwLjAwMCB2w6AgeDF2YyDEkeG7gyB0aOG7sWMgaGnhu4duIHLDunQuIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBjYW5fbmFwX3RoZW0gPSA1MDAwMCAtIHRvdGFsX25hcAogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9ZiJC4bqhbiBj4bqnbiBu4bqhcCB0aMOqbSB7ZGluaGRhbmcoc3RyKGNhbl9uYXBfdGhlbSkpfSB2w6AgeDF2YyDEkeG7gyB0aOG7sWMgaGnhu4duIGzhu4duaCByw7p0LiIpCiAgICAgICAgcmV0dXJuICAgICAgICAKICAgICAgICAiIiIKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcHJpbnQoIltERUJVR10gVGluIG5o4bqvbiDEkcaw4bujYyBjaHV54buDbiB0aeG6v3AsIGLhu48gcXVhLiIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0uIikKICAgICAgICByZXR1cm4KICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIHBow6F0IGhp4buHbiBzcGFtLiIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGtow7RuZyB0aOG7gyBn4butaSB0aW4gbmjhuq9uLiIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICBwcmludCgiW0RFQlVHXSBUaW4gbmjhuq9uIHF1w6EgY8WpLCBi4buPIHF1YS4iKQogICAgICAgIHJldHVybgoKICAgIHBhdHRlcm4gPSByIl4vbW9tb1xzKygwXGR7OX0pXHMrKFxkKykkIgogICAgbWF0Y2ggPSByZS5tYXRjaChwYXR0ZXJuLCBtZXNzYWdlX3RleHQpCiAgICBpZiBub3QgbWF0Y2g6CiAgICAgICAgcHJpbnQoIltERUJVR10gVGluIG5o4bqvbiBraMO0bmcga2jhu5twIHbhu5tpIGPDuiBwaMOhcC4iKQogICAgICAgIHJldHVybgoKICAgIG1vbW9fbnVtYmVyLCBhbW91bnRfc3RyID0gbWF0Y2guZ3JvdXBzKCkKICAgIHRyeToKICAgICAgICBhbW91bnQgPSBpbnQoYW1vdW50X3N0cikKICAgICAgICBpZiBhbW91bnQgPCA1MDAwMDoKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gU+G7kSB0aeG7gW4gcsO6dCB04buRaSB0aGnhu4N1IGzDoCA1MC4wMDAuIikKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iVOG7kWkgdGhp4buDdSA1MC4wMDAiKQogICAgICAgICAgICByZXR1cm4KICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBjaHV54buDbiDEkeG7lWkgc+G7kSB0aeG7gW46IHthbW91bnRfc3RyfSIpCiAgICAgICAgcmV0dXJuCgogICAgY3VvY19jb25fdGhpZXUgPSBnZXRfY3VvY19jYW5fdGhpZXUodXNlcl9pZCkKICAgIGlmIGN1b2NfY29uX3RoaWV1ID4gMDoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD1mIkLhuqFuIGPhuqduIGPGsOG7o2MgdGjDqm0ge2RpbmhkYW5nKHN0cihjdW9jX2Nvbl90aGlldSkpfSDEkeG7gyByw7p0IikKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGPDsm4gY+G6p24gY8aw4bujYzoge2N1b2NfY29uX3RoaWV1fSIpCiAgICAgICAgcmV0dXJuCgogICAgYmFsYW5jZSA9IGdldF92aWNoaW5oKHVzZXJfaWQpCiAgICBpZiBiYWxhbmNlIDwgYW1vdW50OgogICAgICAgIHByaW50KCJbREVCVUddIFPhu5EgZMawIGtow7RuZyDEkeG7py4iKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IlPhu5EgZMawIGtow7RuZyDEkeG7pyIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgaXNfbmV3X3VzZXIodXNlcl9pZCk6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iVMOibiB0aOG7pyBraMO0bmcgdGjhu4MgcsO6dCIsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZGJ1dHRvbigpLAogICAgICAgICAgICBwYXJzZV9tb2RlPSdIVE1MJykKICAgICAgICByZXR1cm4KICAgIGlmIG5vdCBjYXBuaGF0X3NvZHUodXNlcl9pZCwgYW1vdW50LCB0cnU9VHJ1ZSk6CiAgICAgICAgcmV0dXJuCgogICAgZm9ybWF0dGVkX2Ftb3VudCA9IGRpbmhkYW5nKHN0cihhbW91bnQpKQoKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbW9tby50eHQiLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGZpbGU6CiAgICAgICAgICAgIGZpbGUud3JpdGUoZiJ7dXNlcl9pZH0ge21vbW9fbnVtYmVyfVxuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ2hpIG1vbW8gdsOgbyBtb21vLnR4dDoge3VzZXJfaWR9IHttb21vX251bWJlcn0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBnaGkgbW9tby50eHQ6IHtlfSIpCiAgICAgICAgcmV0dXJuCgogICAgcmFuZG9tX2NvZGUgPSByYW5kb20ucmFuZGludCgxMDAwMDAsIDk5OTk5OSkKICAgIGZ1bGxfbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZQogICAgdmlldF9uYW1fdHogPSBweXR6LnRpbWV6b25lKCdBc2lhL0hvX0NoaV9NaW5oJykKICAgIGN1cnJlbnRfdGltZSA9IGRhdGV0aW1lLm5vdyh2aWV0X25hbV90eikKICAgIGN1cnJlbnRfdGltZV9zdHIgPSBjdXJyZW50X3RpbWUuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKCiAgICB0cnk6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9ZiIiIsSQYW5nIHjhu60gbMO9IGzhu4duaCByw7p0IHRp4buBbiAje3JhbmRvbV9jb2RlfQpUw6BpIGtob+G6o24gY+G7p2EgYuG6oW4gc+G6vSBi4buLIHThuqFtIGtow7NhIGNobyDEkeG6v24ga2hpIGzhu4duaCByw7p0IHjhu60gbMO9IHhvbmcsIHZ1aSBsw7JuZyBraMO0bmcgdGhhbyB0w6FjIHRyw6FuaCBt4bqldCB0w6BpIGtob+G6o24iIiIsCiAgICAgICAgICAgIHBhcnNlX21vZGU9J0hUTUwnLCByZXBseV90b19tZXNzYWdlX2lkPW1lc3NhZ2UubWVzc2FnZV9pZAogICAgICAgICkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gcsO6dCB0aeG7gW4gduG7m2kgbcOjICN7cmFuZG9tX2NvZGV9IikKCiAgICAgICAgdGhvbmdiYW9ydXQodXNlcl9pZCwgZnVsbF9uYW1lLCBtb21vX251bWJlciwgYW1vdW50LCByYW5kb21fY29kZSwgZGluaGRhbmcoc3RyKGJhbGFuY2UpKSkKCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfSAtIHtjdXJyZW50X3RpbWVfc3RyfSAtIE1PTU8gLSB7YW1vdW50fSAtIENoxrBhIGR1eeG7h3QgLSB7cmFuZG9tX2NvZGV9XG4iKQogICAgICAgICAgICBwcmludChmIltERUJVR10gR2hpIHbDoG8gRklMRS9sc3J1dC50eHQiKQoKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZmlsZS53cml0ZShmInt1c2VyX2lkfVxuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIGLhu4sgdOG6oW0ga2jDs2EuIikKICAgIGV4Y2VwdCBUZWxlZ3JhbUVycm9yIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvOiB7ZX0iKQoKZGVmIHRob25nYmFvcnV0KHVzZXJfaWQsIGZ1bGxfbmFtZSwgbW9tb19udW1iZXIsIGFtb3VudCwgY29kZSwgZm9ybWF0dGVkX2JhbGFuY2UpOgogICAgaW1wb3J0IHJlcXVlc3RzCiAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQogICAgaW1wb3J0IHB5dHoKICAgIGZyb20gaW8gaW1wb3J0IEJ5dGVzSU8KCiAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5ub3cocHl0ei50aW1lem9uZSgnQXNpYS9Ib19DaGlfTWluaCcpKS5zdHJmdGltZSgiJUg6JU06JVMgJWQvJW0vJVkiKQogICAgZm9ybWF0dGVkX2Ftb3VudCA9IGRpbmhkYW5nKHN0cihhbW91bnQpKQoKICAgIG1lc3NhZ2UgPSBmIiIiCipUSMOUTkcgQsOBTyBSw5pUIFRJ4buATioKCvCfkaQgTmfGsOG7nWkgZMO5bmc6IFt7ZnVsbF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyX2lkfSkK8J+GlCBJRDogYHt1c2VyX2lkfWAK8J+TsSBNT01POiBge21vbW9fbnVtYmVyfWAK8J+SuCBT4buRIHRp4buBbjogKntmb3JtYXR0ZWRfYW1vdW50fSoK8J+SsCBT4buRIGTGsDogYHtmb3JtYXR0ZWRfYmFsYW5jZX1gCvCflJAgTcOjIHLDunQgdGnhu4FuOiBge2NvZGV9YArinIUgRHV54buHdCByw7p0OiBgL2R1eWV0bW9tbyB7Y29kZX1gCuKdjCBM4buXaSByw7p0OiBgL2xvaW1vbW8ge2NvZGV9YArwn5WSIFRo4budaSBnaWFuOiB7Y3VycmVudF90aW1lfQrwn5GuIEFETUlOOiBAa2FpYWFhMTgKIiIiCiAgICB0cnk6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEfhu61pIHRow7RuZyBiw6FvIHLDunQgY2hvIHt1c2VyX2lkfSAoe2Z1bGxfbmFtZX0pIikKCiAgICAgICAgIyBU4bqhbyBVUkwgUVIKICAgICAgICBxcl91cmwgPSBmImh0dHBzOi8vbW9tb3N2My5hcGltaWVucGhpLmNvbS9hcGkvUVJDb2RlP3Bob25lPXttb21vX251bWJlcn0mYW1vdW50PXthbW91bnR9Jm5vdGU9VElOSExJTkggdGhhbmggdG9hbiIKCiAgICAgICAgIyBU4bqjaSDhuqNuaCBRUgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KHFyX3VybCwgdGltZW91dD0xMCkKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIHFyX2ltZyA9IEJ5dGVzSU8ocmVzcG9uc2UuY29udGVudCkKICAgICAgICAgICAgcXJfaW1nLm5hbWUgPSAicXIuanBnIgoKICAgICAgICAgICAgIyBH4butaSDhuqNuaCBrw6htIGNhcHRpb24KICAgICAgICAgICAgYm90MS5zZW5kX3Bob3RvKAogICAgICAgICAgICAgICAgY2hhdF9pZD0iLTEwMDMyNDEwMDI0NzgiLAogICAgICAgICAgICAgICAgcGhvdG89cXJfaW1nLAogICAgICAgICAgICAgICAgY2FwdGlvbj1tZXNzYWdlLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuTUFSS0RPV04KICAgICAgICAgICAgKQogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSDhuqNuaCBRUiBrw6htIGNhcHRpb24gdGjDoG5oIGPDtG5nIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgdOG6o2kgxJHGsOG7o2Mg4bqjbmggUVIsIGNo4buJIGfhu61pIGNhcHRpb24iKQogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPSItMTAwMzI0MTAwMjQ3OCIsIHRleHQ9bWVzc2FnZSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuTUFSS0RPV04pCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSDhuqNuaCBRUiwgY2jhu4kgZ+G7rWkgY2FwdGlvbjoge2V9IikKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPSItMTAwMzI0MTAwMjQ3OCIsIHRleHQ9bWVzc2FnZSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuTUFSS0RPV04pCgpAYm90MS5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WydkdXlldG1vbW8nXSkKZGVmIGR1eWV0bW9tbyhtZXNzYWdlOiBNZXNzYWdlKToKICAgICIiIgogICAgRHV54buHdCDEkcahbiByw7p0IE1PTU8vQkFOSyB0aGVvIG3DozogL2R1eWV0bW9tbyA8TcODPgogICAgU+G7rWEgY8OhYyBs4buXaToKICAgIC0gU28gc8OhbmggQURNSU4gxJHDum5nICho4buXIHRy4bujIEFETUlOIGzDoCBzdHJpbmcgaG/hurdjIGxpc3QpCiAgICAtIEfhu61pIHRpbiBuaOG6r24gYuG6sW5nIGJvdDEgKGJvdCBuaOG6rW4gbOG7h25oKQogICAgLSBC4bqvdCBs4buXaSBraGkgZ+G7rWkgdGluIGNobyB1c2VyIChjaGF0IG5vdCBmb3VuZCkKICAgIC0gQ+G6rXAgbmjhuq10IGZpbGUgbHNydXQudHh0IGFuIHRvw6BuCiAgICAiIiIKICAgIGFkbWluX3VzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAoKICAgICMgLS0tIEtp4buDbSB0cmEgcXV54buBbiBBRE1JTiAoaOG7lyB0cuG7oyBBRE1JTiBjw7MgdGjhu4MgbMOgIGxpc3QvdHVwbGUvc2V0IGhv4bq3YyAxIGdpw6EgdHLhu4spIC0tLQogICAgdHJ5OgogICAgICAgICMgY2h14bqpbiBow7NhIGThuqFuZyBjaHXhu5dpIMSR4buDIHNvIHPDoW5oIGFuIHRvw6BuCiAgICAgICAgaWYgaXNpbnN0YW5jZShBRE1JTiwgKGxpc3QsIHR1cGxlLCBzZXQpKToKICAgICAgICAgICAgYWRtaW5fc2V0ID0gc2V0KG1hcChzdHIsIEFETUlOKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhZG1pbl9zZXQgPSB7c3RyKEFETUlOKX0KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgYWRtaW5fc2V0ID0ge3N0cihBRE1JTil9CgogICAgaWYgc3RyKGFkbWluX3VzZXJfaWQpIG5vdCBpbiBhZG1pbl9zZXQ6CiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICBwYXJ0c190ZXh0ID0gbWVzc2FnZS50ZXh0LnNwbGl0KCkKICAgIHJhbmRvbV9jb2RlID0gcGFydHNfdGV4dFsxXSBpZiBsZW4ocGFydHNfdGV4dCkgPiAxIGVsc2UgTm9uZQogICAgaWYgbm90IHJhbmRvbV9jb2RlOgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PSJUaGnhur91IG3DoyByw7p0IHRp4buBbi4gQ8O6IHBow6FwOiAvZHV5ZXRtb21vIDxNw4M+IikKICAgICAgICByZXR1cm4gTm9uZQoKICAgIHRyeToKICAgICAgICBwcmludChmIltERUJVR10gQuG6r3QgxJHhuqd1IHjhu60gbMO9IGR1eeG7h3QgcsO6dCB0aeG7gW4gduG7m2kgbcOjOiB7cmFuZG9tX2NvZGV9IikKCiAgICAgICAgIyDEkeG7jWMgZmlsZSBhbiB0b8OgbgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRS9sc3J1dC50eHQiKToKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IkZpbGUgbHNydXQudHh0IGtow7RuZyB04buTbiB04bqhaS4iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbHNydXQudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBsc3J1dF9saW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgdXBkYXRlZF9sc3J1dF9saW5lcyA9IFtdCiAgICAgICAgZm91bmQgPSBGYWxzZQogICAgICAgIHVzZXJfaWQgPSBOb25lCiAgICAgICAgYW1vdW50ID0gMAoKICAgICAgICBmb3IgbGluZSBpbiBsc3J1dF9saW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAtICIpCiAgICAgICAgICAgICMgxJHhuqNtIGLhuqNvIGPhuqV1IHRyw7pjIMOtdCBuaOG6pXQgNiBwaOG6p24gdsOgIHBo4bqnbiBjdeG7kWkga2jhu5twIG3DowogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDYgYW5kIHBhcnRzWy0xXS5zdHJpcCgpID09IHJhbmRvbV9jb2RlOgogICAgICAgICAgICAgICAgIyBs4bqleSB1c2VyX2lkIHbDoCBhbW91bnQgY+G6qW4gdGjhuq1uCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IGludChwYXJ0c1swXS5zdHJpcCgpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAjIG7hur91IGlkIGtow7RuZyBo4bujcCBs4buHLCBnaeG7ryBuZ3V5w6puIGTDsm5nIHbDoCB0aeG6v3AgdOG7pWMKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGludChwYXJ0c1szXS5zdHJpcCgpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSAwCgogICAgICAgICAgICAgICAgIyBu4bq/dSDEkcOjIGR1eeG7h3QgdHLGsOG7m2MgxJHDswogICAgICAgICAgICAgICAgaWYgIlRow6BuaCBjw7RuZyIgaW4gbGluZToKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDGoW4gbsOgeSDEkcOjIMSRxrDhu6NjIGR1eeG7h3QgdHLGsOG7m2MgxJHDszoge2xpbmUuc3RyaXAoKX0iKQogICAgICAgICAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PSLEkMahbiBuw6B5IMSRw6MgxJHGsOG7o2MgZHV54buHdCB0csaw4bubYyDEkcOzLiIpCiAgICAgICAgICAgICAgICAgICAgIyB24bqrbiB0aMOqbSBkw7JuZyBuZ3V5w6puIGfhu5FjCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9sc3J1dF9saW5lcy5hcHBlbmQobGluZSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgICAgICMgbuG6v3UgxJFhbmcgbMOgIENoxrBhIGR1eeG7h3QgLT4gY+G6rXAgbmjhuq10IHRow6BuaCBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIGlmICJDaMawYSBkdXnhu4d0IiBpbiBsaW5lIG9yICJDaMawYSBkdXnhu4d0IiBpbiBwYXJ0czoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWVfc3RyID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICAgICAgICAgICAgICBuZXdfbGluZSA9IGYie3BhcnRzWzBdLnN0cmlwKCl9IC0ge2N1cnJlbnRfdGltZV9zdHJ9IC0gTU9NTyAtIHtwYXJ0c1szXS5zdHJpcCgpfSAtIFRow6BuaCBjw7RuZyAtIHtyYW5kb21fY29kZX1cbiIKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzLmFwcGVuZChuZXdfbGluZSkKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDGoW4gcsO6dCB0aeG7gW4gxJHDoyDEkcaw4bujYyBkdXnhu4d0OiB7cGFydHNbMF0uc3RyaXAoKX0gLSB7YW1vdW50fSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgY8OhYyB0cuG6oW5nIHRow6FpIGtow6FjLCBnaeG7ryBuZ3V5w6puCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9sc3J1dF9saW5lcy5hcHBlbmQobGluZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHVwZGF0ZWRfbHNydXRfbGluZXMuYXBwZW5kKGxpbmUpCgogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBtw6MgcsO6dCB0aeG7gW46IHtyYW5kb21fY29kZX0iKQogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iS2jDtG5nIHThu5NuIHThuqFpIG3DoyByw7p0IHRp4buBbiBuw6B5LiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICMgZ2hpIGzhuqFpIGZpbGUgduG7m2kgZW5jb2RpbmcgdXRmLTgKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbHNydXQudHh0IiwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBmaWxlLndyaXRlbGluZXModXBkYXRlZF9sc3J1dF9saW5lcykKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbOG7h25oIHLDunQgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSwgc+G7kSB0aeG7gW46IHthbW91bnR9IikKCiAgICAgICAgIyBM4bqleSBz4buRIGTGsCBoaeG7h24gdOG6oWkgKGtow7RuZyB04buxIMSR4buZbmcgdHLhu6svbmjhuq1uIGJp4bq/dCBk4buxYSB2w6BvIGxvZ2ljIGjhu4cgdGjhu5FuZykKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdmljaGluaCA9IGdldF92aWNoaW5oKHVzZXJfaWQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgY3VycmVudF92aWNoaW5oID0gMAoKICAgICAgICBmb3JtYXR0ZWRfYmFsYW5jZSA9IGZvcm1hdF9iYWxhbmNlKGN1cnJlbnRfdmljaGluaCkKICAgICAgICBmb3JtYXR0ZWRfYW1vdW50ID0gZm9ybWF0X2JhbGFuY2UoYW1vdW50KQoKICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIHThu5tpIHVzZXIg4oCUIGLhuq90IGzhu5dpIG7hur91IGtow7RuZyB0aOG7gyBn4butaSAodXNlciBjaMawYSAvc3RhcnQgaG/hurdjIGNo4bq3biBib3QpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD11c2VyX2lkLAogICAgICAgICAgICAgICAgdGV4dD0oCiAgICAgICAgICAgICAgICAgICAgZiJJRDogYHt1c2VyX2lkfWBcbiIKICAgICAgICAgICAgICAgICAgICBmIi0gUsO6dCB0aMOgbmggY8O0bmcge2Zvcm1hdHRlZF9hbW91bnR9IHh1XG4iCiAgICAgICAgICAgICAgICAgICAgZiItIFBow60gcsO6dCB0aeG7gW46IDBcbiIKICAgICAgICAgICAgICAgICAgICBmIi0gU+G7kSBkxrAgaGnhu4duIHThuqFpOiB7Zm9ybWF0dGVkX2JhbGFuY2V9IgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9Ik1hcmtkb3duIgogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAjIGdoaSBsb2cgbmjGsG5nIGtow7RuZyByYWlzZSDEkeG7gyBhZG1pbiB24bqrbiBjb2kgbMOgIMSRw6MgZHV54buHdAogICAgICAgICAgICBwcmludChmIltXQVJOXSBLaMO0bmcgZ+G7rWkgxJHGsOG7o2MgdGluIHThu5tpIHVzZXIge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgICAgICAjIGfhu61pIGPhuqNuaCBiw6FvIGNobyBhZG1pbiB0aGF5IHRo4bq/CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PWYixJDDoyBkdXnhu4d0IG5oxrBuZyBraMO0bmcgZ+G7rWkgxJHGsOG7o2MgdGluIGNobyB1c2VyIHt1c2VyX2lkfToge2V9IikKCiAgICAgICAgIyBO4bq/dSBjw7MgZmlsZSBiYW4udHh0LCB4w7NhIHVzZXIga2jhu49pIGRhbmggc8OhY2ggYmFuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygiRklMRS9iYW4udHh0Iik6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgICAgICAgICBiYW5fbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBiYW5fbGluZXM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0cih1c2VyX2lkKSBub3QgaW4gbGluZS5zdHJpcCgpLnNwbGl0KCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlLndyaXRlKGxpbmUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGPhuq1wIG5o4bqtdCBiYW4udHh0OiB7ZX0iKQoKICAgICAgICAjIEfhu61pIHjDoWMgbmjhuq1uIGNobyBhZG1pbgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IsSQw6MgZHV54buHdCByw7p0IHRp4buBbiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiB4w6FjIG5o4bqtbiBjaG8gYWRtaW46IHtlfSIpCgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGR1eeG7h3QgcsO6dCB0aeG7gW4gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSIpCgogICAgICAgICMgR+G7jWkgaMOgbSB44butIGzDvSBo4bqtdSBj4bqnbiAoZ2hpIGxvZywgY2h1eeG7g24gdGnhu4FuLCB2di4pIG7hur91IGPDswogICAgICAgIHRyeToKICAgICAgICAgICAgdGJyKHVzZXJfaWQsIGFtb3VudCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ+G7jWkgdGJyKCk6IHtlfSIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZHV54buHdCByw7p0IHRp4buBbjoge2V9IikKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PWYiTOG7l2kga2hpIGR1eeG7h3QgcsO6dCB0aeG7gW46IHtlfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKCmltcG9ydCByZXF1ZXN0cwpmcm9tIHRlbGVncmFtLmNvbnN0YW50cyBpbXBvcnQgUGFyc2VNb2RlCgoKZGVmIHRicih1c2VyX2lkOiBpbnQsIGFtb3VudDogaW50KToKICAgIGZvcm1hdHRlZF9hbW91bnQgPSBmb3JtYXRfYmFsYW5jZShhbW91bnQpCgogICAgZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkKQogICAgaGlkZGVuX3VzZXJfaWQgPSB1c2VyX2lkX3N0cls6Nl0gKyAiKioqKiIKCiAgICBncm91cF9tZXNzYWdlID0gKAogICAgICAgIGYiPGI+TmfGsOG7nWkgY2jGoWkgSUQ6IHtoaWRkZW5fdXNlcl9pZH08L2I+XG5cbiIKICAgICAgICBmIjxiPi0gUsO6dCBNT01PIHRow6BuaCBjw7RuZyB7Zm9ybWF0dGVkX2Ftb3VudH0geHU8L2I+IgogICAgKQoKICAgIG90aGVyX2JvdF90b2tlbiA9ICI4NDkzNzAzMjk3OkFBSFNmOHdUeGlwbjdURVRQMUI5WVNXcWFSNjBHbEpzVkhjIgogICAgdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e290aGVyX2JvdF90b2tlbn0vc2VuZE1lc3NhZ2UiCgogICAgcGF5bG9hZCA9IHsKICAgICAgICAiY2hhdF9pZCI6IGdyb3VwX2NoYXRfaWQsCiAgICAgICAgInRleHQiOiBncm91cF9tZXNzYWdlLAogICAgICAgICJwYXJzZV9tb2RlIjogIkhUTUwiCiAgICB9CgogICAgdHJ5OgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCh1cmwsIGpzb249cGF5bG9hZCwgdGltZW91dD0xMCkKICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIHLDunQgTU9NTyB2w6BvIG5ow7NtLiIpCiAgICBleGNlcHQgcmVxdWVzdHMuUmVxdWVzdEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBn4butaSB0aMO0bmcgYsOhbyB2w6BvIG5ow7NtOiB7ZX0iKQoKQGJvdDEubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnbG9pbW9tbyddKQpkZWYgbG9pbW9tbyhtZXNzYWdlOiBNZXNzYWdlKToKICAgIGFkbWluX3VzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAoKICAgICMgLS0tIGNodeG6qW4gaMOzYSBBRE1JTiAoaOG7lyB0cuG7oyBBRE1JTiBsw6AgbGlzdC90dXBsZS9zZXQgaG/hurdjIDEgZ2nDoSB0cuG7iykgLS0tCiAgICB0cnk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShBRE1JTiwgKGxpc3QsIHR1cGxlLCBzZXQpKToKICAgICAgICAgICAgYWRtaW5fc2V0ID0gc2V0KG1hcChzdHIsIEFETUlOKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhZG1pbl9zZXQgPSB7c3RyKEFETUlOKX0KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgYWRtaW5fc2V0ID0ge3N0cihBRE1JTil9CgogICAgaWYgc3RyKGFkbWluX3VzZXJfaWQpIG5vdCBpbiBhZG1pbl9zZXQ6CiAgICAgICAgcmV0dXJuCgogICAgcGF0dGVybiA9IHIiXi9sb2ltb21vXHMrKFxkezZ9KSQiCiAgICBtYXRjaCA9IHJlLm1hdGNoKHBhdHRlcm4sIChtZXNzYWdlLnRleHQgb3IgIiIpLnN0cmlwKCkpCiAgICBpZiBub3QgbWF0Y2g6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IkPDuiBwaMOhcDogL2xvaW1vbW8gPE3DgyA2IHPhu5E+IikKICAgICAgICByZXR1cm4KCiAgICByYW5kb21fY29kZSA9IG1hdGNoLmdyb3VwKDEpCiAgICB1cGRhdGVkX2xpbmVzID0gW10KICAgIGZvdW5kX2NvZGUgPSBGYWxzZQogICAgdXNlcl90b19ub3RpZnkgPSBOb25lCiAgICBhbW91bnRfdG9fcmVmdW5kID0gMAoKICAgIHRyeToKICAgICAgICBwcmludChmIltERUJVR10gQuG6r3QgxJHhuqd1IHjhu60gbMO9IHnDqnUgY+G6p3UgaOG7p3kgbOG7h25oIHLDunQgTU9NTyB24bubaSBtw6M6IHtyYW5kb21fY29kZX0iKQogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRS9sc3J1dC50eHQiKToKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9Iktow7RuZyB0w6xtIHRo4bqleSBk4buvIGxp4buHdSByw7p0IHRp4buBbiAoRklMRS9sc3J1dC50eHQpLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIMSR4buNYyBmaWxlIGFuIHRvw6BuICh0aGF5IG51bGwgYnl0ZSBu4bq/dSBjw7MpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJyZXBsYWNlIikgYXMgZmlsZToKICAgICAgICAgICAgbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCgogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAjIGxv4bqhaSBi4buPIGPDoWMgYnl0ZSBudWxsIGhv4bq3YyBrw70gdOG7sSBs4bqhIHRoxrDhu51uZyBn4bq3cAogICAgICAgICAgICBjbGVhbmVkID0gbGluZS5yZXBsYWNlKCJceDAwIiwgIiIpLnJzdHJpcCgiXG4iKQogICAgICAgICAgICBwYXJ0cyA9IGNsZWFuZWQuc3BsaXQoIiAtICIpCgogICAgICAgICAgICAjIGFuIHRvw6BuOiBu4bq/dSBwaOG6p24gY3Xhu5FpIGPDsyBrw70gdOG7sSByw6FjLCBzdHJpcCgpCiAgICAgICAgICAgIGxhc3RfcGFydCA9IHBhcnRzWy0xXS5zdHJpcCgpIGlmIHBhcnRzIGVsc2UgIiIKCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPiA1IGFuZCBsYXN0X3BhcnQgPT0gcmFuZG9tX2NvZGU6CiAgICAgICAgICAgICAgICAjIHBhcnRzWzRdIGzDoCB0cuG6oW5nIHRow6FpLCBwYXJ0c1swXSB1c2VyX2lkLCBwYXJ0c1szXSBhbW91bnQKICAgICAgICAgICAgICAgIHN0YXR1c19maWVsZCA9IHBhcnRzWzRdLnN0cmlwKCkgaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgICAgICAgICAgICAgIyBs4bqleSB1c2VyX2lkIGFuIHRvw6BuCiAgICAgICAgICAgICAgICB1c2VyX2lkX3JhdyA9IHBhcnRzWzBdLnN0cmlwKCkgaWYgcGFydHMgZWxzZSAiIgogICAgICAgICAgICAgICAgbV91aWQgPSByZS5zZWFyY2gociJcZCsiLCB1c2VyX2lkX3JhdykKICAgICAgICAgICAgICAgIGlmIG5vdCBtX3VpZDoKICAgICAgICAgICAgICAgICAgICAjIGtow7RuZyBs4bqleSDEkcaw4bujYyBpZCwgZ2hpIGxvZyB2w6AgZ2nhu68gbmd1ecOqbiBkw7JuZwogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW1dBUk5dIETDsm5nIGPDsyBtw6MgbmjGsG5nIHVzZXIgaWQga2jDtG5nIHjDoWMgxJHhu4tuaCwgYuG7jyBxdWE6IHtjbGVhbmVkfSIpCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQobGluZSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB1c2VyX3RvX25vdGlmeSA9IGludChtX3VpZC5ncm91cCgpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwcmludChmIltXQVJOXSBLaMO0bmcgdGjhu4MgcGFyc2UgdXNlcl9pZCB04burICd7bV91aWQuZ3JvdXAoKX0nIikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgIyBs4bqleSBhbW91bnQgYW4gdG/DoG4KICAgICAgICAgICAgICAgIGFtb3VudF9yYXcgPSBwYXJ0c1szXS5zdHJpcCgpIGlmIGxlbihwYXJ0cykgPiAzIGVsc2UgIjAiCiAgICAgICAgICAgICAgICBtX2FtdCA9IHJlLnNlYXJjaChyIi0/XGQrIiwgYW1vdW50X3Jhdy5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYW1vdW50X3RvX3JlZnVuZCA9IGludChtX2FtdC5ncm91cCgpKSBpZiBtX2FtdCBlbHNlIGludChyZS5zdWIociJcRCIsICIiLCBhbW91bnRfcmF3KSBvciAwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBhbW91bnRfdG9fcmVmdW5kID0gMAoKICAgICAgICAgICAgICAgICMgeOG7rSBsw70gdGhlbyB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgICAgICBsb3dfc3RhdHVzID0gc3RhdHVzX2ZpZWxkLmxvd2VyKCkKICAgICAgICAgICAgICAgIGlmICJ0aMOgbmggY8O0bmciIGluIGxvd19zdGF0dXMgb3IgInRoYW5oIGNvbmciIGluIGxvd19zdGF0dXM6CiAgICAgICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IsSQxqFuIG7DoHkgxJHDoyDEkcaw4bujYyBkdXnhu4d0IHRyxrDhu5tjIMSRw7MuIikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMahbiDEkcOjIGR1eeG7h3QgdHLGsOG7m2MgxJHDszoge2NsZWFuZWR9IikKICAgICAgICAgICAgICAgIGVsaWYgImNoxrBhIGR1eeG7h3QiIGluIGxvd19zdGF0dXMgb3IgImNodWFkdXlldCIgaW4gbG93X3N0YXR1cyBvciAiY2jGsGEiIGluIGxvd19zdGF0dXM6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF90aW1lX3N0ciA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgICAgICAgICAgbmV3X2xpbmUgPSBmInt1c2VyX3RvX25vdGlmeX0gLSB7Y3VycmVudF90aW1lX3N0cn0gLSBNT01PIC0ge2Ftb3VudF90b19yZWZ1bmR9IC0gxJDDoyBo4buneSAtIHtyYW5kb21fY29kZX1cbiIKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChuZXdfbGluZSkKICAgICAgICAgICAgICAgICAgICBmb3VuZF9jb2RlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMahbiByw7p0IHRp4buBbiB7cmFuZG9tX2NvZGV9IMSRxrDhu6NjIGjhu6d5LCB1c2VyPXt1c2VyX3RvX25vdGlmeX0sIGhvw6BuPXthbW91bnRfdG9fcmVmdW5kfSIpCgogICAgICAgICAgICAgICAgICAgICMgSG/DoG4gdGnhu4FuIChjYXBuaGF0X3NvZHUgb3IgY2FwbmhhdF9zb2R1IHNpZ25hdHVyZSBhc3N1bWVkKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgaG9hbl9vayA9IGNhcG5oYXRfc29kdSh1c2VyX3RvX25vdGlmeSwgYW1vdW50X3RvX3JlZnVuZCwgdHJ1PUZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBob2FuX29rOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEhvw6BuIHRp4buBbiB0aMOgbmggY8O0bmcgY2hvIHVzZXIge3VzZXJfdG9fbm90aWZ5fToge2Ftb3VudF90b19yZWZ1bmR9IikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW1dBUk5dIGNhcG5oYXRfc29kdSB0cuG6oyB24buBIEZhbHNlIGNobyB1c2VyIHt1c2VyX3RvX25vdGlmeX0iKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIGtoaSBob8OgbiB0aeG7gW4gY2hvIHVzZXIge3VzZXJfdG9fbm90aWZ5fToge2V9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyB0cuG6oW5nIHRow6FpIGzhuqEsIGdp4buvIG5ndXnDqm4KICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChsaW5lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBraMO0bmcga2jhu5twIG3DoyAtIGdp4buvIG5ndXnDqm4KICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKGxpbmUpCgogICAgICAgIGlmIG5vdCBmb3VuZF9jb2RlOgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iTcOjIHLDunQgdGnhu4FuIGtow7RuZyB04buTbiB04bqhaSBob+G6t2MgxJHDoyDEkcaw4bujYyB44butIGzDvS4iKQogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IG3DoyByw7p0IHRp4buBbiB7cmFuZG9tX2NvZGV9IHRyb25nIGThu68gbGnhu4d1IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgZ2hpIGZpbGUgYW4gdG/DoG4KICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbHNydXQudHh0IiwgInciLCBlbmNvZGluZz0idXRmLTgiLCBlcnJvcnM9InJlcGxhY2UiKSBhcyBmaWxlOgogICAgICAgICAgICBmaWxlLndyaXRlbGluZXModXBkYXRlZF9saW5lcykKCiAgICAgICAgIyB0aMO0bmcgYsOhbyBjaG8gYWRtaW4gdsOgIHVzZXIKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0i4pyFIMSQw6MgaOG7p3kgxJHGoW4gcsO6dCB0aeG7gW4gdsOgIGhvw6BuIHRp4buBbiAobuG6v3Uga2jhuqMgZOG7pW5nKS4iKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGjhu6d5IMSRxqFuIHLDunQgI3tyYW5kb21fY29kZX0iKQoKICAgICAgICAjIHRow7RuZyBiw6FvIHVzZXIgKG7hur91IGPDsykKICAgICAgICBpZiB1c2VyX3RvX25vdGlmeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYmFsYW5jZSA9IGdldF92aWNoaW5oKHVzZXJfdG9fbm90aWZ5KQogICAgICAgICAgICAgICAgZm9ybWF0dGVkX2JhbGFuY2UgPSBkaW5oZGFuZyhzdHIoYmFsYW5jZSkpCiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgIGNoYXRfaWQ9dXNlcl90b19ub3RpZnksCiAgICAgICAgICAgICAgICAgICAgdGV4dD0oCiAgICAgICAgICAgICAgICAgICAgICAgIGYiUsO6dCB0aeG7gW4ga2jDtG5nIHRow6BuaCBjw7RuZywgbOG7h25oIMSRw6MgYuG7iyBo4buneS4gVnVpIGzDsm5nIMSR4bujaSAxMC0yMHMgdsOgIHRo4butIGzhuqFpLlxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIkxpw6puIGjhu4cgQURNSU4gxJHhu4MgxJHGsOG7o2MgaOG7lyB0cuG7oy5cblxuIgogICAgICAgICAgICAgICAgICAgICAgICBmIlPhu5EgZMawIGhp4buHbiB04bqhaToge2Zvcm1hdHRlZF9iYWxhbmNlfSIKICAgICAgICAgICAgICAgICAgICApLAogICAgICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHRow7RuZyBiw6FvIGNobyB1c2VyIHt1c2VyX3RvX25vdGlmeX0uIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiB04bubaSB1c2VyIHt1c2VyX3RvX25vdGlmeX06IHtlfSIpCgogICAgICAgICAgICAjIGfhu6Ega2jhu49pIGJhbiBu4bq/dSBjw7MKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIkZJTEUvYmFuLnR4dCIpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9iYW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBiYW5fbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2Jhbi50eHQiLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBibCBpbiBiYW5fbGluZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzdHIodXNlcl90b19ub3RpZnkpIG5vdCBpbiBibC5zdHJpcCgpLnNwbGl0KCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZi53cml0ZShibCkKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gKE7hur91IGPDsykgxJHDoyBn4buhIHVzZXIge3VzZXJfdG9fbm90aWZ5fSBraOG7j2kgYmFuLnR4dCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IGJhbi50eHQ6IHtlfSIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gbG9pbW9tbzoge2V9IikKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PWYiTOG7l2kga2hpIHjhu60gbMO9OiB7ZX0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCgpWQUxJRF9CQU5LUyA9IHsKICAgICJJQ0IiOiAiVmlldGluQmFuayIsICJWQ0IiOiAiVmlldGNvbWJhbmsiLCAiQklEViI6ICJCSURWIiwgIlZCQSI6ICJBZ3JpYmFuayIsCiAgICAiT0NCIjogIk9DQiIsICJNQiI6ICJNQkJhbmsiLCAiVENCIjogIlRlY2hjb21iYW5rIiwgIkFDQiI6ICJBQ0IiLAogICAgIlZQQiI6ICJWUEJhbmsiLCAiVFBCIjogIlRQQmFuayIsICJTVEIiOiAiU2Fjb21iYW5rIiwgIkhEQiI6ICJIREJhbmsiLAogICAgIlZDQ0IiOiAiVmlldENhcGl0YWxCYW5rIiwgIkJWQmFuayI6ICJCVkJhbmsiLCAiU0NCIjogIlNDQiIsICJWSUIiOiAiVklCIiwKICAgICJTSEIiOiAiU0hCIiwgIkVJQiI6ICJFeGltYmFuayIsICJNU0IiOiAiTVNCIiwgIkNBS0UiOiAiQ0FLRSIsCiAgICAiVWJhbmsiOiAiVWJhbmsiLCAiVElNTyI6ICJUaW1vIiwgIlNHSUNCIjogIlNhaWdvbkJhbmsiLCAiQkFCIjogIkJhY0FCYW5rIiwKICAgICJQVkNCIjogIlBWY29tQmFuayIsICJPY2VhbmJhbmsiOiAiT2NlYW5iYW5rIiwgIk5DQiI6ICJOQ0IiLCAiU0hCVk4iOiAiU2hpbmhhbkJhbmsiLAogICAgIkFCQiI6ICJBQkJBTksiLCAiVkFCIjogIlZpZXRBQmFuayIsICJOQUIiOiAiTmFtQUJhbmsiLCAiUEdCIjogIlBHQmFuayIsCiAgICAiVklFVEJBTksiOiAiVmlldEJhbmsiLCAiQlZCIjogIkJhb1ZpZXRCYW5rIiwgIlNFQUIiOiAiU2VBQmFuayIsCiAgICAiQ09PUEJBTksiOiAiQ09PUEJBTksiLCAiTFBCIjogIkxpZW5WaWV0UG9zdEJhbmsiLCAiS0xCIjogIktpZW5Mb25nQmFuayIsCiAgICAiU0NWTiI6ICJTdGFuZGFyZENoYXJ0ZXJlZCIsICJQQlZOIjogIlB1YmxpY0JhbmsiLCAiSVZCIjogIkluZG92aW5hQmFuayIsCiAgICAiSFNCQyI6ICJIU0JDIiwgIkRPQiI6ICJEb25nQUJhbmsiLCAiQ0lNQiI6ICJDSU1CIiwgIkNCQiI6ICJDQkJhbmsiCn0KCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnYmFuayddKQpkZWYgcnV0YmFuayhtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgcHJpbnQoZiJbREVCVUddIE5o4bqtbiBs4buHbmggdOG7qyB1c2VyOiB7dXNlcl9pZH0iKQoKICAgICMgPT09PT09IEtJ4buCTSBUUkEgVOG7lE5HIE7huqBQIFThu6ogRklMRS9sc25hcC50eHQgPT09PT09CiAgICB0b3RhbF9uYXAgPSAwCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzbmFwLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoIiAtICIpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpIDwgNDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdWlkLCBfLCBuYXBfdHlwZSwgYW1vdW50X3N0ciA9IHBhcnRzCiAgICAgICAgICAgICAgICBpZiBzdHIodXNlcl9pZCkgIT0gdWlkOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gaW50KGFtb3VudF9zdHIpCiAgICAgICAgICAgICAgICAgICAgdG90YWxfbmFwICs9IGFtb3VudAogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludCgiW0RFQlVHXSBGSUxFL2xzbmFwLnR4dCBraMO0bmcgdOG7k24gdOG6oWkuIikKICAgICIiIgogICAgaWYgdG90YWxfbmFwIDwgNTAwMDA6CiAgICAgICAgaWYgdG90YWxfbmFwID09IDA6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD0iQuG6oW4gY+G6p24gbuG6oXAgNTAuMDAwIHbDoCB4MXZjIMSR4buDIHRo4buxYyBoaeG7h24gcsO6dC4iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNhbl9uYXBfdGhlbSA9IDUwMDAwIC0gdG90YWxfbmFwCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD1mIkLhuqFuIGPhuqduIG7huqFwIHRow6ptIHtkaW5oZGFuZyhzdHIoY2FuX25hcF90aGVtKSl9IHbDoCB4MXZjIMSR4buDIHRo4buxYyBoaeG7h24gbOG7h25oIHLDunQuIikKICAgICAgICByZXR1cm4KICAgICAgICAiIiIKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgcmV0dXJuIHByaW50KCJbREVCVUddIFRpbiBuaOG6r24gYuG7iyBmb3J3YXJkLCBi4buPIHF1YS4iKQogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgcmV0dXJuIHByaW50KCJbREVCVUddIE5nxrDhu51pIGTDuW5nIGLhu4sgY+G6pW0uIikKICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgcmV0dXJuIHByaW50KCJbREVCVUddIFBow6F0IGhp4buHbiBzcGFtLiIpCiAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4gcHJpbnQoIltERUJVR10gTmfGsOG7nWkgZMO5bmcgYuG7iyBo4bqhbiBjaOG6vyBn4butaSB0aW4gbmjhuq9uLiIpCiAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICByZXR1cm4gcHJpbnQoIltERUJVR10gVGluIG5o4bqvbiBjxaksIGLhu48gcXVhLiIpCiAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgaWYgbGVuKGFyZ3MpICE9IDQ6CiAgICAgICAgcmV0dXJuIHByaW50KCJbREVCVUddIFNhaSBjw7ogcGjDoXAuIikKCiAgICBiYW5rX2NvZGUsIGFjY291bnRfbnVtYmVyLCBhbW91bnRfc3RyID0gYXJnc1sxXSwgYXJnc1syXSwgYXJnc1szXQoKICAgIGlmIGJhbmtfY29kZSBub3QgaW4gVkFMSURfQkFOS1M6CiAgICAgICAgcmV0dXJuIHByaW50KGYiW0RFQlVHXSBNw6MgbmfDom4gaMOgbmcga2jDtG5nIGjhu6NwIGzhu4c6IHtiYW5rX2NvZGV9IikKICAgIGlmIG5vdCBhY2NvdW50X251bWJlci5pc2RpZ2l0KCk6CiAgICAgICAgcmV0dXJuIHByaW50KGYiW0RFQlVHXSBT4buRIHTDoGkga2hv4bqjbiBraMO0bmcgaOG7o3AgbOG7hzoge2FjY291bnRfbnVtYmVyfSIpCiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KGFtb3VudF9zdHIpCiAgICAgICAgaWYgYW1vdW50IDwgMTAwMDAwOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlThu5FpIHRoaeG7g3UgMTAwLjAwMCIpCiAgICAgICAgICAgIHJldHVybiBwcmludCgiW0RFQlVHXSBT4buRIHRp4buBbiByw7p0IGTGsOG7m2kgbeG7qWMgdOG7kWkgdGhp4buDdS4iKQogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcmV0dXJuIHByaW50KCJbREVCVUddIEzhu5dpIGNodXnhu4NuIMSR4buVaSBz4buRIHRp4buBbi4iKQoKICAgIGN1cnJlbnRfYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWQpCiAgICBpZiBhbW91bnQgPiBjdXJyZW50X2JhbGFuY2U6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJT4buRIGTGsCBraMO0bmcgxJHhu6ciKQogICAgICAgIHJldHVybiBwcmludCgiW0RFQlVHXSBT4buRIGTGsCBraMO0bmcgxJHhu6cuIikKCiAgICBjdW9jX2Nvbl90aGlldSA9IGdldF9jdW9jX2Nhbl90aGlldSh1c2VyX2lkKQogICAgaWYgY3VvY19jb25fdGhpZXUgPiAwOgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0PWYiQuG6oW4gY+G6p24gY8aw4bujYyB0aMOqbSB7ZGluaGRhbmcoc3RyKGN1b2NfY29uX3RoaWV1KSl9IMSR4buDIHLDunQiKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gY8OybiBj4bqnbiBjxrDhu6NjOiB7Y3VvY19jb25fdGhpZXV9IikKICAgICAgICByZXR1cm4KCiAgICBpZiBpc19uZXdfdXNlcih1c2VyX2lkKToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PSJUw6JuIHRo4bunIGtow7RuZyB0aOG7gyByw7p0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZGJ1dHRvbigpLCBwYXJzZV9tb2RlPSdIVE1MJykKICAgICAgICByZXR1cm4KCiAgICBmb3JtYXR0ZWRfYW1vdW50ID0gZGluaGRhbmcoc3RyKGFtb3VudCkpCiAgICBiYW5rX25hbWUgPSBWQUxJRF9CQU5LU1tiYW5rX2NvZGVdCiAgICBmb3JtYXR0ZWRfYmFsYW5jZSA9IGRpbmhkYW5nKHN0cihjdXJyZW50X2JhbGFuY2UgLSBhbW91bnQpKQoKICAgIGlmIG5vdCBjYXBuaGF0X3NvZHUodXNlcl9pZCwgYW1vdW50LCB0cnU9VHJ1ZSk6CiAgICAgICAgcHJpbnQoIltERUJVR10gVHLhu6sgdGnhu4FuIHRo4bqldCBi4bqhaS4iKQogICAgICAgIHJldHVybgogICAgcHJpbnQoZiJbREVCVUddIMSQw6MgdHLhu6sge2Ftb3VudH0ga2jhu49pIHPhu5EgZMawIGPhu6dhIHVzZXIge3VzZXJfaWR9IikKCiAgICByYW5kb21fY29kZSA9IHJhbmRvbS5yYW5kaW50KDEwMDAwMCwgOTk5OTk5KQogICAgZm9ybWF0dGVkX2Z1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICBwcmludChmIltERUJVR10gVOG6oW8gTUdEOiB7cmFuZG9tX2NvZGV9IikKICAgIHRyeToKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD1mIiIixJBhbmcgeOG7rSBsw70gbOG7h25oIHLDunQgdGnhu4FuICN7cmFuZG9tX2NvZGV9ClTDoGkga2hv4bqjbiB04bqhbSB0aOG7nWkgYuG7iyBraMOzYSDEkeG7gyB44butIGzDvSBs4buHbmggcsO6dCwgdnVpIGzDsm5nIGtow7RuZyB0aGFvIHTDoWMgdGjDqm0gdHLDoW5oIG3huqV0IHTDoGkga2hv4bqjbiIiIiwKICAgICAgICAgICAgcGFyc2VfbW9kZT0nSFRNTCcsIHJlcGx5X3RvX21lc3NhZ2VfaWQ9bWVzc2FnZS5tZXNzYWdlX2lkCiAgICAgICAgKQoKICAgICAgICB0aG9uZ2Jhb3J1dGJhbmsodXNlcl9pZCwgZm9ybWF0dGVkX2Z1bGxuYW1lLCBiYW5rX25hbWUsIGFjY291bnRfbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQsIHJhbmRvbV9jb2RlLCBmb3JtYXR0ZWRfYmFsYW5jZSwgZm9ybWF0dGVkX2Ftb3VudCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvOiB7ZX0iKQoKICAgIGN1cnJlbnRfdGltZSA9IGRhdGV0aW1lLm5vdyhweXR6LnRpbWV6b25lKCdBc2lhL0hvX0NoaV9NaW5oJykpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSAtIHtjdXJyZW50X3RpbWV9IC0gQkFOSyAtIHtiYW5rX25hbWV9IC0ge2FjY291bnRfbnVtYmVyfSAtIHthbW91bnR9IC0gQ2jGsGEgZHV54buHdCAtIHtyYW5kb21fY29kZX1cbiIpCiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEdoaSBs4buLY2ggc+G7rSByw7p0IHRow6BuaCBjw7RuZy4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBnaGkgZmlsZSBGSUxFL2xzcnV0LnR4dDoge2V9IikKICAgIHRyeToKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfVxuIikKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gVGjDqm0gdXNlciB2w6BvIGRhbmggc8OhY2ggYuG7iyBraMOzYSB04bqhbSB0aOG7nWkuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ2hpIGZpbGUgRklMRS9iYW4udHh0OiB7ZX0iKQoKZnJvbSB1cmxsaWIucGFyc2UgaW1wb3J0IHF1b3RlCgpkZWYgdGhvbmdiYW9ydXRiYW5rKHVzZXJfaWQsIGZvcm1hdHRlZF9mdWxsbmFtZSwgYmFua19uYW1lLCBhY2NvdW50X251bWJlciwgYW1vdW50LCByYW5kb21fY29kZSwgZm9ybWF0dGVkX2JhbGFuY2UsIGZvcm1hdHRlZF9hbW91bnQpOgogICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUubm93KHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKSkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKICAgIHByaW50KGYiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyByw7p0IHRp4buBbiB04burIHVzZXIge3VzZXJfaWR9IC0ge2Zvcm1hdHRlZF9mdWxsbmFtZX0iKQoKICAgIHRyeToKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICAjIFThuqBPIFFSIEJBTksgUsOaVCBUSeG7gE4KICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCiAgICAgICAgIyBlbmNvZGUgbuG7mWkgZHVuZyBNR0QKICAgICAgICBlbmNvZGVkX2luZm8gPSBxdW90ZShzdHIocmFuZG9tX2NvZGUpKQoKICAgICAgICBxcl91cmwgPSAoCiAgICAgICAgICAgIGYiaHR0cHM6Ly9pbWcudmlldHFyLmlvL2ltYWdlLyIKICAgICAgICAgICAgZiJ7YmFua19uYW1lLnJlcGxhY2UoJyAnLCAnJyl9LXthY2NvdW50X251bWJlcn0td2l0aGRyYXcucG5nIgogICAgICAgICAgICBmIj9hbW91bnQ9e2Ftb3VudH0mYWRkSW5mbz17ZW5jb2RlZF9pbmZvfSIKICAgICAgICApCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBRUiBVUkw6IHtxcl91cmx9IikKCiAgICAgICAgIyB04bqjaSDhuqNuaCBRUgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQocXJfdXJsLCB0aW1lb3V0PTEwKQogICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgaW1nID0gSW1hZ2Uub3BlbihCeXRlc0lPKHJlc3BvbnNlLmNvbnRlbnQpKS5jb252ZXJ0KCJSR0IiKQoKICAgICAgICAgICAgaW1nX2J5dGVzID0gQnl0ZXNJTygpCiAgICAgICAgICAgIGltZy5zYXZlKGltZ19ieXRlcywgZm9ybWF0PSJQTkciKQogICAgICAgICAgICBpbWdfYnl0ZXMuc2VlaygwKQoKICAgICAgICAgICAgc2VuZF9waG90b19tb2RlID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHThuqNpIFFSLCBz4bq9IGfhu61pIHRleHQ6IHtlfSIpCiAgICAgICAgICAgIHNlbmRfcGhvdG9fbW9kZSA9IEZhbHNlCgogICAgICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgICMgQ0FQVElPTgogICAgICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgIGNhcHRpb24gPSBmIiIiCirwn5OkIFRIw5RORyBCw4FPIFLDmlQgVEnhu4BOIEJBTksqCgrwn5GkIE5nxrDhu51pIGTDuW5nOiBbe2Zvcm1hdHRlZF9mdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pCvCfhpQgSUQ6IGB7dXNlcl9pZH1gCvCfj6YgTmfDom4gaMOgbmc6IGB7YmFua19uYW1lfWAK8J+UoiBT4buRIHTDoGkga2hv4bqjbjogYHthY2NvdW50X251bWJlcn1gCvCfkrggU+G7kSB0aeG7gW46ICp7Zm9ybWF0dGVkX2Ftb3VudH0qCvCfkrAgU+G7kSBkxrAgc2F1IHLDunQ6IGB7Zm9ybWF0dGVkX2JhbGFuY2V9YArwn5SQIE1HRDogYHtyYW5kb21fY29kZX1gCvCflZIgVGjhu51pIGdpYW46IHtjdXJyZW50X3RpbWV9Cgrwn5GJICpEdXnhu4d0OiogYC9kdXlldGJhbmsge3JhbmRvbV9jb2RlfWAK4p2MICpU4burIGNo4buRaToqIGAvbG9pYmFuayB7cmFuZG9tX2NvZGV9YAoK8J+RruKAjeKZgu+4jyBBRE1JTjogQGthaWFhYTE4CiIiIgoKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICAjIEfhu6xJIOG6ok5IIEhP4bq2QyBURVhUCiAgICAgICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgaWYgc2VuZF9waG90b19tb2RlOgogICAgICAgICAgICBib3QxLnNlbmRfcGhvdG8oCiAgICAgICAgICAgICAgICBjaGF0X2lkPSItMTAwMzI0MTAwMjQ3OCIsCiAgICAgICAgICAgICAgICBwaG90bz1pbWdfYnl0ZXMsCiAgICAgICAgICAgICAgICBjYXB0aW9uPWNhcHRpb24sCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPSJNYXJrZG93biIKICAgICAgICAgICAgKQogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSDhuqNuaCBRUiB0aMOgbmggY8O0bmciKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD0iLTEwMDMyNDEwMDI0NzgiLAogICAgICAgICAgICAgICAgdGV4dD1jYXB0aW9uLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT0iTWFya2Rvd24iCiAgICAgICAgICAgICkKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gR+G7rWkgdGV4dCBraMO0bmcgY8OzIFFSIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvIEFETUlOOiB7ZX0iKQoKZnJvbSB0ZWxlYm90LmFwaWhlbHBlciBpbXBvcnQgQXBpVGVsZWdyYW1FeGNlcHRpb24KCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ2R1eWV0YmFuayddKQpkZWYgZHV5ZXRiYW5rKG1lc3NhZ2U6IE1lc3NhZ2UpOgogICAgIiIiCiAgICBEdXnhu4d0IGzhu4duaCByw7p0IEJBTksgYW4gdG/DoG46CiAgICAtIFRyw6FuaCBjcmFzaCBraGkgdXNlciBjaMawYSAvc3RhcnQgaG/hurdjIGNo4bq3biBib3QgKGNoYXQgbm90IGZvdW5kKS4KICAgIC0gU2FuaXRpemUgZMOybmcgZmlsZSAobG/huqFpIGJ5dGUgbnVsbCkuCiAgICAtIEdoaSBmaWxlIGFuIHRvw6BuICh1dGYtOCwgZXJyb3JzPSdyZXBsYWNlJykuCiAgICAtIFRy4bqjIGzhu51pIGFkbWluIGLhurFuZyBib3QxLCBn4butaSB1c2VyIGLhurFuZyBib3QxICh0cnkvZXhjZXB0KS4KICAgICIiIgogICAgYWRtaW5fdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgIyBjaHXhuqluIGjDs2EgQURNSU4gKGjhu5cgdHLhu6MgQURNSU4gbMOgIGxpc3QvdHVwbGUvc2V0IGhv4bq3YyAxIGdpw6EgdHLhu4spCiAgICB0cnk6CiAgICAgICAgaWYgaXNpbnN0YW5jZShBRE1JTiwgKGxpc3QsIHR1cGxlLCBzZXQpKToKICAgICAgICAgICAgYWRtaW5fc2V0ID0gc2V0KG1hcChzdHIsIEFETUlOKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhZG1pbl9zZXQgPSB7c3RyKEFETUlOKX0KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgYWRtaW5fc2V0ID0ge3N0cihBRE1JTil9CgogICAgaWYgc3RyKGFkbWluX3VzZXJfaWQpIG5vdCBpbiBhZG1pbl9zZXQ6CiAgICAgICAgcmV0dXJuCgogICAgYXJncyA9IChtZXNzYWdlLnRleHQgb3IgIiIpLnN0cmlwKCkuc3BsaXQoKQogICAgaWYgbGVuKGFyZ3MpICE9IDI6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iQ8O6IHBow6FwOiAvZHV5ZXRiYW5rIDxNw4M+IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuCgogICAgcmFuZG9tX2NvZGUgPSBhcmdzWzFdLnN0cmlwKCkKICAgIHByaW50KGYiW0RFQlVHXSBNw6MgxJHGoW4gY+G6p24gZHV54buHdDoge3JhbmRvbV9jb2RlfSIpCgogICAgdHJ5OgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRS9sc3J1dC50eHQiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9Iktow7RuZyB0w6xtIHRo4bqleSBGSUxFL2xzcnV0LnR4dCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIMSR4buNYyBmaWxlIGFuIHRvw6BuLCB0aGF5IHRo4bq/IGJ5dGUgbOG6oQogICAgICAgIHdpdGggb3BlbigiRklMRS9sc3J1dC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIsIGVycm9ycz0icmVwbGFjZSIpIGFzIGY6CiAgICAgICAgICAgIGxzcnV0X2xpbmVzID0gZi5yZWFkbGluZXMoKQoKICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzID0gW10KICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgdXNlcl9pZCA9IE5vbmUKICAgICAgICBhbW91bnQgPSAwCiAgICAgICAgYmFua19uYW1lID0gIiIKICAgICAgICBiYW5rX2FjY291bnQgPSAiIgoKICAgICAgICBmb3IgcmF3X2xpbmUgaW4gbHNydXRfbGluZXM6CiAgICAgICAgICAgICMgbG/huqFpIGLhu48gYnl0ZSBudWxsIHbDoCBjw6FjIGvDvSB04buxIGzhuqEsIGdp4buvIHJhd19saW5lIMSR4buDIHZp4bq/dCBs4bqhaSBu4bq/dSBj4bqnbgogICAgICAgICAgICBjbGVhbl9saW5lID0gcmF3X2xpbmUucmVwbGFjZSgiXHgwMCIsICIiKS5yc3RyaXAoIlxuIikKICAgICAgICAgICAgcGFydHMgPSBbcC5zdHJpcCgpIGZvciBwIGluIGNsZWFuX2xpbmUuc3BsaXQoIiAtICIpXQoKICAgICAgICAgICAgIyBraeG7g20gdHJhIGFuIHRvw6BuOiDDrXQgbmjhuqV0IGPDsyA3IHBo4bqnbiAoaW5kZXggYuG6r3QgxJHhuqd1IHThu6sgMCksIHBo4bqnbiAyIGzDoCAnQkFOSycKICAgICAgICAgICAgbGFzdF9wYXJ0ID0gcGFydHNbLTFdIGlmIHBhcnRzIGVsc2UgIiIKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSA3IGFuZCBwYXJ0c1syXS51cHBlcigpID09ICJCQU5LIiBhbmQgbGFzdF9wYXJ0ID09IHJhbmRvbV9jb2RlOgogICAgICAgICAgICAgICAgIyBwYXJzZSB1c2VyX2lkIGFuIHRvw6BuCiAgICAgICAgICAgICAgICB1aWRfbWF0Y2ggPSByZS5zZWFyY2gociJcZCsiLCBwYXJ0c1swXSkKICAgICAgICAgICAgICAgIGlmIG5vdCB1aWRfbWF0Y2g6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gRMOybmcgY8OzIG3DoyBuaMawbmcgdXNlcl9pZCBraMO0bmcgeMOhYyDEkeG7i25oLCBnaeG7ryBuZ3V5w6puOiB7Y2xlYW5fbGluZX0iKQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfbHNydXRfbGluZXMuYXBwZW5kKHJhd19saW5lKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IGludCh1aWRfbWF0Y2guZ3JvdXAoKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gS2jDtG5nIHRo4buDIHBhcnNlIHVzZXJfaWQgdOG7qyAne3BhcnRzWzBdfScsIGdp4buvIG5ndXnDqm4gZMOybmcuIikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzLmFwcGVuZChyYXdfbGluZSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgICMgcGFyc2UgYW1vdW50IGFuIHRvw6BuIChsb+G6oWkgZOG6pXUgcGjhuql5L2No4bqlbSkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBhbW91bnRfdGV4dCA9IHBhcnRzWzVdIGlmIGxlbihwYXJ0cykgPiA1IGVsc2UgIjAiCiAgICAgICAgICAgICAgICAgICAgYW1vdW50X251bSA9IGludChyZS5zdWIociJbXlxkXC1dIiwgIiIsIHN0cihhbW91bnRfdGV4dCkpIG9yIDApCiAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gYW1vdW50X251bQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSAwCgogICAgICAgICAgICAgICAgYmFua19uYW1lID0gcGFydHNbM10gaWYgbGVuKHBhcnRzKSA+IDMgZWxzZSAiIgogICAgICAgICAgICAgICAgYmFua19hY2NvdW50ID0gcGFydHNbNF0gaWYgbGVuKHBhcnRzKSA+IDQgZWxzZSAiIgogICAgICAgICAgICAgICAgc3RhdHVzX2ZpZWxkID0gcGFydHNbNl0ubG93ZXIoKSBpZiBsZW4ocGFydHMpID4gNiBlbHNlICIiCgogICAgICAgICAgICAgICAgaWYgInRow6BuaCBjw7RuZyIgaW4gc3RhdHVzX2ZpZWxkIG9yICJ0aGFuaCBjb25nIiBpbiBzdGF0dXNfZmllbGQ6CiAgICAgICAgICAgICAgICAgICAgIyDEkcOjIGR1eeG7h3QgdHLGsOG7m2MgxJHDswogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IsSQxqFuIG7DoHkgxJHDoyDEkcaw4bujYyBkdXnhu4d0IHRyxrDhu5tjIMSRw7MuIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW1dBUk5dIEtow7RuZyBn4butaSDEkcaw4bujYyB0aW4gY2hvIGFkbWluOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfbHNydXRfbGluZXMuYXBwZW5kKHJhd19saW5lKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgZWxpZiAiY2jGsGEiIGluIHN0YXR1c19maWVsZCBvciAiY2h1YSIgaW4gc3RhdHVzX2ZpZWxkOgogICAgICAgICAgICAgICAgICAgICMgY+G6rXAgbmjhuq10IHRow6BuaCB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWVfc3RyID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICAgICAgICAgICAgICBuZXdfbGluZSA9IGYie3VzZXJfaWR9IC0ge2N1cnJlbnRfdGltZV9zdHJ9IC0gQkFOSyAtIHtiYW5rX25hbWV9IC0ge2JhbmtfYWNjb3VudH0gLSB7YW1vdW50fSAtIFRow6BuaCBjw7RuZyAtIHtyYW5kb21fY29kZX1cbiIKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzLmFwcGVuZChuZXdfbGluZSkKICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoW5oIGThuqV1IFRow6BuaCBjw7RuZyBjaG8gbcOjIHtyYW5kb21fY29kZX0sIHVzZXI9e3VzZXJfaWR9LCBhbW91bnQ9e2Ftb3VudH0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIHRy4bqhbmcgdGjDoWkgbOG6oSA9PiBnaeG7ryBuZ3V5w6puCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9sc3J1dF9saW5lcy5hcHBlbmQocmF3X2xpbmUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1cGRhdGVkX2xzcnV0X2xpbmVzLmFwcGVuZChyYXdfbGluZSkKCiAgICAgICAgaWYgbm90IGZvdW5kOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iS2jDtG5nIHTDrG0gdGjhuqV5IG3DoyByw7p0IHRp4buBbiBuw6B5IGhv4bq3YyDEkcOjIMSRxrDhu6NjIHjhu60gbMO9LiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgbcOjIHLDunQgdGnhu4FuOiB7cmFuZG9tX2NvZGV9IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgZ2hpIGZpbGUgYW4gdG/DoG4KICAgICAgICB3aXRoIG9wZW4oIkZJTEUvbHNydXQudHh0IiwgInciLCBlbmNvZGluZz0idXRmLTgiLCBlcnJvcnM9InJlcGxhY2UiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlbGluZXModXBkYXRlZF9sc3J1dF9saW5lcykKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIGPhuq1wIG5o4bqtdCBGSUxFL2xzcnV0LnR4dCIpCgogICAgICAgICMgTOG6pXkgc+G7kSBkxrAgaGnhu4duIHThuqFpIChraMO0bmcgdHLhu6sgdGnhu4FuIOG7nyDEkcOieSB2w6wgxJHDoyB0cuG7qyBraGkgdXNlciBn4butaSBs4buHbmgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfdmljaGluaCh1c2VyX2lkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IDAKCiAgICAgICAgZm9ybWF0dGVkX2JhbGFuY2UgPSBmb3JtYXRfYmFsYW5jZShjdXJyZW50X2JhbGFuY2UpCiAgICAgICAgZm9ybWF0dGVkX2Ftb3VudCA9IGZvcm1hdF9iYWxhbmNlKGFtb3VudCkKCiAgICAgICAgIyBH4butaSB0aW4gdOG7m2kgdXNlciAoYuG7jWMgdHJ5L2V4Y2VwdCDEkeG7gyB0csOhbmggY3Jhc2ggbuG6v3UgdXNlciBjaMawYSAvc3RhcnQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD11c2VyX2lkLAogICAgICAgICAgICAgICAgdGV4dD0oCiAgICAgICAgICAgICAgICAgICAgZiJJRDogYHt1c2VyX2lkfWBcbiIKICAgICAgICAgICAgICAgICAgICBmIi0gUsO6dCB0aMOgbmggY8O0bmcge2Zvcm1hdHRlZF9hbW91bnR9IHh1XG4iCiAgICAgICAgICAgICAgICAgICAgZiItIFBow60gcsO6dCB0aeG7gW46IDBcbiIKICAgICAgICAgICAgICAgICAgICBmIi0gU+G7kSBkxrAgaGnhu4duIHThuqFpOiB7Zm9ybWF0dGVkX2JhbGFuY2V9IgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9Ik1hcmtkb3duIgogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEFwaVRlbGVncmFtRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW1dBUk5dIEFwaVRlbGVncmFtRXhjZXB0aW9uIGtoaSBn4butaSB1c2VyIHt1c2VyX2lkfToge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9ZiLEkMOjIGR1eeG7h3QgbmjGsG5nIGtow7RuZyBn4butaSDEkcaw4bujYyB0aW4gY2hvIHVzZXIge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiB04bubaSB1c2VyIHt1c2VyX2lkfToge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9ZiLEkMOjIGR1eeG7h3QgbmjGsG5nIGtow7RuZyBn4butaSDEkcaw4bujYyB0aW4gY2hvIHVzZXIge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIFjDs2Ega2jhu49pIGJhbiBu4bq/dSBjw7MKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCJGSUxFL2Jhbi50eHQiKToKICAgICAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9iYW4udHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGJhbl9saW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgIG5ld19iYW5fbGluZXMgPSBbbG4gZm9yIGxuIGluIGJhbl9saW5lcyBpZiBzdHIodXNlcl9pZCkgbm90IGluIGxuXQogICAgICAgICAgICAgICAgaWYgbGVuKG5ld19iYW5fbGluZXMpICE9IGxlbihiYW5fbGluZXMpOgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9iYW4udHh0IiwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X2Jhbl9saW5lcykKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyB4w7NhIFVzZXIgSUQge3VzZXJfaWR9IGto4buPaSBGSUxFL2Jhbi50eHQiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSBiYW4udHh0OiB7ZX0iKQoKICAgICAgICAjIFRow7RuZyBiw6FvIGFkbWluIHjDoWMgbmjhuq1uCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0i4pyFIMSQw6MgZHV54buHdCByw7p0IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW1dBUk5dIEtow7RuZyBn4butaSDEkcaw4bujYyB0aW4geMOhYyBuaOG6rW4gY2hvIGFkbWluOiB7ZX0iKQoKICAgICAgICAjIEfhu41pIHjhu60gbMO9IGjhuq11IGPhuqduIChu4bq/dSBjw7MpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YnJiKHVzZXJfaWQsIGFtb3VudCwgYmFua19uYW1lLCBiYW5rX2FjY291bnQpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRicmIgY2hvIHVzZXIge3VzZXJfaWR9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgZ+G7jWkgdGJyYjoge2V9IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBkdXnhu4d0IHLDunQgdGnhu4FuOiB7ZX0iKQogICAgICAgIHRyeToKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9ZiJM4buXaSBraGkgZHV54buHdCByw7p0OiB7ZX0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCgppbXBvcnQgcmVxdWVzdHMKZnJvbSB0ZWxlZ3JhbS5jb25zdGFudHMgaW1wb3J0IFBhcnNlTW9kZQoKCmRlZiB0YnJiKHVzZXJfaWQ6IGludCwgYW1vdW50OiBpbnQsIGJhbmtfY29kZTogc3RyLCBiYW5rX2FjY291bnQ6IHN0cik6CiAgICBmb3JtYXR0ZWRfYW1vdW50ID0gZm9ybWF0X2JhbGFuY2UoYW1vdW50KQoKICAgIGdyb3VwX2NoYXRfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZCkKICAgIGhpZGRlbl91c2VyX2lkID0gdXNlcl9pZF9zdHJbOjZdICsgIioqKioiCgogICAgZ3JvdXBfbWVzc2FnZSA9ICgKICAgICAgICBmIjxiPk5nxrDhu51pIGNoxqFpIElEOiB7aGlkZGVuX3VzZXJfaWR9PC9iPlxuXG4iCiAgICAgICAgZiI8Yj4tIFLDunQgQkFOSyB0aMOgbmggY8O0bmcge2Zvcm1hdHRlZF9hbW91bnR9IHh1PC9iPiIKICAgICkKCiAgICBvdGhlcl9ib3RfdG9rZW4gPSAiODQ5MzcwMzI5NzpBQUhTZjh3VHhpcG43VEVUUDFCOVlTV3FhUjYwR2xKc1ZIYyIKICAgIHVybCA9IGYiaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdHtvdGhlcl9ib3RfdG9rZW59L3NlbmRNZXNzYWdlIgoKICAgIHBheWxvYWQgPSB7CiAgICAgICAgImNoYXRfaWQiOiBncm91cF9jaGF0X2lkLAogICAgICAgICJ0ZXh0IjogZ3JvdXBfbWVzc2FnZSwKICAgICAgICAicGFyc2VfbW9kZSI6ICJIVE1MIgogICAgfQoKICAgIHRyeToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QodXJsLCBqc29uPXBheWxvYWQsIHRpbWVvdXQ9MTApCiAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgcHJpbnQoIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyByw7p0IEJBTksgdsOgbyBuaMOzbS4iKQogICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgZ+G7rWkgdGjDtG5nIGLDoW8gdsOgbyBuaMOzbToge2V9IikKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ2xvaWJhbmsnXSkKZGVmIGxvaWJhbmsobWVzc2FnZTogTWVzc2FnZSk6CiAgICAiIiIKICAgIEjhu6d5IGzhu4duaCByw7p0IEJBTks6IC9sb2liYW5rIDxNw4MgNiBz4buRPgogICAgLSBLaeG7g20gdHJhIHF1eeG7gW4gQURNSU4gKGjhu5cgdHLhu6MgQURNSU4gbMOgIGxpc3Qvc3RyKQogICAgLSDEkOG7jWMvZ2hpIEZJTEUvbHNydXQudHh0IGFuIHRvw6BuIChlcnJvcnM9J3JlcGxhY2UnKQogICAgLSBQYXJzZSBjw6FjIGTDsm5nIGFuIHRvw6BuIChsb+G6oWkgYuG7jyBceDAwLCB0cmltKQogICAgLSBH4butaSB0aMO0bmcgYsOhbyBjaG8gYWRtaW4gdsOgIHVzZXIgYuG6sW5nIGJvdDEKICAgICIiIgogICAgYWRtaW5fdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCgogICAgIyBjaHXhuqluIGjDs2EgQURNSU4gKGPDsyB0aOG7gyBsw6AgbGlzdC90dXBsZS9zZXQgaG/hurdjIDEgZ2nDoSB0cuG7iykKICAgIHRyeToKICAgICAgICBpZiBpc2luc3RhbmNlKEFETUlOLCAobGlzdCwgdHVwbGUsIHNldCkpOgogICAgICAgICAgICBhZG1pbl9zZXQgPSBzZXQobWFwKHN0ciwgQURNSU4pKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGFkbWluX3NldCA9IHtzdHIoQURNSU4pfQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBhZG1pbl9zZXQgPSB7c3RyKEFETUlOKX0KCiAgICBpZiBzdHIoYWRtaW5fdXNlcl9pZCkgbm90IGluIGFkbWluX3NldDoKICAgICAgICBwcmludChmIltERUJVR10gVXNlciB7YWRtaW5fdXNlcl9pZH0ga2jDtG5nIGPDsyBxdXnhu4FuIGjhu6d5IGzhu4duaCByw7p0LiIpCiAgICAgICAgcmV0dXJuCgogICAgdHh0ID0gKG1lc3NhZ2UudGV4dCBvciAiIikuc3RyaXAoKQogICAgbSA9IHJlLm1hdGNoKHIiXi9sb2liYW5rXHMrKFxkezZ9KSQiLCB0eHQpCiAgICBpZiBub3QgbToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iQ8O6IHBow6FwOiAvbG9pYmFuayA8TcODIDYgc+G7kT4iKQogICAgICAgIHJldHVybgoKICAgIHJhbmRvbV9jb2RlID0gbS5ncm91cCgxKQogICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIHjhu60gbMO9IGjhu6d5IHLDunQgQkFOSyBjaG8gbcOjOiB7cmFuZG9tX2NvZGV9IikKCiAgICAjIMSR4buNYyBmaWxlIGFuIHRvw6BuCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoIkZJTEUvbHNydXQudHh0Iik6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9Iktow7RuZyB0w6xtIHRo4bqleSBGSUxFL2xzcnV0LnR4dCIpCiAgICAgICAgcHJpbnQoIltERUJVR10gRklMRS9sc3J1dC50eHQga2jDtG5nIHThu5NuIHThuqFpIikKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJyZXBsYWNlIikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9Ikzhu5dpIGtoaSDEkeG7jWMgZOG7ryBsaeG7h3UgcsO6dCB0aeG7gW4uIikKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgxJHhu41jIEZJTEUvbHNydXQudHh0OiB7ZX0iKQogICAgICAgIHJldHVybgoKICAgIHVwZGF0ZWRfbGluZXMgPSBbXQogICAgZm91bmRfY29kZSA9IEZhbHNlCiAgICB1c2VyX3RvX25vdGlmeSA9IE5vbmUKICAgIGFtb3VudF90b19yZWZ1bmQgPSAwCgogICAgZm9yIHJhdyBpbiBsaW5lczoKICAgICAgICAjIGzDoG0gc+G6oWNoIG51bGwgYnl0ZXMgdsOgIGPDoWMga8O9IHThu7EgbOG6oSwgZ2nhu68gcmF3IMSR4buDIG7hur91IGtow7RuZyBz4butYSB24bqrbiBnaGkgbOG6oWkKICAgICAgICBjbGVhbmVkID0gcmF3LnJlcGxhY2UoIlx4MDAiLCAiIikucnN0cmlwKCJcbiIpCiAgICAgICAgcGFydHMgPSBbcC5zdHJpcCgpIGZvciBwIGluIGNsZWFuZWQuc3BsaXQoIiAtICIpXQoKICAgICAgICAjIMSRaeG7gXUga2nhu4duIGFuIHRvw6BuOiBwaOG6p24gbG/huqFpIGzDoCBCQU5LIHbDoCBwaOG6p24gY3Xhu5FpIGzDoCBtw6MKICAgICAgICBsYXN0X3BhcnQgPSBwYXJ0c1stMV0gaWYgcGFydHMgZWxzZSAiIgogICAgICAgIGlmIGxlbihwYXJ0cykgPj0gNyBhbmQgcGFydHNbMl0udXBwZXIoKSA9PSAiQkFOSyIgYW5kIGxhc3RfcGFydCA9PSByYW5kb21fY29kZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFTDrG0gdGjhuqV5IGTDsm5nIHRyw7luZyBtw6M6IHtjbGVhbmVkfSIpCgogICAgICAgICAgICAjIGzhuqV5IHRy4bqhbmcgdGjDoWkgKHRoxrDhu51uZyDhu58gduG7iyB0csOtIDYgbuG6v3UgY+G6pXUgdHLDumMgY2h14bqpbikKICAgICAgICAgICAgc3RhdHVzX2ZpZWxkID0gcGFydHNbNl0gaWYgbGVuKHBhcnRzKSA+IDYgZWxzZSAiIgoKICAgICAgICAgICAgIyBs4bqleSB1c2VyX2lkIGFuIHRvw6BuCiAgICAgICAgICAgIHVpZF9yYXcgPSBwYXJ0c1swXSBpZiBwYXJ0cyBlbHNlICIiCiAgICAgICAgICAgIG1fdWlkID0gcmUuc2VhcmNoKHIiXGQrIiwgdWlkX3JhdykKICAgICAgICAgICAgaWYgbm90IG1fdWlkOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbV0FSTl0gS2jDtG5nIHBhcnNlIMSRxrDhu6NjIHVzZXJfaWQgdOG7qyBkw7JuZzoge2NsZWFuZWR9IikKICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKHJhdykKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXJfdG9fbm90aWZ5ID0gaW50KG1fdWlkLmdyb3VwKCkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwcmludChmIltXQVJOXSB1c2VyX2lkIGtow7RuZyBo4bujcCBs4buHOiB7bV91aWQuZ3JvdXAoKX0iKQogICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQocmF3KQogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICMgbOG6pXkgYW1vdW50IGFuIHRvw6BuICh0aMaw4budbmcg4bufIHbhu4sgdHLDrSA1KQogICAgICAgICAgICBhbW91bnRfcmF3ID0gcGFydHNbNV0gaWYgbGVuKHBhcnRzKSA+IDUgZWxzZSAiMCIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYW10X2RpZ2l0cyA9IHJlLnN1YihyIlteXGRcLV0iLCAiIiwgc3RyKGFtb3VudF9yYXcpKQogICAgICAgICAgICAgICAgYW1vdW50X3RvX3JlZnVuZCA9IGludChhbXRfZGlnaXRzKSBpZiBhbXRfZGlnaXRzIGVsc2UgMAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgYW1vdW50X3RvX3JlZnVuZCA9IDAKCiAgICAgICAgICAgIHN0YXR1c19sb3cgPSBzdGF0dXNfZmllbGQubG93ZXIoKQogICAgICAgICAgICBpZiAidGjDoG5oIGPDtG5nIiBpbiBzdGF0dXNfbG93IG9yICJ0aGFuaCBjb25nIiBpbiBzdGF0dXNfbG93OgogICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IsSQxqFuIG7DoHkgxJHDoyDEkcaw4bujYyBkdXnhu4d0IHRyxrDhu5tjIMSRw7MuIikKICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKHJhdykKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMahbiDEkcOjIGR1eeG7h3QgdHLGsOG7m2MgxJHDsywgZ2nhu68gbmd1ecOqbi4iKQogICAgICAgICAgICAgICAgIyBraMO0bmcgdGnhur9wIHThu6VjIHjhu60gbMO9CiAgICAgICAgICAgIGVsaWYgImNoxrBhIiBpbiBzdGF0dXNfbG93IG9yICJjaHVhIiBpbiBzdGF0dXNfbG93OgogICAgICAgICAgICAgICAgIyBj4bqtcCBuaOG6rXQgdGjDoG5oIMSQw6MgaOG7p3kKICAgICAgICAgICAgICAgICMgZ2nhu68gY+G6pXUgdHLDumM6IHVzZXIgLSB0aW1lIC0gQkFOSyAtIGJhbmtfbmFtZSAtIGJhbmtfYWNjb3VudCAtIGFtb3VudCAtIMSQw6MgaOG7p3kgLSBjb2RlCiAgICAgICAgICAgICAgICB0aW1lX3N0ciA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgICAgICBiYW5rX25hbWUgPSBwYXJ0c1szXSBpZiBsZW4ocGFydHMpID4gMyBlbHNlICIiCiAgICAgICAgICAgICAgICBiYW5rX2FjY291bnQgPSBwYXJ0c1s0XSBpZiBsZW4ocGFydHMpID4gNCBlbHNlICIiCiAgICAgICAgICAgICAgICBuZXdfbGluZSA9IGYie3VzZXJfdG9fbm90aWZ5fSAtIHt0aW1lX3N0cn0gLSBCQU5LIC0ge2JhbmtfbmFtZX0gLSB7YmFua19hY2NvdW50fSAtIHthbW91bnRfdG9fcmVmdW5kfSAtIMSQw6MgaOG7p3kgLSB7cmFuZG9tX2NvZGV9XG4iCiAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChuZXdfbGluZSkKICAgICAgICAgICAgICAgIGZvdW5kX2NvZGUgPSBUcnVlCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoW5oIGThuqV1IMSQw6MgaOG7p3kgY2hvIG3DoyB7cmFuZG9tX2NvZGV9LCB1c2VyPXt1c2VyX3RvX25vdGlmeX0sIGFtb3VudD17YW1vdW50X3RvX3JlZnVuZH0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyB0cuG6oW5nIHRow6FpIGzhuqEgLT4gZ2nhu68gbmd1ecOqbgogICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcy5hcHBlbmQocmF3KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKHJhdykKCiAgICBpZiBub3QgZm91bmRfY29kZToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iTcOjIHLDunQgdGnhu4FuIGtow7RuZyB04buTbiB04bqhaSBob+G6t2MgxJHDoyDEkcaw4bujYyB44butIGzDvS4iKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBNw6Mge3JhbmRvbV9jb2RlfSBraMO0bmcgdMOsbSB0aOG6pXkuIikKICAgICAgICByZXR1cm4KCiAgICAjIGdoaSBmaWxlIGFuIHRvw6BuCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IiwgZXJyb3JzPSJyZXBsYWNlIikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKHVwZGF0ZWRfbGluZXMpCiAgICAgICAgcHJpbnQoIltERUJVR10gxJDDoyBj4bqtcCBuaOG6rXQgRklMRS9sc3J1dC50eHQiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PSJM4buXaSBraGkgZ2hpIEZJTEUvbHNydXQudHh0LiIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGdoaSBGSUxFL2xzcnV0LnR4dDoge2V9IikKICAgICAgICByZXR1cm4KCiAgICAjIGhvw6BuIHRp4buBbiBjaG8gdXNlcgogICAgaWYgdXNlcl90b19ub3RpZnkgaXMgbm90IE5vbmU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBvayA9IGNhcG5oYXRfc29kdSh1c2VyX3RvX25vdGlmeSwgYW1vdW50X3RvX3JlZnVuZCwgdHJ1PUZhbHNlKQogICAgICAgICAgICBpZiBvazoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBIb8OgbiBs4bqhaSB7YW1vdW50X3RvX3JlZnVuZH0gY2hvIHVzZXIge3VzZXJfdG9fbm90aWZ5fSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIltXQVJOXSBjYXBuaGF0X3NvZHUgdHLhuqMgduG7gSBGYWxzZSBjaG8gdXNlciB7dXNlcl90b19ub3RpZnl9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBM4buXaSBraGkgaG/DoG4gdGnhu4FuOiB7ZX0iKQoKICAgICMgdGjDtG5nIGLDoW8gYWRtaW4KICAgIHRyeToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0i4pyFIMSQw6MgaOG7p3kgxJHGoW4gcsO6dCB0aeG7gW4uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltXQVJOXSBLaMO0bmcgZ+G7rWkgxJHGsOG7o2MgdGjDtG5nIGLDoW8gY2hvIGFkbWluOiB7ZX0iKQoKICAgICMgdGjDtG5nIGLDoW8gdXNlciAoa2jDtG5nIGNyYXNoIG7hur91IHVzZXIgY2jGsGEgL3N0YXJ0KQogICAgaWYgdXNlcl90b19ub3RpZnkgaXMgbm90IE5vbmU6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBiYWxhbmNlID0gZ2V0X3ZpY2hpbmgodXNlcl90b19ub3RpZnkpCiAgICAgICAgICAgIGZvcm1hdHRlZCA9IGZvcm1hdF9iYWxhbmNlKGJhbGFuY2UpCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPXVzZXJfdG9fbm90aWZ5LAogICAgICAgICAgICAgICAgdGV4dD0oCiAgICAgICAgICAgICAgICAgICAgZiJSw7p0IHRp4buBbiBraMO0bmcgdGjDoG5oIGPDtG5nLCBs4buHbmggxJHDoyBi4buLIGjhu6d5LlxuIgogICAgICAgICAgICAgICAgICAgIGYiVnVpIGzDsm5nIMSR4bujaSAxMC0yMHMgdsOgIHRo4butIGzhuqFpLlxuXG4iCiAgICAgICAgICAgICAgICAgICAgZiJT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXR0ZWR9IgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgICAgICkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgdGjDtG5nIGLDoW8gY2hvIHVzZXIge3VzZXJfdG9fbm90aWZ5fSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltXQVJOXSBLaMO0bmcgZ+G7rWkgxJHGsOG7o2MgdGluIHThu5tpIHVzZXIge3VzZXJfdG9fbm90aWZ5fToge2V9IikKCiAgICAgICAgIyBn4buhIGto4buPaSBiYW4gbuG6v3UgY8OzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygiRklMRS9iYW4udHh0Iik6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBiYW5fbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgICAgICBuZXdfYmFuID0gW10KICAgICAgICAgICAgICAgIHVpZF9zdHIgPSBzdHIodXNlcl90b19ub3RpZnkpCiAgICAgICAgICAgICAgICBmb3IgYmwgaW4gYmFuX2xpbmVzOgogICAgICAgICAgICAgICAgICAgIHRva2VucyA9IGJsLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIHVpZF9zdHIgbm90IGluIHRva2VuczoKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X2Jhbi5hcHBlbmQoYmwpCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvYmFuLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X2JhbikKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu6EgdXNlciB7dXNlcl90b19ub3RpZnl9IGto4buPaSBiYW4udHh0IChu4bq/dSBjw7MpLiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgY+G6rXAgbmjhuq10IGJhbi50eHQ6IHtlfSIpCgoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiY3QiKQpkZWYgY3QoY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgbmjhuqVuIHbDoG8gY2FsbGJhY2sgJ2N0JyIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlID0gIiIiQ2h1eeG7g24geHUgdGhlbyBjw7ogcGjDoXA6Ci9jaHV5ZW4gW0lEIG5nxrDhu51pIG5o4bqtbl0gW3Phu5EgeHVdCgpWRDogL2NodXllbiAwOTg3NjU0MzIxIDEwMDAwMAoKPGI+UGjDrSBjaHV54buDbiBsw6AgNSUvbOG6p24sIG5nxrDhu51pIGNodXnhu4NuIGNo4buLdSBwaMOtLiBU4buRaSB0aGnhu4N1IDEuMDAwIHThu5FpIMSRYSAxMDAuMDAwPC9iPiIiIgoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PW1lc3NhZ2UsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZGJ1dHRvbigpLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgKQoKCiAgICBleGNlcHQgVGVsZWdyYW1FcnJvciBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB0cm9uZyBjYWxsYmFjayAnY3QnOiB7ZX0iKQoKZGVmIGlzX25ld191c2VyKHVzZXJfaWQ6IGludCkgLT4gYm9vbDoKICAgIHBhdGggPSAiRklMRS90dC50eHQiCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCiAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgaWYgbGluZS5zdHJpcCgpID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBwYXNzCiAgICByZXR1cm4gVHJ1ZQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WydjaHV5ZW4nXSkKZGVmIGNodXllbihtZXNzYWdlKToKICAgIHRyeToKICAgICAgICBzZW5kZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIHNlbmRlcl9mdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7c2VuZGVyX2Z1bGxuYW1lfSAoSUQ6IHtzZW5kZXJfaWR9KSDEkcOjIGfhu61pIGzhu4duaCBjaHV54buDbiB0aeG7gW4iKQoKICAgICAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHNlbmRlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHNlbmRlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGlzX25ld191c2VyKHNlbmRlcl9pZCk6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAiVMOibiB0aOG7pyBraMO0bmcgdGjhu4MgY2h1eeG7g24gdGnhu4FuIiwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGFyZ3MgPSBtZXNzYWdlLnRleHQuc3BsaXQoKVsxOl0KICAgICAgICBpZiBsZW4oYXJncykgIT0gMjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZWNlaXZlcl9pZCA9IGludChhcmdzWzBdKQogICAgICAgICAgICBhbW91bnQgPSBpbnQoYXJnc1sxXSkKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGlmIHNlbmRlcl9pZCA9PSByZWNlaXZlcl9pZDoKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJLaMO0bmcgdGjhu4MgY2h1eeG7g24gY2hvIGLhuqNuIHRow6JuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGN1b2NfY29uX3RoaWV1ID0gZ2V0X2N1b2NfY2FuX3RoaWV1KHNlbmRlcl9pZCkKICAgICAgICBpZiBjdW9jX2Nvbl90aGlldSA+IDA6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9ZiJC4bqhbiBj4bqnbiBjxrDhu6NjIHRow6ptIHtkaW5oZGFuZyhzdHIoY3VvY19jb25fdGhpZXUpKX0gxJHhu4MgY2h1eeG7g24gdGnhu4FuIgogICAgICAgICAgICApCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7c2VuZGVyX2lkfSBjw7JuIGPhuqduIGPGsOG7o2M6IHtjdW9jX2Nvbl90aGlldX0iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc2VuZGVyX2JhbGFuY2UgPSBnZXRfYmFsYW5jZShzZW5kZXJfaWQpCiAgICAgICAgZmVlID0gaW50KGFtb3VudCAqIDAuMDUpCiAgICAgICAgdG90YWxfYW1vdW50ID0gYW1vdW50ICsgZmVlCgogICAgICAgIGlmIHNlbmRlcl9iYWxhbmNlIDwgMTAwMCBvciBhbW91bnQgPCAxMDAwOgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlThu5FpIHRoaeG7g3UgMS4wMDAiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBhbW91bnQgPiAxMDAwMDA6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAiVOG7kWkgxJFhIDEwMC4wMDAiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBzZW5kZXJfYmFsYW5jZSA8IHRvdGFsX2Ftb3VudDoKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJT4buRIGTGsCBraMO0bmcgxJHhu6ciKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZWNlaXZlcl9pbmZvID0gYm90LmdldF9jaGF0KHJlY2VpdmVyX2lkKQogICAgICAgICAgICByZWNlaXZlcl9mdWxsbmFtZSA9IHJlY2VpdmVyX2luZm8uZmlyc3RfbmFtZQogICAgICAgICAgICBpZiByZWNlaXZlcl9pbmZvLmxhc3RfbmFtZToKICAgICAgICAgICAgICAgIHJlY2VpdmVyX2Z1bGxuYW1lICs9IGYiIHtyZWNlaXZlcl9pbmZvLmxhc3RfbmFtZX0iCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHJlY2VpdmVyX2JhbGFuY2UgPSBnZXRfYmFsYW5jZShyZWNlaXZlcl9pZCkKICAgICAgICB1cGRhdGVfdmljaGluaChzZW5kZXJfaWQsIHNlbmRlcl9iYWxhbmNlIC0gdG90YWxfYW1vdW50KQogICAgICAgIHVwZGF0ZV92aWNoaW5oKHJlY2VpdmVyX2lkLCByZWNlaXZlcl9iYWxhbmNlICsgYW1vdW50KQogICAgICAgIG1nZCA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoIjAxMjM0NTY3ODkiLCBrPTExKSkKICAgICAgICBwcmludChmIltERUJVR10gR2lhbyBk4buLY2ggY2h1eeG7g24geHUgdOG7qyB7c2VuZGVyX2Z1bGxuYW1lfSAoSUQ6IHtzZW5kZXJfaWR9KSDEkeG6v24ge3JlY2VpdmVyX2Z1bGxuYW1lfSAoSUQ6IHtyZWNlaXZlcl9pZH0pIHbhu5tpIE1HRCB7bWdkfSIpCgogICAgICAgIG1zZ19zZW5kZXIgPSBmIiIiCkLhuqFuIHbhu6thIGNodXnhu4NuIHRow6BuaCBjw7RuZyBz4buRIHh1OiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50KX0KUGjDrSBnaWFvIGThu4tjaDoge2Zvcm1hdF9iYWxhbmNlKGZlZSl9Ck5nxrDhu51pIE5o4bqtbjogW3tyZWNlaXZlcl9mdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17cmVjZWl2ZXJfaWR9KQpJRDogYHtyZWNlaXZlcl9pZH1gCgpNR0Q6IHttZ2R9Ci0gU+G7kSBkxrAgaGnhu4duIHThuqFpOiB7Zm9ybWF0X2JhbGFuY2UoZ2V0X2JhbGFuY2Uoc2VuZGVyX2lkKSl9CiIiIgogICAgICAgIG1zZ19yZWNlaXZlciA9IGYiIiIKVGFkYWEhIELhuqFuIHbhu6thIG5o4bqtbiB0aMOgbmggY8O0bmcgc+G7kSB4dToge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9Ck5nxrDhu51pIGfhu61pOiBbe3NlbmRlcl9mdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17c2VuZGVyX2lkfSkKSUQ6IGB7c2VuZGVyX2lkfWAKCk1HRDoge21nZH0KLSBT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShnZXRfYmFsYW5jZShyZWNlaXZlcl9pZCkpfSB4dQoiIiIKCiAgICAgICAgc2VudF9zZW5kZXIgPSBib3Quc2VuZF9tZXNzYWdlKHNlbmRlcl9pZCwgbXNnX3NlbmRlciwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHNlbnRfcmVjZWl2ZXIgPSBib3Quc2VuZF9tZXNzYWdlKHJlY2VpdmVyX2lkLCBtc2dfcmVjZWl2ZXIsIHBhcnNlX21vZGU9Ik1hcmtkb3duIikKCgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIHRow6BuaCBjw7RuZyBjaG8gbmfGsOG7nWkgZ+G7rWkgdsOgIG5nxrDhu51pIG5o4bqtbiwgTUdEOiB7bWdkfSIpCgogICAgICAgIG5vdGlmeWNodXllbihib3QsIHNlbmRlcl9pZCwgc2VuZGVyX2Z1bGxuYW1lLCByZWNlaXZlcl9pZCwgcmVjZWl2ZXJfZnVsbG5hbWUsIGFtb3VudCwgbWdkLCBBRE1JTikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRyb25nIGjDoG0gY2h1eWVuOiB7ZX0iKQoKaW1wb3J0IHRlbGVib3QKCmRlZiBub3RpZnljaHV5ZW4oCiAgICBjb250ZXh0LAogICAgc2VuZGVyX2lkLAogICAgc2VuZGVyX2Z1bGxuYW1lLAogICAgcmVjZWl2ZXJfaWQsCiAgICByZWNlaXZlcl9mdWxsbmFtZSwKICAgIGFtb3VudCwKICAgIG1nZCwKICAgIGFkbWluX2NoYXRfaWQ9Tm9uZSwgICAjIEdJ4buuIENITyBLSOG7jkkgTOG7lkkgOCBUSEFNIFPhu5Ag4oCTIEtIw5RORyBEw5lORwopOgogICAgIiIiCiAgICBH4butaSB0aMO0bmcgYsOhbyBjaHV54buDbiB0aeG7gW4gdsOgbyBncm91cCBhZG1pbiBD4buQIMSQ4buKTkg6IC0xMDAzMjQxMDAyNDc4CiAgICAoc3luYywgdGVsZWJvdCwgYuG7jyBxdWEgYWRtaW5fY2hhdF9pZCkKICAgICIiIgogICAgdHJ5OgogICAgICAgIHByaW50KAogICAgICAgICAgICBmIltERUJVR10gQuG6r3QgxJHhuqd1IGfhu61pIHRow7RuZyBiw6FvIGNodXnhu4NuIHRp4buBbiB04burIHtzZW5kZXJfZnVsbG5hbWV9IChJRDoge3NlbmRlcl9pZH0pICIKICAgICAgICAgICAgZiLEkeG6v24ge3JlY2VpdmVyX2Z1bGxuYW1lfSAoSUQ6IHtyZWNlaXZlcl9pZH0pLCBNR0Q9e21nZH0iCiAgICAgICAgKQoKICAgICAgICBBRE1JTl9CT1RfVE9LRU4gPSAiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIKICAgICAgICBERUZBVUxUX0FETUlOX0NIQVQgPSAtMTAwMzI0MTAwMjQ3OCAgIyDwn5SSIEPhu5AgxJDhu4pOSCBEVVkgTkjhuqRUCgogICAgICAgIGFkbWluX2JvdCA9IHRlbGVib3QuVGVsZUJvdChBRE1JTl9CT1RfVE9LRU4pCgogICAgICAgICMgPT09PT0gRklYIGFtb3VudCAoY8OzIHRo4buDIGzDoCBsaXN0IC8gdHVwbGUgLyBzdHIpID09PT09CiAgICAgICAgaWYgaXNpbnN0YW5jZShhbW91bnQsIChsaXN0LCB0dXBsZSkpOgogICAgICAgICAgICBhbW91bnQgPSBhbW91bnRbMF0gaWYgYW1vdW50IGVsc2UgMAoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFtb3VudCA9IGludChhbW91bnQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYW1vdW50ID0gaW50KGZsb2F0KHN0cihhbW91bnQpLnJlcGxhY2UoIiwiLCAiIikucmVwbGFjZSgiLiIsICIiKSkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBhbW91bnQgPSAwCiAgICAgICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CgogICAgICAgIGZlZSA9IGludChhbW91bnQgKiAwLjA1KQoKICAgICAgICBzZW5kZXJfbmFtZSA9IHNlbmRlcl9mdWxsbmFtZSBvciAiS2jDtG5nIHTDqm4iCiAgICAgICAgcmVjZWl2ZXJfbmFtZSA9IHJlY2VpdmVyX2Z1bGxuYW1lIG9yICJLaMO0bmcgdMOqbiIKCiAgICAgICAgbm90aWZpY2F0aW9uID0gKAogICAgICAgICAgICAiPGI+VEjDlE5HIELDgU8gQ0hVWeG7gk4gVEnhu4BOPC9iPlxuXG4iCiAgICAgICAgICAgIGYiTmfGsOG7nWkgY2h1eeG7g246IDxhIGhyZWY9J3RnOi8vdXNlcj9pZD17c2VuZGVyX2lkfSc+e3NlbmRlcl9uYW1lfTwvYT5cbiIKICAgICAgICAgICAgZiJJRCBDaHV54buDbjogPGNvZGU+e3NlbmRlcl9pZH08L2NvZGU+XG4iCiAgICAgICAgICAgIGYiU+G7kSB0aeG7gW46IHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfVxuIgogICAgICAgICAgICBmIlBow60gZ2lhbyBk4buLY2g6IHtmb3JtYXRfYmFsYW5jZShmZWUpfVxuXG4iCiAgICAgICAgICAgIGYiTmfGsOG7nWkgbmjhuq1uOiA8YSBocmVmPSd0ZzovL3VzZXI/aWQ9e3JlY2VpdmVyX2lkfSc+e3JlY2VpdmVyX25hbWV9PC9hPlxuIgogICAgICAgICAgICBmIklEIE5o4bqtbjogPGNvZGU+e3JlY2VpdmVyX2lkfTwvY29kZT5cbiIKICAgICAgICAgICAgZiJNR0Q6IDxjb2RlPnttZ2R9PC9jb2RlPiIKICAgICAgICApCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBO4buZaSBkdW5nIHRow7RuZyBiw6FvOlxue25vdGlmaWNhdGlvbn0iKQoKICAgICAgICBhZG1pbl9ib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPURFRkFVTFRfQURNSU5fQ0hBVCwKICAgICAgICAgICAgdGV4dD1ub3RpZmljYXRpb24sCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiLAogICAgICAgICAgICBkaXNhYmxlX3dlYl9wYWdlX3ByZXZpZXc9VHJ1ZQogICAgICAgICkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gY2h1eeG7g24gdGnhu4FuIHbDoG8gZ3JvdXAge0RFRkFVTFRfQURNSU5fQ0hBVH0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIGNodXnhu4NuIHRp4buBbjoge2V9IikKCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJtZyIpCmRlZiBtZyhjYWxsKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gc3RyKGNhbGwuZnJvbV91c2VyLmlkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gecOqdSBj4bqndSB0aMO0bmcgdGluIHbhu4EgZ2lmdGNvZGUuIikKCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLCBraMO0bmcgdGjhu4MgdGjhu7FjIGhp4buHbiB5w6p1IGPhuqd1LiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlID0gIiIiQuG6oW4gY8OzIHRo4buDIG11YSBnaWZ0Y29kZSBi4bqxbmcgY8OhY2ggY2hhdCBs4buHbmggc2F1IGfhu61pIGNobyBCb3QKU+G7kSBsxrDhu6NuZyBHaWZ0Y29kZSB04buRaSB0aGnhu4N1IGzDoCAxLCBnacOhIHRy4buLIHThu5FpIHRoaeG7g3UgbMOgIDEuMDAwL2dpZnQKPGI+L211YWdpZnQgW3Phu5EgbMaw4bujbmcgZ2lmdGNvZGVdIFtz4buRIHRp4buBbiBt4buXaSBnaWZ0Y29kZV08L2I+CgpWRDogL211YWdpZnQgNSA1MDAwCjxiPlBow60gbXVhIGdpZnQgbMOgIDEwJS9s4bqnbiBu4bq/dSBHaWZ0Y29kZSBnacOhIHRy4buLIGTGsOG7m2kgNS4wMDAgbmfGsOG7nWkgbXVhIGNo4buLdSBwaMOtLCB0csOqbiA1LjAwMCBraMO0bmcgbeG6pXQgcGjDrTwvYj4iIiIKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE7hu5lpIGR1bmcgdGjDtG5nIGLDoW86XG57bWVzc2FnZX0iKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PW1lc3NhZ2UsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZGJ1dHRvbigpLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgKQoKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHRy4bqjIGzhu51pIHnDqnUgY+G6p3UgY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LiIpCgogICAgZXhjZXB0IFRlbGVncmFtRXJyb3IgYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IHnDqnUgY+G6p3UgZ2lmdGNvZGUgdOG7qyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCgpkZWYgbG9nX2dpZnRjb2RlX3RvX2ZpbGUoZ2lmdGNvZGUsIGFtb3VudCk6CiAgICB1dGNfdGltZSA9IGR0LmRhdGV0aW1lLnV0Y25vdygpLnN0cmZ0aW1lKCIlSDolTTolUyAlZC0lbS0lWSIpCiAgICB2aWV0bmFtX3RpbWUgPSBjb252ZXJ0X3V0Y190b192aWV0bmFtKHV0Y190aW1lKQogICAgdGltZXN0YW1wID0gdmlldG5hbV90aW1lLnN0cmZ0aW1lKCIlSDolTTolUyAlZC8lbS8lWSIpCiAgICBwcmludChmIltERUJVR10gR2hpIGdpZnRjb2RlIHbDoG8gZmlsZToge2dpZnRjb2RlfSB8IHthbW91bnR9IHwge3RpbWVzdGFtcH0gfCAxIikKICAgIHdpdGggb3BlbigiRklMRS9naWZ0LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICBmaWxlLndyaXRlKGYie2dpZnRjb2RlfSB8IHthbW91bnR9IHwge3RpbWVzdGFtcH0gfCAxXG4iKQoKZGVmIGNvbnZlcnRfdXRjX3RvX3ZpZXRuYW0odXRjX3RpbWU6IHN0cikgLT4gZHQuZGF0ZXRpbWU6CiAgICB1dGNfZHQgPSBkdC5kYXRldGltZS5zdHJwdGltZSh1dGNfdGltZSwgIiVIOiVNOiVTICVkLSVtLSVZIikKICAgIHZpZXRuYW1fdHogPSB0aW1lem9uZSh0aW1lZGVsdGEoaG91cnM9NykpCiAgICB2aWV0bmFtX2R0ID0gdXRjX2R0LnJlcGxhY2UodHppbmZvPXRpbWV6b25lLnV0YykuYXN0aW1lem9uZSh2aWV0bmFtX3R6KQogICAgcmV0dXJuIHZpZXRuYW1fZHQKCmRlZiByYW5kb21tZ2QoKToKICAgIHJhbmRvbV9jb2RlID0gJycuam9pbihyYW5kb20uY2hvaWNlcyhzdHJpbmcuYXNjaWlfdXBwZXJjYXNlICsgc3RyaW5nLmRpZ2l0cywgaz04KSkKICAgIHByaW50KGYiW0RFQlVHXSBU4bqhbyBNR0Qgbmfhuqt1IG5oacOqbjoge3JhbmRvbV9jb2RlfSIpCiAgICByZXR1cm4gcmFuZG9tX2NvZGUKCmRlZiBnZW5lcmF0ZV9naWZ0Y29kZSgpOgogICAgcmFuZG9tX3N0cmluZyA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX3VwcGVyY2FzZSwgaz05KSkKICAgIGdpZnRjb2RlID0gZiJUSU5ITElOSHtyYW5kb21fc3RyaW5nfSIKICAgIHJldHVybiBnaWZ0Y29kZQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoY29tbWFuZHM9WydtdWFnaWZ0J10pCmRlZiBtdWFnaWZ0KG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBmdWxsbmFtZSA9IG1lc3NhZ2UuZnJvbV91c2VyLmZ1bGxfbmFtZQoKICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgIHJldHVybgogICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgcmV0dXJuCiAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgcmV0dXJuCiAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4KICAgIGlmIGlzX25ld191c2VyKHVzZXJfaWQpOgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PSJUw6JuIHRo4bunIGtow7RuZyB0aOG7gyBtdWEgR2lmdGNvZGUiLAogICAgICAgICAgICByZXBseV9tYXJrdXA9a2V5Ym9hcmRidXR0b24oKSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKCiAgICAgICAgcmV0dXJuCgogICAgY3VvY19jb25fdGhpZXUgPSBnZXRfY3VvY19jYW5fdGhpZXUodXNlcl9pZCkKICAgIGlmIGN1b2NfY29uX3RoaWV1ID4gMDoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD1mIkLhuqFuIGPhuqduIGPGsOG7o2MgdGjDqm0ge2RpbmhkYW5nKHN0cihjdW9jX2Nvbl90aGlldSkpfSDEkeG7gyBtdWEgY29kZSIKICAgICAgICApCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBjw7JuIGPhuqduIGPGsOG7o2M6IHtjdW9jX2Nvbl90aGlldX0iKQoKICAgICAgICByZXR1cm4KCiAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnNwbGl0KCkKICAgIGlmIGxlbihhcmdzKSAhPSAzOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBxdWFudGl0eSA9IGludChhcmdzWzFdKQogICAgICAgIGFtb3VudF9wZXJfZ2lmdGNvZGUgPSBpbnQoYXJnc1syXSkKICAgICAgICBpZiBhbW91bnRfcGVyX2dpZnRjb2RlIDwgMTAwMDoKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iVOG7kWkgdGhp4buDdSAxLjAwMCAiKQoKICAgICAgICAgICAgcmV0dXJuCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICByZXR1cm4KCiAgICB1c2VyX2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkKQoKICAgIGlmIGFtb3VudF9wZXJfZ2lmdGNvZGUgPCA1MDAwOgogICAgICAgIHRvdGFsX2Nvc3QgPSBpbnQocXVhbnRpdHkgKiBhbW91bnRfcGVyX2dpZnRjb2RlICogMS4xKQogICAgICAgIGZlZSA9IHRvdGFsX2Nvc3QgLSAocXVhbnRpdHkgKiBhbW91bnRfcGVyX2dpZnRjb2RlKQogICAgZWxzZToKICAgICAgICB0b3RhbF9jb3N0ID0gcXVhbnRpdHkgKiBhbW91bnRfcGVyX2dpZnRjb2RlCiAgICAgICAgZmVlID0gMAoKICAgIHByaW50KGYiW0RFQlVHXSBT4buRIGTGsCBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHt1c2VyX2JhbGFuY2V9LCB04buVbmcgY2hpIHBow606IHt0b3RhbF9jb3N0fSwgcGjDrToge2ZlZX0iKQoKICAgIGlmIHVzZXJfYmFsYW5jZSA9PSAwIG9yIHVzZXJfYmFsYW5jZSA8IDEwMDA6CiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iU+G7kSBkxrAga2jDtG5nIMSR4bunIikKICAgICAgICByZXR1cm4KCiAgICBpZiB1c2VyX2JhbGFuY2UgPCB0b3RhbF9jb3N0OgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0PWYiQuG6oW4gY2jhu4kgbXVhIMSRxrDhu6NjIHtmb3JtYXRfYmFsYW5jZSh1c2VyX2JhbGFuY2UpfSIpCgogICAgICAgIHJldHVybgoKICAgIGlmIHF1YW50aXR5IDwgMToKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PSJU4buRaSB0aGnhu4N1IDEgbcOjIikKCiAgICAgICAgcmV0dXJuCgogICAgaWYgcXVhbnRpdHkgPiAxMDAwMDA6CiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD0iVOG7kWkgxJFhIDEwMC4wMDAgbeG7l2kgbcOjIikKCiAgICAgICAgcmV0dXJuCgogICAgaWYgcXVhbnRpdHkgPiA1OgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9IlThu5FpIMSRYSA1IG3DoyIpCgogICAgICAgIHJldHVybgoKICAgIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWQsIHVzZXJfYmFsYW5jZSAtIHRvdGFsX2Nvc3QpCiAgICBnaWZ0Y29kZXMgPSBbZ2VuZXJhdGVfZ2lmdGNvZGUoKSBmb3IgXyBpbiByYW5nZShxdWFudGl0eSldCiAgICBnaWZ0Y29kZXNfdGV4dCA9ICJcbiIuam9pbihbZiJgL2dpZnQge2NvZGV9YCB0cuG7iyBnacOhOiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3Blcl9naWZ0Y29kZSl9IHh1IiBmb3IgY29kZSBpbiBnaWZ0Y29kZXNdKQogICAgcHJpbnQoZiJbREVCVUddIFThuqFvIHtxdWFudGl0eX0gbcOjIGdpZnRjb2RlOiB7Z2lmdGNvZGVzfSIpCgogICAgZm9yIGdpZnRjb2RlIGluIGdpZnRjb2RlczoKICAgICAgICBsb2dfZ2lmdGNvZGVfdG9fZmlsZShnaWZ0Y29kZSwgYW1vdW50X3Blcl9naWZ0Y29kZSkKCiAgICBuZXdfYmFsYW5jZSA9IHVzZXJfYmFsYW5jZSAtIHRvdGFsX2Nvc3QKCiAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgIGNoYXRfaWQ9dXNlcl9pZCwKICAgICAgICB0ZXh0PWYiQuG6oW4gxJHDoyBtdWEgdGjDoG5oIGPDtG5nIHtxdWFudGl0eX0gbcOjIGNvZGVcblxue2dpZnRjb2Rlc190ZXh0fVxuXG4iCiAgICAgICAgICAgICBmIlBow60gZ2lhbyBk4buLY2g6IHtmb3JtYXRfYmFsYW5jZShmZWUpfVxuIgogICAgICAgICAgICAgZiJT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IiwKICAgICAgICBwYXJzZV9tb2RlPSJNYXJrZG93biIsCiAgICAgICAgcmVwbHlfbWFya3VwPWdldF9yZXBseV9rZXlib2FyZCgpCiAgICApCgoKICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG11YSBnaWZ0Y29kZSBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LCBz4buRIGTGsCBjw7JuIGzhuqFpOiB7bmV3X2JhbGFuY2V9IikKCiAgICBhZG1pbmR6KHVzZXJfaWQsIGZ1bGxuYW1lLCBxdWFudGl0eSwgYW1vdW50X3Blcl9naWZ0Y29kZSwgbmV3X2JhbGFuY2UsIEFETUlOKQogICAgbm90aWZ5X211YWdpZnQodXNlcl9pZCwgcXVhbnRpdHksIGFtb3VudF9wZXJfZ2lmdGNvZGUsIEdST1VQKQoKZGVmIG5vdGlmeV9tdWFnaWZ0KHVzZXJfaWQsIHF1YW50aXR5LCBhbW91bnRfcGVyX2dpZnRjb2RlLCBncm91cF9jaGF0X2lkKToKICAgIHRvdGFsX3B1cmNoYXNlID0gcXVhbnRpdHkgKiBhbW91bnRfcGVyX2dpZnRjb2RlCiAgICBtZXNzYWdlID0gZiLwn46BIEFpIMSRw7MgduG7q2EgbXVhIHRow6BuaCBjw7RuZyB7cXVhbnRpdHl9IGdpZnQgY29kZSwgbeG7l2kgY29kZSB0cuG7iyBnacOhIHtmb3JtYXRfYmFsYW5jZShhbW91bnRfcGVyX2dpZnRjb2RlKX0geHUiCiAgICBwcmludChmIltERUJVR10gVGjDtG5nIGLDoW8gbXVhIGdpZnRjb2RlOiBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gbXVhIHtxdWFudGl0eX0gZ2lmdCBjb2RlLCB04buVbmcgdHLhu4sgZ2nDoSB7Zm9ybWF0X2JhbGFuY2UodG90YWxfcHVyY2hhc2UpfSB4dSIpCiAgICB0cnk6CiAgICAgICAgdXNlcl9ib3QgPSB0ZWxlYm90LlRlbGVCb3QoIjgyMzQ1NTcyNDY6QUFIdGk0S2tMbWE0NVdkNzd5NllXalZvQ0pPZGs3NTFkaUUiKQogICAgICAgIHVzZXJfYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPS0xMDAzNTg5OTQyMjg3LHRleHQ9bWVzc2FnZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgZ+G7rWkgbm90aWZ5X211YWdpZnQ6IHtlfSIpCgpkZWYgYWRtaW5keih1c2VyX2lkLCBmdWxsbmFtZSwgcXVhbnRpdHksIGFtb3VudF9wZXJfZ2lmdGNvZGUsIG5ld19iYWxhbmNlLCBBRE1JTik6CiAgICB0cmFuc2FjdGlvbl9pZCA9IHJhbmRvbW1nZCgpCiAgICBtZXNzYWdlID0gKAogICAgICAgIGYi8J+OgSBUSMOUTkcgQsOBTyBNVUEgQ09ERVxuIgogICAgICAgIGYi8J+RpCBOZ8aw4budaSBkw7luZzogW3tmdWxsbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pXG4iCiAgICAgICAgZiLwn4aUIElEOiBge3VzZXJfaWR9YFxuIgogICAgICAgIGYi8J+SsyBNdWE6IHtxdWFudGl0eX0gbcOjIGNvZGVcbiIKICAgICAgICBmIvCfkrAgU+G7kSB0aeG7gW46IHtmb3JtYXRfYmFsYW5jZShhbW91bnRfcGVyX2dpZnRjb2RlKX0geHVcbiIKICAgICAgICBmIvCfhpQgTUdEOiBge3RyYW5zYWN0aW9uX2lkfWBcbiIKICAgICAgICBmIvCfkrUgU+G7kSBkxrAgbeG7m2k6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1IikKICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgYsOhbyBjaG8gQWRtaW4gduG7gSBnaWFvIGThu4tjaDoge21lc3NhZ2V9IikKICAgIGFkbWluX2JvdCA9IHRlbGVib3QuVGVsZUJvdCgiODA3OTMxNzAzNzpBQUZLMHRodGJPVGQwVmd5WnlBMTFWckUzZUo1eVBQNnV0WSIpCiAgICBhZG1pbl9ib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9LTEwMDMyNDEwMDI0NzgsdGV4dD1tZXNzYWdlLHBhcnNlX21vZGU9Ik1hcmtkb3duIikKCmRlZiBnZXRfcmVwbHlfa2V5Ym9hcmQoKToKICAgIG1hcmt1cCA9IHR5cGVzLlJlcGx5S2V5Ym9hcmRNYXJrdXAocmVzaXplX2tleWJvYXJkPVRydWUpCiAgICBtYXJrdXAucm93KHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn46yIERhbmggc8OhY2ggR2FtZSIpLCB0eXBlcy5LZXlib2FyZEJ1dHRvbigi8J+RpCBUw6BpIEtob+G6o24iKSkKICAgIG1hcmt1cC5yb3codHlwZXMuS2V5Ym9hcmRCdXR0b24oIvCfkrUgTuG6oXAgdGnhu4FuIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn5K4IFLDunQgdGnhu4FuIikpCiAgICBtYXJrdXAucm93KHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn46WIEJYSCDwn46WIiksIHR5cGVzLktleWJvYXJkQnV0dG9uKCLwn4y6IEhvYSBI4buTbmciKSkKCiAgICAjIExvZyB2aeG7h2MgdOG6oW8gYsOgbiBwaMOtbSB0cuG6oyBs4budaQogICAgcHJpbnQoIltERUJVR10gxJDDoyB04bqhbyBiw6BuIHBow61tIHRy4bqjIGzhu51pIikKCiAgICByZXR1cm4gbWFya3VwCgpkZWYgY3VvY3RpZW52MSh1c2VyX2lkLCBhbW91bnQpOgogICAgIiIiQ+G7mW5nIHRow6ptIHPhu5EgdGnhu4FuIGPGsOG7o2MgdsOgbyBGSUxFL2N1b2N0aWVuLnR4dCIiIgogICAgZmlsZV9wYXRoID0gIkZJTEUvY3VvY3RpZW4udHh0IgogICAgdXBkYXRlZCA9IEZhbHNlCiAgICBsaW5lcyA9IFtdCgogICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdWlkLCB2YWwgPSBwYXJ0cwogICAgICAgICAgICAgICAgaWYgdWlkID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICBuZXdfdG90YWwgPSBpbnQodmFsKSArIGFtb3VudAogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1aWR9IHtuZXdfdG90YWx9IikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dWlkfSB7dmFsfSIpCgogICAgaWYgbm90IHVwZGF0ZWQ6CiAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHthbW91bnR9IikKCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIGYud3JpdGUobGluZSArICJcbiIpCgogICAgI2lmIGlzX25ld191c2VyKHVzZXJfaWQpOgogICAgICAgICNtc2cgPSBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLHRleHQ9IlTDom4gdGjhu6cga2jDtG5nIHRo4buDIG5o4bqtcCBHaWZ0Y29kZSIscmVwbHlfbWFya3VwPWtleWJvYXJkYnV0dG9uKCkscGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICAjbHV1dmF4b2F0bihtc2cpCiAgICAgICAgI2x1dXZheG9hdG4obWVzc2FnZSkKCkBib3QubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnZ2lmdCddKQpkZWYgZ2lmdChtZXNzYWdlKToKICAgIGltcG9ydCByZXF1ZXN0cwogICAgaW1wb3J0IGpzb24KICAgIGltcG9ydCB0aW1lCiAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQogICAgaW1wb3J0IHB5dHoKCiAgICAjIE7hur91IGLhuqFuIMSRw6Mga2hhaSBiw6FvIGPDoWMgdG9rZW4gbsOgeSDhu58gZmlsZSBuZ2/DoGkgdGjDrCBi4buPIDIgZMOybmcgZMaw4bubaQogICAgT1RIRVJfQk9UX1RPS0VOID0gIjgwNzkzMTcwMzc6QUFGSzB0aHRiT1RkMFZneVp5QTExVnJFM2VKNXlQUDZ1dFkiCiAgICBCT1QxX1RPS0VOID0gIjgyMzQ1NTcyNDY6QUFIdGk0S2tMbWE0NVdkNzd5NllXalZvQ0pPZGs3NTFkaUUiCgogICAgZGVmIHNlbmRfbm90aWZ5KGJvdF90b2tlbiwgY2hhdF9pZCwgdGV4dCwgcGFyc2VfbW9kZT0iSFRNTCIsIHJlcGx5X21hcmt1cD1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBH4butaSBtZXNzYWdlIHF1YSBUZWxlZ3JhbSBCb3QgQVBJIChyZXF1ZXN0cykgLSB0cuG6oyB24buBIGRpY3QgSlNPTiBr4bq/dCBxdeG6oy4KICAgICAgICAiIiIKICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7Ym90X3Rva2VufS9zZW5kTWVzc2FnZSIKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAiY2hhdF9pZCI6IGNoYXRfaWQsCiAgICAgICAgICAgICJ0ZXh0IjogdGV4dCwKICAgICAgICAgICAgInBhcnNlX21vZGUiOiBwYXJzZV9tb2RlCiAgICAgICAgfQogICAgICAgIGlmIHJlcGx5X21hcmt1cCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcGF5bG9hZFsicmVwbHlfbWFya3VwIl0gPSBqc29uLmR1bXBzKHJlcGx5X21hcmt1cCwgZW5zdXJlX2FzY2lpPUZhbHNlKQogICAgICAgIHRyeToKICAgICAgICAgICAgciA9IHJlcXVlc3RzLnBvc3QodXJsLCBkYXRhPXBheWxvYWQsIHRpbWVvdXQ9NikKICAgICAgICAgICAgcmV0dXJuIHIuanNvbigpIGlmIHIub2sgZWxzZSB7Im9rIjogRmFsc2UsICJlcnJvciI6IHIudGV4dH0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGV4OgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgc2VuZF9ub3RpZnk6IHtleH0iKQogICAgICAgICAgICByZXR1cm4geyJvayI6IEZhbHNlLCAiZXJyb3IiOiBzdHIoZXgpfQoKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSB5w6p1IGPhuqd1IG5o4bqtbiBxdcOgIHbhu5tpIG7hu5lpIGR1bmc6IHttZXNzYWdlLnRleHR9IikKCiAgICAjIChnaeG7ryBuZ3V5w6puIGPDoWMga2nhu4NtIHRyYSBiYW4gLyBzcGFtIC8gZm9yd2FyZCkKICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlIG9yIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgIHJldHVybgogICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCkgb3IgY2hlY2tfc3BhbShtZXNzYWdlKSBvciBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICByZXR1cm4KCiAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgaWYgdXNlcl9pZCBpbiB1c2VyX2xhc3RfZ2lmdF90aW1lOgogICAgICAgIHRpbWVfc2luY2VfbGFzdF9naWZ0ID0gY3VycmVudF90aW1lIC0gdXNlcl9sYXN0X2dpZnRfdGltZVt1c2VyX2lkXQogICAgICAgIGlmIHRpbWVfc2luY2VfbGFzdF9naWZ0IDwgMTIwOgogICAgICAgICAgICByZW1haW5pbmdfdGltZSA9IGludCgxMjAgLSB0aW1lX3NpbmNlX2xhc3RfZ2lmdCkKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD1mIkLhuqFuIHbhu6thIGjhu5FjIGNvZGUgeG9uZywgY+G6p24gxJHhu6NpIHRow6ptIHtyZW1haW5pbmdfdGltZX0gZ2nDonkgbuG7r2EgbeG7m2kgY8OzIHRo4buDIGjhu5FjIGNvZGUgdGnhur9wIHRoZW8iLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPWdldF9yZXBseV9rZXlib2FyZCgpCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIG1lc3NhZ2VfdGV4dCA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpCiAgICAgICAgaWYgbm90IG1lc3NhZ2VfdGV4dC5zdGFydHN3aXRoKCcvZ2lmdCAnKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHF1ZXJ5ID0gbWVzc2FnZV90ZXh0LnNwbGl0KG1heHNwbGl0PTEpCiAgICAgICAgaWYgbGVuKHF1ZXJ5KSAhPSAyOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZ2lmdF9jb2RlID0gcXVlcnlbMV0uc3RyaXAoKQogICAgICAgIGNvZGVfZm91bmQgPSBGYWxzZQogICAgICAgIGFtb3VudF9yZWNlaXZlZCA9IDAKICAgICAgICB1cGRhdGVkX2xpbmVzID0gW10KCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2dpZnQudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICBsaW5lcyA9IGZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCIgfCAiKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDQgYW5kIHBhcnRzWzBdID09IGdpZnRfY29kZToKICAgICAgICAgICAgICAgIHJlbWFpbmluZ191c2VzID0gaW50KHBhcnRzWzNdKQogICAgICAgICAgICAgICAgaWYgcmVtYWluaW5nX3VzZXMgPiAwOgogICAgICAgICAgICAgICAgICAgIGFtb3VudF9yZWNlaXZlZCA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICBuZXdfbGluZSA9IGYie3BhcnRzWzBdfSB8IHtwYXJ0c1sxXX0gfCB7cGFydHNbMl19IHwge3JlbWFpbmluZ191c2VzIC0gMX1cbiIKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChuZXdfbGluZSkKICAgICAgICAgICAgICAgICAgICBjb2RlX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dD0iTcOjIGNvZGUgxJHDoyBo4bq/dCBsxrDhu6N0IGhv4bq3YyBraMO0bmcgdOG7k24gdOG6oWkiLAogICAgICAgICAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9Z2V0X3JlcGx5X2tleWJvYXJkKCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1cGRhdGVkX2xpbmVzLmFwcGVuZChsaW5lKQoKICAgICAgICBpZiBjb2RlX2ZvdW5kOgogICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkKQogICAgICAgICAgICB1cGRhdGVkX2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgKyBhbW91bnRfcmVjZWl2ZWQKICAgICAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgdXBkYXRlZF9iYWxhbmNlKQoKICAgICAgICAgICAgIyBD4buZbmcgdGnhu4FuIGPGsOG7o2MgZ+G6pXAgMTAgbOG6p24gZ2nDoSB0cuG7iyBjb2RlCiAgICAgICAgICAgICMgY3VvY3RpZW52MSh1c2VyX2lkLCBhbW91bnRfcmVjZWl2ZWQgKiAxMCkKICAgICAgICAgICAgY3VvY3RpZW52MSh1c2VyX2lkLCBhbW91bnRfcmVjZWl2ZWQpCiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9naWZ0LnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgICAgIGZpbGUud3JpdGVsaW5lcyh1cGRhdGVkX2xpbmVzKQoKICAgICAgICAgICAgZm9ybWF0dGVkX2Ftb3VudCA9IGZvcm1hdF9iYWxhbmNlKGFtb3VudF9yZWNlaXZlZCkKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD1mIiIiCkNow7pjIG3hu6tuZyBi4bqhbiDEkcOjIG5o4bqtbiDEkcaw4bujYyBxdcOgOiB7Zm9ybWF0dGVkX2Ftb3VudH0geHUKU+G7kSBkxrAgbeG7m2k6IHtmb3JtYXRfYmFsYW5jZSh1cGRhdGVkX2JhbGFuY2UpfQoiIiIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPWdldF9yZXBseV9rZXlib2FyZCgpCiAgICAgICAgICAgICkKCiAgICAgICAgICAgIHVzZXJfbGFzdF9naWZ0X3RpbWVbdXNlcl9pZF0gPSBjdXJyZW50X3RpbWUKCiAgICAgICAgICAgIGZ1bGxuYW1lID0gbWVzc2FnZS5mcm9tX3VzZXIuZnVsbF9uYW1lCiAgICAgICAgICAgIGN1cnJlbnRfdm5fdGltZSA9IGRhdGV0aW1lLm5vdyhweXR6LnRpbWV6b25lKCJBc2lhL0hvX0NoaV9NaW5oIikpLnN0cmZ0aW1lKCIlSDolTTolUyAlZC0lbS0lWSIpCgogICAgICAgICAgICAjIC0tLSBH4butaSB0aMO0bmcgYsOhbyB04bubaSAyIGNoYW5uZWwvYm90IGLhurFuZyBBUEkgKGTDuW5nIDEgaMOgbSBzZW5kX25vdGlmeSkgLS0tCiAgICAgICAgICAgIG5vdGlmeV90ZXh0XzEgPSAoCiAgICAgICAgICAgICAgICBmIjxiPlRow7RuZyBiw6FvIG5o4bqtcCBjb2RlPC9iPlxuIgogICAgICAgICAgICAgICAgZiLwn5GkIE5nxrDhu51pIGTDuW5nOiA8YSBocmVmPSd0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9Jz57ZnVsbG5hbWV9PC9hPlxuIgogICAgICAgICAgICAgICAgZiLwn4aUIElEOiA8Y29kZT57dXNlcl9pZH08L2NvZGU+XG4iCiAgICAgICAgICAgICAgICBmIvCflJEgQ29kZTogPGNvZGU+e2dpZnRfY29kZX08L2NvZGU+XG4iCiAgICAgICAgICAgICAgICBmIvCfkrAgU+G7kSB0aeG7gW46IHtmb3JtYXR0ZWRfYW1vdW50fSB4dVxuIgogICAgICAgICAgICAgICAgZiLij7AgVGjhu51pIGdpYW46IHtjdXJyZW50X3ZuX3RpbWV9IgogICAgICAgICAgICApCgogICAgICAgICAgICBub3RpZnlfdGV4dF8yID0gKAogICAgICAgICAgICAgICAgZiJOZ8aw4budaSBjaMahaSBJRDogPGEgaHJlZj0ndGc6Ly91c2VyP2lkPXt1c2VyX2lkfSc+e3VzZXJfaWR9IC0ge2Z1bGxuYW1lfTwvYT5cbiIKICAgICAgICAgICAgICAgIGYixJDDoyBuaOG6rW4gcXXDoCB04burIG3DoyBjb2RlIDxiPntnaWZ0X2NvZGV9PC9iPiB0aMOgbmggY8O0bmcgdsOgIG5o4bqtbiA8Yj57Zm9ybWF0dGVkX2Ftb3VudH08L2I+IHh1IgogICAgICAgICAgICApCgogICAgICAgICAgICAjIEfhu61pIHThu5tpIGNoYW5uZWwvZ3JvdXAgMSAodsOtIGThu6UgLTEwMDMyNDEwMDI0NzgpIGLhurFuZyBPVEhFUl9CT1RfVE9LRU4KICAgICAgICAgICAgcmVzMSA9IHNlbmRfbm90aWZ5KE9USEVSX0JPVF9UT0tFTiwgIi0xMDAzMjQxMDAyNDc4Iiwgbm90aWZ5X3RleHRfMSkKICAgICAgICAgICAgaWYgbm90IHJlczEuZ2V0KCJvayIpOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEfhu61pIG5vdGlmeTEgdGjhuqV0IGLhuqFpOiB7cmVzMX0iKQoKICAgICAgICAgICAgIyBH4butaSB04bubaSBjaGFubmVsL2dyb3VwIDIgKHbDrSBk4bulIC0xMDAzNTg5OTQyMjg3KSBi4bqxbmcgQk9UMV9UT0tFTgogICAgICAgICAgICByZXMyID0gc2VuZF9ub3RpZnkoQk9UMV9UT0tFTiwgIi0xMDAzNTg5OTQyMjg3Iiwgbm90aWZ5X3RleHRfMikKICAgICAgICAgICAgaWYgbm90IHJlczIuZ2V0KCJvayIpOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEfhu61pIG5vdGlmeTIgdGjhuqV0IGLhuqFpOiB7cmVzMn0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IC9naWZ0OiB7ZX0iKQoKCgpkZWYgZml4c2QoYW1vdW50KToKICAgIHJldHVybiAiezosLjBmfSIuZm9ybWF0KGFtb3VudCkucmVwbGFjZSgiLCIsICIuIikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gImxzbiIpCmRlZiBsc24oY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgecOqdSBj4bqndSB4ZW0gbOG7i2NoIHPhu60gbuG6oXAgdGnhu4FuLiIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBj4bqlbSB0cnV5IGPhuq1wLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB1c2VyX25hcF9pbmZvID0gW10KCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzbmFwLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgbmFwX2ZpbGU6CiAgICAgICAgICAgIGxpbmVzID0gbmFwX2ZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQ4buNYyBk4buvIGxp4buHdSB04burIGZpbGUgJ0ZJTEUvbHNuYXAudHh0Jy4iKQoKICAgICAgICB2bl90aW1lem9uZSA9IHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKQogICAgICAgIHV0Y190aW1lem9uZSA9IHB5dHoudGltZXpvbmUoJ1VUQycpCgogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiIC0gIikKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDQ6CiAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgbGluZV91c2VyX2lkID0gcGFydHNbMF0uc3RyaXAoKQogICAgICAgICAgICBpZiBsaW5lX3VzZXJfaWQgPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgIGRhdGVfc3RyID0gcGFydHNbMV0KICAgICAgICAgICAgICAgIGtlbmhfbmFwID0gcGFydHNbMl0KICAgICAgICAgICAgICAgIGFtb3VudF9zdHIgPSBwYXJ0c1szXS5yZXBsYWNlKCIuIiwgIiIpCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGR0X29iaiA9IGRhdGV0aW1lLnN0cnB0aW1lKGRhdGVfc3RyLCAiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgICAgICAgICAgICAgICAgIGR0X29iaiA9IHV0Y190aW1lem9uZS5sb2NhbGl6ZShkdF9vYmopCiAgICAgICAgICAgICAgICAgICAgZHRfb2JqX3ZuID0gZHRfb2JqLmFzdGltZXpvbmUodm5fdGltZXpvbmUpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF90aW1lX3N0ciA9IGR0X29ial92bi5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBleDoKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgcGFyc2UgdGjhu51pIGdpYW46IHtleH0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGFtb3VudF9pbnQgPSBpbnQoYW1vdW50X3N0cikKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBhbW91bnRfaW50ID0gMAoKICAgICAgICAgICAgICAgIHVzZXJfbmFwX2luZm8uYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAna2VuaF9uYXAnOiBrZW5oX25hcCwKICAgICAgICAgICAgICAgICAgICAnYW1vdW50JzogYW1vdW50X2ludCwKICAgICAgICAgICAgICAgICAgICAnY3VycmVudF90aW1lJzogY3VycmVudF90aW1lX3N0cgogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgaWYgbm90IHVzZXJfbmFwX2luZm86CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgY8OzIHRow7RuZyB0aW4gbuG6oXAgdGnhu4FuIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHVzZXJfbmFwX2luZm8uc29ydChrZXk9bGFtYmRhIHg6IGRhdGV0aW1lLnN0cnB0aW1lKHhbJ2N1cnJlbnRfdGltZSddLCAiJWQvJW0vJVkgJUg6JU06JVMiKSwgcmV2ZXJzZT1UcnVlKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIHTDrG0gdGjhuqV5IHtsZW4odXNlcl9uYXBfaW5mbyl9IGdpYW8gZOG7i2NoIG7huqFwIHRp4buBbiBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LiIpCgogICAgICAgIHJlcGx5ID0gIlRo4budaSBnaWFuICAgICAgICAgICB8IEvDqm5oIG7huqFwIHwgU+G7kSB0aeG7gW5cblxuIgogICAgICAgIGZvciBuYXBfaW5mbyBpbiB1c2VyX25hcF9pbmZvWzoyMF06CiAgICAgICAgICAgIGtlbmhfbmFwID0gbmFwX2luZm9bJ2tlbmhfbmFwJ10KICAgICAgICAgICAgYW1vdW50X2Zvcm1hdHRlZCA9IGZpeHNkKG5hcF9pbmZvWydhbW91bnQnXSkKICAgICAgICAgICAgY3VycmVudF90aW1lID0gbmFwX2luZm9bJ2N1cnJlbnRfdGltZSddCiAgICAgICAgICAgIHJlcGx5ICs9IGYie2N1cnJlbnRfdGltZX0gfCB7a2VuaF9uYXB9IHwge2Ftb3VudF9mb3JtYXR0ZWR9XG4iCgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9cmVwbHkKICAgICAgICApCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IGzhu4tjaCBz4butIG7huqFwIHRp4buBbiBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJsc3IiKQpkZWYgbHNyKGNhbGw6IENhbGxiYWNrUXVlcnkpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgeGVtIGzhu4tjaCBz4butIHLDunQgdGnhu4FuLiIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICByZXBseV9tYXJrdXA9Tm9uZQogICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBj4bqlbSB0cnV5IGPhuq1wLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB1c2VyX3J1dF9pbmZvID0gW10KCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzcnV0LnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgcnV0X2ZpbGU6CiAgICAgICAgICAgIGxpbmVzID0gcnV0X2ZpbGUucmVhZGxpbmVzKCkKCiAgICAgICAgdm5fdGltZXpvbmUgPSBweXR6LnRpbWV6b25lKCdBc2lhL0hvX0NoaV9NaW5oJykKCiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCIgLSAiKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpIDwgNjoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICBsaW5lX3VzZXJfaWQgPSBwYXJ0c1swXS5zdHJpcCgpCiAgICAgICAgICAgIGlmIGxpbmVfdXNlcl9pZCAhPSB1c2VyX2lkOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGRhdGVfc3RyID0gcGFydHNbMV0uc3RyaXAoKQogICAgICAgICAgICBrZW5oX3J1dCA9IHBhcnRzWzJdLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICBzdGF0dXMgPSBwYXJ0c1stMl0uc3RyaXAoKQoKICAgICAgICAgICAgaWYgc3RhdHVzICE9ICJUaMOgbmggY8O0bmciOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIGlmIGtlbmhfcnV0ID09ICJCQU5LIiBhbmQgbGVuKHBhcnRzKSA9PSA4OgogICAgICAgICAgICAgICAgYW1vdW50X3N0ciA9IHBhcnRzWzVdLnJlcGxhY2UoIi4iLCAiIikuc3RyaXAoKQogICAgICAgICAgICBlbGlmIGtlbmhfcnV0ID09ICJNT01PIiBhbmQgbGVuKHBhcnRzKSA9PSA2OgogICAgICAgICAgICAgICAgYW1vdW50X3N0ciA9IHBhcnRzWzNdLnJlcGxhY2UoIi4iLCAiIikuc3RyaXAoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgVGjhu51pIGdpYW4gxJHDoyBsw6AgVk4KICAgICAgICAgICAgICAgIHRpbWVfb2JqID0gZGF0ZXRpbWUuc3RycHRpbWUoZGF0ZV9zdHIsICIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgICAgICB0aW1lX3N0ciA9IHRpbWVfb2JqLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgIHVzZXJfcnV0X2luZm8uYXBwZW5kKHsKICAgICAgICAgICAgICAgICdrZW5oX3J1dCc6IGtlbmhfcnV0LAogICAgICAgICAgICAgICAgJ2Ftb3VudCc6IGludChhbW91bnRfc3RyKSwKICAgICAgICAgICAgICAgICdjdXJyZW50X3RpbWUnOiB0aW1lX3N0ciwKICAgICAgICAgICAgICAgICdzdGF0dXMnOiBzdGF0dXMKICAgICAgICAgICAgfSkKCiAgICAgICAgaWYgbm90IHVzZXJfcnV0X2luZm86CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgY8OzIGdpYW8gZOG7i2NoIHRow6BuaCBjw7RuZyBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB1c2VyX3J1dF9pbmZvLnNvcnQoa2V5PWxhbWJkYSB4OiBkYXRldGltZS5zdHJwdGltZSh4WydjdXJyZW50X3RpbWUnXSwgIiVkLyVtLyVZICVIOiVNOiVTIiksIHJldmVyc2U9VHJ1ZSkKCiAgICAgICAgcmVwbHkgPSAiPGI+VGjhu51pIGdpYW4gICB8ICAgS8OqbmggcsO6dCAgIHwgICBT4buRIHRp4buBbiAgIHwgICBUcuG6oW5nIHRow6FpPC9iPlxuXG4iCiAgICAgICAgZm9yIHJ1dCBpbiB1c2VyX3J1dF9pbmZvWzoyMF06CiAgICAgICAgICAgIHJlcGx5ICs9IGYie3J1dFsnY3VycmVudF90aW1lJ119IHwge3J1dFsna2VuaF9ydXQnXX0gfCB7Zml4c2QocnV0WydhbW91bnQnXSl9IHwge3J1dFsnc3RhdHVzJ119XG4iCgogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXJlcGx5LAogICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSBs4buLY2ggc+G7rSByw7p0IHRp4buBbiBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCgpkZWYgY2hlY2tfdXNlcl91bmxvY2sodXNlcl9pZDogc3RyKSAtPiBib29sOgogICAgdHJ5OgogICAgICAgIHRvdGFsX2N1b2MgPSAwCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEtp4buDbSB0cmEgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IG3hu58ga2jDs2EuIikKCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzY2hvaS50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNob2lfZmlsZToKICAgICAgICAgICAgbGluZXMgPSBjaG9pX2ZpbGUucmVhZGxpbmVzKCkKICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiICIpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDM6CiAgICAgICAgICAgICAgICAgICAgbGluZV91c2VyX2lkID0gcGFydHNbMF0uc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIGlmIGxpbmVfdXNlcl9pZCA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIExv4bqhaSBi4buPIGThuqV1IGNo4bqlbSBob+G6t2MgZOG6pXUgcGjhuql5IG7hur91IGPDswogICAgICAgICAgICAgICAgICAgICAgICAgICAgYW1vdW50ID0gZmxvYXQocGFydHNbMl0ucmVwbGFjZSgiLiIsICIiKS5yZXBsYWNlKCIsIiwgIiIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxfY3VvYyArPSBhbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyBjxrDhu6NjIHthbW91bnR9IFZORC4iKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHByaW50KGYiW0RFQlVHXSBU4buVbmcgc+G7kSB0aeG7gW4gY8aw4bujYyBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gbMOgIHt0b3RhbF9jdW9jfSBWTkQuIikKCiAgICAgICAgaWYgdG90YWxfY3VvYyA+PSA1MDAwMDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkeG7pyDEkWnhu4F1IGtp4buHbiBt4bufIGtow7NhLiIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBjaMawYSDEkeG7pyDEkWnhu4F1IGtp4buHbiBt4bufIGtow7NhLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkga2nhu4NtIHRyYSBt4bufIGtow7NhIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJtb2tob2F0YW50aHUiKQpkZWYgbW9raG9hdGFudGh1KGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgbeG7nyBraMOzYSB0w6BpIGtob+G6o24uIikKCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0b3RhbF9jdW9jID0gMAogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2xzY2hvaS50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGNob2lfZmlsZToKICAgICAgICAgICAgICAgIGxpbmVzID0gY2hvaV9maWxlLnJlYWRsaW5lcygpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDhu41jIHtsZW4obGluZXMpfSBkw7JuZyB04burIEZJTEUvbHNjaG9pLnR4dCIpCiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiICIpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAzOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lX3VzZXJfaWQgPSBwYXJ0c1swXS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxpbmVfdXNlcl9pZCA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFtb3VudCA9IGZsb2F0KHBhcnRzWzJdLnJlcGxhY2UoIi4iLCAiIikucmVwbGFjZSgiLCIsICIiKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbF9jdW9jICs9IGFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyBjxrDhu6NjIHRow6ptIHthbW91bnR9IFZORC4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEZpbGUgRklMRS9sc2Nob2kudHh0IGtow7RuZyB04buTbiB04bqhaS4iKQogICAgICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsICJLaMO0bmcgdMOsbSB0aOG6pXkgZOG7ryBsaeG7h3UgY8aw4bujYywgdnVpIGzDsm5nIHRo4butIGzhuqFpIHNhdS4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFThu5VuZyBz4buRIHRp4buBbiBjxrDhu6NjIGPhu6dhIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBsw6Age3RvdGFsX2N1b2N9IFZORC4iKQoKICAgICAgICBpZiB0b3RhbF9jdW9jIDwgNTAwMDA6CiAgICAgICAgICAgIG1pc3NpbmdfY3VvYyA9IG1heCgwLCA1MDAwMCAtIHRvdGFsX2N1b2MpCiAgICAgICAgICAgIGZvcm1hdHRlZF9taXNzaW5nX2N1b2MgPSBmb3JtYXRfYmFsYW5jZShpbnQobWlzc2luZ19jdW9jKSkKICAgICAgICAgICAgbWVzc2FnZSA9IGYiQuG6oW4gY+G6p24gY8aw4bujYyB0aMOqbSA8Yj57Zm9ybWF0dGVkX21pc3NpbmdfY3VvY308L2I+IG3hu5tpIGPDsyB0aOG7gyBt4bufIGtow7NhIgogICAgICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgdGV4dD1tZXNzYWdlLAogICAgICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBjaGVja191c2VyX3VubG9jayh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIG3hu58ga2jDs2EgdGjDoG5oIGPDtG5nLiIpCiAgICAgICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICB0ZXh0PSJN4bufIGtow7NhIHRow6BuaCBjw7RuZywgYuG6oW4gY8OzIHRo4buDIHPhu60gZOG7pW5nIG3hu41pIHTDrW5oIG7Eg25nIGPhu6dhIEdhbWUsIGNow7pjIGLhuqFuIGNoxqFpIGdhbWUgdnVpIHbhurshIiwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICAgICAgKQoKICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3R0LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgdHRfZmlsZToKICAgICAgICAgICAgICAgIHR0X2ZpbGUud3JpdGUoZiJ7dXNlcl9pZH1cbiIpCgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIMSR4bunIMSRaeG7gXUga2nhu4duIG3hu58ga2jDs2EuIikKICAgICAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9IjxiPkLhuqFuIGPhuqduIGPGsOG7o2MgdGjDqm0gNTAuMDAwIG3hu5tpIGPDsyB0aOG7gyBt4bufIGtow7NhPC9iPiIsCiAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSBt4bufIGtow7NhIHTDoGkga2hv4bqjbiBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInNwIikKZGVmIHNwKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSB5w6p1IGPhuqd1IGjhu5cgdHLhu6MuIikKCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlID0gIiIiR+G7rWkgbuG7mWkgZHVuZyBo4buXIHRy4bujIGNobyBhZG1pbiBraGkgYuG6oW4gY+G6p24gU3VwcG9ydDoKMS4gSG/DoG4gNzAlIGPDoWMgYmlsbCBzYWkgbuG7mWkgZHVuZywga2jDtG5nIGdoaSBu4buZaSBkdW5nIG7huqFwIHRp4buBbjogUXVheSBjbGlwIExvZ2luIE1vbW8gLT4gQ2hpIHRp4bq/dCBnaWFvIGThu4tjaCBn4butaSBBZC4KMi4gSG/DoG4gMTAwJSBjw6FjIGJpbGwgbuG6oXAgdsOgbyB0w6BpIGtob+G6o24gQkFOSyB2w6Agc+G7kSBNT01PIGPFqSBraGkgQm90IHRoYXkgxJHhu5VpLiIiIgoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgogICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9bWVzc2FnZSwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBn4butaSB0aMO0bmcgdGluIGjhu5cgdHLhu6MgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dCA9PSAi8J+StSBO4bqhcCB0aeG7gW4iKQpkZWYgbmFwdGllbihtZXNzYWdlKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgecOqdSBj4bqndSB4ZW0gdMOgaSBraG/huqNuLiIpCgogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiDEkcOjIMSRxrDhu6NjIGNodXnhu4NuIHRp4bq/cCwgYuG7jyBxdWEuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaW4gbmjhuq9uIMSRxrDhu6NjIGfhu61pIHRyxrDhu5tjIGtoaSBib3QgYuG6r3QgxJHhuqd1LCBi4buPIHF1YS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBuZ2hpIG5n4budIGfhu61pIHNwYW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIHRo4buDIGfhu61pIHRpbiBuaOG6r24uIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQoKICAgICAgICBpZiBwaG9uZSBpcyBOb25lOgogICAgICAgICAgICBtYXJrdXAgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgICAgICBjb250YWN0X2J1dHRvbiA9IEtleWJvYXJkQnV0dG9uKCLwn5OxIFNoYXJlIE51bWJlciIsIHJlcXVlc3RfY29udGFjdD1UcnVlKQogICAgICAgICAgICBtYXJrdXAuYWRkKGNvbnRhY3RfYnV0dG9uKQogICAgICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgIlZ1aSBsw7JuZyB4w6FjIG1pbmggU8SQVCDEkeG7gyB0aeG6v3AgdOG7pWM6IiwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXAKICAgICAgICAgICAgKQogICAgICAgICAgICBsdXV2YXhvYXRuKG1zZykKICAgICAgICAgICAgcmV0dXJuIiIiCgogICAgICAgIHRleHQgPSAiVnVpIGzDsm5nIGNo4buNbiBrw6puaCBu4bqhcCIKICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiB5w6p1IGPhuqd1IGNo4buNbiBrw6puaCBu4bqhcCDEkcOjIMSRxrDhu6NjIGNodeG6qW4gYuG7iy4iKQoKICAgICAgICBrZXlib2FyZCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICBidG5fYmFuayA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJCQU5LIiwgY2FsbGJhY2tfZGF0YT0ibmFwYmFuayIpCiAgICAgICAgYnRuX21vbW8gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiTU9NTyIsIGNhbGxiYWNrX2RhdGE9Im5hcG1vbW8iKQogICAgICAgIGJ0bl90aGVjYW8gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiVEjhurogQ8OATyIsIGNhbGxiYWNrX2RhdGE9InRoZWNhbyIpCiAgICAgICAga2V5Ym9hcmQucm93KGJ0bl9tb21vLCBidG5fYmFuaykKICAgICAgICBrZXlib2FyZC5yb3coYnRuX3RoZWNhbykKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIHThuqFvIGPDoWMgbsO6dDogQkFOSywgTU9NTywgVEjhurogQ8OATy4iKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD10ZXh0LAogICAgICAgICAgICByZXBseV9tYXJrdXA9a2V5Ym9hcmQsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICApCgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRpbiBuaOG6r24gduG7m2kgYsOgbiBwaMOtbSB0w7l5IGNo4buNbiB2w6AgbMawdSDEkeG7gyB4w7NhIHNhdS4iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgdHJvbmcgaMOgbSBuYXB0aWVuOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0ID09ICLwn5K4IFLDunQgdGnhu4FuIikKZGVmIHJ1dHRpZW4obWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgcsO6dCB0aeG7gW4uIikKCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaW4gbmjhuq9uIMSRw6MgxJHGsOG7o2MgY2h1eeG7g24gdGnhur9wLCBi4buPIHF1YS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gxJHGsOG7o2MgZ+G7rWkgdHLGsOG7m2Mga2hpIGJvdCBi4bqvdCDEkeG6p3UsIGLhu48gcXVhLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIG5naGkgbmfhu50gZ+G7rWkgc3BhbS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBraMO0bmcgdGjhu4MgZ+G7rWkgdGluIG5o4bqvbi4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgIiIicGhvbmUgPSBnZXRfcGhvbmVfbnVtYmVyKHVzZXJfaWQpCiAgICAgICAgaWYgcGhvbmUgaXMgTm9uZToKICAgICAgICAgICAgbWFya3VwID0gUmVwbHlLZXlib2FyZE1hcmt1cChyZXNpemVfa2V5Ym9hcmQ9VHJ1ZSwgb25lX3RpbWVfa2V5Ym9hcmQ9VHJ1ZSkKICAgICAgICAgICAgY29udGFjdF9idXR0b24gPSBLZXlib2FyZEJ1dHRvbigi8J+TsSBTaGFyZSBOdW1iZXIiLCByZXF1ZXN0X2NvbnRhY3Q9VHJ1ZSkKICAgICAgICAgICAgbWFya3VwLmFkZChjb250YWN0X2J1dHRvbikKICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIG1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgICJWdWkgbMOybmcgeMOhYyBtaW5oIFPEkFQgxJHhu4MgdGnhur9wIHThu6VjOiIsCiAgICAgICAgICAgICAgICByZXBseV9tYXJrdXA9bWFya3VwCiAgICAgICAgICAgICkKICAgICAgICAgICAgbHV1dmF4b2F0bihtc2cpCiAgICAgICAgICAgIHJldHVybiIiIgoKICAgICAgICB0ZXh0ID0gIiIi8J+SuCA8Yj5Sw7p0IHh1IHRoZW8gY8O6IHBow6FwOjwvYj4KPGJsb2NrcXVvdGU+PGNvZGU+L21vbW8gW1Phu5EgbW9tb10rW1Phu5EgeHVdPC9jb2RlPjwvYmxvY2txdW90ZT4KVkQ6IC9tb21vIDA5MDkwOTA5OTkgMTAwMDAwClLDunQgdOG7kWkgdGhp4buDdSA1MC4wMDAgeHUKCjxibG9ja3F1b3RlPjxjb2RlPi9iYW5rIFtiYW5rIG5hbWVdIFtz4buRIHTDoGkga2hv4bqjbl0gW3Phu5EgeHUgY+G6p24gcsO6dF08L2NvZGU+PC9ibG9ja3F1b3RlPgpWRDogL2JhbmsgTUIgMDk5OTk5OTk5IDEwMDAwMApSw7p0IHThu5FpIHRoaeG7g3UgMTAwLjAwMCB4dQoKPGJsb2NrcXVvdGUgZXhwYW5kYWJsZT5EYW5oIHPDoWNoIEJhbmsgTmFtZQpJQ0IgLT4gVmlldGluQmFuawpWQ0IgLT4gVmlldGNvbWJhbmsKQklEViAtPiBCSURWClZCQSAtPiBBZ3JpYmFuawpPQ0IgLT4gT0NCCk1CIC0+IE1CQmFuawpUQ0IgLT4gVGVjaGNvbWJhbmsKQUNCIC0+IEFDQgpWUEIgLT4gVlBCYW5rClRQQiAtPiBUUEJhbmsKU1RCIC0+IFNhY29tYmFuawpIREIgLT4gSERCYW5rClZDQ0IgLT4gVmlldENhcGl0YWxCYW5rCkJWQmFuayAtPiBCVkJhbmsKU0NCIC0+IFNDQgpWSUIgLT4gVklCClNIQiAtPiBTSEIKRUlCIC0+IEV4aW1iYW5rCk1TQiAtPiBNU0IKQ0FLRSAtPiBDQUtFClViYW5rIC0+IFViYW5rClRJTU8gLT4gVGltbwpTR0lDQiAtPiBTYWlnb25CYW5rCkJBQiAtPiBCYWNBQmFuawpQVkNCIC0+IFBWY29tQmFuawpPY2VhbmJhbmsgLT4gT2NlYW5iYW5rCk5DQiAtPiBOQ0IKU0hCVk4gLT4gU2hpbmhhbkJhbmsKQUJCIC0+IEFCQkFOSwpWQUIgLT4gVmlldEFCYW5rCk5BQiAtPiBOYW1BQmFuawpQR0IgLT4gUEdCYW5rClZJRVRCQU5LIC0+IFZpZXRCYW5rCkJWQiAtPiBCYW9WaWV0QmFuawpTRUFCIC0+IFNlQUJhbmsKQ09PUEJBTksgLT4gQ09PUEJBTksKTFBCIC0+IExpZW5WaWV0UG9zdEJhbmsKS0xCIC0+IEtpZW5Mb25nQmFuawpTQ1ZOIC0+IFN0YW5kYXJkQ2hhcnRlcmVkClBCVk4gLT4gUHVibGljQmFuawpJVkIgLT4gSW5kb3ZpbmFCYW5rCkhTQkMgLT4gSFNCQwpET0IgLT4gRG9uZ0FCYW5rCkNJTUIgLT4gQ0lNQgpDQkIgLT4gQ0JCYW5rPC9ibG9ja3F1b3RlPgoiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQYW5nIGfhu61pIGjGsOG7m25nIGThuqtuIHLDunQgdGnhu4FuLiIpCiAgICAgICAgICAgIG1zZyA9IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9dGV4dCwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICAgICAgKQoKICAgICAgICBleGNlcHQgQXBpVGVsZWdyYW1FeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBn4butaSB0aW4gbmjhuq9uIHLDunQgdGnhu4FuOiB7ZX0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgdHJvbmcgaMOgbSBydXR0aWVuOiB7ZX0iKQoKQGJvdC5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogbWVzc2FnZS50ZXh0ID09ICLirZDvuI8gRXZlbnQg4q2Q77iPIikKZGVmIGV2ZW50KG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gecOqdSBj4bqndSB4ZW0gY8OhYyBz4buxIGtp4buHbi4iKQoKICAgICAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGzDoCB0aW4gbmjhuq9uIGNodXnhu4NuIHRp4bq/cC4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRxrDhu6NjIGfhu61pIHRyxrDhu5tjIHRo4budaSBnaWFuIGJvdCBi4bqvdCDEkeG6p3UuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBj4bqlbS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgbmdoaSBuZ+G7nSBzcGFtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGtow7RuZyB0aOG7gyBuaOG6rW4gdGluIG5o4bqvbiB04burIGJvdC4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgY3VycmVudF93ZWVrID0gZGF0ZXRpbWUubm93KCkuaXNvY2FsZW5kYXIoKVsxXQogICAgICAgIHByZXZpb3VzX3dlZWsgPSBjdXJyZW50X3dlZWsgLSAxIGlmIGN1cnJlbnRfd2VlayA+IDEgZWxzZSA1MgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUdeG6p24gaGnhu4duIHThuqFpOiB7Y3VycmVudF93ZWVrfSwgdHXhuqduIHRyxrDhu5tjOiB7cHJldmlvdXNfd2Vla30iKQoKICAgICAgICBtZXNzYWdlX3RleHQgPSAiQ8OhYyBFVkVOVCDEkWFuZyBkaeG7hW4gcmE6XG4iCiAgICAgICAga2V5Ym9hcmQgPSBbCiAgICAgICAgICAgIFtJbmxpbmVLZXlib2FyZEJ1dHRvbigiR0jDiVAgVuG6rFQgUEjhuqhNIE5PRUwiLCBjYWxsYmFja19kYXRhPSJnaGVwdmF0cGhhbW5vZWwiKV0sCiAgICAgICAgICAgIFtJbmxpbmVLZXlib2FyZEJ1dHRvbigi8J+OriBUb3AgTmhp4buHbSB24bulIPCfjq4iLCBjYWxsYmFja19kYXRhPSJ0b3BuaGllbXZ1IildLAogICAgICAgICAgICBbCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIlRvcCBSRUYgdHXhuqduIHtjdXJyZW50X3dlZWt9IiwgY2FsbGJhY2tfZGF0YT1mInRvcHJlZntjdXJyZW50X3dlZWt9IiksCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbihmIlRvcCBSRUYgdHXhuqduIHtwcmV2aW91c193ZWVrfSIsIGNhbGxiYWNrX2RhdGE9ZiJ0b3ByZWZ7cHJldmlvdXNfd2Vla30iKQogICAgICAgICAgICBdCiAgICAgICAgXQogICAgICAgIHJlcGx5X21hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKGtleWJvYXJkKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9bWVzc2FnZV90ZXh0LCByZXBseV9tYXJrdXA9cmVwbHlfbWFya3VwKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyB0aW4gc+G7sSBraeG7h24gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gc+G7sSBraeG7h24gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKICAgICAgICBwYXNzCgpjdXJyZW50X3dlZWsgPSBkYXRldGltZS5ub3coKS5pc29jYWxlbmRhcigpWzFdCnByZXZpb3VzX3dlZWsgPSBjdXJyZW50X3dlZWsgLSAxIGlmIGN1cnJlbnRfd2VlayA+IDEgZWxzZSA1MgoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSBpbiBbImdoZXB2YXRwaGFtbm9lbCIsICJ0b3BuaGllbXZ1IiwgZiJ0b3ByZWZ7Y3VycmVudF93ZWVrfSIsIGYidG9wcmVme3ByZXZpb3VzX3dlZWt9Il0pCmRlZiBldnQoY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IMSRw6MgbmjhuqVuIHbDoG8gc+G7sSBraeG7h246IHtjYWxsLmRhdGF9IikKCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBjYWxsLmRhdGEgPT0gImdoZXB2YXRwaGFtbm9lbCI6CiAgICAgICAgICAgIGRlZiBnZXRfaXRlbV9xdWFudGl0eV9mcm9tX2ZpbGUoZmlsZV9uYW1lLCB1c2VyX2lkKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBmdWxsX3BhdGggPSBmIkZJTEUve2ZpbGVfbmFtZX0iCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIGtp4buDbSB0cmEgc+G7kSBsxrDhu6NuZyB24bqtdCBwaOG6qW0gdHJvbmcgdOG7h3A6IHtmdWxsX3BhdGh9IGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0iKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmdWxsX3BhdGgpOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gVOG7h3Age2Z1bGxfcGF0aH0ga2jDtG5nIHThu5NuIHThuqFpLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGZ1bGxfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSDEkeG7jWMgdOG7h3Age2ZpbGVfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICAgICAgICAgIHJldHVybiAwCgogICAgICAgICAgICBzb2x1b25nc2FvID0gZ2V0X2l0ZW1fcXVhbnRpdHlfZnJvbV9maWxlKCJzYW8udHh0IiwgdXNlcl9pZCkKICAgICAgICAgICAgc29sdW9uZ2JvbmcgPSBnZXRfaXRlbV9xdWFudGl0eV9mcm9tX2ZpbGUoImJvbmcudHh0IiwgdXNlcl9pZCkKICAgICAgICAgICAgc29sdW9uZ25ndW9pdHV5ZXQgPSBnZXRfaXRlbV9xdWFudGl0eV9mcm9tX2ZpbGUoIm5ndW9pdHV5ZXQudHh0IiwgdXNlcl9pZCkKICAgICAgICAgICAgc29sdW9uZ2tlbyA9IGdldF9pdGVtX3F1YW50aXR5X2Zyb21fZmlsZSgia2VvLnR4dCIsIHVzZXJfaWQpCiAgICAgICAgICAgIHNvbHVvbmdjYXl0aG9uZyA9IGdldF9pdGVtX3F1YW50aXR5X2Zyb21fZmlsZSgiY2F5dGhvbmcudHh0IiwgdXNlcl9pZCkKICAgICAgICAgICAgc29sdW9uZ2NheXRob25nZGFjYmlldCA9IGdldF9pdGVtX3F1YW50aXR5X2Zyb21fZmlsZSgiY2F5dGhvbmdkYWNiaWV0LnR4dCIsIHVzZXJfaWQpCgogICAgICAgICAgICBwcmludChmIltERUJVR10gU+G7kSBsxrDhu6NuZyB24bqtdCBwaOG6qW0gY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiBzYW86IHtzb2x1b25nc2FvfSwgYm9uZzoge3NvbHVvbmdib25nfSwgbmd1b2l0dXlldDoge3NvbHVvbmduZ3VvaXR1eWV0fSwga2VvOiB7c29sdW9uZ2tlb30sIGNheXRob25nOiB7c29sdW9uZ2NheXRob25nfSwgY2F5dGhvbmdkYWNiaWV0OiB7c29sdW9uZ2NheXRob25nZGFjYmlldH0iKQoKICAgICAgICAgICAgcmVwbHlfbWVzc2FnZSA9IGYiIiI8Yj7imITvuI9FdmVudCBHSMOJUCBW4bqsVCBQSOG6qE0gR0nDgU5HIFNJTkjimITvuI88L2I+ClRodSB0aOG6rXAgY8OhYyB24bqtdCBwaOG6qW0gR2nDoW5nIHNpbmgg4q2Q77iP4p2E4piD8J+NrCDEkeG7gyBnaMOpcCB0aMOgbmggY8OieSB0aMO0bmcgTm9lbCB2w6Agbmjhuq1uIHRoxrDhu59uZyBj4buxYyBs4bubbiEKCkLhuqFuIMSRYW5nIGPDszoK4q2Q77iPOiA8Yj57c29sdW9uZ3Nhb308L2I+CuKdhDogPGI+e3NvbHVvbmdib25nfTwvYj4K4piDOiA8Yj57c29sdW9uZ25ndW9pdHV5ZXR9PC9iPgrwn42sOiA8Yj57c29sdW9uZ2tlb308L2I+Cgrwn4yyIDxiPntzb2x1b25nY2F5dGhvbmd9PC9iPgrwn46EIDxiPntzb2x1b25nY2F5dGhvbmdkYWNiaWV0fTwvYj4iIiIKCiAgICAgICAgICAgIGtleWJvYXJkID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAoKQogICAgICAgICAgICBrZXlib2FyZC5hZGQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIkdow6lwIOKdhCDimIMg8J+NrCA9IPCfjLIiLCBjYWxsYmFja19kYXRhPSJnaGVwYmF2YXRwaGFtIikpCiAgICAgICAgICAgIGtleWJvYXJkLmFkZCh0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiR2jDqXAg4p2EIOKYgyDwn42sIOKtkO+4jyA9IPCfjoQiLCBjYWxsYmFja19kYXRhPSJnaGVwYm9udmF0cGhhbSIpKQogICAgICAgICAgICBrZXlib2FyZC5hZGQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIsSQ4buVaSDwn4yyIOKepCBYdSIsIGNhbGxiYWNrX2RhdGE9ImRvaWNheXRob25nc2FuZ3h1IikpCiAgICAgICAgICAgIGtleWJvYXJkLmFkZCh0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigixJDhu5VpIPCfjoQg4p6kIFh1IiwgY2FsbGJhY2tfZGF0YT0iZG9pY2F5dGhvbmdkYWNiaWV0c2FuZ3h1IikpCgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9cmVwbHlfbWVzc2FnZSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPWtleWJvYXJkCiAgICAgICAgICAgICkKCiAgICAgICAgYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gc+G7sSBraeG7h24ge2NhbGwuZGF0YX0gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKICAgICAgICBwYXNzCgpkZWYgdXBkYXRlX2l0ZW1fcXVhbnRpdHkoZmlsZV9uYW1lLCB1c2VyX2lkLCBxdWFudGl0eV90b19zdWJ0cmFjdCk6CiAgICBsaW5lcyA9IFtdCiAgICBmb3VuZCA9IEZhbHNlCiAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICBuZXdfYW1vdW50ID0gbWF4KDAsIGludChwYXJ0c1sxXSkgLSBxdWFudGl0eV90b19zdWJ0cmFjdCkKICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmV3X2Ftb3VudH1cbiIpCiAgICAgICAgICAgICAgICBmb3VuZCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lKQoKICAgIGlmIGZvdW5kOgogICAgICAgIHdpdGggb3BlbihmaWxlX25hbWUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKZGVmIGFkZF9pdGVtX3F1YW50aXR5KGZpbGVfbmFtZSwgdXNlcl9pZCwgcXVhbnRpdHlfdG9fYWRkKToKICAgIGxpbmVzID0gW10KICAgIGZvdW5kID0gRmFsc2UKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX25hbWUpOgogICAgICAgIHdpdGggb3BlbihmaWxlX25hbWUsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkfSB7cXVhbnRpdHlfdG9fYWRkfVxuIikKICAgICAgICByZXR1cm4KCiAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDIgYW5kIHBhcnRzWzBdID09IHVzZXJfaWQ6CiAgICAgICAgICAgICAgICBuZXdfYW1vdW50ID0gaW50KHBhcnRzWzFdKSArIHF1YW50aXR5X3RvX2FkZAogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfYW1vdW50fVxuIikKICAgICAgICAgICAgICAgIGZvdW5kID0gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUpCgogICAgaWYgbm90IGZvdW5kOgogICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7cXVhbnRpdHlfdG9fYWRkfVxuIikKCiAgICB3aXRoIG9wZW4oZmlsZV9uYW1lLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKZGVmIGdldF9pdGVtX3F1YW50aXR5KGZpbGVfbmFtZSwgdXNlcl9pZCk6CiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoZmlsZV9uYW1lKToKICAgICAgICByZXR1cm4gMAogICAgd2l0aCBvcGVuKGZpbGVfbmFtZSwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyIGFuZCBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgIHJldHVybiAwCgojYm90LmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkLCAiS2jDtG5nIMSR4bunIHbhuq10IHBo4bqpbSDinYQg4piDIPCfjawg4q2Q77iPIMSR4buDIHF1eSDEkeG7lWkiLCBzaG93X2FsZXJ0PVRydWUpCgpAYm90LmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhIGluIFsiZ2hlcGJhdmF0cGhhbSIsICJnaGVwYm9udmF0cGhhbSIsICJkb2ljYXl0aG9uZ3Nhbmd4dSIsICJkb2ljYXl0aG9uZ2RhY2JpZXRzYW5neHUiXSkKZGVmIGhhbmRsZV9pdGVtX2V4Y2hhbmdlKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgY2hhdF9pZCA9IGNhbGwubWVzc2FnZS5jaGF0LmlkCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIG5o4bqlbiB2w6BvIHPhu7Ega2nhu4duOiB7Y2FsbC5kYXRhfSIpCgogICAgICAgIGJvdC5lZGl0X21lc3NhZ2VfcmVwbHlfbWFya3VwKAogICAgICAgICAgICBjaGF0X2lkPWNoYXRfaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBzb2x1b25nc2FvID0gZ2V0X2l0ZW1fcXVhbnRpdHkoIkZJTEUvc2FvLnR4dCIsIHVzZXJfaWQpCiAgICAgICAgc29sdW9uZ2JvbmcgPSBnZXRfaXRlbV9xdWFudGl0eSgiRklMRS9ib25nLnR4dCIsIHVzZXJfaWQpCiAgICAgICAgc29sdW9uZ25ndW9pdHV5ZXQgPSBnZXRfaXRlbV9xdWFudGl0eSgiRklMRS9uZ3VvaXR1eWV0LnR4dCIsIHVzZXJfaWQpCiAgICAgICAgc29sdW9uZ2tlbyA9IGdldF9pdGVtX3F1YW50aXR5KCJGSUxFL2tlby50eHQiLCB1c2VyX2lkKQogICAgICAgIHNvbHVvbmdjYXl0aG9uZyA9IGdldF9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nLnR4dCIsIHVzZXJfaWQpCiAgICAgICAgc29sdW9uZ2NheXRob25nZGFjYmlldCA9IGdldF9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nZGFjYmlldC50eHQiLCB1c2VyX2lkKQoKICAgICAgICBpZiBjYWxsLmRhdGEgPT0gImdoZXBiYXZhdHBoYW0iOgogICAgICAgICAgICBpZiBzb2x1b25nYm9uZyA8IDEgb3Igc29sdW9uZ25ndW9pdHV5ZXQgPCAxIG9yIHNvbHVvbmdrZW8gPCAxOgogICAgICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCAiS2jDtG5nIMSR4bunIHbhuq10IHBo4bqpbSDinYQg4piDIPCfjawgxJHhu4MgxJHhu5VpIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB1cGRhdGVfaXRlbV9xdWFudGl0eSgiRklMRS9ib25nLnR4dCIsIHVzZXJfaWQsIDEpCiAgICAgICAgICAgIHVwZGF0ZV9pdGVtX3F1YW50aXR5KCJGSUxFL25ndW9pdHV5ZXQudHh0IiwgdXNlcl9pZCwgMSkKICAgICAgICAgICAgdXBkYXRlX2l0ZW1fcXVhbnRpdHkoIkZJTEUva2VvLnR4dCIsIHVzZXJfaWQsIDEpCiAgICAgICAgICAgIGFkZF9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nLnR4dCIsIHVzZXJfaWQsIDEpCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIkLhuqFuIMSRw6MgxJHhu5VpIHRow6BuaCBjw7RuZyDwn4yyIikKCiAgICAgICAgZWxpZiBjYWxsLmRhdGEgPT0gImdoZXBib252YXRwaGFtIjoKICAgICAgICAgICAgaWYgc29sdW9uZ2JvbmcgPCAxIG9yIHNvbHVvbmduZ3VvaXR1eWV0IDwgMSBvciBzb2x1b25na2VvIDwgMSBvciBzb2x1b25nc2FvIDwgMToKICAgICAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgIktow7RuZyDEkeG7pyB24bqtdCBwaOG6qW0g4p2EIOKYgyDwn42sIOKtkO+4jyDEkeG7gyDEkeG7lWkiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHVwZGF0ZV9pdGVtX3F1YW50aXR5KCJGSUxFL2JvbmcudHh0IiwgdXNlcl9pZCwgMSkKICAgICAgICAgICAgdXBkYXRlX2l0ZW1fcXVhbnRpdHkoIkZJTEUvbmd1b2l0dXlldC50eHQiLCB1c2VyX2lkLCAxKQogICAgICAgICAgICB1cGRhdGVfaXRlbV9xdWFudGl0eSgiRklMRS9rZW8udHh0IiwgdXNlcl9pZCwgMSkKICAgICAgICAgICAgdXBkYXRlX2l0ZW1fcXVhbnRpdHkoIkZJTEUvc2FvLnR4dCIsIHVzZXJfaWQsIDEpCiAgICAgICAgICAgIGFkZF9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nZGFjYmlldC50eHQiLCB1c2VyX2lkLCAxKQogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJC4bqhbiDEkcOjIMSR4buVaSB0aMOgbmggY8O0bmcg8J+OhCIpCgogICAgICAgIGVsaWYgY2FsbC5kYXRhID09ICJkb2ljYXl0aG9uZ3Nhbmd4dSI6CiAgICAgICAgICAgIGlmIHNvbHVvbmdjYXl0aG9uZyA8IDE6CiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJLaMO0bmcgxJHhu6cg8J+MsiDEkeG7gyDEkeG7lWkiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHVwZGF0ZV9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nLnR4dCIsIHVzZXJfaWQsIDEpCiAgICAgICAgICAgIGFtb3VudCA9IHJhbmRvbS5yYW5kaW50KDExMTEsIDY2NjYpCiAgICAgICAgICAgIHVwZGF0ZV9zb3RpZW4odXNlcl9pZCwgYW1vdW50KSAgIyBD4buZbmcgdGjDqm0gdGhheSB2w6wgc2V0CiAgICAgICAgICAgIGZvcm1hdHRlZCA9IGZvcm1hdF9iYWxhbmNlKGFtb3VudCkKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkLCBmIkLhuqFuIMSRw6MgxJHhu5VpIHRow6BuaCBjw7RuZyB2w6Agbmjhuq1uIMSRxrDhu6NjIHtmb3JtYXR0ZWR9IikKICAgICAgICAgICAgYm90Mi5zZW5kX21lc3NhZ2UoR1JPVVAsIGYiPGk+e3VzZXJfaWR9IMSRw6MgxJHhu5VpIHRow6BuaCBjw7RuZyB2w6Agbmjhuq1uIHtmb3JtYXR0ZWR9PC9pPiIsIHBhcnNlX21vZGU9IkhUTUwiKQoKICAgICAgICBlbGlmIGNhbGwuZGF0YSA9PSAiZG9pY2F5dGhvbmdkYWNiaWV0c2FuZ3h1IjoKICAgICAgICAgICAgaWYgc29sdW9uZ2NheXRob25nZGFjYmlldCA8IDE6CiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQsICJLaMO0bmcgxJHhu6cg8J+OhCDEkeG7gyDEkeG7lWkiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHVwZGF0ZV9pdGVtX3F1YW50aXR5KCJGSUxFL2NheXRob25nZGFjYmlldC50eHQiLCB1c2VyX2lkLCAxKQogICAgICAgICAgICBhbW91bnQgPSByYW5kb20ucmFuZGludCgxMTExLCA5OTk5KQogICAgICAgICAgICB1cGRhdGVfc290aWVuKHVzZXJfaWQsIGFtb3VudCkgICMgQ+G7mW5nIHRow6ptIHRoYXkgdsOsIHNldAogICAgICAgICAgICBmb3JtYXR0ZWQgPSBmb3JtYXRfYmFsYW5jZShhbW91bnQpCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgZiJC4bqhbiDEkcOjIMSR4buVaSB0aMOgbmggY8O0bmcgdsOgIG5o4bqtbiDEkcaw4bujYyB7Zm9ybWF0dGVkfSIpCiAgICAgICAgICAgIGJvdDIuc2VuZF9tZXNzYWdlKEdST1VQLCBmIjxpPnt1c2VyX2lkfSDEkcOjIMSR4buVaSB0aMOgbmggY8O0bmcgdsOgIG5o4bqtbiB7Zm9ybWF0dGVkfTwvaT4iLCBwYXJzZV9tb2RlPSJIVE1MIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEzhu5dpIHjhu60gbMO9IMSR4buVaSB24bqtdCBwaOG6qW06IHtlfSIpCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBtZXNzYWdlLnRleHQgPT0gIvCfjpYgQlhIIPCfjpYiKQpkZWYgYnhoKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gecOqdSBj4bqndSBCWEguIikKCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaW4gbmjhuq9uIGPhu6dhIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBsw6AgdGluIG5o4bqvbiBjaHV54buDbiB0aeG6v3AuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaW4gbmjhuq9uIGPhu6dhIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcaw4bujYyBn4butaSB0csaw4bubYyB0aOG7nWkgZ2lhbiBib3QgYuG6r3QgxJHhuqd1LiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIG5naGkgbmfhu50gc3BhbS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBraMO0bmcgdGjhu4Mgbmjhuq1uIHRpbiBuaOG6r24gdOG7qyBib3QuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICIiInBob25lID0gZ2V0X3Bob25lX251bWJlcih1c2VyX2lkKQogICAgICAgIGlmIHBob25lIGlzIE5vbmU6CiAgICAgICAgICAgIG1hcmt1cCA9IFJlcGx5S2V5Ym9hcmRNYXJrdXAocmVzaXplX2tleWJvYXJkPVRydWUsIG9uZV90aW1lX2tleWJvYXJkPVRydWUpCiAgICAgICAgICAgIGNvbnRhY3RfYnV0dG9uID0gS2V5Ym9hcmRCdXR0b24oIvCfk7EgU2hhcmUgTnVtYmVyIiwgcmVxdWVzdF9jb250YWN0PVRydWUpCiAgICAgICAgICAgIG1hcmt1cC5hZGQoY29udGFjdF9idXR0b24pCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgICAgICBtZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAiVnVpIGzDsm5nIHjDoWMgbWluaCBTxJBUIMSR4buDIHRp4bq/cCB04bulYzoiLAogICAgICAgICAgICAgICAgcmVwbHlfbWFya3VwPW1hcmt1cAogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybiIiIgoKICAgICAgICBtZXNzYWdlX3RleHQgPSAoCiAgICAgICAgICAgICI8Yj7wn46WIEJYSCBDxq/hu6JDPC9iPlxuIgogICAgICAgICAgICAiVG9wIGPGsOG7o2MgbmfDoHkgKHRoYW5oIHRvw6FuIHbDoG8gMTJoIHRyxrBhIGjDtG0gc2F1KTpcbiIKICAgICAgICAgICAgIvCfpYdUb3AgMTogNTAuMDAwXG4iCiAgICAgICAgICAgICLwn6WIVG9wIDI6IDMwLjAwMFxuIgogICAgICAgICAgICAi8J+liVRvcCAzOiAxNS4wMDBcblxuIgogICAgICAgICAgICAiVG9wIGPGsOG7o2MgdHXhuqduICh0aGFuaCB0b8OhbiB2w6BvIDEyaCB0csawYSB0aOG7qSAyIHR14bqnbiBzYXUpOlxuIgogICAgICAgICAgICAi8J+lh1RvcCAxOiAxMDAuMDAwXG4iCiAgICAgICAgICAgICLwn6WIVG9wIDI6IDUwLjAwMFxuIgogICAgICAgICAgICAi8J+liVRvcCAzOiAyMC4wMDBcblxuIgogICAgICAgICkKICAgICAgICBrZXlib2FyZCA9IFsKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIk5nw6B5IiwgY2FsbGJhY2tfZGF0YT0iYnhobmdheSIpLAogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIlR14bqnbiIsIGNhbGxiYWNrX2RhdGE9ImJ4aHR1YW4iKQogICAgICAgICAgICBdCiAgICAgICAgXQogICAgICAgIHJlcGx5X21hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKGtleWJvYXJkKQoKICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgdGV4dD1tZXNzYWdlX3RleHQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1yZXBseV9tYXJrdXAsCiAgICAgICAgICAgIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwKICAgICAgICApCgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyB0aW4gQlhIIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSBn4butaSBCWEggY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKCmRlZiBnZXRfdG90YWxfYmV0X3RvZGF5KCk6CiAgICB0b3BfdG9kYXkgPSBbXQogICAgdHJ5OgogICAgICAgIHByaW50KCJbREVCVUddIMSQYW5nIMSR4buNYyB04buHcCBGSUxFL3RvcGN1b2MudHh0IMSR4buDIGzhuqV5IGPGsOG7o2MgbmfDoHkuIikKICAgICAgICB3aXRoIG9wZW4oJ0ZJTEUvdG9wY3VvYy50eHQnLCAncicsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGZpbGU6CiAgICAgICAgICAgIGxpbmVzID0gZmlsZS5yZWFkbGluZXMoKQogICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCcgJykKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPCAzOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB1c2VyX2lkID0gcGFydHNbMF0KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBiZXRfdG9kYXkgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgYmV0X3dlZWsgPSBpbnQocGFydHNbMl0pCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBjxrDhu6NjIGjDtG0gbmF5OiB7YmV0X3RvZGF5fSwgdHXhuqduIG7DoHk6IHtiZXRfd2Vla30iKQogICAgICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gTOG7l2kga2hpIGNodXnhu4NuIMSR4buVaSBz4buRIGzGsOG7o25nIGPGsOG7o2MsIGLhu48gcXVhIGTDsm5nLiIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICBpZiBiZXRfdG9kYXkgPj0gMTAwMDAwOgogICAgICAgICAgICAgICAgICAgIHRvcF90b2RheS5hcHBlbmQoeyd1c2VyX2lkJzogdXNlcl9pZCwgJ2Ftb3VudCc6IGJldF90b2RheX0pCgogICAgICAgIHRvcF90b2RheSA9IHNvcnRlZCh0b3BfdG9kYXksIGtleT1sYW1iZGEgeDogeFsnYW1vdW50J10sIHJldmVyc2U9VHJ1ZSkKICAgICAgICBwcmludChmIltERUJVR10gRGFuaCBzw6FjaCB0b3AgY8aw4bujYyBuZ8OgeToge3RvcF90b2RheX0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gdOG7h3AgRklMRS90b3BjdW9jLnR4dDoge2V9IikKICAgIHJldHVybiB0b3BfdG9kYXkKCmRlZiBnZXRfdG90YWxfYmV0X3dlZWsoKToKICAgIHRvcF93ZWVrID0gW10KICAgIHRyeToKICAgICAgICBwcmludCgiW0RFQlVHXSDEkGFuZyDEkeG7jWMgdOG7h3AgRklMRS90b3BjdW9jLnR4dCDEkeG7gyBs4bqleSBjxrDhu6NjIHR14bqnbi4iKQogICAgICAgIHdpdGggb3BlbignRklMRS90b3BjdW9jLnR4dCcsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgICAgICAgICAgbGluZXMgPSBmaWxlLnJlYWRsaW5lcygpCiAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoJyAnKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDM6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIHVzZXJfaWQgPSBwYXJ0c1swXQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGJldF90b2RheSA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICBiZXRfd2VlayA9IGludChwYXJ0c1syXSkKICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGPGsOG7o2MgaMO0bSBuYXk6IHtiZXRfdG9kYXl9LCB0deG6p24gbsOgeToge2JldF93ZWVrfSIpCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBM4buXaSBraGkgY2h1eeG7g24gxJHhu5VpIHPhu5EgbMaw4bujbmcgY8aw4bujYywgYuG7jyBxdWEgZMOybmcuIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICAgICAgICAgIGlmIGJldF93ZWVrID49IDEwMDAwMDoKICAgICAgICAgICAgICAgICAgICB0b3Bfd2Vlay5hcHBlbmQoeyd1c2VyX2lkJzogdXNlcl9pZCwgJ2Ftb3VudCc6IGJldF93ZWVrfSkKCiAgICAgICAgdG9wX3dlZWsgPSBzb3J0ZWQodG9wX3dlZWssIGtleT1sYW1iZGEgeDogeFsnYW1vdW50J10sIHJldmVyc2U9VHJ1ZSkKICAgICAgICBwcmludChmIltERUJVR10gRGFuaCBzw6FjaCB0b3AgY8aw4bujYyB0deG6p246IHt0b3Bfd2Vla30iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gdOG7h3AgRklMRS90b3BjdW9jLnR4dDoge2V9IikKICAgIHJldHVybiB0b3Bfd2VlawoKQGJvdC5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSBpbiBbImJ4aG5nYXkiLCAiYnhodHVhbiIsICJieGhuZ2F5dHJ1b2MiLCAiYnhodHVhbnRydW9jIl0pCmRlZiBieGEoY2FsbCk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IHN0cihjYWxsLmZyb21fdXNlci5pZCkKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IHnDqnUgY+G6p3UgQlhIIHbhu5tpIGThu68gbGnhu4d1IHtjYWxsLmRhdGF9IikKCiAgICAgICAgaWYgY2FsbC5kYXRhIGluIFsiYnhobmdheSIsICJieGh0dWFuIiwgImJ4aG5nYXl0cnVvYyIsICJieGh0dWFudHJ1b2MiXToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBkZWYgZ2V0X3RvcF9wbGF5ZXJzKCk6CiAgICAgICAgICAgIHBsYXlzID0gW10KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3h4dGQudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmaWxlOgogICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGZpbGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAyOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdV9pZCwgY291bnQgPSBwYXJ0c1swXSwgaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgY291bnQgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYXlzLmFwcGVuZCgodV9pZCwgY291bnQpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBjaMahaSB7dV9pZH0gY8OzIHtjb3VudH0gbMaw4bujdCBjaMahaS4iKQogICAgICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSBU4buHcCBGSUxFL3h4dGQudHh0IGtow7RuZyB04buTbiB04bqhaS4iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IHThu4dwIEZJTEUveHh0ZC50eHQ6IHtlfSIpCgogICAgICAgICAgICBwbGF5cy5zb3J0KGtleT1sYW1iZGEgeDogeFsxXSwgcmV2ZXJzZT1UcnVlKQogICAgICAgICAgICByZXR1cm4gcGxheXNbOjVdCgogICAgICAgIHRvcF9wbGF5ZXJzID0gZ2V0X3RvcF9wbGF5ZXJzKCkKICAgICAgICBudW1iZXJfcGxheSA9IG5leHQoKGNvdW50IGZvciB1X2lkLCBjb3VudCBpbiB0b3BfcGxheWVycyBpZiB1X2lkID09IHVzZXJfaWQpLCAwKQoKICAgICAgICBpZiBjYWxsLmRhdGEgPT0gImJ4aG5nYXkiOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJBhbmcgeOG7rSBsw70gQlhIIG5nw6B5IGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKICAgICAgICAgICAgICAgIHRvcF90b2RheSA9IGdldF90b3RhbF9iZXRfdG9kYXkoKQogICAgICAgICAgICAgICAgdXNlcl9iZXRfdG9kYXkgPSBuZXh0KChlbnRyeVsiYW1vdW50Il0gZm9yIGVudHJ5IGluIHRvcF90b2RheSBpZiBlbnRyeVsidXNlcl9pZCJdID09IHVzZXJfaWQpLCAwKQoKICAgICAgICAgICAgICAgIHZpZXRuYW1fdHogPSBweXR6LnRpbWV6b25lKCdBc2lhL0hvX0NoaV9NaW5oJykKICAgICAgICAgICAgICAgIGRhdGVfdGltZSA9IGRhdGV0aW1lLm5vdyh2aWV0bmFtX3R6KS5zdHJmdGltZSgiJWQvJW0iKQoKICAgICAgICAgICAgICAgIHRvcF90b2RheV9tZXNzYWdlID0gIiIKICAgICAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKG1pbigzLCBsZW4odG9wX3RvZGF5KSkpOgogICAgICAgICAgICAgICAgICAgIHRvcF90b2RheV9tZXNzYWdlICs9ICgKICAgICAgICAgICAgICAgICAgICAgICAgZiJ7aGlkZV91c2VyX2lkKHRvcF90b2RheVtpXVsndXNlcl9pZCddKX0gICAgIgogICAgICAgICAgICAgICAgICAgICAgICBmIntmb3JtYXRfYmFsYW5jZSh0b3BfdG9kYXlbaV1bJ2Ftb3VudCddKX1cbiIKICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgIiIieHh0ZF9tZXNzYWdlID0gIlRvcCBnYW1lIDxiPljDumMgeOG6r2MgdHLDqm4gZMaw4bubaSDirIbvuI/irIc8L2I+XG5JRCAgICBMxrDhu6N0IGNoxqFpXG4iCiAgICAgICAgICAgICAgICBmb3IgdV9pZCwgY291bnQgaW4gdG9wX3BsYXllcnM6CiAgICAgICAgICAgICAgICAgICAgeHh0ZF9tZXNzYWdlICs9IGYie2hpZGVfdXNlcl9pZCh1X2lkKX0gICAge2NvdW50fVxuIiIiCgogICAgICAgICAgICAgICAgcmVwbHlfbWVzc2FnZSA9ICgKICAgICAgICAgICAgICAgICAgICBmIkjDtG0gbmF5IGLhuqFuIMSRw6MgY8aw4bujYzogPGI+e2Zvcm1hdF9iYWxhbmNlKHVzZXJfYmV0X3RvZGF5KX08L2I+XG5cbiIKICAgICAgICAgICAgICAgICAgICBmIjxiPlRvcCBjxrDhu6NjIG5nw6B5IHtkYXRlX3RpbWV9PC9iPlxuXG4iCiAgICAgICAgICAgICAgICAgICAgZiJ7dG9wX3RvZGF5X21lc3NhZ2V9XG5cbiIKICAgICAgICAgICAgICAgICAgICAjZiJ7eHh0ZF9tZXNzYWdlfSIKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICBtc2cgPSBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgICAgICAgICAgdGV4dD1yZXBseV9tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IEJYSCBuZ8OgeToge2V9IikKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgZWxpZiBjYWxsLmRhdGEgPT0gImJ4aHR1YW4iOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJBhbmcgeOG7rSBsw70gQlhIIHR14bqnbiBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LiIpCiAgICAgICAgICAgICAgICB0b3Bfd2VlayA9IGdldF90b3RhbF9iZXRfd2VlaygpCiAgICAgICAgICAgICAgICB1c2VyX2JldF93ZWVrID0gbmV4dCgoZW50cnlbImFtb3VudCJdIGZvciBlbnRyeSBpbiB0b3Bfd2VlayBpZiBlbnRyeVsidXNlcl9pZCJdID09IHVzZXJfaWQpLCAwKQoKICAgICAgICAgICAgICAgIGN1cnJlbnRfd2VlayA9IGRhdGV0aW1lLm5vdygpLmlzb2NhbGVuZGFyKClbMV0KICAgICAgICAgICAgICAgIHRvcF93ZWVrX21lc3NhZ2UgPSAiIgogICAgICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UobWluKDQsIGxlbih0b3Bfd2VlaykpKToKICAgICAgICAgICAgICAgICAgICB0b3Bfd2Vla19tZXNzYWdlICs9ICgKICAgICAgICAgICAgICAgICAgICAgICAgZiJ7aGlkZV91c2VyX2lkKHRvcF93ZWVrW2ldWyd1c2VyX2lkJ10pfSAiCiAgICAgICAgICAgICAgICAgICAgICAgIGYie2Zvcm1hdF9iYWxhbmNlKHRvcF93ZWVrW2ldWydhbW91bnQnXSl9XG4iCiAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIHJlcGx5X21lc3NhZ2UgPSAoCiAgICAgICAgICAgICAgICAgICAgZiJUdeG6p24gbsOgeSBi4bqhbiDEkcOjIGPGsOG7o2M6IDxiPntmb3JtYXRfYmFsYW5jZSh1c2VyX2JldF93ZWVrKX08L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgZiI8Yj5Ub3AgY8aw4bujYyB0deG6p24ge2N1cnJlbnRfd2Vla308L2I+XG4iCiAgICAgICAgICAgICAgICAgICAgZiJUb3AgfCBJRCB8IFRp4buBbiBjxrDhu6NjXG4iCiAgICAgICAgICAgICAgICAgICAgZiJ7dG9wX3dlZWtfbWVzc2FnZX0iCiAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgICAgIHRleHQ9cmVwbHlfbWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSBCWEggdHXhuqduOiB7ZX0iKQogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gQlhIIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCgpkZWYgaGlkZV91c2VyX2lkKHVzZXJfaWQpOgogICAgcmV0dXJuIGYie3VzZXJfaWRbOjZdfSoqKioiCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBtZXNzYWdlLnRleHQgPT0gIvCfjLogSG9hIEjhu5NuZyIpCmRlZiBob2Fob25nKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gecOqdSBj4bqndSB4ZW0gaG9hIGjhu5NuZy4iKQoKICAgICAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbWVzc2FnZS5kYXRlIDwgYm90X3N0YXJ0X3RpbWU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgY+G6pW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgY2hlY2tfc3BhbShtZXNzYWdlKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIHBow6F0IGhp4buHbiBzcGFtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGtow7RuZyB0aOG7gyBn4butaSB0aW4gbmjhuq9uLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAiIiJwaG9uZSA9IGdldF9waG9uZV9udW1iZXIodXNlcl9pZCkKICAgICAgICBpZiBwaG9uZSBpcyBOb25lOgogICAgICAgICAgICBtYXJrdXAgPSBSZXBseUtleWJvYXJkTWFya3VwKHJlc2l6ZV9rZXlib2FyZD1UcnVlLCBvbmVfdGltZV9rZXlib2FyZD1UcnVlKQogICAgICAgICAgICBjb250YWN0X2J1dHRvbiA9IEtleWJvYXJkQnV0dG9uKCLwn5OxIFNoYXJlIE51bWJlciIsIHJlcXVlc3RfY29udGFjdD1UcnVlKQogICAgICAgICAgICBtYXJrdXAuYWRkKGNvbnRhY3RfYnV0dG9uKQogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgbWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgIlZ1aSBsw7JuZyB4w6FjIG1pbmggU8SQVCDEkeG7gyB0aeG6v3AgdOG7pWM6IiwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXAKICAgICAgICAgICAgKQogICAgICAgICAgICByZXR1cm4iIiIKCiAgICAgICAgaG9hX2hvbmdfaG9tX25heSwgaG9hX2hvbmdfdHVhbl9uYXksIGhvYV9ob25nX3RvbmcgPSBnZXRfcmVmX2luZm8odXNlcl9pZCkKICAgICAgICBkZXR1X2NvdW50ID0gZ2V0X2RldHVfY291bnQodXNlcl9pZCkKICAgICAgICBib3RfaW5mbyA9IGJvdC5nZXRfbWUoKQogICAgICAgIHVzZXJuYW1lYm90ID0gYm90X2luZm8udXNlcm5hbWUKCiAgICAgICAgbWVzc2FnZV90ZXh0ID0gKAogICAgICAgICAgICAi8J+RiSBMaW5rIG3hu51pIGLhuqFuIGLDqCBj4bunYSBi4bqhbjpcbiIKICAgICAgICAgICAgZiI8Y29kZT5odHRwczovL3QubWUve3VzZXJuYW1lYm90fT9zdGFydD17dXNlcl9pZH08L2NvZGU+XG4iCiAgICAgICAgICAgICLwn5GIIENMSUNLIFbDgE8gTElOSyBCw4pOIMSQ4buCIENPUFkgVsOAIEfhu6xJIENITyBC4bqgTiBCw4hcblxuIgogICAgICAgICAgICAi8J+MuiBOaOG6rW4gbmdheSBIT0EgSOG7kk5HIGLhurFuZyAyJSBz4buRIHRp4buBbiB0aHVhIGPGsOG7o2MgdOG7qyBuZ8aw4budaSBjaMahaSBtw6AgYuG6oW4gZ2nhu5tpIHRoaeG7h3UuXG5cbiIKICAgICAgICAgICAgZiI8Yj7wn4y6IFThu5VuZyBob2EgaOG7k25nIPCfjLo6IHtmb3JtYXRfYmFsYW5jZShob2FfaG9uZ190b25nKX08L2I+XG5cbiIKICAgICAgICAgICAgZiJT4buRIGzGsOG7o25nIMSR4buHIHThu606IHtkZXR1X2NvdW50fVxuXG4iCiAgICAgICAgICAgIGYiSEggbmjhuq1uIMSRxrDhu6NjIGjDtG0gbmF5OiB7Zm9ybWF0X2JhbGFuY2UoaG9hX2hvbmdfaG9tX25heSl9XG4iCiAgICAgICAgICAgIGYiSEggbmjhuq1uIMSRxrDhu6NjIHR14bqnbiBuw6B5OiB7Zm9ybWF0X2JhbGFuY2UoaG9hX2hvbmdfdHVhbl9uYXkpfSIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gaG9hIGjhu5NuZyBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7bWVzc2FnZV90ZXh0fSIpCiAgICAgICAgbXNnID0gYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD1tZXNzYWdlX3RleHQsIHBhcnNlX21vZGU9UGFyc2VNb2RlLkhUTUwpCgoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IHnDqnUgY+G6p3UgaG9hIGjhu5NuZyBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgIHBhc3MKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dCA9PSAi8J+PhiDEkHVhIFRvcCIpCmRlZiBkdWF0b3AobWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSDEkcOjIHnDqnUgY+G6p3UgeGVtIGLhuqNuZyDEkHVhIFRvcC4iKQoKICAgICAgICBpZiBtZXNzYWdlLmZvcndhcmRfZnJvbSBvciBtZXNzYWdlLmZvcndhcmRfZGF0ZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFRpbiBuaOG6r24gxJHDoyDEkcaw4bujYyBjaHV54buDbiB0aeG6v3AsIGLhu48gcXVhLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGluIG5o4bqvbiDEkcaw4bujYyBn4butaSB0csaw4bubYyBraGkgYm90IGLhuq90IMSR4bqndSwgYuG7jyBxdWEuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBj4bqlbS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGLhu4sgbmdoaSBuZ+G7nSBzcGFtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG5vdCBjYW5fc2VuZF9tZXNzYWdlKHVzZXJfaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGtow7RuZyB0aOG7gyBn4butaSB0aW4gbmjhuq9uLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtZXNzYWdlX3RleHQgPSAiIiIK8J+PhiA8Yj7EkFVBIFRPUCBIw4BORyBOR8OAWTwvYj4KClRvcCBkw6J5IHRo4bqvbmcgKHRoYW5oIHRvw6FuIDEyaCB0csawYSBow7RtIHNhdSk6CvCfpYcgVG9wIDE6IDIwLjAwMCB4dQrwn6WIIFRvcCAyOiAxMC4wMDAgeHUK8J+liSBUb3AgMzogNS4wMDAgeHUKClRvcCBkw6J5IHRodWEgKHRoYW5oIHRvw6FuIDEyaCB0csawYSBow7RtIHNhdSk6CvCfpYcgVG9wIDE6IDMwLjAwMCB4dQrwn6WIIFRvcCAyOiAyMC4wMDAgeHUK8J+liSBUb3AgMzogMTAuMDAwIHh1CiIiIgoKICAgICAgICBrZXlib2FyZCA9IFsKICAgICAgICAgICAgWwogICAgICAgICAgICAgICAgSW5saW5lS2V5Ym9hcmRCdXR0b24oIkTDonkgVGjhuq9uZyIsIGNhbGxiYWNrX2RhdGE9InRvcGRheXRoYW5nIiksCiAgICAgICAgICAgICAgICBJbmxpbmVLZXlib2FyZEJ1dHRvbigiRMOieSBUaHVhIiwgY2FsbGJhY2tfZGF0YT0idG9wZGF5dGh1YSIpCiAgICAgICAgICAgIF0KICAgICAgICBdCiAgICAgICAgcmVwbHlfbWFya3VwID0gSW5saW5lS2V5Ym9hcmRNYXJrdXAoa2V5Ym9hcmQpCgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PW1lc3NhZ2VfdGV4dCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPXJlcGx5X21hcmt1cCwKICAgICAgICAgICAgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTAogICAgICAgICkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgdGluIFRPUCBUSOG6rk5HIFRIVUEgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGfhu61pIFRPUCBUSOG6rk5HIFRIVUEgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKICAgICAgICBwYXNzCgpAYm90Lm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBtZXNzYWdlLnRleHQgPT0gIvCfkaUgR2nhu5tpIHRoaeG7h3UgYuG6oW4gYsOoIikKZGVmIGdpb2l0aGlldWJhbmJlKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjaGVja19zcGFtKG1lc3NhZ2UpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGJvdF9pbmZvID0gYm90LmdldF9tZSgpCiAgICAgICAgdXNlcm5hbWVib3QgPSBib3RfaW5mby51c2VybmFtZQoKICAgICAgICBvcmlnaW5hbF9saW5rID0gZiJodHRwczovL3QubWUve3VzZXJuYW1lYm90fT9zdGFydD17dXNlcl9pZH0iCgogICAgICAgIHRyeToKICAgICAgICAgICAgc2hvcnRlbl9hcGkgPSBmImh0dHBzOi8vdGlueXVybC5jb20vYXBpLWNyZWF0ZS5waHA/dXJsPXtvcmlnaW5hbF9saW5rfSIKICAgICAgICAgICAgc2hvcnRfbGluayA9IHJlcXVlc3RzLmdldChzaG9ydGVuX2FwaSkudGV4dAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2hvcnRfbGluayA9IG9yaWdpbmFsX2xpbmsKICAgICAgICBtZXNzYWdlX3RleHQgPSAoCiAgICAgICAgICAgICLwn5GJIExpbmsgbeG7nWkgYuG6oW4gYsOoIGPhu6dhIGLhuqFuOlxuIgogICAgICAgICAgICBmIjxjb2RlPntzaG9ydF9saW5rfTwvY29kZT5cbiIKICAgICAgICAgICAgIvCfkYggQ0xJQ0sgVsOATyBMSU5LIELDik4gxJDhu4IgQ09QWSBWw4AgR+G7rEkgQ0hPIELhuqBOIELDiFxuXG4iCiAgICAgICAgICAgICLwn4y6IE5o4bqtbiBuZ2F5IEhPQSBI4buSTkcgYuG6sW5nIDIlIHPhu5EgdGnhu4FuIHRodWEgY8aw4bujYyB04burIG5nxrDhu51pIGNoxqFpIG3DoCBi4bqhbiBnaeG7m2kgdGhp4buHdS4iCiAgICAgICAgKQogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UoY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsIHRleHQ9bWVzc2FnZV90ZXh0LCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHBhc3MKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgaW4gWyJ0b3BkYXl0aGFuZyIsICJ0b3BkYXl0aHVhIl0pCmRlZiBkdG9wKGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSB5w6p1IGPhuqd1IEJYSCB24bubaSBk4buvIGxp4buHdSB7Y2FsbC5kYXRhfSIpCgogICAgICAgIGlmIGNhbGwuZGF0YSBpbiBbInRvcGRheXRoYW5nIiwgInRvcGRheXRodWEiXToKICAgICAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgICAgICkKCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB2aWV0bmFtX3R6ID0gcHl0ei50aW1lem9uZSgnQXNpYS9Ib19DaGlfTWluaCcpCiAgICAgICAgZGF0ZV90aW1lID0gZGF0ZXRpbWUubm93KHZpZXRuYW1fdHopLnN0cmZ0aW1lKCIlZC8lbSIpCgogICAgICAgIGRhdGEgPSBbXQogICAgICAgIHdpdGggb3BlbigiY2h1b2l0aGFuZ3RodWEudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAzOgogICAgICAgICAgICAgICAgICAgIHVzZXJfaWQsIGRheXRoYW5nLCBkYXl0aHVhID0gcGFydHMKICAgICAgICAgICAgICAgICAgICBkYXRhLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VyX2lkIjogdXNlcl9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgImRheXRoYW5nIjogaW50KGRheXRoYW5nKSwKICAgICAgICAgICAgICAgICAgICAgICAgImRheXRodWEiOiBpbnQoZGF5dGh1YSkKICAgICAgICAgICAgICAgICAgICB9KQoKICAgICAgICBpZiBjYWxsLmRhdGEgPT0gInRvcGRheXRoYW5nIjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIHjhu60gbMO9IFRPUCBEw4JZIFRI4bquTkcgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQogICAgICAgICAgICB0b3BfZGF5dGhhbmcgPSBzb3J0ZWQoZGF0YSwga2V5PWxhbWJkYSB4OiB4WyJkYXl0aGFuZyJdLCByZXZlcnNlPVRydWUpCiAgICAgICAgICAgIHRvcF90b2RheV9tZXNzYWdlID0gIiIKCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKG1pbigzLCBsZW4odG9wX2RheXRoYW5nKSkpOgogICAgICAgICAgICAgICAgZW50cnkgPSB0b3BfZGF5dGhhbmdbaV0KICAgICAgICAgICAgICAgIHRvcF90b2RheV9tZXNzYWdlICs9ICgKICAgICAgICAgICAgICAgICAgICBmIntoaWRlX3VzZXJfaWQoZW50cnlbJ3VzZXJfaWQnXSl9IC0ge2VudHJ5WydkYXl0aGFuZyddfVxuIgogICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgcmVwbHlfbWVzc2FnZSA9ICgKICAgICAgICAgICAgICAgIGYiPGI+VG9wIGTDonkgdGjhuq9uZyBuZ8OgeSB7ZGF0ZV90aW1lfTwvYj5cblxuIgogICAgICAgICAgICAgICAgZiJ7dG9wX3RvZGF5X21lc3NhZ2V9IgogICAgICAgICAgICApCgogICAgICAgIGVsaWYgY2FsbC5kYXRhID09ICJ0b3BkYXl0aHVhIjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIHjhu60gbMO9IFRPUCBEw4JZIFRIVUEgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQogICAgICAgICAgICB0b3BfZGF5dGh1YSA9IHNvcnRlZChkYXRhLCBrZXk9bGFtYmRhIHg6IHhbImRheXRodWEiXSwgcmV2ZXJzZT1UcnVlKQogICAgICAgICAgICB0b3BfdG9kYXlfbWVzc2FnZSA9ICIiCgogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShtaW4oMywgbGVuKHRvcF9kYXl0aHVhKSkpOgogICAgICAgICAgICAgICAgZW50cnkgPSB0b3BfZGF5dGh1YVtpXQogICAgICAgICAgICAgICAgdG9wX3RvZGF5X21lc3NhZ2UgKz0gKAogICAgICAgICAgICAgICAgICAgIGYie2hpZGVfdXNlcl9pZChlbnRyeVsndXNlcl9pZCddKX0gLSB7ZW50cnlbJ2RheXRodWEnXX1cbiIKICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgIHJlcGx5X21lc3NhZ2UgPSAoCiAgICAgICAgICAgICAgICBmIjxiPlRvcCBkw6J5IHRodWEgbmfDoHkge2RhdGVfdGltZX08L2I+XG5cbiIKICAgICAgICAgICAgICAgIGYie3RvcF90b2RheV9tZXNzYWdlfSIKICAgICAgICAgICAgKQoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PXJlcGx5X21lc3NhZ2UsCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgKQogICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSBCWEggY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKICAgICAgICBwYXNzCgpkZWYgZ2V0X2FsbF9zZWxsaW5nX2l0ZW1zKCk6CiAgICBzZWxsaW5nX2l0ZW1zID0gW10KICAgIHRyeToKICAgICAgICBwcmludCgiW0RFQlVHXSDEkGFuZyDEkeG7jWMgdOG7h3AgRklMRS9jaG8udHh0IMSR4buDIGzhuqV5IGRhbmggc8OhY2ggduG6rXQgcGjhuqltIGLDoW4uIikKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvY2hvLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZmlsZToKICAgICAgICAgICAgICAgIGRhdGEgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiB8ICIpCiAgICAgICAgICAgICAgICBpZiBsZW4oZGF0YSkgPT0gNDoKICAgICAgICAgICAgICAgICAgICBmaXJzdF9wYXJ0ID0gZGF0YVswXS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGZpcnN0X3BhcnQpID49IDI6CiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1faWQgPSBmaXJzdF9wYXJ0WzFdCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGxpbmdfaXRlbXMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6IGl0ZW1faWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZW1vamkiOiBkYXRhWzFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInF1YW50aXR5IjogaW50KGRhdGFbMl0pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInByaWNlIjogZmxvYXQoZGF0YVszXSkKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgdGjDqm0gduG6rXQgcGjhuqltOiBJRD17aXRlbV9pZH0sIEVtb2ppPXtkYXRhWzFdfSwgU+G7kSBsxrDhu6NuZz17ZGF0YVsyXX0sIEdpw6E9e2RhdGFbM119IikKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludCgiW0RFQlVHXSBU4buHcCBGSUxFL2Noby50eHQga2jDtG5nIHTDrG0gdGjhuqV5LiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB44butIGzDvSB04buHcCBGSUxFL2Noby50eHQ6IHtlfSIpCgogICAgcmV0dXJuIHNlbGxpbmdfaXRlbXMKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dCA9PSAi8J+StSBDaOG7oyBnaWFvIGThu4tjaCDwn5K1IikKZGVmIGNob2dpYW9kaWNoKG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7bWVzc2FnZS5mcm9tX3VzZXIuaWR9IHnDqnUgY+G6p3UgeGVtIGNo4bujIGdpYW8gZOG7i2NoLiIpCgogICAgICAgIGlmIG1lc3NhZ2UuZm9yd2FyZF9mcm9tIG9yIG1lc3NhZ2UuZm9yd2FyZF9kYXRlOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBtZXNzYWdlLmRhdGUgPCBib3Rfc3RhcnRfdGltZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQobWVzc2FnZS5mcm9tX3VzZXIuaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge21lc3NhZ2UuZnJvbV91c2VyLmlkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7bWVzc2FnZS5mcm9tX3VzZXIuaWR9IGLhu4sgcGjDoXQgaGnhu4duIHNwYW0uIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaWYgbm90IGNhbl9zZW5kX21lc3NhZ2UobWVzc2FnZS5mcm9tX3VzZXIuaWQpOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge21lc3NhZ2UuZnJvbV91c2VyLmlkfSBraMO0bmcgdGjhu4MgZ+G7rWkgdGluIG5o4bqvbi4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc2VsbGluZ19pdGVtcyA9IGdldF9hbGxfc2VsbGluZ19pdGVtcygpCgogICAgICAgIG1lc3NhZ2VfdGV4dF8xID0gIiIiCkTDuW5nIGzhu4duaCAvc2VsbCBbVMOqbiBW4bqtdCBwaOG6qW1dIFtT4buRIGzGsOG7o25nXSBbU+G7kSB0aeG7gW4gbeG7l2kgVlBdIMSR4buDIGLDoW4KRMO5bmcgbOG7h25oIC9idXkgW0lEXSDEkeG7gyBtdWEgSUQgSXRlbQpEw7luZyBs4buHbmggL2h1eSBbSURdIMSR4buDIGjhu6d5IGLDoW4gSUQgSXRlbQoKUGjDrSBiw6FuIGjDoG5nIGzDoCAxMCUgbmfGsOG7nWkgYsOhbiBjaOG7i3UgcGjDrSwgcGjDrSBo4buneSBsw6AgMSUKClZEOiAvc2VsbCBWIDEgNTAwMCAoxJHhu4MgYsOhbiAxIGvDvSB04buxIFYgZ2nDoSA1LjAwMCkKPGk+TMawdSDDvTogQ8OhYyB24bqtdCBwaOG6qW0gxJHEg25nIGLDoW4gc+G6vSBi4buLIHjDs2Ega2jDtG5nIGhvw6BuIHRy4bqjIGtoaSBxdWEgbmfDoHkgbeG7m2kuIE5nxrDhu51pIGNoxqFpIGPhuqduIGNow7ogw70gaOG7p3kgYsOhbiDEkeG7gyB0csOhbmggbeG6pXQgduG6rXQgcGjhuqltPC9pPgoKTGlzdCBOYW1lIGPDoWMgduG6rXQgcGjhuqltIMSR4buDIGLDoW4gbMOgOiAiTmd1b2lUdXlldCIsICJCb25nVHV5ZXQiLCAiS2VvIiwgIk5nb2lTYW8iLCAiVGhvbmdOaG8iLCAiVGhvbmdEYWNCaWV0Igo8Yj5N4bq3dCBow6BuZyDEkWFuZyDEkcSDbmcgYsOhbiBj4bunYSBi4bqhbiBsw6A8L2I+IiIiCgogICAgICAgIGlmIHNlbGxpbmdfaXRlbXM6CiAgICAgICAgICAgIG1lc3NhZ2VfdGV4dF8yID0gIjxiPkRhbmggc8OhY2ggxJFhbmcgYsOhblxuSUQgIHxJdGVtICB8ICBT4buRIGzGsOG7o25nICB8ICBUaGFuaCB0b8OhbjwvYj5cbiIKICAgICAgICAgICAgZm9yIGl0ZW0gaW4gc2VsbGluZ19pdGVtczoKICAgICAgICAgICAgICAgIG1lc3NhZ2VfdGV4dF8yICs9IGYie2l0ZW1bJ2lkJ119IHwge2l0ZW1bJ2Vtb2ppJ119IHwge2l0ZW1bJ3F1YW50aXR5J119IHwge2Zvcm1hdF9iYWxhbmNlKGl0ZW1bJ3ByaWNlJ10pfVxuIgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIGhp4buDbiB0aOG7iyB24bqtdCBwaOG6qW0gYsOhbjoge2l0ZW1bJ2lkJ119IHwge2l0ZW1bJ2Vtb2ppJ119IHwge2l0ZW1bJ3F1YW50aXR5J119IHwge2Zvcm1hdF9iYWxhbmNlKGl0ZW1bJ3ByaWNlJ10pfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbWVzc2FnZV90ZXh0XzIgPSAiPGI+RGFuaCBzw6FjaCDEkWFuZyBiw6FuXG5JRCAgfEl0ZW0gIHwgIFPhu5EgbMaw4bujbmcgIHwgIFRoYW5oIHRvw6FuPC9iPiIKCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCwgdGV4dD1tZXNzYWdlX3RleHRfMSwgcGFyc2VfbW9kZT1QYXJzZU1vZGUuSFRNTCkKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNoYXRfaWQ9bWVzc2FnZS5jaGF0LmlkLCB0ZXh0PW1lc3NhZ2VfdGV4dF8yLCBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gecOqdSBj4bqndSBjaOG7oyBnaWFvIGThu4tjaCBj4bunYSBuZ8aw4budaSBkw7luZyB7bWVzc2FnZS5mcm9tX3VzZXIuaWR9OiB7ZX0iKQogICAgICAgIHBhc3MKCmRlZiBnZXRfdXNlcl90YXNrKHVzZXJfaWQpOgogICAgdHJ5OgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyDEkeG7jWMgdOG7h3AgRklMRS9kcy50eHQgxJHhu4MgbOG6pXkgbmhp4buHbSB24bulIGPhu6dhIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfS4iKQogICAgICAgIHdpdGggb3BlbigiRklMRS9kcy50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiICIpCiAgICAgICAgICAgIGlmIHBhcnRzWzBdID09IHN0cih1c2VyX2lkKSBhbmQgcGFydHNbLTFdID09ICJGYWxzZSI6CiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGPDsyBuaGnhu4dtIHbhu6UgY2jGsGEgaG/DoG4gdGjDoG5oOiB7cGFydHNbMV19LCB7cGFydHNbMl19IikKICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0c1sxXSwgcGFydHNbMl0KICAgICAgICByZXR1cm4gTm9uZSwgTm9uZQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBU4buHcCBGSUxFL2RzLnR4dCBraMO0bmcgdMOsbSB0aOG6pXkuIikKICAgICAgICByZXR1cm4gTm9uZSwgTm9uZQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gdOG7h3AgRklMRS9kcy50eHQ6IHtlfSIpCiAgICAgICAgcmV0dXJuIE5vbmUsIE5vbmUKCmRlZiBnZXRfdXNlcl9uaGllbXZ1KHVzZXJfaWQpOgogICAgdHJ5OgogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkGFuZyDEkeG7jWMgdOG7h3AgRklMRS9uaGllbXZ1LnR4dCDEkeG7gyBs4bqleSBuaGnhu4dtIHbhu6UgY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9LiIpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL25oaWVtdnUudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAiKQogICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gY8OzIHtpbnQocGFydHNbMV0pfSBuaGnhu4dtIHbhu6UuIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW50KHBhcnRzWzFdKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIGPDsyBuaGnhu4dtIHbhu6UgbsOgby4iKQogICAgICAgIHJldHVybiAwCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIFThu4dwIEZJTEUvbmhpZW12dS50eHQga2jDtG5nIHTDrG0gdGjhuqV5LiIpCiAgICAgICAgcmV0dXJuIDAKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHjhu60gbMO9IHThu4dwIEZJTEUvbmhpZW12dS50eHQ6IHtlfSIpCiAgICAgICAgcmV0dXJuIDAKCkBib3QubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UudGV4dCA9PSAi8J+XkiBOaGnhu4dtIFbhu6Ug8J+XkiIpCmRlZiBuaGllbXZ1KG1lc3NhZ2UpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIobWVzc2FnZS5mcm9tX3VzZXIuaWQpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSB5w6p1IGPhuqd1IHhlbSBuaGnhu4dtIHbhu6UuIikKCiAgICAgICAgaWYgbWVzc2FnZS5mb3J3YXJkX2Zyb20gb3IgbWVzc2FnZS5mb3J3YXJkX2RhdGU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIG1lc3NhZ2UuZGF0ZSA8IGJvdF9zdGFydF90aW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBpc191c2VyX2Jhbm5lZCh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGNoZWNrX3NwYW0obWVzc2FnZSk6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gYuG7iyBwaMOhdCBoaeG7h24gc3BhbS4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBub3QgY2FuX3NlbmRfbWVzc2FnZSh1c2VyX2lkKToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBraMO0bmcgdGjhu4MgZ+G7rWkgdGluIG5o4bqvbi4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgc29fbHVvbmcgPSBnZXRfdXNlcl9uaGllbXZ1KHVzZXJfaWQpCiAgICAgICAgc29fbGFuX3RoYW5nLCBzb190aWVuX2N1b2MgPSBnZXRfdXNlcl90YXNrKHVzZXJfaWQpCgogICAgICAgIGtleWJvYXJkID0gW10KICAgICAgICBpZiBzb19sYW5fdGhhbmcgYW5kIHNvX3RpZW5fY3VvYzoKICAgICAgICAgICAgbWVzc2FnZV90ZXh0ID0gKAogICAgICAgICAgICAgICAgZiJC4bqhbiDEkcOjIHRo4buxYyBoaeG7h24gxJHGsOG7o2MgPGI+e3NvX2x1b25nfTwvYj4gbmhp4buHbSB24bulLlxuXG4iCiAgICAgICAgICAgICAgICBmIkhvw6BuIHRow6BuaCBjaHXhu5dpIDxiPntzb19sYW5fdGhhbmd9IGzhuqduIHRo4bqvbmcgbGnDqm4gdGnhur9wIOG7nyBHYW1lIFjDumMgeOG6r2M8L2I+ICIKICAgICAgICAgICAgICAgIGYiduG7m2kgc+G7kSB0aeG7gW4gdOG7kWkgdGhp4buDdSBjaG8gbeG7l2kgbOG7h25oIGPGsOG7o2MgbMOgIDxiPntmb3JtYXRfYmFsYW5jZShpbnQoc29fdGllbl9jdW9jKSl9PC9iPiIKICAgICAgICAgICAgKQogICAgICAgICAgICBrZXlib2FyZC5hcHBlbmQoW0lubGluZUtleWJvYXJkQnV0dG9uKCJI4buneSBuaGnhu4dtIHbhu6UiLCBjYWxsYmFja19kYXRhPSdodXluaGllbXZ1JyldKQogICAgICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGPDsyBuaGnhu4dtIHbhu6U6IHtzb19sYW5fdGhhbmd9IGzhuqduIHRo4bqvbmcsIGPGsOG7o2Mge3NvX3RpZW5fY3VvY30iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG1lc3NhZ2VfdGV4dCA9IGYiQuG6oW4gxJHDoyB0aOG7sWMgaGnhu4duIMSRxrDhu6NjIDxiPntzb19sdW9uZ308L2I+IG5oaeG7h20gduG7pS5cblxuQuG6oW4gY2jGsGEgY8OzIG5oaeG7h20gduG7pSBuw6BvIGPhuqduIHRo4buxYyBoaeG7h24uIgogICAgICAgICAgICBrZXlib2FyZC5hcHBlbmQoW0lubGluZUtleWJvYXJkQnV0dG9uKCJOaOG6rW4gbmhp4buHbSB24bulIiwgY2FsbGJhY2tfZGF0YT0nbmhhbm5oaWVtdnUnKV0pCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gY2jGsGEgY8OzIG5oaeG7h20gduG7pSBuw6BvLiIpCgogICAgICAgIHJlcGx5X21hcmt1cCA9IElubGluZUtleWJvYXJkTWFya3VwKGtleWJvYXJkKSBpZiBrZXlib2FyZCBlbHNlIE5vbmUKCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD1tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIHRleHQ9bWVzc2FnZV90ZXh0LAogICAgICAgICAgICByZXBseV9tYXJrdXA9cmVwbHlfbWFya3VwLAogICAgICAgICAgICBwYXJzZV9tb2RlPVBhcnNlTW9kZS5IVE1MCiAgICAgICAgKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgeOG7rSBsw70gecOqdSBj4bqndSBuaGnhu4dtIHbhu6UgY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgIHBhc3MKCmRlZiBnZXRfdXNlcl90YXNrX3N0YXR1cyh1c2VyX2lkKToKICAgIHRyeToKICAgICAgICBwcmludChmIltERUJVR10gxJBhbmcga2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIG5oaeG7h20gduG7pSBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvZHMudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAiKQogICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkIGFuZCBwYXJ0c1stMV0gPT0gIkZhbHNlIjoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gY8OzIG5oaeG7h20gduG7pSBjaMawYSBob8OgbiB0aMOgbmguIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIGPDsyBuaGnhu4dtIHbhu6UgY2jGsGEgaG/DoG4gdGjDoG5oLiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICBwcmludChmIltERUJVR10gVOG7h3AgRklMRS9kcy50eHQga2jDtG5nIHTDrG0gdGjhuqV5LiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIMSR4buNYyB04buHcCBGSUxFL2RzLnR4dDoge2V9IikKICAgICAgICByZXR1cm4gVHJ1ZQoKZGVmIHNhdmVfdGFzayh1c2VyX2lkLCBzb19sYW5fdGhhbmcsIHNvX3RpZW5fY3VvYyk6CiAgICB0cnk6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQYW5nIGzGsHUgbmhp4buHbSB24bulIG3hu5tpIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gduG7m2kge3NvX2xhbl90aGFuZ30gbOG6p24gdGjhuq9uZyB2w6Age3NvX3RpZW5fY3VvY30gdGnhu4FuIGPGsOG7o2MuIikKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvZHMudHh0IiwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IHtzb19sYW5fdGhhbmd9IHtzb190aWVuX2N1b2N9IEZhbHNlXG4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgbMawdSBuaGnhu4dtIHbhu6UgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfToge2V9IikKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gIm5oYW5uaGllbXZ1IikKZGVmIG5oYW5uaGllbXZ1KGNhbGwpOgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBzdHIoY2FsbC5mcm9tX3VzZXIuaWQpCiAgICAgICAgaWYgaXNfdXNlcl9iYW5uZWQodXNlcl9pZCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBib3QuZWRpdF9tZXNzYWdlX3JlcGx5X21hcmt1cCgKICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgbWVzc2FnZV9pZD1jYWxsLm1lc3NhZ2UubWVzc2FnZV9pZCwKICAgICAgICAgICAgcmVwbHlfbWFya3VwPU5vbmUKICAgICAgICApCgogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgIGlmIG5vdCBnZXRfdXNlcl90YXNrX3N0YXR1cyh1c2VyX2lkKToKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkLhuqFuIGNoxrBhIGhvw6BuIHRow6BuaCBuaGnhu4dtIHbhu6UgdHLGsOG7m2MuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHNvX2xhbl90aGFuZyA9IHJhbmRvbS5yYW5kaW50KDUsIDkpCiAgICAgICAgc29fdGllbl9jdW9jID0gcmFuZG9tLnJhbmRpbnQoNTU1NSwgOTk5OSkKICAgICAgICBmb3JtYXR0ZWRfc29fdGllbl9jdW9jID0gZm9ybWF0X2JhbGFuY2Uoc29fdGllbl9jdW9jKQoKICAgICAgICBzYXZlX3Rhc2sodXNlcl9pZCwgc29fbGFuX3RoYW5nLCBzb190aWVuX2N1b2MpCgogICAgICAgIG5oaWVtX3Z1X3RleHQgPSAoCiAgICAgICAgICAgIGYiTmhp4buHbSB24bulIGPhu6dhIGLhuqFuIGzDoDpcbiIKICAgICAgICAgICAgZiJIb8OgbiB0aMOgbmggY2h14buXaSA8Yj57c29fbGFuX3RoYW5nfSBs4bqnbiB0aOG6r25nIGxpw6puIHRp4bq/cCDhu58gR2FtZSBYw7pjIHjhuq9jPC9iPiAiCiAgICAgICAgICAgIGYiduG7m2kgc+G7kSB0aeG7gW4gdOG7kWkgdGhp4buDdSBjaG8gbeG7l2kgbOG7h25oIGPGsOG7o2MgbMOgIDxiPntmb3JtYXR0ZWRfc29fdGllbl9jdW9jfTwvYj4iCiAgICAgICAgKQoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBuaGllbV92dV90ZXh0LCBwYXJzZV9tb2RlPSJIVE1MIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIHThuqFvIG5oaeG7h20gduG7pSBt4bubaSBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7ZX0iKQogICAgICAgIHBhc3MKCkBib3QuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gImh1eW5oaWVtdnUiKQpkZWYgaHV5bmhpZW12dShjYWxsKToKICAgIHRyeToKICAgICAgICB1c2VyX2lkID0gc3RyKGNhbGwuZnJvbV91c2VyLmlkKQogICAgICAgIGlmIGlzX3VzZXJfYmFubmVkKHVzZXJfaWQpOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYm90LmVkaXRfbWVzc2FnZV9yZXBseV9tYXJrdXAoCiAgICAgICAgICAgIGNoYXRfaWQ9Y2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgICAgIG1lc3NhZ2VfaWQ9Y2FsbC5tZXNzYWdlLm1lc3NhZ2VfaWQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1Ob25lCiAgICAgICAgKQoKICAgICAgICBpZiB1cGRhdGVfdGFza19zdGF0dXModXNlcl9pZCk6CiAgICAgICAgICAgIGJvdC5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgICAgICAgICAgYm90LnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIsSQw6MgaOG7p3kgbmhp4buHbSB24bulLiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0gxJHDoyBo4buneSBuaGnhu4dtIHbhu6UuIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBib3QuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgICAgIHBhc3MKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGjhu6d5IG5oaeG7h20gduG7pSBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH06IHtlfSIpCiAgICAgICAgcGFzcwoKZGVmIHVwZGF0ZV90YXNrX3N0YXR1cyh1c2VyX2lkKToKICAgIHRyeToKICAgICAgICBwcmludChmIltERUJVR10gxJBhbmcgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbmhp4buHbSB24bulIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZH0uIikKICAgICAgICB3aXRoIG9wZW4oIkZJTEUvZHMudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL2RzLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiICIpCiAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkIGFuZCBwYXJ0c1stMV0gPT0gIkZhbHNlIjoKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IHtwYXJ0c1sxXX0ge3BhcnRzWzJdfSBUcnVlXG4iKQogICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGPhuq1wIG5o4bqtdCBuaGnhu4dtIHbhu6UgY+G7p2EgbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IHRow6BuaCBob8OgbiB0aMOgbmguIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZShsaW5lKQogICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBU4buHcCBGSUxFL2RzLnR4dCBraMO0bmcgdMOsbSB0aOG6pXkuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIG5oaeG7h20gduG7pSBjaG8gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9OiB7ZX0iKQoKZGVmIHVwZGF0ZV9jdW9jdGllbih1c2VyX2lkLCBhbW91bnQpOgogICAgZmlsZV9wYXRoID0gIkZJTEUvY3VvY3RpZW4udHh0IgogICAgdXBkYXRlZCA9IEZhbHNlCiAgICBsaW5lcyA9IFtdCiAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB1aWQsIHZhbCA9IHBhcnRzCiAgICAgICAgICAgICAgICBpZiB1aWQgPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgIG5ld190b3RhbCA9IGludCh2YWwpICsgYW1vdW50CiAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VpZH0ge25ld190b3RhbH0iKQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1aWR9IHt2YWx9IikKICAgIGlmIG5vdCB1cGRhdGVkOgogICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7YW1vdW50fSIpCiAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgIGYud3JpdGUobGluZSArICJcbiIpCgpAYm90MS5tZXNzYWdlX2hhbmRsZXIoZnVuYz1sYW1iZGEgbWVzc2FnZTogYm9vbChyZS5zZWFyY2gocicoP2kpXGJuYXBiYW5rXGInLCBtZXNzYWdlLnRleHQpKSkKZGVmIE5BUEJBTksobWVzc2FnZSk6CiAgICBjb21tYW5kX3BhcnRzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgdXNlcl9hZG1pbiA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfYWRtaW59IGfhu61pIGzhu4duaDoge21lc3NhZ2UudGV4dH0iKQoKICAgIGlmIHVzZXJfYWRtaW4gbm90IGluIEFETUlOOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9hZG1pbn0ga2jDtG5nIHBo4bqjaSBsw6AgYWRtaW4uIikKICAgICAgICByZXR1cm4KCiAgICBpZiBsZW4oY29tbWFuZF9wYXJ0cykgIT0gMyBvciBjb21tYW5kX3BhcnRzWzBdLmxvd2VyKCkgIT0gIm5hcGJhbmsiOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buHbmgga2jDtG5nIGjhu6NwIGzhu4cgaG/hurdjIHRoaeG6v3UgdGhhbSBz4buRLiIpCiAgICAgICAgcmV0dXJuCgogICAgbWFuYXBfZGF0YSA9IHJlYWRfbWFuYXBfZmlsZSgpCiAgICB1c2VyX2lkZW50aWZpZXIgPSBjb21tYW5kX3BhcnRzWzFdLnN0cmlwKCkKICAgIGFtb3VudF90b19uYXBfc3RyID0gY29tbWFuZF9wYXJ0c1syXS5zdHJpcCgpCgogICAgdHJ5OgogICAgICAgIGFtb3VudF90b19uYXAgPSBpbnQoYW1vdW50X3RvX25hcF9zdHIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFPhu5EgdGnhu4FuIG7huqFwOiB7YW1vdW50X3RvX25hcH0iKQogICAgICAgIGlmIGFtb3VudF90b19uYXAgPCAxIG9yIGFtb3VudF90b19uYXAgPiAxXzAwMF8wMDBfMDAwXzAwMDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFPhu5EgdGnhu4FuIG7huqFwIG5nb8OgaSBnaeG7m2kgaOG6oW4gKDEgxJHhur9uIDEgbmdow6xuIHThu7cpLiIpCiAgICAgICAgICAgIHJldHVybgogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEdpw6EgdHLhu4sgdGnhu4FuIG7huqFwIGtow7RuZyBo4bujcCBs4buHLiIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgdXNlcl9pZGVudGlmaWVyIGluIG1hbmFwX2RhdGE6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX2lkX3RvX25hcCA9IGludChtYW5hcF9kYXRhW3VzZXJfaWRlbnRpZmllcl0pCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUw6xtIHRo4bqleSBJRCBuZ8aw4budaSBkw7luZyB04burIG3Dozoge3VzZXJfaWRfdG9fbmFwfSIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBNw6MgbmfGsOG7nWkgZMO5bmcga2jDtG5nIGjhu6NwIGzhu4cgdHJvbmcgbWFuYXBfZGF0YS4iKQogICAgICAgICAgICByZXR1cm4KICAgIGVsc2U6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX2lkX3RvX25hcCA9IGludCh1c2VyX2lkZW50aWZpZXIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBEw7luZyBJRCB0cuG7sWMgdGnhur9wOiB7dXNlcl9pZF90b19uYXB9IikKICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEdpw6EgdHLhu4sgSUQgbmfGsOG7nWkgZMO5bmcga2jDtG5nIGjhu6NwIGzhu4cuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIHVzZXJfaW5mbyA9IGJvdC5nZXRfY2hhdCh1c2VyX2lkX3RvX25hcCkKICAgICAgICBmdWxsbmFtZV90b19uYXAgPSB1c2VyX2luZm8uZmlyc3RfbmFtZSBvciAiIgogICAgICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgICAgIGZ1bGxuYW1lX3RvX25hcCArPSBmIiB7dXNlcl9pbmZvLmxhc3RfbmFtZX0iCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFRow7RuZyB0aW4gbmfGsOG7nWkgZMO5bmc6IHtmdWxsbmFtZV90b19uYXB9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgYm90MS5yZXBseV90byhtZXNzYWdlLCAiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIG7DoHkuIikKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIHbhu5tpIElEIHt1c2VyX2lkX3RvX25hcH0uIikKICAgICAgICByZXR1cm4KCiAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkX3RvX25hcCkKICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlICsgYW1vdW50X3RvX25hcAogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZF90b19uYXAsIG5ld19iYWxhbmNlKQogICAgdXBkYXRlX2N1b2N0aWVuKHVzZXJfaWRfdG9fbmFwLCBhbW91bnRfdG9fbmFwKQogICAgY3VycmVudF90aW1lID0gZ2V0X3ZpZXRuYW1fdGltZSgpCiAgICBwcmludChmIltERUJVR10gVGjhu51pIGdpYW4gZ2lhbyBk4buLY2g6IHtjdXJyZW50X3RpbWV9IikKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCdGSUxFL2xzbmFwLnR4dCcsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkX3RvX25hcH0gLSB7Y3VycmVudF90aW1lfSAtIEJBTksgLSB7YW1vdW50X3RvX25hcH1cbiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGdoaSBs4buLY2ggc+G7rSBu4bqhcDoge3VzZXJfaWRfdG9fbmFwfSAtIHtjdXJyZW50X3RpbWV9IC0gQkFOSyAtIHthbW91bnRfdG9fbmFwfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGdoaSBs4buLY2ggc+G7rSBu4bqhcDoge2V9IikKICAgICAgICByZXR1cm4KCiAgICBhZG1pbl9tZXNzYWdlID0gKAogICAgICAgIGYi4pyFIMSQw6MgbuG6oXAgdGjDoG5oIGPDtG5nXG4iCiAgICAgICAgZiLwn5GkIE5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWVfdG9fbmFwfVxuIgogICAgICAgIGYi8J+GlCBJRDogPGNvZGU+e3VzZXJfaWRfdG9fbmFwfTwvY29kZT5cbiIKICAgICAgICBmIvCfkrAgU+G7kSB4dSBu4bqhcDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfSB4dVxuIgogICAgICAgIGYi8J+StSBT4buRIHh1IG3hu5tpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSB4dVxuIgogICAgICAgIGYi4o+zIFRo4budaSBnaWFuOiB7Y3VycmVudF90aW1lfSIKICAgICkKICAgIGZvciBhZG1pbl9pZCBpbiBBRE1JTjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGFkbWluX2lkLCBhZG1pbl9tZXNzYWdlLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gbuG6oXAgY2hvIGFkbWluIHthZG1pbl9pZH0uIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSB0aMO0bmcgYsOhbyDEkeG6v24gYWRtaW4ge2FkbWluX2lkfToge2V9IikKCiAgICB1c2VyX21lc3NhZ2UgPSAoCiAgICAgICAgZiJUYWRhYSEgQuG6oW4gduG7q2EgbuG6oXAgQkFOSyB0aMOgbmggY8O0bmcgc+G7kSB4dToge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfVxuXG4iCiAgICAgICAgZiJNR0Q6IHtyYW5kb20ucmFuZGludCgxMDAwMDAwMDAwMCwgOTk5OTk5OTk5OTkpfVxuIgogICAgICAgIGYiLSBT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1IgogICAgKQogICAgdHJ5OgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZF90b19uYXAsIHVzZXJfbWVzc2FnZSkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBu4bqhcCB0aMOgbmggY8O0bmcgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH0uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgdGjDtG5nIGLDoW8gxJHhur9uIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH06IHtlfSIpCgogICAgZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkX3RvX25hcCkKICAgIGhpZGRlbl91c2VyX2lkID0gdXNlcl9pZF9zdHJbOjZdICsgIioqKioiCiAgICBncm91cF9tZXNzYWdlID0gKAogICAgICAgIGYiPGI+TmfGsOG7nWkgY2jGoWkgSUQ6IHtoaWRkZW5fdXNlcl9pZH1cblxuIgogICAgICAgIGYiLSBO4bqhcCBCQU5LIHRow6BuaCBjw7RuZyB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX25hcCl9IHh1PC9iPiIKICAgICkKICAgIG90aGVyX2JvdF90b2tlbiA9ICI4NDkzNzAzMjk3OkFBSFNmOHdUeGlwbjdURVRQMUI5WVNXcWFSNjBHbEpzVkhjIgogICAgdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e290aGVyX2JvdF90b2tlbn0vc2VuZE1lc3NhZ2UiCiAgICBwYXlsb2FkID0gewogICAgICAgICJjaGF0X2lkIjogZ3JvdXBfY2hhdF9pZCwKICAgICAgICAidGV4dCI6IGdyb3VwX21lc3NhZ2UsCiAgICAgICAgInBhcnNlX21vZGUiOiAiSFRNTCIKICAgIH0KICAgIHRyeToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QodXJsLCBqc29uPXBheWxvYWQpCiAgICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gbuG6oXAgdsOgbyBuaMOzbS4iKQogICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgdGjDtG5nIGLDoW8gxJHhur9uIG5ow7NtOiB7ZX0iKQoKQGJvdDEubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IGJvb2wocmUuc2VhcmNoKHInKD9pKVxibmFwbW9tb1xiJywgbWVzc2FnZS50ZXh0KSkpCmRlZiBOQVBNT01PKG1lc3NhZ2UpOgogICAgY29tbWFuZF9wYXJ0cyA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KCkKICAgIHVzZXJfYWRtaW4gPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2FkbWlufSBn4butaSBs4buHbmg6IHttZXNzYWdlLnRleHR9IikKCiAgICBpZiB1c2VyX2FkbWluIG5vdCBpbiBBRE1JTjoKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfYWRtaW59IGtow7RuZyBwaOG6o2kgbMOgIGFkbWluLiIpCiAgICAgICAgcmV0dXJuCiAgICBpZiBsZW4oY29tbWFuZF9wYXJ0cykgIT0gMyBvciBjb21tYW5kX3BhcnRzWzBdLmxvd2VyKCkgIT0gIm5hcG1vbW8iOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buHbmgga2jDtG5nIGjhu6NwIGzhu4cgaG/hurdjIHRoaeG6v3UgdGhhbSBz4buRLiIpCiAgICAgICAgcmV0dXJuCgogICAgbWFuYXBfZGF0YSA9IHJlYWRfbWFuYXBfZmlsZSgpCiAgICB1c2VyX2lkZW50aWZpZXIgPSBjb21tYW5kX3BhcnRzWzFdLnN0cmlwKCkKICAgIGFtb3VudF90b19uYXBfc3RyID0gY29tbWFuZF9wYXJ0c1syXS5zdHJpcCgpCgogICAgdHJ5OgogICAgICAgIGFtb3VudF90b19uYXAgPSBpbnQoYW1vdW50X3RvX25hcF9zdHIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIFPhu5EgdGnhu4FuIG7huqFwIE1PTU86IHthbW91bnRfdG9fbmFwfSIpCiAgICAgICAgaWYgYW1vdW50X3RvX25hcCA8IDEgb3IgYW1vdW50X3RvX25hcCA+IDFfMDAwXzAwMF8wMDBfMDAwOgogICAgICAgICAgICBwcmludChmIltERUJVR10gU+G7kSB0aeG7gW4gbuG6oXAgbmdvw6BpIGdp4bubaSBo4bqhbiAoMSDEkeG6v24gMSBuZ2jDrG4gdOG7tykuIikKICAgICAgICAgICAgcmV0dXJuCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBwcmludChmIltERUJVR10gR2nDoSB0cuG7iyB0aeG7gW4gbuG6oXAgTU9NTyBraMO0bmcgaOG7o3AgbOG7hy4iKQogICAgICAgIHJldHVybgoKICAgIGlmIHVzZXJfaWRlbnRpZmllciBpbiBtYW5hcF9kYXRhOgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcl9pZF90b19uYXAgPSBpbnQobWFuYXBfZGF0YVt1c2VyX2lkZW50aWZpZXJdKQogICAgICAgICAgICBwcmludChmIltERUJVR10gVMOsbSB0aOG6pXkgSUQgbmfGsOG7nWkgZMO5bmcgdOG7qyBtw6M6IHt1c2VyX2lkX3RvX25hcH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGNodXnhu4NuIElEIHThu6sgbWFuYXBfZGF0YToge2V9IikKICAgICAgICAgICAgcmV0dXJuCiAgICBlbHNlOgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcl9pZF90b19uYXAgPSBpbnQodXNlcl9pZGVudGlmaWVyKQogICAgICAgICAgICBwcmludChmIltERUJVR10gRMO5bmcgSUQgdHLhu7FjIHRp4bq/cDoge3VzZXJfaWRfdG9fbmFwfSIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBHacOhIHRy4buLIElEIG5nxrDhu51pIGTDuW5nIGtow7RuZyBo4bujcCBs4buHLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b19uYXApCiAgICAgICAgZnVsbG5hbWVfdG9fbmFwID0gdXNlcl9pbmZvLmZpcnN0X25hbWUgb3IgIiIKICAgICAgICBpZiB1c2VyX2luZm8ubGFzdF9uYW1lOgogICAgICAgICAgICBmdWxsbmFtZV90b19uYXAgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIG5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWVfdG9fbmFwfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGJvdDEucmVwbHlfdG8obWVzc2FnZSwgIktow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyBuw6B5LiIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyB24bubaSBJRCB7dXNlcl9pZF90b19uYXB9LiIpCiAgICAgICAgcmV0dXJuCgogICAgY3VycmVudF9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZF90b19uYXApCiAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19uYXAKICAgIHVwZGF0ZV92aWNoaW5oKHVzZXJfaWRfdG9fbmFwLCBuZXdfYmFsYW5jZSkKICAgIHVwZGF0ZV9jdW9jdGllbih1c2VyX2lkX3RvX25hcCwgYW1vdW50X3RvX25hcCkKICAgIGN1cnJlbnRfdGltZSA9IGdldF92aWV0bmFtX3RpbWUoKQogICAgcHJpbnQoZiJbREVCVUddIFRo4budaSBnaWFuIGdpYW8gZOG7i2NoOiB7Y3VycmVudF90aW1lfSIpCgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbignRklMRS9sc25hcC50eHQnLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZiJ7dXNlcl9pZF90b19uYXB9IC0ge2N1cnJlbnRfdGltZX0gLSBNT01PIC0ge2Ftb3VudF90b19uYXB9XG4iKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBnaGkgbOG7i2NoIHPhu60gbuG6oXAgTU9NTzoge3VzZXJfaWRfdG9fbmFwfSAtIHtjdXJyZW50X3RpbWV9IC0gTU9NTyAtIHthbW91bnRfdG9fbmFwfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGdoaSBs4buLY2ggc+G7rSBu4bqhcDoge2V9IikKICAgICAgICByZXR1cm4KCiAgICBhZG1pbl9tZXNzYWdlID0gKAogICAgICAgIGYi4pyFIMSQw6MgbuG6oXAgdGjDoG5oIGPDtG5nXG4iCiAgICAgICAgZiLwn5GkIE5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWVfdG9fbmFwfVxuIgogICAgICAgIGYi8J+GlCBJRDogPGNvZGU+e3VzZXJfaWRfdG9fbmFwfTwvY29kZT5cbiIKICAgICAgICBmIvCfkrAgU+G7kSB4dSBu4bqhcDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfSB4dVxuIgogICAgICAgIGYi8J+StSBT4buRIHh1IG3hu5tpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSB4dVxuIgogICAgICAgIGYi4o+zIFRo4budaSBnaWFuOiB7Y3VycmVudF90aW1lfSIKICAgICkKICAgIGZvciBhZG1pbl9pZCBpbiBBRE1JTjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGFkbWluX2lkLCBhZG1pbl9tZXNzYWdlLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gbuG6oXAgTU9NTyBjaG8gYWRtaW4ge2FkbWluX2lkfS4iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvIMSR4bq/biBhZG1pbiB7YWRtaW5faWR9OiB7ZX0iKQoKICAgIHVzZXJfbWVzc2FnZSA9ICgKICAgICAgICBmIlRhZGFhISBC4bqhbiB24burYSBu4bqhcCBNT01PIHRow6BuaCBjw7RuZyBz4buRIHh1OiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX25hcCl9XG5cbiIKICAgICAgICBmIk1HRDoge3JhbmRvbS5yYW5kaW50KDEwMDAwMDAwMDAwLCA5OTk5OTk5OTk5OSl9XG4iCiAgICAgICAgZiItIFPhu5EgZMawIGhp4buHbiB04bqhaToge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0geHUiCiAgICApCiAgICB0cnk6CiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSh1c2VyX2lkX3RvX25hcCwgdXNlcl9tZXNzYWdlKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG7huqFwIHRow6BuaCBjw7RuZyBNT01PIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZF90b19uYXB9LiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGfhu61pIHRow7RuZyBiw6FvIMSR4bq/biBuZ8aw4budaSBkw7luZyB7dXNlcl9pZF90b19uYXB9OiB7ZX0iKQoKICAgIGdyb3VwX2NoYXRfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZF90b19uYXApCiAgICBoaWRkZW5fdXNlcl9pZCA9IHVzZXJfaWRfc3RyWzo2XSArICIqKioqIgogICAgZ3JvdXBfbWVzc2FnZSA9ICgKICAgICAgICBmIjxiPk5nxrDhu51pIGNoxqFpIElEOiB7aGlkZGVuX3VzZXJfaWR9XG5cbiIKICAgICAgICBmIi0gTuG6oXAgTU9NTyB0aMOgbmggY8O0bmcge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfSB4dTwvYj4iCiAgICApCiAgICBvdGhlcl9ib3RfdG9rZW4gPSAiODQ5MzcwMzI5NzpBQUhTZjh3VHhpcG43VEVUUDFCOVlTV3FhUjYwR2xKc1ZIYyIKICAgIHVybCA9IGYiaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdHtvdGhlcl9ib3RfdG9rZW59L3NlbmRNZXNzYWdlIgogICAgcGF5bG9hZCA9IHsKICAgICAgICAiY2hhdF9pZCI6IGdyb3VwX2NoYXRfaWQsCiAgICAgICAgInRleHQiOiBncm91cF9tZXNzYWdlLAogICAgICAgICJwYXJzZV9tb2RlIjogIkhUTUwiCiAgICB9CiAgICB0cnk6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1wYXlsb2FkKQogICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG7huqFwIE1PTU8gdsOgbyBuaMOzbS4iKQogICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgdGjDtG5nIGLDoW8gxJHhur9uIG5ow7NtOiB7ZX0iKQoKQGJvdDEubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IGJvb2wocmUuc2VhcmNoKHInKD9pKVxibmFwdGhlXGInLCBtZXNzYWdlLnRleHQpKSkKZGVmIE5BUFRIRShtZXNzYWdlKToKICAgIGNvbW1hbmRfcGFydHMgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCiAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge21lc3NhZ2UuZnJvbV91c2VyLmlkfSBn4butaSBs4buHbmg6IHttZXNzYWdlLnRleHR9IikKCiAgICBpZiBtZXNzYWdlLmZyb21fdXNlci5pZCBub3QgaW4gQURNSU46CiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHttZXNzYWdlLmZyb21fdXNlci5pZH0ga2jDtG5nIHBo4bqjaSBsw6AgYWRtaW4uIikKICAgICAgICByZXR1cm4KICAgIGlmIGxlbihjb21tYW5kX3BhcnRzKSAhPSAzIG9yIGNvbW1hbmRfcGFydHNbMF0ubG93ZXIoKSAhPSAibmFwdGhlIjoKICAgICAgICBwcmludChmIltERUJVR10gTOG7h25oIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyB0aGnhur91IHRoYW0gc+G7kS4iKQogICAgICAgIHJldHVybgoKICAgIG1hbmFwX2RhdGEgPSByZWFkX21hbmFwX2ZpbGUoKQogICAgdXNlcl9pZGVudGlmaWVyID0gY29tbWFuZF9wYXJ0c1sxXS5zdHJpcCgpCiAgICBhbW91bnRfdG9fbmFwX3N0ciA9IGNvbW1hbmRfcGFydHNbMl0uc3RyaXAoKQoKICAgIHRyeToKICAgICAgICBhbW91bnRfdG9fbmFwID0gaW50KGFtb3VudF90b19uYXBfc3RyKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBT4buRIHRp4buBbiBu4bqhcDoge2Ftb3VudF90b19uYXB9IikKICAgICAgICBpZiBhbW91bnRfdG9fbmFwIDwgMSBvciBhbW91bnRfdG9fbmFwID4gMV8wMDBfMDAwXzAwMF8wMDA6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBT4buRIHRp4buBbiBu4bqhcCBuZ2/DoGkgZ2nhu5tpIGjhuqFuICgxIMSR4bq/biAxIG5naMOsbiB04bu3KS4iKQogICAgICAgICAgICByZXR1cm4KICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBHacOhIHRy4buLIHRp4buBbiBu4bqhcCBraMO0bmcgaOG7o3AgbOG7hy4iKQogICAgICAgIHJldHVybgoKICAgIGlmIHVzZXJfaWRlbnRpZmllciBpbiBtYW5hcF9kYXRhOgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcl9pZF90b19uYXAgPSBpbnQobWFuYXBfZGF0YVt1c2VyX2lkZW50aWZpZXJdKQogICAgICAgICAgICBwcmludChmIltERUJVR10gVMOsbSB0aOG6pXkgSUQgbmfGsOG7nWkgZMO5bmcgdOG7qyBtw6M6IHt1c2VyX2lkX3RvX25hcH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGNodXnhu4NuIElEIHThu6sgbWFuYXBfZGF0YToge2V9IikKICAgICAgICAgICAgcmV0dXJuCiAgICBlbHNlOgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcl9pZF90b19uYXAgPSBpbnQodXNlcl9pZGVudGlmaWVyKQogICAgICAgICAgICBwcmludChmIltERUJVR10gRMO5bmcgSUQgdHLhu7FjIHRp4bq/cDoge3VzZXJfaWRfdG9fbmFwfSIpCiAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBHacOhIHRy4buLIElEIG5nxrDhu51pIGTDuW5nIGtow7RuZyBo4bujcCBs4buHLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b19uYXApCiAgICAgICAgZnVsbG5hbWVfdG9fbmFwID0gdXNlcl9pbmZvLmZpcnN0X25hbWUgb3IgIiIKICAgICAgICBpZiB1c2VyX2luZm8ubGFzdF9uYW1lOgogICAgICAgICAgICBmdWxsbmFtZV90b19uYXAgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIG5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWVfdG9fbmFwfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGJvdC5yZXBseV90byhtZXNzYWdlLCAiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIG7DoHkuIikKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIHbhu5tpIElEIHt1c2VyX2lkX3RvX25hcH0uIikKICAgICAgICByZXR1cm4KCiAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkX3RvX25hcCkKICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlICsgYW1vdW50X3RvX25hcAogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZF90b19uYXAsIG5ld19iYWxhbmNlKQogICAgdXBkYXRlX2N1b2N0aWVuKHVzZXJfaWRfdG9fbmFwLCBhbW91bnRfdG9fbmFwKQogICAgY3VycmVudF90aW1lID0gZ2V0X3ZpZXRuYW1fdGltZSgpCiAgICBwcmludChmIltERUJVR10gVGjhu51pIGdpYW4gZ2lhbyBk4buLY2g6IHtjdXJyZW50X3RpbWV9IikKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCdGSUxFL2xzbmFwLnR4dCcsICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShmInt1c2VyX2lkX3RvX25hcH0gLSB7Y3VycmVudF90aW1lfSAtIFRIRUNBTyAtIHthbW91bnRfdG9fbmFwfVxuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ2hpIGzhu4tjaCBz4butIG7huqFwOiB7dXNlcl9pZF90b19uYXB9IC0ge2N1cnJlbnRfdGltZX0gLSBUSEVDQU8gLSB7YW1vdW50X3RvX25hcH0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBnaGkgbOG7i2NoIHPhu60gbuG6oXA6IHtlfSIpCiAgICAgICAgcmV0dXJuCgogICAgYWRtaW5fbWVzc2FnZSA9ICgKICAgICAgICBmIuKchSDEkMOjIG7huqFwIHRow6BuaCBjw7RuZ1xuIgogICAgICAgIGYi8J+RpCBOZ8aw4budaSBkw7luZzoge2Z1bGxuYW1lX3RvX25hcH1cbiIKICAgICAgICBmIvCfhpQgSUQ6IDxjb2RlPnt1c2VyX2lkX3RvX25hcH08L2NvZGU+XG4iCiAgICAgICAgZiLwn5KwIFPhu5EgeHUgbuG6oXA6IHtmb3JtYXRfYmFsYW5jZShhbW91bnRfdG9fbmFwKX0geHVcbiIKICAgICAgICBmIvCfkrUgU+G7kSB4dSBt4bubaToge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0geHVcbiIKICAgICAgICBmIuKPsyBUaOG7nWkgZ2lhbjoge2N1cnJlbnRfdGltZX0iCiAgICApCiAgICBmb3IgYWRtaW5faWQgaW4gQURNSU46CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShhZG1pbl9pZCwgYWRtaW5fbWVzc2FnZSwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG7huqFwIGNobyBhZG1pbiB7YWRtaW5faWR9LiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgdGjDtG5nIGLDoW8gxJHhur9uIGFkbWluIHthZG1pbl9pZH06IHtlfSIpCgogICAgdXNlcl9tZXNzYWdlID0gKAogICAgICAgIGYiVGFkYWEhIELhuqFuIHbhu6thIGfhuqFjaCB0aOG6uyB0aMOgbmggY8O0bmcgc+G7kSB4dToge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfVxuXG4iCiAgICAgICAgZiJNR0Q6IHtyYW5kb20ucmFuZGludCgxMDAwMDAwMDAwMCwgOTk5OTk5OTk5OTkpfVxuIgogICAgICAgIGYiLSBT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1IgogICAgKQogICAgdHJ5OgogICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZF90b19uYXAsIHVzZXJfbWVzc2FnZSkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBu4bqhcCB0aMOgbmggY8O0bmcgY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH0uIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgdGjDtG5nIGLDoW8gxJHhur9uIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH06IHtlfSIpCgogICAgZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICB1c2VyX2lkX3N0ciA9IHN0cih1c2VyX2lkX3RvX25hcCkKICAgIGhpZGRlbl91c2VyX2lkID0gdXNlcl9pZF9zdHJbOjZdICsgIioqKioiCiAgICBncm91cF9tZXNzYWdlID0gKAogICAgICAgIGYiPGI+TmfGsOG7nWkgY2jGoWkgSUQ6IHtoaWRkZW5fdXNlcl9pZH1cblxuIgogICAgICAgIGYiLSBH4bqhY2ggdGjhursgdGjDoG5oIGPDtG5nIHtmb3JtYXRfYmFsYW5jZShhbW91bnRfdG9fbmFwKX0geHU8L2I+IgogICAgKQogICAgb3RoZXJfYm90X3Rva2VuID0gIjg0OTM3MDMyOTc6QUFIU2Y4d1R4aXBuN1RFVFAxQjlZU1dxYVI2MEdsSnNWSGMiCiAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfYm90X3Rva2VufS9zZW5kTWVzc2FnZSIKICAgIHBheWxvYWQgPSB7CiAgICAgICAgImNoYXRfaWQiOiBncm91cF9jaGF0X2lkLAogICAgICAgICJ0ZXh0IjogZ3JvdXBfbWVzc2FnZSwKICAgICAgICAicGFyc2VfbW9kZSI6ICJIVE1MIgogICAgfQogICAgdHJ5OgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCh1cmwsIGpzb249cGF5bG9hZCkKICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBu4bqhcCB2w6BvIG5ow7NtLiIpCiAgICBleGNlcHQgcmVxdWVzdHMuUmVxdWVzdEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSB0aMO0bmcgYsOhbyDEkeG6v24gbmjDs206IHtlfSIpCgpBRE1JTiA9IFs4MjA1NTY3ODUxXQoKQGJvdDEubWVzc2FnZV9oYW5kbGVyKGNvbW1hbmRzPVsnYWRtaW4nXSkKZGVmIGFkbWluKG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBpZiB1c2VyX2lkIG5vdCBpbiBBRE1JTjoKICAgICAgICByZXR1cm4KICAgIGtleWJvYXJkID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAocm93X3dpZHRoPTIpCiAgICBidG5fbWFuYWdlX3VzZXIgPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiUXXhuqNuIGzDvSB1c2VyIiwgY2FsbGJhY2tfZGF0YT0icXVhbmx5dXNlciIpCiAgICBidG5fcGF5X3RvcCA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJUcuG6oyB0aMaw4bufbmcgdG9wIiwgY2FsbGJhY2tfZGF0YT0idHJhdG9wIikKICAgIGJ0bl9uYXBfdGllbiA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJO4bqhcCB0aeG7gW4iLCBjYWxsYmFja19kYXRhPSJuYXBtb25leSIpCiAgICBidG5fY29uZ190aWVuID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIkPhu5luZyB0aeG7gW4iLCBjYWxsYmFja19kYXRhPSJjb25nbW9uZXkiKQogICAgYnRuX3RydV90aWVuID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIlRy4burIHRp4buBbiIsIGNhbGxiYWNrX2RhdGE9InRydW1vbmV5IikKICAgIGJ0bl90aGFuZ2hvbW5heSA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJU4buVbmcgdGjhuq9uZyIsIGNhbGxiYWNrX2RhdGE9InRvbmd0aGFuZyIpCiAgICBidG5fdGh1YWhvbW5heSA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJU4buVbmcgdGh1YSIsIGNhbGxiYWNrX2RhdGE9InRvbmd0aHVhIikKICAgIGJ0bl9kc21tID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIsSQ4buVaSBz4buRIE1PTU8iLCBjYWxsYmFja19kYXRhPSJkb2lzb21vbW8iKQogICAgYnRuX2RzYmsgPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigixJDhu5VpIHPhu5EgQkFOSyIsIGNhbGxiYWNrX2RhdGE9ImRvaXNvYmFuayIpCiAgICBidG5faHUgPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiSMWpIGJvbnVzIiwgY2FsbGJhY2tfZGF0YT0iaHVib251cyIpCiAgICBidG5fc2lldWh1ID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIlNpw6p1IGjFqSBib251cyIsIGNhbGxiYWNrX2RhdGE9InNpZXVodWJvbnVzIikKICAgIGJ0bl9naWZ0bmhvbSA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJQaMOhdCBHaWZ0Y29kZSBU4bqhaSBOaMOzbSIsIGNhbGxiYWNrX2RhdGE9ImdpZnRuaG9tIikKICAgIGJ0bl9naWZ0YWRtaW4gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiR2lmdGNvZGUgQURNSU4iLCBjYWxsYmFja19kYXRhPSJnaWZ0YWRtaW4iKQogICAgYnRuX3RhbnRodSA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJUw6JuIHRo4bunIiwgY2FsbGJhY2tfZGF0YT0idGFudGh1IikKCiAgICBrZXlib2FyZC5yb3coYnRuX21hbmFnZV91c2VyKQogICAga2V5Ym9hcmQucm93KGJ0bl9wYXlfdG9wLCBidG5fbmFwX3RpZW4pCiAgICBrZXlib2FyZC5yb3coYnRuX2NvbmdfdGllbiwgYnRuX3RydV90aWVuKQogICAga2V5Ym9hcmQucm93KGJ0bl90aGFuZ2hvbW5heSwgYnRuX3RodWFob21uYXkpCiAgICBrZXlib2FyZC5yb3coYnRuX2RzbW0sIGJ0bl9kc2JrKQogICAga2V5Ym9hcmQucm93KGJ0bl9odSwgYnRuX3NpZXVodSkKICAgIGtleWJvYXJkLnJvdyhidG5fZ2lmdG5ob20sIGJ0bl9naWZ0YWRtaW4pCiAgICBrZXlib2FyZC5yb3coYnRuX3RhbnRodSApCiAgICBib3QxLnNlbmRfbWVzc2FnZShjaGF0X2lkPW1lc3NhZ2UuY2hhdC5pZCx0ZXh0PSJYaW4gY2jDoG8gQWRtaW46IixyZXBseV9tYXJrdXA9a2V5Ym9hcmQpCgpkZWYgdGFvX251dF90cmFuZ190cnVvY19zYXUocHJlZml4X2NhbGxiYWNrLCBjdXJyZW50X3BhZ2UsIHRvdGFsX3BhZ2VzKToKICAgIG5hdl9idXR0b25zID0gW10KICAgIGlmIGN1cnJlbnRfcGFnZSA+IDE6CiAgICAgICAgbmF2X2J1dHRvbnMuYXBwZW5kKHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKAogICAgICAgICAgICAi4qyF77iPIFRyYW5nIHRyxrDhu5tjIiwgY2FsbGJhY2tfZGF0YT1mIntwcmVmaXhfY2FsbGJhY2t9X3BhZ2Vfe2N1cnJlbnRfcGFnZSAtIDF9IikpCiAgICBpZiBjdXJyZW50X3BhZ2UgPCB0b3RhbF9wYWdlczoKICAgICAgICBuYXZfYnV0dG9ucy5hcHBlbmQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oCiAgICAgICAgICAgICJUcmFuZyBzYXUg4p6h77iPIiwgY2FsbGJhY2tfZGF0YT1mIntwcmVmaXhfY2FsbGJhY2t9X3BhZ2Vfe2N1cnJlbnRfcGFnZSArIDF9IikpCiAgICByZXR1cm4gbmF2X2J1dHRvbnMKCmRlZiB0aGVtX251dF90cmFuZ192YW9fa2V5Ym9hcmQoa2V5Ym9hcmQsIHByZWZpeF9jYWxsYmFjaywgY3VycmVudF9wYWdlLCB0b3RhbF9wYWdlcyk6CiAgICBuYXZfYnV0dG9ucyA9IHRhb19udXRfdHJhbmdfdHJ1b2Nfc2F1KHByZWZpeF9jYWxsYmFjaywgY3VycmVudF9wYWdlLCB0b3RhbF9wYWdlcykKICAgIGlmIG5hdl9idXR0b25zOgogICAgICAgIGtleWJvYXJkLmFkZCgqbmF2X2J1dHRvbnMpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiZ2lmdG5ob20iKQpkZWYgZ2lmdG5ob20oY2FsbCk6CiAgICB0cnk6CiAgICAgICAgIyA9PT09PSBUUuG6oiBDQUxMQkFDSyBOR0FZIChDSOG7kE5HIFRJTUVPVVQpID09PT09CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyA9PT09PSBCT1QgUEjDgVQgR0lGVENPREUgPT09PT0KICAgICAgICBUT0tFTiA9ICI4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFIgogICAgICAgIENIQVRfSUQgPSAtMTAwMzU4OTk0MjI4NwogICAgICAgIFNBVkVfRklMRSA9ICJGSUxFL2dpZnQudHh0IgoKICAgICAgICBpbXBvcnQgb3MKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgaW1wb3J0IHN0cmluZwogICAgICAgIGZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgZnJvbSB0ZWxlYm90IGltcG9ydCB0eXBlcwogICAgICAgIGltcG9ydCB0ZWxlYm90CgogICAgICAgIGdpZnRfYm90ID0gdGVsZWJvdC5UZWxlQm90KFRPS0VOLCBwYXJzZV9tb2RlPSJIVE1MIikKCiAgICAgICAgb3MubWFrZWRpcnMoIkZJTEUiLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAjID09PT09IFThuqBPIENPREUgPT09PT0KICAgICAgICBkZWYgcmFuZG9tX2NvZGUoKToKICAgICAgICAgICAgcmV0dXJuICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX3VwcGVyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9MTIpKQoKICAgICAgICAjID09PT09IE7hu5hJIERVTkcgPT09PT0KICAgICAgICB0ZXh0ID0gKAogICAgICAgICAgICAiPGI+SOG7hyBUaOG7kW5nIFBow6F0IENvZGUgTmfhuqt1IE5oacOqbjwvYj5cblxuIgogICAgICAgICAgICAiTeG7h25oIGdpw6EgbcOjIGNvZGU6IDExMTEgLSA5OTk5XG4iCiAgICAgICAgICAgICJC4bqhbiBjw7MgdGjhu4Mgbmjhuq1wIGNvZGUgdOG6oWk6IEB0aW5obGluaGJvdFxuIgogICAgICAgICAgICAiRMO5bmcgbOG7h25oIDxjb2RlPi9naWZ0IFttw6MgY29kZV08L2NvZGU+IHThuqFpIGJvdCBAdGluaGxpbmhib3RcblxuIgogICAgICAgICAgICAiNSBtw6MgY29kZSBt4bubaSBiw6puIGTGsOG7m2k6XG5cbiIKICAgICAgICApCgogICAgICAgIGNvZGVzX3RleHQgPSAiIgoKICAgICAgICBmb3IgXyBpbiByYW5nZSg1KToKICAgICAgICAgICAgY29kZSA9IGYiTElOSFRJTkgte3JhbmRvbV9jb2RlKCl9IgogICAgICAgICAgICBub3dfc3RyID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKCiAgICAgICAgICAgIHdpdGggb3BlbihTQVZFX0ZJTEUsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUoZiJ7Y29kZX0gfCAxMTExIHwge25vd19zdHJ9IHwgMVxuIikKCiAgICAgICAgICAgIGNvZGVzX3RleHQgKz0gZiI8Y29kZT4vZ2lmdCB7Y29kZX08L2NvZGU+XG4iCgogICAgICAgICMgPT09PT0gTsOaVCA9PT09PQogICAgICAgIG1hcmt1cCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKCkKICAgICAgICBtYXJrdXAuYWRkKAogICAgICAgICAgICB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigKICAgICAgICAgICAgICAgIHRleHQ9IvCfjoEgTmjhuq1wIGNvZGUgdOG6oWkgxJHDonkiLAogICAgICAgICAgICAgICAgdXJsPSJodHRwczovL3QubWUvdGluaGxpbmhib3QiCiAgICAgICAgICAgICkKICAgICAgICApCgogICAgICAgICMgPT09PT0gR+G7rEkgVsOATyBOSMOTTSA9PT09PQogICAgICAgIGdpZnRfYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgQ0hBVF9JRCwKICAgICAgICAgICAgdGV4dCArIGNvZGVzX3RleHQsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1tYXJrdXAKICAgICAgICApCgogICAgICAgICMgPT09PT0gVEjDlE5HIELDgU8gQ0hPIEFETUlOIChOR8av4bucSSBC4bqkTSBOw5pUKSA9PT09PQogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICB0ZXh0PSgKICAgICAgICAgICAgICAgICLinIUgPGI+UEjDgVQgR0lGVENPREUgVEjDgE5IIEPDlE5HPC9iPlxuXG4iCiAgICAgICAgICAgICAgICBmIvCfkaQgQWRtaW46IDxjb2RlPntjYWxsLmZyb21fdXNlci5pZH08L2NvZGU+XG4iCiAgICAgICAgICAgICAgICBmIvCfk6YgU+G7kSBjb2RlOiA8Yj41PC9iPlxuIgogICAgICAgICAgICAgICAgZiLwn5ONIE5ow7NtIElEOiA8Y29kZT57Q0hBVF9JRH08L2NvZGU+IgogICAgICAgICAgICApLAogICAgICAgICAgICBwYXJzZV9tb2RlPSJIVE1MIgogICAgICAgICkKCiAgICAgICAgIyA9PT09PSBBTEVSVCBOR+G6rk4gVFLDik4gTsOaVCA9PT09PQogICAgICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KAogICAgICAgICAgICBjYWxsLmlkLAogICAgICAgICAgICB0ZXh0PSLinIUgxJDDoyBwaMOhdCBnaWZ0Y29kZSB2w6BvIG5ow7NtIiwKICAgICAgICAgICAgc2hvd19hbGVydD1UcnVlCiAgICAgICAgKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltHSUZUSE9NXSDinYwgTOG7l2k6IHtlfSIpCgogICAgICAgICMgPT09PT0gQsOBTyBM4buWSSBDSE8gQURNSU4gPT09PT0KICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgY2hhdF9pZD1jYWxsLm1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgICAgIHRleHQ9KAogICAgICAgICAgICAgICAgICAgICLinYwgPGI+UEjDgVQgR0lGVENPREUgVEjhuqRUIELhuqBJPC9iPlxuXG4iCiAgICAgICAgICAgICAgICAgICAgZiLwn5ObIEzhu5dpOiA8Y29kZT57ZX08L2NvZGU+IgogICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgIHRyeToKICAgICAgICAgICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoCiAgICAgICAgICAgICAgICBjYWxsLmlkLAogICAgICAgICAgICAgICAgdGV4dD0i4p2MIEzhu5dpIGtoaSBwaMOhdCBnaWZ0Y29kZSIsCiAgICAgICAgICAgICAgICBzaG93X2FsZXJ0PVRydWUKICAgICAgICAgICAgKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YS5zdGFydHN3aXRoKCJxdWFubHl1c2VyIikpCmRlZiBxdWFubHl1c2VyKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkIG5vdCBpbiBBRE1JTjoKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgcGFydHMgPSBjYWxsLmRhdGEuc3BsaXQoIl8iKQogICAgICAgIGN1cnJlbnRfcGFnZSA9IGludChwYXJ0c1stMV0pIGlmIHBhcnRzWy0xXS5pc2RpZ2l0KCkgZWxzZSAxCiAgICBleGNlcHQ6CiAgICAgICAgY3VycmVudF9wYWdlID0gMQoKICAgIHBlcl9wYWdlID0gMTAKICAgIHN0YXJ0ID0gKGN1cnJlbnRfcGFnZSAtIDEpICogcGVyX3BhZ2UKICAgIGVuZCA9IHN0YXJ0ICsgcGVyX3BhZ2UKCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3VzZXIudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICB1c2VycyA9IFtsaW5lLnN0cmlwKCkgZm9yIGxpbmUgaW4gZiBpZiBsaW5lLnN0cmlwKCldCgogICAgICAgIHRvdGFsX3VzZXJzID0gbGVuKHVzZXJzKQogICAgICAgIHRvdGFsX3BhZ2VzID0gKHRvdGFsX3VzZXJzICsgcGVyX3BhZ2UgLSAxKSAvLyBwZXJfcGFnZQoKICAgICAgICBpZiBub3QgdXNlcnM6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAi8J+TrSBEYW5oIHPDoWNoIHVzZXIgaGnhu4duIMSRYW5nIHRy4buRbmcuIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgR2nhu5tpIGjhuqFuIHBow6JuIHRyYW5nIGtow7RuZyB2xrDhu6N0IHF1w6EgdHJhbmcgY3Xhu5FpCiAgICAgICAgaWYgY3VycmVudF9wYWdlID4gdG90YWxfcGFnZXM6CiAgICAgICAgICAgIGN1cnJlbnRfcGFnZSA9IHRvdGFsX3BhZ2VzCiAgICAgICAgICAgIHN0YXJ0ID0gKGN1cnJlbnRfcGFnZSAtIDEpICogcGVyX3BhZ2UKICAgICAgICAgICAgZW5kID0gc3RhcnQgKyBwZXJfcGFnZQoKICAgICAgICBrZXlib2FyZCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKHJvd193aWR0aD0yKQogICAgICAgIGN1cnJlbnRfdXNlcnMgPSB1c2Vyc1tzdGFydDplbmRdCiAgICAgICAgYnV0dG9ucyA9IFtdCgogICAgICAgIGZvciB1c2VyIGluIGN1cnJlbnRfdXNlcnM6CiAgICAgICAgICAgIGJ0biA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKHRleHQ9dXNlciwgY2FsbGJhY2tfZGF0YT1mInVzZXJfe3VzZXJ9IikKICAgICAgICAgICAgYnV0dG9ucy5hcHBlbmQoYnRuKQogICAgICAgICAgICBpZiBsZW4oYnV0dG9ucykgPT0gMjoKICAgICAgICAgICAgICAgIGtleWJvYXJkLmFkZCgqYnV0dG9ucykKICAgICAgICAgICAgICAgIGJ1dHRvbnMgPSBbXQoKICAgICAgICBpZiBidXR0b25zOgogICAgICAgICAgICBrZXlib2FyZC5hZGQoKmJ1dHRvbnMpCgogICAgICAgIHRoZW1fbnV0X3RyYW5nX3Zhb19rZXlib2FyZChrZXlib2FyZCwgInF1YW5seXVzZXIiLCBjdXJyZW50X3BhZ2UsIHRvdGFsX3BhZ2VzKQoKICAgICAgICBib3QxLmVkaXRfbWVzc2FnZV90ZXh0KAogICAgICAgICAgICBjaGF0X2lkPWNhbGwubWVzc2FnZS5jaGF0LmlkLAogICAgICAgICAgICBtZXNzYWdlX2lkPWNhbGwubWVzc2FnZS5tZXNzYWdlX2lkLAogICAgICAgICAgICB0ZXh0PWYi8J+TiyBEYW5oIHPDoWNoIHVzZXIgKFRyYW5nIHtjdXJyZW50X3BhZ2V9L3t0b3RhbF9wYWdlc30pOiIsCiAgICAgICAgICAgIHJlcGx5X21hcmt1cD1rZXlib2FyZAogICAgICAgICkKCiAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsICLinYwgS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgRklMRS91c2VyLnR4dC4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBmIuKaoO+4jyBM4buXaSBraGkgxJHhu41jIGRhbmggc8OhY2ggdXNlcjoge2V9IikKCkBib3QxLmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhLnN0YXJ0c3dpdGgoInVzZXJfIikpCmRlZiB1c2VyX2luZm9fYWRtaW4oY2FsbCk6CiAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgbm90IGluIEFETUlOOgogICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIHVzZXJfaWQgPSBjYWxsLmRhdGEuc3BsaXQoIl8iLCAxKVsxXQogICAgICAgIHVzZXJuYW1lID0gY2FsbC5mcm9tX3VzZXIudXNlcm5hbWUKICAgICAgICBwcmludChmIltERUJVR10gQURNSU4gecOqdSBj4bqndSB4ZW0gdXNlcjoge3VzZXJfaWR9LCBi4bufaToge3VzZXJuYW1lfSIpCiAgICAgICAgdmlfY2hpbmggPSBnZXRfdmljaGluaCh1c2VyX2lkKQogICAgICAgIHRvdGFsX2JldF90b2RheSA9IGdldF9iZXRfdG9kYXkodXNlcl9pZCkKICAgICAgICB0b3RhbF9iZXRfd2VlayA9IGdldF9iZXRfd2Vlayh1c2VyX2lkKQogICAgICAgIHRvdGFsX3dpbnMgPSBnZXRfd2luKHVzZXJfaWQpCiAgICAgICAgdG90YWxfbG9zc2VzID0gZ2V0X2xvc3ModXNlcl9pZCkKICAgICAgICBtYW5hcF9jb2RlID0gZ2V0X21hbmFwKHVzZXJfaWQpCgogICAgICAgIHZpcF9sZXZlbCwgdmlwX3BvaW50cyA9IGdldF92aXAodXNlcl9pZCkKICAgICAgICByZXF1aXJlZF9wb2ludHMgPSB2aXBfbGV2ZWwgKiAxMDAgKyA5OQogICAgICAgIHdoaWxlIHZpcF9wb2ludHMgPj0gcmVxdWlyZWRfcG9pbnRzOgogICAgICAgICAgICB2aXBfbGV2ZWwgKz0gMQogICAgICAgICAgICB2aXBfcG9pbnRzID0gMAogICAgICAgICAgICByZXF1aXJlZF9wb2ludHMgPSB2aXBfbGV2ZWwgKiAxMDAgKyA5OQogICAgICAgICAgICB1cGRhdGVfdmlwKHVzZXJfaWQsIHZpcF9sZXZlbCwgdmlwX3BvaW50cykKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEPhuq1wIG5o4bqtdCBj4bqlcCBWSVA6IHt2aXBfbGV2ZWx9LCByZXNldCDEkWnhu4NtIFZJUCIpCiAgICAgICAgY2h1b2lfd2luLCBjaHVvaV9sb3NzID0gZ2V0X3dpbl9sb3NzX3N0cmVhayh1c2VyX2lkKQogICAgICAgIHRvbmdfbmFwX21vbW8gPSAwCiAgICAgICAgdG9uZ19uYXBfYmFuayA9IDAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9sc25hcC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCh1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoIiAtICIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlbmggPSBwYXJ0c1syXS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbW91bnQgPSBpbnQocGFydHNbM10ucmVwbGFjZSgiLiIsICIiKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBrZW5oID09ICJNT01PIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZ19uYXBfbW9tbyArPSBhbW91bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGtlbmggPT0gIkJBTksiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25nX25hcF9iYW5rICs9IGFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgRklMRS9sc25hcC50eHQiKQogICAgICAgIHRvbmdfcnV0X21vbW8gPSAwCiAgICAgICAgdG9uZ19ydXRfYmFuayA9IDAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9sc3J1dC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aCh1c2VyX2lkKSBhbmQgInRow6BuaCBjw7RuZyIgaW4gbGluZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgiIC0gIikKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAga2VuaCA9IHBhcnRzWzJdLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYga2VuaCA9PSAiTU9NTyIgYW5kIGxlbihwYXJ0cykgPj0gNDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25nX3J1dF9tb21vICs9IGludChwYXJ0c1szXS5yZXBsYWNlKCIuIiwgIiIpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBrZW5oID09ICJCQU5LIiBhbmQgbGVuKHBhcnRzKSA+PSA2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmdfcnV0X2JhbmsgKz0gaW50KHBhcnRzWzVdLnJlcGxhY2UoIi4iLCAiIikpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBwcmludCgiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgRklMRS9sc3J1dC50eHQiKQoKICAgICAgICB0b25nX25hcCA9IHRvbmdfbmFwX21vbW8gKyB0b25nX25hcF9iYW5rCiAgICAgICAgdG9uZ19ydXQgPSB0b25nX3J1dF9tb21vICsgdG9uZ19ydXRfYmFuawoKICAgICAgICBtc2cgPSAoCiAgICAgICAgICAgIGYiPGI+VGjDtG5nIHRpbiB0w6BpIGtob+G6o248L2I+XG4iCiAgICAgICAgICAgIGYiSUQ6IDxjb2RlPnt1c2VyX2lkfTwvY29kZT5cbiIKICAgICAgICAgICAgZiIgU+G7kSBkxrAgdsOtIGNow61uaDogPGI+e2Zvcm1hdF9iYWxhbmNlKHZpX2NoaW5oKX08L2I+XG4iCiAgICAgICAgICAgIGYiIFZJUDogPGI+e3ZpcF9sZXZlbH0gKHt2aXBfcG9pbnRzfS97cmVxdWlyZWRfcG9pbnRzfSk8L2I+XG4iCiAgICAgICAgICAgIGYiIEPGsOG7o2MgaMO0bSBuYXk6IDxiPntmb3JtYXRfYmFsYW5jZSh0b3RhbF9iZXRfdG9kYXkpfTwvYj5cbiIKICAgICAgICAgICAgZiIgQ8aw4bujYyB0deG6p24gbsOgeTogPGI+e2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2JldF93ZWVrKX08L2I+XG4iCiAgICAgICAgICAgIGYiIFThu5VuZyB0aOG6r25nOiA8Yj57Zm9ybWF0X2JhbGFuY2UodG90YWxfd2lucyl9PC9iPlxuIgogICAgICAgICAgICBmIiBU4buVbmcgdGh1YTogPGI+e2Zvcm1hdF9iYWxhbmNlKHRvdGFsX2xvc3Nlcyl9PC9iPlxuXG4iCiAgICAgICAgICAgIGYiIDxiPk7huqFwPC9iPjoge2Zvcm1hdF9iYWxhbmNlKHRvbmdfbmFwKX1cbiIKICAgICAgICAgICAgZiLilJwgTU9NTzoge2Zvcm1hdF9iYWxhbmNlKHRvbmdfbmFwX21vbW8pfVxuIgogICAgICAgICAgICBmIuKUlCBCQU5LOiB7Zm9ybWF0X2JhbGFuY2UodG9uZ19uYXBfYmFuayl9XG4iCiAgICAgICAgICAgIGYiIDxiPlLDunQ8L2I+OiB7Zm9ybWF0X2JhbGFuY2UodG9uZ19ydXQpfVxuIgogICAgICAgICAgICBmIuKUnCBNT01POiB7Zm9ybWF0X2JhbGFuY2UodG9uZ19ydXRfbW9tbyl9XG4iCiAgICAgICAgICAgIGYi4pSUIEJBTks6IHtmb3JtYXRfYmFsYW5jZSh0b25nX3J1dF9iYW5rKX1cblxuIgogICAgICAgICAgICBmIkNodeG7l2kgdGjhuq9uZzogPGI+e2NodW9pX3dpbn08L2I+XG4iCiAgICAgICAgICAgIGYiQ2h14buXaSB0aHVhOiA8Yj57Y2h1b2lfbG9zc308L2I+XG4iCiAgICAgICAgICAgIGYiTcOjIG7huqFwOiA8Y29kZT57bWFuYXBfY29kZX08L2NvZGU+IgogICAgICAgICkKCiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIG1zZywgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIHRpbiBjaGkgdGnhur90IGPhu6dhIHVzZXIge3VzZXJfaWR9IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGYi4p2MIEzhu5dpIGtoaSBs4bqleSB0aMO0bmcgdGluIHVzZXI6IHtlfSIpCiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEtoaSBs4bqleSB0aMO0bmcgdGluIHVzZXI6IHtlfSIpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidHJhdG9wIikKZGVmIHRyYXRvcChjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCBub3QgaW4gQURNSU46CiAgICAgICAgcmV0dXJuCiAgICBrZXlib2FyZCA9IHR5cGVzLklubGluZUtleWJvYXJkTWFya3VwKHJvd193aWR0aD0yKQogICAgYnRuX3RvcG5nYXkgPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiVG9wIG5nw6B5IiwgY2FsbGJhY2tfZGF0YT0idG9wbmdheSIpCiAgICBidG5fdG9wdHVhbiA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJUb3AgdHXhuqduIiwgY2FsbGJhY2tfZGF0YT0idG9wdHVhbiIpCiAgICBrZXlib2FyZC5hZGQoYnRuX3RvcG5nYXksIGJ0bl90b3B0dWFuKQogICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsICJBZG1pbiB2dWkgbMOybmcgY2jhu41uIGvDqm5oIHRy4bqjIHRvcDoiLCByZXBseV9tYXJrdXA9a2V5Ym9hcmQpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidG9wbmdheSIpCmRlZiB0cmF0aHVvbmd0b3BuZ2F5KGNhbGwpOgogICAgYm90Ml90b2tlbiA9ICI4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFIgogICAgZ3JvdXBfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgYm90MiA9IFRlbGVCb3QoYm90Ml90b2tlbikKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCgogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgIT0gODIwNTU2Nzg1MToKICAgICAgICByZXR1cm4KCiAgICBkZWYgZXNjYXBlX21hcmtkb3duKHRleHQpOgogICAgICAgIHJldHVybiByZS5zdWIocicoW18qXFtcXSgpfmA+Iys9fHt9LiFcXC1dKScsIHInXFxcMScsIHN0cih0ZXh0KSkKCiAgICBkZWYgcHJvbW90ZV9hbmRfc2V0X3RpdGxlKHVzZXJfaWQsIHRpdGxlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNoYXRfbWVtYmVyID0gYm90Mi5nZXRfY2hhdF9tZW1iZXIoZ3JvdXBfaWQsIHVzZXJfaWQpCiAgICAgICAgICAgIHN0YXR1cyA9IGNoYXRfbWVtYmVyLnN0YXR1cwoKICAgICAgICAgICAgaWYgc3RhdHVzIGluIFsnbGVmdCcsICdraWNrZWQnXToKICAgICAgICAgICAgICAgIG1zZyA9IGYiW+KdjF0gVXNlciB7dXNlcl9pZH0gY2jGsGEgdGhhbSBnaWEgbmjDs20gaG/hurdjIMSRw6MgYuG7iyBjaOG6t24uIgogICAgICAgICAgICAgICAgcHJpbnQobXNnKQogICAgICAgICAgICAgICAgcmV0dXJuIG1zZwoKICAgICAgICAgICAgaWYgc3RhdHVzID09ICdjcmVhdG9yJzoKICAgICAgICAgICAgICAgIG1zZyA9IGYiW+KaoO+4j10gQuG7jyBxdWEgdGl0bGUgY2hvIGNo4bunIG5ow7NtIHt1c2VyX2lkfSAoVGVsZWdyYW0ga2jDtG5nIGNobyBwaMOpcCkuIgogICAgICAgICAgICAgICAgcHJpbnQobXNnKQogICAgICAgICAgICAgICAgcmV0dXJuIG1zZwoKICAgICAgICAgICAgIyBQcm9tb3RlIG7hur91IGNoxrBhIHBo4bqjaSBhZG1pbgogICAgICAgICAgICBpZiBzdGF0dXMgIT0gJ2FkbWluaXN0cmF0b3InOgogICAgICAgICAgICAgICAgYm90Mi5wcm9tb3RlX2NoYXRfbWVtYmVyKAogICAgY2hhdF9pZD1ncm91cF9pZCwKICAgIHVzZXJfaWQ9dXNlcl9pZCwKICAgIGNhbl9jaGFuZ2VfaW5mbz1GYWxzZSwKICAgIGNhbl9wb3N0X21lc3NhZ2VzPUZhbHNlLAogICAgY2FuX2VkaXRfbWVzc2FnZXM9RmFsc2UsCiAgICBjYW5fZGVsZXRlX21lc3NhZ2VzPUZhbHNlLAogICAgY2FuX2ludml0ZV91c2Vycz1UcnVlLAogICAgY2FuX3Jlc3RyaWN0X21lbWJlcnM9RmFsc2UsCiAgICBjYW5fcGluX21lc3NhZ2VzPUZhbHNlLAogICAgY2FuX3Byb21vdGVfbWVtYmVycz1GYWxzZSwKICAgIGNhbl9tYW5hZ2VfdmlkZW9fY2hhdHM9RmFsc2UsCiAgICBjYW5fbWFuYWdlX2NoYXQ9RmFsc2UKKQoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIGzhu4duaCBwcm9tb3RlIHt1c2VyX2lkfSwgY2jhu50geMOhYyBuaOG6rW4uLi4iKQoKICAgICAgICAgICAgICAgICMgQ2jhu50gdOG7kWkgxJFhIDEwIGdpw6J5IMSR4buDIFRlbGVncmFtIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMTApOgogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICBpZiBib3QyLmdldF9jaGF0X21lbWJlcihncm91cF9pZCwgdXNlcl9pZCkuc3RhdHVzID09ICdhZG1pbmlzdHJhdG9yJzoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqnbiBjdeG7kWkKICAgICAgICAgICAgaWYgYm90Mi5nZXRfY2hhdF9tZW1iZXIoZ3JvdXBfaWQsIHVzZXJfaWQpLnN0YXR1cyAhPSAnYWRtaW5pc3RyYXRvcic6CiAgICAgICAgICAgICAgICBtc2cgPSBmIlvinYxdIFVzZXIge3VzZXJfaWR9IHbhuqtuIGNoxrBhIHRow6BuaCBhZG1pbiBzYXUga2hpIHByb21vdGUuIgogICAgICAgICAgICAgICAgcHJpbnQobXNnKQogICAgICAgICAgICAgICAgcmV0dXJuIG1zZwoKICAgICAgICAgICAgIyDEkOG6t3QgdGl0bGUKICAgICAgICAgICAgc2V0X3RpdGxlX3VybCA9IGYiaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdHtib3QyX3Rva2VufS9zZXRDaGF0QWRtaW5pc3RyYXRvckN1c3RvbVRpdGxlIgogICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICJ1c2VyX2lkIjogdXNlcl9pZCwKICAgICAgICAgICAgICAgICJjdXN0b21fdGl0bGUiOiB0aXRsZQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlcyA9IHJlcXVlc3RzLnBvc3Qoc2V0X3RpdGxlX3VybCwgZGF0YT1wYXlsb2FkKQogICAgICAgICAgICBpZiByZXMuc3RhdHVzX2NvZGUgPT0gMjAwIGFuZCByZXMuanNvbigpLmdldCgib2siKToKICAgICAgICAgICAgICAgIG1zZyA9IGYiW+KchV0gxJDhurd0IHRpdGxlOiB7dGl0bGV9IGNobyB1c2VyIHt1c2VyX2lkfSIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG1zZyA9IGYiW+KdjF0gTOG7l2kgxJHhurd0IHRpdGxlIGNobyB1c2VyIHt1c2VyX2lkfToge3Jlcy50ZXh0fSIKICAgICAgICAgICAgcHJpbnQobXNnKQogICAgICAgICAgICByZXR1cm4gbXNnCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHByaW50KCJb4p2MXSBM4buXaSBwcm9tb3RlL3NldCB0aXRsZToiKQogICAgICAgICAgICBwcmludCh0cmFjZWJhY2suZm9ybWF0X2V4YygpKQogICAgICAgICAgICByZXR1cm4gZiJM4buXaToge3RyYWNlYmFjay5mb3JtYXRfZXhjKCl9IgoKCiAgICBkZWYgZm9ybWF0X2JhbGFuY2UoYW1vdW50KToKICAgICAgICByZXR1cm4gZiJ7YW1vdW50Oix9Ii5yZXBsYWNlKCIsIiwgIi4iKQogICAgZGVmIHVwZGF0ZV9zb3RpZW4odXNlcl9pZCwgYW1vdW50KToKICAgICAgICBwYXRoID0gIkZJTEUvc2QudHh0IgogICAgICAgIHVzZXJfaWQgPSBzdHIodXNlcl9pZCkKICAgICAgICB1cGRhdGVkID0gRmFsc2UKICAgICAgICBsaW5lcyA9IFtdCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFIik6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKCJGSUxFIikKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgICAgIG9wZW4ocGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKS5jbG9zZSgpCiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMiBhbmQgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IDAKICAgICAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudAogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lKQogICAgICAgIGlmIG5vdCB1cGRhdGVkOgogICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge2Ftb3VudH1cbiIpCiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKICAgICAgICBwcmludChmIltERUJVR10g4pyFIMSQw6MgY+G6rXAgbmjhuq10OiB7dXNlcl9pZH0gK3tmb3JtYXRfYmFsYW5jZShhbW91bnQpfSB2w6BvIEZJTEUvc2QudHh0IikKCiAgICB2aWV0bmFtX3R6ID0gcHl0ei50aW1lem9uZSgiQXNpYS9Ib19DaGlfTWluaCIpCiAgICBub3cgPSBkYXRldGltZS5ub3codmlldG5hbV90eikKICAgIHllc3RlcmRheSA9IG5vdyAtIHRpbWVkZWx0YShkYXlzPTEpCgogICAgZnVsbF9maWxlX25hbWUgPSB5ZXN0ZXJkYXkuc3RyZnRpbWUoIiVkJW0lWSIpCiAgICBzaG9ydF9maWxlX25hbWUgPSB5ZXN0ZXJkYXkuc3RyZnRpbWUoIiVkIikubHN0cmlwKCIwIikgKyB5ZXN0ZXJkYXkuc3RyZnRpbWUoIiVtIikubHN0cmlwKCIwIikgKyB5ZXN0ZXJkYXkuc3RyZnRpbWUoIiVZIikKCiAgICBwb3NzaWJsZV9wYXRocyA9IFtmIkZJTEUve2Z1bGxfZmlsZV9uYW1lfS50eHQiLCBmIkZJTEUve3Nob3J0X2ZpbGVfbmFtZX0udHh0Il0KICAgIGZpbGVfcGF0aCA9IG5leHQoKHAgZm9yIHAgaW4gcG9zc2libGVfcGF0aHMgaWYgb3MucGF0aC5leGlzdHMocCkpLCBOb25lKQoKICAgIGlmIG5vdCBmaWxlX3BhdGg6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGYiS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUge2Z1bGxfZmlsZV9uYW1lfS50eHQgaG/hurdjIHtzaG9ydF9maWxlX25hbWV9LnR4dCIpCiAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCgogICAgICAgIHRvcF9saXN0ID0gW10KICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdG9wX2xpc3QuYXBwZW5kKChwYXJ0c1swXSwgaW50KHBhcnRzWzFdKSkpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgaWYgbm90IHRvcF9saXN0OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgZiJE4buvIGxp4buHdSB0cm9uZyBmaWxlIHtmaWxlX3BhdGh9IHLhu5duZy4iKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdG9wX2xpc3Quc29ydChrZXk9bGFtYmRhIHg6IHhbMV0sIHJldmVyc2U9VHJ1ZSkKICAgICAgICByZXdhcmRzID0gWzUwMDAwLCAzMDAwMCwgMTUwMDBdCiAgICAgICAgdG9wX2luZm9fbGluZXMgPSBbXQogICAgICAgIG5nYXlfdGhhbmcgPSB5ZXN0ZXJkYXkuc3RyZnRpbWUoIiVkLyVtIikKCiAgICAgICAgZm9yIGluZGV4LCAodXNlcl9pZCwgYW1vdW50KSBpbiBlbnVtZXJhdGUodG9wX2xpc3RbOjNdKToKICAgICAgICAgICAgcmV3YXJkID0gcmV3YXJkc1tpbmRleF0KICAgICAgICAgICAgdXBkYXRlX3NvdGllbih1c2VyX2lkLCByZXdhcmQpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjaGF0ID0gYm90LmdldF9jaGF0KHVzZXJfaWQpCiAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IGYie2NoYXQuZmlyc3RfbmFtZSBvciAnJ30ge2NoYXQubGFzdF9uYW1lIG9yICcnfSIuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbm90IGZ1bGxuYW1lOgogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gIktow7RuZyBjw7MgdMOqbiIKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZnVsbG5hbWUgPSBmIkzhu5dpIGzhuqV5IHTDqm46IHtlfSIKCiAgICAgICAgICAgIHNlbmRfZXJyb3IgPSBOb25lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG1zZzEgPSBmIlRy4bqjIHRoxrDhu59uZyBUb3Age2luZGV4ICsgMX0gbmfDoHkge25nYXlfdGhhbmd9IHPhu5EgdGnhu4FuIHtmb3JtYXRfYmFsYW5jZShyZXdhcmQpfSIKICAgICAgICAgICAgICAgIG1zZzIgPSBmIkLhuqFuIHbhu6thIMSRxrDhu6NjIMSR4bq3dCBEYW5oIGhp4buHdSBsw6A6IFRvcCB7aW5kZXggKyAxfSBuZ8OgeSB7bmdheV90aGFuZ30iCiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHVzZXJfaWQsIG1zZzEpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHVzZXJfaWQsIG1zZzIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbmRfZXJyb3IgPSBmIkzhu5dpIGfhu61pIHRpbiBuaOG6r246IHtlfSIKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSB7c2VuZF9lcnJvcn0iKQoKICAgICAgICAgICAgdGl0bGUgPSBmIlRvcCB7aW5kZXggKyAxfSB7bmdheV90aGFuZ30iCiAgICAgICAgICAgIHByb21vdGVfbXNnID0gcHJvbW90ZV9hbmRfc2V0X3RpdGxlKGludCh1c2VyX2lkKSwgdGl0bGUpCgogICAgICAgICAgICBlcnJvcl9ub3RlcyA9IFtdCiAgICAgICAgICAgIGlmIHNlbmRfZXJyb3I6CiAgICAgICAgICAgICAgICBlcnJvcl9ub3Rlcy5hcHBlbmQoc2VuZF9lcnJvcikKICAgICAgICAgICAgaWYgIkzhu5dpIiBpbiBmdWxsbmFtZToKICAgICAgICAgICAgICAgIGVycm9yX25vdGVzLmFwcGVuZChmdWxsbmFtZSkKCiAgICAgICAgICAgIG5vdGVfc3RyID0gZiIgKHsnLCAnLmpvaW4oZXJyb3Jfbm90ZXMpfSkiIGlmIGVycm9yX25vdGVzIGVsc2UgIiIKICAgICAgICAgICAgcHJvZmlsZV9saW5rID0gKAogICAgICAgICAgICAgICAgZiJbe3VzZXJfaWR9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9KSB8IHtlc2NhcGVfbWFya2Rvd24oZnVsbG5hbWUpfXtlc2NhcGVfbWFya2Rvd24obm90ZV9zdHIpfVxuIgogICAgICAgICAgICAgICAgZiJ7ZXNjYXBlX21hcmtkb3duKHByb21vdGVfbXNnKX0iCiAgICAgICAgICAgICkKICAgICAgICAgICAgdG9wX2luZm9fbGluZXMuYXBwZW5kKGYiVE9Qe2luZGV4ICsgMX06IHtwcm9maWxlX2xpbmt9IikKCiAgICAgICAgdGhvbmdiYW9fYWRtaW4gPSAixJDDoyB0cuG6oyB0aMaw4bufbmcgVE9QOlxuIiArICJcblxuIi5qb2luKHRvcF9pbmZvX2xpbmVzKQogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCB0aG9uZ2Jhb19hZG1pbiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHRidHJhdG9wbmdheSh0b3BfbGlzdCwgbmdheV90aGFuZykKICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyBhZG1pbiBob8OgbiB04bqldCIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB0b3BuZ2F5OiB7ZX0iKQogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBmIkzhu5dpIHjhu60gbMO9IHRvcG5nYXk6IHtlfSIpCgpkZWYgdGJ0cmF0b3BuZ2F5KHRvcF9saXN0LCBuZ2F5X3RoYW5nKToKICAgIG1zZyA9IGYiSG/DoG4gdOG6pXQgdHLhuqMgdG9wIG5nw6B5IHtuZ2F5X3RoYW5nfVxuXG4iCiAgICBmb3IgaWR4LCAodXNlcl9pZCwgYW1vdW50KSBpbiBlbnVtZXJhdGUodG9wX2xpc3RbOjNdKToKICAgICAgICBoaWRkZW5faWQgPSBzdHIodXNlcl9pZCkKICAgICAgICBpZiBsZW4oaGlkZGVuX2lkKSA+IDY6CiAgICAgICAgICAgIGhpZGRlbl9pZCA9IGhpZGRlbl9pZFs6Nl0gKyAiKioqKiIKICAgICAgICBtc2cgKz0gZiJ7aGlkZGVuX2lkfSB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50KX1cbiIKICAgIHRyeToKICAgICAgICBib3QyLnNlbmRfbWVzc2FnZSgtMTAwMzU4OTk0MjI4NywgbXNnLnN0cmlwKCkpCiAgICAgICAgcHJpbnQoIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyB04buVbmcga+G6v3QgdHLhuqMgdG9wLiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEfhu61pIHRidHJhdG9wOiB7ZX0iKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRvcHR1YW4iKQpkZWYgdG9wdHVhbihjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIGRlZiBmb3JtYXRfYmFsYW5jZShhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgZGVmIHVwZGF0ZV9zb3RpZW4odXNlcl9pZCwgYW1vdW50KToKICAgICAgICB1c2VyX2lkID0gc3RyKHVzZXJfaWQpCiAgICAgICAgZmlsZXBhdGggPSAic2QudHh0IgogICAgICAgIHVwZGF0ZWQgPSBGYWxzZQogICAgICAgIGxpbmVzID0gW10KCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZXBhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQoKICAgICAgICBuZXdfbGluZXMgPSBbXQogICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMiBhbmQgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSAwCiAgICAgICAgICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudAogICAgICAgICAgICAgICAgbmV3X2xpbmVzLmFwcGVuZChmInt1c2VyX2lkfSB7bmV3X2JhbGFuY2V9XG4iKQogICAgICAgICAgICAgICAgdXBkYXRlZCA9IFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQobGluZSkKCiAgICAgICAgaWYgbm90IHVwZGF0ZWQ6CiAgICAgICAgICAgIG5ld19saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge2Ftb3VudH1cbiIpCgogICAgICAgIHdpdGggb3BlbihmaWxlcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X2xpbmVzKQoKICAgICAgICBwcmludChmIltERUJVR10gK3tmb3JtYXRfYmFsYW5jZShhbW91bnQpfSBWTsSQIGNobyB7dXNlcl9pZH0iKQoKICAgIHZpZXRuYW1fdHogPSBweXR6LnRpbWV6b25lKCJBc2lhL0hvX0NoaV9NaW5oIikKICAgIG5vdyA9IGRhdGV0aW1lLm5vdyh2aWV0bmFtX3R6KQogICAgaXNvX3llYXIsIGlzb193ZWVrLCBfID0gbm93Lmlzb2NhbGVuZGFyKCkKCiAgICBpZiBpc29fd2VlayA9PSAxOgogICAgICAgIHByZXZfd2VlayA9IDUyCiAgICAgICAgcHJldl95ZWFyID0gaXNvX3llYXIgLSAxCiAgICBlbHNlOgogICAgICAgIHByZXZfd2VlayA9IGlzb193ZWVrIC0gMQogICAgICAgIHByZXZfeWVhciA9IGlzb195ZWFyCgogICAgZmlsZV9wYXRoID0gZiJGSUxFL3R1YW57cHJldl93ZWVrfS50eHQiCiAgICBwcmludChmIltERUJVR10gVHXhuqduIGhp4buHbiB04bqhaToge2lzb193ZWVrfSwgdMOsbSBmaWxlIHR14bqnbiB0csaw4bubYzoge2ZpbGVfcGF0aH0iKQoKICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBmIktow7RuZyB0w6xtIHRo4bqleSBmaWxlIHR14bqnbiB0csaw4bubYzogdHVhbntwcmV2X3dlZWt9LnR4dCIpCiAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCgogICAgICAgIHRvcF9saXN0ID0gW10KICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDI6CiAgICAgICAgICAgICAgICB1c2VyX2lkID0gcGFydHNbMF0KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBiZXRfYW1vdW50ID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgIHRvcF9saXN0LmFwcGVuZCgodXNlcl9pZCwgYmV0X2Ftb3VudCkpCiAgICAgICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBpZiBub3QgdG9wX2xpc3Q6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBmIkThu68gbGnhu4d1IHRyb25nIGZpbGUge2ZpbGVfcGF0aH0gcuG7l25nLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0b3BfbGlzdC5zb3J0KGtleT1sYW1iZGEgeDogeFsxXSwgcmV2ZXJzZT1UcnVlKQogICAgICAgIHJld2FyZHMgPSBbMTAwMDAwLCA1MDAwMCwgMjAwMDBdCiAgICAgICAgdG9wX2luZm9fbGluZXMgPSBbXQogICAgICAgIGxhYmVsX3dlZWsgPSBmIlR14bqnbiB7cHJldl93ZWVrfSIKCiAgICAgICAgZm9yIGluZGV4LCAodXNlcl9pZCwgYW1vdW50KSBpbiBlbnVtZXJhdGUodG9wX2xpc3RbOjNdKToKICAgICAgICAgICAgcmV3YXJkID0gcmV3YXJkc1tpbmRleF0KICAgICAgICAgICAgdXBkYXRlX3NvdGllbih1c2VyX2lkLCByZXdhcmQpCgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjaGF0ID0gYm90LmdldF9jaGF0KHVzZXJfaWQpCiAgICAgICAgICAgICAgICBmdWxsbmFtZSA9IGYie2NoYXQuZmlyc3RfbmFtZSBvciAnJ30ge2NoYXQubGFzdF9uYW1lIG9yICcnfSIuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbm90IGZ1bGxuYW1lOgogICAgICAgICAgICAgICAgICAgIGZ1bGxuYW1lID0gIktow7RuZyBjw7MgdMOqbiIKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZnVsbG5hbWUgPSBmIkzhu5dpIGzhuqV5IHTDqm46IHtlfSIKCiAgICAgICAgICAgIHNlbmRfZXJyb3IgPSBOb25lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG1zZzEgPSBmIlRy4bqjIHRoxrDhu59uZyBUb3Age2luZGV4ICsgMX0ge2xhYmVsX3dlZWt9IHPhu5EgdGnhu4FuIHtmb3JtYXRfYmFsYW5jZShyZXdhcmQpfSIKICAgICAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZCwgbXNnMSkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBH4butaSB0cuG6oyB0aMaw4bufbmcgY2hvIHt1c2VyX2lkfToge21zZzF9IikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VuZF9lcnJvciA9IGYiTOG7l2kgZ+G7rWkgdGluIG5o4bqvbjoge2V9IgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIHtzZW5kX2Vycm9yfSIpCgogICAgICAgICAgICBlcnJvcl9ub3RlcyA9IFtdCiAgICAgICAgICAgIGlmIHNlbmRfZXJyb3I6CiAgICAgICAgICAgICAgICBlcnJvcl9ub3Rlcy5hcHBlbmQoc2VuZF9lcnJvcikKICAgICAgICAgICAgaWYgIkzhu5dpIiBpbiBmdWxsbmFtZToKICAgICAgICAgICAgICAgIGVycm9yX25vdGVzLmFwcGVuZChmdWxsbmFtZSkKCiAgICAgICAgICAgIGVycm9yX25vdGVfc3RyID0gZiIgKHsnLCAnLmpvaW4oZXJyb3Jfbm90ZXMpfSkiIGlmIGVycm9yX25vdGVzIGVsc2UgIiIKICAgICAgICAgICAgcHJvZmlsZV9saW5rID0gZiJbe3VzZXJfaWR9XSh0ZzovL3VzZXI/aWQ9e3VzZXJfaWR9KSB8IHtmdWxsbmFtZX0ge2Zvcm1hdF9iYWxhbmNlKHJld2FyZCl9IHtlcnJvcl9ub3RlX3N0cn0iCiAgICAgICAgICAgIHRvcF9pbmZvX2xpbmVzLmFwcGVuZChmIlRPUHtpbmRleCArIDF9OiB7cHJvZmlsZV9saW5rfSIpCgogICAgICAgIHRob25nYmFvX2FkbWluID0gZiLEkMOjIHRy4bqjIHRoxrDhu59uZyBUT1AgdHXhuqduOlxuXG4iICsgIlxuIi5qb2luKHRvcF9pbmZvX2xpbmVzKQogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCB0aG9uZ2Jhb19hZG1pbiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQogICAgICAgIHRidHJhdG9wdHVhbih0b3BfbGlzdCwgbGFiZWxfd2VlaykKICAgICAgICBwcmludCgiW0RFQlVHXSBH4butaSB0aMO0bmcgYsOhbyBhZG1pbiBob8OgbiB04bqldCIpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB0b3B0dWFuOiB7ZX0iKQogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCBmIkzhu5dpIGtoaSB44butIGzDvSB0b3B0dWFuOiB7ZX0iKQoKZGVmIHRidHJhdG9wdHVhbih0b3BfbGlzdCwgcHJldl93ZWVrKToKICAgIG1zZyA9IGYiSG/DoG4gdOG6pXQgdHLhuqMgdG9wIHR14bqnbiB7cHJldl93ZWVrfVxuXG4iCiAgICBwcml6ZXMgPSBbMTAwMDAwLCA1MDAwMCwgMjAwMDBdCiAgICBmb3IgaWR4LCAodXNlcl9pZCwgYW1vdW50KSBpbiBlbnVtZXJhdGUodG9wX2xpc3RbOjNdKToKICAgICAgICBoaWRkZW5faWQgPSBzdHIodXNlcl9pZCkKICAgICAgICBpZiBsZW4oaGlkZGVuX2lkKSA+IDY6CiAgICAgICAgICAgIGhpZGRlbl9pZCA9IGhpZGRlbl9pZFs6Nl0gKyAiKioqKiIKICAgICAgICBtc2cgKz0gZiJ7aGlkZGVuX2lkfSB7Zm9ybWF0X2JhbGFuY2UocHJpemVzW2lkeF0pfVxuIgogICAgdHJ5OgogICAgICAgIGJvdDIuc2VuZF9tZXNzYWdlKC0xMDAzNTg5OTQyMjg3LCBtc2cuc3RyaXAoKSkKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIHThu5VuZyBr4bq/dCB0cuG6oyB0b3AuIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltFUlJPUl0gR+G7rWkgdGJ0cmF0b3A6IHtlfSIpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAibmFwbW9uZXkiKQpkZWYgbmFwbW9uZXkoY2FsbCk6CiAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgbm90IGluIEFETUlOOgogICAgICAgIHJldHVybgogICAga2V5Ym9hcmQgPSB0eXBlcy5JbmxpbmVLZXlib2FyZE1hcmt1cChyb3dfd2lkdGg9MikKICAgIGJ0bl9iYW5rID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIk7huqFwIEJhbmsiLCBjYWxsYmFja19kYXRhPSJ3YWxsZXRiYW5rIikKICAgIGJ0bl9tb21vID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIk7huqFwIE1vbW8iLCBjYWxsYmFja19kYXRhPSJ3YWxsZXRtb21vIikKICAgIGJ0bl90aGVjYW8gPSB0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiTuG6oXAgdGjhursgY8OgbyIsIGNhbGxiYWNrX2RhdGE9IndhbGxldHRoZWNhbyIpCiAgICBrZXlib2FyZC5hZGQoYnRuX2JhbmssIGJ0bl9tb21vKQogICAga2V5Ym9hcmQuYWRkKGJ0bl90aGVjYW8pCiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBjaOG7jW4ga8OqbmggbuG6oXA6IiwgcmVwbHlfbWFya3VwPWtleWJvYXJkKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gIndhbGxldGJhbmsiKQpkZWYgd2FsbGV0YmFuayhjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIGRlZiBmb3JtYXRfYmFsYW5jZShhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgZGVmIGdldF92aWV0bmFtX3RpbWUoKToKICAgICAgICByZXR1cm4gZGF0ZXRpbWUubm93KHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKSkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKCiAgICBkZWYgZ2V0X2JhbGFuY2UodXNlcl9pZCk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCJGSUxFL3NkLnR4dCIpOgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc2QudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiB1cGRhdGVfY3VvY3RpZW4odXNlcl9pZCwgYW1vdW50KToKICAgICAgICBmaWxlX3BhdGggPSAiRklMRS9jdW9jdGllbi50eHQiCiAgICAgICAgdXBkYXRlZCA9IEZhbHNlCiAgICAgICAgbGluZXMgPSBbXQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgbGluZSA9IGxpbmUuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSAhPSAyOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHVpZCwgdmFsID0gcGFydHMKICAgICAgICAgICAgICAgICAgICBpZiB1aWQgPT0gc3RyKHVzZXJfaWQpOgogICAgICAgICAgICAgICAgICAgICAgICBuZXdfdG90YWwgPSBpbnQodmFsKSArIGFtb3VudAogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dWlkfSB7bmV3X3RvdGFsfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VpZH0ge3ZhbH0iKQogICAgICAgIGlmIG5vdCB1cGRhdGVkOgogICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge2Ftb3VudH0iKQogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICBmLndyaXRlKGxpbmUgKyAiXG4iKQoKICAgIGRlZiB1cGRhdGVfdmljaGluaCh1c2VyX2lkLCBuZXdfYmFsYW5jZSk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGxpbmVzID0gW10KICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIkZJTEUvc2QudHh0Iik6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgiXG4iKSBlbHNlIGxpbmUgKyAiXG4iKQogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3NkLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKICAgIGRlZiBhc2tfZm9yX3VzZXJfaWQoKToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIGjDo3kgZ+G7rWkgSUQgbmfGsOG7nWkgZMO5bmcgY+G6p24gbuG6oXA6IikKICAgICAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyX2J5X2NoYXRfaWQoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIHJlY2VpdmVfdXNlcl9pZCkKCiAgICBkZWYgcmVjZWl2ZV91c2VyX2lkKG1zZyk6CiAgICAgICAgdXNlcl9pZCA9IG1zZy50ZXh0LnN0cmlwKCkKICAgICAgICBleGlzdHMgPSBGYWxzZQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCJGSUxFL3NkLnR4dCIpOgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc2QudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBpZiBsaW5lLnN0YXJ0c3dpdGgodXNlcl9pZCArICIgIik6CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0cyA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBpZiBub3QgZXhpc3RzOgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIklEIGtow7RuZyB04buTbiB04bqhaSwgdnVpIGzDsm5nIGfhu61pIElEIGtow6FjLiIpCiAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCByZWNlaXZlX3VzZXJfaWQpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCBmIk5o4bqtcCBz4buRIHRp4buBbiBtdeG7kW4gbuG6oXAgY2hvIElEIHt1c2VyX2lkfToiKQogICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBsYW1iZGEgbTogcmVjZWl2ZV9hbW91bnQobSwgdXNlcl9pZCkpCgogICAgZGVmIHJlY2VpdmVfYW1vdW50KG1zZywgdXNlcl9pZCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBhbW91bnQgPSBpbnQobXNnLnRleHQuc3RyaXAoKS5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikpCiAgICAgICAgICAgIGlmIGFtb3VudCA8PSAwOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIlPhu5EgdGnhu4FuIGtow7RuZyBo4bujcCBs4buHLCB2dWkgbMOybmcgZ+G7rWkgbOG6oWkuIikKICAgICAgICAgICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIGxhbWJkYSBtOiByZWNlaXZlX2Ftb3VudChtLCB1c2VyX2lkKSkKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcl9pbmZvID0gYm90LmdldF9jaGF0KHVzZXJfaWQpCiAgICAgICAgICAgIGZ1bGxuYW1lID0gKHVzZXJfaW5mby5maXJzdF9uYW1lIG9yICIiKSArICgiICIgKyB1c2VyX2luZm8ubGFzdF9uYW1lIGlmIHVzZXJfaW5mby5sYXN0X25hbWUgZWxzZSAiIikKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIGZ1bGxuYW1lID0gIktow7RuZyByw7UiCgogICAgICAgIG9sZF9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZCkKICAgICAgICBuZXdfYmFsYW5jZSA9IG9sZF9iYWxhbmNlICsgYW1vdW50CiAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZCwgbmV3X2JhbGFuY2UpCiAgICAgICAgdXBkYXRlX2N1b2N0aWVuKHVzZXJfaWQsIGFtb3VudCkKICAgICAgICB0aW1lX3N0ciA9IGdldF92aWV0bmFtX3RpbWUoKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9sc25hcC50eHQiLCAiYSIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWR9IC0ge3RpbWVfc3RyfSAtIEJBTksgLSB7YW1vdW50fVxuIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0VSUk9SXSBHaGkgbHNuYXAudHh0IHRo4bqldCBi4bqhaToge2V9IikKCiAgICAgICAgYWRtaW5fbWVzc2FnZSA9ICgKICAgICAgICAgICAgZiLinIUgxJDDoyBu4bqhcCB0aMOgbmggY8O0bmdcbiIKICAgICAgICAgICAgZiLwn5GkIE5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWV9XG4iCiAgICAgICAgICAgIGYi8J+GlCBJRDogPGNvZGU+e3VzZXJfaWR9PC9jb2RlPlxuIgogICAgICAgICAgICBmIvCfkrAgU+G7kSB4dSBu4bqhcDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9IHh1XG4iCiAgICAgICAgICAgIGYi8J+StSBT4buRIHh1IG3hu5tpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSB4dVxuIgogICAgICAgICAgICBmIuKPsyBUaOG7nWkgZ2lhbjoge3RpbWVfc3RyfSIKICAgICAgICApCiAgICAgICAgZm9yIGFkIGluIEFETUlOOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShhZCwgYWRtaW5fbWVzc2FnZSwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSBhZG1pbjoge2V9IikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX21zZyA9ICgKICAgICAgICAgICAgICAgIGYiQuG6oW4gduG7q2EgbuG6oXAgQkFOSyB0aMOgbmggY8O0bmcgc+G7kSB4dToge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9XG5cbiIKICAgICAgICAgICAgICAgIGYiTUdEOiB7cmFuZG9tLnJhbmRpbnQoMTAwMDAwMDAwMDAsIDk5OTk5OTk5OTk5KX1cbiIKICAgICAgICAgICAgICAgIGYiLSBT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1IgogICAgICAgICAgICApCiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZCwgdXNlcl9tc2cpCiAgICAgICAgZXhjZXB0OgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiBuaOG6r24gdOG7m2kge3VzZXJfaWR9IikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBoaWRkZW5fdXNlciA9IHN0cih1c2VyX2lkKVs6Nl0gKyAiKioqKiIKICAgICAgICAgICAgZ3JvdXBfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgICAgICAgICBvdGhlcl90b2tlbiA9ICI4NDkzNzAzMjk3OkFBSFNmOHdUeGlwbjdURVRQMUI5WVNXcWFSNjBHbEpzVkhjIgogICAgICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfdG9rZW59L3NlbmRNZXNzYWdlIgogICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICJ0ZXh0IjogZiI8Yj5OZ8aw4budaSBjaMahaSBJRDoge2hpZGRlbl91c2VyfVxuXG4tIE7huqFwIEJBTksgdGjDoG5oIGPDtG5nIHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfSB4dTwvYj4iLAogICAgICAgICAgICAgICAgInBhcnNlX21vZGUiOiAiSFRNTCIKICAgICAgICAgICAgfQogICAgICAgICAgICByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1wYXlsb2FkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEfhu61pIG5ow7NtIHRo4bqldCBi4bqhaToge2V9IikKCiAgICBhc2tfZm9yX3VzZXJfaWQoKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gIndhbGxldG1vbW8iKQpkZWYgd2FsbGV0bW9tbyhjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIG1hbmFwX2RhdGEgPSB7fQoKICAgIGRlZiBmb3JtYXRfYmFsYW5jZShhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgZGVmIGdldF92aWV0bmFtX3RpbWUoKToKICAgICAgICByZXR1cm4gZGF0ZXRpbWUubm93KHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKSkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKCiAgICBkZWYgZ2V0X2JhbGFuY2UodXNlcl9pZCk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCJGSUxFL3NkLnR4dCIpOgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc2QudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiB1cGRhdGVfdmljaGluaCh1c2VyX2lkLCBuZXdfYmFsYW5jZSk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGxpbmVzID0gW10KICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIkZJTEUvc2QudHh0Iik6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgiXG4iKSBlbHNlIGxpbmUgKyAiXG4iKQogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3NkLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKICAgIGRlZiB1cGRhdGVfY3VvY3RpZW4odXNlcl9pZCwgYW1vdW50X3RvX2FkZCk6CiAgICAgICAgZmlsZV9wYXRoID0gIkZJTEUvY3VvY3RpZW4udHh0IgogICAgICAgIHVwZGF0ZWQgPSBGYWxzZQogICAgICAgIGxpbmVzID0gW10KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICB1aWQsIHZhbCA9IHBhcnRzCiAgICAgICAgICAgICAgICAgICAgaWYgdWlkID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3RvdGFsID0gaW50KHZhbCkgKyBhbW91bnRfdG9fYWRkCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1aWR9IHtuZXdfdG90YWx9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lIGlmIGxpbmUuZW5kc3dpdGgoIlxuIikgZWxzZSBsaW5lICsgIlxuIikKICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHthbW91bnRfdG9fYWRkfVxuIikKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGVsaW5lcyhsaW5lcykKCiAgICBkZWYgYXNrX2Zvcl91c2VyX2lkZW50aWZpZXIoKToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBn4butaSBtw6MgaG/hurdjIElEIG5nxrDhu51pIGTDuW5nIGPhuqduIG7huqFwIE1PTU86IikKICAgICAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyX2J5X2NoYXRfaWQoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIHJlY2VpdmVfdXNlcl9pZGVudGlmaWVyKQoKICAgIGRlZiByZWNlaXZlX3VzZXJfaWRlbnRpZmllcihtc2cpOgogICAgICAgIHVzZXJfaWRlbnRpZmllciA9IG1zZy50ZXh0LnN0cmlwKCkKICAgICAgICBpZiB1c2VyX2lkZW50aWZpZXIgaW4gbWFuYXBfZGF0YToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdXNlcl9pZF90b19uYXAgPSBpbnQobWFuYXBfZGF0YVt1c2VyX2lkZW50aWZpZXJdKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFTDrG0gdGjhuqV5IElEIG5nxrDhu51pIGTDuW5nIHThu6sgbcOjOiB7dXNlcl9pZF90b19uYXB9IikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGNodXnhu4NuIElEIHThu6sgbWFuYXBfZGF0YToge2V9IikKICAgICAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCAiTcOjIG5nxrDhu51pIGTDuW5nIGtow7RuZyBo4bujcCBs4buHLCB2dWkgbMOybmcgZ+G7rWkgbOG6oWkuIikKICAgICAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCByZWNlaXZlX3VzZXJfaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXJfaWRfdG9fbmFwID0gaW50KHVzZXJfaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBEw7luZyBJRCB0cuG7sWMgdGnhur9wOiB7dXNlcl9pZF90b19uYXB9IikKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIklEIGtow7RuZyBo4bujcCBs4buHLCB2dWkgbMOybmcgZ+G7rWkgbOG6oWkuIikKICAgICAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCByZWNlaXZlX3VzZXJfaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4aXN0cyA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIkZJTEUvc2QudHh0Iik6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGlmIGxpbmUuc3RhcnRzd2l0aChzdHIodXNlcl9pZF90b19uYXApICsgIiAiKToKICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RzID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIG5vdCBleGlzdHM6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCAiSUQga2jDtG5nIHThu5NuIHThuqFpIHRyb25nIGjhu4cgdGjhu5FuZywgdnVpIGzDsm5nIGfhu61pIGzhuqFpLiIpCiAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCByZWNlaXZlX3VzZXJfaWRlbnRpZmllcikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCBmIk5o4bqtcCBz4buRIHRp4buBbiBtdeG7kW4gbuG6oXAgTU9NTyBjaG8gSUQge3VzZXJfaWRfdG9fbmFwfToiKQogICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBsYW1iZGEgbTogcmVjZWl2ZV9hbW91bnQobSwgdXNlcl9pZF90b19uYXApKQoKICAgIGRlZiByZWNlaXZlX2Ftb3VudChtc2csIHVzZXJfaWRfdG9fbmFwKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFtb3VudF90b19uYXAgPSBpbnQobXNnLnRleHQuc3RyaXAoKS5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikpCiAgICAgICAgICAgIGlmIGFtb3VudF90b19uYXAgPD0gMDoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJT4buRIHRp4buBbiBraMO0bmcgaOG7o3AgbOG7hywgdnVpIGzDsm5nIGfhu61pIGzhuqFpLiIpCiAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBsYW1iZGEgbTogcmVjZWl2ZV9hbW91bnQobSwgdXNlcl9pZF90b19uYXApKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b19uYXApCiAgICAgICAgICAgIGZ1bGxuYW1lX3RvX25hcCA9IHVzZXJfaW5mby5maXJzdF9uYW1lIG9yICIiCiAgICAgICAgICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgICAgICAgICBmdWxsbmFtZV90b19uYXAgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGjDtG5nIHRpbiBuZ8aw4budaSBkw7luZzoge2Z1bGxuYW1lX3RvX25hcH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCAiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIG7DoHkuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyB24bubaSBJRCB7dXNlcl9pZF90b19uYXB9LiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkX3RvX25hcCkKICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19uYXAKICAgICAgICB1cGRhdGVfdmljaGluaCh1c2VyX2lkX3RvX25hcCwgbmV3X2JhbGFuY2UpCiAgICAgICAgdXBkYXRlX2N1b2N0aWVuKHVzZXJfaWRfdG9fbmFwLCBhbW91bnRfdG9fbmFwKQogICAgICAgIGN1cnJlbnRfdGltZSA9IGdldF92aWV0bmFtX3RpbWUoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaOG7nWkgZ2lhbiBnaWFvIGThu4tjaDoge2N1cnJlbnRfdGltZX0iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbignRklMRS9sc25hcC50eHQnLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWRfdG9fbmFwfSAtIHtjdXJyZW50X3RpbWV9IC0gTU9NTyAtIHthbW91bnRfdG9fbmFwfVxuIikKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGdoaSBs4buLY2ggc+G7rSBu4bqhcCBNT01POiB7dXNlcl9pZF90b19uYXB9IC0ge2N1cnJlbnRfdGltZX0gLSBNT01PIC0ge2Ftb3VudF90b19uYXB9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBnaGkgbOG7i2NoIHPhu60gbuG6oXA6IHtlfSIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBhZG1pbl9tZXNzYWdlID0gKAogICAgICAgICAgICBmIuKchSDEkMOjIG7huqFwIHRow6BuaCBjw7RuZ1xuIgogICAgICAgICAgICBmIvCfkaQgTmfGsOG7nWkgZMO5bmc6IHtmdWxsbmFtZV90b19uYXB9XG4iCiAgICAgICAgICAgIGYi8J+GlCBJRDogPGNvZGU+e3VzZXJfaWRfdG9fbmFwfTwvY29kZT5cbiIKICAgICAgICAgICAgZiLwn5KwIFPhu5EgeHUgbuG6oXA6IHtmb3JtYXRfYmFsYW5jZShhbW91bnRfdG9fbmFwKX0geHVcbiIKICAgICAgICAgICAgZiLwn5K1IFPhu5EgeHUgbeG7m2k6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1XG4iCiAgICAgICAgICAgIGYi4o+zIFRo4budaSBnaWFuOiB7Y3VycmVudF90aW1lfSIKICAgICAgICApCiAgICAgICAgZm9yIGFkbWluX2lkIGluIEFETUlOOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShhZG1pbl9pZCwgYWRtaW5fbWVzc2FnZSwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBu4bqhcCBNT01PIGNobyBhZG1pbiB7YWRtaW5faWR9LiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSB0aMO0bmcgYsOhbyDEkeG6v24gYWRtaW4ge2FkbWluX2lkfToge2V9IikKCiAgICAgICAgdXNlcl9tZXNzYWdlID0gKAogICAgICAgICAgICBmIlRhZGFhISBC4bqhbiB24burYSBu4bqhcCBNT01PIHRow6BuaCBjw7RuZyBz4buRIHh1OiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX25hcCl9XG5cbiIKICAgICAgICAgICAgZiJNR0Q6IHtyYW5kb20ucmFuZGludCgxMDAwMDAwMDAwMCwgOTk5OTk5OTk5OTkpfVxuIgogICAgICAgICAgICBmIi0gU+G7kSBkxrAgaGnhu4duIHThuqFpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSB4dSIKICAgICAgICApCiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3Quc2VuZF9tZXNzYWdlKHVzZXJfaWRfdG9fbmFwLCB1c2VyX21lc3NhZ2UpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG7huqFwIHRow6BuaCBjw7RuZyBNT01PIGNobyBuZ8aw4budaSBkw7luZyB7dXNlcl9pZF90b19uYXB9LiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kgZ+G7rWkgdGjDtG5nIGLDoW8gxJHhur9uIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH06IHtlfSIpCgogICAgICAgIGdyb3VwX2NoYXRfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgICAgIHVzZXJfaWRfc3RyID0gc3RyKHVzZXJfaWRfdG9fbmFwKQogICAgICAgIGhpZGRlbl91c2VyX2lkID0gdXNlcl9pZF9zdHJbOjZdICsgIioqKioiCiAgICAgICAgZ3JvdXBfbWVzc2FnZSA9ICgKICAgICAgICAgICAgZiI8Yj5OZ8aw4budaSBjaMahaSBJRDoge2hpZGRlbl91c2VyX2lkfVxuXG4iCiAgICAgICAgICAgIGYiLSBO4bqhcCBNT01PIHRow6BuaCBjw7RuZyB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX25hcCl9IHh1PC9iPiIKICAgICAgICApCiAgICAgICAgb3RoZXJfYm90X3Rva2VuID0gIjg0OTM3MDMyOTc6QUFIU2Y4d1R4aXBuN1RFVFAxQjlZU1dxYVI2MEdsSnNWSGMiCiAgICAgICAgdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e290aGVyX2JvdF90b2tlbn0vc2VuZE1lc3NhZ2UiCiAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9jaGF0X2lkLAogICAgICAgICAgICAidGV4dCI6IGdyb3VwX21lc3NhZ2UsCiAgICAgICAgICAgICJwYXJzZV9tb2RlIjogIkhUTUwiCiAgICAgICAgfQogICAgICAgIHRyeToKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1wYXlsb2FkKQogICAgICAgICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gbuG6oXAgTU9NTyB2w6BvIG5ow7NtLiIpCiAgICAgICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRow7RuZyBiw6FvIMSR4bq/biBuaMOzbToge2V9IikKCiAgICBhc2tfZm9yX3VzZXJfaWRlbnRpZmllcigpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAid2FsbGV0dGhlY2FvIikKZGVmIHdhbGxldHRoZWNhbyhjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIG1hbmFwX2RhdGEgPSB7fQoKICAgIGRlZiBmb3JtYXRfYmFsYW5jZShhbW91bnQpOgogICAgICAgIHJldHVybiBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCgogICAgZGVmIGdldF92aWV0bmFtX3RpbWUoKToKICAgICAgICByZXR1cm4gZGF0ZXRpbWUubm93KHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKSkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKCiAgICBkZWYgZ2V0X2JhbGFuY2UodXNlcl9pZCk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKCJGSUxFL3NkLnR4dCIpOgogICAgICAgICAgICB3aXRoIG9wZW4oIkZJTEUvc2QudHh0IiwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFydHNbMF0gPT0gdXNlcl9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGludChwYXJ0c1sxXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMAoKICAgIGRlZiB1cGRhdGVfdmljaGluaCh1c2VyX2lkLCBuZXdfYmFsYW5jZSk6CiAgICAgICAgdXNlcl9pZCA9IHN0cih1c2VyX2lkKQogICAgICAgIGxpbmVzID0gW10KICAgICAgICBmb3VuZCA9IEZhbHNlCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoIkZJTEUvc2QudHh0Iik6CiAgICAgICAgICAgIHdpdGggb3BlbigiRklMRS9zZC50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgICAgICBpZiBwYXJ0c1swXSA9PSB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge25ld19iYWxhbmNlfVxuIikKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMuYXBwZW5kKGxpbmUgaWYgbGluZS5lbmRzd2l0aCgiXG4iKSBlbHNlIGxpbmUgKyAiXG4iKQogICAgICAgIGlmIG5vdCBmb3VuZDoKICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtuZXdfYmFsYW5jZX1cbiIpCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3NkLnR4dCIsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZWxpbmVzKGxpbmVzKQoKICAgIGRlZiB1cGRhdGVfY3VvY3RpZW4odXNlcl9pZCwgYW1vdW50X3RvX2FkZCk6CiAgICAgICAgZmlsZV9wYXRoID0gIkZJTEUvY3VvY3RpZW4udHh0IgogICAgICAgIHVwZGF0ZWQgPSBGYWxzZQogICAgICAgIGxpbmVzID0gW10KICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgIT0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICB1aWQsIHZhbCA9IHBhcnRzCiAgICAgICAgICAgICAgICAgICAgaWYgdWlkID09IHN0cih1c2VyX2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3RvdGFsID0gaW50KHZhbCkgKyBhbW91bnRfdG9fYWRkCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChmInt1aWR9IHtuZXdfdG90YWx9XG4iKQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzLmFwcGVuZChsaW5lIGlmIGxpbmUuZW5kc3dpdGgoIlxuIikgZWxzZSBsaW5lICsgIlxuIikKICAgICAgICBpZiBub3QgdXBkYXRlZDoKICAgICAgICAgICAgbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHthbW91bnRfdG9fYWRkfVxuIikKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGVsaW5lcyhsaW5lcykKCiAgICBkZWYgYXNrX2Zvcl91c2VyX2lkZW50aWZpZXIoKToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBn4butaSBtw6MgaG/hurdjIElEIG5nxrDhu51pIGTDuW5nIGPhuqduIEfhuqFjaCB0aOG6uyBjw6BvOiIpCiAgICAgICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKGNhbGwubWVzc2FnZS5jaGF0LmlkLCByZWNlaXZlX3VzZXJfaWRlbnRpZmllcikKCiAgICBkZWYgcmVjZWl2ZV91c2VyX2lkZW50aWZpZXIobXNnKToKICAgICAgICB1c2VyX2lkZW50aWZpZXIgPSBtc2cudGV4dC5zdHJpcCgpCiAgICAgICAgaWYgdXNlcl9pZGVudGlmaWVyIGluIG1hbmFwX2RhdGE6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHVzZXJfaWRfdG9fbmFwID0gaW50KG1hbmFwX2RhdGFbdXNlcl9pZGVudGlmaWVyXSkKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUw6xtIHRo4bqleSBJRCBuZ8aw4budaSBkw7luZyB04burIG3Dozoge3VzZXJfaWRfdG9fbmFwfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBjaHV54buDbiBJRCB04burIG1hbmFwX2RhdGE6IHtlfSIpCiAgICAgICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIk3DoyBuZ8aw4budaSBkw7luZyBraMO0bmcgaOG7o3AgbOG7hywgdnVpIGzDsm5nIGfhu61pIGzhuqFpLiIpCiAgICAgICAgICAgICAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcmVjZWl2ZV91c2VyX2lkZW50aWZpZXIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB1c2VyX2lkX3RvX25hcCA9IGludCh1c2VyX2lkZW50aWZpZXIpCiAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gRMO5bmcgSUQgdHLhu7FjIHRp4bq/cDoge3VzZXJfaWRfdG9fbmFwfSIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJJRCBraMO0bmcgaOG7o3AgbOG7hywgdnVpIGzDsm5nIGfhu61pIGzhuqFpLiIpCiAgICAgICAgICAgICAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcmVjZWl2ZV91c2VyX2lkZW50aWZpZXIpCiAgICAgICAgICAgICAgICByZXR1cm4KCiAgICAgICAgZXhpc3RzID0gRmFsc2UKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cygiRklMRS9zZC50eHQiKToKICAgICAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3NkLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICAgICAgaWYgbGluZS5zdGFydHN3aXRoKHN0cih1c2VyX2lkX3RvX25hcCkgKyAiICIpOgogICAgICAgICAgICAgICAgICAgICAgICBleGlzdHMgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgaWYgbm90IGV4aXN0czoKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJJRCBraMO0bmcgdOG7k24gdOG6oWkgdHJvbmcgaOG7hyB0aOG7kW5nLCB2dWkgbMOybmcgZ+G7rWkgbOG6oWkuIikKICAgICAgICAgICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHJlY2VpdmVfdXNlcl9pZGVudGlmaWVyKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsIGYiTmjhuq1wIHPhu5EgdGnhu4FuIG114buRbiBH4bqhY2ggdGjhursgY8OgbyBjaG8gSUQge3VzZXJfaWRfdG9fbmFwfToiKQogICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBsYW1iZGEgbTogcmVjZWl2ZV9hbW91bnQobSwgdXNlcl9pZF90b19uYXApKQoKICAgIGRlZiByZWNlaXZlX2Ftb3VudChtc2csIHVzZXJfaWRfdG9fbmFwKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFtb3VudF90b19uYXAgPSBpbnQobXNnLnRleHQuc3RyaXAoKS5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikpCiAgICAgICAgICAgIGlmIGFtb3VudF90b19uYXAgPD0gMDoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJT4buRIHRp4buBbiBraMO0bmcgaOG7o3AgbOG7hywgdnVpIGzDsm5nIGfhu61pIGzhuqFpLiIpCiAgICAgICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCBsYW1iZGEgbTogcmVjZWl2ZV9hbW91bnQobSwgdXNlcl9pZF90b19uYXApKQogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b19uYXApCiAgICAgICAgICAgIGZ1bGxuYW1lX3RvX25hcCA9IHVzZXJfaW5mby5maXJzdF9uYW1lIG9yICIiCiAgICAgICAgICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgICAgICAgICBmdWxsbmFtZV90b19uYXAgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgICAgICAgICBwcmludChmIltERUJVR10gVGjDtG5nIHRpbiBuZ8aw4budaSBkw7luZzoge2Z1bGxuYW1lX3RvX25hcH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCAiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIG7DoHkuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyB24bubaSBJRCB7dXNlcl9pZF90b19uYXB9LiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBjdXJyZW50X2JhbGFuY2UgPSBnZXRfYmFsYW5jZSh1c2VyX2lkX3RvX25hcCkKICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19uYXAKICAgICAgICB1cGRhdGVfdmljaGluaCh1c2VyX2lkX3RvX25hcCwgbmV3X2JhbGFuY2UpCiAgICAgICAgdXBkYXRlX2N1b2N0aWVuKHVzZXJfaWRfdG9fbmFwLCBhbW91bnRfdG9fbmFwKQogICAgICAgIGN1cnJlbnRfdGltZSA9IGdldF92aWV0bmFtX3RpbWUoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaOG7nWkgZ2lhbiBnaWFvIGThu4tjaDoge2N1cnJlbnRfdGltZX0iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggb3BlbignRklMRS9sc25hcC50eHQnLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGYie3VzZXJfaWRfdG9fbmFwfSAtIHtjdXJyZW50X3RpbWV9IC0gVEhFQ0FPIC0ge2Ftb3VudF90b19uYXB9XG4iKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ2hpIGzhu4tjaCBz4butIEfhuqFjaCB0aOG6uyBjw6BvOiB7dXNlcl9pZF90b19uYXB9IC0ge2N1cnJlbnRfdGltZX0gLSBUSEVDQU8gLSB7YW1vdW50X3RvX25hcH0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGdoaSBs4buLY2ggc+G7rSBu4bqhcDoge2V9IikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGFkbWluX21lc3NhZ2UgPSAoCiAgICAgICAgICAgIGYi4pyFIMSQw6MgR+G6oWNoIHRo4bq7IGPDoG8gdGjDoG5oIGPDtG5nXG4iCiAgICAgICAgICAgIGYi8J+RpCBOZ8aw4budaSBkw7luZzoge2Z1bGxuYW1lX3RvX25hcH1cbiIKICAgICAgICAgICAgZiLwn4aUIElEOiA8Y29kZT57dXNlcl9pZF90b19uYXB9PC9jb2RlPlxuIgogICAgICAgICAgICBmIvCfkrAgU+G7kSB4dSBu4bqhcDoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfSB4dVxuIgogICAgICAgICAgICBmIvCfkrUgU+G7kSB4dSBt4bubaToge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0geHVcbiIKICAgICAgICAgICAgZiLij7MgVGjhu51pIGdpYW46IHtjdXJyZW50X3RpbWV9IgogICAgICAgICkKICAgICAgICBmb3IgYWRtaW5faWQgaW4gQURNSU46CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGFkbWluX2lkLCBhZG1pbl9tZXNzYWdlLCBwYXJzZV9tb2RlPSJIVE1MIikKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIEfhuqFjaCB0aOG6uyBjw6BvIGNobyBhZG1pbiB7YWRtaW5faWR9LiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSB0aMO0bmcgYsOhbyDEkeG6v24gYWRtaW4ge2FkbWluX2lkfToge2V9IikKCiAgICAgICAgdXNlcl9tZXNzYWdlID0gKAogICAgICAgICAgICBmIlRhZGFhISBC4bqhbiB24burYSBn4bqhY2ggdGjhursgdGjDoG5oIGPDtG5nIHPhu5EgeHU6IHtmb3JtYXRfYmFsYW5jZShhbW91bnRfdG9fbmFwKX1cblxuIgogICAgICAgICAgICBmIk1HRDoge3JhbmRvbS5yYW5kaW50KDEwMDAwMDAwMDAwLCA5OTk5OTk5OTk5OSl9XG4iCiAgICAgICAgICAgIGYiLSBT4buRIGTGsCBoaeG7h24gdOG6oWk6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1IgogICAgICAgICkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdC5zZW5kX21lc3NhZ2UodXNlcl9pZF90b19uYXAsIHVzZXJfbWVzc2FnZSkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gbuG6oXAgdGjDoG5oIGPDtG5nIHRo4bq7IGPDoG8gY2hvIG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX25hcH0uIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSB0aMO0bmcgYsOhbyDEkeG6v24gbmfGsOG7nWkgZMO5bmcge3VzZXJfaWRfdG9fbmFwfToge2V9IikKCiAgICAgICAgZ3JvdXBfY2hhdF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICAgICAgdXNlcl9pZF9zdHIgPSBzdHIodXNlcl9pZF90b19uYXApCiAgICAgICAgaGlkZGVuX3VzZXJfaWQgPSB1c2VyX2lkX3N0cls6Nl0gKyAiKioqKiIKICAgICAgICBncm91cF9tZXNzYWdlID0gKAogICAgICAgICAgICBmIjxiPk5nxrDhu51pIGNoxqFpIElEOiB7aGlkZGVuX3VzZXJfaWR9XG5cbiIKICAgICAgICAgICAgZiItIEfhuqFjaCB0aOG6uyB0aMOgbmggY8O0bmcge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19uYXApfSB4dTwvYj4iCiAgICAgICAgICkKICAgICAgICBvdGhlcl9ib3RfdG9rZW4gPSAiODQ5MzcwMzI5NzpBQUhTZjh3VHhpcG43VEVUUDFCOVlTV3FhUjYwR2xKc1ZIYyIKICAgICAgICB1cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfYm90X3Rva2VufS9zZW5kTWVzc2FnZSIKICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAiY2hhdF9pZCI6IGdyb3VwX2NoYXRfaWQsCiAgICAgICAgICAgICJ0ZXh0IjogZ3JvdXBfbWVzc2FnZSwKICAgICAgICAgICAgInBhcnNlX21vZGUiOiAiSFRNTCIKICAgICAgICB9CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QodXJsLCBqc29uPXBheWxvYWQpCiAgICAgICAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBH4bqhY2ggdGjhursgY8OgbyB2w6BvIG5ow7NtLiIpCiAgICAgICAgZXhjZXB0IHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHRow7RuZyBiw6FvIMSR4bq/biBuaMOzbToge2V9IikKCiAgICBhc2tfZm9yX3VzZXJfaWRlbnRpZmllcigpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiY29uZ21vbmV5IikKZGVmIGNvbmdtb25leShjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIGtleWJvYXJkID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRNYXJrdXAocm93X3dpZHRoPTIpCiAgICBhbW91bnRzID0gWzEwXzAwMCwgMjBfMDAwLCA1MF8wMDAsIDEwMF8wMDAsIDIwMF8wMDAsIDUwMF8wMDAsCiAgICAgICAgICAgICAgIDFfMDAwXzAwMCwgMl8wMDBfMDAwLCA1XzAwMF8wMDAsIDEwXzAwMF8wMDBdCgogICAgYnV0dG9ucyA9IFtdCiAgICBmb3IgYW1vdW50IGluIGFtb3VudHM6CiAgICAgICAgZm9ybWF0dGVkID0gZiJ7YW1vdW50Oix9Ii5yZXBsYWNlKCIsIiwgIi4iKQogICAgICAgIGJ1dHRvbiA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKGYie2Zvcm1hdHRlZH0iLCBjYWxsYmFja19kYXRhPWYiY29uZ197YW1vdW50fSIpCiAgICAgICAgYnV0dG9ucy5hcHBlbmQoYnV0dG9uKQoKICAgIGZvciBpIGluIHJhbmdlKDAsIGxlbihidXR0b25zKSwgMik6CiAgICAgICAga2V5Ym9hcmQuYWRkKCpidXR0b25zW2k6aSsyXSkKICAgIGtleWJvYXJkLmFkZCh0eXBlcy5JbmxpbmVLZXlib2FyZEJ1dHRvbigiU+G7kSB0aeG7gW4ga2jDoWMiLCBjYWxsYmFja19kYXRhPSJjb25nX2toYWMiKSkKCiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBjaOG7jW4gc+G7kSB0aeG7gW4gY+G7mW5nOiIsIHJlcGx5X21hcmt1cD1rZXlib2FyZCkKCkBib3QxLmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJjb25nX2toYWMiKQpkZWYgY29uZ19raGFjKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkICE9IDgyMDU1Njc4NTE6CiAgICAgICAgcmV0dXJuCiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIvCfkqwgVnVpIGzDsm5nIG5o4bqtcCBz4buRIHRp4buBbiBtdeG7kW4gY+G7mW5nOiIpCiAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyX2J5X2NoYXRfaWQoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIHJlY2VpdmVfY3VzdG9tX2Ftb3VudCkKCkBib3QxLmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhLnN0YXJ0c3dpdGgoImNvbmdfIikgYW5kIGNhbGwuZGF0YSAhPSAiY29uZ19raGFjIikKZGVmIGNvbmdfc2VsZWN0X2Ftb3VudChjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBhbW91bnQgPSBpbnQoY2FsbC5kYXRhLnNwbGl0KCJfIilbMV0pCiAgICBleGNlcHQ6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsICJT4buRIHRp4buBbiBraMO0bmcgaOG7o3AgbOG7hy4iKQogICAgICAgIHJldHVybgoKICAgIGFkbWluX2Ftb3VudF9zZWxlY3Rpb25bY2FsbC5mcm9tX3VzZXIuaWRdID0gYW1vdW50CiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgZiJC4bqhbiDEkcOjIGNo4buNbiBj4buZbmcge2Ftb3VudDosfSB4dS4gVnVpIGzDsm5nIGfhu61pIElEIG5nxrDhu51pIGTDuW5nIMSR4buDIGPhu5luZyB0aeG7gW46IikKICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXJfYnlfY2hhdF9pZChjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgcmVjZWl2ZV91c2VyX2lkX2Zvcl9jb25nLCBjYWxsLmZyb21fdXNlci5pZCkKCmRlZiByZWNlaXZlX2N1c3RvbV9hbW91bnQobWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KG1lc3NhZ2UudGV4dC5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikuc3RyaXAoKSkKICAgICAgICBpZiBhbW91bnQgPD0gMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcgogICAgZXhjZXB0OgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgdGnhu4FuIGtow7RuZyBo4bujcCBs4buHLiBI4buneSB0aGFvIHTDoWMuIikKICAgICAgICByZXR1cm4KCiAgICBhZG1pbl9hbW91bnRfc2VsZWN0aW9uW21lc3NhZ2UuZnJvbV91c2VyLmlkXSA9IGFtb3VudAogICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIsSQw6MgY2jhu41uIGPhu5luZyB7YW1vdW50Oix9IHh1LiBOaOG6rXAgSUQgbmfGsOG7nWkgZMO5bmc6IikKICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXJfYnlfY2hhdF9pZChtZXNzYWdlLmNoYXQuaWQsIHJlY2VpdmVfdXNlcl9pZF9mb3JfY29uZywgbWVzc2FnZS5mcm9tX3VzZXIuaWQpCgpkZWYgcmVjZWl2ZV91c2VyX2lkX2Zvcl9jb25nKG1zZywgYWRtaW5faWQpOgogICAgaWYgbXNnLmZyb21fdXNlci5pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIHVzZXJfaWRfdGV4dCA9IG1zZy50ZXh0LnN0cmlwKCkKICAgIHRyeToKICAgICAgICB1c2VyX2lkX3RvX2NvbmcgPSBpbnQodXNlcl9pZF90ZXh0KQogICAgZXhjZXB0OgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1zZy5jaGF0LmlkLCAiSUQga2jDtG5nIGjhu6NwIGzhu4csIHZ1aSBsw7JuZyBn4butaSBs4bqhaSBJRCBo4bujcCBs4buHOiIpCiAgICAgICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcihtc2csIHJlY2VpdmVfdXNlcl9pZF9mb3JfY29uZywgYWRtaW5faWQpCiAgICAgICAgcmV0dXJuCgogICAgaWYgYWRtaW5faWQgbm90IGluIGFkbWluX2Ftb3VudF9zZWxlY3Rpb246CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJM4buXaToga2jDtG5nIHTDrG0gdGjhuqV5IHPhu5EgdGnhu4FuIMSRw6MgY2jhu41uLiBWdWkgbMOybmcgY2jhu41uIGzhuqFpIHPhu5EgdGnhu4FuLiIpCiAgICAgICAgcmV0dXJuCgogICAgYW1vdW50X3RvX2NvbmcgPSBhZG1pbl9hbW91bnRfc2VsZWN0aW9uW2FkbWluX2lkXQogICAgaWYgYW1vdW50X3RvX2NvbmcgPD0gMCBvciBhbW91bnRfdG9fY29uZyA+IDFfMDAwXzAwMF8wMDBfMDAwXzAwMDoKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIlPhu5EgeHUgdsaw4bujdCBnaeG7m2kgaOG6oW4gY2hvIHBow6lwLiIpCiAgICAgICAgcmV0dXJuCgogICAgdHJ5OgogICAgICAgIHVzZXJfaW5mbyA9IGJvdC5nZXRfY2hhdCh1c2VyX2lkX3RvX2NvbmcpCiAgICAgICAgZnVsbG5hbWUgPSB1c2VyX2luZm8uZmlyc3RfbmFtZSBvciAiIgogICAgICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgICAgIGZ1bGxuYW1lICs9IGYiIHt1c2VyX2luZm8ubGFzdF9uYW1lfSIKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgZiJM4buXaSBraGkgbOG6pXkgdGjDtG5nIHRpbiB1c2VyOiB7ZX0iKQogICAgICAgIHJldHVybgogICAgY3VycmVudF9iYWxhbmNlID0gZ2V0X2JhbGFuY2UodXNlcl9pZF90b19jb25nKQogICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgKyBhbW91bnRfdG9fY29uZwogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZF90b19jb25nLCBuZXdfYmFsYW5jZSkKCiAgICBhZG1pbl9tZXNzYWdlID0gKAogICAgICAgIGYi4pyFIMSQw6MgY+G7mW5nIHRp4buBbiB0aMOgbmggY8O0bmdcbiIKICAgICAgICBmIvCfkaQgTmfGsOG7nWkgZMO5bmc6IHtmdWxsbmFtZX1cbiIKICAgICAgICBmIvCfhpQgSUQ6IHt1c2VyX2lkX3RvX2Nvbmd9XG4iCiAgICAgICAgZiLwn5KwIFPhu5EgeHUgxJHGsOG7o2MgY+G7mW5nOiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX2NvbmcpfSB4dVxuIgogICAgICAgIGYi8J+StSBT4buRIHh1IG3hu5tpOiB7Zm9ybWF0X2JhbGFuY2UobmV3X2JhbGFuY2UpfSB4dVxuIgogICAgICAgIGYi4o+zIFRo4budaSBnaWFuOiB7dGltZS5zdHJmdGltZSgnJUg6JU06JVMgJWQvJW0vJVknLCB0aW1lLmxvY2FsdGltZSgpKX0iCiAgICApCiAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIsSQw6MgY+G7mW5nIHRp4buBbiB0aMOgbmggY8O0bmchIikKICAgIGZvciBhZG1pbl9pZF8gaW4gQURNSU46CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShhZG1pbl9pZF8sIGFkbWluX21lc3NhZ2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiBuaOG6r24gxJHhur9uIGFkbWluIHthZG1pbl9pZF99OiB7ZX0iKQogICAgZGVsIGFkbWluX2Ftb3VudF9zZWxlY3Rpb25bYWRtaW5faWRdCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidHJ1bW9uZXkiKQpkZWYgdHJ1bW9uZXkoY2FsbCk6CiAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgbm90IGluIEFETUlOOgogICAgICAgIHJldHVybgogICAga2V5Ym9hcmQgPSB0eXBlcy5JbmxpbmVLZXlib2FyZE1hcmt1cChyb3dfd2lkdGg9MikKICAgIGFtb3VudHMgPSBbMTBfMDAwLCAyMF8wMDAsIDUwXzAwMCwgMTAwXzAwMCwgMjAwXzAwMCwgNTAwXzAwMCwKICAgICAgICAgICAgICAgMV8wMDBfMDAwLCAyXzAwMF8wMDAsIDVfMDAwXzAwMCwgMTBfMDAwXzAwMF0KCiAgICBidXR0b25zID0gW10KICAgIGZvciBhbW91bnQgaW4gYW1vdW50czoKICAgICAgICBmb3JtYXR0ZWQgPSBmInthbW91bnQ6LH0iLnJlcGxhY2UoIiwiLCAiLiIpCiAgICAgICAgYnV0dG9uID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oZiJ7Zm9ybWF0dGVkfSIsIGNhbGxiYWNrX2RhdGE9ZiJ0cnVfe2Ftb3VudH0iKQogICAgICAgIGJ1dHRvbnMuYXBwZW5kKGJ1dHRvbikKCiAgICBmb3IgaSBpbiByYW5nZSgwLCBsZW4oYnV0dG9ucyksIDIpOgogICAgICAgIGtleWJvYXJkLmFkZCgqYnV0dG9uc1tpOmkrMl0pCiAgICBrZXlib2FyZC5hZGQodHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIlPhu5EgdGnhu4FuIGtow6FjIiwgY2FsbGJhY2tfZGF0YT0idHJ1X2toYWMiKSkKCiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBjaOG7jW4gc+G7kSB0aeG7gW4gdHLhu6s6IiwgcmVwbHlfbWFya3VwPWtleWJvYXJkKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRydV9raGFjIikKZGVmIHRydV9raGFjKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkIG5vdCBpbiBBRE1JTjoKICAgICAgICByZXR1cm4KICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAi8J+SrCBWdWkgbMOybmcgbmjhuq1wIHPhu5EgdGnhu4FuIG114buRbiB0cuG7qzoiKQogICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKGNhbGwubWVzc2FnZS5jaGF0LmlkLCByZWNlaXZlX2N1c3RvbV90cnVfYW1vdW50KQoKZGVmIHJlY2VpdmVfY3VzdG9tX3RydV9hbW91bnQobWVzc2FnZSk6CiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KG1lc3NhZ2UudGV4dC5yZXBsYWNlKCIuIiwgIiIpLnJlcGxhY2UoIiwiLCAiIikuc3RyaXAoKSkKICAgICAgICBpZiBhbW91bnQgPD0gMDoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcgogICAgZXhjZXB0OgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgIlPhu5EgdGnhu4FuIGtow7RuZyBo4bujcCBs4buHLiBI4buneSB0aGFvIHTDoWMuIikKICAgICAgICByZXR1cm4KCiAgICBhZG1pbl90cnVfYW1vdW50W21lc3NhZ2UuZnJvbV91c2VyLmlkXSA9IGFtb3VudAogICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIsSQw6MgY2jhu41uIHRy4burIHthbW91bnQ6LH0geHUuIE5o4bqtcCBJRCBuZ8aw4budaSBkw7luZzoiKQogICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKG1lc3NhZ2UuY2hhdC5pZCwgcmVjZWl2ZV91c2VyX2lkX2Zvcl90cnUsIG1lc3NhZ2UuZnJvbV91c2VyLmlkKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEuc3RhcnRzd2l0aCgidHJ1XyIpIGFuZCBjYWxsLmRhdGEgIT0gInRydV9raGFjIikKZGVmIHRydV9zZWxlY3RfYW1vdW50KGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkIG5vdCBpbiBBRE1JTjoKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgYW1vdW50ID0gaW50KGNhbGwuZGF0YS5zcGxpdCgiXyIpWzFdKQogICAgZXhjZXB0OgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAiU+G7kSB0aeG7gW4ga2jDtG5nIGjhu6NwIGzhu4cuIikKICAgICAgICByZXR1cm4KCiAgICBhZG1pbl90cnVfYW1vdW50W2NhbGwuZnJvbV91c2VyLmlkXSA9IGFtb3VudAogICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGYiQuG6oW4gxJHDoyBjaOG7jW4gdHLhu6sge2Ftb3VudDosfSB4dS4gVnVpIGzDsm5nIGfhu61pIElEIG5nxrDhu51pIGTDuW5nIMSR4buDIHRy4burIHRp4buBbjoiKQogICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKGNhbGwubWVzc2FnZS5jaGF0LmlkLCByZWNlaXZlX3VzZXJfaWRfZm9yX3RydSwgY2FsbC5mcm9tX3VzZXIuaWQpCgpkZWYgcmVjZWl2ZV91c2VyX2lkX2Zvcl90cnUobXNnLCBhZG1pbl9pZCk6CiAgICBpZiBtc2cuZnJvbV91c2VyLmlkICE9IDgyMDU1Njc4NTE6CiAgICAgICAgcmV0dXJuCgogICAgdXNlcl9pZF90ZXh0ID0gbXNnLnRleHQuc3RyaXAoKQogICAgdHJ5OgogICAgICAgIHVzZXJfaWRfdG9fdHJ1ID0gaW50KHVzZXJfaWRfdGV4dCkKICAgIGV4Y2VwdDoKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIklEIGtow7RuZyBo4bujcCBs4buHLCB2dWkgbMOybmcgZ+G7rWkgbOG6oWkgSUQgaOG7o3AgbOG7hzoiKQogICAgICAgIGJvdDEucmVnaXN0ZXJfbmV4dF9zdGVwX2hhbmRsZXIobXNnLCByZWNlaXZlX3VzZXJfaWRfZm9yX3RydSwgYWRtaW5faWQpCiAgICAgICAgcmV0dXJuCgogICAgaWYgYWRtaW5faWQgbm90IGluIGFkbWluX3RydV9hbW91bnQ6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobXNnLmNoYXQuaWQsICJM4buXaToga2jDtG5nIHTDrG0gdGjhuqV5IHPhu5EgdGnhu4FuIMSRw6MgY2jhu41uLiBWdWkgbMOybmcgY2jhu41uIGzhuqFpIHPhu5EgdGnhu4FuLiIpCiAgICAgICAgcmV0dXJuCgogICAgYW1vdW50X3RvX3RydSA9IGFkbWluX3RydV9hbW91bnRbYWRtaW5faWRdCgogICAgaWYgYW1vdW50X3RvX3RydSA8IDEgb3IgYW1vdW50X3RvX3RydSA+IDFfMDAwXzAwMF8wMDBfMDAwXzAwMDoKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIlPhu5EgeHUgdHLhu6sgbmdvw6BpIGdp4bubaSBo4bqhbi4iKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b190cnUpCiAgICAgICAgZnVsbG5hbWUgPSB1c2VyX2luZm8uZmlyc3RfbmFtZSBvciAiIgogICAgICAgIGlmIHVzZXJfaW5mby5sYXN0X25hbWU6CiAgICAgICAgICAgIGZ1bGxuYW1lICs9IGYiIHt1c2VyX2luZm8ubGFzdF9uYW1lfSIKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIktow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyBuw6B5LiIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEtow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZF90b190cnV9OiB7ZX0iKQogICAgICAgIHJldHVybgoKICAgIGN1cnJlbnRfYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWRfdG9fdHJ1KQogICAgaWYgY3VycmVudF9iYWxhbmNlIDwgYW1vdW50X3RvX3RydToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIlPhu5EgZMawIGtow7RuZyDEkeG7pyDEkeG7gyB0cuG7qyEiKQogICAgICAgIHJldHVybgoKICAgIG5ld19iYWxhbmNlID0gY3VycmVudF9iYWxhbmNlIC0gYW1vdW50X3RvX3RydQogICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZF90b190cnUsIG5ld19iYWxhbmNlKQoKICAgIGFkbWluX21lc3NhZ2UgPSAoCiAgICAgICAgZiLinIUgxJDDoyB0cuG7qyB0aMOgbmggY8O0bmdcbiIKICAgICAgICBmIvCfkaQgTmfGsOG7nWkgZMO5bmc6IHtmdWxsbmFtZX1cbiIKICAgICAgICBmIvCfhpQgSUQ6IHt1c2VyX2lkX3RvX3RydX1cbiIKICAgICAgICBmIvCfkrAgU+G7kSB4dSBi4buLIHRy4burOiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX3RydSl9IHh1XG4iCiAgICAgICAgZiLwn5K1IFPhu5EgeHUgbeG7m2k6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1XG4iCiAgICAgICAgZiLij7MgVGjhu51pIGdpYW46IHt0aW1lLnN0cmZ0aW1lKCclSDolTTolUyAlZC8lbS8lWScsIHRpbWUubG9jYWx0aW1lKCkpfSIKICAgICkKCiAgICBib3QxLnNlbmRfbWVzc2FnZShtc2cuY2hhdC5pZCwgIsSQw6MgdHLhu6sgdGnhu4FuIHRow6BuaCBjw7RuZyEiKQogICAgZm9yIGFkbWluX2lkXyBpbiBBRE1JTjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGFkbWluX2lkXywgYWRtaW5fbWVzc2FnZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgZ+G7rWkgxJHGsOG7o2MgdGluIG5o4bqvbiDEkeG6v24gYWRtaW4ge2FkbWluX2lkX306IHtlfSIpCgogICAgZGVsIGFkbWluX3RydV9hbW91bnRbYWRtaW5faWRdCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAidG9uZ3RoYW5nIikKZGVmIHRvbmd0aGFuZyhjYWxsKToKICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICBpZiBjYWxsLmZyb21fdXNlci5pZCBub3QgaW4gQURNSU46CiAgICAgICAgcmV0dXJuCiAgICB0cnk6CiAgICAgICAgY2hhdF9pZCA9IGNhbGwubWVzc2FnZS5jaGF0LmlkCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKCJGSUxFL3RoYW5ndGh1YS50eHQiKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdG9wX3RoYW5nID0gW10KICAgICAgICB3aXRoIG9wZW4oIkZJTEUvdGhhbmd0aHVhLnR4dCIsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGxpbmUgaW4gZjoKICAgICAgICAgICAgICAgIHBhcnRzID0gbGluZS5zdHJpcCgpLnNwbGl0KCkKICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMzoKICAgICAgICAgICAgICAgICAgICB1c2VyX2lkLCB0aGFuZywgXyA9IHBhcnRzCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICB0aGFuZyA9IGludCh0aGFuZykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGhhbmcgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wX3RoYW5nLmFwcGVuZCgodXNlcl9pZCwgdGhhbmcpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICBpZiBub3QgdG9wX3RoYW5nOgogICAgICAgICAgICByZXR1cm4KICAgICAgICB0b3BfdGhhbmcuc29ydChrZXk9bGFtYmRhIHg6IHhbMV0sIHJldmVyc2U9VHJ1ZSkKICAgICAgICBtZXNzYWdlID0gIjxiPlRvcCB0aOG6r25nIGjDtG0gbmF5OjwvYj5cbiIKICAgICAgICBmb3IgaSwgKHVzZXJfaWQsIGFtb3VudCkgaW4gZW51bWVyYXRlKHRvcF90aGFuZ1s6MjBdLCBzdGFydD0xKToKICAgICAgICAgICAgbWVzc2FnZSArPSBmIntpfS4gPGNvZGU+e3VzZXJfaWR9PC9jb2RlPjoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudCl9XG4iCiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoY2hhdF9pZCwgbWVzc2FnZSwgcGFyc2VfbW9kZT0iSFRNTCIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIHRoYW5naG9tbmF5OiB7ZX0iKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRvbmd0aHVhIikKZGVmIHRvbmd0aHVhKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGlmIGNhbGwuZnJvbV91c2VyLmlkIG5vdCBpbiBBRE1JTjoKICAgICAgICByZXR1cm4KICAgIHRyeToKICAgICAgICBjaGF0X2lkID0gY2FsbC5tZXNzYWdlLmNoYXQuaWQKICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMoIkZJTEUvdGhhbmd0aHVhLnR4dCIpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICB0b3BfdGh1YSA9IFtdCiAgICAgICAgd2l0aCBvcGVuKCJGSUxFL3RoYW5ndGh1YS50eHQiLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGZvciBsaW5lIGluIGY6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDM6CiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCwgXywgdGh1YSA9IHBhcnRzCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICB0aHVhID0gaW50KHRodWEpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRodWEgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wX3RodWEuYXBwZW5kKCh1c2VyX2lkLCB0aHVhKSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgaWYgbm90IHRvcF90aHVhOgogICAgICAgICAgICByZXR1cm4KICAgICAgICB0b3BfdGh1YS5zb3J0KGtleT1sYW1iZGEgeDogeFsxXSwgcmV2ZXJzZT1UcnVlKQogICAgICAgIG1lc3NhZ2UgPSAiPGI+VG9wIHRodWEgaMO0bSBuYXk6PC9iPlxuIgogICAgICAgIGZvciBpLCAodXNlcl9pZCwgYW1vdW50KSBpbiBlbnVtZXJhdGUodG9wX3RodWFbOjIwXSwgc3RhcnQ9MSk6CiAgICAgICAgICAgIG1lc3NhZ2UgKz0gZiJ7aX0uIDxjb2RlPnt1c2VyX2lkfTwvY29kZT46IHtmb3JtYXRfYmFsYW5jZShhbW91bnQpfVxuIgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNoYXRfaWQsIG1lc3NhZ2UsIHBhcnNlX21vZGU9IkhUTUwiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSB0aHVhaG9tbmF5OiB7ZX0iKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gImRvaXNvbW9tbyIpCmRlZiBoYW5kbGVfZG9pc29tb21vKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAi8J+SrCBWdWkgbMOybmcgbmjhuq1wIHPhu5EgTU9NTyBj4bqnbiDEkeG7lWkga8OobSBo4buNIHTDqm46XG5Ww60gZOG7pTpcbjxiPjAxMjM0NTY3ODkgTkdVWUVOIFZBTiBBPC9iPiIsIHBhcnNlX21vZGU9IkhUTUwiKQogICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKGNhbGwubWVzc2FnZS5jaGF0LmlkLCByZWNlaXZlX21vbW9faW5mbykKCmRlZiByZWNlaXZlX21vbW9faW5mbyhtZXNzYWdlKToKICAgIHRyeToKICAgICAgICBwYXJ0cyA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KG1heHNwbGl0PTEpCiAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDI6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBudW1iZXIsIG5hbWUgPSBwYXJ0c1swXSwgcGFydHNbMV0KCiAgICAgICAgaWYgbm90IG51bWJlci5pc2RpZ2l0KCkgb3IgbGVuKG51bWJlcikgIT0gMTAgb3Igbm90IG51bWJlci5zdGFydHN3aXRoKCIwIik6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBsZW4obmFtZS5zdHJpcCgpLnNwbGl0KCkpIDwgMjoKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIGZpbGVfcGF0aCA9ICJGSUxFL21tLnR4dCIKCiAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUobnVtYmVyKQogICAgICAgICAgICBzdGF0dXMgPSAi4pyFIMSQw6MgZ2hpIHPhu5EgTU9NTyBt4bubaSBs4bqnbiDEkeG6p3U6ICIgKyBudW1iZXIKICAgICAgICBlbHNlOgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKG51bWJlcikKICAgICAgICAgICAgc3RhdHVzID0gIuKchSDEkMOjIHRoYXkgxJHhu5VpIHPhu5EgTU9NTyB0aMOgbmg6ICIgKyBudW1iZXIKCiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBzdGF0dXMpCgogICAgICAgICMgR+G7rWkgdsOgIGdoaW0gdsOgbyBuaMOzbQogICAgICAgIHRyeToKICAgICAgICAgICAgZ3JvdXBfaWQgPSAtMTAwMzU4OTk0MjI4NwogICAgICAgICAgICBvdGhlcl90b2tlbiA9ICI4NDkzNzAzMjk3OkFBSFNmOHdUeGlwbjdURVRQMUI5WVNXcWFSNjBHbEpzVkhjIgoKICAgICAgICAgICAgc2VuZF91cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfdG9rZW59L3NlbmRNZXNzYWdlIgogICAgICAgICAgICBtZXNzYWdlX3RleHQgPSBmIjxiPsSQw6MgdGhheSDEkeG7lWkgc+G7kSBNT01PIMSR4buDIG7huqFwIHRp4buBbiB7bnVtYmVyfSB7bmFtZX0gbeG7jWkgbmfGsOG7nWkgY2jDuiDDvSBraGkgbuG6oXA8L2I+IgoKICAgICAgICAgICAgc2VuZF9yZXNwb25zZSA9IHJlcXVlc3RzLnBvc3Qoc2VuZF91cmwsIGpzb249ewogICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICJ0ZXh0IjogbWVzc2FnZV90ZXh0LAogICAgICAgICAgICAgICAgInBhcnNlX21vZGUiOiAiSFRNTCIKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIGlmIHNlbmRfcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgbXNnX2lkID0gc2VuZF9yZXNwb25zZS5qc29uKClbInJlc3VsdCJdWyJtZXNzYWdlX2lkIl0KCiAgICAgICAgICAgICAgICAjIEdoaW0gdGluIG5o4bqvbgogICAgICAgICAgICAgICAgcGluX3VybCA9IGYiaHR0cHM6Ly9hcGkudGVsZWdyYW0ub3JnL2JvdHtvdGhlcl90b2tlbn0vcGluQ2hhdE1lc3NhZ2UiCiAgICAgICAgICAgICAgICByZXF1ZXN0cy5wb3N0KHBpbl91cmwsIGpzb249ewogICAgICAgICAgICAgICAgICAgICJjaGF0X2lkIjogZ3JvdXBfaWQsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2VfaWQiOiBtc2dfaWQsCiAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfbm90aWZpY2F0aW9uIjogRmFsc2UgICMgVHJ1ZSBu4bq/dSBraMO0bmcgbXXhu5FuIGLDoW8gxJHhu5luZwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBH4butaSBuaMOzbSB0aOG6pXQgYuG6oWk6IHtzZW5kX3Jlc3BvbnNlLnRleHR9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSBob+G6t2MgZ2hpbSB2w6BvIG5ow7NtOiB7ZX0iKQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsIGYi4pqg77iPIEzhu5dpIHjhu60gbMO9OiB7c3RyKGUpfSIpCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSA9PSAiZG9pc29iYW5rIikKZGVmIGhhbmRsZV9kb2lzb2JrKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAi8J+SrCBWdWkgbMOybmcgbmjhuq1wIHRow7RuZyB0aW4gbmfDom4gaMOgbmcgdGhlbyDEkeG7i25oIGThuqFuZzpcbjxiPk1CQiAwODA4MjA4ODg4OCBOR1VZRU4gRElOSCBESUVOPC9iPiIsIHBhcnNlX21vZGU9IkhUTUwiKQogICAgYm90MS5yZWdpc3Rlcl9uZXh0X3N0ZXBfaGFuZGxlcl9ieV9jaGF0X2lkKGNhbGwubWVzc2FnZS5jaGF0LmlkLCByZWNlaXZlX2JhbmtfaW5mbykKCmRlZiByZWNlaXZlX2JhbmtfaW5mbyhtZXNzYWdlKToKICAgIHRyeToKICAgICAgICBwYXJ0cyA9IG1lc3NhZ2UudGV4dC5zdHJpcCgpLnNwbGl0KG1heHNwbGl0PTIpCiAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDM6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBiYW5rX2NvZGUsIGFjY19udW1iZXIsIGZ1bGxfbmFtZSA9IHBhcnRzCgogICAgICAgIGlmIG5vdCBiYW5rX2NvZGUuaXNhbHBoYSgpIG9yIGxlbihiYW5rX2NvZGUpICE9IDM6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBub3QgYWNjX251bWJlci5pc2RpZ2l0KCkgb3Igbm90ICg5IDw9IGxlbihhY2NfbnVtYmVyKSA8PSAxNCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiBsZW4oZnVsbF9uYW1lLnN0cmlwKCkuc3BsaXQoKSkgPCAyOgogICAgICAgICAgICByZXR1cm4KCiAgICAgICAgYmFua19jb2RlID0gYmFua19jb2RlLnVwcGVyKCkKICAgICAgICBhY2NfbnVtYmVyID0gYWNjX251bWJlci5zdHJpcCgpCiAgICAgICAgZnVsbF9uYW1lID0gZnVsbF9uYW1lLnVwcGVyKCkKCiAgICAgICAgZm9ybWF0dGVkX2xpbmUgPSBmIntiYW5rX2NvZGV9IDsge2FjY19udW1iZXJ9IDsge2Z1bGxfbmFtZX0iCiAgICAgICAgZmlsZV9wYXRoID0gIkZJTEUvYmsudHh0IgoKICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoZm9ybWF0dGVkX2xpbmUpCgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKG1lc3NhZ2UuY2hhdC5pZCwgZiLinIUgxJDDoyB0aGF5IMSR4buVaSBz4buRIHTDoGkga2hv4bqjbiBuZ8OibiBow6BuZzpcbntmb3JtYXR0ZWRfbGluZX0iKQoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGdyb3VwX2lkID0gLTEwMDM1ODk5NDIyODcKICAgICAgICAgICAgb3RoZXJfdG9rZW4gPSAiODQ5MzcwMzI5NzpBQUhTZjh3VHhpcG43VEVUUDFCOVlTV3FhUjYwR2xKc1ZIYyIKCiAgICAgICAgICAgIHNlbmRfdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e290aGVyX3Rva2VufS9zZW5kTWVzc2FnZSIKCiAgICAgICAgICAgIGNsZWFuX2xpbmUgPSBmb3JtYXR0ZWRfbGluZS5yZXBsYWNlKCI7IiwgIiIpLnN0cmlwKCkKCiAgICAgICAgICAgIG1lc3NhZ2VfdGV4dCA9ICgKICAgICAgICAgICAgICAgIGYiPGI+xJDDoyB0aGF5IMSR4buVaSBz4buRIEJBTksgxJHhu4MgbuG6oXAgdGnhu4FuIHtjbGVhbl9saW5lfSAiCiAgICAgICAgICAgICAgICBmIm3hu41pIG5nxrDhu51pIGNow7ogw70ga2hpIG7huqFwPC9iPiIKICAgICAgICAgICAgKQoKICAgICAgICAgICAgc2VuZF9yZXNwb25zZSA9IHJlcXVlc3RzLnBvc3Qoc2VuZF91cmwsIGpzb249ewogICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICJ0ZXh0IjogbWVzc2FnZV90ZXh0LAogICAgICAgICAgICAgICAgInBhcnNlX21vZGUiOiAiSFRNTCIKICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIGlmIHNlbmRfcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgbXNnX2lkID0gc2VuZF9yZXNwb25zZS5qc29uKClbInJlc3VsdCJdWyJtZXNzYWdlX2lkIl0KCiAgICAgICAgICAgICAgICBwaW5fdXJsID0gZiJodHRwczovL2FwaS50ZWxlZ3JhbS5vcmcvYm90e290aGVyX3Rva2VufS9waW5DaGF0TWVzc2FnZSIKICAgICAgICAgICAgICAgIHJlcXVlc3RzLnBvc3QocGluX3VybCwganNvbj17CiAgICAgICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICAgICAibWVzc2FnZV9pZCI6IG1zZ19pZCwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZV9ub3RpZmljYXRpb24iOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBH4butaSBuaMOzbSB0aOG6pXQgYuG6oWk6IHtzZW5kX3Jlc3BvbnNlLnRleHR9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBn4butaSBob+G6t2MgZ2hpbSBuaMOzbToge2V9IikKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKaoO+4jyBM4buXaSB44butIGzDvToge3N0cihlKX0iKQoKZGVmIHNldF9maWxlX3N0YXR1c19sYXRlcihmaWxlX3BhdGgsIG1pbnV0ZXMpOgogICAgZGVmIHVwZGF0ZV9maWxlKCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKCJGQUxTRSIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBGaWxlIHtmaWxlX3BhdGh9IMSRw6MgxJHhu5VpIHRow6BuaCBGQUxTRSBzYXUge21pbnV0ZXN9IHBow7p0LiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gR2hpIEZBTFNFIHRo4bqldCBi4bqhaToge2V9IikKCiAgICB0aW1lciA9IHRocmVhZGluZy5UaW1lcihtaW51dGVzICogNjAsIHVwZGF0ZV9maWxlKQogICAgdGltZXIuc3RhcnQoKQoKZGVmIGdldF92aWV0bmFtX3RpbWVfc3RyKCk6CiAgICBub3cgPSBkYXRldGltZS5ub3cocHl0ei50aW1lem9uZSgiQXNpYS9Ib19DaGlfTWluaCIpKQogICAgcmV0dXJuIG5vdy5zdHJmdGltZSgiJUg6JU06JVMgJWQvJW0vJVkiKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgaW4gWyJodWJvbnVzIiwgInNpZXVodWJvbnVzIl0pCmRlZiBoYW5kbGVfaHVib251c19idXR0b25zKGNhbGwpOgogICAgYm90MS5hbnN3ZXJfY2FsbGJhY2tfcXVlcnkoY2FsbC5pZCkKCiAgICBncm91cF9pZCA9IC0xMDAzNTg5OTQyMjg3CiAgICBvdGhlcl90b2tlbiA9ICI4MjM0NTU3MjQ2OkFBSHRpNEtrTG1hNDVXZDc3eTZZV2pWb0NKT2RrNzUxZGlFIgoKICAgIGlmIGNhbGwuZGF0YSA9PSAiaHVib251cyI6CiAgICAgICAgbWVzc2FnZV90ZXh0ID0gIvCflKUgSMWoIEJPTlVTIDEwMC4wMDAgxJDDgyBYVeG6pFQgSEnhu4ZOLCA5MCBQSMOaVCBTxIJOIEjFqCBC4bquVCDEkOG6plUg8J+UpSIKICAgICAgICBmaWxlX3BhdGggPSAiRklMRS9odWJvbnVzLnR4dCIKICAgICAgICBtaW51dGVzID0gOTAKICAgIGVsc2U6CiAgICAgICAgbWVzc2FnZV90ZXh0ID0gIvCflKUgSMWoIEJPTlVTIFBSTyBNQVggMjAwLjAwMCDEkMODIFhV4bqkVCBISeG7hk4sIDYwIFBIw5pUIFPEgk4gSMWoIELhuq5UIMSQ4bqmVSDwn5SlIgogICAgICAgIGZpbGVfcGF0aCA9ICJGSUxFL3NpZXVodWJvbnVzLnR4dCIKICAgICAgICBtaW51dGVzID0gNjAKCiAgICB0cnk6CiAgICAgICAgc2VuZF91cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfdG9rZW59L3NlbmRNZXNzYWdlIgogICAgICAgIHNlbmRfcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHNlbmRfdXJsLCBqc29uPXsKICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgInRleHQiOiBmIjxiPnttZXNzYWdlX3RleHR9PC9iPiIsCiAgICAgICAgICAgICJwYXJzZV9tb2RlIjogIkhUTUwiCiAgICAgICAgfSkKCiAgICAgICAgaWYgc2VuZF9yZXNwb25zZS5zdGF0dXNfY29kZSA9PSAyMDA6CiAgICAgICAgICAgIG1zZ19pZCA9IHNlbmRfcmVzcG9uc2UuanNvbigpWyJyZXN1bHQiXVsibWVzc2FnZV9pZCJdCiAgICAgICAgICAgIHBpbl91cmwgPSBmImh0dHBzOi8vYXBpLnRlbGVncmFtLm9yZy9ib3R7b3RoZXJfdG9rZW59L3BpbkNoYXRNZXNzYWdlIgogICAgICAgICAgICByZXF1ZXN0cy5wb3N0KHBpbl91cmwsIGpzb249ewogICAgICAgICAgICAgICAgImNoYXRfaWQiOiBncm91cF9pZCwKICAgICAgICAgICAgICAgICJtZXNzYWdlX2lkIjogbXNnX2lkLAogICAgICAgICAgICAgICAgImRpc2FibGVfbm90aWZpY2F0aW9uIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gR+G7rWkgaG/hurdjIGdoaW0gdGluIG5o4bqvbiB0aOG6pXQgYuG6oWk6IHtlfSIpCgogICAgdHJ5OgogICAgICAgIHZpZXRuYW1fdGltZSA9IGdldF92aWV0bmFtX3RpbWVfc3RyKCkKICAgICAgICBzdGF0dXNfbGluZSA9IGYiVFJVRSB8IHt2aWV0bmFtX3RpbWV9IgogICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShzdGF0dXNfbGluZSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludChmIltERUJVR10gR2hpIGZpbGUgbOG7l2k6IHtlfSIpCgogICAgYm90MS5zZW5kX21lc3NhZ2UoY2FsbC5tZXNzYWdlLmNoYXQuaWQsIGYi4pyFIMSQw6Mga8OtY2ggaG/huqF0OiB7Y2FsbC5kYXRhLnVwcGVyKCl9IikKCmltcG9ydCBvcwppbXBvcnQgdGltZQppbXBvcnQgdGhyZWFkaW5nCmZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lCmltcG9ydCBweXR6CgpkZWYgYXV0b19yZXNldF9odV9zdGF0dXMoKToKICAgIGRlZiBsb29wX2NoZWNrKCk6CiAgICAgICAgdHogPSBweXR6LnRpbWV6b25lKCJBc2lhL0hvX0NoaV9NaW5oIikKCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgbm93ID0gZGF0ZXRpbWUubm93KHR6KQoKICAgICAgICAgICAgZmlsZV9jb25maWdzID0gWwogICAgICAgICAgICAgICAgKCJGSUxFL2h1Ym9udXMudHh0IiwgOTApLAogICAgICAgICAgICAgICAgKCJGSUxFL3NpZXVodWJvbnVzLnR4dCIsIDYwKQogICAgICAgICAgICBdCgogICAgICAgICAgICBmb3IgZmlsZV9wYXRoLCBsaW1pdF9taW51dGVzIGluIGZpbGVfY29uZmlnczoKICAgICAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhmaWxlX3BhdGgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGYucmVhZCgpLnN0cmlwKCkKCiAgICAgICAgICAgICAgICAgICAgaWYgY29udGVudC5zdGFydHN3aXRoKCJUUlVFIik6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVFJVRXxISDpNTTpTUyBkZC9tbS9ZWVlZCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGNvbnRlbnQuc3BsaXQoInwiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA8IDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lX3N0ciA9IHBhcnRzWzFdLnN0cmlwKCkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIHBhcnNlIHRpbWUgKG5haXZlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRfdGltZV9uYWl2ZSA9IGRhdGV0aW1lLnN0cnB0aW1lKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVfc3RyLCAiJUg6JU06JVMgJWQvJW0vJVkiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBGSVg6IGfhuq9uIHRpbWV6b25lIGNobyBzdGFydF90aW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydF90aW1lID0gdHoubG9jYWxpemUoc3RhcnRfdGltZV9uYWl2ZSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGFwc2VkID0gbm93IC0gc3RhcnRfdGltZQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGVsYXBzZWQudG90YWxfc2Vjb25kcygpID49IGxpbWl0X21pbnV0ZXMgKiA2MDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUoIkZBTFNFIikKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJpbnQoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiW0FVVE8tUkVTRVRdIOKchSB7ZmlsZV9wYXRofSDEkcOjIHThu7EgY2h1eeG7g24gduG7gSBGQUxTRSBzYXUge2xpbWl0X21pbnV0ZXN9IHBow7p0LiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIltBVVRPLVJFU0VUXSDinYwgS2jDtG5nIMSR4buNYyDEkcaw4bujYyB0aOG7nWkgZ2lhbiB0cm9uZyB7ZmlsZV9wYXRofToge2V9IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQoKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBwcmludChmIltBVVRPLVJFU0VUXSDinYwgTOG7l2kgxJHhu41jIGZpbGUge2ZpbGVfcGF0aH06IHtlfSIpCgogICAgICAgICAgICB0aW1lLnNsZWVwKDEpCgogICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9bG9vcF9jaGVjaywgZGFlbW9uPVRydWUpLnN0YXJ0KCkKCkBib3QxLmNhbGxiYWNrX3F1ZXJ5X2hhbmRsZXIoZnVuYz1sYW1iZGEgY2FsbDogY2FsbC5kYXRhID09ICJnaWZ0YWRtaW4iKQpkZWYgZ2lmdGFkbWluX2hhbmRsZXIoY2FsbCk6CiAgICBhZG1pbl9pZCA9IGNhbGwuZnJvbV91c2VyLmlkCiAgICBpZiBhZG1pbl9pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIGJvdDEuYW5zd2VyX2NhbGxiYWNrX3F1ZXJ5KGNhbGwuaWQpCiAgICAgICAgcmV0dXJuCgogICAgbXNnID0gYm90MS5zZW5kX21lc3NhZ2UoCiAgICAgICAgY2FsbC5tZXNzYWdlLmNoYXQuaWQsCiAgICAgICAgIk5o4bqtcCBz4buRIGzGsOG7o25nIGNvZGUgdsOgIHPhu5EgdGnhu4FuIG3hu5dpIGNvZGUgKFZEOiAzIDUwMDAwKToiCiAgICApCiAgICBib3QxLnJlZ2lzdGVyX25leHRfc3RlcF9oYW5kbGVyKG1zZywgcHJvY2Vzc19naWZ0YWRtaW5faW5wdXQpCgpkZWYgcHJvY2Vzc19naWZ0YWRtaW5faW5wdXQobWVzc2FnZSk6CiAgICBhZG1pbl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBpZiBhZG1pbl9pZCAhPSA4MjA1NTY3ODUxOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnN0cmlwKCkuc3BsaXQoKQogICAgICAgIGlmIGxlbihhcmdzKSAhPSAyOgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJTYWkgxJHhu4tuaCBk4bqhbmcuIFbDrSBk4bulOiBgMyA1MDAwMGAiLCBwYXJzZV9tb2RlPSJNYXJrZG93biIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBxdWFudGl0eSA9IGludChhcmdzWzBdKQogICAgICAgIGFtb3VudF9wZXJfZ2lmdGNvZGUgPSBpbnQoYXJnc1sxXSkKCiAgICAgICAgaWYgcXVhbnRpdHkgPCAxIG9yIGFtb3VudF9wZXJfZ2lmdGNvZGUgPCAxMDAwOgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICJT4buRIGzGsOG7o25nIHThu5FpIHRoaeG7g3UgMSB2w6AgbeG7h25oIGdpw6EgdOG7kWkgdGhp4buDdSAxLjAwMCIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBnaWZ0Y29kZXMgPSBbZ2VuZXJhdGVfZ2lmdGNvZGUocHJlZml4PSJBRE1JTi0iKSBmb3IgXyBpbiByYW5nZShxdWFudGl0eSldCiAgICAgICAgZ2lmdGNvZGVzX3RleHQgPSAiXG4iLmpvaW4oCiAgICAgICAgICAgIFtmImAvZ2lmdCB7Y29kZX1gIHRy4buLIGdpw6E6IHtmb3JtYXRfYmFsYW5jZShhbW91bnRfcGVyX2dpZnRjb2RlKX0geHUiIGZvciBjb2RlIGluIGdpZnRjb2Rlc10KICAgICAgICApCgogICAgICAgIG5vdyA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyAlZC8lbS8lWSIpCgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cygiRklMRSIpOgogICAgICAgICAgICBvcy5tYWtlZGlycygiRklMRSIpCgogICAgICAgIHdpdGggb3BlbigiRklMRS9naWZ0LnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZm9yIGNvZGUgaW4gZ2lmdGNvZGVzOgogICAgICAgICAgICAgICAgZi53cml0ZShmIntjb2RlfSB8IHthbW91bnRfcGVyX2dpZnRjb2RlfSB8IHtub3d9IHwgMVxuIikKCiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIG1lc3NhZ2UuY2hhdC5pZCwKICAgICAgICAgICAgZiLEkMOjIHThuqFvIHtxdWFudGl0eX0gbcOjIGdpZnRjb2RlIEFETUlOOlxuXG57Z2lmdGNvZGVzX3RleHR9IiwKICAgICAgICAgICAgcGFyc2VfbW9kZT0iTWFya2Rvd24iCiAgICAgICAgKQoKICAgICAgICBwcmludChmIltERUJVR10gQWRtaW4ge2FkbWluX2lkfSDEkcOjIHThuqFvIHtxdWFudGl0eX0gbcOjIGdpZnRjb2RlIEFETUlOIHbDoCBsxrB1IHbDoG8gRklMRS9naWZ0LnR4dCIpCgogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCAiU2FpIMSR4buLbmggZOG6oW5nLiBWw60gZOG7pTogYDMgNTAwMDBgIiwgcGFyc2VfbW9kZT0iTWFya2Rvd24iKQoKZGVmIGdlbmVyYXRlX2dpZnRjb2RlKHByZWZpeD0iIiwgbGVuZ3RoPTE0KToKICAgICIiIlThuqFvIGdpZnRjb2RlIHbhu5tpIHByZWZpeCB0w7l5IGNo4buNbiIiIgogICAgY29kZSA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX3VwcGVyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9bGVuZ3RoKSkKICAgIHJldHVybiBmIntwcmVmaXh9e2NvZGV9IgoKZGVmIGZvcm1hdF9iYWxhbmNlKGFtb3VudCk6CiAgICByZXR1cm4gZiJ7YW1vdW50Oix9Ii5yZXBsYWNlKCIsIiwgIi4iKQoKQGJvdDEuY2FsbGJhY2tfcXVlcnlfaGFuZGxlcihmdW5jPWxhbWJkYSBjYWxsOiBjYWxsLmRhdGEgPT0gInRhbnRodSIpCmRlZiB0YW50aHUoY2FsbCk6CiAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgaWYgY2FsbC5mcm9tX3VzZXIuaWQgbm90IGluIEFETUlOOgogICAgICAgIHJldHVybgogICAga2V5Ym9hcmQgPSB0eXBlcy5JbmxpbmVLZXlib2FyZE1hcmt1cChyb3dfd2lkdGg9MikKICAgIGJ0bl90b3BuZ2F5ID0gdHlwZXMuSW5saW5lS2V5Ym9hcmRCdXR0b24oIlRow6ptIiwgY2FsbGJhY2tfZGF0YT0idGhlbXRhbnRodSIpCiAgICBidG5fdG9wdHVhbiA9IHR5cGVzLklubGluZUtleWJvYXJkQnV0dG9uKCJHaeG6o20iLCBjYWxsYmFja19kYXRhPSJnaWFtdGFudGh1IikKICAgIGtleWJvYXJkLmFkZChidG5fdG9wbmdheSwgYnRuX3RvcHR1YW4pCiAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIkFkbWluIHZ1aSBsw7JuZyBjaOG7jW4gbG/huqFpIHTDom4gdGjhu6c6IiwgcmVwbHlfbWFya3VwPWtleWJvYXJkKQoKCgpAYm90MS5jYWxsYmFja19xdWVyeV9oYW5kbGVyKGZ1bmM9bGFtYmRhIGNhbGw6IGNhbGwuZGF0YSBpbiBbInRoZW10YW50aHUiLCAiZ2lhbXRhbnRodSJdKQpkZWYgY29uZ3RydXRhbnRodShjYWxsKToKICAgIGRlZiByZWFkX3RhbnRodSgpOgogICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhUQU5USFVfRklMRSk6CiAgICAgICAgICAgIHJldHVybiAwCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4oVEFOVEhVX0ZJTEUsICdyJykgYXMgZjoKICAgICAgICAgICAgICAgIHJldHVybiBpbnQoZi5yZWFkKCkuc3RyaXAoKSkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHJldHVybiAwCgogICAgZGVmIHdyaXRlX3RhbnRodSh2YWx1ZSk6CiAgICAgICAgd2l0aCBvcGVuKFRBTlRIVV9GSUxFLCAndycpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoc3RyKHZhbHVlKSkKCiAgICBib3QxLmFuc3dlcl9jYWxsYmFja19xdWVyeShjYWxsLmlkKQogICAgdXNlcl9pZCA9IGNhbGwuZnJvbV91c2VyLmlkCgogICAgaWYgdXNlcl9pZCBub3QgaW4gQURNSU46CiAgICAgICAgcmV0dXJuCgogICAgYWN0aW9uID0gImFkZCIgaWYgY2FsbC5kYXRhID09ICJ0aGVtdGFudGh1IiBlbHNlICJzdWIiCiAgICBwZW5kaW5nX2FjdGlvblt1c2VyX2lkXSA9IGFjdGlvbgoKICAgIGlmIGFjdGlvbiA9PSAiYWRkIjoKICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShjYWxsLm1lc3NhZ2UuY2hhdC5pZCwgIvCfk6UgQuG6oW4gdnVpIGzDsm5nIG5o4bqtcCAqKnPhu5EgbMaw4bujbmcgY+G6p24gdMSDbmcqKiB0w6JuIHRo4bunOiIpCiAgICBlbHNlOgogICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGNhbGwubWVzc2FnZS5jaGF0LmlkLCAi8J+TpCBC4bqhbiB2dWkgbMOybmcgbmjhuq1wICoqc+G7kSBsxrDhu6NuZyBj4bqnbiBnaeG6o20qKiB0w6JuIHRo4bunOiIpCgogICAgQGJvdDEubWVzc2FnZV9oYW5kbGVyKGZ1bmM9bGFtYmRhIG1lc3NhZ2U6IG1lc3NhZ2UuZnJvbV91c2VyLmlkIGluIHBlbmRpbmdfYWN0aW9uKQogICAgZGVmIHByb2Nlc3NfYW1vdW50KG1lc3NhZ2UpOgogICAgICAgIHRyeToKICAgICAgICAgICAgYW1vdW50ID0gaW50KG1lc3NhZ2UudGV4dC5zdHJpcCgpKQogICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShtZXNzYWdlLmNoYXQuaWQsICLimqDvuI8gVnVpIGzDsm5nIG5o4bqtcCBt4buZdCAqKnPhu5Egbmd1ecOqbioqLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBjdXJyZW50ID0gcmVhZF90YW50aHUoKQogICAgICAgIGFjdGlvbiA9IHBlbmRpbmdfYWN0aW9uLnBvcChtZXNzYWdlLmZyb21fdXNlci5pZCkKCiAgICAgICAgaWYgYWN0aW9uID09ICJhZGQiOgogICAgICAgICAgICBjdXJyZW50ICs9IGFtb3VudAogICAgICAgICAgICB3cml0ZV90YW50aHUoY3VycmVudCkKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKchSDEkMOjIHTEg25nOiB7YW1vdW50fVxu8J+TpiBUw6JuIHRo4bunIGhp4buHbiB04bqhaToge2N1cnJlbnR9IikKICAgICAgICBlbGlmIGFjdGlvbiA9PSAic3ViIjoKICAgICAgICAgICAgY3VycmVudCA9IG1heCgwLCBjdXJyZW50IC0gYW1vdW50KQogICAgICAgICAgICB3cml0ZV90YW50aHUoY3VycmVudCkKICAgICAgICAgICAgYm90MS5zZW5kX21lc3NhZ2UobWVzc2FnZS5jaGF0LmlkLCBmIuKchSDEkMOjIHRy4burOiB7YW1vdW50fVxu8J+TpiBUw6JuIHRo4bunIGhp4buHbiB04bqhaToge2N1cnJlbnR9IikKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBib29sKHJlLnNlYXJjaChyJyg/aSlcYmNvbmdcYicsIG1lc3NhZ2UudGV4dCkpKQpkZWYgQ09ORyhtZXNzYWdlKToKICAgIGNvbW1hbmRfcGFydHMgPSBtZXNzYWdlLnRleHQuc3RyaXAoKS5zcGxpdCgpCiAgICBzZW5kZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHtzZW5kZXJfaWR9IGfhu61pIGzhu4duaDoge21lc3NhZ2UudGV4dH0iKQogICAgaWYgc2VuZGVyX2lkIG5vdCBpbiBBRE1JTjoKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3NlbmRlcl9pZH0ga2jDtG5nIHBo4bqjaSBhZG1pbi4iKQogICAgICAgIHJldHVybgogICAgaWYgbGVuKGNvbW1hbmRfcGFydHMpICE9IDM6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu4duaCBraMO0bmcgxJHDum5nIMSR4buLbmggZOG6oW5nLiBE4bqhbmcgxJHDum5nOiBjb25nIDx1c2VyX2lkPiA8c+G7kV94dT4iKQogICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIHVzZXJfaWRfdG9fY29uZyA9IGludChjb21tYW5kX3BhcnRzWzFdKQogICAgICAgIGFtb3VudF90b19jb25nID0gaW50KGNvbW1hbmRfcGFydHNbMl0pCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEPhu5luZyB7YW1vdW50X3RvX2Nvbmd9IHh1IGNobyB1c2VyIHt1c2VyX2lkX3RvX2Nvbmd9IikKCiAgICAgICAgaWYgYW1vdW50X3RvX2NvbmcgPD0gMCBvciBhbW91bnRfdG9fY29uZyA+IDFfMDAwXzAwMF8wMDBfMDAwXzAwMDoKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIFPhu5EgeHUgdsaw4bujdCBnaeG7m2kgaOG6oW4gY2hvIHBow6lwLiIpCiAgICAgICAgICAgIHJldHVybgogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpOiB1c2VyX2lkIGhv4bq3YyBz4buRIHh1IGtow7RuZyBwaOG6o2kgc+G7kSBuZ3V5w6puLiIpCiAgICAgICAgcmV0dXJuCiAgICB0cnk6CiAgICAgICAgdXNlcl9pbmZvID0gYm90LmdldF9jaGF0KHVzZXJfaWRfdG9fY29uZykKICAgICAgICBmdWxsbmFtZSA9IHVzZXJfaW5mby5maXJzdF9uYW1lIG9yICIiCiAgICAgICAgaWYgdXNlcl9pbmZvLmxhc3RfbmFtZToKICAgICAgICAgICAgZnVsbG5hbWUgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgbOG6pXkgdGjDtG5nIHRpbiB1c2VyIHt1c2VyX2lkX3RvX2Nvbmd9OiB7ZX0iKQogICAgICAgIHJldHVybgogICAgdHJ5OgogICAgICAgIGN1cnJlbnRfYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWRfdG9fY29uZykKICAgICAgICBuZXdfYmFsYW5jZSA9IGN1cnJlbnRfYmFsYW5jZSArIGFtb3VudF90b19jb25nCiAgICAgICAgdXBkYXRlX3ZpY2hpbmgodXNlcl9pZF90b19jb25nLCBuZXdfYmFsYW5jZSkKICAgICAgICBwcmludChmIltERUJVR10gU+G7kSBkxrAgbeG7m2k6IHtuZXdfYmFsYW5jZX0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgY+G6rXAgbmjhuq10IHPhu5EgZMawOiB7ZX0iKQogICAgICAgIHJldHVybgogICAgYWRtaW5fbWVzc2FnZSA9ICgKICAgICAgICBmIuKchSDEkMOjIGPhu5luZyB0aeG7gW4gdGjDoG5oIGPDtG5nXG4iCiAgICAgICAgZiLwn5GkIE5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWV9XG4iCiAgICAgICAgZiLwn4aUIElEOiB7dXNlcl9pZF90b19jb25nfVxuIgogICAgICAgIGYi8J+SsCBT4buRIHh1IMSRxrDhu6NjIGPhu5luZzoge2Zvcm1hdF9iYWxhbmNlKGFtb3VudF90b19jb25nKX0geHVcbiIKICAgICAgICBmIvCfkrUgU+G7kSB4dSBt4bubaToge2Zvcm1hdF9iYWxhbmNlKG5ld19iYWxhbmNlKX0geHVcbiIKICAgICAgICBmIuKPsyBUaOG7nWkgZ2lhbjoge3RpbWUuc3RyZnRpbWUoJyVIOiVNOiVTICVkLyVtLyVZJywgdGltZS5sb2NhbHRpbWUoKSl9IikKICAgIGZvciBhZG1pbl9pZCBpbiBBRE1JTjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJvdDEuc2VuZF9tZXNzYWdlKGFkbWluX2lkLCBhZG1pbl9tZXNzYWdlKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBn4butaSB0aMO0bmcgYsOhbyBjaG8gYWRtaW4ge2FkbWluX2lkfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIGfhu61pIMSRxrDhu6NjIHRpbiBuaOG6r24gxJHhur9uIGFkbWluIHthZG1pbl9pZH06IHtlfSIpCgoKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihmdW5jPWxhbWJkYSBtZXNzYWdlOiBib29sKHJlLnNlYXJjaChyJyg/aSlcYnRydVxiJywgbWVzc2FnZS50ZXh0KSkpCmRlZiBUUlUobWVzc2FnZSk6CiAgICBjb21tYW5kX3BhcnRzID0gbWVzc2FnZS50ZXh0LnNwbGl0KCkKICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7bWVzc2FnZS5mcm9tX3VzZXIuaWR9IGfhu61pIGzhu4duaDoge21lc3NhZ2UudGV4dH0iKQoKICAgIGlmIGxlbihjb21tYW5kX3BhcnRzKSAhPSAzOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buHbmgga2jDtG5nIGjhu6NwIGzhu4csIHRoaeG6v3UgdGhhbSBz4buRLiIpCiAgICAgICAgcmV0dXJuCgogICAgaWYgbWVzc2FnZS5mcm9tX3VzZXIuaWQgbm90IGluIEFETUlOOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7bWVzc2FnZS5mcm9tX3VzZXIuaWR9IGtow7RuZyBwaOG6o2kgbMOgIGFkbWluLiIpCiAgICAgICAgcmV0dXJuIE5vbmUKCiAgICB0cnk6CiAgICAgICAgdXNlcl9pZF90b190cnUgPSBpbnQoY29tbWFuZF9wYXJ0c1sxXSkKICAgICAgICBhbW91bnRfdG9fdHJ1ID0gaW50KGNvbW1hbmRfcGFydHNbMl0pCiAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX3RydX0gecOqdSBj4bqndSB0cuG7qyB7YW1vdW50X3RvX3RydX0geHUuIikKCiAgICAgICAgaWYgYW1vdW50X3RvX3RydSA8IDEgb3IgYW1vdW50X3RvX3RydSA+IDEwMDAwMDAwMDAwMDAwMDA6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBT4buRIHh1IHRy4burIG5nb8OgaSBnaeG7m2kgaOG6oW4uIikKICAgICAgICAgICAgcmV0dXJuCgogICAgZXhjZXB0IChWYWx1ZUVycm9yLCBJbmRleEVycm9yKToKICAgICAgICBwcmludChmIltERUJVR10gTOG7l2kga2hpIGNodXnhu4NuIMSR4buVaSBnacOhIHRy4buLIGzhu4duaC4iKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB1c2VyX2luZm8gPSBib3QuZ2V0X2NoYXQodXNlcl9pZF90b190cnUpCiAgICAgICAgZnVsbG5hbWVfdG9fdHJ1ID0gdXNlcl9pbmZvLmZpcnN0X25hbWUKICAgICAgICBpZiB1c2VyX2luZm8ubGFzdF9uYW1lOgogICAgICAgICAgICBmdWxsbmFtZV90b190cnUgKz0gZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IgogICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIG5nxrDhu51pIGTDuW5nOiB7ZnVsbG5hbWVfdG9fdHJ1fSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYm90MS5yZXBseV90byhtZXNzYWdlLCAiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIG7DoHkuIikKICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IG5nxrDhu51pIGTDuW5nIHt1c2VyX2lkX3RvX3RydX0uIEzhu5dpOiB7ZX0iKQogICAgICAgIHJldHVybgoKICAgIGN1cnJlbnRfYmFsYW5jZSA9IGdldF9iYWxhbmNlKHVzZXJfaWRfdG9fdHJ1KQogICAgcHJpbnQoZiJbREVCVUddIFPhu5EgZMawIGhp4buHbiB04bqhaSBj4bunYSBuZ8aw4budaSBkw7luZyB7dXNlcl9pZF90b190cnV9OiB7Y3VycmVudF9iYWxhbmNlfSIpCgogICAgaWYgY3VycmVudF9iYWxhbmNlIDwgYW1vdW50X3RvX3RydToKICAgICAgICBib3QxLnJlcGx5X3RvKG1lc3NhZ2UsICJT4buRIHRp4buBbiBraMO0bmcgxJHhu6cgxJHhu4MgdHLhu6shIikKICAgICAgICBwcmludChmIltERUJVR10gU+G7kSB0aeG7gW4ga2jDtG5nIMSR4bunIMSR4buDIHRy4burLiIpCiAgICAgICAgcmV0dXJuCgogICAgbmV3X2JhbGFuY2UgPSBjdXJyZW50X2JhbGFuY2UgLSBhbW91bnRfdG9fdHJ1CiAgICB1cGRhdGVfdmljaGluaCh1c2VyX2lkX3RvX3RydSwgbmV3X2JhbGFuY2UpCgogICAgYWRtaW5fbWVzc2FnZSA9ICgKICAgICAgICBmIuKchSDEkMOjIHRy4burIHRow6BuaCBjw7RuZ1xuIgogICAgICAgIGYi8J+RpCBOZ8aw4budaSBkw7luZzoge2Z1bGxuYW1lX3RvX3RydX1cbiIKICAgICAgICBmIvCfhpQgSUQ6IHt1c2VyX2lkX3RvX3RydX1cbiIKICAgICAgICBmIvCfkrAgU+G7kSB4dSBi4buLIHRy4burOiB7Zm9ybWF0X2JhbGFuY2UoYW1vdW50X3RvX3RydSl9IHh1XG4iCiAgICAgICAgZiLwn5K1IFPhu5EgeHUgbeG7m2k6IHtmb3JtYXRfYmFsYW5jZShuZXdfYmFsYW5jZSl9IHh1XG4iCiAgICAgICAgZiLij7MgVGjhu51pIGdpYW46IHt0aW1lLnN0cmZ0aW1lKCclSDolTTolUyAlZC8lbS8lWScsIHRpbWUubG9jYWx0aW1lKCkpfSIKICAgICkKCiAgICBmb3IgYWRtaW5faWQgaW4gQURNSU46CiAgICAgICAgdHJ5OgogICAgICAgICAgICBib3QxLnNlbmRfbWVzc2FnZShhZG1pbl9pZCwgYWRtaW5fbWVzc2FnZSkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8gdHLhu6sgeHUgY2hvIGFkbWluIHthZG1pbl9pZH0uIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdGjhu4MgZ+G7rWkgdGluIG5o4bqvbiDEkeG6v24gYWRtaW4ge2FkbWluX2lkfToge2V9IikKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ2JhbiddKQpkZWYgYmFuKG1lc3NhZ2UpOgogICAgdXNlcl9pZCA9IG1lc3NhZ2UuZnJvbV91c2VyLmlkCiAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGfhu61pIGzhu4duaDoge21lc3NhZ2UudGV4dH0iKQoKICAgIGlmIHVzZXJfaWQgbm90IGluIEFETUlOOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dXNlcl9pZH0ga2jDtG5nIHBo4bqjaSBsw6AgYWRtaW4uIikKICAgICAgICByZXR1cm4KCiAgICBhcmdzID0gbWVzc2FnZS50ZXh0LnNwbGl0KClbMTpdCiAgICBpZiBsZW4oYXJncykgPCAxOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buHbmggdGhp4bq/dSB0aGFtIHPhu5EuIikKICAgICAgICByZXR1cm4KCiAgICB0cnk6CiAgICAgICAgdGFyZ2V0X3VzZXJfaWQgPSBpbnQoYXJnc1swXSkKICAgICAgICByZWFzb24gPSAiICIuam9pbihhcmdzWzE6XSkuc3RyaXAoKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dGFyZ2V0X3VzZXJfaWR9IHnDqnUgY+G6p3UgY+G6pW0uIEzDvSBkbzoge3JlYXNvbn0iKQoKICAgICAgICByZWFzb25fbWFya2Rvd24gPSBmIvCfl5IgTMO9IGRvOiAqKntyZWFzb259KioiIGlmIHJlYXNvbiBlbHNlICIiCiAgICAgICAgcmVhc29uX2h0bWwgPSBmIkzDvSBkbzogPGI+e3JlYXNvbn08L2I+IiBpZiByZWFzb24gZWxzZSAiTMO9IGRvOiIKCiAgICAgICAgaWYgY2hlY2tfYmFuKHRhcmdldF91c2VyX2lkKToKICAgICAgICAgICAgYm90MS5yZXBseV90byhtZXNzYWdlLCAiTmfGsOG7nWkgZMO5bmcgxJHDoyBi4buLIGPhuqVtIHRyxrDhu5tjIMSRw7MuIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt0YXJnZXRfdXNlcl9pZH0gxJHDoyBi4buLIGPhuqVtLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJfaW5mbyA9IGJvdC5nZXRfY2hhdCh0YXJnZXRfdXNlcl9pZCkKICAgICAgICAgICAgdGFyZ2V0X2Z1bGxuYW1lID0gdXNlcl9pbmZvLmZpcnN0X25hbWUgKyAoZiIge3VzZXJfaW5mby5sYXN0X25hbWV9IiBpZiB1c2VyX2luZm8ubGFzdF9uYW1lIGVsc2UgIiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIG5nxrDhu51pIGTDuW5nIGPhuqduIGPhuqVtOiB7dGFyZ2V0X2Z1bGxuYW1lfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgdGFyZ2V0X2Z1bGxuYW1lID0gIktow7RuZyB4w6FjIMSR4buLbmgiCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBLaMO0bmcgdMOsbSB0aOG6pXkgdGjDtG5nIHRpbiBuZ8aw4budaSBkw7luZyB7dGFyZ2V0X3VzZXJfaWR9LiIpCgogICAgICAgIHRyeToKICAgICAgICAgICAgYWRtaW5faW5mbyA9IGJvdC5nZXRfY2hhdCh1c2VyX2lkKQogICAgICAgICAgICBhZG1pbl9uYW1lID0gYWRtaW5faW5mby5maXJzdF9uYW1lICsgKGYiIHthZG1pbl9pbmZvLmxhc3RfbmFtZX0iIGlmIGFkbWluX2luZm8ubGFzdF9uYW1lIGVsc2UgIiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIGFkbWluOiB7YWRtaW5fbmFtZX0iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGFkbWluX25hbWUgPSAiICAiCgogICAgICAgIGJhbl91c2VyKHRhcmdldF91c2VyX2lkLCByZWFzb24pCgogICAgICAgIGJvdDEucmVwbHlfdG8oCiAgICAgICAgICAgIG1lc3NhZ2UsCiAgICAgICAgICAgIGYi4pyFIMSQw6MgY+G6pW0gdGjDoG5oIGPDtG5nXG4iCiAgICAgICAgICAgIGYi8J+RpCBOZ8aw4budaSBkw7luZzogW3t0YXJnZXRfZnVsbG5hbWV9XSh0ZzovL3VzZXI/aWQ9e3RhcmdldF91c2VyX2lkfSlcbiIKICAgICAgICAgICAgZiLwn4aUIElEOiBge3RhcmdldF91c2VyX2lkfWBcbiIKICAgICAgICAgICAgZiJ7cmVhc29uX21hcmtkb3dufSIsCiAgICAgICAgICAgIHBhcnNlX21vZGU9Ik1hcmtkb3duIgogICAgICAgICkKCiAgICAgICAgYm90LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD10YXJnZXRfdXNlcl9pZCwKICAgICAgICAgICAgdGV4dD1mIlTDoGkga2hv4bqjbiBj4bunYSBi4bqhbiDEkcOjIGLhu4sga2jDs2EuXG4iCiAgICAgICAgICAgICAgICAgZiJ7cmVhc29uX21hcmtkb3dufVxuIgogICAgICAgICAgICAgICAgIGYi8J+RpCBBRE1JTjogW3thZG1pbl9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyX2lkfSkiLAogICAgICAgICAgICBwYXJzZV9tb2RlPSJNYXJrZG93biIKICAgICAgICApCgogICAgICAgIHRlbGVib3QuVGVsZUJvdCgiODIzNDU1NzI0NjpBQUh0aTRLa0xtYTQ1V2Q3N3k2WVdqVm9DSk9kazc1MWRpRSIpLnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgY2hhdF9pZD0tMTAwMzU4OTk0MjI4NywKICAgICAgICAgICAgdGV4dD1mIktow7NhIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJfaWR9IHRyw6puIHRvw6BuIHNlcnZlclxue3JlYXNvbl9odG1sfSIsCiAgICAgICAgICAgIHBhcnNlX21vZGU9IkhUTUwiCiAgICAgICAgKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIGtow7NhIHTDoGkga2hv4bqjbiBjaG8gbmjDs20uIikKCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBib3QxLnJlcGx5X3RvKG1lc3NhZ2UsICJJRCBuZ8aw4budaSBkw7luZyBraMO0bmcgaOG7o3AgbOG7hy4iKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBJRCBuZ8aw4budaSBkw7luZyBraMO0bmcgaOG7o3AgbOG7hy4iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGJvdDEucmVwbHlfdG8obWVzc2FnZSwgZiJM4buXaToge3N0cihlKX0iKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkgdGjhu7FjIHRoaSBs4buHbmggY+G6pW06IHtzdHIoZSl9IikKCkBib3QxLm1lc3NhZ2VfaGFuZGxlcihjb21tYW5kcz1bJ3VuYmFuJ10pCmRlZiB1bmJhbihtZXNzYWdlKToKICAgIHVzZXJfaWQgPSBtZXNzYWdlLmZyb21fdXNlci5pZAogICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt1c2VyX2lkfSBn4butaSBs4buHbmg6IHttZXNzYWdlLnRleHR9IikKCiAgICBpZiB1c2VyX2lkIG5vdCBpbiBBRE1JTjoKICAgICAgICBwcmludChmIltERUJVR10gTmfGsOG7nWkgZMO5bmcge3VzZXJfaWR9IGtow7RuZyBwaOG6o2kgbMOgIGFkbWluLiIpCiAgICAgICAgcmV0dXJuCgogICAgYXJncyA9IG1lc3NhZ2UudGV4dC5zcGxpdCgpWzE6XQogICAgaWYgbGVuKGFyZ3MpICE9IDE6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu4duaCB0aGnhur91IHRoYW0gc+G7kS4iKQogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICB0YXJnZXRfdXNlcl9pZCA9IGludChhcmdzWzBdKQogICAgICAgIHByaW50KGYiW0RFQlVHXSBOZ8aw4budaSBkw7luZyB7dGFyZ2V0X3VzZXJfaWR9IHnDqnUgY+G6p3UgbeG7nyBj4bqlbS4iKQoKICAgICAgICBpZiBub3QgY2hlY2tfYmFuKHRhcmdldF91c2VyX2lkKToKICAgICAgICAgICAgYm90MS5yZXBseV90byhtZXNzYWdlLCAiTmfGsOG7nWkgZMO5bmcga2jDtG5nIGLhu4sgY+G6pW0uIikKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIE5nxrDhu51pIGTDuW5nIHt0YXJnZXRfdXNlcl9pZH0ga2jDtG5nIGLhu4sgY+G6pW0uIikKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlciA9IGJvdC5nZXRfY2hhdCh0YXJnZXRfdXNlcl9pZCkKICAgICAgICAgICAgdGFyZ2V0X2Z1bGxuYW1lID0gdXNlci5maXJzdF9uYW1lICsgKGYiIHt1c2VyLmxhc3RfbmFtZX0iIGlmIHVzZXIubGFzdF9uYW1lIGVsc2UgIiIpCiAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBUaMO0bmcgdGluIG5nxrDhu51pIGTDuW5nIGPhuqduIG3hu58gY+G6pW06IHt0YXJnZXRfZnVsbG5hbWV9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICB0YXJnZXRfZnVsbG5hbWUgPSAiIgogICAgICAgICAgICBwcmludChmIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IHRow7RuZyB0aW4gbmfGsOG7nWkgZMO5bmcge3RhcmdldF91c2VyX2lkfS4iKQoKICAgICAgICB1bmJhbl91c2VyKHRhcmdldF91c2VyX2lkKQogICAgICAgIGFkbWluX25hbWUgPSBtZXNzYWdlLmZyb21fdXNlci5maXJzdF9uYW1lICsgKGYiIHttZXNzYWdlLmZyb21fdXNlci5sYXN0X25hbWV9IiBpZiBtZXNzYWdlLmZyb21fdXNlci5sYXN0X25hbWUgZWxzZSAiIikKCiAgICAgICAgYm90MS5yZXBseV90bygKICAgICAgICAgICAgbWVzc2FnZSwKICAgICAgICAgICAgZiLinIUgxJDDoyBt4bufIGPhuqVtIHRow6BuaCBjw7RuZ1xuIgogICAgICAgICAgICBmIvCfkaQgTmfGsOG7nWkgZMO5bmc6IFt7dGFyZ2V0X2Z1bGxuYW1lfV0odGc6Ly91c2VyP2lkPXt0YXJnZXRfdXNlcl9pZH0pXG4iCiAgICAgICAgICAgIGYi8J+GlCBJRDogYHt0YXJnZXRfdXNlcl9pZH1gIiwKICAgICAgICAgICAgcGFyc2VfbW9kZT0iTWFya2Rvd24iCiAgICAgICAgKQoKICAgICAgICBib3Quc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBjaGF0X2lkPXRhcmdldF91c2VyX2lkLAogICAgICAgICAgICB0ZXh0PWYiVMOgaSBraG/huqNuIGPhu6dhIGLhuqFuIMSRw6MgxJHGsOG7o2MgbeG7nyBraMOzYS5cbiIKICAgICAgICAgICAgICAgICBmIvCfkaQgQURNSU46IFt7YWRtaW5fbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlcl9pZH0pIiwKICAgICAgICAgICAgcGFyc2VfbW9kZT0iTWFya2Rvd24iCiAgICAgICAgKQogICAgICAgIHByaW50KGYiW0RFQlVHXSDEkMOjIGfhu61pIHRow7RuZyBiw6FvIG3hu58gY+G6pW0gY2hvIG5nxrDhu51pIGTDuW5nIHt0YXJnZXRfdXNlcl9pZH0uIikKCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICBib3QxLnJlcGx5X3RvKG1lc3NhZ2UsICJJRCBuZ8aw4budaSBkw7luZyBraMO0bmcgaOG7o3AgbOG7hy4gVnVpIGzDsm5nIG5o4bqtcCBt4buZdCBz4buRLiIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIElEIG5nxrDhu51pIGTDuW5nIGtow7RuZyBo4bujcCBs4buHLiIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgYm90MS5yZXBseV90byhtZXNzYWdlLCBmIktow7RuZyB0aOG7gyBt4bufIGPhuqVtIG5nxrDhu51pIGTDuW5nOiB7c3RyKGUpfSIpCiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIGtoaSB0aOG7sWMgdGhpIGzhu4duaCBt4bufIGPhuqVtOiB7c3RyKGUpfSIpCgoKCmRlZiBzYXZlX21lc3NhZ2VfdG9fZmlsZShtZXNzYWdlKToKICAgIHRyeToKICAgICAgICBsb2dfbGluZSA9IGYiW3tnZXRfdmlldG5hbV90aW1lX3N0cigpfV0ge21lc3NhZ2UuY2hhdC5pZH0gfCB7bWVzc2FnZS5tZXNzYWdlX2lkfSB8IHttZXNzYWdlLmZyb21fdXNlci5pZH0gfCB7bWVzc2FnZS50ZXh0fVxuIgogICAgICAgIHdpdGggb3BlbigibWVzc2FnZWlkLnR4dCIsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShsb2dfbGluZSkKICAgICAgICBwcmludChmIltTQVZFXSDEkMOjIGzGsHUgbWVzc2FnZSBJRCB7bWVzc2FnZS5tZXNzYWdlX2lkfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbRVJST1JdIEtow7RuZyB0aOG7gyBsxrB1IG1lc3NhZ2U6IHtlfSIpCgpkZWYgc2NoZWR1bGVfdGFza3MoKToKICAgIHdoaWxlIFRydWU6CiAgICAgICAgdmlldG5hbV90eiA9IHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKQogICAgICAgIG5vdyA9IGRhdGV0aW1lLm5vdyh2aWV0bmFtX3R6KQogICAgICAgIGRlbGV0ZV9kYXkoKQogICAgICAgIGRlbGV0ZV93ZWVrKCkKICAgICAgICB0aW1lLnNsZWVwKDEpCgpkZWYgZGVsZXRlX2RheSgpOgogICAgZ2xvYmFsIGxhc3RfcmVzZXRfZGF5CiAgICB2aWV0bmFtX3R6ID0gcHl0ei50aW1lem9uZSgnQXNpYS9Ib19DaGlfTWluaCcpCiAgICBub3cgPSBkYXRldGltZS5ub3codmlldG5hbV90eikKICAgIHllc3RlcmRheSA9IG5vdyAtIHRpbWVkZWx0YShkYXlzPTEpCiAgICBhcmNoaXZlX2RhdGVfc3RyID0geWVzdGVyZGF5LnN0cmZ0aW1lKCIlZCVtJVkiKQogICAgYXJjaGl2ZV9maWxlbmFtZSA9IGYiRklMRS97YXJjaGl2ZV9kYXRlX3N0cn0udHh0IgogICAgdG9kYXlfc3RyID0gbm93LnN0cmZ0aW1lKCIlWS0lbS0lZCIpCgogICAgaWYgbm93LmhvdXIgPT0gMCBhbmQgbm93Lm1pbnV0ZSA9PSAwOgogICAgICAgIGlmIGxhc3RfcmVzZXRfZGF5ID09IHRvZGF5X3N0cjoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgbGFzdF9yZXNldF9kYXkgPSB0b2RheV9zdHIKICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIMSR4bq/biB0aOG7nWkgZ2lhbiByZXNldCB0b3BjdW9jbmdheSAoMDA6MDApLiIpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0b3BfZmlsZSA9ICJGSUxFL3RvcGN1b2MudHh0IgogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHModG9wX2ZpbGUpOgogICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgJ3RvcGN1b2MudHh0Jy4iKQogICAgICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICAgICB3aXRoIG9wZW4odG9wX2ZpbGUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDhu41jIHtsZW4obGluZXMpfSBkw7JuZyB04burIGZpbGUgJ3RvcGN1b2MudHh0Jy4iKQoKICAgICAgICAgICAgYXJjaGl2ZWRfZGF0YSA9IHt9CiAgICAgICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKGFyY2hpdmVfZmlsZW5hbWUpOgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGFyY2hpdmVfZmlsZW5hbWUsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBmOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVpZCA9IHBhcnRzWzBdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gaW50KHBhcnRzWzFdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyY2hpdmVkX2RhdGFbdWlkXSA9IHZhbAoKICAgICAgICAgICAgbmV3X3RvcGN1b2NfbGluZXMgPSBbXQogICAgICAgICAgICBuZXdfYXJjaGl2ZV9saW5lcyA9IFtdCiAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAzOgogICAgICAgICAgICAgICAgICAgIHVzZXJfaWQgPSBwYXJ0c1swXQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdG9wY3VvY25nYXkgPSBpbnQocGFydHNbMV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgICAgICB0b3BjdW9jbmdheSA9IDAKICAgICAgICAgICAgICAgICAgICB0b3BjdW9jdHVhbiA9IHBhcnRzWzJdCiAgICAgICAgICAgICAgICAgICAgdG90YWxfdmFsID0gYXJjaGl2ZWRfZGF0YS5nZXQodXNlcl9pZCwgMCkgKyB0b3BjdW9jbmdheQogICAgICAgICAgICAgICAgICAgIGFyY2hpdmVkX2RhdGFbdXNlcl9pZF0gPSB0b3RhbF92YWwKICAgICAgICAgICAgICAgICAgICBuZXdfYXJjaGl2ZV9saW5lcy5hcHBlbmQoZiJ7dXNlcl9pZH0ge3RvdGFsX3ZhbH1cbiIpCiAgICAgICAgICAgICAgICAgICAgbmV3X3RvcGN1b2NfbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IDAge3RvcGN1b2N0dWFufVxuIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIELhu48gcXVhIGTDsm5nIGtow7RuZyBo4bujcCBs4buHOiB7bGluZS5zdHJpcCgpfSIpCgogICAgICAgICAgICB3aXRoIG9wZW4oYXJjaGl2ZV9maWxlbmFtZSwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKG5ld19hcmNoaXZlX2xpbmVzKQogICAgICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBsxrB1IGThu68gbGnhu4d1IHRvcGN1b2NuZ2F5IHNhbmcgZmlsZSAne2FyY2hpdmVfZmlsZW5hbWV9Jy4iKQoKICAgICAgICAgICAgd2l0aCBvcGVuKHRvcF9maWxlLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlbGluZXMobmV3X3RvcGN1b2NfbGluZXMpCiAgICAgICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgcmVzZXQgdG9wY3VvY25nYXkgduG7gSAwIGNobyB04bqldCBj4bqjIG5nxrDhu51pIGTDuW5nLiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgdHJvbmcgZGVsZXRlX2RheSgpOiB7ZX0iKQoKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgIyDinIUgUkVTRVQgaG9hX2hvbmdfaG9tX25heSB24buBIDAKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgaG9haG9uZ19wYXRoID0gb3MucGF0aC5qb2luKCJGSUxFIiwgInRvbmdob2Fob25nLnR4dCIpCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoaG9haG9uZ19wYXRoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGhvYWhvbmdfcGF0aCwgInIiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQoKICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMgPSBbXQogICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBsaW5lLnN0cmlwKCkuc3BsaXQoKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwYXJ0cykgPT0gMzoKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IHBhcnRzWzBdCiAgICAgICAgICAgICAgICAgICAgICAgIGhvbV9uYXkgPSBwYXJ0c1sxXQogICAgICAgICAgICAgICAgICAgICAgICB0dWFuX25heSA9IHBhcnRzWzJdCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IDAge3R1YW5fbmF5fVxuIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIltERUJVR10gQuG7jyBxdWEgZMOybmcga2jDtG5nIGjhu6NwIGzhu4cgdHJvbmcgdG9uZ2hvYWhvbmcudHh0OiB7bGluZS5zdHJpcCgpfSIpCgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKGhvYWhvbmdfcGF0aCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyh1cGRhdGVkX2xpbmVzKQogICAgICAgICAgICAgICAgcHJpbnQoIltERUJVR10gxJDDoyByZXNldCBob2FfaG9uZ19ob21fbmF5IHbhu4EgMC4iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIHJlc2V0IGhvYV9ob25nX2hvbV9uYXk6IHtlfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgcHJpbnQoIltERUJVR10gS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgJ3Rvbmdob2Fob25nLnR4dCcuIikKCmRlZiBkZWxldGVfd2VlaygpOgogICAgZ2xvYmFsIGxhc3RfcmVzZXRfd2VlawogICAgdmlldG5hbV90eiA9IHB5dHoudGltZXpvbmUoJ0FzaWEvSG9fQ2hpX01pbmgnKQogICAgbm93ID0gZGF0ZXRpbWUubm93KHZpZXRuYW1fdHopCiAgICBpc29feWVhciwgaXNvX3dlZWssIGlzb193ZWVrZGF5ID0gbm93Lmlzb2NhbGVuZGFyKCkKICAgIGN1cnJlbnRfd2Vla19pZCA9IGYie2lzb195ZWFyfS17aXNvX3dlZWt9IgoKICAgIGlmIG5vdy53ZWVrZGF5KCkgPT0gMCBhbmQgbm93LmhvdXIgPT0gMCBhbmQgbm93Lm1pbnV0ZSA9PSAwOgogICAgICAgIGlmIGxhc3RfcmVzZXRfd2VlayA9PSBjdXJyZW50X3dlZWtfaWQ6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGxhc3RfcmVzZXRfd2VlayA9IGN1cnJlbnRfd2Vla19pZAogICAgICAgIHByaW50KCJbREVCVUddIMSQw6MgxJHhur9uIHRo4budaSBnaWFuIHJlc2V0IHRvcGN1b2N0dWFuICgwMDowMCBUaOG7qSBIYWkpLiIpCgogICAgICAgIHRyeToKICAgICAgICAgICAgZmlsZXBhdGggPSAiRklMRS90b3BjdW9jLnR4dCIKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGZpbGVwYXRoKToKICAgICAgICAgICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlICd0b3BjdW9jLnR4dCcuIikKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgaWYgaXNvX3dlZWsgPT0gMToKICAgICAgICAgICAgICAgIHByZXZfd2VlayA9IDUyCiAgICAgICAgICAgICAgICBwcmV2X3llYXIgPSBpc29feWVhciAtIDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByZXZfd2VlayA9IGlzb193ZWVrIC0gMQogICAgICAgICAgICAgICAgcHJldl95ZWFyID0gaXNvX3llYXIKCiAgICAgICAgICAgIGJhY2t1cF9maWxlbmFtZSA9IGYiRklMRS90dWFue3ByZXZfeWVhcn0te3ByZXZfd2Vla30udHh0IgogICAgICAgICAgICBzaHV0aWwuY29weWZpbGUoZmlsZXBhdGgsIGJhY2t1cF9maWxlbmFtZSkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQw6Mgc2FvIGzGsHUgZOG7ryBsaeG7h3UgdHXhuqduIHRyxrDhu5tjIHbDoG8ge2JhY2t1cF9maWxlbmFtZX0iKQoKICAgICAgICAgICAgd2l0aCBvcGVuKGZpbGVwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIMSQ4buNYyB7bGVuKGxpbmVzKX0gZMOybmcgdOG7qyB0b3BjdW9jLnR4dCIpCgogICAgICAgICAgICB1cGRhdGVkX2xpbmVzID0gW10KICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICBpZiBsZW4ocGFydHMpID09IDM6CiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IHBhcnRzWzBdCiAgICAgICAgICAgICAgICAgICAgdG9wY3VvY25nYXkgPSBwYXJ0c1sxXQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHt0b3BjdW9jbmdheX0gMFxuIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJbREVCVUddIELhu48gcXVhIGTDsm5nIGzhu5dpOiB7bGluZS5zdHJpcCgpfSIpCgogICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGVsaW5lcyh1cGRhdGVkX2xpbmVzKQogICAgICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIHJlc2V0IHRvcGN1b2N0dWFuIHbhu4EgMCB0aMOgbmggY8O0bmcuIikKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kgdHJvbmcgZGVsZXRlX3dlZWsoKToge2V9IikKCiAgICAgICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgICMg4pyFIFJFU0VUIGhvYV9ob25nX3R1YW5fbmF5IHbhu4EgMAogICAgICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICBob2Fob25nX3BhdGggPSBvcy5wYXRoLmpvaW4oIkZJTEUiLCAidG9uZ2hvYWhvbmcudHh0IikKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhob2Fob25nX3BhdGgpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oaG9haG9uZ19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCgogICAgICAgICAgICAgICAgdXBkYXRlZF9saW5lcyA9IFtdCiAgICAgICAgICAgICAgICBmb3IgbGluZSBpbiBsaW5lczoKICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3RyaXAoKS5zcGxpdCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA9PSAzOgogICAgICAgICAgICAgICAgICAgICAgICB1c2VyX2lkID0gcGFydHNbMF0KICAgICAgICAgICAgICAgICAgICAgICAgaG9tX25heSA9IHBhcnRzWzFdCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfbGluZXMuYXBwZW5kKGYie3VzZXJfaWR9IHtob21fbmF5fSAwXG4iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByaW50KGYiW0RFQlVHXSBC4buPIHF1YSBkw7JuZyBraMO0bmcgaOG7o3AgbOG7hyB0cm9uZyB0b25naG9haG9uZy50eHQ6IHtsaW5lLnN0cmlwKCl9IikKCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oaG9haG9uZ19wYXRoLCAidyIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgZi53cml0ZWxpbmVzKHVwZGF0ZWRfbGluZXMpCiAgICAgICAgICAgICAgICBwcmludCgiW0RFQlVHXSDEkMOjIHJlc2V0IGhvYV9ob25nX3R1YW5fbmF5IHbhu4EgMC4iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBwcmludChmIltFUlJPUl0gTOG7l2kga2hpIHJlc2V0IGhvYV9ob25nX3R1YW5fbmF5OiB7ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHByaW50KCJbREVCVUddIEtow7RuZyB0w6xtIHRo4bqleSBmaWxlICd0b25naG9haG9uZy50eHQnLiIpCgpkZWYgbHV1dmF4b2F0bihtZXNzYWdlKToKICAgIHRyeToKICAgICAgICBvcy5tYWtlZGlycygiRklMRSIsIGV4aXN0X29rPVRydWUpCiAgICAgICAgZmlsZV9wYXRoID0gIkZJTEUvbWVzc2FnZWlkLnR4dCIKCiAgICAgICAgdGltZXN0YW1wID0gZGF0ZXRpbWUubm93KHB5dHoudGltZXpvbmUoIkFzaWEvSG9fQ2hpX01pbmgiKSkuc3RyZnRpbWUoIiVIOiVNOiVTICVkLyVtLyVZIikKICAgICAgICB1c2VyX2lkID0gbWVzc2FnZS5mcm9tX3VzZXIuaWQKICAgICAgICBtZXNzYWdlX2lkID0gbWVzc2FnZS5tZXNzYWdlX2lkCiAgICAgICAgY2hhdF9pZCA9IG1lc3NhZ2UuY2hhdC5pZAogICAgICAgIHRleHQgPSBtZXNzYWdlLnRleHQgb3IgIiIKCiAgICAgICAgbG9nX2xpbmUgPSBmInt0aW1lc3RhbXB9IHwge2NoYXRfaWR9IHttZXNzYWdlX2lkfSB7dXNlcl9pZH0ge3RleHQuc3RyaXAoKX1cbiIKCiAgICAgICAgd2l0aCBvcGVuKGZpbGVfcGF0aCwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGxvZ19saW5lKQoKICAgICAgICBwcmludChmIltERUJVR10gxJDDoyBsxrB1IHRpbiBuaOG6r24gdOG6oWkgbWVzc2FnZV9pZCB7bWVzc2FnZV9pZH0iKQoKICAgICAgICBkZWYgZGVsYXllZF9kZWxldGUoKToKICAgICAgICAgICAgdGltZS5zbGVlcCgxMjApCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGJvdC5kZWxldGVfbWVzc2FnZShjaGF0X2lkLCBtZXNzYWdlX2lkKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbQVVUTyBERUxFVEVdIMSQw6MgeG/DoSBtZXNzYWdlX2lkIHttZXNzYWdlX2lkfSBj4bunYSB1c2VyIHt1c2VyX2lkfSIpCgogICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZmlsZV9wYXRoKToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICAgICAgICAgIHdpdGggb3BlbihmaWxlX3BhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGxpbmUgaW4gbGluZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBmIntjaGF0X2lkfSB7bWVzc2FnZV9pZH0iIG5vdCBpbiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYud3JpdGUobGluZSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbQVVUTyBERUxFVEVdIEzhu5dpIHhvw6EgdGluIG5o4bqvbjoge2V9IikKCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9ZGVsYXllZF9kZWxldGUsIGRhZW1vbj1UcnVlKS5zdGFydCgpCgogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0VSUk9SXSBsdXV2YXhvYXRuOiB7ZX0iKQoKZGVmIHJlc3RhcnRfYm90KCk6CiAgICBwcmludCgiW0RFQlVHXSBCb3QgxJFhbmcga2jhu59pIMSR4buZbmcgbOG6oWkuLi4iKQogICAgdGltZS5zbGVlcCg1KQogICAgdHJ5OgogICAgICAgIHByaW50KCJbREVCVUddIMSQYW5nIHRo4buxYyBoaeG7h24ga2jhu59pIMSR4buZbmcgbOG6oWkgYm90Li4uIikKICAgICAgICBvcy5leGVjdihzeXMuZXhlY3V0YWJsZSwgWydweXRob24nXSArIHN5cy5hcmd2KQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSBraGkga2jhu59pIMSR4buZbmcgbOG6oWkgYm90OiB7c3RyKGUpfSIpCiAgICAgICAgdHJhY2ViYWNrLnByaW50X2V4YygpCgpkZWYgcnVuX2JvdDEoKToKICAgIHRyeToKICAgICAgICBwcmludCgiW0RFQlVHXSBLaOG7n2kgxJHhu5luZyBib3QxLi4uIikKICAgICAgICBib3QxLmluZmluaXR5X3BvbGxpbmcoKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KGYiW0RFQlVHXSBM4buXaSDhu58gYm90MToge3N0cihlKX0iKQogICAgICAgIHRyYWNlYmFjay5wcmludF9leGMoKQoKbGFzdF9yZXNldF9kYXkgPSBOb25lCmxhc3RfcmVzZXRfd2VlayA9IE5vbmUKdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9cnVuX2JvdDEsIGRhZW1vbj1UcnVlKS5zdGFydCgpCnRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNjaGVkdWxlX3Rhc2tzLCBkYWVtb249VHJ1ZSkuc3RhcnQoKQphdXRvX3Jlc2V0X2h1X3N0YXR1cygpCgp3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICAgIHByaW50KCJbREVCVUddIFPEg24gbeG7k2kgxJFpIGPhuq11IGNo4bunLi4uIikKICAgICAgICBib3QuaW5maW5pdHlfcG9sbGluZygpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoZiJbREVCVUddIEzhu5dpIHjhuqN5IHJhOiB7c3RyKGUpfSIpCiAgICAgICAgcHJpbnQoIltERUJVR10gVGjDtG5nIHRpbiBs4buXaToiKQogICAgICAgIHRyYWNlYmFjay5wcmludF9leGMoKQogICAgICAgIHJlc3RhcnRfYm90KCk=').decode('utf-8'))
